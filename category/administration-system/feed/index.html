<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Sam &#38; Max &#187; Administration System</title>
	<atom:link href="http://sametmax.com/category/administration-system/feed/" rel="self" type="application/rss+xml" />
	<link>http://sametmax.com</link>
	<description>Du code, du cul</description>
	<lastBuildDate>Sat, 07 Nov 2015 10:56:13 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>http://wordpress.org/?v=4.1</generator>
	<item>
		<title>Désactiver un service dans Ubuntu 14.04 11</title>
		<link>http://sametmax.com/desactiver-un-service-dans-ubuntu-14-04/</link>
		<comments>http://sametmax.com/desactiver-un-service-dans-ubuntu-14-04/#comments</comments>
		<pubDate>Tue, 25 Aug 2015 11:25:59 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[daemon]]></category>
		<category><![CDATA[linux]]></category>
		<category><![CDATA[service]]></category>
		<category><![CDATA[ubuntu]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=16801</guid>
		<description><![CDATA[Quand on installe un service, Ubuntu le lance automatiquement, et installe de quoi le faire démarer à chaque boot de la machine. Si c&#8217;est votre machine de dev, vous ne voulez peut être pas qu&#8217;Apache, Nginx, Redis, MySQL, ElasticSearch, Solr, Supervisor, Postgres, Docker, et MongoDB soient up à chaque fois tous en même temps alors [&#8230;]]]></description>
				<content:encoded><![CDATA[<p>Quand on installe un service, Ubuntu le lance automatiquement, et installe de quoi le faire démarer à chaque boot de la machine.</p>
<p>Si c&#8217;est votre machine de dev, vous ne voulez peut être pas qu&#8217;Apache, Nginx, Redis, MySQL, ElasticSearch, Solr, Supervisor, Postgres, Docker, et MongoDB soient up à chaque fois tous en même temps alors que vous voulez juste vous palucher sur youjizz.</p>
<p>La plupart des scripts de démarrage sont dans /etc/initd.d:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">ls</span> <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>init.d
acpid           brltty             grub-common  lpd         pppd-dns      resolvconf   skeleton           unattended-upgrades
anacron         console-setup      halt...</pre></td></tr></table></div>

<p>Mais ces scripts sont lancés parce qu&#8217;ils sont symlinkés dans un des répertoires <code>/etc/rcX</code>:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">ls</span> <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>rc<span style="color: #000000; font-weight: bold;">*</span>.d<span style="color: #000000; font-weight: bold;">/*</span>apache<span style="color: #000000; font-weight: bold;">*</span>
<span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>rc0.d<span style="color: #000000; font-weight: bold;">/</span>K80apache2  <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>rc5.d<span style="color: #000000; font-weight: bold;">/</span>K80apache2  <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>rc6.d<span style="color: #000000; font-weight: bold;">/</span>K80apache2</pre></td></tr></table></div>

<p>Ouai, j&#8217;ai encore des clients qui utilisent apache. Certains utilisent même Tomcat.</p>
<p>Pour désactiver le démarrage automatique, vous pouvez essayer bourinement la suppression des liens :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">sudo</span> <span style="color: #c20cb9; font-weight: bold;">rm</span> $<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #c20cb9; font-weight: bold;">ls</span> <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>rc<span style="color: #000000; font-weight: bold;">*</span>.d<span style="color: #000000; font-weight: bold;">/*</span>apache<span style="color: #000000; font-weight: bold;">*</span><span style="color: #7a0874; font-weight: bold;">&#41;</span></pre></td></tr></table></div>

<p>Ça marche. </p>
<p>Solution plus pratique, utiliser la commande <code>update-rc.d</code>, qui n&#8217;est pas faite pour l&#8217;utilisation par les humains, mais fuck it :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">sudo</span> update-rc.d <span style="color: #660033;">-f</span> apache2 remove</pre></td></tr></table></div>

<p>Ça supprime aussi tous les liens. <code>sudo update-rc.d -f apache2 disable</code> devrait le faire moins bourinement mais ne marche pas sur ma machine.</p>
<p>Pour inverser la tendance :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">sudo</span> update-rc.d apache2 defaults</pre></td></tr></table></div>

<p>(ou enable si par miracle ça marche pour vous)</p>
<p>Enfin, si le cœur vous en dit:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">sudo</span> update-rc.d <span style="color: #660033;">-f</span> apache2 remove
<span style="color: #c20cb9; font-weight: bold;">sudo</span> sysv-rc-conf</pre></td></tr></table></div>

<p>Vous donnera une joli interface curse pour le faire plus visuellement.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/desactiver-un-service-dans-ubuntu-14-04/feed/</wfw:commentRss>
		<slash:comments>11</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2015/08/JkC3vWe.gif" length="963671" type="image/jpg" />	</item>
		<item>
		<title>Minitip pew et OSX</title>
		<link>http://sametmax.com/minitip-pew-et-osx/</link>
		<comments>http://sametmax.com/minitip-pew-et-osx/#comments</comments>
		<pubDate>Wed, 15 Apr 2015 11:27:32 +0000</pubDate>
		<dc:creator><![CDATA[coyote]]></dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[osx]]></category>
		<category><![CDATA[pew]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=15826</guid>
		<description><![CDATA[
Comme tout bon lecteur de S&#38;M, je me fais un devoir d'adopter tous les outils conseillés par nos maîtres (oui bon sauf crossbar.io – j'ai une vie…)
]]></description>
				<content:encoded><![CDATA[<p style="text-align: center;"><em><small>Ceci est un post invité de <a href="http://sametmax.com/author/coyote/">coyote</a> posté sous licence <a href="http://creativecommons.org/licenses/by/3.0/">creative common 3.0 unported</a>.</small></em></p>
<p>Comme tout bon lecteur de S&amp;M, je me fais un devoir d&#8217;adopter tous les outils conseillés par nos maîtres (oui bon sauf crossbar.io – j&#8217;ai une vie…)</p>
<p>Donc, j&#8217;étais très heureux de découvrir <a title="pew" href="http://sametmax.com/mieux-que-python-virtualenvwrapper-pew/">pew</a> mais soyons honnête, ce n&#8217;est pas <em>exactement</em> un drop-in replacement de virtualenv-wrapper. Bien sûr, c&#8217;est très proche et c&#8217;est beaucoup mieux mais… deux-trois petites bricoles n’emmerdaient toujours.</p>
<h3>Le problème</h3>
<p><strong>bash</strong> sous OSX et Linux ont des configurations et conventions un poil différentes ce qui fait que par défaut, si vous n&#8217;êtes pas déjà au fait de ces différences, vous vous rendez compte que dès que vous activez un environnement avec pew, tout est cassé : votre prompt, vos raccourcis, etc.</p>
<p>Tout ça est dû au fait que (/!\ simplification inside) :</p>
<p>* Sous linux, au lancement de tout shell, le contenu du <em>bashrc</em> (<em>~/.bashrc</em>, <em>/etc/bashrc</em>) est exécuté.<br />
* Sous OSX, au lancement d&#8217;un terminal, le contenu du <em>~/.bash_login</em> est exécuté puis au lancement de subshell, c&#8217;est le ~/bashrc.</p>
<p>C&#8217;est con, mais ça veut dire qu&#8217;à chaque <code lang="bash">pew workon toto</code>, seul <em>.bashrc</em> est exécuté. Et généralement, sous OSX, il est vide ou non existant.</p>
<h3>La solution</h3>
<p>C&#8217;est très simple, mais ça prends quand même 5mn…</p>
<p>On ne peut pas simplement tout déplacer du .bash_login vers le .bashrc, sinon hors virtualenv ça ne marchera pas. Voici donc comment je fais moi, mais c&#8217;est juste parce que je suis paresseux.</p>
<p><strong><em>~/.bash_login</em>:</strong></p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #7a0874; font-weight: bold;">source</span> ~<span style="color: #000000; font-weight: bold;">/</span>.bashrc</pre></td></tr></table></div>

<p>Et c&#8217;est tout. En gros, on court-circuite le comportement OSX pour revenir vers du plus standard.</p>
<p><strong>Extrait du <em>~/.bashrc</em>:</strong></p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #666666; font-style: italic;"># modification de diverses variables que je veux PARTOUT (hors env et dans env)</span>
<span style="color: #7a0874; font-weight: bold;">export</span> <span style="color: #007800;">PATH</span>=<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>mongodb-osx-x86_64-2.6.3<span style="color: #000000; font-weight: bold;">/</span>bin:<span style="color: #007800;">$PATH</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># modifications que je veux uniquement HORS env</span>
<span style="color: #666666; font-style: italic;"># si vous avez d'autres versions de python ou pip dans votre path,</span>
<span style="color: #666666; font-style: italic;"># comme le .bashrc est lancé après l'inclusion du path de l'environ par pew</span>
<span style="color: #666666; font-style: italic;"># vous devez bricoler sinon vous aurez pas la bonne version. </span>
<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#91;</span> <span style="color: #ff0000;">&quot;<span style="color: #007800;">${VIRTUAL_ENV}</span>a&quot;</span> = <span style="color: #ff0000;">&quot;a&quot;</span> <span style="color: #7a0874; font-weight: bold;">&#93;</span>
	<span style="color: #000000; font-weight: bold;">then</span>
	<span style="color: #7a0874; font-weight: bold;">export</span> <span style="color: #007800;">PATH</span>=<span style="color: #ff0000;">&quot;/Library/Frameworks/Python.framework/Versions/3.4/bin:<span style="color: #007800;">${PATH}</span>&quot;</span>
<span style="color: #000000; font-weight: bold;">else</span>
        <span style="color: #666666; font-style: italic;"># modification voulues uniquement dans l'env ?</span>
<span style="color: #000000; font-weight: bold;">fi</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># raccourcis pour les vieilles habitudes. c'est ce qui me derange</span>
<span style="color: #666666; font-style: italic;"># le plus avec pew :)</span>
<span style="color: #000000; font-weight: bold;">function</span> workon<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
	pew-workon $<span style="color: #000000; font-weight: bold;">@</span>;
<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># completion pew sur le raccourci. vous connaissez le nom de vos envs vous ?</span>
_pew<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>
<span style="color: #7a0874; font-weight: bold;">&#123;</span>
    <span style="color: #7a0874; font-weight: bold;">local</span> <span style="color: #007800;">cur</span>=<span style="color: #800000;">${COMP_WORDS[COMP_CWORD]}</span>
    <span style="color: #007800;">COMPREPLY</span>=<span style="color: #7a0874; font-weight: bold;">&#40;</span> $<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #7a0874; font-weight: bold;">compgen</span> <span style="color: #660033;">-W</span> <span style="color: #ff0000;">&quot;<span style="color: #007800;">$(pew-ls)</span>&quot;</span> <span style="color: #660033;">--</span> <span style="color: #800000;">${cur}</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#41;</span>
<span style="color: #7a0874; font-weight: bold;">&#125;</span>
<span style="color: #7a0874; font-weight: bold;">complete</span> <span style="color: #660033;">-F</span> _pew workon
&nbsp;
<span style="color: #666666; font-style: italic;"># renvoie le path d'un projet depuis le nom de l'env pour faire d'une pierre deux coups (optionnel)</span>
<span style="color: #666666; font-style: italic;"># utilise pyp</span>
<span style="color: #000000; font-weight: bold;">function</span> pwdof<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
	<span style="color: #007800;">path</span>=<span style="color: #000000; font-weight: bold;">`</span><span style="color: #7a0874; font-weight: bold;">pwd</span><span style="color: #000000; font-weight: bold;">`</span>
	<span style="color: #007800;">env_name</span>=<span style="color: #000000; font-weight: bold;">`</span><span style="color: #7a0874; font-weight: bold;">echo</span> $<span style="color: #000000; font-weight: bold;">@|</span> pyp <span style="color: #ff0000;">&quot;p.split('/')[-1]&quot;</span><span style="color: #000000; font-weight: bold;">`</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#91;</span> <span style="color: #ff0000;">&quot;<span style="color: #007800;">${env_name}</span>&quot;</span> = <span style="color: #ff0000;">&quot;toto&quot;</span> <span style="color: #7a0874; font-weight: bold;">&#93;</span>
		<span style="color: #000000; font-weight: bold;">then</span>
		<span style="color: #007800;">path</span>=~<span style="color: #000000; font-weight: bold;">/</span>src<span style="color: #000000; font-weight: bold;">/</span>toto-project;
	<span style="color: #000000; font-weight: bold;">fi</span>
&nbsp;
	<span style="color: #7a0874; font-weight: bold;">echo</span> <span style="color: #007800;">$path</span>;
<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># coloration du prompt a l’intérieur du subshell</span>
<span style="color: #666666; font-style: italic;"># j'aime avoir les branches git et le nom de l'env dans mon prompt.</span>
<span style="color: #666666; font-style: italic;"># donc pour que votre prompt marche dehors ET dedans (exemple)</span>
<span style="color: #000000; font-weight: bold;">function</span> color_prompt <span style="color: #7a0874; font-weight: bold;">&#123;</span>
    <span style="color: #7a0874; font-weight: bold;">local</span> <span style="color: #007800;">__user_and_host</span>=<span style="color: #ff0000;">&quot;\[\033[01;32m\]\u@\h&quot;</span>
    <span style="color: #7a0874; font-weight: bold;">local</span> <span style="color: #007800;">__cur_location</span>=<span style="color: #ff0000;">&quot;\[\033[01;34m\]\w&quot;</span>
    <span style="color: #7a0874; font-weight: bold;">local</span> <span style="color: #007800;">__git_branch_color</span>=<span style="color: #ff0000;">&quot;\[\033[31m\]&quot;</span>
    <span style="color: #7a0874; font-weight: bold;">local</span> <span style="color: #007800;">__git_branch</span>=<span style="color: #ff0000;">'`git branch 2&amp;gt; /dev/null | grep -e ^* | sed -E  s/^\\\\\*\ \(.+\)$/\(\\\\\1\)\ /`'</span>
    <span style="color: #7a0874; font-weight: bold;">local</span> <span style="color: #007800;">__prompt_tail</span>=<span style="color: #ff0000;">&quot;\[\033[35m\]$&quot;</span>
    <span style="color: #7a0874; font-weight: bold;">local</span> <span style="color: #007800;">__last_color</span>=<span style="color: #ff0000;">&quot;\[\033[00m\]&quot;</span>
    <span style="color: #7a0874; font-weight: bold;">export</span> <span style="color: #007800;">PS1</span>=<span style="color: #ff0000;">&quot;<span style="color: #007800;">$__user_and_host</span> <span style="color: #007800;">$__cur_location</span> <span style="color: #007800;">$__git_branch_color</span><span style="color: #007800;">$__git_branch</span><span style="color: #007800;">$__prompt_tail</span><span style="color: #007800;">$__last_color</span> &quot;</span>
    <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#91;</span> <span style="color: #ff0000;">&quot;<span style="color: #007800;">${VIRTUAL_ENV}</span>a&quot;</span> <span style="color: #000000; font-weight: bold;">!</span>= <span style="color: #ff0000;">&quot;a&quot;</span> <span style="color: #7a0874; font-weight: bold;">&#93;</span>
    	<span style="color: #000000; font-weight: bold;">then</span>
		<span style="color: #7a0874; font-weight: bold;">export</span> <span style="color: #007800;">PS1</span>=<span style="color: #ff0000;">&quot;(<span style="color: #000099; font-weight: bold;">\$</span>(basename '<span style="color: #007800;">$VIRTUAL_ENV</span>'))<span style="color: #007800;">$PS1</span>&quot;</span>;
&nbsp;
		<span style="color: #666666; font-style: italic;"># facultatif: permet de faire un cd au lancement du subshell</span>
		<span style="color: #7a0874; font-weight: bold;">cd</span> <span style="color: #000000; font-weight: bold;">`</span>pwdof <span style="color: #800000;">${VIRTUAL_ENV}</span><span style="color: #000000; font-weight: bold;">`</span>
   	<span style="color: #000000; font-weight: bold;">fi</span>
<span style="color: #7a0874; font-weight: bold;">&#125;</span>
color_prompt
&nbsp;
<span style="color: #666666; font-style: italic;"># completion de la commande pew qui n'est pas installé par pip</span>
<span style="color: #666666; font-style: italic;"># mais qui reste pratique.</span>
<span style="color: #666666; font-style: italic;"># adapté depuis: https://github.com/berdario/pew/blob/master/pew/complete_scripts/complete.bash</span>
_pew<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>
<span style="color: #7a0874; font-weight: bold;">&#123;</span>
	<span style="color: #7a0874; font-weight: bold;">local</span> <span style="color: #007800;">cur</span>=<span style="color: #800000;">${COMP_WORDS[COMP_CWORD]}</span>
	<span style="color: #7a0874; font-weight: bold;">local</span> <span style="color: #007800;">prev</span>=<span style="color: #800000;">${COMP_WORDS[COMP_CWORD-1]}</span>
    <span style="color: #007800;">args</span>=<span style="color: #ff0000;">&quot;--help --python -i -a -r&quot;</span>
    <span style="color: #007800;">commands</span>=<span style="color: #ff0000;">&quot;ls add mkproject rm lssitepackages cp workon new mktmpenv setproject show wipeenv sitepackages_dir inall toggleglobalsitepackages&quot;</span>
&nbsp;
    <span style="color: #000000; font-weight: bold;">case</span> <span style="color: #007800;">$prev</span> <span style="color: #000000; font-weight: bold;">in</span>
        <span style="color: #c20cb9; font-weight: bold;">ls</span><span style="color: #000000; font-weight: bold;">|</span>show<span style="color: #000000; font-weight: bold;">|</span><span style="color: #c20cb9; font-weight: bold;">rm</span><span style="color: #000000; font-weight: bold;">|</span>workon<span style="color: #000000; font-weight: bold;">|</span><span style="color: #c20cb9; font-weight: bold;">cp</span><span style="color: #000000; font-weight: bold;">|</span>setproject<span style="color: #7a0874; font-weight: bold;">&#41;</span>
            <span style="color: #007800;">COMPREPLY</span>=<span style="color: #7a0874; font-weight: bold;">&#40;</span> $<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #7a0874; font-weight: bold;">compgen</span> <span style="color: #660033;">-W</span> <span style="color: #ff0000;">&quot;<span style="color: #007800;">$(pew-ls)</span>&quot;</span> <span style="color: #660033;">--</span> <span style="color: #800000;">${cur}</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#41;</span>
            <span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #000000;">0</span>
            <span style="color: #000000; font-weight: bold;">;;</span>
        inall<span style="color: #7a0874; font-weight: bold;">&#41;</span>
            _command_offset <span style="color: #000000;">2</span>
            <span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #000000;">0</span>
            <span style="color: #000000; font-weight: bold;">;;</span>
        mktmpenv<span style="color: #000000; font-weight: bold;">|</span>new<span style="color: #7a0874; font-weight: bold;">&#41;</span>
            <span style="color: #007800;">COMPREPLY</span>=<span style="color: #7a0874; font-weight: bold;">&#40;</span> $<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #7a0874; font-weight: bold;">compgen</span> <span style="color: #660033;">-W</span> <span style="color: #ff0000;">&quot;<span style="color: #007800;">${args}</span>&quot;</span> <span style="color: #660033;">--</span> <span style="color: #800000;">${cur}</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#41;</span>
            <span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #000000;">0</span>
            <span style="color: #000000; font-weight: bold;">;;</span>
        mkproject<span style="color: #7a0874; font-weight: bold;">&#41;</span>
            <span style="color: #007800;">COMPREPLY</span>=<span style="color: #7a0874; font-weight: bold;">&#40;</span> $<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #7a0874; font-weight: bold;">compgen</span> <span style="color: #660033;">-W</span> <span style="color: #ff0000;">&quot;<span style="color: #007800;">${args}</span> -t --list&quot;</span> <span style="color: #660033;">--</span> <span style="color: #800000;">${cur}</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#41;</span>
            <span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #000000;">0</span>
            <span style="color: #000000; font-weight: bold;">;;</span>
        add<span style="color: #7a0874; font-weight: bold;">&#41;</span>
            <span style="color: #007800;">COMPREPLY</span>=<span style="color: #7a0874; font-weight: bold;">&#40;</span> $<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #7a0874; font-weight: bold;">compgen</span> <span style="color: #660033;">-W</span> <span style="color: #ff0000;">&quot;--help -d&quot;</span> <span style="color: #660033;">--</span> <span style="color: #800000;">${cur}</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#41;</span>
            <span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #000000;">0</span>
            <span style="color: #000000; font-weight: bold;">;;</span>
    <span style="color: #000000; font-weight: bold;">esac</span>
&nbsp;
    <span style="color: #007800;">COMPREPLY</span>=<span style="color: #7a0874; font-weight: bold;">&#40;</span> $<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #7a0874; font-weight: bold;">compgen</span> <span style="color: #660033;">-W</span> <span style="color: #ff0000;">&quot;<span style="color: #007800;">${commands}</span>&quot;</span> <span style="color: #660033;">--</span> <span style="color: #800000;">${cur}</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#41;</span>
&nbsp;
<span style="color: #7a0874; font-weight: bold;">&#125;</span>
<span style="color: #7a0874; font-weight: bold;">complete</span> <span style="color: #660033;">-F</span> _pew pew</pre></td></tr></table></div>

<p>Et voilà !</p>
<p>Ça casse pas trois pattes à un canard mais si vous êtes sous OSX, que vous avez installé, vu que c&#8217;était pas parfait puis vous êtes dit «on verra plus tard» et bien le moment est arrivé.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/minitip-pew-et-osx/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2015/01/ZhHAoYy.jpg" length="112688" type="image/jpg" />	</item>
		<item>
		<title>Écouter sur le port 80 sans être root 16</title>
		<link>http://sametmax.com/ecouter-sur-le-port-80-sans-etre-root/</link>
		<comments>http://sametmax.com/ecouter-sur-le-port-80-sans-etre-root/#comments</comments>
		<pubDate>Wed, 28 Jan 2015 13:47:08 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[linux]]></category>
		<category><![CDATA[port]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[reseau]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=15817</guid>
		<description><![CDATA[Sous beaucoup d'OS, tous les ports d'un nombre inférieur à 1024 ne peuvent pas être utilisés par des serveurs sans avoir les privilèges administrateurs. Néanmoins, on a pas vraiment envie que son app bricolée un lendemain de cuite soit lancée en root, pour que la moindre faille de sécurité donne l'accès total à son système.]]></description>
				<content:encoded><![CDATA[<p>Sous beaucoup d&#8217;OS, tous les ports d&#8217;un nombre inférieur à 1024 ne peuvent pas être utilisés par des processus sans avoir les privilèges administrateurs. Néanmoins, on a pas vraiment envie que son app bricolée un lendemain de cuite soit lancée en root, pour que la moindre faille de sécurité donne l&#8217;accès total à son système.</p>
<p>Beaucoup de logiciels se lancent en root, et relâchent leurs privilèges a posteriori. C&#8217;est ce que faisait Apache a une époque (peut être le fait-il toujours, j&#8217;ai pas cheché). Nginx lui, lance un processus racine en root, et spawn des enfants avec un utilisateur normal. </p>
<p>Mais nous, on a pas la foi de se faire chier à faire ça, donc généralement, on met nginx en front et il gère ça pour nous. </p>
<p>Sauf que, parfois, on a pas envie de mettre 40 couches devant notre app. Par exemple, si on utilise crossbar.io (ouai, j&#8217;ai encore réussi à le placer \o/), le logiciel est clairement capable d&#8217;être en front tout seul. </p>
<p>Bonne nouvelle, sur les Linux modernes, les exécutables peuvent avoir des <a href="http://linux.die.net/man/7/capabilities">permissions</a> avancées, comme &#8220;pourvoir changer l&#8217;horloge système&#8221; ou &#8220;empêcher la mise en veille&#8221;. Ces permissions sont changeables avec l&#8217;outil <code>setcap</code>.</p>
<p>Sous Ubuntu, ça s&#8217;installe avec :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">sudo</span> <span style="color: #c20cb9; font-weight: bold;">apt-get install</span> libcap2-bin</pre></td></tr></table></div>

<p>Puis on choisit l&#8217;exécutable à qui on veut donner nos nouvelles permissions. Dans mon cas, le Python du virtualenv de mon projet :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">$ pew workon super_projet
$ which python
/home/sam/.<span style="color: black;">local</span>/share/virtualenvs/super_projet/bin/python</pre></td></tr></table></div>

<p>Je check si il a pas déjà des permissions (normalement non) :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">$ sudo getcap `which python`</pre></td></tr></table></div>

<p>Nada. Good.</p>
<p>Un petit coup de <code>man setcap</code> nous liste les permissions utilisables, et on peut voire que <code>CAP_NET_BIND_SERVICE</code> est la permission qui permet d&#8217;autoriser un exécutable à binder n&#8217;importe quel port. </p>
<p>On rajoute les permissions :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">sudo</span> setcap <span style="color: #007800;">cap_net_bind_service</span>=+ep <span style="color: #000000; font-weight: bold;">`</span><span style="color: #c20cb9; font-weight: bold;">which</span> python<span style="color: #000000; font-weight: bold;">`</span></pre></td></tr></table></div>

<p>On check que les permissions ont bien été ajoutées :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">$ sudo getcap `which python`
/home/sam/.<span style="color: black;">local</span>/share/virtualenvs/super_projet/bin/python <span style="color: #66cc66;">=</span> cap_net_bind_service+eip</pre></td></tr></table></div>

<p>On a rajouté avec le <code>+</code> la permission <code>cap_net_bind_service</code> pour les cas <code>e</code> et <code>p</code> qui correspondent aux premières lettres de ces définitions :</p>
<pre>
Permitted (formerly known as forced):
    These capabilities are automatically permitted to the thread, regardless of the thread's inheritable capabilities. 

Inheritable (formerly known as allowed):
    This set is ANDed with the thread's inheritable set to determine which inheritable capabilities are enabled in the permitted set of the thread after the execve(2). 

Effective:
    This is not a set, but rather just a single bit. If this bit is set, then during an execve(2) all of the new permitted capabilities for the thread are also raised in the effective set. If this bit is not set, then after an execve(2), none of the new permitted capabilities is in the new effective set.
</pre>
<p>Et je n&#8217;ai absolument rien compris à celles-ci, je sais juste que ça marche.</p>
<p>Voilà, maintenant tout ce que vous lancez avec le Python de ce virtualenv peut se binder au port 80.</p>
<p>Si vous n&#8217;aimez pas l&#8217;idée de donner cette permission à tout un Python, il existe une alternative : rediriger tout ce qui rentre sur le port 80 vers un autre port. </p>
<p>Pour ça on peut utiliser un autre soft :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">sudo</span> <span style="color: #c20cb9; font-weight: bold;">apt-get install</span> socat</pre></td></tr></table></div>

<p>Par exemple, balancer tout le trafic du port <code>80</code> vers le port <code>8080</code> :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">socat tcp-listen:<span style="color: #000000;">80</span>,fork,reuseaddr tcp:localhost:<span style="color: #000000;">8080</span></pre></td></tr></table></div>

<p>Et pouf, votre appli qui écoute sur le port <code>8080</code> reçoit le trafic du port <code>80</code>.</p>
<p>C&#8217;est plus simple, mais il faut le faire pour chaque port, et s&#8217;assurer que la commande est bien lancée au démarrage du serveur.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/ecouter-sur-le-port-80-sans-etre-root/feed/</wfw:commentRss>
		<slash:comments>16</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2015/01/5448b43a23db2b0525bdf2f2fe7f80a1.png" length="150421" type="image/jpg" />	</item>
		<item>
		<title>Conclusions de la migration 10</title>
		<link>http://sametmax.com/conclusions-de-la-migration/</link>
		<comments>http://sametmax.com/conclusions-de-la-migration/#comments</comments>
		<pubDate>Thu, 08 Jan 2015 09:15:40 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[blog]]></category>
		<category><![CDATA[meta]]></category>
		<category><![CDATA[migration]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=15682</guid>
		<description><![CDATA[La migration de serveur est terminée. Le blog, le <a href="http://multiboards.net">multiboards</a>, <a href="http://indexerror.net">IndexError</a> et <a href="http://0bin.net">0bin</a> on été rétablis. On en a profité pour remettre sur pied <a href="http://allthatcounts.net">AllThatCounts</a> qui avait été délaissé durant le dernier crash.]]></description>
				<content:encoded><![CDATA[<p>La migration de serveur est terminée. Le blog, le <a href="http://multiboards.net">multiboards</a>, <a href="http://indexerror.net">IndexError</a> et <a href="http://0bin.net">0bin</a> on été rétablis. On en a profité pour remettre sur pied <a href="http://allthatcounts.net">AllThatCounts</a> qui avait été délaissé durant le dernier crash.</p>
<p>On quitte donc <a href="https://www.leaseweb.com/">LeaseWeb</a>, qui nous a forcé à migré 3 fois avec ses machines qui ont planté. En plus deux fois la partition <code>/tmp</code> était corrompue, ce qui rend le backup particulièrement compliqué. On notera que leur SAV nous posait des questions du genre &#8220;si vous installez ça, et lancez cette commande, ça donne quoi ?&#8221;, alors qu&#8217;on leur a bien notifié qu&#8217;on avait un disque monté en lecture seul du fait du FS en vrac&#8230;</p>
<p>On est passé chez <a href="http://www.cinfu.com/vps/">Cinfu</a>, car on peut les payer en Bitcoin. Livraison du serveur rapide, installation sans histoire, et finalement une migration beaucoup moins chiante que la dernière fois car on a fait les gros bourrins : <code>rsync</code> + <code>mysqldump</code> bien large. Ce qui a pris le plus de temps c&#8217;était de résoudre les centaines de problèmes de permissions que ça a créé, les trucs que ça aurait pas du écraser, etc.</p>
<p>On avait + de 100000 spams dans la poubelle des commentaires, qui prenaient 300 Mo des 400 mo de la taille totale de la BDD du blog. Un petit :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">DELETE</span> <span style="color: #993333; font-weight: bold;">FROM</span> wp_comments <span style="color: #993333; font-weight: bold;">WHERE</span> comment_approved <span style="color: #66cc66;">=</span> <span style="color: #ff0000;">'trash'</span>;</pre></td></tr></table></div>

<p>A accéléré la migration vu qu&#8217;on a du transférer la base 3 fois et la réimporter autant à cause d&#8217;erreurs diverses. Note à nous-même : arrêter de mettre des <code>.bak</code> dans <code>/tmp</code> parce que c&#8217;est &#8220;juste pour 5 minutes&#8221;. Après on se fait avoir comme des débutants au reboot. </p>
<p>C&#8217;est là qu&#8217;on voit qu&#8217;on est dev, et pas admin.</p>
<p>Rajouter dans wp-config.php :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="php" style="font-family:monospace;"><span style="color: #990000;">define</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'EMPTY_TRASH_DAYS'</span><span style="color: #339933;">,</span> <span style="color: #cc66cc;">30</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre></td></tr></table></div>

<p>Nous évitera d&#8217;avoir à repenser à tout ça. C&#8217;est con mais faut le savoir.</p>
<p>J&#8217;en profite pour témoigner mon amour immodéré pour <a href="https://mosh.mit.edu/">mosh</a>. Parce que faire tout ça sur une connexion thai avec 300ms de ping minimum et une coupure toutes les 10 minutes, avec SSH, c&#8217;est juste un enfer.</p>
<p>Sous Centos, faut installer les repos <code>EPEL</code> et <code>yum install mosh</code> derrière.</p>
<p>Sous Ubuntu, fait installer le ppa <code>ppa:keithw/mosh</code> et <code>apt-get install mosh</code> derrière.</p>
<p>Certains serveurs ont un pare feu tatillon, et il faut rajouter dans la section <code>:RH-Firewall-1-INPUT - [0:0]</code> de iptable :</p>
<p><code>-A RH-Firewall-1-INPUT -p udp --dport 60000:61000 -j ACCEPT</code></p>
<p>D&#8217;autres ont des problèmes de locales:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">apt-get install --reinstall language-pack-fr
dpkg-reconfigure locales</pre></td></tr></table></div>

<p>Parfois y a aucun problème. C&#8217;est juste qu&#8217;on a pas un parc homogène, avec des bécanes vieilles de 1000 ans, alors forcément&#8230;</p>
<p>Mais Max a fait des devis, et si on passe au cloud avec les 2G/s de BP et les To de disque dur qu&#8217;on consomme, on multiplie les prix par 10 d&#8217;hébergement. Faire les trucs à la main, c&#8217;est chiant, mais c&#8217;est économe.</p>
<p>Pour mosh, pas de serveur à lancer, juste remplacer <code>ssh</code> par <code>mosh</code> dans la commande quand on se connecte. Des fois je lance avec <code>--predict=experimental</code> car je suis impatient et le retour de frappe est plus rapide, mais le cursor fait des mouvements bizarres, faut s&#8217;habituer.</p>
<p>Bon, on retourne faire des trucs plus productifs.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/conclusions-de-la-migration/feed/</wfw:commentRss>
		<slash:comments>10</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2015/01/reVgzvz.gif" length="998065" type="image/jpg" />	</item>
		<item>
		<title>Black awk down 8</title>
		<link>http://sametmax.com/black-awk-down/</link>
		<comments>http://sametmax.com/black-awk-down/#comments</comments>
		<pubDate>Tue, 06 Jan 2015 10:26:20 +0000</pubDate>
		<dc:creator><![CDATA[foX]]></dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[Gadget]]></category>
		<category><![CDATA[Programmation]]></category>
		<category><![CDATA[linux]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[shell]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=10493</guid>
		<description><![CDATA[Qui n'a jamais rêvé d'avoir un shell Unix un peu plus pythonic ? Les oneliners en sed et Awk bien chiadés, c'est l'apanage des grands barbus en sandales et ça déchire, mais ça reste cryptique et la manipulation de liste et de chaînes de caractères est tout de même limitée.]]></description>
				<content:encoded><![CDATA[<blockquote><p>Ceci est un post invité de <a href="http://sametmax.com/author/foX" target="_blank">foX </a>posté sous licence <a href="http://creativecommons.org/licenses/by/3.0/" target="_blank">creative common 3.0 unported</a>.</p></blockquote>
<h2>Introduction (sans douleur)</h2>
<p>Qui n&#8217;a jamais rêvé d&#8217;avoir un shell Unix un peu plus pythonic ? Les oneliners en <a href="http://fr.wikipedia.org/wiki/Stream_Editor" title="sed">sed</a> et <a href="http://fr.wikipedia.org/wiki/Awk" title="Awk">Awk</a> bien chiadés, c&#8217;est l&#8217;apanage des grands barbus en sandales et ça déchire, mais ça reste cryptique et la manipulation de liste et de chaînes de caractères est tout de même limitée. On peut dégainer perl en one line, comme ça c&#8217;est encore plus puissant mais moins lisible&#8230;</p>
<p>Et python dans tout ça ? En oneliner, ça craint, car le principe d&#8217;indentation ne facilite pas les choses et on finit avec une imbrication de bazar de parenthèses illisible.</p>
<p>La solution ? Pour se faire plaisir : une bonne pyp. Le bidule s&#8217;installe avec&#8230; pip (c&#8217;est une méta pipe).</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">pip <span style="color: #c20cb9; font-weight: bold;">install</span> pyp</pre></td></tr></table></div>

<p>pyp (<a href="http://code.google.com/p/pyp/" title="pyp">Python Power at the Prompt</a>) va enchanter votre shell unix et vous envoyer au 7ème ciel. Petit tour d&#8217;horizon de la merveille.</p>
<h2>Pyp et les strings</h2>
<p>C&#8217;est la base quand on bricole des oneliners en shell, tripoter des strings.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">ls</span> <span style="color: #000000; font-weight: bold;">*</span>JPG <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #ff0000;">&quot;'mv', p, p.replace('JPG', 'jpg')&quot;</span></pre></td></tr></table></div>

<p>Revoyons l&#8217;action au ralenti : </p>
<ul>
<li>ls *JPG va nous lister tous les fichiers qui finissent par JPG dans le dossier courant.</li>
<li>Ensuite on envoie cela dans pyp avec un pipe Unix. Celui-ci va composer une ligne de commande qui est la concaténation d&#8217;une commande unix (mv pour renommer un fichier), ce qu&#8217;on aura reçu en entrée (qui s&#8217;appelle par convention &#8220;p&#8221;) et une version modifiée de p où l&#8217;on remplace JPG par jpg.</li>
</ul>
<p>On voit ici que l&#8217;on utilise la méthode replace de la classe str python. On peut utiliser n&#8217;importe quelle méthode de str : lower, upper, title, strip(tease), count etc. Avec des petits bonus comme refindall(re) :-)</p>
<p>Ça donne quoi ma brave dame ? Et bien si on avait des fichiers appelés porn1.JPG et ass.JPG notre jolie commande renverrait :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">mv</span> porn1.JPG porn1.jpg
<span style="color: #c20cb9; font-weight: bold;">mv</span> ass.JPG ass.jpg</pre></td></tr></table></div>

<p>Ok, bien gentil me direz-vous, mais qu&#8217;en fait-on ? Et bien ou l&#8217;on pipe ça dans le shell ( | sh) ou alors on passe l&#8217;argument -x (ou &#8211;execute) à pyp ou directement exécuter le résultat.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">ls</span> <span style="color: #000000; font-weight: bold;">*</span>JPG <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #ff0000;">&quot;'mv', p, p.replace('JPG', 'jpg')&quot;</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">sh</span>
<span style="color: #666666; font-style: italic;"># ou bien</span>
<span style="color: #c20cb9; font-weight: bold;">ls</span> <span style="color: #000000; font-weight: bold;">*</span>JPG <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #660033;">-x</span> <span style="color: #ff0000;">&quot;'mv', p, p.replace('JPG', 'jpg')&quot;</span></pre></td></tr></table></div>

<p>Pourquoi on aime bien python ? Car il slice le bread comme un chef. Pyp aussi, oeuf corse, quelques exemples :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #7a0874; font-weight: bold;">echo</span> <span style="color: #ff0000;">&quot;sam-et-max&quot;</span> <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #ff0000;">&quot;p.split('-')[2]&quot;</span>
<span style="color: #666666; font-style: italic;"># max</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># La même chose en plus court. Le m, comme minus, sous-entend qu'on split sur &quot;-&quot;</span>
<span style="color: #7a0874; font-weight: bold;">echo</span> <span style="color: #ff0000;">&quot;sam-et-max&quot;</span> <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #ff0000;">&quot;m[2]&quot;</span>
<span style="color: #666666; font-style: italic;"># max</span>
&nbsp;
<span style="color: #7a0874; font-weight: bold;">echo</span> <span style="color: #ff0000;">&quot;sam-et-max&quot;</span> <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #ff0000;">&quot;m[0], m[2]&quot;</span>
<span style="color: #666666; font-style: italic;"># sam max</span></pre></td></tr></table></div>

<p>Comme vous avez vu, il y a un petit raccourci sympa avec m (comme minus) au lieu de p. C&#8217;est pas fini, vous en avez d&#8217;autres : d (dot) pour un point, w (whitespace) pour une espace, u pour underscore, s pour slash&#8230; Ils ont pensé à tout.</p>
<h2>Des pyp à la chaîne</h2>
<p>On tout de suite envie de remettre le couvert avec une autre pyp. C&#8217;est possible et même encouragé. Le symbole utilisé est le pipe unix | dans une commande pyp. Ce n&#8217;est donc pas un pipe du shell mais un pipe interne de pyp. Vous suivez ? Un petit exemple :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #7a0874; font-weight: bold;">echo</span> <span style="color: #ff0000;">&quot;sam et max&quot;</span> <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #ff0000;">&quot;w[0] | 'avant : ', o, 'après :', p&quot;</span>
<span style="color: #666666; font-style: italic;"># avant :  sam et max après : sam</span></pre></td></tr></table></div>

<p>Le p représente toujours le paramètre courant. Donc dans la seconde partie du pipe, c&#8217;est le premier élément de la liste issu du split de la chaîne &#8220;sam et max&#8221; sur l&#8217;espace (w comme whitespace). Vous suivez toujours ? Oui, bon. Et donc le o ? Et bien c&#8217;est le paramètre d&#8217;origine non modifié. Et il y a h (comme history ou comme hâlibi !) pour avoir le paramètre p à toutes les étapes de la chaîne de pipe&#8230; Beaucoup de puissance on vous dit !</p>
<p>On peut aussi rouler^w faire des join facilement avec les mêmes raccourcis. Par exemple on split sur les espaces puis join sur slash :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #7a0874; font-weight: bold;">echo</span> <span style="color: #ff0000;">&quot;sam et max aiment le lourd en fin de soirée&quot;</span> <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #ff0000;">&quot;w[:6]|s&quot;</span>
<span style="color: #666666; font-style: italic;"># sam/et/max/aiment/le/lourd</span></pre></td></tr></table></div>

<h2>Une liste de pyp avec une belle pp</h2>
<p>S&#8217;il y a un bien un truc qui envoie du bois avec python, c&#8217;est la gestion des listes. Pyp n&#8217;est pas en reste. C&#8217;est pp qui contient les listes. En avant :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">ls</span> <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #ff0000;">&quot;pp[3]&quot;</span>
<span style="color: #666666; font-style: italic;"># Affiche le troisième fichier</span></pre></td></tr></table></div>

<p>On peut utiliser toutes les méthodes standards de la classe list (sort, count etc.) plus quelques bonus :</p>
<p># Équivalent de | sort | uniq</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">ls</span> <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #ff0000;">&quot;pp.uniq()&quot;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># Additionne tous les PID des process de machine.</span>
<span style="color: #666666; font-style: italic;"># Ça ne sert à rien, mais c'est un exemple hein ?</span>
<span style="color: #c20cb9; font-weight: bold;">ps</span> <span style="color: #660033;">-ef</span> <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #ff0000;">&quot;w[1] | int(p) | sum(pp)&quot;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># Voilà qui est plus utile. </span>
<span style="color: #666666; font-style: italic;"># Au passage, on note que la ligne d'en-tête est ignoré et ne fait pas planter pyp.</span>
<span style="color: #666666; font-style: italic;"># Malin le lapin.</span>
<span style="color: #c20cb9; font-weight: bold;">df</span> <span style="color: #660033;">-m</span> <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #ff0000;">&quot;w[1] | int(p) | sum(pp)&quot;</span></pre></td></tr></table></div>

<h2>pyp au naturel</h2>
<p>Pour compléter les fonctions python, pyp propose quelques fonctions maisons tout à fait sympathiques. Florilège :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #7a0874; font-weight: bold;">echo</span> <span style="color: #ff0000;">&quot;Sam Bill Max&quot;</span> <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #ff0000;">&quot;p.kill('Bill')&quot;</span>  <span style="color: #666666; font-style: italic;"># quand c'est pas bill, c'est kenny...</span>
<span style="color: #666666; font-style: italic;"># Sam  Max</span>
&nbsp;
<span style="color: #7a0874; font-weight: bold;">echo</span> <span style="color: #000000;">124</span> <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #ff0000;">&quot;(int(p)/2+30)&quot;</span>
<span style="color: #666666; font-style: italic;"># 91</span>
&nbsp;
<span style="color: #c20cb9; font-weight: bold;">ls</span>  <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #ff0000;">&quot;n, p&quot;</span>
<span style="color: #666666; font-style: italic;"># Liste des fichiers avec un numéro croissant devant</span>
&nbsp;
<span style="color: #7a0874; font-weight: bold;">echo</span> <span style="color: #000000; font-weight: bold;">/</span>home<span style="color: #000000; font-weight: bold;">/</span>fox<span style="color: #000000; font-weight: bold;">/</span>video<span style="color: #000000; font-weight: bold;">/</span>gangbang.avi  <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #ff0000;">&quot;'Dir='+p.dir, '<span style="color: #000099; font-weight: bold;">\n</span>File='+p.file, '<span style="color: #000099; font-weight: bold;">\n</span>Ext='+p.ext&quot;</span> <span style="color: #666666; font-style: italic;"># basename, dirname et ses amis</span>
<span style="color: #666666; font-style: italic;"># Dir=/home/fox/video </span>
<span style="color: #666666; font-style: italic;"># File=gangbang.avi </span>
<span style="color: #666666; font-style: italic;"># Ext=avi</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># On définit le séparateur de liste comme l'espace, </span>
<span style="color: #666666; font-style: italic;"># puis on regroupe la liste par deux élément</span>
<span style="color: #666666; font-style: italic;"># et enfin on fait un join sur le caractère tiret (minus)</span>
<span style="color: #7a0874; font-weight: bold;">echo</span> <span style="color: #ff0000;">&quot;1 2 3 4 5 6&quot;</span> <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #ff0000;">&quot;pp.delimit(' ') | pp.divide(2) | m&quot;</span>
<span style="color: #666666; font-style: italic;"># 1-2</span>
<span style="color: #666666; font-style: italic;"># 3-4</span>
<span style="color: #666666; font-style: italic;"># 5-6</span>
&nbsp;
<span style="color: #c20cb9; font-weight: bold;">ps</span> <span style="color: #660033;">-ef</span> <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #ff0000;">&quot;w[1] | int(p) | max(pp)&quot;</span> 
<span style="color: #666666; font-style: italic;"># (le PID le plus grand)</span></pre></td></tr></table></div>

<h2>pyp en intention ou intention de pyp ?</h2>
<p>Il ne faut pas se gêner, on peut utiliser les excellentes <a href="http://sametmax.com/python-love-les-listes-en-intention-partie/" title="Listes en intention">listes en intention</a> de Python.  Voici tous les PID impaires :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">ps</span> <span style="color: #660033;">-ef</span> <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #ff0000;">&quot;w[1] | int(p) | [i for i in pp if i%2] | p &quot;</span></pre></td></tr></table></div>

<h2>L&#8217;industrie de la pyp c&#8217;est un truc de macro</h2>
<p>Les bonnes choses, ça se garde, alors voilà :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">ps</span> <span style="color: #660033;">-ef</span> <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #ff0000;">&quot;w[1] | int(p) | [i for i in pp if i%2] | p &quot;</span> <span style="color: #660033;">-s</span> odd  <span style="color: #666666; font-style: italic;"># on enregistre la macro 'odd'</span>
&nbsp;
<span style="color: #c20cb9; font-weight: bold;">ps</span> ef <span style="color: #000000; font-weight: bold;">|</span> pyp odd <span style="color: #666666; font-style: italic;"># c'est aussi simple que cela ;-)</span></pre></td></tr></table></div>

<h2>pyp sur grand écran</h2>
<p>Cette petite pépite est développée par Sony Pictures Imageworks pour ses besoins internes. Le développement n&#8217;est pas très collaboratif (un commit par release&#8230;) mais reste ouvert aux contributions externes. C&#8217;est sous une licence de type BSD.<br />
Les loulous ont fait une jolie vidéo de tutorial très bling bling. C&#8217;est l&#8217;avantage de bosser dans le milieu : </p>
<p><span class='embed-youtube' style='text-align:center; display: block;'><iframe class='youtube-player' type='text/html' width='1170' height='689' src='http://www.youtube.com/embed/eWtVWF0JSJA?version=3&#038;rel=1&#038;fs=1&#038;showsearch=0&#038;showinfo=1&#038;iv_load_policy=1&#038;wmode=transparent' frameborder='0' allowfullscreen='true'></iframe></span></p>
<h2>Et bien plus encore&#8230;</h2>
<p>Cet outil merveilleux possède encore des fonctionnalités qui vont vous le faire adorer comme son mode interactif avec une coloration syntaxique sympathique, la gestion de l&#8217;historique dans le pipe et beaucoup d&#8217;autres. Adieu sed, awk, uniq, sort et con sort, vous étiez mes premiers amours, mais pyp vous chasse dehors.</p>
<p>Ce n&#8217;est pas la seule ni la première tentative de faire la peau d&#8217;awk avec python. Sam avait déjà écrit <a href="http://sametmax.com/remplacer-sed-awk-cut-et-perl-par-python-orgasme-pour-sysadmin/" title="une pyped pour Sam">un article </a>sur une autre solution aussi appelée pyped.</p>
<h2> C&#8217;est donc parfait ? </h2>
<p>Oui, bien entendu. Aucun défaut, aucun bug. Ok&#8230; voici les limites : </p>
<ul>
<ol>Perf de daube. Sur des petits volumes (quelques milliers de lignes) ça le fait. Au delà, ça rame. Quelques patch sont proposés pour diviser par trois le temps de traitement :-)</ol>
<ol>Conso mémoire obcène. Idem, pour des petits volumes on s&#8217;en fout, mais sinon ça peut rapidement chiffrer. Pourquoi ? Le machin ne fonctionne pas en stream, tout est gardé en mémoire et à chaque étape de transformation (pour permettre d&#8217;accéder à l&#8217;historique).</ol>
<ol>C&#8217;est installé sur votre pc, mais pas partout, contrairement à ce bon vieux awk. </ol>
</ul>
<p>Amusez vous bien, celui qui fait la plus jolie commande pyp dans les commentaires aura le droit à un bisous.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/black-awk-down/feed/</wfw:commentRss>
		<slash:comments>8</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2014/06/hawk.jpg" length="364221" type="image/jpg" />	</item>
		<item>
		<title>S&#8217;assurer que SELinux ne bloque pas un programme 7</title>
		<link>http://sametmax.com/sassurer-que-selinux-ne-bloque-pas-un-programme/</link>
		<comments>http://sametmax.com/sassurer-que-selinux-ne-bloque-pas-un-programme/#comments</comments>
		<pubDate>Sat, 03 Jan 2015 11:48:34 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Administration System]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=15659</guid>
		<description><![CDATA[Les distros Linux récentes viennent souvent avec des surcouches de protections type policykit, apparmor, SELinux, etc.

Tout ça est bien loin de la simplicité de la notion user/group et leurs permissions, et peut mener à un arrachage de cheveux en règle. ]]></description>
				<content:encoded><![CDATA[<p>Les distros Linux récentes viennent souvent avec des surcouches de protections type policykit, apparmor, SELinux, etc.</p>
<p>Tout ça est bien loin de la simplicité de la notion user/group et leurs permissions, et peut mener à un arrachage de cheveux en règle. </p>
<p>Cette après midi par exemple, on avait notre backend qui ne répondait pas sur le serveur tout neuf. On a changé toutes les permissions, passé de <code>sock://</code> à <code>http://</code>, tweaké les fichiers de settings de iptables, varnish, nginx, gunicorn, supervisor, django&#8230; Puis en dernier recours, on a viré toutes les couches une par une, desinstaller les programmes, réinstaller à neuf, reset les fichiers de config en valeur par défaut, créé des fichiers de config minimaux pour toute la stack, nada. La journée frustrante et foutue en l&#8217;air.</p>
<p>On a quand même isolé le point de blocage sur varnish, et après avoir fait tous les tests possibles et des sacrifices humains, Max a eu l&#8217;intuition SELinux.</p>
<p>Voici maintenant ce qui se passe généralement dans cette situation.</p>
<p>Dans un élan de colère, l&#8217;utilisateur impatient fera un rapide test pour savoir si SELinux le protège comme les USA ont protégé les irakiens :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #7a0874; font-weight: bold;">echo</span> <span style="color: #000000;">0</span> <span style="color: #000000; font-weight: bold;">&gt;/</span>selinux<span style="color: #000000; font-weight: bold;">/</span>enforce</pre></td></tr></table></div>

<p>Ça désactive tout le bouzin jusqu&#8217;au prochain reboot, mettre <code>1</code> inversant la tendance.</p>
<p>Lançant son programme et voyant que ça marche, notre dev échaudé se fend de l&#8217;équivalent du <code>chmod 777 -R</code> pour SELinux, à savoir éditer le fichier de config (<code>/etc/sysconfig/selinux</code> sur Centos) et changer rageusement <code>SELINUX=enforcing</code> pour <code>SELINUX=disabled</code>. Reboot and forget.</p>
<p>Une solution radicale et efficace, certes, mais qui laisse quand même un petit poids sur le conscience : diantre, il y a sûrement un moyen propre d&#8217;essuyer toute cette merde. Où sont les 3 coquillages ?</p>
<p>La solution est dans un petit programme appelé <code>audit2allow</code>, qui fait parti d&#8217;un package plus gros qu&#8217;il vous faudra trouver pour votre OS. Sous CentOs, puisque c&#8217;était notre config ce jour là, on a du faire un petit :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">yum install</span> policycoreutils-python</pre></td></tr></table></div>

<p>Ensuite, on lance notre audit :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">audit2allow <span style="color: #660033;">-a</span> <span style="color: #660033;">-w</span></pre></td></tr></table></div>

<p>Et après un peu de moulinage, il va vous sortir tout un listing de blocage, et quoi faire pour s&#8217;en sortir. Un petit <code>grep votre_prog</code> sur la sortie et vous obtenez ceci :</p>
<pre>type=AVC msg=audit(1331500393.450:25): avc:  denied  { name_connect } for  pid=1276 comm="varnishd" dest=81 scontext=unconfined_u:system_r:varnishd_t:s0 tcontext=system_u:object_r:reserved_port_t:s0 tclass=tcp_socket
        Was caused by:
        One of the following booleans was set incorrectly.
        Description:
        Allow varnishd to connect to all ports, not just HTTP.

        Allow access by executing:
        # setsebool -P varnishd_connect_any 1
        Description:
        Allow system to run with NIS

        Allow access by executing:
        # setsebool -P allow_ypbind 1</pre>
<p>Nous, c&#8217;était varnish qui était bloqué, comme le confirme le discret <strong>denied</strong> dans ce gros blog d&#8217;informations illisibles. A croire que les gars de SELinux ont tout fait pour créer la techno la moins user friendly possible. Je pense que la ligne ne commence pas par &#8220;AVC&#8221; pour rien, chaque fois que SELinux bloque un truc, un devops stagiaire meurt quelque part.</p>
<p>Il suffit ensuite de suivre docilement les instructions. Pour ce cas, on rentre avec les droits admin la commande :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">setsebool <span style="color: #660033;">-P</span> varnishd_connect_any <span style="color: #000000;">1</span></pre></td></tr></table></div>

<p>Et on est bon. </p>
<p>Enfin, jusqu&#8217;à la prochaine après midi de debug incompréhensible qui vous fera revenir à SELinux. Max est beaucoup tenté par la solution 1 pour éviter une nouvelle galère. </p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/sassurer-que-selinux-ne-bloque-pas-un-programme/feed/</wfw:commentRss>
		<slash:comments>7</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2015/01/pNNBLpS.gif" length="121990" type="image/jpg" />	</item>
		<item>
		<title>Créer un réseau ad hoc sous Windows 8 2</title>
		<link>http://sametmax.com/creer-un-reseau-ad-hoc-sous-windows-8/</link>
		<comments>http://sametmax.com/creer-un-reseau-ad-hoc-sous-windows-8/#comments</comments>
		<pubDate>Thu, 04 Dec 2014 15:07:34 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[lan]]></category>
		<category><![CDATA[wifi]]></category>
		<category><![CDATA[windows]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=12704</guid>
		<description><![CDATA[On a pas toujours un switch sous la main, et pourtant, mettre deux ordinateurs en réseau peut se faire sentir. Ok, c'est pour faire une LAN, qui j'essaye de tromper là ?]]></description>
				<content:encoded><![CDATA[<p>On a pas toujours un switch sous la main, et pourtant, mettre deux ordinateurs en réseau peut se faire sentir. Ok, c&#8217;est pour faire une LAN, qui j&#8217;essaye de tromper là ?</p>
<p>La solution, c&#8217;est le réseau ad hoc, c&#8217;est à dire demander à son ordi d&#8217;être point d&#8217;accès WIFI et réseau local.</p>
<p>Sous Windows 7, c&#8217;est facile, panneau de config, réseaux et partages, 3 clics et ça roule.</p>
<p>Mais mon Windows 8 ne voyait pas le réseau, et j&#8217;ai steam installé dessus.</p>
<p>Du coup, on a cherché un moyen de faire le réseau depuis W8, et l&#8217;option a été retirée des GUI.</p>
<p>Heureusement, il reste la ligne de commande.</p>
<p>D&#8217;abord, vérifier que son matos supporte le mode ad hoc :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">netsh wlan show drivers</pre></td></tr></table></div>

<p>Dans la liste, il doit y avoir une ligne à propos d&#8217;un réseau hébergé avec marqué &#8220;oui&#8221;.</p>
<p>Si ce n&#8217;est pas le cas, fin du voyage. Sinon, on configure le réseau (les droits admins sont nécessaires) :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">netsh wlan <span style="color: #000000; font-weight: bold;">set</span> un_nom_de_reseau <span style="color: #007800;">mode</span>=allow <span style="color: #007800;">ssid</span>=un_ssid <span style="color: #007800;">key</span>=un_mot_de_passe</pre></td></tr></table></div>

<p>Quand on veut lancer le réseau :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">netsh wlan start un_nom_de_reseau</pre></td></tr></table></div>

<p>Quand on veut l&#8217;arrêter :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">netsh wlan stop un_nom_de_reseau</pre></td></tr></table></div>

<p>Et les autres systèmes peuvent le voir dans la liste des réseaux WIFI sous le nom de &#8220;un_ssid&#8221; avec le mot de passe &#8220;un_mot_de_passe&#8221;.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/creer-un-reseau-ad-hoc-sous-windows-8/feed/</wfw:commentRss>
		<slash:comments>2</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2014/12/gVXqYHR.jpg" length="58038" type="image/jpg" />	</item>
		<item>
		<title>Servir des fichiers statiques avec nginx 10</title>
		<link>http://sametmax.com/servir-des-fichiers-statiques-avec-nginx/</link>
		<comments>http://sametmax.com/servir-des-fichiers-statiques-avec-nginx/#comments</comments>
		<pubDate>Thu, 23 Oct 2014 06:20:02 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[css]]></category>
		<category><![CDATA[javascript]]></category>
		<category><![CDATA[nginx]]></category>
		<category><![CDATA[static]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=10490</guid>
		<description><![CDATA[C'est un truc donc j'ai tout le temps besoin, alors l'article servira de pense bête. ]]></description>
				<content:encoded><![CDATA[<p>C&#8217;est un truc dont j&#8217;ai tout le temps besoin, alors l&#8217;article servira de pense bête. Marre de chercher à chaque fois :</p>
<pre>
        # sur django, on met tout dans /static/, donc par habitude je le fais
        # pour tout
        location /static/ {

            # Le dossier doit contenir le dossier 'static'. Par exemple si votre
            # arbo est /home/sametmax/repo/static, le chemin sera
            # /home/sametmax/repo. Rassurez-vous, personne n'aura accès aux
            # autres sous dossiers de "repo".
            root  /chemin/absolu/vers/dossier/;

            # On active la compression
            gzip  on;
            gzip_http_version 1.0;
            gzip_vary on;
            gzip_comp_level 6;
            gzip_proxied any;
            gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;
            gzip_buffers 16 8k;

            # Sauf pour les vieux nav
            gzip_disable ~@~\MSIE [1-6].(?!.*SV1)~@~];

            # On dit au navigateur de le mettre en cache pour 3 mois. Faites gaffe,
            # mettez un param dans les url de vos balises script/link qui change
            # à chaque version du fichier, sinon vous ne pourrez pas mettre à jour
            # vos fichiers.
            expires modified +90d;
        }
</pre>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/servir-des-fichiers-statiques-avec-nginx/feed/</wfw:commentRss>
		<slash:comments>10</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2014/10/81RMYJLMA-L__AA1500_.jpg" length="204738" type="image/jpg" />	</item>
		<item>
		<title>Passer d&#8217;une clé Putty (ppk) à une clé OpenSSH 6</title>
		<link>http://sametmax.com/passer-dun-cle-putty-ppk-a-une-cle-openssh/</link>
		<comments>http://sametmax.com/passer-dun-cle-putty-ppk-a-une-cle-openssh/#comments</comments>
		<pubDate>Sat, 27 Sep 2014 12:29:25 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[cle]]></category>
		<category><![CDATA[putty]]></category>
		<category><![CDATA[ssh]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=12248</guid>
		<description><![CDATA[Cas d'école, mon client me donne la clé pour accéder à son instance Amazon (bouh !) et il me file une clé Putty puisqu'il est sous Windows. ]]></description>
				<content:encoded><![CDATA[<p>Cas d&#8217;école, mon client me donne la clé pour accéder à son instance Amazon (bouh !) et il me file une clé Putty puisqu&#8217;il est sous Windows. </p>
<p>Heureusement, Putty existe aussi sous nunux. Par exemple sous Ubuntu :</p>
<pre>sudo apt-get install putty-tools</pre>
<p>Et il embarque tout ce qu&#8217;il faut pour convertir sa clé :</p>
<pre>
puttygen cle.ppk -O public-openssh -o nouvelle_cle.pub
puttygen cle.ppk -O private-openssh -o nouvelle_cle</pre>
<p>Y a plus qu&#8217;à mettre dans son dossier <code>.ssh</code>. En prime, je rajoute généralement ça dans <code>.ssh/config</code> :</p>
<pre>Host ip ou domaine
HostName ip ou domaine
User username pour le server
IdentityFile ~/.ssh/nouvelle_cle</pre>
<p>Comme ça pas besoin de sélectionner la clé manuellement à chaque connexion, si SSH voit cette IP, il me prend la bonne clé.</p>
<p>Mon dossier .ssh est un simple lien vers le vrai dossier dans la partition <a href="http://sametmax.com/eviter-davoir-la-queue-a-lair-en-publique-avec-truecrypt/">Truecrypt</a>. Malgré la disparition du projet, j&#8217;ai pas trouvé mieux.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/passer-dun-cle-putty-ppk-a-une-cle-openssh/feed/</wfw:commentRss>
		<slash:comments>6</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2014/09/SWBP6w7.png" length="285129" type="image/jpg" />	</item>
		<item>
		<title>Le déploiement par conteneurs avec Docker 30</title>
		<link>http://sametmax.com/le-deploiement-par-conteneurs-avec-docker/</link>
		<comments>http://sametmax.com/le-deploiement-par-conteneurs-avec-docker/#comments</comments>
		<pubDate>Thu, 15 May 2014 19:10:39 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[deploiment]]></category>
		<category><![CDATA[docker]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=10270</guid>
		<description><![CDATA[Mettre son projet en production, c'est la galère. Tellement que mille méthodes ont vu le jour pour automatiser tout ça. Dernièrement, grâce à notre cher <a href="http://sametmax.com/author/cortex/">Cortex</a>, j'ai découvert un projet écrit en Go nommé <a href="http://docker.io/">Docker</a>, qui propose encore une autre approche du problème.
]]></description>
				<content:encoded><![CDATA[<p>Mettre son projet en production, c&#8217;est la galère. Tellement que mille méthodes ont vu le jour pour automatiser tout ça. Chef, salt, fabric, des script bash, virtualenv, git hooks, etc.</p>
<p>Après, il y a ceux qui utilisent des VM, qui elles, ont leur propres outils d&#8217;automatisation type Vagrant.</p>
<p>Et comme ça ne suffit pas, des services ce sont mis en place pour faciliter la mise en prod dans le cloud comme Heroku, Gondor, dotCloud&#8230;</p>
<p>Malgré ça, Max fait encore beaucoup de trucs à la main parce que &#8220;ça marche jamais comme prévu&#8221;. Pas très scalable.</p>
<p>Dernièrement, grâce à notre cher <a href="http://sametmax.com/author/cortex/">Cortex</a>, j&#8217;ai découvert un projet écrit en Go nommé <a href="http://docker.io/">Docker</a>, qui propose encore une autre approche du problème.</p>
<p>J&#8217;ai été intrigué après avoir visionné une conf sur le sujet car le principe est très cool, mais aussi parce que j&#8217;ai bossé à une époque avec <a href="https://github.com/jpetazzo">un des mecs</a> de chez Docker. Et ce gars est un monstre. Mais vraiment. Une brute. Le genre qui n&#8217;a pas besoin de souris ni de gestionnaire de fenêtre, mais qui peut vous régler votre problème en tapant d&#8217;une main tout en vous expliquant ce qu&#8217;il fait dans votre domaine d&#8217;expertise alors que ce n&#8217;est pas le sien. Je l&#8217;ai vu faire. C&#8217;est énervant.</p>
<p>Pour le moment, je dois dire que Docker est vraiment sympa. Petit tour du propriétaire.</p>
<h2>C&#8217;est comme si chaque process avait sa mini VM</h2>
<p>Pour faire simple, docker, c&#8217;est de la virtualisation légère.</p>
<p>Ça marche comme cela : on prend une image d&#8217;un Linux de base qu&#8217;on fait tourner dans Docker, on lui installe de quoi faire tourner un process &#8211; par exemple Redis &#8211; et on obtient une nouvelle image qui contient juste la différence avec l&#8217;image précédente. On fait ça avec plein d&#8217;autres process, et quand on a besoin de l&#8217;un d&#8217;entre eux, on lance l&#8217;image qui contient l&#8217;install de celui-ci.</p>
<p>Ce sont des images très légères, on peut en lancer 100 sur une même machine si on le souhaite. Mais elles sont parfaitement isolées : elles ont leur propre système de fichier, leurs propres arbres de processus, utilisateurs, permissions, ports&#8230; Donc si par exemple je fais un nginx compilé avec des extensions exotiques et une config zarb, je peux en faire une image puis l&#8217;utiliser sur n&#8217;importe quel serveur qui contient Docker.</p>
<p>Le but, c&#8217;est de créer plein de petits conteneurs légers et isolés de votre machine. Et au lieu de configurer chaque serveur, on envoie juste les conteneurs dont on a besoin, et on est certain qu&#8217;ils marchent partout pareil, peu importe la config à l&#8217;arrivée. <strong>On virtualise des services, qu&#8217;on combine, et non une machine complète.</strong></p>
<p>Quand je vous dis que c&#8217;est léger, c&#8217;est VRAIMENT léger. A peine plus gourmand que le process sans la VM. En fait, un conteneur Docker démarre presque instantanément, il n&#8217;y a pas de &#8220;boot&#8221; comme pour une vraie VM. Mais on en a les avantages car votre Redis dockerisé marchera pareil sur une Fedora et une Ubuntu.</p>
<p>Docker ne marche que sur Linux pour le moment, et encore, sur un Linux pas trop vieux  car il utilise une technologie récente, dont vous avez probablement peu entendu parler : <a href="https://fr.wikipedia.org/wiki/LXC">LXC</a>.</p>
<p>Détail amusant : Docker est pas mal utilisé dans la communauté des devs sous Mac, qui du coup ont une VM Ubuntu dans laquelle ils font tourner Docker pour travailler. N&#8217;est-ce pas merveilleux ?</p>
<h2>La démonstration obligatoire</h2>
<p>Je ne vais pas vous laisser comme ça et vous demander de vous la mettre derrière l&#8217;oreille, donc exemple d&#8217;utilisation sous Bubuntoune.</p>
<p>Je suis en 14.04, mais je pense que ça marche pareil depuis la 12.04.</p>
<p>Installation :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #666666;">$ </span><span style="color: #c20cb9; font-weight: bold;">sudo</span> <span style="color: #c20cb9; font-weight: bold;">apt-get install</span> docker.io</pre></td></tr></table></div>

<p>Cela va mettre la commande <code>docker.io</code> à votre disposition, mais sous d&#8217;autres systèmes, elle s&#8217;appelle juste <code>docker</code>. Perso je fais un
<pre lang="python bash">alias docker="sudo docker.io"</pre>
<p> puisque de toute façon il faut toujours lancer cette commande avec les droits admin.</p>
<p>Ensuite, on va télécharger une image de base sur laquelle baser toutes nos images :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #666666;">$ </span>docker pull ubuntu</pre></td></tr></table></div>

<p>Docker.io, ce n&#8217;est pas juste un software, c&#8217;est aussi un service qui héberge les images. Vous pouvez bien entendu créer vos propres images de base, et héberger votre  dépôt personnel d&#8217;images, mais on ne va pas se faire chier à faire ça ici. Prévoyez quelques gigas de place, Docker ne prend pas beaucoup de ressources CPU/RAM, mais par contre ça bouffe en espace disque.</p>
<p>Donc là, je demande la récupération des images &#8220;ubuntu&#8221;, qui vont nous servir d&#8217;images de base. Elles sont toutes faites et prêtes à l&#8217;emploi, que demande le peuple ?</p>
<p><strong>Ça va downloader pendant pas mal de temps</strong>, puis vous aurez plusieurs images à votre disposition, que l&#8217;on peut lister ainsi :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">$ docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE
ubuntu              <span style="color: #000000;">12.04</span>               8dbd9e392a96        <span style="color: #000000;">4</span> months ago        <span style="color: #000000;">131.5</span> MB <span style="color: #7a0874; font-weight: bold;">&#40;</span>virtual <span style="color: #000000;">131.5</span> MB<span style="color: #7a0874; font-weight: bold;">&#41;</span>
ubuntu              <span style="color: #000000;">12.10</span>               b750fe79269d        <span style="color: #000000;">5</span> months ago        <span style="color: #000000;">24.65</span> kB <span style="color: #7a0874; font-weight: bold;">&#40;</span>virtual <span style="color: #000000;">180.1</span> MB<span style="color: #7a0874; font-weight: bold;">&#41;</span>
ubuntu              latest              8dbd9e392a96        <span style="color: #000000;">4</span> months ago        <span style="color: #000000;">131.5</span> MB <span style="color: #7a0874; font-weight: bold;">&#40;</span>virtual <span style="color: #000000;">131.5</span> MB<span style="color: #7a0874; font-weight: bold;">&#41;</span>
ubuntu              precise             8dbd9e392a96        <span style="color: #000000;">4</span> months ago        <span style="color: #000000;">131.5</span> MB <span style="color: #7a0874; font-weight: bold;">&#40;</span>virtual <span style="color: #000000;">131.5</span> MB<span style="color: #7a0874; font-weight: bold;">&#41;</span>
ubuntu              quantal             b750fe79269d        <span style="color: #000000;">5</span> months ago        <span style="color: #000000;">24.65</span> kB <span style="color: #7a0874; font-weight: bold;">&#40;</span>virtual <span style="color: #000000;">180.1</span> MB<span style="color: #7a0874; font-weight: bold;">&#41;</span></pre></td></tr></table></div>

<p>Vous faites votre marché : quelle image de base voulez-vous utiliser ?</p>
<p>La 12.04 est une LTS qui est déjà bien field testée, donc je vais prendre celle là.</p>
<p>Ensuite, pour lancer une commande avec, il faut faire <code>docker run id_image commande</code>. Ceci va lancer l&#8217;image, lancer la commande, et dès que la commande se termine, arrêter l&#8217;image :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">$ docker run 74fe38d11401 <span style="color: #7a0874; font-weight: bold;">echo</span> <span style="color: #ff0000;">'YEAHHHHHHHHHHHHHH'</span>
WARNING: Local <span style="color: #7a0874; font-weight: bold;">&#40;</span>127.0.0.1<span style="color: #7a0874; font-weight: bold;">&#41;</span> DNS resolver found <span style="color: #000000; font-weight: bold;">in</span> resolv.conf and containers can<span style="color: #ff0000;">'t use it. Using default external servers : [8.8.8.8 8.8.4.4]
YEAHHHHHHHHHHHHHH</span></pre></td></tr></table></div>

<p>Mesurons le temps pris en tout pour faire cela :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">$ <span style="color: #000000; font-weight: bold;">time</span> <span style="color: #660033;">-f</span> <span style="color: #ff0000;">&quot;%e seconds&quot;</span> <span style="color: #c20cb9; font-weight: bold;">sudo</span> docker.io run 74fe38d11401 <span style="color: #7a0874; font-weight: bold;">echo</span> <span style="color: #ff0000;">'YEAHHHHHHHHHHHHHH'</span>
WARNING: Local <span style="color: #7a0874; font-weight: bold;">&#40;</span>127.0.0.1<span style="color: #7a0874; font-weight: bold;">&#41;</span> DNS resolver found <span style="color: #000000; font-weight: bold;">in</span> resolv.conf and containers can<span style="color: #ff0000;">'t use it. Using default external servers : [8.8.8.8 8.8.4.4]
YEAHHHHHHHHHHHHHH
0.45 seconds</span></pre></td></tr></table></div>

<p>Comme vous le voyez, démarrer un conteneur, c&#8217;est vraiment rapide. Mais faire un
<pre lang="python bash">echo</pre>
<p>, ça ne sert pas à grand chose :)</p>
<p>Faisons quelque chose de plus utile : lançons un terminal bash et demandons un accès à stdin/stdout (<code>-i</code>) ainsi qu&#8217;un tty (<code>-t</code>) :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">$ docker run <span style="color: #660033;">-i</span> <span style="color: #660033;">-t</span> 74fe38d11401 <span style="color: #c20cb9; font-weight: bold;">bash</span>
WARNING: Local <span style="color: #7a0874; font-weight: bold;">&#40;</span>127.0.0.1<span style="color: #7a0874; font-weight: bold;">&#41;</span> DNS resolver found <span style="color: #000000; font-weight: bold;">in</span> resolv.conf and containers can<span style="color: #ff0000;">'t use it. Using default external servers : [8.8.8.8 8.8.4.4]
root@8195e92a5e62:/#</span></pre></td></tr></table></div>

<p>Et hop, comme le process ne se termine pas tant qu&#8217;on est connecté au tty, on a le conteneur qui continue de tourner, mais on a un terminal dessus, nous permettant d&#8217;entrer n&#8217;importe quelle commande.</p>
<p>Si on installait <a href="http://0bin.net/">0bin</a> ?</p>
<p>D&#8217;abord, on a besoin de pip dans le conteneur:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #666666;"># </span><span style="color: #c20cb9; font-weight: bold;">apt-get install</span> python-pip</pre></td></tr></table></div>

<p>Notez qu&#8217;on est toujours root dans son conteneur. Après tout, c&#8217;est virtuel et isolé, donc pas de raison de se faire chier.</p>
<p>Ensuite, on tape dans pypi :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #666666;"># </span>pip <span style="color: #c20cb9; font-weight: bold;">install</span> zerobin</pre></td></tr></table></div>

<p>Pas besoin de virtualenv, on est déjà dans un environnement isolé.</p>
<p>Faisons un petit fichier de config. On va avoir besoin de vim :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #666666; font-style: italic;"># apt-get install vim</span>
<span style="color: #666666; font-style: italic;"># cd /home</span>
<span style="color: #666666; font-style: italic;"># vi settings.py</span></pre></td></tr></table></div>

<p>On met des settings perso pour zerobin, histoire de montrer le principe de faire un conteneur avec un setup sur mesure (on peut, bien entendu, faire 1000 fois plus compliqué, c&#8217;est un exemple bande de bananes) :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #808080; font-style: italic;"># on le fait ecouter sur l'exterieur</span>
HOST <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">&quot;0.0.0.0&quot;</span>
<span style="color: #808080; font-style: italic;"># on change le menu de la page d'accueil</span>
MENU <span style="color: #66cc66;">=</span> <span style="color: black;">&#40;</span>
    <span style="color: black;">&#40;</span><span style="color: #483d8b;">'Home'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'/'</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
    <span style="color: black;">&#40;</span><span style="color: #483d8b;">'Contact'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'mailto:mysupermail@awesomesite.com'</span><span style="color: black;">&#41;</span>
<span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Et on lance notre petit zerobin :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #666666;"># </span>zerobin <span style="color: #660033;">--settings-file</span>=settings.py</pre></td></tr></table></div>

<p>Et voilà, on a un zerobin qui tourne dans notre conteneur isolé.</p>
<p>On va sauvegarder tout ça. Sur notre machine hôte (donc pas dans le conteneur), on va sauvegarder notre nouvelle image. D&#8217;abord, on va trouver l&#8217;ID du conteneur qui tourne :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">$ docker <span style="color: #c20cb9; font-weight: bold;">ps</span>
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                     NAMES
8195e92a5e62        ubuntu:<span style="color: #000000;">12.04</span>        <span style="color: #c20cb9; font-weight: bold;">bash</span>                <span style="color: #000000;">37</span> minutes ago      Up <span style="color: #000000;">37</span> minutes                                 boring_mccarthy</pre></td></tr></table></div>

<p>Ensuite on commite ce conteneur pour obtenir une nouvele image. Pour faire simple, on va l&#8217;appeller &#8220;zerobin&#8221; :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #666666;">$ </span>docker commit 8195e92a5e62 zerobin</pre></td></tr></table></div>

<p>On peut alors tranquillement arrêter notre conteneur :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #666666;">$ </span>docker stop 8195e92a5e62</pre></td></tr></table></div>

<p>Maintenant on peut pusher notre image tout neuve sur un repo distant avec <code>docker push</code> pour pouvoir la puller plus tard. Il faut ouvrir un compte sur leur service ou créer son propre depot, je vous laisse trouver <a href="http://docs.docker.io/use/workingwithrepository/">comment faire</a>. Plus simplement, on peut juste dumper l&#8217;image avec <code>docker save id_image > nom_image.tar</code>, la copier sur une clé USB, et la recharger avec <code>docker load < nom_image.tar</code>.</p>
<p>Dans tous les cas, une fois sur le serveur, vous pouvez lancer votre image "zerobin", ici encore une fois avec la commande bash:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #666666;"># </span>docker run <span style="color: #660033;">-t</span> <span style="color: #660033;">-i</span> <span style="color: #660033;">-p</span> <span style="color: #000000;">7777</span>:<span style="color: #000000;">8000</span> zerobin <span style="color: #c20cb9; font-weight: bold;">bash</span></pre></td></tr></table></div>

<p>Cette fois, on rajoute une option de plus : <code>-p 7777:8000</code> dit à docker de relier le port <code>7777</code> de ma machine au port <code>8000</code> (port de 0bin par défaut) de mon conteneur. Ainsi, si une app va sur le port <code>7777</code> de ma machine, elle va en fait parler au port <code>8000</code> du conteneur sans s'en rendre compte.</p>
<p>Du coup, je peux lancer mon petit zerobin depuis mon contenur :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #666666; font-style: italic;"># cd /home</span>
<span style="color: #666666; font-style: italic;"># zerobin --settings-file=settings.py</span></pre></td></tr></table></div>

<p>Et voilà ! J'ai un zerobin qui marche, qui est préconfiguré, isolé et portable. Si je change de serveur, ou même d'OS, je peux juste reprendre le même conteneur et le relancer tel quel. Et je peux faire ça avec plein de process et les faire communiquer entre eux.</p>
<div id="attachment_10271" style="width: 336px" class="wp-caption aligncenter"><a href="http://sametmax.com/wp-content/uploads/2014/05/Capture-du-2014-05-16-015832.png" class="grouped_elements" rel="tc-fancybox-group10270"><img src="http://sametmax.com/wp-content/uploads/2014/05/Capture-du-2014-05-16-015832.png" alt="Capture d&#039;écran de zerobin" title="J&#039;accède à 7777 sur la machine, mais ça tape sur 8000 dans mon conteneur" width="326" height="179" class="size-full wp-image-10271" /></a><p class="wp-caption-text">J&#039;accède à 7777 sur la machine, mais ça tape sur 8000 dans mon conteneur</p></div>
<p>Docker est un outil très riche, et vous vous doutez bien que je ne vous ai montré que le début.</p>
<p>Par exemple, vous voulez sans doute ne pas avoir à lancer bash, puis un <code>cd</code>, puis zerobin. Ça peut s'automatiser avec un <a href="https://www.docker.io/learn/dockerfile/">dockerfile</a>. Vous voulez aussi peut être lancer le conteneur en arrière-plan, ça se fait avec l'option <code>-d</code>. Ou peut être voulez-vous un dossier partagé entre tous les conteneurs ? C'est possible avec l'option <a href="http://docs.docker.io/use/working_with_volumes/">volume</a>.</p>
<p>Parmi les usages vraiment intéressants de dockers : packager les services très custos comme les nginx ou ffmpeg compilés avec des options cryptiques, deployer son app django avec toutes les libs Python et les settings qui vont bien, remplacer une app à chaud en redirigeant juste le load balancer sur le nouveau conteneur, ou encore fournir un env de test à un client. Perso, rien que pour tester des nouveaux logiciels sans pourrir ma machine, je trouve ça pratique : on a bien moins peur de faire un <code>make install</code>.</p>
<p>Je vous laisse prendre en main le nouveau joujou, j'ai des serveurs à planter.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/le-deploiement-par-conteneurs-avec-docker/feed/</wfw:commentRss>
		<slash:comments>30</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2014/05/OON3N0g.jpg" length="52401" type="image/jpg" />	</item>
	</channel>
</rss>
