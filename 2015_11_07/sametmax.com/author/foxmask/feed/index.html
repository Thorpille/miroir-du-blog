<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Sam &#38; Max &#187; foxmask</title>
	<atom:link href="http://sametmax.com/author/foxmask/feed/" rel="self" type="application/rss+xml" />
	<link>http://sametmax.com</link>
	<description>Du code, du cul</description>
	<lastBuildDate>Sat, 07 Nov 2015 10:56:13 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>http://wordpress.org/?v=4.1</generator>
	<item>
		<title>Prendre le contrôle d&#8217;internet ? C&#8217;est possible ! Dégainez &amp; Tirez avec Trigger Happy 4</title>
		<link>http://sametmax.com/prendre-le-controle-dinternet-cest-possible-degainez-tirez-avec-trigger-happy/</link>
		<comments>http://sametmax.com/prendre-le-controle-dinternet-cest-possible-degainez-tirez-avec-trigger-happy/#comments</comments>
		<pubDate>Sun, 28 Dec 2014 06:45:36 +0000</pubDate>
		<dc:creator><![CDATA[foxmask]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=12972</guid>
		<description><![CDATA[Ceci est un post invité de foxmask posté sous licence creative common 3.0 unported. &#8220;C&#8217;est l&#8217;histoire d&#8217;un mec qu&#8217;est su&#8217;l&#8217;pont de l&#8217;Alma et regarde dans&#8221; &#8230; le python, et comme il débute, se demande mais putain de bordel, des projets à la con à pondre pour se lancer à l&#8217;assaut d&#8217;un langage, c&#8217;est toujours les [&#8230;]]]></description>
				<content:encoded><![CDATA[<p style="text-align: center;"><em><small>Ceci est un post invité de <a href="http://sametmax.com/author/foxmask/">foxmask</a> posté sous licence <a href="http://creativecommons.org/licenses/by/3.0/">creative common 3.0 unported</a>.</small></em></p>
<p>&#8220;C&#8217;est l&#8217;histoire d&#8217;un mec qu&#8217;est su&#8217;l&#8217;pont de l&#8217;Alma et regarde dans&#8221; &#8230; le python, et comme il débute, se demande mais putain de bordel, des projets à la con à pondre pour se lancer à l&#8217;assaut d&#8217;un langage, c&#8217;est toujours les mêmes trucs chiants que plus personne n&#8217;a envie de voir tels : forum, blog, wiki, cms. Alors comment être novateur un poil plus que ces projets sans (plus aucun) défit technique ?</p>
<p>A cette question je me suis dit, pourquoi ne pas produire &#8220;simplement&#8221; (toute proportion gardée) un équivalent libre au célébrissime <a href="https://www.ifttt.com">IFTTT</a> ?</p>
<h2>Mais qu&#8217;est-ce ? </h2>
<p>IFTTT est un service qui vous permet de brancher entre eux, les services internet où vous possédez un compte, comme Twitter, Facebook pour ne citer qu&#8217;eux (parce que la liste est longue comme un python au moins;) Et donc quand un évènement défini se produit sur votre compte twitter, genre un tweet de votre poto tombe, le service réagit au quart de tour pour rebalancer les données ailleurs, sur Facebook, un blog et n&#8217;importe quoi qui vous chante.</p>
<p>Hé bien cet équivalent libre est <a href="https://github.com/foxmask/django-th">Trigger Happy</a>, et ce &#8220;principe&#8221; décrit ci-dessus défini un ESB (Entreprise Service Bus, très connu du monde Java), un BUS qui récupère des données de droite et vous les expédie à gauche.</p>
<p>Wikipedia le défini ainsi :</p>
<blockquote="wikipedia"><p>
L&#8217;enterprise service bus (ESB) est une technique informatique intergicielle. Son but est avant tout de permettre la communication des applications qui n&#8217;ont pas été conçues pour fonctionner ensemble</p></blockquote>
<h2>Pourquoi un tel projet ?</h2>
<p>3 aspects :</p>
<ul>
<li>Avec ce projet je me suis lancé le défit d&#8217;arriver à cerner au mieux Django et abordé au mieux Python.</li>
<li>Comme tout ce que j&#8217;entreprends, se produit par pur réaction allergique à un truc qui m&#8217;a gonflé, explications les zamis :<br />
Au début on fait (plus ou moins) comme tout le monde, sa veille techno à partir de flux RSS de sites web choisis, avec un lecteur de flux RSS moins bien choisi comme iGoogle à une certaine époque ou encore &#8230; Google Reader.<br />
Là le truc qui m&#8217;a pris le chou, ce fut d&#8217;avoir dans Evernote, le résultats des flux RSS de mes sites favoris complètement atrophiés.<br />
Du genre &#8220;il a été à l&#8217;école&#8221; devenait &#8220;il a t l&#8217;cole&#8221;. Or le problème ne vient pas d&#8217;Evernote qui affiche parfaitement nos chers caractères latins, mais de IFTTT qui les bouffait au passage. Outre IFTTT il existe des versions payantes de services mais qui sont vite très vite limitées dans le nombre de triggers déclenchés que sont Zapier et CloudWork.
</li>
<li>
Le dernier aspect concerne sa chère vie privé.<br />
Oui en effet, pour que IFTTT puisse récupérer des donnés d&#8217;un service à l&#8217;autre, il faut que vous ayez un compte sur chaque service comme Twitter et Facebook. Pourquoi IFTTT en a besoin ? Pour que, &#8220;en votre nom&#8221;, avec les accréditations que vous leur octroyez, puisse lire/écrire les informations de part et d&#8217;autre.<br />
Mais pourquoi faire confiance à IFTTT / Cloudwork / Zapier ? Pourquoi leur offrir NOS accréditations les yeux fermés ?<br />
Trigger Happy repond à la question puisque l&#8217;application vous appartient, les accréditations obtenues de Twitter, Facebook etc, sont stockées dans VOTRE application Trigger Happy. Et personne n&#8217;ira les exploiter pour voir ce que vous faites sur vos comptes.
</li>
</ul>
<h2>Comment fonctionne le projet ?</h2>
<p>Dans la version simplifiée ceci donne :<br />
<div id="attachment_5019" style="width: 420px" class="wp-caption aligncenter"><a href="http://www.foxmask.bzh/wp-content/uploads/2014/12/trigger-happy-working.png" class="grouped_elements" rel="tc-fancybox-group12972"><img src="http://www.foxmask.bzh/wp-content/uploads/2014/12/trigger-happy-working.png" alt="Trigger Happy wokring process" width="410" height="351" class="size-full wp-image-5019" /></a><p class="wp-caption-text">Image tirée de ma main &#8220;gauche&#8221; gauche, enfin la gauche pas adroite</p></div><br />
De part et d&#8217;autres (dans les nuages) on a les services qui nous intéressent<br />
Les éclairs oranges sont les connecteurs qui permettent de dialoguer avec les services<br />
Au milieu .. (non ne coule pas une rivière) le moteur Trigger Happy qui gère, via les connecteurs, l&#8217;échange des données.</p>
<p>Dans la version complète ceci donne :<br />
<div id="attachment_5018" style="width: 567px" class="wp-caption aligncenter"><a href="http://www.foxmask.bzh/wp-content/uploads/2014/12/th_esb.png" class="grouped_elements" rel="tc-fancybox-group12972"><img src="http://www.foxmask.bzh/wp-content/uploads/2014/12/th_esb.png" alt="Trigger Happy Micro ESB" width="557" height="347" class="size-full wp-image-5018" /></a><p class="wp-caption-text">Trigger Happy Micro ESB</p></div></p>
<p>On a au milieu un &#8220;tube&#8221; (pipeline) qui va permettre, via des &#8220;command&#8221; &#038; settings &#038; url &#038; service provider, d&#8217;identifier les services &#8220;django th 1, 2, 3, 4&#8243;.<br />
A un moment donné, à l&#8217;entrée du tube, arrive un &#8220;flux&#8221; de donnés identifié pour admettons &#8220;django th 1&#8243; aka un flux RSS (au pif) puis on identifie une destination, admettons &#8220;django th 2&#8243; aka &#8220;twitter&#8221;, et les données collectées repartent donc du tube vers twitter, comme le service s&#8217;attend à les recevoir.</p>
<h2>Dans la vraie vie comment ça se passe  ?</h2>
<p>Ça se passe bien mon zami : je m&#8217;en va (la fote est volontaire tout comme l&#8217;reste;) vous montrer la création d&#8217;un trigger, permettant d&#8217;extraire les billets du flux de mon blog et de les renvoyer sur Twitter en 5 étapes :</p>
<p>Ici en premier lieu vous pouvez voir la liste des services que Trigger Happy gere pour l&#8217;utilisateur courant (mézigues)</p>
<div id="attachment_5023" style="width: 614px" class="wp-caption aligncenter"><a href="http://www.foxmask.bzh/wp-content/uploads/2014/12/trigger_happy_services.png" class="grouped_elements" rel="tc-fancybox-group12972"><img src="http://www.foxmask.bzh/wp-content/uploads/2014/12/trigger_happy_services-1024x539.png" alt="Trigger Happy : services activés" width="604" height="318" class="size-large wp-image-5023" /></a><p class="wp-caption-text">Trigger Happy : services activés</p></div>
<p>Puis l&#8217;accueil de l&#8217;appli où on remarquera que je suis radin en nombre de trigger affichés par page parce que &#8230; je me sers de l&#8217;appli via un browser sur mon smartphone m&#8217;sieur &#8216;dames :<br />
<div id="attachment_5022" style="width: 614px" class="wp-caption aligncenter"><a href="http://www.foxmask.bzh/wp-content/uploads/2014/12/trigger_happy_home.png" class="grouped_elements" rel="tc-fancybox-group12972"><img src="http://www.foxmask.bzh/wp-content/uploads/2014/12/trigger_happy_home-1024x595.png" alt="Trigger Happy : Accueil" width="604" height="351" class="size-large wp-image-5022" /></a><p class="wp-caption-text">Trigger Happy : Accueil</p></div></p>
<p>Etape 1:<br />
<div id="attachment_5024" style="width: 621px" class="wp-caption aligncenter"><a href="http://www.foxmask.bzh/wp-content/uploads/2014/12/trigger_happy_step1.png" class="grouped_elements" rel="tc-fancybox-group12972"><img src="http://www.foxmask.bzh/wp-content/uploads/2014/12/trigger_happy_step1.png" alt="Trigger Happy : Etape 1 de la création d&#039;un trigger" width="611" height="315" class="size-full wp-image-5024" /></a><p class="wp-caption-text">Choix du service fournissant les données</p></div></p>
<p>Etape 2:<br />
<div id="attachment_5025" style="width: 709px" class="wp-caption aligncenter"><a href="http://www.foxmask.bzh/wp-content/uploads/2014/12/trigger_happy_step2.png" class="grouped_elements" rel="tc-fancybox-group12972"><img src="http://www.foxmask.bzh/wp-content/uploads/2014/12/trigger_happy_step2.png" alt="Trigger Happy : Etape 2 de la création d&#039;un trigger" width="699" height="329" class="size-full wp-image-5025" /></a><p class="wp-caption-text">nommage du service et fourniture de l&#8217;origine des données</p></div></p>
<p>Etape 3:<br />
<div id="attachment_5026" style="width: 602px" class="wp-caption aligncenter"><a href="http://www.foxmask.bzh/wp-content/uploads/2014/12/trigger_happy_step3.png" class="grouped_elements" rel="tc-fancybox-group12972"><img src="http://www.foxmask.bzh/wp-content/uploads/2014/12/trigger_happy_step3.png" alt="Trigger Happy : Etape 3 de la création d&#039;un trigger" width="592" height="310" class="size-full wp-image-5026" /></a><p class="wp-caption-text">Choix du service accueillant les données</p></div></p>
<p>Etape 4:<br />
<div id="attachment_5027" style="width: 670px" class="wp-caption aligncenter"><a href="http://www.foxmask.bzh/wp-content/uploads/2014/12/trigger_happy_step4.png" class="grouped_elements" rel="tc-fancybox-group12972"><img src="http://www.foxmask.bzh/wp-content/uploads/2014/12/trigger_happy_step4.png" alt="Trigger Happy : Etape 4 de la création d&#039;un trigger" width="660" height="351" class="size-full wp-image-5027" /></a><p class="wp-caption-text">Trigger Happy : Etape 4 de la création d&#8217;un trigger</p></div></p>
<p>Ensuite le moment venu, se déclenche ce trigger, et pour en voir le résultat, on peut consulter <a href="http://www.foxmask.bzh/post/2014/11/27/django-paris-numa-novembre-2014-demo-live/">le billet</a> que j&#8217;avais préparé le mois dernier pour une présentation Django Paris. Et qui au moment de la publication du billet, à 19h15 pétantes, est tombé sur <a href="https://twitter.com/foxmask/status/538033340155432960">twitter</a> directement et <a href="https://www.evernote.com/pub/foxmask1/Django#st=p&#038;n=e47e8324-ad7e-4b4a-bf4e-0823642b9d3a">Evernote</a> dans la foulée.</p>
<p>Voilà ! </p>
<p>Le défit est parti et n&#8217;attend plus qu&#8217;à ce que le nombre de services croissent. Pour cela rien de plus simple, j&#8217;ai fait une doc expliquant comment pondre un module django qui exploite le service de votre choix tel Buffer, Trello, Dropbox et j&#8217;en passe et des meilleurs. Tout ce dont on a besoin : l&#8217;API du service visé en python, créer un compte pour avoir accès au service et suivre le howto sur <a href="http://trigger-happy.readthedocs.org/en/latest/new_module.html">readthedoc</a>  </p>
<p>Last but not least aux dev : ca tourne avec django 1.7 / Python 2.7 et 3.4</p>
<p>Dernier détail: comme je suis sûr que vous vous demandez pourquoi ce nom de projet ? <a href="http://trigger-happy.eu/static/django-paris-novembre-2014/trigger-happy.png" class="grouped_elements" rel="tc-fancybox-group12972">C&#8217;est un perso de la franchise Skylander</a> auquel joue mon fils et comme le projet &#8220;trigger&#8221; à tirelarigot sur l&#8217;net, ca collait pile poil :)</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/prendre-le-controle-dinternet-cest-possible-degainez-tirez-avec-trigger-happy/feed/</wfw:commentRss>
		<slash:comments>4</slash:comments>
		</item>
		<item>
		<title>Python a le don d&#8217;Ubiquité : Multiprocessing 7</title>
		<link>http://sametmax.com/python-ubiuite-multiprocessing/</link>
		<comments>http://sametmax.com/python-ubiuite-multiprocessing/#comments</comments>
		<pubDate>Sun, 02 Feb 2014 16:41:23 +0000</pubDate>
		<dc:creator><![CDATA[foxmask]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[multiprocessing]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=8939</guid>
		<description><![CDATA[Ceci est un post invité de Foxmask posté sous licence creative common 3.0 unported. Tout récemment j&#8217;ai voulu donner un coup de fouet à mon script de traitement de Trigger Happy (que je fais tourner sur ma &#8220;raspberry pi&#8221; parce que chuis un w4rl0rdZ:P) que j&#8217;estimais être trop long dans ses traitements de données. Actuellement [&#8230;]]]></description>
				<content:encoded><![CDATA[<blockquote><p>Ceci est un post invité de <a href="http://sametmax.com/author/foxmask" target="_blank">Foxmask </a>posté sous licence <a href="http://creativecommons.org/licenses/by/3.0/" target="_blank">creative common 3.0 unported</a>.</p></blockquote>
<p>Tout récemment j&#8217;ai voulu donner un coup de fouet à mon <a href="https://github.com/foxmask/django-th/blob/d91e443795429c85decf0ccf5e1f8470df7d11c4/fire.py">script de traitement</a> de <a href="http://www.foxmask.info/tag/triggerhappy/">Trigger Happy</a> (que je fais tourner sur ma &#8220;raspberry pi&#8221; parce que chuis un w4rl0rdZ:P) que j&#8217;estimais être trop long dans ses traitements de données.</p>
<p>Actuellement avec <a href="https://pypi.python.org/pypi/django_th/">Trigger Happy</a>, j&#8217;ai 30 sources de données (essentiellement des flux rss), que je parcours, et quand un nouvel item arrive, je l&#8217;envoi à pétaouchnock (Evernote ;) Le tout prend <strong>7min</strong>, soit 14secondes par source. La loose totale.</p>
<p>Voici le corps du délit :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">#!/usr/bin/env python</span>
<span style="color: #808080; font-style: italic;"># -*- coding: utf-8 -*-</span>
<span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">__future__</span> <span style="color: #ff7700;font-weight:bold;">import</span> unicode_literals
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">os</span>
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">datetime</span>
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">time</span>
&nbsp;
<span style="color: #dc143c;">os</span>.<span style="color: black;">environ</span>.<span style="color: black;">setdefault</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;DJANGO_SETTINGS_MODULE&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">&quot;django_th.settings&quot;</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">from</span> django_th.<span style="color: black;">services</span> <span style="color: #ff7700;font-weight:bold;">import</span> default_provider
<span style="color: #ff7700;font-weight:bold;">from</span> django_th.<span style="color: black;">models</span> <span style="color: #ff7700;font-weight:bold;">import</span> TriggerService
<span style="color: #ff7700;font-weight:bold;">from</span> django.<span style="color: black;">utils</span>.<span style="color: black;">log</span> <span style="color: #ff7700;font-weight:bold;">import</span> getLogger
&nbsp;
<span style="color: #808080; font-style: italic;"># create logger</span>
logger <span style="color: #66cc66;">=</span> getLogger<span style="color: black;">&#40;</span><span style="color: #483d8b;">'django_th.trigger_happy'</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> go<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;
        run the main process
    &quot;&quot;&quot;</span>
    trigger <span style="color: #66cc66;">=</span> TriggerService.<span style="color: black;">objects</span>.<span style="color: #008000;">filter</span><span style="color: black;">&#40;</span>status<span style="color: #66cc66;">=</span><span style="color: #008000;">True</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">if</span> trigger:
        <span style="color: #ff7700;font-weight:bold;">for</span> service <span style="color: #ff7700;font-weight:bold;">in</span> trigger:
<span style="color: black;">&#91;</span>...<span style="color: black;">&#93;</span>
    <span style="color: #ff7700;font-weight:bold;">else</span>:
        <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;No trigger set by any user&quot;</span>
&nbsp;
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> main<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    default_provider.<span style="color: black;">load_services</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
    <span style="color: #808080; font-style: italic;"># let's go</span>
    go<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">if</span> __name__ <span style="color: #66cc66;">==</span> <span style="color: #483d8b;">&quot;__main__&quot;</span>:
&nbsp;
    main<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Mais avant que je ne me penche sur le code du script pour l&#8217;améliorer, je me suis dit que plutôt que de chercher à corriger un problème, autant chercher la source de celui-ci d&#8217;abord (normal hein).</p>
<p>Un HTOP m&#8217;a révélé :</p>
<ol>
<li>que le CPU était à 100% tout le temps, que le script tourne ou pas</li>
<li>quye la raison était double : rabittmq et celery&#8230; </li>
</ol>
<p>Une fois shootés ces derniers, tout va pour le mieux :P<br />
Je ne dis pas que ceux ci sont de la merde, mais que, pour mon cas, la crontab se suffit à elle-même.</p>
<p>Donc une fois désinstallés c&#8217;est 2 (sur)consommateurs de ressources, je relance le script pour tomber à un temps de traitement à <strong>5mn</strong></p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="shell" style="font-family:monospace;">2014-02-02 14:40:51,693 INFO fire 5142 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - News Sam et Max nothing new
2014-02-02 14:40:53,865 INFO fire 5142 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - News de Numerama nothing new
2014-02-02 14:40:56,013 INFO fire 5142 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - Flux de La Ferme du Web nothing new
2014-02-02 14:41:01,005 INFO fire 5142 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - flux de Paulds nothing new
2014-02-02 14:41:20,098 INFO fire 5142 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - Flux d'un Odieux Connard nothing new
2014-02-02 14:41:22,142 INFO fire 5142 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - Flux de Strict minimum nothing new
2014-02-02 14:41:25,868 INFO fire 5142 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - Humeurs Illustrées nothing new
2014-02-02 14:41:33,497 INFO fire 5142 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - Flux du Journalisme Total nothing new
2014-02-02 14:41:35,658 INFO fire 5142 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - Flux de Kernel Panic nothing new
2014-02-02 14:41:44,897 INFO fire 5142 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - Flux de AngularJS nothing new
2014-02-02 14:41:49,016 INFO fire 5142 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - Flux de Odeon nothing new
2014-02-02 14:41:54,186 INFO fire 5142 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - Flux de Nicolargo nothing new
2014-02-02 14:42:12,525 INFO fire 5142 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - Flux de JEEK nothing new
2014-02-02 14:42:21,349 INFO fire 5142 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - Flux de Recher nothing new
2014-02-02 14:42:31,266 INFO fire 5142 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - Flux de Un blog d'adminsys Libres nothing new
2014-02-02 14:42:35,824 INFO fire 5142 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - flux de Le bloc-notes de Gee nothing new
2014-02-02 14:42:36,647 INFO fire 5142 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - Flux de mere code (atom) nothing new
2014-02-02 14:42:39,616 INFO fire 5142 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - Flux de Alex Mac Caw nothing new
2014-02-02 14:42:42,985 INFO fire 5142 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - Flux de Yearofmoo Articles nothing new
2014-02-02 14:43:42,732 INFO fire 5142 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - News Novapost nothing new
2014-02-02 14:43:46,722 INFO fire 5142 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - News Les Numériques nothing new
2014-02-02 14:43:58,303 INFO fire 5142 date 2014-02-02 13:00:00 &gt;= date triggered 2014-02-02 09:02:36 title Test du Quechua Phone 5, le smartphone des montagnards ?
2014-02-02 14:44:08,010 INFO fire 5142 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - News Frandroid = 1 new data
2014-02-02 14:44:17,624 INFO fire 5142 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - Flux de TechCrunch Mobile nothing new
2014-02-02 14:44:20,339 INFO fire 5142 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - Flux Django annonces nothing new
2014-02-02 14:44:20,744 INFO fire 5142 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - La Hyène - Python nothing new
2014-02-02 14:44:24,237 INFO fire 5142 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - News de PCInpact nothing new
2014-02-02 14:44:29,055 INFO fire 5142 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - PointGPhone nothing new
2014-02-02 14:44:31,299 INFO fire 5142 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - HumanCoders Python nothing new
2014-02-02 14:44:52,751 INFO fire 5142 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - HauteFeuille Lab (python) nothing new
2014-02-02 14:44:58,850 INFO fire 5142 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - Flux de Python Plone Planet nothing new</pre></td></tr></table></div>

<p>Comme je suis un éternel insatisfait de bibi, j&#8217;ai cherché <a href="http://sametmax.com/remplacer-les-threads-avec-le-module-multiprocessing-en-python/">des moyens</a> <a href="http://www.hautefeuille.eu/python-parallelism-multiprocessing.html">un peu partout</a>, jusqu&#8217;à ce que Sam me souffle une suggestion ;)</p>
<p>A présent donc <a href="https://github.com/foxmask/django-th/blob/master/fire.py">une version modifiée pour exploiter le multiprocessing</a> est la suivante :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">#!/usr/bin/env python</span>
<span style="color: #808080; font-style: italic;"># -*- coding: utf-8 -*-</span>
<span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">__future__</span> <span style="color: #ff7700;font-weight:bold;">import</span> unicode_literals
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">os</span>
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">datetime</span>
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">time</span>
<span style="color: #dc143c;">os</span>.<span style="color: black;">environ</span>.<span style="color: black;">setdefault</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;DJANGO_SETTINGS_MODULE&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">&quot;th.settings&quot;</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">from</span> django_th.<span style="color: black;">services</span> <span style="color: #ff7700;font-weight:bold;">import</span> default_provider
<span style="color: #ff7700;font-weight:bold;">from</span> django_th.<span style="color: black;">models</span> <span style="color: #ff7700;font-weight:bold;">import</span> TriggerService
<span style="color: #ff7700;font-weight:bold;">from</span> django.<span style="color: black;">utils</span>.<span style="color: black;">log</span> <span style="color: #ff7700;font-weight:bold;">import</span> getLogger
&nbsp;
<span style="color: #808080; font-style: italic;"># create logger</span>
logger <span style="color: #66cc66;">=</span> getLogger<span style="color: black;">&#40;</span><span style="color: #483d8b;">'django_th.trigger_happy'</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> go<span style="color: black;">&#40;</span>service<span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;
        run the main process
    &quot;&quot;&quot;</span>
    <span style="color: black;">&#91;</span>...<span style="color: black;">&#93;</span>
&nbsp;
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> main<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    default_provider.<span style="color: black;">load_services</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
    <span style="color: #808080; font-style: italic;"># let's go</span>
    trigger <span style="color: #66cc66;">=</span> TriggerService.<span style="color: black;">objects</span>.<span style="color: #008000;">filter</span><span style="color: black;">&#40;</span>status<span style="color: #66cc66;">=</span><span style="color: #008000;">True</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">if</span> trigger:
        <span style="color: #ff7700;font-weight:bold;">from</span> multiprocessing <span style="color: #ff7700;font-weight:bold;">import</span> Pool
        pool <span style="color: #66cc66;">=</span> Pool<span style="color: black;">&#40;</span>processes<span style="color: #66cc66;">=</span><span style="color: #ff4500;">5</span><span style="color: black;">&#41;</span>
        result <span style="color: #66cc66;">=</span> pool.<span style="color: #008000;">map</span><span style="color: black;">&#40;</span>go<span style="color: #66cc66;">,</span> trigger<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">else</span>:
        <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;No trigger set by any user&quot;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">if</span> __name__ <span style="color: #66cc66;">==</span> <span style="color: #483d8b;">&quot;__main__&quot;</span>:
&nbsp;
    main<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>fait tomber le temps de traitement à &#8230; <strong>1min</strong> &#8230;:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="shell" style="font-family:monospace;">$ date &amp;&amp; ./fire.sh &amp;&amp; date 
dimanche 2 février 2014, 14:58:38 (UTC+0100)
2014-02-02 14:58:48,221 INFO fire 5334 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - Flux de La Ferme du Web nothing new
2014-02-02 14:58:48,243 INFO fire 5336 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - Humeurs Illustrées nothing new
2014-02-02 14:58:48,256 INFO fire 5337 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - Flux de Kernel Panic nothing new
2014-02-02 14:58:48,283 INFO fire 5333 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - News Sam et Max nothing new
2014-02-02 14:58:48,907 INFO fire 5335 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - Flux d'un Odieux Connard nothing new
2014-02-02 14:58:49,267 INFO fire 5334 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - flux de Paulds nothing new
2014-02-02 14:58:49,446 INFO fire 5336 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - Flux du Journalisme Total nothing new
2014-02-02 14:58:49,713 INFO fire 5333 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - News de Numerama nothing new
2014-02-02 14:58:49,847 INFO fire 5335 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - Flux de Strict minimum nothing new
2014-02-02 14:58:50,209 INFO fire 5334 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - Flux de Odeon nothing new
2014-02-02 14:58:50,353 INFO fire 5337 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - Flux de AngularJS nothing new
2014-02-02 14:58:50,830 INFO fire 5333 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - Flux de Un blog d'adminsys Libres nothing new
2014-02-02 14:58:51,338 INFO fire 5336 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - Flux de JEEK nothing new
2014-02-02 14:58:51,396 INFO fire 5334 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - Flux de Nicolargo nothing new
2014-02-02 14:58:51,476 INFO fire 5337 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - Flux de Yearofmoo Articles nothing new
2014-02-02 14:58:51,735 INFO fire 5333 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - flux de Le bloc-notes de Gee nothing new
2014-02-02 14:58:52,148 INFO fire 5335 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - Flux de mere code (atom) nothing new
2014-02-02 14:58:52,640 INFO fire 5336 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - Flux de Recher nothing new
2014-02-02 14:58:52,971 INFO fire 5335 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - Flux de Alex Mac Caw nothing new
2014-02-02 14:58:53,416 INFO fire 5334 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - News Les Numériques nothing new
2014-02-02 14:58:53,474 INFO fire 5333 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - Flux de TechCrunch Mobile nothing new
2014-02-02 14:58:53,870 INFO fire 5337 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - News Novapost nothing new
2014-02-02 14:58:54,072 INFO fire 5335 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - PointGPhone nothing new
2014-02-02 14:58:54,316 INFO fire 5333 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - Flux Django annonces nothing new
2014-02-02 14:58:54,853 INFO fire 5336 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - La Hyène - Python nothing new
2014-02-02 14:58:55,111 INFO fire 5335 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - HumanCoders Python nothing new
2014-02-02 14:58:55,222 INFO fire 5334 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - News Frandroid nothing new
2014-02-02 14:58:55,380 INFO fire 5337 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - HauteFeuille Lab (python) nothing new
2014-02-02 14:58:55,696 INFO fire 5336 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - News de PCInpact nothing new
2014-02-02 14:59:02,214 INFO fire 5337 user: foxmask - provider: ServiceRss - consummer: ServiceEvernote - Flux de Python Plone Planet nothing new
dimanche 2 février 2014, 14:59:02 (UTC+0100)</pre></td></tr></table></div>

<p>Comme on l&#8217;aura remarqué la différence entre les 2 versions est l&#8217;appel fait à a fonction go </p>
<p>avant :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> main<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    default_provider.<span style="color: black;">load_services</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
    <span style="color: #808080; font-style: italic;"># let's go</span>
    go<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>après :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> main<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    default_provider.<span style="color: black;">load_services</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
    <span style="color: #808080; font-style: italic;"># let's go</span>
    trigger <span style="color: #66cc66;">=</span> TriggerService.<span style="color: black;">objects</span>.<span style="color: #008000;">filter</span><span style="color: black;">&#40;</span>status<span style="color: #66cc66;">=</span><span style="color: #008000;">True</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">if</span> trigger:
        <span style="color: #ff7700;font-weight:bold;">from</span> multiprocessing <span style="color: #ff7700;font-weight:bold;">import</span> Pool
        pool <span style="color: #66cc66;">=</span> Pool<span style="color: black;">&#40;</span>processes<span style="color: #66cc66;">=</span><span style="color: #ff4500;">5</span><span style="color: black;">&#41;</span>
        result <span style="color: #66cc66;">=</span> pool.<span style="color: #008000;">map</span><span style="color: black;">&#40;</span>go<span style="color: #66cc66;">,</span> trigger<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">else</span>:
        <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;No trigger set by any user&quot;</span></pre></td></tr></table></div>

<p>du coup l&#8217;appel de la fonction &#8220;go&#8221; implique de changer sa signature en lui filant comme <a href="http://sametmax.com/la-difference-entre-parametres-et-arguments/">argument</a> &#8220;trigger&#8221; (le QuerySet de l&#8217;appli Django)</p>
<p>A présent donc <strong>pool.map</strong> fait l&#8217;itération des données trouvées dans le modele <strong>TriggerService</strong> et exécute tout le tintouin. *<:o)</p>
<p>ps : @Sam : chose promise chose dûe ;)</p>
<p><strong>edit:</strong> apres de moult nouveaux essais sur le sujet, seul SQLite supporte cette façon de faire. MySQL, PostgreSQL non. La faute au multiprocessing, qui m&#8217;a-t-on confirmé de ci de là ne convient pas du tout pour gérer des connexions aux bases.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/python-ubiuite-multiprocessing/feed/</wfw:commentRss>
		<slash:comments>7</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2014/02/le-petit-serpent-albinos-a-deux-tetes-credit-photo-sunshine-serpents_35781_w250.jpg" length="16901" type="image/jpg" />	</item>
	</channel>
</rss>
