<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Sam &#38; Max &#187; doctest</title>
	<atom:link href="http://sametmax.com/tag/doctest/feed/" rel="self" type="application/rss+xml" />
	<link>http://sametmax.com</link>
	<description>Du code, du cul</description>
	<lastBuildDate>Sat, 07 Nov 2015 10:56:13 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>http://wordpress.org/?v=4.1</generator>
	<item>
		<title>Un gros guide bien gras sur les tests unitaires en Python, partie 4 8</title>
		<link>http://sametmax.com/un-gros-guide-bien-gras-sur-les-tests-unitaires-en-python-partie-4/</link>
		<comments>http://sametmax.com/un-gros-guide-bien-gras-sur-les-tests-unitaires-en-python-partie-4/#comments</comments>
		<pubDate>Sat, 06 Dec 2014 20:34:40 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[docstring]]></category>
		<category><![CDATA[doctest]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[tests unitaires]]></category>
		<category><![CDATA[unit tests]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=12717</guid>
		<description><![CDATA[<a href="http://sametmax.com/un-gros-guide-bien-gras-sur-les-tests-unitaires-en-python-partie-3/">Après avoir vu pytest</a>, un outil typiquement pythonique sont les doctests, des tests unitaires intégrés dans les <a href="http://sametmax.com/les-docstrings/">docstrings</a>.]]></description>
				<content:encoded><![CDATA[<p>Python est un langage très pro, et il y a beaucoup, beaucoup d&#8217;outils pour faire des tests.</p>
<p><a href="http://sametmax.com/un-gros-guide-bien-gras-sur-les-tests-unitaires-en-python-partie-3/">Après avoir vu pytest</a>, un outil typiquement pythonique sont les doctests, des tests unitaires intégrés dans les <a href="http://sametmax.com/les-docstrings/">docstrings</a>.</p>
<p>Pour rappel, les docstrings, ce sont ces chaînes de caractères qu&#8217;on retrouve au début des modules, sous la signature des fonctions ou dans la définition des classes. Elles servent à la documentation de ceux-ci, ainsi on peut la lire dans le code, et dans les vraies docs car les outils standards savent les extraire.</p>
<p>Ça ressemble à ça :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> une_fonction<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot; Ceci est une docstring.
&nbsp;
        On peut la lire dans le code source, avec help() dans le shell ou
        dans les docs générés par pydoc et sphinx.
    &quot;&quot;&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">pass</span></pre></td></tr></table></div>

<p>Et bien ces docstrings, on peut mettre des tests unitaires dedans formatés comme des sessions de shell Python. Cela permet de donner des exemples d&#8217;usage, tout en testant son code. C&#8217;est chouette.</p>
<p>Musique ?</p>
<p>Musique.</p>
<p><span class='embed-youtube' style='text-align:center; display: block;'><iframe class='youtube-player' type='text/html' width='1170' height='689' src='http://www.youtube.com/embed/hUSm87nvG3k?version=3&#038;rel=1&#038;fs=1&#038;showsearch=0&#038;showinfo=1&#038;iv_load_policy=1&#038;wmode=transparent' frameborder='0' allowfullscreen='true'></iframe></span></p>
<h2>Hello doctests</h2>
<p>Faire des doctests n&#8217;est pas bien compliqué car c&#8217;est du copier coller. On fait une session shell avec ce qu&#8217;on veut tester, et on copie-colle le tout dans la docstring. Fastoche.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #808080; font-style: italic;"># on copie juste la session de shell tel quel</span>
<span style="color: #ff7700;font-weight:bold;">def</span> ajouter<span style="color: black;">&#40;</span>a<span style="color: #66cc66;">,</span> b<span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;
        &gt;&gt;&gt; ajouter(1, 2)
        3
    &quot;&quot;&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> a + b
&nbsp;
<span style="color: #808080; font-style: italic;"># et on demande à Python de parser les doctests. Directement dans votre fichier</span>
<span style="color: #808080; font-style: italic;"># de code. Si, si. Pas de fichier de tests à part.</span>
<span style="color: #ff7700;font-weight:bold;">if</span> __name__ <span style="color: #66cc66;">==</span> <span style="color: #483d8b;">&quot;__main__&quot;</span>:
    <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">doctest</span>
    <span style="color: #dc143c;">doctest</span>.<span style="color: black;">testmod</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>On lance ensuite directement notre fichier de code :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">python mon_module.py</pre></td></tr></table></div>

<p>Et ça n&#8217;affiche absolument rien. C&#8217;est parce qu&#8217;il n&#8217;y a pas d&#8217;erreur. On peut avoir le topo en demandant un peu de verbosité avec <code>-v</code> :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">python mon_module.py <span style="color: #660033;">-v</span>
Trying:
    ajouter<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #000000;">1</span>, <span style="color: #000000;">2</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>
Expecting:
    <span style="color: #000000;">3</span>
ok
<span style="color: #000000;">1</span> items had no tests:
    __main__
<span style="color: #000000;">1</span> items passed all tests:
   <span style="color: #000000;">1</span> tests <span style="color: #000000; font-weight: bold;">in</span> __main__.ajouter
<span style="color: #000000;">1</span> tests <span style="color: #000000; font-weight: bold;">in</span> <span style="color: #000000;">2</span> items.
<span style="color: #000000;">1</span> passed and <span style="color: #000000;">0</span> failed.
Test passed.</pre></td></tr></table></div>

<p>Les doctests marchent purement en se basant sur le formatage texte. Python va prendre la ligne avec <code>>>></code>, l&#8217;exécuter, si la ligne suivante ne contient pas de <code>>>></code>, il va comparer le résultat de l&#8217;exécution de la ligne précédente avec le contenu de la ligne qui la suit.</p>
<p>Ceci passe :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #483d8b;">&quot;&quot;&quot;
    &gt;&gt;&gt; ajouter(1, 2)
    3
&quot;&quot;&quot;</span></pre></td></tr></table></div>

<p>Mais ceci échoue :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #483d8b;">&quot;&quot;&quot;
    &gt;&gt;&gt; ajouter(1, 2)
    4
&quot;&quot;&quot;</span></pre></td></tr></table></div>

<p>Car le résultat AFFICHÉ dans le shell est 3, et non 4.</p>
<p>En cas d&#8217;échec, Python vous en dit un peu plus :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">python mon_module.py
<span style="color: #000000; font-weight: bold;">**********************************************************************</span>
File <span style="color: #ff0000;">&quot;mon_module.py&quot;</span>, line <span style="color: #000000;">6</span>, <span style="color: #000000; font-weight: bold;">in</span> __main__.ajouter
Failed example:
    ajouter<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #000000;">1</span>, <span style="color: #000000;">2</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>
Expected:
    <span style="color: #000000;">4</span>
Got:
    <span style="color: #000000;">3</span>
<span style="color: #000000; font-weight: bold;">**********************************************************************</span>
<span style="color: #000000;">1</span> items had failures:
   <span style="color: #000000;">1</span> of   <span style="color: #000000;">1</span> <span style="color: #000000; font-weight: bold;">in</span> __main__.ajouter</pre></td></tr></table></div>

<h2>Formater ses doctests</h2>
<p>Les doctests sont faits pour s&#8217;intégrer de manière transparente aux docstrings. On peut donc en mettre autant qu&#8217;on veut, au milieu du texte ordinaire de la docstring. Python se base sur les chevrons (<code>>>></code>) pour savoir quand commence un test, et le saut de ligne pour savoir quand ça se termine. Au delà de ça, le style est libre.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> ajouter<span style="color: black;">&#40;</span>a<span style="color: #66cc66;">,</span> b<span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot; Je peux mettre n'importe quoi ici.
&nbsp;
        Et ici aussi.
&nbsp;
        Puis intégrer des tests:
&nbsp;
        &gt;&gt;&gt; ajouter(1, 2)
        3
        &gt;&gt;&gt; ajouter(2, 2)
        4
&nbsp;
        Et un saut de ligne indique que les tests sont terminés. Mais je peux
        encore en ajouter après si je veux.
&nbsp;
        &gt;&gt;&gt; ajouter(0, 0)
        0
&nbsp;
    &quot;&quot;&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> a + b</pre></td></tr></table></div>

<p>Néanmoins, l’intérêt des doctests est de documenter son code à travers les tests, et donc on adoptera généralement un format tel que :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> ajouter<span style="color: black;">&#40;</span>a<span style="color: #66cc66;">,</span> b<span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot; Additionne deux elements.
&nbsp;
        Exemple :
&nbsp;
            &gt;&gt;&gt; # on peut mettre des commentaires ici
            &gt;&gt;&gt; ajouter(1, 2) # ou là
            3
            &gt;&gt;&gt; ajouter(2., 2) # fonctionne sur tous les types de nombre
            4.0
&nbsp;
        La fonction fonctionne en duck typing, et accepte donc tout objet
        qui possède la méthode magique __add__ :
&nbsp;
            &gt;&gt;&gt; ajouter('a', 'b')
            'ab'
            &gt;&gt;&gt; ajouter([1], [2])
            [1, 2]
    &quot;&quot;&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> a + b</pre></td></tr></table></div>

<p>Notez comme il est agréable de lire cette docstring : on comprend tout de suite comment utiliser la fonction. En prime, ce sont des tests unitaires qui garantissent que notre fonction va continuer de fonctionner correctement et nous oblige à garder cette doc à jour.</p>
<p>On peut faire des imports dedans ou utiliser temporairement <a href="http://sametmax.com/debugger-en-python-les-bases-de-pdb/">pdb</a> pour debugger. N&#8217;importe quel code de shell est valide mais faites attention à ne pas démarrer des boucles infinies comme les event loops des GUI ou lib async.</p>
<p>Voici ce que donnerait l&#8217;exemple des articles précédents avec des docstests :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> get<span style="color: black;">&#40;</span>data<span style="color: #66cc66;">,</span> index<span style="color: #66cc66;">,</span> default<span style="color: #66cc66;">=</span><span style="color: #008000;">None</span><span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot; Implémente l'équivalent de dict.get() pour les indexables.
&nbsp;
        Example :
&nbsp;
            &gt;&gt;&gt; simple_comme_bonjour = ('pomme', 'banane')
            &gt;&gt;&gt; get(simple_comme_bonjour, 0)
            'pomme'
            &gt;&gt;&gt; get(simple_comme_bonjour, 1000, 'Je laisse la main')
            'Je laisse la main'
    &quot;&quot;&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">try</span>:
        <span style="color: #ff7700;font-weight:bold;">return</span> data<span style="color: black;">&#91;</span>index<span style="color: black;">&#93;</span>
    <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: #008000;">IndexError</span>:
        <span style="color: #ff7700;font-weight:bold;">return</span> default</pre></td></tr></table></div>

<h2>Problèmes et solutions</h2>
<p>Les doctests ne sont pas la Panacée, particulièrement parce que le test se fera sur le résultat AFFICHÉ dans le shell. Cela peut facilement amener à des erreurs.</p>
<p>Déjà, il faut faire attention à la représentation des objets dans le shell Python. <strong>La représentation n&#8217;est pas forcément la valeur de saisie</strong> :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff4500;">1</span>.
<span style="color: #ff4500;">1.0</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #483d8b;">&quot;1&quot;</span>
<span style="color: #483d8b;">'1'</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: black;">&#123;</span><span style="color: #483d8b;">&quot;foo&quot;</span>: <span style="color: #483d8b;">&quot;bar&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">&quot;une apostrophe : '&quot;</span>: <span style="color: #483d8b;">&quot;est échapée ainsi qu'un accent&quot;</span><span style="color: black;">&#125;</span>
<span style="color: black;">&#123;</span><span style="color: #483d8b;">&quot;une apostrophe : '&quot;</span>: <span style="color: #483d8b;">&quot;est <span style="color: #000099; font-weight: bold;">\x</span>c3<span style="color: #000099; font-weight: bold;">\x</span>a9chap<span style="color: #000099; font-weight: bold;">\x</span>c3<span style="color: #000099; font-weight: bold;">\x</span>a9e ainsi qu'un accent&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'foo'</span>: <span style="color: #483d8b;">'bar'</span><span style="color: black;">&#125;</span></pre></td></tr></table></div>

<p>La solution à ce problème est de tester dans le shell les valeurs de retour, et non de le faire de tête. Faites bien gaffe aux espaces qui sont donc significatifs, surtout ceux en fin de ligne. Mon éditeur est configuré pour les virer par défaut, et ça m&#8217;a niqué en écrivant l&#8217;article :)</p>
<p>Ensuite, il y a des cas où la représentation ne sera pas la même d&#8217;un appel à l&#8217;autre.</p>
<p>C&#8217;est le cas avec les dictionnaires, puisque l&#8217;ordre des éléments n&#8217;est pas garanti par nature. Ne faites donc pas :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> retourne_un_dico<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: black;">&#123;</span><span style="color: #483d8b;">'ordre'</span>: <span style="color: #483d8b;">'non garanti'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'le'</span>: <span style="color: #483d8b;">'resultat'</span><span style="color: black;">&#125;</span></pre></td></tr></table></div>

<p>Mais plutôt quelque chose qui vous garantit l&#8217;affichage :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #483d8b;">&quot;&quot;&quot;
&gt;&gt;&gt; res = list(retourne_un_dico().items())
&gt;&gt;&gt; res.sort()
[('le', 'resultat'), ('ordre', 'non garanti')]
&gt;&gt;&gt; # ou
&gt;&gt;&gt; retourne_un_dico() == {'ordre': 'non garanti', 'le': 'resultat'}
True
&quot;&quot;&quot;</span></pre></td></tr></table></div>

<p>Parfois, on ne peut juste pas garantir l&#8217;affichage. Par exemple avec des nombres non prévisibles comme les hash ou les id des objets :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #483d8b;">&quot;&quot;&quot;
&gt;&gt;&gt; class Test(): pass
&gt;&gt;&gt; repr(Test())
''
&quot;&quot;&quot;</span></pre></td></tr></table></div>

<p><code>7f4687d30fc8</code> n&#8217;est ici pas prévisible. Python met certains cas spéciaux comme celui-ci des flags activables via le commentaire <code># doctest: +NOM_DU_FLAG</code>.</p>
<p>Par exemple, le flag <code>ELLIPSIS</code> permet de placer <code>...</code> dans le résultat en guise de joker :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #483d8b;">&quot;&quot;&quot;
&gt;&gt;&gt; repr(Test()) # doctest: +ELLIPSIS
''
&quot;&quot;&quot;</span></pre></td></tr></table></div>

<p>D&#8217;autres problèmes similaires peuvent être résolus ainsi. Le flag <code>SKIP</code> permet de sauter un test que vous voulez mettre là, en exemple, mais qui ne doit pas être testé :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #483d8b;">&quot;&quot;&quot;
&gt;&gt;&gt; # ce test va être ignoré
&gt;&gt;&gt; repr(Test()) # doctest: +SKIP
''
&quot;&quot;&quot;</span></pre></td></tr></table></div>

<p><code>NORMALIZE_WHITESPACE</code> permet de considérer toute séquence de caractères non imprimables comme un espace. 8 tabs ou 4 espaces dans le résultat seront tous considérés comme un espace.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #483d8b;">&quot;&quot;&quot;
&gt;&gt;&gt; 'ceci est une assez longue ligne divisible' # doctest: +NORMALIZE_WHITESPACE
'ceci    est     une assez longue    ligne divisible'
&quot;&quot;&quot;</span></pre></td></tr></table></div>

<p>Les flags sont cumulables, si on les sépare par des virgules dans le commentaire.</p>
<p>Autre astuce, si votre sortie doit contenir un saut de ligne, Python va l’interpréter comme la fin des tests. On peut pallier cela en utilisant <code>&lt;BLANKLINE&gt;</code> :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #483d8b;">&quot;&quot;&quot;
&gt;&gt;&gt; print('Un saut de ligne<span style="color: #000099; font-weight: bold;">\\</span>n')
Un saut de ligne
&nbsp;
&quot;&quot;&quot;</span></pre></td></tr></table></div>

<p>Faites attention aux antislash et autres caractères spéciaux dans vos docstests puisque toute string est parsée deux fois : une fois à l&#8217;écriture de la docstring, puis une fois à son exécution. Ici vous voyez que je suis tenu d&#8217;échapper mon <code>\n</code> On peut d&#8217;ailleurs utiliser les préfixes <code>r</code> (cf: les <a href="http://sametmax.com/comment-marchent-les-raw-strings-en-python/">raw strings</a>) et <code>u</code> sur les docstrings, si un jour vous êtes bloqué par trop d&#8217;échappements ou des caractères non ASCII en pagaille, pensez-y.</p>
<p>Un cas particulier est celui des exceptions. LOL, n&#8217;est-il pas ?</p>
<p>Pour y répondre, Python décide qu&#8217;une expression est levée si il voit <code>Traceback (most recent call last):</code>. Il ignore ensuite tout le texte &#8211; qui est donc optionnel et que vous pouvez omettre &#8211; jusqu&#8217;à ce qu&#8217;il rencontre le nom de l&#8217;exception levée. À partir de là, il vérifie que le test passe.</p>
<p>Par exemple, si votre exception génère ce traceback :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">Traceback <span style="color: black;">&#40;</span>most recent call last<span style="color: black;">&#41;</span>:
  File <span style="color: #483d8b;">&quot;&quot;</span><span style="color: #66cc66;">,</span> line <span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff7700;font-weight:bold;">in</span> 
  File <span style="color: #483d8b;">&quot;test.py&quot;</span><span style="color: #66cc66;">,</span> line <span style="color: #ff4500;">41</span><span style="color: #66cc66;">,</span> <span style="color: #ff7700;font-weight:bold;">in</span> ajouter
    <span style="color: #ff4500;">1</span> / <span style="color: #ff4500;">0</span>
<span style="color: #008000;">ZeroDivisionError</span>: integer division <span style="color: #ff7700;font-weight:bold;">or</span> modulo by zero</pre></td></tr></table></div>

<p>Vous pouvez faire dans votre doctest :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #483d8b;">&quot;&quot;&quot;
&gt;&gt;&gt; je_leve_une_exception()
Traceback (most recent call last):
ZeroDivisionError: integer division or modulo by zero
&quot;&quot;&quot;</span></pre></td></tr></table></div>

<p>Seule la dernière ligne est comparée.</p>
<p>Il est également possible de mettre les doctests dans un fichier texte à part, mais je ne vous le recommande pas. Cela retire l’intérêt principal des doctests : avoir du code exécutable dans la doc. Si on doit avoir un fichier séparé, autant utiliser des tests normaux, bien plus pratiques et complets.</p>
<p>Car il n&#8217;y a pas de tear down, setup ou fixtures avec les docstests. Ca reste un outil basique.</p>
<p>Sachez néanmoins que les doctests sont parfaitement compris par <code>pytest</code>, il suffit juste de lui demander de les exécuter avec l&#8217;option suivante :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">py.test <span style="color: #660033;">--doctest-modules</span></pre></td></tr></table></div>

<p>Dans ce cas, il n&#8217;est pas nécessaire de faire à la fin de chaque fichier contenant des doctests :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">if</span> __name__ <span style="color: #66cc66;">==</span> <span style="color: #483d8b;">&quot;__main__&quot;</span>:
    <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">doctest</span>
    <span style="color: #dc143c;">doctest</span>.<span style="color: black;">testmod</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<h2>Quand utiliser les doctests ?</h2>
<p>Généralement, on utilise un mélange des tests ordinaires (dans notre cas des tests <code>pytest</code> plutôt que <code>unittest</code>) et des doctests.</p>
<p>On utilisera des doctests pour les objets ou les fonctions simples et indépendantes. J&#8217;entends par là, des fonctions et des objets qui prennent uniquement des types basiques en paramètres, et qui retournent uniquement ces types basiques en paramètres. Pour les objets, ils doivent avoir peu de méthodes.</p>
<p>Pour tout le reste, on utilisera des tests ordinaires.</p>
<p>Par exemple, si vous avez une fonction comme notre exemple <code>get()</code>, les doctests sont un bon choix. En revanche, si vous avez un objet <code>Server</code> qui est un serveur HTTP, ou une fonction qui prend un objet <code>Server</code> en paramètre, il vaut mieux utiliser les tests ordinaires.</p>
<p>Il est tout à fait possible, et même agréable, de mettre quelques tests simples en doctests qui aident à la documentation, et de faire les tests les plus compliqués via <code>pytest</code>.</p>
<p>Prochaine étape, <a href="http://sametmax.com/un-gros-guide-bien-gras-sur-les-tests-unitaires-en-python-partie-5/">les mocks</a>. Parti de là, je pourrai vous dire quelles parties de votre programme tester en priorité, et comment. Au début je voulais faire l&#8217;inverse, mais finalement, c&#8217;est plus pratique.</p>
<hr />
<p><a href="https://github.com/sametmax/codes-des-articles/blob/master/2014/decembre/docstests.py">Télécharger le code de l&#8217;article</a></p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/un-gros-guide-bien-gras-sur-les-tests-unitaires-en-python-partie-4/feed/</wfw:commentRss>
		<slash:comments>8</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2014/12/tumblr_n5i7twM2SY1r539hzo1_500.gif" length="598099" type="image/jpg" />	</item>
		<item>
		<title>Les docstrings en Python 25</title>
		<link>http://sametmax.com/les-docstrings/</link>
		<comments>http://sametmax.com/les-docstrings/#comments</comments>
		<pubDate>Wed, 06 Mar 2013 09:34:00 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[docstring]]></category>
		<category><![CDATA[doctest]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=570</guid>
		<description><![CDATA[Du fait de la nature du tuto, exceptionellement je ne respecterai pas le nouveau format de rédaction. Mais y aura quand même de la zik : Une des mes fonctionnalités favorites en Python est son mécanisme de documentation du code : les doctrings. En effet, je crois qu&#8217;il est très important de rendre simple les [&#8230;]]]></description>
				<content:encoded><![CDATA[<p>Du fait de la nature du tuto, exceptionellement je ne respecterai pas le <a href="http://sametmax.com/quelques-changements-sur-le-blog/">nouveau format de rédaction</a>. Mais y aura quand même de la zik :</p>

<!-- iframe plugin v.2.9 wordpress.org/plugins/iframe/ -->
<iframe width="560" height="315" src="http://www.youtube.com/embed/ls-LYas5j8U" frameborder="0" scrolling="no" class="iframe-class"></iframe>

<p>Une des mes fonctionnalités favorites en Python est son mécanisme de documentation du code : les doctrings. En effet, je crois qu&#8217;il est très important de rendre simple les tâches over chiantes comme <a href="http://sametmax.com/se-simplifier-les-tests-python-avec-pytest/">les tests unitaires</a> ou la doc car moins il y a de frein à le faire, plus il y a de chances qu&#8217;on le fasse.</p>
<h2>Principe</h2>
<p>La docstring est une chaîne de caractères que l&#8217;on n&#8217;assigne pas, et qui est placée à un endroit spécifique du code pour décrire ce dernier.</p>
<p>La docstring la plus courante est placée sous une fonction. Voici une fonction SANS docstring :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> ajouter<span style="color: black;">&#40;</span>a<span style="color: #66cc66;">,</span> b<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">return</span> a + b</pre></td></tr></table></div>

<p>Et voici une fonction AVEC docstring :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> ajouter<span style="color: black;">&#40;</span>a<span style="color: #66cc66;">,</span> b<span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;
        Ajoute deux nombres l'un à l'autre et retourne
        le résultat.
    &quot;&quot;&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> a + b</pre></td></tr></table></div>

<p>La chaîne de caractère doit être placée juste en dessous de la signature de la fonction.</p>
<p>Écrire des docstrings offrent de nombreux avantages :</p>
<ul>
<li>La fonction <code>help()</code> affiche cette documentation dans un shell.</li>
<li>Les outils de programmation tels que les shells ou les IDE affichent cette documentation quand le développeur qui ne lit pas votre code, mais l&#8217;utilise, en a besoin.</li>
<li>On peut générer une bonne doc du code avec des commandes qui extraient ces docstrings.</li>
<li>C&#8217;est un mécanisme standardisé de documentation : tout le monde sait que si c&#8217;est là, et que ça a cette forme, c&#8217;est une documentation.</li>
<li>Le code Python peut utiliser la docstring pour la lire ou l&#8217;afficher.</li>
<li>On peut mettre des tests dans les docstrings, qui servent alors d&#8217;exemples d&#8217;utilisation.</li>
</ul>
<h2>Usage</h2>
<p>Si vous avez une fonction ainsi faite :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> ajouter<span style="color: black;">&#40;</span>a<span style="color: #66cc66;">,</span> b<span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;
        Ajoute deux nombres l'un à l'autre et retourne
        le résultat.
    &quot;&quot;&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> a + b</pre></td></tr></table></div>

<p>Alors dans un shell, toute personne qui va utiliser votre fonction pourra faire :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">help</span><span style="color: black;">&#40;</span>ajouter<span style="color: black;">&#41;</span>
Help on function ajouter <span style="color: #ff7700;font-weight:bold;">in</span> module <span style="color: #dc143c;">__main__</span>:
&nbsp;
ajouter<span style="color: black;">&#40;</span>a<span style="color: #66cc66;">,</span> b<span style="color: black;">&#41;</span>
    Ajoute deux nombres l<span style="color: #483d8b;">'un à l'</span>autre et retourne
    le résultat.</pre></td></tr></table></div>

<p>Il y a ainsi une documentation de votre fonction DANS le shell, sans avoir à se connecter à Internet ou quoi que ce soit. Il n&#8217;a pas à ouvrir le moindre fichier.</p>
<p>On peut documenter également les modules en plaçant la docstring comme première expression Python (qui n&#8217;est pas un commentaire) tout en haut du fichier :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">#!/usr/bin/env python</span>
<span style="color: #808080; font-style: italic;"># -*- coding: utf-8 -*-</span>
&nbsp;
&nbsp;
<span style="color: #483d8b;">&quot;&quot;&quot;
    Ceci est un module génial qui va faire 
    plein de trucs super cool.
&quot;&quot;&quot;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">threading</span>
<span style="color: #ff7700;font-weight:bold;">import</span> multiprocessing
<span style="color: #ff7700;font-weight:bold;">from</span> functools <span style="color: #ff7700;font-weight:bold;">import</span> wraps
<span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">Queue</span> <span style="color: #ff7700;font-weight:bold;">import</span> Empty
&nbsp;
<span style="color: #ff7700;font-weight:bold;">class</span> BaseAsbtractAdapterStrategyFactoryMock<span style="color: black;">&#40;</span><span style="color: #008000;">object</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">pass</span></pre></td></tr></table></div>

<p>On peut aussi documenter une classe et ses méthodes :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">class</span> ADallas<span style="color: black;">&#40;</span><span style="color: #008000;">object</span><span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;
        Cette classe vous donne le classe à Dallas
        quand vous en avez vraiment besoin.
    &quot;&quot;&quot;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> univers_impitoyable<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #483d8b;">&quot;&quot;&quot;
            Retourne un objet univers, prêt
            à être impitoyable.
        &quot;&quot;&quot;</span></pre></td></tr></table></div>

<p>La plupart des fonctions et modules de la lib standard sont ainsi documentées, vous pouvez donc faire :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">os</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">help</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">os</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">from</span> functools <span style="color: #ff7700;font-weight:bold;">import</span> partial
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">help</span><span style="color: black;">&#40;</span>partial<span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">help</span><span style="color: black;">&#40;</span><span style="color: #008000;">str</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">help</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'foo'</span>.<span style="color: black;">upper</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<h2>Bonnes pratiques</h2>
<p>D&#8217;abord, et malgré mes exemples à caractère purement pédagogique précédents, votre docstring devrait être en anglais. Même quand vous travaillez uniquement avec des français. L&#8217;anglais est la lingua franca (oui, oui, je sais&#8230;) de l&#8217;informatique, et de plus vous évitez tout problème d&#8217;encoding car vous n&#8217;avez aucun moyen de savoir si cette doc sera lue dans un shell rêglé avec les pieds (comme celui de Windows).</p>
<p>J&#8217;écrirai un article pour motiver les résistants à se mettre à l&#8217;anglais une bonne fois pour toute.</p>
<p>L&#8217;anglais est votre ami. Il est la novlang de notre métier. C&#8217;est pas vendeur ça ?</p>
<p>Bref.</p>
<p>Ensuite, il existe plusieurs manières de formater une docstring, et il y a même un <a href="http://www.python.org/dev/peps/pep-0257/">PEP 257</a> qui ne parle que de ça. En résumé :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> foo<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;Docstring d'une ligne&quot;&quot;&quot;</span>
&nbsp;
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> foo<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;Résumé de la docstring de plusieurs lignes.
&nbsp;
    Contenu détaillé de la doctstring.
    Contenu détaillé de la doctstring.
    Contenu détaillé de la doctstring.
&nbsp;
    &quot;&quot;&quot;</span></pre></td></tr></table></div>

<p>Je ne respecte jamais cette convention. Généralement je fais plutôt :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> foo<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;
        Docstring d'une ligne.
    &quot;&quot;&quot;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> foo<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;
        Résumé de la docstring de plusieurs lignes.
&nbsp;
        Contenu détaillé de la doctstring.
        Contenu détaillé de la doctstring.
        Contenu détaillé de la doctstring.
    &quot;&quot;&quot;</span></pre></td></tr></table></div>

<p>Je trouve ça immensément plus lisible dans le code. Je ne peux pas vous recommander de faire comme moi, puisque c&#8217;est aller à l&#8217;encontre du PEP. Tout ce que je peux vous dire c&#8217;est que personne ne s&#8217;est jamais plaint de cette habitude. En matière de docstring, la plupart des gens sont juste déjà trop heureux qu&#8217;il y en ait.</p>
<p>En revanche, tout le monde est d&#8217;accord sur le fait qu&#8217;une ligne de la docstring ne doit pas faire plus de 80 caractères. Donc indentez en conséquence. Le plugin SublimeText <a href="https://github.com/ehuss/Sublime-Wrap-Plus">Wrap-Plus</a> permet de le faire automatiquement avec <kbd>Alt</kbd> + <kbd>Q</kbd> (et bien plus). Un must have.</p>
<h2>Usage avancé</h2>
<p>Python étant un langage qui aime l&#8217;instrospection, la docstring est accessible depuis le code sous la forme de l&#8217;attribut <code>__doc__</code> :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">def</span> foo<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
...     <span style="color: #483d8b;">&quot;&quot;&quot;
...         Can foo a bar with ease
...     &quot;&quot;&quot;</span>
...     <span style="color: #ff7700;font-weight:bold;">pass</span>
...
<span style="color: #66cc66;">&gt;&gt;&gt;</span> foo.__doc__
<span style="color: #483d8b;">'<span style="color: #000099; font-weight: bold;">\n</span>        Can foo a bar with ease<span style="color: #000099; font-weight: bold;">\n</span>    '</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span></pre></td></tr></table></div>

<p>Vous ne vous en servirez pas souvent, mais c&#8217;est utile pour créer le help d&#8217;un script (c&#8217;est ce que fait <a href="http://sametmax.com/sept-petites-libs-qui-changent-la-vie-dun-dev-python/">clize</a>) ou faire une popup dans un IDE.</p>
<p>Une autre particularité des docstrings, c&#8217;est qu&#8217;elles sont très utilisées dans les générateurs de documentation comme <a href="http://sphinx-doc.org/">sphinx</a>. Et ils comprennent généralement très bien <a href="http://thomas-cokelaer.info/tutorials/sphinx/docstring_python.html">le format RST</a>.</p>
<p>Le format RST est une convention de balisage pour formater du texte. Il garde le texte lisible, mais permet de générer du HTML, du PDF et un tas d&#8217;autres trucs plus propres. Aussi je vous invite à l&#8217;utiliser si vous avez une docstring dont vous sentez qu&#8217;elle a besoin d&#8217;être aussi complète que possible.</p>
<p>Voici toutes les balises à votre disposition :</p>
<pre>:param arg1: description
:param arg2: description
:type arg1: type
:type arg1: type
:return: description de la valeur de retour
:rtype: type de la valeur de retour

:Example:

Un exemple écrit après un saut de ligne.

.. seealso:: Référence à une autre partie du code
.. warnings:: Avertissement
.. note:: Note
.. todo:: A faire</pre>
<p>On peut aussi utilise <code>``element``</code> pour signaler un morceau de code au milieu du texte. Sur les docstrings très longues (il n&#8217;est pas rare qu&#8217;une docstring soit plus longue que le code qu&#8217;elle documente), comme celles des modules, on peut sous-ligner les titres et sous-titres avec des <code>=</code> et des <code>-</code>.</p>
<p>Par exemple :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">#!/usr/bin/env python</span>
<span style="color: #808080; font-style: italic;"># -*- coding: utf-8 -*-</span>
&nbsp;
<span style="color: #483d8b;">&quot;&quot;&quot;
    The ``obvious`` module
    ======================
&nbsp;
    Use it to import very obvious functions.
&nbsp;
    :Example:
&nbsp;
    &gt;&gt;&gt; from obvious import add
    &gt;&gt;&gt; add(1, 1)
    2
&nbsp;
    This is a subtitle
    -------------------
&nbsp;
    You can say so many things here ! You can say so many things here !
    You can say so many things here ! You can say so many things here !
    You can say so many things here ! You can say so many things here !
    You can say so many things here ! You can say so many things here !
&nbsp;
    This is another subtitle
    ------------------------
&nbsp;
    Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod
    tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam,
    quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo
    consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse
    cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non
    proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
&nbsp;
&nbsp;
&quot;&quot;&quot;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> add<span style="color: black;">&#40;</span>a<span style="color: #66cc66;">,</span> b<span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;
        Adds two numbers and returns the result.
&nbsp;
        This add two real numbers and return a real result. You will want to
        use this function in any place you would usually use the ``+`` operator
        but requires a functional equivalent.
&nbsp;
        :param a: The first number to add
        :param b: The second number to add
        :type a: int
        :type b: int
        :return: The result of the addition
        :rtype: int
&nbsp;
        :Example:
&nbsp;
        &gt;&gt;&gt; add(1, 1)
        2
        &gt;&gt;&gt; add(2.1, 3.4)  # all int compatible types work
        5.5
&nbsp;
        .. seealso:: sub(), div(), mul()
        .. warnings:: This is a completly useless function. Use it only in a 
                      tutorial unless you want to look like a fool.
        .. note:: You may want to use a lambda function instead of this.
        .. todo:: Delete this function. Then masturbate with olive oil.
    &quot;&quot;&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> a + b</pre></td></tr></table></div>

<p>Aucun champ n&#8217;est obligatoire, aucuns ne sont interdépendant. Cela vous donne une grande flexibilité pour savoir jusqu&#8217;à quel point vous voulez documenter votre fonction.</p>
<p>La section la plus importante à mon sens est <code>:Example:</code>. Avec ça une personne peut généralement avoir une bonne idée de ce qui se passe, et en plus ça sert de tests (comme on le verra plus loin).</p>
<p>La section la plus inutile est de loin <code>.. todo::</code>. En fait je vous recommande de ne pas l&#8217;utiliser. Si vous avez des todos, utilisez plutôt la convention de commentaire :</p>
<p><code># TODO: un truc à faire</code></p>
<p>Car :</p>
<ul>
<li>Je pense que vos TODO n&#8217;ont rien à foutre dans la doc.</li>
<li>Il faut mieux avoir un TODO le plus proche du truc qu&#8217;il doit modifier. Le mettre en haut de la fonction n&#8217;a pas toujours de sens.</li>
<li>De très nombreux outils et services détectent ce format automatiquement et en font quelque chose d&#8217;utile.</li>
</ul>
<p>Le typage des arguments et de la valeur de retour n&#8217;est pas toujours utile, surtout avec Python faisant massivement usage du duck typing. La description est plus importante. Mettez le typage quand le type n&#8217;est pas intuitif ou signalez une caratéristique comme : itérable, indexable, file-like object, etc.</p>
<p><em>EDIT: ah, y aussi un field <code>raises</code> pour déclarer que le code peut lever une exception en particulier. J&#8217;avais zappé. On m&#8217;a aussi demandé si il y avait des équivalent à <code>@since</code> et <code>@depreciated</code> mais non, en général on fout ça dans <code>.. note::</code> ou <code>.. warning:: </code></em></p>
<h2>Doc tests<br />
</h2>
<p>Une fonctionalité controversée des docstrings sont les doctests, des tests unitaires directement intégrés dans la docstring.</p>
<p>Mon conseil : utilisez les docstests pour des petites fonctions simples ou pour quelques exemples sur les fonctions complexes, et complétez les avec des tests ordinnaires. Ce sont des bons compléments, mais pas forcément idéales pour contenir TOUS les tests. Après, si c&#8217;est le seul truc qui vous motive pour écrire des tests, mettez tout dedans, il vaut mieux ça que rien du tout.</p>
<p>Une doc test est donc la rédaction d&#8217;une partie de la docstring avec la syntaxe d&#8217;un shell :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> add<span style="color: black;">&#40;</span>a<span style="color: #66cc66;">,</span> b<span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;
        Do I neeed to explain this ?
&nbsp;
        :Example:
&nbsp;
        &gt;&gt;&gt; add(1, 1)
        2
        &gt;&gt;&gt; add(2.1, 3.4)  # all int compatible types work
        5.5
&nbsp;
    &quot;&quot;&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> a + b
&nbsp;
<span style="color: #808080; font-style: italic;"># A la fin de votre script, mettez ce snippet qui va activer les doctest</span>
<span style="color: #ff7700;font-weight:bold;">if</span> __name__ <span style="color: #66cc66;">==</span> <span style="color: #483d8b;">&quot;__main__&quot;</span>:
    <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">doctest</span>
    <span style="color: #dc143c;">doctest</span>.<span style="color: black;">testmod</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Si vous importez ce module, il ne se passera rien. Mais si vous faites <code>python script.py</code>, Python va exécuter <code>add(1, 1)</code> et vérifier que cela affiche bien <code>2</code>, puis exécuter <code>add(2.1, 3.4)</code> et vérifier que cela affiche bien <code>5.5</code>.</p>
<p>Si il n&#8217;y a aucune erreur, le script se termine silencieusement (il donne des détails si on utilise l&#8217;option <code>-v</code>). Sinon, il beugle. Par exemple si je rajoute :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> add<span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span>
<span style="color: #ff4500;">3</span></pre></td></tr></table></div>

<p>On obtient en sortie :</p>
<pre>$ python script.py
*******************************************
File "script.py", line 7, in __main__.add
Failed example:
    add(1, 1)
Expected:
    3
Got:
    2
*******************************************
1 items had failures:
   1 of   2 in __main__.add
***Test Failed*** 1 failures.</pre>
<p><strong>Attention !</strong></p>
<p>Python compare non pas la valeur, mais CE QUI S&#8217;AFFICHE. Ça peut être très déroutant. Si j&#8217;ai les tests :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #008000;">str</span><span style="color: black;">&#40;</span>add<span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>        
<span style="color: #ff4500;">2</span>        
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">str</span><span style="color: black;">&#40;</span>add<span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>        
<span style="color: #ff4500;">2</span></pre></td></tr></table></div>

<p>Ça va planter :</p>
<pre>$ python script.py
*******************************************
File "script.py", line 10, in __main__.add
Failed example:
    str(add(1, 1))
Expected:
    2
Got:
    '2'
*******************************************
1 items had failures:
   1 of   2 in __main__.add
***Test Failed*** 1 failures.</pre>
<p>Il aurait fallu que j&#8217;écrive :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #008000;">str</span><span style="color: black;">&#40;</span>add<span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #ff4500;">2</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">str</span><span style="color: black;">&#40;</span>add<span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #483d8b;">'2'</span></pre></td></tr></table></div>

<p>Notez les guillemets. C&#8217;est ainsi que ça s&#8217;afficherait dans le shell. Donc c&#8217;est ce que teste Python.</p>
<p>C&#8217;est la raison pour laquelle les docstests ne sont pas parfaites pour les gros tests. Si vous testez des caratères d&#8217;échappements ou du texte unicode, il vous faudra préfixer vos doctests de <code>ur</code> sinon ça va échouer :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">ur<span style="color: #483d8b;">&quot;&quot;&quot;
    Ceci est une doctring écrite en unicode, sans interprétation des caractères
    d'échappement.
&quot;&quot;&quot;</span></pre></td></tr></table></div>

<p>Même problème pour les textes longs. Il faut préciser qu&#8217;on veut tester une sortie tronquée avec <code>+ELLIPSIS</code> :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #008000;">range</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">1000</span><span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># doctest: +ELLIPSIS</span>
<span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> ...<span style="color: #66cc66;">,</span> <span style="color: #ff4500;">18</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">999</span><span style="color: black;">&#93;</span></pre></td></tr></table></div>

<p>Car vous allez pas écrire les 1000 entiers pour le fun dans le test. Pareil pour les stacktraces.</p>
<p>Les espaces sont signficatifs, du coup il faut parfois marquer les tests avec <code>+NORMALIZE_WHITESPACE</code> :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #008000;">range</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">20</span><span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># doctest: +NORMALIZE_WHITESPACE</span>
<span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span><span style="color: #66cc66;">,</span>   <span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span>  <span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span>  <span style="color: #ff4500;">3</span><span style="color: #66cc66;">,</span>  <span style="color: #ff4500;">4</span><span style="color: #66cc66;">,</span>  <span style="color: #ff4500;">5</span><span style="color: #66cc66;">,</span>  <span style="color: #ff4500;">6</span><span style="color: #66cc66;">,</span>  <span style="color: #ff4500;">7</span><span style="color: #66cc66;">,</span>  <span style="color: #ff4500;">8</span><span style="color: #66cc66;">,</span>  <span style="color: #ff4500;">9</span><span style="color: #66cc66;">,</span>
<span style="color: #ff4500;">10</span><span style="color: #66cc66;">,</span>  <span style="color: #ff4500;">11</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">12</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">13</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">14</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">15</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">16</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">17</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">18</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">19</span><span style="color: black;">&#93;</span></pre></td></tr></table></div>

<p>Sinon c&#8217;est galère car il faut reformater la sortie à la main correctement.</p>
<p>Enfin, sur les structures de données comme les dicos, l&#8217;ordre des éléments n&#8217;est pas garanti, donc l&#8217;ordre d&#8217;affichage non plus. Quand aux données aléatoires&#8230;</p>
<p>Bref, les docstests, c&#8217;est cool, mais il ne faut pas en abuser.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/les-docstrings/feed/</wfw:commentRss>
		<slash:comments>25</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2013/03/291486324_426.jpg" length="57343" type="image/jpg" />	</item>
	</channel>
</rss>
