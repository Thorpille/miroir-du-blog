<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Sam &#38; Max &#187; varnish</title>
	<atom:link href="http://sametmax.com/tag/varnish/feed/" rel="self" type="application/rss+xml" />
	<link>http://sametmax.com</link>
	<description>Du code, du cul</description>
	<lastBuildDate>Sat, 07 Nov 2015 10:56:13 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>http://wordpress.org/?v=4.1</generator>
	<item>
		<title>C&#8217;est l&#8217;histoire d&#8217;un blog qui traverse la route et PAF le blog 10</title>
		<link>http://sametmax.com/cest-dun-blog-qui-traverse-la-route-et-paf-le-blog/</link>
		<comments>http://sametmax.com/cest-dun-blog-qui-traverse-la-route-et-paf-le-blog/#comments</comments>
		<pubDate>Tue, 01 Oct 2013 13:49:17 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Philo et culture]]></category>
		<category><![CDATA[hosting]]></category>
		<category><![CDATA[meta]]></category>
		<category><![CDATA[varnish]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=7290</guid>
		<description><![CDATA[Retour à la normale, avec notre bon vieux WP pourri, un cache trop agressif devant, un design moche et des articles honteux.]]></description>
				<content:encoded><![CDATA[<p>Retour à la normale, avec notre bon vieux WP pourri, un cache trop agressif devant, un design moche et des articles honteux.</p>
<p>Bienvenue sur Sam et Max.</p>
<p>Donc après que Lease Web nous ait lâché plusieurs fois dans le mois, notre Varnish a décidé de ne pas fonctionner pour une raison qui restera mystérieuse. Du coup on a pris un autre hébergeur, et Max, dans une tentative désespérée avant la migration, a tenté une cure par imposition des mains.</p>
<p>Ça a marché, du coup j&#8217;ai pris un serveur pour rien ^^ On va rester sur ce serveur du fait de notre flemme légendaire et parce que, bah, on a aucun revenu attaché au blog donc si il est pas disponible ça nous coûte rien à part de répondre aux tweets attristés des fans.</p>
<p>Bref, je reviens avec plein d&#8217;idées d&#8217;articles, des concepts novateurs (qui ne verront jamais le jour par manque de temps, mais c&#8217;est l&#8217;intention qui fait le forgeron) et quelques millions d&#8217;entrées dans les mails, flux RSS et autres outils dit &#8220;d&#8217;information&#8221; qui ont pour mission de s&#8217;assurer que vous n&#8217;aurez jamais la bonne, noyée dans la masse.</p>
<p>Notre référencement s&#8217;est évidement fait plomber, car un bonheur n&#8217;arrive jamais seul. Mais on s&#8217;en fout parce qu&#8217;on a encore pu profiter de la plage et du soleil pendant que vous êtes tous sous la grisaille. Et savoir que la situation des autres est pire que la sienne, ça n&#8217;a pas de prix.</p>
<p>C&#8217;est reparti !</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/cest-dun-blog-qui-traverse-la-route-et-paf-le-blog/feed/</wfw:commentRss>
		<slash:comments>10</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2013/10/32678906.jpg" length="129224" type="image/jpg" />	</item>
		<item>
		<title>Savoir si une page est en cache avec Varnish 2</title>
		<link>http://sametmax.com/savoir-si-une-page-est-en-cache-avec-varnish/</link>
		<comments>http://sametmax.com/savoir-si-une-page-est-en-cache-avec-varnish/#comments</comments>
		<pubDate>Wed, 01 May 2013 07:44:34 +0000</pubDate>
		<dc:creator><![CDATA[Max]]></dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[Programmation]]></category>
		<category><![CDATA[cache]]></category>
		<category><![CDATA[hit]]></category>
		<category><![CDATA[miss]]></category>
		<category><![CDATA[varnish]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=5945</guid>
		<description><![CDATA[Petite astuce pour savoir si Varnish fait bien son boulot. L'affichage dans les Headers d'un debug permettant de savoir si votre page a bien été servit depuis le cache plutôt que le backend.]]></description>
				<content:encoded><![CDATA[<p>Pour savoir si cette feignasse de Varnish a bien fait son boulot voici une petite astuce pour afficher dans les HEADERS de son navigateur la provenance de la page, le cache ou le backend.<br />
Varnish propose dans son <a href="https://www.varnish-cache.org/trac/wiki/VCLExampleHitMissHeader">wiki</a> cette méthode.</p>
<p><strong><br />
dans le fichier de conf de Varnish:</strong></p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">vi</span> <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>varnish<span style="color: #000000; font-weight: bold;">/</span>default.vcl</pre></td></tr></table></div>

<p><b>et rajoutez ces quelques lignes:</b></p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">sub vcl_deliver <span style="color: #7a0874; font-weight: bold;">&#123;</span>
        <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>obj.hits <span style="color: #000000; font-weight: bold;">&gt;</span> <span style="color: #000000;">0</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
                <span style="color: #000000; font-weight: bold;">set</span> resp.http.X-Cache = <span style="color: #ff0000;">&quot;HIT&quot;</span>;
        <span style="color: #7a0874; font-weight: bold;">&#125;</span> <span style="color: #000000; font-weight: bold;">else</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
                <span style="color: #000000; font-weight: bold;">set</span> resp.http.X-Cache = <span style="color: #ff0000;">&quot;MISS&quot;</span>;
        <span style="color: #7a0874; font-weight: bold;">&#125;</span>
<span style="color: #7a0874; font-weight: bold;">&#125;</span></pre></td></tr></table></div>

<p><b>On redemarre le service pour prendre en compte les changements:</b></p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">service varnishd restart</pre></td></tr></table></div>

<p><b>Dans le navigateur:</b></p>
<p><img src="http://sametmax.com/wp-content/uploads/2013/04/varnish.png" alt="" title="ça devrait cristalliser..." width="300" height="329" class="aligncenter size-full wp-image-5949" /></p>
<p>Comme on le voit ici, la page a été servie par le backend, si ce n&#8217;était pas prévu il va falloir revoir vos règles.</p>
<p>ATTENTION: Pensez à bien rafraichir votre navigateur pour être sur que ce ne soit pas la page mise en cache par ce dernier qui soit affichée, personnellement j&#8217;utilise la version navigation privé de chrome.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/savoir-si-une-page-est-en-cache-avec-varnish/feed/</wfw:commentRss>
		<slash:comments>2</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2013/04/1221965226fv47Eh.jpg" length="24506" type="image/jpg" />	</item>
		<item>
		<title>Initiation à Varnish &#8211; Accélerer un blog WordPress 6</title>
		<link>http://sametmax.com/initiation-a-varnish-accelerer-un-blog-wordpress/</link>
		<comments>http://sametmax.com/initiation-a-varnish-accelerer-un-blog-wordpress/#comments</comments>
		<pubDate>Sun, 31 Mar 2013 08:54:54 +0000</pubDate>
		<dc:creator><![CDATA[Max]]></dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[Web]]></category>
		<category><![CDATA[nginx]]></category>
		<category><![CDATA[varnish]]></category>
		<category><![CDATA[wordpress]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=4416</guid>
		<description><![CDATA[Wordpress est devenu une usine à gaz avec le temps. Naviguer sur un blog sous Wordpress peut devenir pénible lorsque ce dernier a beaucoup de contenu ou de visiteurs. Des plugins censés mettre en cache les pages existent comme WP Cache, il y a aussi une façon d'attaquer le problème autrement avec Varnish.]]></description>
				<content:encoded><![CDATA[<p><a href="https://www.varnish-cache.org/">Varnish</a> est un service qui permet de mettre en cache (sur disque ou en mémoire) certains contenus de votre site. Beaucoup de gros sites l&#8217;utilisent pour sa puissance et ses options de configuration.<br />
Il est plutôt facile à installer mais ça se corse lorsqu&#8217;il faut le configurer car il peut ne rien cacher du tout, surtout avec la config par défaut.</p>
<p>Nous allons voir ici une configuration pour un site sous WordPress avec un serveur Nginx, Varnish étant placé en Front c&#8217;est à dire devant Nginx (il y a aussi le mode sandwich Nginx / Varnish / Backend).</p>
<p><img class="aligncenter size-full wp-image-4417" title="Varnish en Front" src="http://sametmax.com/wp-content/uploads/2013/02/varnish.png" alt="" width="580" height="272" /></p>
<p><strong>Installation de Varnish sous ubuntu:<br />
</strong></p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">sudo</span> <span style="color: #c20cb9; font-weight: bold;">apt-get install</span> varnish</pre></td></tr></table></div>

<p>Il y a 2 fichiers qu&#8217;il faut retenir pour Varnish, le fichier avec les règles et le fichier de config du service.<br />
<strong><br />
Configurer le service, On va faire en sorte que Varnish écoute sur le port 80:</strong></p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">vi</span> <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>default<span style="color: #000000; font-weight: bold;">/</span>varnish</pre></td></tr></table></div>


<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #007800;">DAEMON_OPTS</span>=<span style="color: #ff0000;">&quot;-a :80 <span style="color: #000099; font-weight: bold;">\
</span>             -T localhost:6082 <span style="color: #000099; font-weight: bold;">\
</span>             -f /etc/varnish/default.vcl <span style="color: #000099; font-weight: bold;">\
</span>             -S /etc/varnish/secret <span style="color: #000099; font-weight: bold;">\
</span>             -s malloc,256m&quot;</span></pre></td></tr></table></div>

<p>Trouvez cette ligne dans le fichier de conf et mettez 80 pour l&#8217;option -a.<br />
<em>malloc</em> va sauver le cache en mémoire à hauteur de 256 MB, on peut sauvegarder sur disque si on a un SSD (ex: -s file,/var/lib/varnish/varnish_storage.bin,1G&#8221;).</p>
<p><strong>Configurer les règles de cache:</strong></p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">vi</span> <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>varnish<span style="color: #000000; font-weight: bold;">/</span>default.vcl</pre></td></tr></table></div>


<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #666666; font-style: italic;">#</span>
<span style="color: #666666; font-style: italic;"># Varnish 3 configuration for Wordpress</span>
<span style="color: #666666; font-style: italic;">#</span>
<span style="color: #666666; font-style: italic;"># On Debian OS:  /etc/varnish/default.vcl</span>
<span style="color: #666666; font-style: italic;">#</span>
<span style="color: #666666; font-style: italic;"># Nicolas Hennion (aka) Nicolargo</span>
<span style="color: #666666; font-style: italic;">#</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># Set the default backend (Nginx server for me)</span>
backend default <span style="color: #7a0874; font-weight: bold;">&#123;</span>
	<span style="color: #666666; font-style: italic;"># My Nginx server listen on IP address 127.0.0.1 and TCP port 8080</span>
	.host = <span style="color: #ff0000;">&quot;127.0.0.1&quot;</span>;
	.port = <span style="color: #ff0000;">&quot;8080&quot;</span>;
	<span style="color: #666666; font-style: italic;"># Increase guru timeout</span>
	<span style="color: #666666; font-style: italic;"># http://vincentfretin.ecreall.com/articles/varnish-guru-meditation-on-timeout</span>
	.first_byte_timeout = 300s;
<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># This function is used when a request is send by a HTTP client (Browser) </span>
sub vcl_recv <span style="color: #7a0874; font-weight: bold;">&#123;</span>
	<span style="color: #666666; font-style: italic;"># Block the forbidden IP addresse</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>client.ip ~ forbidden<span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
        	error <span style="color: #000000;">403</span> <span style="color: #ff0000;">&quot;Forbidden&quot;</span>;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># Only cache the following sites</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.host ~ <span style="color: #ff0000;">&quot;(sametmax.com)&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span> 
		<span style="color: #000000; font-weight: bold;">set</span> req.backend = default; 
	<span style="color: #7a0874; font-weight: bold;">&#125;</span> <span style="color: #000000; font-weight: bold;">else</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span> 
		<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>pass<span style="color: #7a0874; font-weight: bold;">&#41;</span>; 
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># Normalize the header, remove the port (in case you're testing this on various TCP ports)</span>
	<span style="color: #000000; font-weight: bold;">set</span> req.http.Host = regsub<span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Host, <span style="color: #ff0000;">&quot;:[0-9]+&quot;</span>, <span style="color: #ff0000;">&quot;&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>;
&nbsp;
	<span style="color: #666666; font-style: italic;"># Post requests will not be cached</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Authorization <span style="color: #000000; font-weight: bold;">||</span> req.request == <span style="color: #ff0000;">&quot;POST&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>pass<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># --- Wordpress specific configuration</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># Did not cache the RSS feed</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.url ~ <span style="color: #ff0000;">&quot;/feed&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>pass<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># Blitz hack</span>
        <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.url ~ <span style="color: #ff0000;">&quot;/mu-.*&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
                <span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>pass<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
        <span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
&nbsp;
	<span style="color: #666666; font-style: italic;"># Did not cache the admin and login pages</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.url ~ <span style="color: #ff0000;">&quot;/wp-(login|admin)&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>pass<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># Remove the &quot;has_js&quot; cookie</span>
	<span style="color: #000000; font-weight: bold;">set</span> req.http.Cookie = regsuball<span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Cookie, <span style="color: #ff0000;">&quot;has_js=[^;]+(; )?&quot;</span>, <span style="color: #ff0000;">&quot;&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>;
&nbsp;
	<span style="color: #666666; font-style: italic;"># Remove any Google Analytics based cookies</span>
	<span style="color: #000000; font-weight: bold;">set</span> req.http.Cookie = regsuball<span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Cookie, <span style="color: #ff0000;">&quot;__utm.=[^;]+(; )?&quot;</span>, <span style="color: #ff0000;">&quot;&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>;
&nbsp;
	<span style="color: #666666; font-style: italic;"># Remove the Quant Capital cookies (added by some plugin, all __qca)</span>
	<span style="color: #000000; font-weight: bold;">set</span> req.http.Cookie = regsuball<span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Cookie, <span style="color: #ff0000;">&quot;__qc.=[^;]+(; )?&quot;</span>, <span style="color: #ff0000;">&quot;&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>;
&nbsp;
	<span style="color: #666666; font-style: italic;"># Remove the wp-settings-1 cookie</span>
	<span style="color: #000000; font-weight: bold;">set</span> req.http.Cookie = regsuball<span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Cookie, <span style="color: #ff0000;">&quot;wp-settings-1=[^;]+(; )?&quot;</span>, <span style="color: #ff0000;">&quot;&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>;
&nbsp;
	<span style="color: #666666; font-style: italic;"># Remove the wp-settings-time-1 cookie</span>
	<span style="color: #000000; font-weight: bold;">set</span> req.http.Cookie = regsuball<span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Cookie, <span style="color: #ff0000;">&quot;wp-settings-time-1=[^;]+(; )?&quot;</span>, <span style="color: #ff0000;">&quot;&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>;
&nbsp;
	<span style="color: #666666; font-style: italic;"># Remove the wp test cookie</span>
	<span style="color: #000000; font-weight: bold;">set</span> req.http.Cookie = regsuball<span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Cookie, <span style="color: #ff0000;">&quot;wordpress_test_cookie=[^;]+(; )?&quot;</span>, <span style="color: #ff0000;">&quot;&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>;
&nbsp;
	<span style="color: #666666; font-style: italic;"># Are there cookies left with only spaces or that are empty?</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.cookie ~ <span style="color: #ff0000;">&quot;^ *$&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		    <span style="color: #7a0874; font-weight: bold;">unset</span> req.http.cookie;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># Cache the following files extensions </span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.url ~ <span style="color: #ff0000;">&quot;\.(css|js|png|gif|jp(e)?g|swf|ico)&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		<span style="color: #7a0874; font-weight: bold;">unset</span> req.http.cookie;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># Normalize Accept-Encoding header and compression</span>
	<span style="color: #666666; font-style: italic;"># https://www.varnish-cache.org/docs/3.0/tutorial/vary.html</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Accept-Encoding<span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		<span style="color: #666666; font-style: italic;"># Do no compress compressed files...</span>
		<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.url ~ <span style="color: #ff0000;">&quot;\.(jpg|png|gif|gz|tgz|bz2|tbz|mp3|ogg)$&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
			   	remove req.http.Accept-Encoding;
		<span style="color: #7a0874; font-weight: bold;">&#125;</span> elsif <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Accept-Encoding ~ <span style="color: #ff0000;">&quot;gzip&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		    	<span style="color: #000000; font-weight: bold;">set</span> req.http.Accept-Encoding = <span style="color: #ff0000;">&quot;gzip&quot;</span>;
		<span style="color: #7a0874; font-weight: bold;">&#125;</span> elsif <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Accept-Encoding ~ <span style="color: #ff0000;">&quot;deflate&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		    	<span style="color: #000000; font-weight: bold;">set</span> req.http.Accept-Encoding = <span style="color: #ff0000;">&quot;deflate&quot;</span>;
		<span style="color: #7a0874; font-weight: bold;">&#125;</span> <span style="color: #000000; font-weight: bold;">else</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
			remove req.http.Accept-Encoding;
		<span style="color: #7a0874; font-weight: bold;">&#125;</span>
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># Check the cookies for wordpress-specific items</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Cookie ~ <span style="color: #ff0000;">&quot;wordpress_&quot;</span> <span style="color: #000000; font-weight: bold;">||</span> req.http.Cookie ~ <span style="color: #ff0000;">&quot;comment_&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>pass<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #000000; font-weight: bold;">!</span>req.http.cookie<span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		<span style="color: #7a0874; font-weight: bold;">unset</span> req.http.cookie;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># --- End of Wordpress specific configuration</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># Did not cache HTTP authentication and HTTP Cookie</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Authorization <span style="color: #000000; font-weight: bold;">||</span> req.http.Cookie<span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		<span style="color: #666666; font-style: italic;"># Not cacheable by default</span>
		<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>pass<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># Define the default grace period to serve cached content</span>
	<span style="color: #000000; font-weight: bold;">set</span> req.grace = 30s;
&nbsp;
	<span style="color: #666666; font-style: italic;"># Cache all others requests</span>
	<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>lookup<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
sub vcl_pipe <span style="color: #7a0874; font-weight: bold;">&#123;</span>
	<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>pipe<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
sub vcl_pass <span style="color: #7a0874; font-weight: bold;">&#123;</span>
	<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>pass<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># The data on which the hashing will take place</span>
sub vcl_hash <span style="color: #7a0874; font-weight: bold;">&#123;</span>
 	hash_data<span style="color: #7a0874; font-weight: bold;">&#40;</span>req.url<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
 	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.host<span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
     	hash_data<span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.host<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
 	<span style="color: #7a0874; font-weight: bold;">&#125;</span> <span style="color: #000000; font-weight: bold;">else</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
     	hash_data<span style="color: #7a0874; font-weight: bold;">&#40;</span>server.ip<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
 	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># If the client supports compression, keep that in a different cache</span>
    	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Accept-Encoding<span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
        	hash_data<span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Accept-Encoding<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #7a0874; font-weight: bold;">hash</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>;
<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># This function is used when a request is sent by our backend (Nginx server)</span>
sub vcl_fetch <span style="color: #7a0874; font-weight: bold;">&#123;</span>
	<span style="color: #666666; font-style: italic;"># Remove some headers we never want to see</span>
	<span style="color: #7a0874; font-weight: bold;">unset</span> beresp.http.Server;
	<span style="color: #7a0874; font-weight: bold;">unset</span> beresp.http.X-Powered-By;
&nbsp;
	<span style="color: #666666; font-style: italic;"># For static content strip all backend cookies</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.url ~ <span style="color: #ff0000;">&quot;\.(css|js|png|gif|jp(e?)g)|swf|ico&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		<span style="color: #7a0874; font-weight: bold;">unset</span> beresp.http.cookie;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># Only allow cookies to be set if we're in admin area</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>beresp.http.Set-Cookie <span style="color: #000000; font-weight: bold;">&amp;&amp;</span> req.url <span style="color: #000000; font-weight: bold;">!</span>~ <span style="color: #ff0000;">&quot;^/wp-(login|admin)&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
        	<span style="color: #7a0874; font-weight: bold;">unset</span> beresp.http.Set-Cookie;
    	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># don't cache response to posted requests or those with basic auth</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span> req.request == <span style="color: #ff0000;">&quot;POST&quot;</span> <span style="color: #000000; font-weight: bold;">||</span> req.http.Authorization <span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
        	<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>hit_for_pass<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
    	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
    	<span style="color: #666666; font-style: italic;"># don't cache search results</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span> req.url ~ <span style="color: #ff0000;">&quot;\?s=&quot;</span> <span style="color: #7a0874; font-weight: bold;">&#41;</span><span style="color: #7a0874; font-weight: bold;">&#123;</span>
		<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>hit_for_pass<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># only cache status ok</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span> beresp.status <span style="color: #000000; font-weight: bold;">!</span>= <span style="color: #000000;">200</span> <span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>hit_for_pass<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># A TTL of 24h</span>
	<span style="color: #000000; font-weight: bold;">set</span> beresp.ttl = 24h;
&nbsp;
	<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>deliver<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># The routine when we deliver the HTTP request to the user</span>
<span style="color: #666666; font-style: italic;"># Last chance to modify headers that are sent to the client</span>
sub vcl_deliver <span style="color: #7a0874; font-weight: bold;">&#123;</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>obj.hits <span style="color: #000000; font-weight: bold;">&gt;</span> <span style="color: #000000;">0</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span> 
		<span style="color: #000000; font-weight: bold;">set</span> resp.http.X-Cache = <span style="color: #ff0000;">&quot;cached&quot;</span>;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span> <span style="color: #000000; font-weight: bold;">else</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		<span style="color: #000000; font-weight: bold;">set</span> resp.http.x-Cache = <span style="color: #ff0000;">&quot;uncached&quot;</span>;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># Remove some headers: PHP version</span>
	<span style="color: #7a0874; font-weight: bold;">unset</span> resp.http.X-Powered-By;
&nbsp;
	<span style="color: #666666; font-style: italic;"># Remove some headers: Apache version &amp; OS</span>
	<span style="color: #7a0874; font-weight: bold;">unset</span> resp.http.Server;
&nbsp;
	<span style="color: #666666; font-style: italic;"># Remove some heanders: Varnish</span>
	<span style="color: #7a0874; font-weight: bold;">unset</span> resp.http.Via;
	<span style="color: #7a0874; font-weight: bold;">unset</span> resp.http.X-Varnish;
&nbsp;
	<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>deliver<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
sub vcl_init <span style="color: #7a0874; font-weight: bold;">&#123;</span>
 	<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>ok<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
sub vcl_fini <span style="color: #7a0874; font-weight: bold;">&#123;</span>
 	<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>ok<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
<span style="color: #7a0874; font-weight: bold;">&#125;</span></pre></td></tr></table></div>

<p>Avant toute chose voici la doc :) : <a href="https://www.varnish-cache.org/docs/3.0/">https://www.varnish-cache.org/docs/3.0/</a><br />
Ce qu&#8217;il faut retenir de ce fichier de règles c&#8217;est les parties normalisation, enlever les cookies inutiles (car si cookie alors pas de cache) et ne pas mettre en cache l&#8217;admin. Cette config tourne actuellement sur S&#038;M.</p>
<p>Un point intéressant c&#8217;est le debug, vous pouvez mettre un <em>set resp.http.X-Cache = &#8220;cached&#8221;;</em> et vérifier les headers de votre serveur dans le debug de votre navigateur pour savoir si oui ou non la page servie est en cache.</p>
<p><strong>L&#8217;admin varnish en ligne de commande:</strong><br />
Varnish possède une admin en ligne de commande où l&#8217;on peut par exemple purger le cache d&#8217;une ou plusieurs pages.<br />
Tapez <em>varnishadm</em> dans le shell:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">varnishadm
<span style="color: #000000;">200</span>        
<span style="color: #660033;">-----------------------------</span>
Varnish Cache CLI <span style="color: #000000;">1.0</span>
<span style="color: #660033;">-----------------------------</span>
Linux,3.2.0-<span style="color: #000000;">25</span>-virtual,x86_64,-smalloc,-smalloc,-hcritbit
&nbsp;
Type <span style="color: #ff0000;">'help'</span> <span style="color: #000000; font-weight: bold;">for</span> <span style="color: #7a0874; font-weight: bold;">command</span> list.
Type <span style="color: #ff0000;">'quit'</span> to close CLI session.
&nbsp;
varnish<span style="color: #000000; font-weight: bold;">&gt;</span> ban.url <span style="color: #000000; font-weight: bold;">/</span>toto<span style="color: #000000; font-weight: bold;">/</span>ma-page.php</pre></td></tr></table></div>

<p>Pour purger une page on va utiliser la commande ban.url et y ajouter une partie de l&#8217;url à purger. On peut utiliser un ban en appelant également une url de purge avec Curl ou Wget pour les automations, il y a un excellent article <a href="http://binbash.fr/2011/11/15/purger-le-cache-de-varnish-3/">sur la purge ici.</a></p>
<p><strong>Configurer Nginx:</strong><br />
Une fois varnish installé, on va modifier un peu nginx pour que la liaison puisse se faire. Ci-dessous l&#8217;exemple de notre conf nginx.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">&nbsp;
server <span style="color: #7a0874; font-weight: bold;">&#123;</span>
    listen      <span style="color: #000000;">8080</span>;
    server_name  sametmax.com  ;
    root         <span style="color: #000000; font-weight: bold;">/</span>unrep<span style="color: #000000; font-weight: bold;">/</span>sametmax<span style="color: #000000; font-weight: bold;">/</span>;  <span style="color: #666666; font-style: italic;"># absolute path to your WordPress installation</span>
    index index.php index.html;
    set_real_ip_from        127.0.0.1;
    real_ip_header          X-Forwarded-For;
&nbsp;
    location ~ \.php$ <span style="color: #7a0874; font-weight: bold;">&#123;</span>
        include        <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>nginx<span style="color: #000000; font-weight: bold;">/</span>fastcgi_params;
        fastcgi_pass   127.0.0.1:<span style="color: #000000;">53217</span>;
        fastcgi_index index.php;
        fastcgi_buffers <span style="color: #000000;">8</span> 16k;
        fastcgi_buffer_size 32k;
        fastcgi_param  SCRIPT_FILENAME  <span style="color: #007800;">$document_root</span><span style="color: #007800;">$fastcgi_script_name</span>;
    <span style="color: #7a0874; font-weight: bold;">&#125;</span></pre></td></tr></table></div>

<p>Pour PHP on utilise spawn-fcgi que l&#8217;on gère avec <a href="http://supervisord.org/">supervisor</a> dont voici la conf dans /etc/supervisord.conf</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #7a0874; font-weight: bold;">&#91;</span>program:php5-cgi<span style="color: #7a0874; font-weight: bold;">&#93;</span>
<span style="color: #007800;">command</span>=<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>spawn-fcgi <span style="color: #660033;">-u</span> adolf <span style="color: #660033;">-n</span> <span style="color: #660033;">-a</span> 127.0.0.1 <span style="color: #660033;">-p</span> <span style="color: #000000;">53217</span> <span style="color: #660033;">-P</span> <span style="color: #000000; font-weight: bold;">/</span>tmp<span style="color: #000000; font-weight: bold;">/</span>fastcgi-php.pid <span style="color: #660033;">-F</span> <span style="color: #000000;">4</span> <span style="color: #660033;">--</span> <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>php-cgi
<span style="color: #007800;">redirect_stderr</span>=<span style="color: #c20cb9; font-weight: bold;">true</span>          ; redirect proc stderr to stdout <span style="color: #7a0874; font-weight: bold;">&#40;</span>default <span style="color: #c20cb9; font-weight: bold;">false</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>
<span style="color: #007800;">user</span>=sametmax
<span style="color: #007800;">autostart</span>=<span style="color: #c20cb9; font-weight: bold;">true</span>
<span style="color: #007800;">autorestart</span>=<span style="color: #c20cb9; font-weight: bold;">true</span>
<span style="color: #007800;">startsecs</span>=<span style="color: #000000;">10</span>
<span style="color: #007800;">startretries</span>=<span style="color: #000000;">9999999999999</span>
<span style="color: #007800;">stdout_logfile</span>=<span style="color: #000000; font-weight: bold;">/</span>var<span style="color: #000000; font-weight: bold;">/</span>log<span style="color: #000000; font-weight: bold;">/</span>php5-cgi<span style="color: #000000; font-weight: bold;">/</span>php5-cgi.log
<span style="color: #007800;">stdout_logfile_maxbytes</span>=10MB   ; max <span style="color: #666666; font-style: italic;"># logfile bytes b4 rotation (default 50MB)</span></pre></td></tr></table></div>

<p><strong>Pour résumer:</strong></p>
<p>Dans cette configuration Varnish est en front end et va décider quand servir une page prise dans le cache (disque dur ou RAM) et quand interroger le backend pour servir une nouvelle page.<br />
Sur d&#8217;autres sites à fort trafic on a mis Nginx en front end car il encaisse beaucoup plus les hits et qu&#8217;il fait très bien le boulot pour servir des pages statiques.</p>
<p><strong>Attention!</strong><br />
Même si Varnish n&#8217;est pas compliqué à installer il peut être un vrai casse-tête quand il s&#8217;agit de cacher des pages. Pensez donc bien à normaliser vos headers (user-agent, gzip, etc), utilisez le debug.<br />
Bien configuré Varnish vous booste un serveur avec une réélle efficacité, il nous a sauvé 2 sites jusqu&#8217;à présent, ça sera d&#8217;ailleurs un standard sur nos prochains sites.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/initiation-a-varnish-accelerer-un-blog-wordpress/feed/</wfw:commentRss>
		<slash:comments>6</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2013/03/back_to_the_future.jpg" length="23411" type="image/jpg" />	</item>
	</channel>
</rss>
