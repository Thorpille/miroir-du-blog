<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Sam &#38; Max &#187; unit tests</title>
	<atom:link href="http://sametmax.com/tag/unit-tests/feed/" rel="self" type="application/rss+xml" />
	<link>http://sametmax.com</link>
	<description>Du code, du cul</description>
	<lastBuildDate>Sat, 07 Nov 2015 10:56:13 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>http://wordpress.org/?v=4.1</generator>
	<item>
		<title>Un gros guide bien gras sur les tests unitaires en Python, partie 5 9</title>
		<link>http://sametmax.com/un-gros-guide-bien-gras-sur-les-tests-unitaires-en-python-partie-5/</link>
		<comments>http://sametmax.com/un-gros-guide-bien-gras-sur-les-tests-unitaires-en-python-partie-5/#comments</comments>
		<pubDate>Sun, 17 May 2015 07:35:20 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[mock]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[unit tests]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=16281</guid>
		<description><![CDATA[Vous avez <a href="http://sametmax.com/un-gros-guide-bien-gras-sur-les-tests-unitaires-en-python-partie-4/">vu</a> les modules pour faire les tests, mais dès que vous allez vouloir faire des tests sérieux, vous allez vous heurter à la dure réalité.

La réalité est que pour tester, il vous faut la réalité.]]></description>
				<content:encoded><![CDATA[<p>Vous avez <a href="http://sametmax.com/un-gros-guide-bien-gras-sur-les-tests-unitaires-en-python-partie-4/">vu</a> les modules pour faire les tests, mais dès que vous allez vouloir faire des tests sérieux, vous allez vous heurter à la dure réalité.</p>
<p>La réalité est que pour tester, il vous faut la réalité.</p>
<p>Par exemple, si vous tapez dans une base de données, il vous faut une base de données opérationnelle. Pour tester un téléchargement, il vous faut une connexion internet. Pour tester si votre API fonctionne, il faut lancer un serveur Web.</p>
<p>Autre chose, si votre code appelle un autre code, comment vous assurer que cet appel a bien eu lieu ? Il faudrait aussi un logger pour tous les appels, et si le code n&#8217;est pas le vôtre, c&#8217;est encore plus chiant.</p>
<p>Comme nous savons que les informaticiens sont des grosses larves, il y a forcément une solution, au moins partielle, à ces problèmes. En l’occurrence, on va jouer au docteur, à la dinette, aux cowboys et aux indiens.</p>
<p>Bref, on va jouer à faire semblant.</p>
<p><span class='embed-youtube' style='text-align:center; display: block;'><iframe class='youtube-player' type='text/html' width='1170' height='689' src='http://www.youtube.com/embed/vjncyiuwwXQ?version=3&#038;rel=1&#038;fs=1&#038;showsearch=0&#038;showinfo=1&#038;iv_load_policy=1&#038;wmode=transparent' frameborder='0' allowfullscreen='true'></iframe></span></p>
<h2>Les objets mocks</h2>
<p>Un objet mock, c&#8217;est un objet basé sur le <a href="http://sametmax.com/usages-et-dangers-du-null-object-pattern-en-python/">null object pattern</a> qui sert à faire semblant. Quand on l&#8217;instancie avec n&#8217;importe quoi, ça marche, quand on appelle n&#8217;importe quelle méthode, ça marche et ça renvoie un mock.</p>
<p>Bien entendu, comme les besoins des tests sont un peu plus raffinés que ça, mock fait plus que du null object pattern, et permet :</p>
<ul>
<li>De configurer son API.</li>
<li>De configurer ses sides effects.</li>
<li>De configurer sa valeur de retour.</li>
<li>De monkey patcher un autre objet.</li>
<li>D&#8217;enregistrer tous les appels qu&#8217;on lui fait.</li>
</ul>
<p>Alors évidement, comme ça, je me doute bien que la puissance de l&#8217;outil ne vous frappe pas en face comme le nez au milieu de l&#8217;eureka dans un couloir.</p>
<p>C&#8217;est pour ça qu&#8217;on va passer aux exemples concrets. D&#8217;abord, assurez-vous de pouvoir faire <code>import unittest.mock</code>, qui est dispo depuis Python 3.3. Si ce n&#8217;est pas le cas, <a href="http://sametmax.com/votre-python-aime-les-pip/">l&#8217;installer</a> avec <code>pip install mock</code> vous permettra de l&#8217;importer sous la forme <code>import mock</code>. Le reste, c&#8217;est pareil.</p>
<h2>On dirait que moi je t&#8217;attaque et toi tu meurs pas</h2>
<p>Un objet mock est un <a href="http://sametmax.com/les-trucmuchables-en-python/">callable</a>, c&#8217;est-à-dire qu&#8217;il peut être appelé comme une fonction ou une classe, et il retourne toujours un objet mock :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">unittest</span>.<span style="color: black;">mock</span> <span style="color: #ff7700;font-weight:bold;">import</span> MagicMock <span style="color: #808080; font-style: italic;"># ou from mock import MagicMock</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> mock <span style="color: #66cc66;">=</span> MagicMock<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>mock<span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&lt;</span>MagicMock <span style="color: #008000;">id</span><span style="color: #66cc66;">=</span><span style="color: #483d8b;">'140302100559296'</span><span style="color: #66cc66;">&gt;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> mock<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&lt;</span>MagicMock name<span style="color: #66cc66;">=</span><span style="color: #483d8b;">'mock()'</span> <span style="color: #008000;">id</span><span style="color: #66cc66;">=</span><span style="color: #483d8b;">'140302101821704'</span><span style="color: #66cc66;">&gt;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> mock<span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #008000;">True</span><span style="color: #66cc66;">,</span> <span style="color: black;">&#91;</span><span style="color: #008000;">Exception</span><span style="color: #66cc66;">,</span> <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&lt;</span>MagicMock name<span style="color: #66cc66;">=</span><span style="color: #483d8b;">'mock()'</span> <span style="color: #008000;">id</span><span style="color: #66cc66;">=</span><span style="color: #483d8b;">'140302101821704'</span><span style="color: #66cc66;">&gt;</span></pre></td></tr></table></div>

<p>On peut appeler n&#8217;importe quoi sur son objet mock, et ça retourne toujours un objet mock :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> mock.<span style="color: black;">foo</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&lt;</span>MagicMock name<span style="color: #66cc66;">=</span><span style="color: #483d8b;">'mock.foo()'</span> <span style="color: #008000;">id</span><span style="color: #66cc66;">=</span><span style="color: #483d8b;">'140302101723960'</span><span style="color: #66cc66;">&gt;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> mock.<span style="color: black;">nimporte</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>.<span style="color: black;">nawak</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>.<span style="color: black;">je</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>.<span style="color: black;">te</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>.<span style="color: #dc143c;">dis</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&lt;</span>MagicMock name<span style="color: #66cc66;">=</span><span style="color: #483d8b;">'mock.nimporte().nawak().je().te().dis()'</span> <span style="color: #008000;">id</span><span style="color: #66cc66;">=</span><span style="color: #483d8b;">'140302101825744'</span><span style="color: #66cc66;">&gt;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> mock + mock - <span style="color: #ff4500;">10000</span>
<span style="color: #66cc66;">&lt;</span>MagicMock name<span style="color: #66cc66;">=</span><span style="color: #483d8b;">'mock.__add__().__sub__()'</span> <span style="color: #008000;">id</span><span style="color: #66cc66;">=</span><span style="color: #483d8b;">'140302134081520'</span><span style="color: #66cc66;">&gt;</span></pre></td></tr></table></div>

<p>Quand retourner un objet mock n&#8217;est pas possible, l&#8217;objet essaye d&#8217;avoir le comportement qui fera planter le moins possible :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">int</span><span style="color: black;">&#40;</span>mock<span style="color: black;">&#41;</span>
<span style="color: #ff4500;">1</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: black;">&#91;</span>m <span style="color: #ff7700;font-weight:bold;">for</span> m <span style="color: #ff7700;font-weight:bold;">in</span> mock<span style="color: black;">&#93;</span>
<span style="color: black;">&#91;</span><span style="color: black;">&#93;</span></pre></td></tr></table></div>

<h2>On dirait que le bâton, là, c&#8217;est un sabre laser</h2>
<p>Parfois, néanmoins, il est utile de vouloir avoir un comportement spécifique. Il se trouve que les méthodes des objets mocks peuvent être des objets mocks. Mock, mock, mock !!!!!</p>
<p>Et les objets mocks peuvent être configurés pour avoir un effet de bord ou une valeur de retour :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">mock.<span style="color: black;">you</span> <span style="color: #66cc66;">=</span> MagicMock<span style="color: black;">&#40;</span>side_effect<span style="color: #66cc66;">=</span><span style="color: #008000;">ValueError</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'mofo !'</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># un callable marche aussi</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> mock.<span style="color: black;">you</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
Traceback <span style="color: black;">&#40;</span>most recent call last<span style="color: black;">&#41;</span>:
  File <span style="color: #483d8b;">&quot;&lt;ipython-input-21-a7e6455585e9&gt;&quot;</span><span style="color: #66cc66;">,</span> line <span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #66cc66;">&lt;</span>module<span style="color: #66cc66;">&gt;</span>
    mock.<span style="color: black;">you</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
  File <span style="color: #483d8b;">&quot;/usr/lib/python3.4/unittest/mock.py&quot;</span><span style="color: #66cc66;">,</span> line <span style="color: #ff4500;">885</span><span style="color: #66cc66;">,</span> <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #0000cd;">__call__</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> _mock_self._mock_call<span style="color: black;">&#40;</span>*args<span style="color: #66cc66;">,</span> **kwargs<span style="color: black;">&#41;</span>
  File <span style="color: #483d8b;">&quot;/usr/lib/python3.4/unittest/mock.py&quot;</span><span style="color: #66cc66;">,</span> line <span style="color: #ff4500;">941</span><span style="color: #66cc66;">,</span> <span style="color: #ff7700;font-weight:bold;">in</span> _mock_call
    <span style="color: #ff7700;font-weight:bold;">raise</span> effect
<span style="color: #008000;">ValueError</span>: mofo <span style="color: #66cc66;">!</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> mock.<span style="color: black;">mock</span> <span style="color: #66cc66;">=</span> MagicMock<span style="color: black;">&#40;</span>return_value<span style="color: #66cc66;">=</span><span style="color: #483d8b;">&quot;moooooooooock&quot;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> mock.<span style="color: black;">mock</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #483d8b;">'moooooooooock'</span></pre></td></tr></table></div>

<p>Cela vous permet d&#8217;utiliser les objets mocks comme des remplacements pour des objets réels dans vos tests mais chiants à instancier comme une event loop, un serveur, une connexion à une base de données&#8230; Ca permet aussi de remplacer des appels très longs par des trucs instantanés.</p>
<p>Mais la partie vraiment fun, c&#8217;est qu&#8217;on peut associer des vrais objets avec des objets mocks :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">class</span> VraiObjetSerieuxEtTout:
...     <span style="color: #ff7700;font-weight:bold;">def</span> faire_un_truc_super_serieux<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
...         <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #483d8b;">&quot;... and don't call me Shirley&quot;</span>
...     <span style="color: #ff7700;font-weight:bold;">def</span> faire_un_autre_truc_serieux<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
...         <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #483d8b;">&quot;why so serious ?&quot;</span>
...
<span style="color: #66cc66;">&gt;&gt;&gt;</span> sirius <span style="color: #66cc66;">=</span> VraiObjetSerieuxEtTout<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> sirius.<span style="color: black;">faire_un_truc_super_serieux</span> <span style="color: #66cc66;">=</span> MagicMock<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># It's a kinda magic, magic !</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> sirius.<span style="color: black;">faire_un_autre_truc_serieux</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #483d8b;">'why so serious ?'</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> sirius.<span style="color: black;">faire_un_truc_super_serieux</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'ieux'</span><span style="color: black;">&#41;</span>.<span style="color: black;">delamort</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">3</span>:<span style="color: #ff4500;">14</span><span style="color: black;">&#93;</span> + <span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&lt;</span>MagicMock name<span style="color: #66cc66;">=</span><span style="color: #483d8b;">'mock().delamort().__getitem__().__add__()'</span> <span style="color: #008000;">id</span><span style="color: #66cc66;">=</span><span style="color: #483d8b;">'140302103288296'</span><span style="color: #66cc66;">&gt;</span></pre></td></tr></table></div>

<p>Et là ça devient super sympa : vous pouvez utilisez vos vrais objets, et pour certains appels, juste vous faciliter la vie pour les tests.</p>
<h2>On dirait qu&#8217;on compte le nombre de balles que tu as tirées</h2>
<p>Puisque les objets mocks sont un peu les <a href="http://sametmax.com/merci-de-respecter-les-salopes">grosses salopes</a> de la programmation et acceptent tout ce qui vient (oups, je viens de tuer l’ambiance métaphore enfantine là), il peut être nécessaire de vérifier ce qui s&#8217;est passé. Or il se trouve qu&#8217;ils intègrent un historique des appels :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> sirius.<span style="color: black;">faire_un_truc_super_serieux</span>.<span style="color: black;">mock_calls</span>
<span style="color: black;">&#91;</span>call<span style="color: black;">&#40;</span><span style="color: #483d8b;">'ieux'</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
 call<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>.<span style="color: black;">delamort</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
 call<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>.<span style="color: black;">delamort</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>.<span style="color: #0000cd;">__getitem__</span><span style="color: black;">&#40;</span><span style="color: #008000;">slice</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">3</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">14</span><span style="color: #66cc66;">,</span> <span style="color: #008000;">None</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
 call<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>.<span style="color: black;">delamort</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>.<span style="color: #0000cd;">__getitem__</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>.<span style="color: #0000cd;">__add__</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: black;">&#93;</span></pre></td></tr></table></div>

<p> Et comme vérifier qu&#8217;un appel a bien eu lieu est une tâche courante, <a href="https://docs.python.org/3/library/unittest.mock.html#unittest.mock.Mock.assert_called_with">des méthodes</a> pour les tests unitaires ont été intégrées :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> sirius.<span style="color: black;">faire_un_truc_super_serieux</span>.<span style="color: black;">assert_called_with</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'ieux'</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> sirius.<span style="color: black;">faire_un_truc_super_serieux</span>.<span style="color: black;">assert_called_with</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'not_ieux'</span><span style="color: black;">&#41;</span>
Traceback <span style="color: black;">&#40;</span>most recent call last<span style="color: black;">&#41;</span>:
  File <span style="color: #483d8b;">&quot;&lt;ipython-input-56-e8c4890f08d9&gt;&quot;</span><span style="color: #66cc66;">,</span> line <span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #66cc66;">&lt;</span>module<span style="color: #66cc66;">&gt;</span>
    sirius.<span style="color: black;">faire_un_truc_super_serieux</span>.<span style="color: black;">assert_called_with</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'not_ieux'</span><span style="color: black;">&#41;</span>
  File <span style="color: #483d8b;">&quot;/usr/lib/python3.4/unittest/mock.py&quot;</span><span style="color: #66cc66;">,</span> line <span style="color: #ff4500;">760</span><span style="color: #66cc66;">,</span> <span style="color: #ff7700;font-weight:bold;">in</span> assert_called_with
    <span style="color: #ff7700;font-weight:bold;">raise</span> <span style="color: #008000;">AssertionError</span><span style="color: black;">&#40;</span>_error_message<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">from</span> cause
<span style="color: #008000;">AssertionError</span>: Expected call: mock<span style="color: black;">&#40;</span><span style="color: #483d8b;">'not_ieux'</span><span style="color: black;">&#41;</span>
Actual call: mock<span style="color: black;">&#40;</span><span style="color: #483d8b;">'ieux'</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<h2>On dirait que tu vas mettre ces porte-jartelles et&#8230;</h2>
<p>Pour finir, le module <code>mock</code> vient avec <code>patch()</code>, qui sert à, surprise, patcher les objets, et propose des <a href="http://sametmax.com/les-context-managers-et-le-mot-cle-with-en-python/">context managers</a> et des <a href="http://sametmax.com/comprendre-les-decorateurs-python-pas-a-pas-partie-1/">décorateurs</a> pour se faciliter la vie.</p>
<p>Par exemple, détourner <code>open()</code> temporairement :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">unittest</span>.<span style="color: black;">mock</span> <span style="color: #ff7700;font-weight:bold;">import</span> patch
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">with</span> patch<span style="color: black;">&#40;</span><span style="color: #483d8b;">'__main__.open'</span><span style="color: #66cc66;">,</span> mock_open<span style="color: black;">&#40;</span>read_data<span style="color: #66cc66;">=</span><span style="color: #483d8b;">'wololo'</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span> create<span style="color: #66cc66;">=</span><span style="color: #008000;">True</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">as</span> mock:
...     <span style="color: #ff7700;font-weight:bold;">with</span> <span style="color: #008000;">open</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'zefile'</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">as</span> h:
...         <span style="color: black;">result</span> <span style="color: #66cc66;">=</span> h.<span style="color: black;">read</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
...
<span style="color: #66cc66;">&gt;&gt;&gt;</span> mock.<span style="color: black;">assert_called_once_with</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'zefile'</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">assert</span> result <span style="color: #66cc66;">==</span> <span style="color: #483d8b;">'wololo'</span></pre></td></tr></table></div>

<p>Ou alors avoir une partie d&#8217;un module qui soit un mock pour tout un appel de fonction :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">@</span>patch<span style="color: black;">&#40;</span><span style="color: #483d8b;">'os.listdir'</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">def</span> ah<span style="color: black;">&#40;</span>mock<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">os</span>
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">os</span>.<span style="color: black;">listdir</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'.'</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
    <span style="color: #808080; font-style: italic;"># l'objet mock initial est aussi passé en param automatiquement</span>
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>mock<span style="color: black;">&#41;</span>
ah<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #808080; font-style: italic;">## &lt;MagicMock name='listdir()' id='140302096346864'&gt;</span>
<span style="color: #808080; font-style: italic;">## &lt;MagicMock name='listdir' id='140302101454688'&gt;</span></pre></td></tr></table></div>

<p>Le module mock est vraiment très complet, avec des outils pour checker les signatures, passer <code>isinstance()</code>, overrider le contenu d&#8217;un dico, et tout un tas de cas particuliers et corner cases. Donc <a href="https://docs.python.org/3/library/unittest.mock.html#unittest.mock.patch">lisez la doc</a> si vous rencontrez un blocage avant de paniquer.</p>
<h2>Dis, comment on fait les bébés</h2>
<p>Exemple prit d&#8217;une base de code IRL, avec une fonction pytest qui teste un objet <code>response</code> représentant une réponse HTTP. Si on appelle <code>write()</code> sur cet objet sous-jacent elle doit faire des appels à deux méthodes privées et une méthode d&#8217;un objet Twisted.</p>
<p>Problème, ces méthodes :</p>
<ul>
<li>Supposent qu&#8217;une event loop est lancée.</li>
<li>Ecrivent sur le réseau.</li>
<li>Sont potentiellement appelées de manière asynchrone, en dehors de notre contrôle.</li>
<li>Ont des side effects donc on veut être certains qu&#8217;elles sont appelées, et avec les bons paramètres.</li>
</ul>
<p>Du coup, on les remplace par des objets mocks, et yala :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> test_write<span style="color: black;">&#40;</span>response<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">assert</span> response.<span style="color: black;">write</span> <span style="color: #66cc66;">!=</span> response._req.<span style="color: black;">write</span>
    response._disable_rendering <span style="color: #66cc66;">=</span> MagicMock<span style="color: black;">&#40;</span>name<span style="color: #66cc66;">=</span><span style="color: #483d8b;">'_disable_rendering'</span><span style="color: black;">&#41;</span>
    response._set_twisted_headers <span style="color: #66cc66;">=</span> MagicMock<span style="color: black;">&#40;</span>name<span style="color: #66cc66;">=</span><span style="color: #483d8b;">'_set_twisted_headers'</span><span style="color: black;">&#41;</span>
    response.<span style="color: black;">write</span><span style="color: black;">&#40;</span>b<span style="color: #483d8b;">'test'</span><span style="color: black;">&#41;</span>
    response._set_twisted_headers.<span style="color: black;">assert_called_once_with</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
    response._disable_rendering.<span style="color: black;">assert_called_once_with</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">assert</span> response.<span style="color: black;">write</span> <span style="color: #66cc66;">==</span> response._req.<span style="color: black;">write</span>
    response._req.<span style="color: black;">write</span>.<span style="color: black;">assert_called_once_with</span><span style="color: black;">&#40;</span>b<span style="color: #483d8b;">'test'</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<h2>Et pourquoi ? Et pourquoi ? Et pourquoi ?</h2>
<p>Prochaines étapes, savoir quand tester, et quoi tester, mais aussi comment rendre un code plus testable. Probablement la partie qui sera la plus difficile à écrire pour moi, car c&#8217;est assez subjectif. On parlera sans doute du code coverage, et je gage que je vais devoir créer un petit projet bidon pour tester tout ça, du genre un minifieur d&#8217;URL ou autre. Faudra voir l&#8217;inspiration.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/un-gros-guide-bien-gras-sur-les-tests-unitaires-en-python-partie-5/feed/</wfw:commentRss>
		<slash:comments>9</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2015/05/VLbJSOV.gif" length="937018" type="image/jpg" />	</item>
		<item>
		<title>Un gros guide bien gras sur les tests unitaires en Python, partie 4 8</title>
		<link>http://sametmax.com/un-gros-guide-bien-gras-sur-les-tests-unitaires-en-python-partie-4/</link>
		<comments>http://sametmax.com/un-gros-guide-bien-gras-sur-les-tests-unitaires-en-python-partie-4/#comments</comments>
		<pubDate>Sat, 06 Dec 2014 20:34:40 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[docstring]]></category>
		<category><![CDATA[doctest]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[tests unitaires]]></category>
		<category><![CDATA[unit tests]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=12717</guid>
		<description><![CDATA[<a href="http://sametmax.com/un-gros-guide-bien-gras-sur-les-tests-unitaires-en-python-partie-3/">Après avoir vu pytest</a>, un outil typiquement pythonique sont les doctests, des tests unitaires intégrés dans les <a href="http://sametmax.com/les-docstrings/">docstrings</a>.]]></description>
				<content:encoded><![CDATA[<p>Python est un langage très pro, et il y a beaucoup, beaucoup d&#8217;outils pour faire des tests.</p>
<p><a href="http://sametmax.com/un-gros-guide-bien-gras-sur-les-tests-unitaires-en-python-partie-3/">Après avoir vu pytest</a>, un outil typiquement pythonique sont les doctests, des tests unitaires intégrés dans les <a href="http://sametmax.com/les-docstrings/">docstrings</a>.</p>
<p>Pour rappel, les docstrings, ce sont ces chaînes de caractères qu&#8217;on retrouve au début des modules, sous la signature des fonctions ou dans la définition des classes. Elles servent à la documentation de ceux-ci, ainsi on peut la lire dans le code, et dans les vraies docs car les outils standards savent les extraire.</p>
<p>Ça ressemble à ça :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> une_fonction<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot; Ceci est une docstring.
&nbsp;
        On peut la lire dans le code source, avec help() dans le shell ou
        dans les docs générés par pydoc et sphinx.
    &quot;&quot;&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">pass</span></pre></td></tr></table></div>

<p>Et bien ces docstrings, on peut mettre des tests unitaires dedans formatés comme des sessions de shell Python. Cela permet de donner des exemples d&#8217;usage, tout en testant son code. C&#8217;est chouette.</p>
<p>Musique ?</p>
<p>Musique.</p>
<p><span class='embed-youtube' style='text-align:center; display: block;'><iframe class='youtube-player' type='text/html' width='1170' height='689' src='http://www.youtube.com/embed/hUSm87nvG3k?version=3&#038;rel=1&#038;fs=1&#038;showsearch=0&#038;showinfo=1&#038;iv_load_policy=1&#038;wmode=transparent' frameborder='0' allowfullscreen='true'></iframe></span></p>
<h2>Hello doctests</h2>
<p>Faire des doctests n&#8217;est pas bien compliqué car c&#8217;est du copier coller. On fait une session shell avec ce qu&#8217;on veut tester, et on copie-colle le tout dans la docstring. Fastoche.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #808080; font-style: italic;"># on copie juste la session de shell tel quel</span>
<span style="color: #ff7700;font-weight:bold;">def</span> ajouter<span style="color: black;">&#40;</span>a<span style="color: #66cc66;">,</span> b<span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;
        &gt;&gt;&gt; ajouter(1, 2)
        3
    &quot;&quot;&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> a + b
&nbsp;
<span style="color: #808080; font-style: italic;"># et on demande à Python de parser les doctests. Directement dans votre fichier</span>
<span style="color: #808080; font-style: italic;"># de code. Si, si. Pas de fichier de tests à part.</span>
<span style="color: #ff7700;font-weight:bold;">if</span> __name__ <span style="color: #66cc66;">==</span> <span style="color: #483d8b;">&quot;__main__&quot;</span>:
    <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">doctest</span>
    <span style="color: #dc143c;">doctest</span>.<span style="color: black;">testmod</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>On lance ensuite directement notre fichier de code :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">python mon_module.py</pre></td></tr></table></div>

<p>Et ça n&#8217;affiche absolument rien. C&#8217;est parce qu&#8217;il n&#8217;y a pas d&#8217;erreur. On peut avoir le topo en demandant un peu de verbosité avec <code>-v</code> :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">python mon_module.py <span style="color: #660033;">-v</span>
Trying:
    ajouter<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #000000;">1</span>, <span style="color: #000000;">2</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>
Expecting:
    <span style="color: #000000;">3</span>
ok
<span style="color: #000000;">1</span> items had no tests:
    __main__
<span style="color: #000000;">1</span> items passed all tests:
   <span style="color: #000000;">1</span> tests <span style="color: #000000; font-weight: bold;">in</span> __main__.ajouter
<span style="color: #000000;">1</span> tests <span style="color: #000000; font-weight: bold;">in</span> <span style="color: #000000;">2</span> items.
<span style="color: #000000;">1</span> passed and <span style="color: #000000;">0</span> failed.
Test passed.</pre></td></tr></table></div>

<p>Les doctests marchent purement en se basant sur le formatage texte. Python va prendre la ligne avec <code>>>></code>, l&#8217;exécuter, si la ligne suivante ne contient pas de <code>>>></code>, il va comparer le résultat de l&#8217;exécution de la ligne précédente avec le contenu de la ligne qui la suit.</p>
<p>Ceci passe :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #483d8b;">&quot;&quot;&quot;
    &gt;&gt;&gt; ajouter(1, 2)
    3
&quot;&quot;&quot;</span></pre></td></tr></table></div>

<p>Mais ceci échoue :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #483d8b;">&quot;&quot;&quot;
    &gt;&gt;&gt; ajouter(1, 2)
    4
&quot;&quot;&quot;</span></pre></td></tr></table></div>

<p>Car le résultat AFFICHÉ dans le shell est 3, et non 4.</p>
<p>En cas d&#8217;échec, Python vous en dit un peu plus :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">python mon_module.py
<span style="color: #000000; font-weight: bold;">**********************************************************************</span>
File <span style="color: #ff0000;">&quot;mon_module.py&quot;</span>, line <span style="color: #000000;">6</span>, <span style="color: #000000; font-weight: bold;">in</span> __main__.ajouter
Failed example:
    ajouter<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #000000;">1</span>, <span style="color: #000000;">2</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>
Expected:
    <span style="color: #000000;">4</span>
Got:
    <span style="color: #000000;">3</span>
<span style="color: #000000; font-weight: bold;">**********************************************************************</span>
<span style="color: #000000;">1</span> items had failures:
   <span style="color: #000000;">1</span> of   <span style="color: #000000;">1</span> <span style="color: #000000; font-weight: bold;">in</span> __main__.ajouter</pre></td></tr></table></div>

<h2>Formater ses doctests</h2>
<p>Les doctests sont faits pour s&#8217;intégrer de manière transparente aux docstrings. On peut donc en mettre autant qu&#8217;on veut, au milieu du texte ordinaire de la docstring. Python se base sur les chevrons (<code>>>></code>) pour savoir quand commence un test, et le saut de ligne pour savoir quand ça se termine. Au delà de ça, le style est libre.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> ajouter<span style="color: black;">&#40;</span>a<span style="color: #66cc66;">,</span> b<span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot; Je peux mettre n'importe quoi ici.
&nbsp;
        Et ici aussi.
&nbsp;
        Puis intégrer des tests:
&nbsp;
        &gt;&gt;&gt; ajouter(1, 2)
        3
        &gt;&gt;&gt; ajouter(2, 2)
        4
&nbsp;
        Et un saut de ligne indique que les tests sont terminés. Mais je peux
        encore en ajouter après si je veux.
&nbsp;
        &gt;&gt;&gt; ajouter(0, 0)
        0
&nbsp;
    &quot;&quot;&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> a + b</pre></td></tr></table></div>

<p>Néanmoins, l’intérêt des doctests est de documenter son code à travers les tests, et donc on adoptera généralement un format tel que :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> ajouter<span style="color: black;">&#40;</span>a<span style="color: #66cc66;">,</span> b<span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot; Additionne deux elements.
&nbsp;
        Exemple :
&nbsp;
            &gt;&gt;&gt; # on peut mettre des commentaires ici
            &gt;&gt;&gt; ajouter(1, 2) # ou là
            3
            &gt;&gt;&gt; ajouter(2., 2) # fonctionne sur tous les types de nombre
            4.0
&nbsp;
        La fonction fonctionne en duck typing, et accepte donc tout objet
        qui possède la méthode magique __add__ :
&nbsp;
            &gt;&gt;&gt; ajouter('a', 'b')
            'ab'
            &gt;&gt;&gt; ajouter([1], [2])
            [1, 2]
    &quot;&quot;&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> a + b</pre></td></tr></table></div>

<p>Notez comme il est agréable de lire cette docstring : on comprend tout de suite comment utiliser la fonction. En prime, ce sont des tests unitaires qui garantissent que notre fonction va continuer de fonctionner correctement et nous oblige à garder cette doc à jour.</p>
<p>On peut faire des imports dedans ou utiliser temporairement <a href="http://sametmax.com/debugger-en-python-les-bases-de-pdb/">pdb</a> pour debugger. N&#8217;importe quel code de shell est valide mais faites attention à ne pas démarrer des boucles infinies comme les event loops des GUI ou lib async.</p>
<p>Voici ce que donnerait l&#8217;exemple des articles précédents avec des docstests :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> get<span style="color: black;">&#40;</span>data<span style="color: #66cc66;">,</span> index<span style="color: #66cc66;">,</span> default<span style="color: #66cc66;">=</span><span style="color: #008000;">None</span><span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot; Implémente l'équivalent de dict.get() pour les indexables.
&nbsp;
        Example :
&nbsp;
            &gt;&gt;&gt; simple_comme_bonjour = ('pomme', 'banane')
            &gt;&gt;&gt; get(simple_comme_bonjour, 0)
            'pomme'
            &gt;&gt;&gt; get(simple_comme_bonjour, 1000, 'Je laisse la main')
            'Je laisse la main'
    &quot;&quot;&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">try</span>:
        <span style="color: #ff7700;font-weight:bold;">return</span> data<span style="color: black;">&#91;</span>index<span style="color: black;">&#93;</span>
    <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: #008000;">IndexError</span>:
        <span style="color: #ff7700;font-weight:bold;">return</span> default</pre></td></tr></table></div>

<h2>Problèmes et solutions</h2>
<p>Les doctests ne sont pas la Panacée, particulièrement parce que le test se fera sur le résultat AFFICHÉ dans le shell. Cela peut facilement amener à des erreurs.</p>
<p>Déjà, il faut faire attention à la représentation des objets dans le shell Python. <strong>La représentation n&#8217;est pas forcément la valeur de saisie</strong> :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff4500;">1</span>.
<span style="color: #ff4500;">1.0</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #483d8b;">&quot;1&quot;</span>
<span style="color: #483d8b;">'1'</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: black;">&#123;</span><span style="color: #483d8b;">&quot;foo&quot;</span>: <span style="color: #483d8b;">&quot;bar&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">&quot;une apostrophe : '&quot;</span>: <span style="color: #483d8b;">&quot;est échapée ainsi qu'un accent&quot;</span><span style="color: black;">&#125;</span>
<span style="color: black;">&#123;</span><span style="color: #483d8b;">&quot;une apostrophe : '&quot;</span>: <span style="color: #483d8b;">&quot;est <span style="color: #000099; font-weight: bold;">\x</span>c3<span style="color: #000099; font-weight: bold;">\x</span>a9chap<span style="color: #000099; font-weight: bold;">\x</span>c3<span style="color: #000099; font-weight: bold;">\x</span>a9e ainsi qu'un accent&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'foo'</span>: <span style="color: #483d8b;">'bar'</span><span style="color: black;">&#125;</span></pre></td></tr></table></div>

<p>La solution à ce problème est de tester dans le shell les valeurs de retour, et non de le faire de tête. Faites bien gaffe aux espaces qui sont donc significatifs, surtout ceux en fin de ligne. Mon éditeur est configuré pour les virer par défaut, et ça m&#8217;a niqué en écrivant l&#8217;article :)</p>
<p>Ensuite, il y a des cas où la représentation ne sera pas la même d&#8217;un appel à l&#8217;autre.</p>
<p>C&#8217;est le cas avec les dictionnaires, puisque l&#8217;ordre des éléments n&#8217;est pas garanti par nature. Ne faites donc pas :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> retourne_un_dico<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: black;">&#123;</span><span style="color: #483d8b;">'ordre'</span>: <span style="color: #483d8b;">'non garanti'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'le'</span>: <span style="color: #483d8b;">'resultat'</span><span style="color: black;">&#125;</span></pre></td></tr></table></div>

<p>Mais plutôt quelque chose qui vous garantit l&#8217;affichage :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #483d8b;">&quot;&quot;&quot;
&gt;&gt;&gt; res = list(retourne_un_dico().items())
&gt;&gt;&gt; res.sort()
[('le', 'resultat'), ('ordre', 'non garanti')]
&gt;&gt;&gt; # ou
&gt;&gt;&gt; retourne_un_dico() == {'ordre': 'non garanti', 'le': 'resultat'}
True
&quot;&quot;&quot;</span></pre></td></tr></table></div>

<p>Parfois, on ne peut juste pas garantir l&#8217;affichage. Par exemple avec des nombres non prévisibles comme les hash ou les id des objets :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #483d8b;">&quot;&quot;&quot;
&gt;&gt;&gt; class Test(): pass
&gt;&gt;&gt; repr(Test())
''
&quot;&quot;&quot;</span></pre></td></tr></table></div>

<p><code>7f4687d30fc8</code> n&#8217;est ici pas prévisible. Python met certains cas spéciaux comme celui-ci des flags activables via le commentaire <code># doctest: +NOM_DU_FLAG</code>.</p>
<p>Par exemple, le flag <code>ELLIPSIS</code> permet de placer <code>...</code> dans le résultat en guise de joker :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #483d8b;">&quot;&quot;&quot;
&gt;&gt;&gt; repr(Test()) # doctest: +ELLIPSIS
''
&quot;&quot;&quot;</span></pre></td></tr></table></div>

<p>D&#8217;autres problèmes similaires peuvent être résolus ainsi. Le flag <code>SKIP</code> permet de sauter un test que vous voulez mettre là, en exemple, mais qui ne doit pas être testé :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #483d8b;">&quot;&quot;&quot;
&gt;&gt;&gt; # ce test va être ignoré
&gt;&gt;&gt; repr(Test()) # doctest: +SKIP
''
&quot;&quot;&quot;</span></pre></td></tr></table></div>

<p><code>NORMALIZE_WHITESPACE</code> permet de considérer toute séquence de caractères non imprimables comme un espace. 8 tabs ou 4 espaces dans le résultat seront tous considérés comme un espace.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #483d8b;">&quot;&quot;&quot;
&gt;&gt;&gt; 'ceci est une assez longue ligne divisible' # doctest: +NORMALIZE_WHITESPACE
'ceci    est     une assez longue    ligne divisible'
&quot;&quot;&quot;</span></pre></td></tr></table></div>

<p>Les flags sont cumulables, si on les sépare par des virgules dans le commentaire.</p>
<p>Autre astuce, si votre sortie doit contenir un saut de ligne, Python va l’interpréter comme la fin des tests. On peut pallier cela en utilisant <code>&lt;BLANKLINE&gt;</code> :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #483d8b;">&quot;&quot;&quot;
&gt;&gt;&gt; print('Un saut de ligne<span style="color: #000099; font-weight: bold;">\\</span>n')
Un saut de ligne
&nbsp;
&quot;&quot;&quot;</span></pre></td></tr></table></div>

<p>Faites attention aux antislash et autres caractères spéciaux dans vos docstests puisque toute string est parsée deux fois : une fois à l&#8217;écriture de la docstring, puis une fois à son exécution. Ici vous voyez que je suis tenu d&#8217;échapper mon <code>\n</code> On peut d&#8217;ailleurs utiliser les préfixes <code>r</code> (cf: les <a href="http://sametmax.com/comment-marchent-les-raw-strings-en-python/">raw strings</a>) et <code>u</code> sur les docstrings, si un jour vous êtes bloqué par trop d&#8217;échappements ou des caractères non ASCII en pagaille, pensez-y.</p>
<p>Un cas particulier est celui des exceptions. LOL, n&#8217;est-il pas ?</p>
<p>Pour y répondre, Python décide qu&#8217;une expression est levée si il voit <code>Traceback (most recent call last):</code>. Il ignore ensuite tout le texte &#8211; qui est donc optionnel et que vous pouvez omettre &#8211; jusqu&#8217;à ce qu&#8217;il rencontre le nom de l&#8217;exception levée. À partir de là, il vérifie que le test passe.</p>
<p>Par exemple, si votre exception génère ce traceback :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">Traceback <span style="color: black;">&#40;</span>most recent call last<span style="color: black;">&#41;</span>:
  File <span style="color: #483d8b;">&quot;&quot;</span><span style="color: #66cc66;">,</span> line <span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff7700;font-weight:bold;">in</span> 
  File <span style="color: #483d8b;">&quot;test.py&quot;</span><span style="color: #66cc66;">,</span> line <span style="color: #ff4500;">41</span><span style="color: #66cc66;">,</span> <span style="color: #ff7700;font-weight:bold;">in</span> ajouter
    <span style="color: #ff4500;">1</span> / <span style="color: #ff4500;">0</span>
<span style="color: #008000;">ZeroDivisionError</span>: integer division <span style="color: #ff7700;font-weight:bold;">or</span> modulo by zero</pre></td></tr></table></div>

<p>Vous pouvez faire dans votre doctest :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #483d8b;">&quot;&quot;&quot;
&gt;&gt;&gt; je_leve_une_exception()
Traceback (most recent call last):
ZeroDivisionError: integer division or modulo by zero
&quot;&quot;&quot;</span></pre></td></tr></table></div>

<p>Seule la dernière ligne est comparée.</p>
<p>Il est également possible de mettre les doctests dans un fichier texte à part, mais je ne vous le recommande pas. Cela retire l’intérêt principal des doctests : avoir du code exécutable dans la doc. Si on doit avoir un fichier séparé, autant utiliser des tests normaux, bien plus pratiques et complets.</p>
<p>Car il n&#8217;y a pas de tear down, setup ou fixtures avec les docstests. Ca reste un outil basique.</p>
<p>Sachez néanmoins que les doctests sont parfaitement compris par <code>pytest</code>, il suffit juste de lui demander de les exécuter avec l&#8217;option suivante :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">py.test <span style="color: #660033;">--doctest-modules</span></pre></td></tr></table></div>

<p>Dans ce cas, il n&#8217;est pas nécessaire de faire à la fin de chaque fichier contenant des doctests :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">if</span> __name__ <span style="color: #66cc66;">==</span> <span style="color: #483d8b;">&quot;__main__&quot;</span>:
    <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">doctest</span>
    <span style="color: #dc143c;">doctest</span>.<span style="color: black;">testmod</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<h2>Quand utiliser les doctests ?</h2>
<p>Généralement, on utilise un mélange des tests ordinaires (dans notre cas des tests <code>pytest</code> plutôt que <code>unittest</code>) et des doctests.</p>
<p>On utilisera des doctests pour les objets ou les fonctions simples et indépendantes. J&#8217;entends par là, des fonctions et des objets qui prennent uniquement des types basiques en paramètres, et qui retournent uniquement ces types basiques en paramètres. Pour les objets, ils doivent avoir peu de méthodes.</p>
<p>Pour tout le reste, on utilisera des tests ordinaires.</p>
<p>Par exemple, si vous avez une fonction comme notre exemple <code>get()</code>, les doctests sont un bon choix. En revanche, si vous avez un objet <code>Server</code> qui est un serveur HTTP, ou une fonction qui prend un objet <code>Server</code> en paramètre, il vaut mieux utiliser les tests ordinaires.</p>
<p>Il est tout à fait possible, et même agréable, de mettre quelques tests simples en doctests qui aident à la documentation, et de faire les tests les plus compliqués via <code>pytest</code>.</p>
<p>Prochaine étape, <a href="http://sametmax.com/un-gros-guide-bien-gras-sur-les-tests-unitaires-en-python-partie-5/">les mocks</a>. Parti de là, je pourrai vous dire quelles parties de votre programme tester en priorité, et comment. Au début je voulais faire l&#8217;inverse, mais finalement, c&#8217;est plus pratique.</p>
<hr />
<p><a href="https://github.com/sametmax/codes-des-articles/blob/master/2014/decembre/docstests.py">Télécharger le code de l&#8217;article</a></p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/un-gros-guide-bien-gras-sur-les-tests-unitaires-en-python-partie-4/feed/</wfw:commentRss>
		<slash:comments>8</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2014/12/tumblr_n5i7twM2SY1r539hzo1_500.gif" length="598099" type="image/jpg" />	</item>
		<item>
		<title>Un gros guide bien gras sur les tests unitaires en Python, partie 1 19</title>
		<link>http://sametmax.com/un-gros-guide-bien-gras-sur-les-tests-unitaires-en-python-partie-1/</link>
		<comments>http://sametmax.com/un-gros-guide-bien-gras-sur-les-tests-unitaires-en-python-partie-1/#comments</comments>
		<pubDate>Wed, 15 Jan 2014 15:26:00 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[assert]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[unit tests]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=8764</guid>
		<description><![CDATA[Les tests unitaires font partie de ces "bonnes pratiques" que tout le monde semble appliquer sur le net. Tous les devs hypes parlent de tests unitaires : les conférences, les blogs, les tutos, les livres, whooooo !

Dans la vraie vie vivante, on croise pourtant peu de gens qui les utilisent vraiment. On les retrouvent surtout dans les gros projets et les grosses boîtes, et encore.]]></description>
				<content:encoded><![CDATA[<p>La zik maintenant traditionelle :</p>
<p><span class='embed-youtube' style='text-align:center; display: block;'><iframe class='youtube-player' type='text/html' width='1170' height='689' src='http://www.youtube.com/embed/1pm4fQRl72k?version=3&#038;rel=1&#038;fs=1&#038;showsearch=0&#038;showinfo=1&#038;iv_load_policy=1&#038;wmode=transparent' frameborder='0' allowfullscreen='true'></iframe></span></p>
<p>Les tests unitaires font partie de ces &#8220;bonnes pratiques&#8221; que tout le monde semble appliquer sur le net. Tous les devs hypes parlent de tests unitaires : les conférences, les blogs, les tutos, les livres, whooooo !</p>
<p>Dans la vraie vie vivante, on croise pourtant peu de gens qui les utilisent vraiment. On les retrouvent surtout dans les gros projets et les grosses boîtes, et encore.</p>
<p>Il y a plusieurs raisons à cela. D&#8217;une part, beaucoup, beaucoup, beaucoup de développeurs n&#8217;ont aucune idée de ce qu&#8217;est un test unitaire. Ceux qui savent, ne voient pas forcément l’intérêt, et ceux qui en voient l’intérêt n&#8217;ont pas forcément l&#8217;expérience nécessaire à leur mise en œuvre.</p>
<p>Je connais des tas de dev qui codent des tas d&#8217;excellents projets sans le moindre test unitaires.</p>
<p>L&#8217;adage selon lequel un code sans test unitaire est un code buggé est parfaitement faux puisque existe bien d&#8217;autres manières de tester son code. De plus, même un code bien testé est un code buggé. Je le sais, je l&#8217;ai codé.</p>
<p>Malgré cela, vous devriez maitriser l&#8217;usage des tests unitaires, car quand vous arrivez à vous sortir les extrémités digitales de la terminaison dorsale afin de les mettre en place, le bénéfice est très important. Mais aussi parce que certains projets ne peuvent pas s&#8217;en passer, et donc que vous ne pourrez pas travailler dessus sans savoir en faire. Certains projets sur Github n&#8217;acceptent pas de pull request sans couverture de tests, et certaines personnes n&#8217;utiliseront pas votre lib si elle n&#8217;est pas testée. C&#8217;est un gage de qualité.</p>
<p>Je n&#8217;en ferai pas une question morale ou de principe, les projets que l&#8217;on publie sur Sam et Max sont parfaitement exempt de tests unitaires, et d&#8217;ailleurs, la plupart des projets pros avec Max n&#8217;ont aucun tests non plus.</p>
<p>En revanche, en tant que freelance, je prends généralement le temps d&#8217;en faire.</p>
<p>Pas de dogmatisme du test donc, mais passé le goût de crabe dans la bouche, ça vaut le coup, alors lisez ce guide.</p>
<h2>Qu&#8217;est-ce qu&#8217;un test unitaire</h2>
<p>Le test unitaire est un bout de code qui fait exactement ce que son nom dit : il teste une unité de code.</p>
<p>Le problème c&#8217;est quoi tester, qu&#8217;est-ce qu&#8217;une &#8220;unité de code&#8221;, ce n&#8217;est pas quelque chose d&#8217;évident à définir, et vient avec la pratique. En théorie c&#8217;est un bout de code minimaliste, que l&#8217;on ne peut pas réduire plus. En pratique, on choisit avec pragmatisme un truc assez petit, mais pas trop, parce que merde, hein.</p>
<p>Mais alors que veut-on dire par &#8220;tester&#8221; ?</p>
<p>Et bien c&#8217;est d&#8217;une banalité affligeante : on donne des entrées au code, et on vérifie que ses sorties sont celles attendues pour ces entrées.</p>
<p>Bref, généralement (mais pas toujours) on teste une fonction. Souvent avec une autre fonction. Et c&#8217;est d&#8217;un manque d&#8217;originalité terrible.</p>
<p>Le test unitaire le plus bête qu&#8217;on puisse avoir en Python :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #808080; font-style: italic;"># Fichier de code</span>
<span style="color: #ff7700;font-weight:bold;">def</span> fonction_a_tester<span style="color: black;">&#40;</span>param1<span style="color: #66cc66;">,</span> param2<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">return</span> param1 + param2</pre></td></tr></table></div>


<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #808080; font-style: italic;"># Fichier de test</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">from</span> fichier_de_code <span style="color: #ff7700;font-weight:bold;">import</span> fonction_a_test
&nbsp;
<span style="color: #ff7700;font-weight:bold;">assert</span> fonction_a_tester<span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span> <span style="color: #66cc66;">==</span> <span style="color: #ff4500;">2</span>  <span style="color: #808080; font-style: italic;"># test de l'addition</span>
<span style="color: #ff7700;font-weight:bold;">assert</span> fonction_a_tester<span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> -<span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span> <span style="color: #66cc66;">==</span> <span style="color: #ff4500;">0</span> <span style="color: #808080; font-style: italic;"># test avec chiffre négatif</span>
<span style="color: #ff7700;font-weight:bold;">assert</span> fonction_a_tester<span style="color: black;">&#40;</span><span style="color: #ff4500;">4</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span> <span style="color: #66cc66;">==</span> <span style="color: #ff4500;">6</span> <span style="color: #808080; font-style: italic;"># test avec autre chose que des 1</span>
<span style="color: #ff7700;font-weight:bold;">assert</span> fonction_a_tester<span style="color: black;">&#40;</span><span style="color: #ff4500;">4.5</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span> <span style="color: #66cc66;">==</span> <span style="color: #ff4500;">6.5</span> <span style="color: #808080; font-style: italic;"># test avec des floats</span></pre></td></tr></table></div>

<p>Deux constats :</p>
<ul>
<li>C&#8217;est parfaitement chiant. Les tests unitaires sont dans 99% des cas des tautologiques super ennuyeuses.</li>
<li>On teste le même code plusieurs fois, avec plusieurs cas de figure, pour être certain que ça se comporte comme prévu.</li>
</ul>
<p><code>assert</code> est un mot clé qui lève l&#8217;exception <code>AssertionError</code> quand l&#8217;expression évaluée ne retourne pas <code>True</code>. L&#8217;utilisation d&#8217;<code>assert</code> n&#8217;est pas le sujet de l&#8217;article, ici on s&#8217;en sert pour faire un test unitaire tout simplement parce que la première ligne qui ne renverra pas <code>True</code> fera  planter le programme. C&#8217;est le test unitaire du pauvre.</p>
<p>Un test unitaire, ce n&#8217;est que ça. Un répétition bête et emmerdante de vérifications généralement très connes.</p>
<h2>C&#8217;est minable ! A quoi ça sert ?</h2>
<p>Là normalement vous vous dites &#8220;je sais ce que fait mon code, surtout une unité minimaliste, je n&#8217;ai pas besoin d&#8217;écrire des évidences pour le tester&#8221;. Et c&#8217;est pour cela que je ne suis pas dogmatique sur les tests unitaires, car c&#8217;est en partie vrai. Beaucoup de codes sont suffisamment simples ou peu critiques pour ne pas avoir besoin d&#8217;être renforcés par des tests unitaires. Et même si il faut des tests, tout le code n&#8217;a pas nécessairement besoin d&#8217;être testé.</p>
<p>Lancer un blog pour sa cousine n&#8217;est pas la même chose qu&#8217;une site de rencontre pour un grand compte.</p>
<p>Mais le test unitaire a plusieurs bénéfices. Le premier c&#8217;est qu&#8217;il vous oblige à réfléchir aux entrées et sorties de vos fonctions, et à l&#8217;API de votre code en général. Vous vous apercevrez à l&#8217;usage qu&#8217;un code est plus ou moins facile à tester selon la manière dont vous l&#8217;avez organisé, et ce faisant, vous serez forcé d&#8217;écrire un code plus souple, propre, extensible.</p>
<p>Écrire des tests fait de vous un meilleur développeur.</p>
<p>Cependant ce n&#8217;est pas le principal intérêt. Le véritable gain tient dans ce que vous gagnez dans le futur : quand vous allez modifier votre code, vous pourrez rapidement voir si il n&#8217;est pas cassé. En effet, votre code va grossir, et vous ne vous souviendrez pas de toutes les dépendances, de tous les effets de bords, de toutes les interactions. Certains dev sont meilleurs que d&#8217;autres à tout garder dans la tête, mais même Cortex a ses limites. Au bout d&#8217;un moment, le code est plus fort que vous.</p>
<p>À partir de là, vous allez tout de même avoir besoin de factoriser le code, bouger des choses, en ajouter d&#8217;autres, corriger un bug, faire un petit ajustement. À chaque fois que vous le faites, vous prenez le risque de casser un truc. Au début du projet, le risque est faible, et même si ça arrive, ça se répare vite. Après 2 mois de dev, les tests seront votre filet de sécurité. Vous pouvez les lancer après chaque modif, et voir que vous n&#8217;avez rien pété. Vous pouvez les lancer après une contribution d&#8217;un autre dev, et voir que ça tourne toujours. Vous pouvez les lancer après un changement d’environnement (OS, base de données, système de fichier, format, etc) et vous assurer que ça n&#8217;a pas d’impacts.</p>
<p>Particulièrement, des tests unitaires ont beaucoup de valeur sur un projet avec beaucoup de participants, tels que des logiciels libres populaires ou des systèmes de grandes sociétés.</p>
<p>Par exemple, sur notre dernière fonction bidon, on décide de faire une petite modification :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #808080; font-style: italic;"># Fichier de code</span>
<span style="color: #ff7700;font-weight:bold;">def</span> fonction_a_tester<span style="color: black;">&#40;</span>param1<span style="color: #66cc66;">,</span> param2<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">int</span><span style="color: black;">&#40;</span>param1<span style="color: black;">&#41;</span> + <span style="color: #008000;">int</span><span style="color: black;">&#40;</span>param2<span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>On peut maintenant passer une string, et elle sera convertie en entier.</p>
<p>On lance notre batterie de tests, et là, au milieu de centaines d&#8217;autres tests, celui là foire :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">assert</span> fonction_a_tester<span style="color: black;">&#40;</span><span style="color: #ff4500;">4.5</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span> <span style="color: #66cc66;">==</span> <span style="color: #ff4500;">6.5</span> <span style="color: #808080; font-style: italic;"># test avec des floats</span></pre></td></tr></table></div>

<p>On voit très vite que notre idée était pourrie, car on a un use case qui ne sera plus compatible. Si quelqu&#8217;un a utilisé des floats avec notre fonction, on va casser son code.</p>
<p>En l&#8217;essence, c&#8217;est ça l’intérêt des tests unitaires : vous faire sauter au yeux quand quelque chose casse. On appelle ça des &#8220;tests de régression&#8221;, et c&#8217;est l&#8217;usage le plus courant.</p>
<p>Plus tard vous verrez qu&#8217;on utilise aussi les tests pour développer son code (TDD), pour définir un comportement du produit avec le client (BDD) ou tout simplement pour servir de documentation.</p>
<p>Mais l&#8217;usage de base, c&#8217;est ça. S&#8217;assurer qu&#8217;on est pas en train de merder.</p>
<h2>Résumé</h2>
<ol>
<li>N&#8217;écoutez pas les Papes du test vous disant que si vous n&#8217;avez pas des tests unitaires à 50 ans, vous avez raté votre vie. Les tests, c&#8217;est bien. Un projet livré, c&#8217;est mieux. Une documentation est plus importante que des tests. Les 3, évidement, c&#8217;est l&#8217;idéal.</li>
<li>Un test, c&#8217;est une suite parfaitement chiante d&#8217;énonciations d&#8217;évidences. Il n&#8217;y a généralement rien de compliqué dans les tests. Vous vous sentirez parfois insulté en les écrivant tellement c&#8217;est con.</li>
<li>L’intérêt majeur des tests est d&#8217;avoir une alerte rouge qui se lance quand vous avez pété un truc. Ça arrive bien plus souvent que vous ne le croyez sans que vous ne vous en aperceviez car vous n&#8217;avez pas de tests.</li>
</ol>
<p>Ces bases posées, la prochaine partie fera la démonstration du module <a href="http://docs.python.org/2/library/unittest.html">unittest</a> afin de créer vos premiers tests unitaires en Python, puis on enchaînera, partie par partie, sur les applications pratiques, les variantes, les girafes lesbiennes et tout ce qui fait un bon article de s&#038;m.</p>
<p>Dans la <a href="http://sametmax.com/un-gros-guide-bien-gras-sur-les-tests-unitaires-en-python-partie-2/">partie 2,</a> on va voir comment faire des tests en utilisant la lib standard Python.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/un-gros-guide-bien-gras-sur-les-tests-unitaires-en-python-partie-1/feed/</wfw:commentRss>
		<slash:comments>19</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2014/01/sm4y87Q.jpg" length="31863" type="image/jpg" />	</item>
		<item>
		<title>Ajouter une route au urls.py de Django durant les tests</title>
		<link>http://sametmax.com/ajouter-une-route-au-urls-py-de-django-durant-les-tests/</link>
		<comments>http://sametmax.com/ajouter-une-route-au-urls-py-de-django-durant-les-tests/#comments</comments>
		<pubDate>Thu, 09 May 2013 08:55:37 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[routes]]></category>
		<category><![CDATA[unit tests]]></category>
		<category><![CDATA[urls.py]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=5965</guid>
		<description><![CDATA[Créer des routes dans l'urlconf juste pour les tests unitaires n'est pas très propre, heureusement on peut utiliser des urls de test complètement séparées.]]></description>
				<content:encoded><![CDATA[<p>Créer des routes dans l&#8217;urlconf juste pour les tests unitaires n&#8217;est pas très propre, heureusement on peut utiliser des urls de test complètement séparées.</p>
<p>D&#8217;abord, il faut mettre un fichier <em>urls.py</em> dans votre dossier <em>tests</em> qui contient vos routes de tests. Ensuite&#8230;</p>
<p>Si vous utilisez le mécanisme de Django pour les tests, il suffit de déclarer le chemin de ce module comme attribut <code>urls</code> de votre classe de test, et Django se charge du reste :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">class</span> VotreTestCase<span style="color: black;">&#40;</span>TestCase<span style="color: black;">&#41;</span>:
    urls <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">'votreapp.tests.urls'</span></pre></td></tr></table></div>

<p>Dans le cas où, comme moi, vous préférez utiliser <a href="http://sametmax.com/se-simplifier-les-tests-python-avec-pytest/">une autre lib</a> pour écrire vos tests, vous pouvez quand choisir votre module d&#8217;urls en faisant :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">from</span> django.<span style="color: black;">conf</span> <span style="color: #ff7700;font-weight:bold;">import</span> settings
<span style="color: #ff7700;font-weight:bold;">from</span> django.<span style="color: black;">core</span>.<span style="color: black;">urlresolvers</span> <span style="color: #ff7700;font-weight:bold;">import</span> clear_url_caches
&nbsp;
<span style="color: #ff7700;font-weight:bold;">import</span> urls
&nbsp;
settings.<span style="color: black;">ROOT_URLCONF</span> <span style="color: #66cc66;">=</span> urls
<span style="color: #808080; font-style: italic;"># n'oubliez pas cette ligne, sinon vous autre des comportements aberrant</span>
<span style="color: #808080; font-style: italic;"># car django met les urls en cache</span>
clear_url_caches<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/ajouter-une-route-au-urls-py-de-django-durant-les-tests/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2013/05/RixqOqk.jpg" length="75780" type="image/jpg" />	</item>
		<item>
		<title>Paramètres par défaut pour la commande py.test 3</title>
		<link>http://sametmax.com/parametres-par-defaut-pour-la-commande-py-test/</link>
		<comments>http://sametmax.com/parametres-par-defaut-pour-la-commande-py-test/#comments</comments>
		<pubDate>Fri, 03 May 2013 08:23:51 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[pytest]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[tox]]></category>
		<category><![CDATA[unit tests]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=5969</guid>
		<description><![CDATA[Je ne fais plus de tests unittaires sans <a href="http://sametmax.com/se-simplifier-les-tests-python-avec-pytest/">pytest</a>, et je me retrouve souvent à rentrer les mêmes paramètres de la commande encore et encore. Parfois, quand j'autilise des wrappers tels que django-pytest et pytest-django (ça s'invente pas), je ne peux même pas passer d'arguments directement à <code>py.test</code>.

On peut y remedier en créer un fichier de config à la racine du projet.]]></description>
				<content:encoded><![CDATA[<p>Je ne fais plus de tests unittaires sans <a href="http://sametmax.com/se-simplifier-les-tests-python-avec-pytest/">pytest</a>, et je me retrouve souvent à rentrer les mêmes paramètres de la commande encore et encore. Parfois, quand j&#8217;utilise des wrappers tels que django-pytest et pytest-django (ça s&#8217;invente pas), je ne peux même pas passer d&#8217;arguments directement à <code>py.test</code>.</p>
<p>On peut y remédier en créant un fichier de config à la racine du projet. Nommez le fichier <em>tox.ini</em>, car c&#8217;est aussi le nom du fichier de configuration de l&#8217;outil de tests <a href="http://testrun.org/tox/latest//">tox</a>, et il est compatible, donc autant avoir un seul format. Dedans, créez une section pytest, et vous pouvez configurer la lib la dedans.</p>
<p>En l’occurrence, le settings &#8220;addopts&#8221;, pour &#8220;add options&#8221; (ajouter options), permet de spécifier les options de la ligne de commande à toujours ajouter à <code>py.test</code>.</p>
<p>Mon fichier contient toujours au moins ceci :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="json" style="font-family:monospace;">[pytest]
addopts = --ignore=&quot;virtualenv&quot; --capture=no</pre></td></tr></table></div>

<p>Ainsi <code>py.test</code> ignore toujours le dossier <em>virtualenv</em> (qui est un lien vers l&#8217;env virtuel de mon projet) car je ne veux pas qu&#8217;il lance les tests de ce dossier. Et il ne capture pas stdout, ce qui me permet d&#8217;utiliser <a href="http://sametmax.com/debugger-en-python-les-bases-de-pdb/">ipdb</a> pendant les tests unittaires. Parfois j&#8217;utilise aussi <code>--maxfail=1</code> quand je veux qu&#8217;il s&#8217;arrête dès la première erreur rencontrée.</p>
<p>Pour ne pas aller dans ce dossier et ne pas capturer stdout.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/parametres-par-defaut-pour-la-commande-py-test/feed/</wfw:commentRss>
		<slash:comments>3</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2013/05/OaEu6Os.jpg" length="78922" type="image/jpg" />	</item>
		<item>
		<title>Se simplifier les tests Python avec Pytest 11</title>
		<link>http://sametmax.com/se-simplifier-les-tests-python-avec-pytest/</link>
		<comments>http://sametmax.com/se-simplifier-les-tests-python-avec-pytest/#comments</comments>
		<pubDate>Wed, 07 Nov 2012 12:04:50 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[unit tests]]></category>
		<category><![CDATA[unittest]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=2884</guid>
		<description><![CDATA[Et si on pouvait rendre les tests plus simples à écrire et à lire, aussi simple qu'un <code>assert</code>, mais un résultat plus clair que <code>unittest</code> en sortie ?]]></description>
				<content:encoded><![CDATA[<p>Personne n&#8217;aime faire des tests unitaires. C&#8217;est un peu comme les impôts: on sait que c&#8217;est utile, mais on est jamais content de s&#8217;en occuper.</p>
<p>Réchèr m&#8217;a dernièrement <a href="http://sametmax.com/quelques-innovation-de-python-3-backportees-en-python-2-7/#comment-2870">posé la question</a> de l&#8217;abondance des méthodes <code>assertTruc()</code> et leur utilité, et je lui ai répondu que chaque méthode donnait des infos adaptées au test effectué.</p>
<p>Max m&#8217;a dernièrement fait la remarque que les tests &#8220;c&#8217;est bien mais c&#8217;est compliqué&#8221;. J&#8217;avoue être à court de contre argument.</p>
<p>Et si on pouvait rendre les tests plus simples à écrire et à lire, aussi simple qu&#8217;un <code>assert</code>, mais avec un résultat plus clair que <code>unittest</code> en sortie ?</p>
<p><code><a href="http://sametmax.com/votre-python-aime-les-pip/">pip install</a> pytest </code></p>
<p><a href="http://pytest.org/latest/index.html">Pytest</a> est une lib de test à utiliser à la place de <a href="http://docs.python.org/2/library/unittest.html">unittest</a>. Ses créateurs utilisent l&#8217;introspections et l&#8217;injection de dépendance pour créer des tests magiquement.</p>
<p>D&#8217;ordinnaire, la magie, on aime pas trop ça en Python, et on laisse ça aux rubistes. Mais dans le domaine du test, qui n&#8217;est pas un code de production avec les mêmes contraintes de lecture, de recherche de bugs architecturaux et d&#8217;interactions entre dev, mais qui a par contre une forte contrainte &#8220;j&#8217;ai pas envie d&#8217;écrire un caractère de plus&#8221;, ça a du sens.</p>
<p>Voilà comment ça se passe: on vire toute ce qui est classe et setup verbeux. On laisse juste les imports de vos libs, et les tests. Avec des <code>assert</code>. Pytest va alors analyser tout ça, et faire tout le boulot autour pour vous.</p>
<p>Exemple:</p>
<p>Dans votre lib:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> ma_fonction_a_tester<span style="color: black;">&#40;</span>a<span style="color: #66cc66;">,</span> b<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">return</span> a + b</pre></td></tr></table></div>

<p>Dans votre fichier test.py:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">from</span> malib <span style="color: #ff7700;font-weight:bold;">import</span> ma_fonction_a_tester
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> test_function<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">assert</span> ma_fonction_a_tester<span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span> <span style="color: #66cc66;">==</span> <span style="color: #ff4500;">2</span></pre></td></tr></table></div>

<p>Et on lance :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">py.test test.py</pre></td></tr></table></div>

<p>Pour obtenir:</p>
<pre>====== test session starts ======
platform linux2 -- Python 2.7.3 -- pytest-2.3.2
collected 1 items

Bureau/test.py .

====== 1 passed in 0.02 seconds ======
</pre>
<p>Et voilà, les tests redeviennent bêtes et simples. Mais ils ne perdent pas en puissance. Car Pytest analyse le <code>assert</code>, et le transforme à la volée. Du coup, pour les <a href="http://sametmax.com/quest-ce-quune-structure-de-donnees/">structures de données</a> complexes, Pytest va vous sortir les infos de debug utile que <code>assertTruc()</code> de unittest vous aurait sorti.</p>
<p>Exemple avec des tuples:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> ma_fonction_a_tester<span style="color: black;">&#40;</span>a<span style="color: #66cc66;">,</span> b<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: black;">&#40;</span>a * <span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span> b * <span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span>
&nbsp;
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> test_function<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">assert</span> ma_fonction_a_tester<span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span> <span style="color: #66cc66;">==</span> <span style="color: black;">&#40;</span><span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Va donner:</p>
<pre>
====== test session starts ======
platform linux2 -- Python 2.7.3 -- pytest-2.3.2
collected 1 items

Bureau/test.py F

====== FAILURES ======
______ test_function ______

    def test_function():
>       assert ma_fonction_a_tester(1, 1) == (2, 2, 3)
E       assert (2, 2) == (2, 2, 3)
E         Right contains more items, first extra item: 3

Bureau/test.py:7: AssertionError
====== 1 failed in 0.02 seconds ======</pre>
<p>On nous indique clairement qu&#8217;il y a un item de trop dans mon résultat, et lequel.</p>
<p>En prime, Pytest nous affranchie des fonctions <code>setUp()</code> et <code>tearDown()</code> génériques. Le problème de ces méthodes dans unittest, c&#8217;est qu&#8217;elles sont éxécutées à chaque début de test. On en a pas forcément besoin, et on a pas les mêmes besoins pour chaque test.</p>
<p>Pytest ajoute encore un peu de magie pour régler le probleme</p>
<p>Dans votre lib, vous avez ça:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">re</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> extraire_title<span style="color: black;">&#40;</span>html<span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;
        Extrait le title d'une page HTML a base de regex. C'est mal.
    &quot;&quot;&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">try</span>:
        <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #dc143c;">re</span>.<span style="color: black;">search</span><span style="color: black;">&#40;</span>r<span style="color: #483d8b;">'&lt;title[^&gt;]*&gt;(.*)&lt;/title&gt;'</span><span style="color: #66cc66;">,</span> html<span style="color: black;">&#41;</span>.<span style="color: black;">groups</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#93;</span>
    <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: #008000;">IndexError</span><span style="color: #66cc66;">,</span> <span style="color: #008000;">AttributeError</span>:
        <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">None</span></pre></td></tr></table></div>

<p>Dans votre fichier de tests, vous aurez:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">urllib2</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">import</span> pytest
&nbsp;
<span style="color: #66cc66;">@</span>pytest.<span style="color: black;">fixture</span>
<span style="color: #ff7700;font-weight:bold;">def</span> exemple_html<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #dc143c;">urllib2</span>.<span style="color: black;">urlopen</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'http://www.google.com'</span><span style="color: black;">&#41;</span>.<span style="color: black;">read</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> test_extraire_title<span style="color: black;">&#40;</span>exemple_html<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">assert</span> extraire_title<span style="color: black;">&#40;</span>exemple_html<span style="color: black;">&#41;</span> <span style="color: #66cc66;">==</span> <span style="color: #483d8b;">'Google'</span></pre></td></tr></table></div>

<p>Qu&#8217;est-ce qui va se passer ?</p>
<p><code>exemple_html()</code> va être déclarée comme une &#8220;fixture&#8221;, c&#8217;est à dire quelque chose qui contient ou génère des données de tests.</p>
<p>Quand Pytest va lancer les tests, il va voir qu&#8217;un argument de <code>test_extraire_title()</code> porte le même nom que la fonction <code>exemple_html</code>. Alors, il va automatiquement appeler <code>exemple_html()</code>, et passer le résultat à <code>test_extraire_title()</code> pour lancer le test.</p>
<p>On peut donc avoir des tas de fonctions de setup, partagées entre plein de fonctons de tests.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/se-simplifier-les-tests-python-avec-pytest/feed/</wfw:commentRss>
		<slash:comments>11</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2012/11/fat-free-product-4001.jpg" length="186363" type="image/jpg" />	</item>
		<item>
		<title>Quelques innovation de Python 3 backportées en Python 2.7 4</title>
		<link>http://sametmax.com/quelques-innovation-de-python-3-backportees-en-python-2-7/</link>
		<comments>http://sametmax.com/quelques-innovation-de-python-3-backportees-en-python-2-7/#comments</comments>
		<pubDate>Mon, 05 Nov 2012 11:36:42 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[context manager]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[sets]]></category>
		<category><![CDATA[strings]]></category>
		<category><![CDATA[unit tests]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=2863</guid>
		<description><![CDATA[Comme nous l'avons vu avec les vues ou les collections, Python 2.7 vient avec pas mal de bonus issus directement de la branche 3. En voici quelques autres. Tout ceci n'est bien sûr ni nouveau ni exhaustif, mais je m’aperçois que peu de personnes le savent.]]></description>
				<content:encoded><![CDATA[<p>Comme nous l&#8217;avons vu avec les <a href="http://sametmax.com/les-vues-sur-des-collections-en-python/">vues</a> ou les <a href="http://sametmax.com/ce-que-vous-ne-saviez-pas-sur-les-collections-en-python/">collections</a>, Python 2.7 vient avec pas mal de bonus issus directement de la branche 3. En voici quelques autres. Tout ceci n&#8217;est bien sûr ni nouveau ni exhaustif, mais je m’aperçois que peu de personnes le savent.</p>
<p>Une notation littérale pour les sets:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: black;">&#123;</span><span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: black;">&#125;</span> <span style="color: #66cc66;">==</span> <span style="color: #008000;">set</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #008000;">True</span></pre></td></tr></table></div>

<p>Une syntaxe pour les dictionnaires en intention:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> d <span style="color: #66cc66;">=</span> <span style="color: black;">&#123;</span><span style="color: #008000;">chr</span><span style="color: black;">&#40;</span>x<span style="color: black;">&#41;</span>: x <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">range</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">65</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">91</span><span style="color: black;">&#41;</span><span style="color: black;">&#125;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> d
<span style="color: black;">&#123;</span><span style="color: #483d8b;">'A'</span>: <span style="color: #ff4500;">65</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'C'</span>: <span style="color: #ff4500;">67</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'B'</span>: <span style="color: #ff4500;">66</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'E'</span>: <span style="color: #ff4500;">69</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'D'</span>: <span style="color: #ff4500;">68</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'G'</span>: <span style="color: #ff4500;">71</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'F'</span>: <span style="color: #ff4500;">70</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'I'</span>: <span style="color: #ff4500;">73</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'H'</span>: <span style="color: #ff4500;">72</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'K'</span>: <span style="color: #ff4500;">75</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'J'</span>: <span style="color: #ff4500;">74</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'M'</span>: <span style="color: #ff4500;">77</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'L'</span>: <span style="color: #ff4500;">76</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'O'</span>: <span style="color: #ff4500;">79</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'N'</span>: <span style="color: #ff4500;">78</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'Q'</span>: <span style="color: #ff4500;">81</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'P'</span>: <span style="color: #ff4500;">80</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'S'</span>: <span style="color: #ff4500;">83</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'R'</span>: <span style="color: #ff4500;">82</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'U'</span>: <span style="color: #ff4500;">85</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'T'</span>: <span style="color: #ff4500;">84</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'W'</span>: <span style="color: #ff4500;">87</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'V'</span>: <span style="color: #ff4500;">86</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'Y'</span>: <span style="color: #ff4500;">89</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'X'</span>: <span style="color: #ff4500;">88</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'Z'</span>: <span style="color: #ff4500;">90</span><span style="color: black;">&#125;</span></pre></td></tr></table></div>

<p>Imbriquer <code>with</code>:</p>
<p>Avant il fallait utiliser <a href="http://docs.python.org/2/library/contextlib.html#contextlib.nested">nested()</a> ou imbriquer à la main</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">with</span> <span style="color: #008000;">open</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'fichiera'</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">as</span> a:
    <span style="color: #ff7700;font-weight:bold;">with</span> <span style="color: #008000;">open</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'fichiera'</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">as</span> b:
        <span style="color: #808080; font-style: italic;"># faire un truc</span></pre></td></tr></table></div>

<p>Maintenant on peut faire:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">with</span> <span style="color: #008000;">open</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'fichiera'</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">as</span> a<span style="color: #66cc66;">,</span> <span style="color: #008000;">open</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'fichiera'</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">as</span> b:
    <span style="color: #808080; font-style: italic;"># faire un truc</span></pre></td></tr></table></div>

<p>Rien à voir, mais toujours sympa. <code>timedelta</code> a maintenant une méthode <code>total_seconds()</code> qui retourne la valeur de la durée en seconde. En effet, l&#8217;attribut <code>seconds</code> ne retourne que ce qui reste en seconde une fois qu&#8217;on a retiré les jours:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">datetime</span> <span style="color: #ff7700;font-weight:bold;">import</span> timedelta
<span style="color: #66cc66;">&gt;&gt;&gt;</span> delta <span style="color: #66cc66;">=</span> timedelta<span style="color: black;">&#40;</span>days<span style="color: #66cc66;">=</span><span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> seconds<span style="color: #66cc66;">=</span><span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> delta.<span style="color: black;">seconds</span>
<span style="color: #ff4500;">1</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> delta.<span style="color: black;">total_seconds</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #ff4500;">86401.0</span></pre></td></tr></table></div>

<p>Notez qu&#8217;il n&#8217;y a toujours ni attribut minutes, ni heures.</p>
<p>Le module <code>unittest</code> gagne une pléthore d&#8217;améliorations, et notamment:</p>
<p>L&#8217;utilisation de <code>assertRaises</code> comme context manager:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">with</span> <span style="color: #008000;">self</span>.<span style="color: black;">assertRaises</span><span style="color: black;">&#40;</span><span style="color: #008000;">KeyError</span><span style="color: black;">&#41;</span>:
    <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span><span style="color: black;">&#91;</span><span style="color: #483d8b;">'foo'</span><span style="color: black;">&#93;</span></pre></td></tr></table></div>

<p>Et un bon gros nombres de méthodes:</p>
<p><code>assertIsNone()</code> / <code>assertIsNotNone()</code>, <code>assertIs()</code> / <code>assertIsNot()</code>, <code>assertIsInstance()</code> / <code>assertNotIsInstance()</code>, <code>assertGreater()</code> / <code>assertGreaterEqual()</code> / <code>assertLess()</code> / <code>assertLessEqual()</code>, <code>assertRegexpMatches()</code> / <code>assertNotRegexpMatches()</code>, <code>assertRaisesRegexp()</code>,<br />
<code>assertIn()</code> / <code>assertNotIn()</code>, <code>assertDictContainsSubset()</code>, <code>assertAlmostEqual()</code> / <code>assertNotAlmostEqual()</code>.</p>
<p>Enfin <code>format()</code> commence à devenir une alternative valable à <code>%</code> car il propose maintenant des marqueurs sans noter d’index:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #483d8b;">&quot;{}, puis {} et finalement {}&quot;</span>.<span style="color: black;">format</span><span style="color: black;">&#40;</span>*<span style="color: #008000;">range</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #483d8b;">'0, puis 1 et finalement 2'</span></pre></td></tr></table></div>

<p>Et il ajoute le séparateur des milliers au mini-langage de formatage, mais pour la virgule uniquement. Par exemple, si avoir un nombre de 15 caractères minimum formater en tant que float, avec deux chiffres après la virgules, et donc les milliers sont groupés à l&#8217;américaine:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #483d8b;">'{:15,.2f}'</span>.<span style="color: black;">format</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">54321</span><span style="color: black;">&#41;</span>
<span style="color: #483d8b;">'      54,321.00'</span></pre></td></tr></table></div>

]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/quelques-innovation-de-python-3-backportees-en-python-2-7/feed/</wfw:commentRss>
		<slash:comments>4</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2012/11/Pimp-My-Ride-43797.jpg" length="291183" type="image/jpg" />	</item>
		<item>
		<title>Répéter une commande bash jusqu&#8217;à ça marche ou que ça plante 5</title>
		<link>http://sametmax.com/repeter-une-commande-bash-jusqua-ca-marche-ou-que-ca-plante/</link>
		<comments>http://sametmax.com/repeter-une-commande-bash-jusqua-ca-marche-ou-que-ca-plante/#comments</comments>
		<pubDate>Wed, 08 Aug 2012 14:37:01 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[bash]]></category>
		<category><![CDATA[unit tests]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=1594</guid>
		<description><![CDATA[Parfois il est utile de spammer son terminal jusqu'à ce que mort s'en suive.]]></description>
				<content:encoded><![CDATA[<p>Parfois il est utile de spammer son terminal jusqu&#8217;à ce que mort s&#8217;en suive.</p>
<p>Par exemple, hier nous avions un bug aléatoire qui apparaissait dans une batterie de tests qui prenait quelques minutes à exécuter. Confirmer qu&#8217;on avait bien éliminé le problème était délicat.</p>
<p>On est donc allé faire les courses (c&#8217;est y pas mignon, le petit couple sam et max au super marché, so kawaï) et j&#8217;ai lancé ceci avant de partir faire la queue pendant une heure:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">nosetests tests <span style="color: #660033;">-x</span>; <span style="color: #000000; font-weight: bold;">while</span> <span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #7a0874; font-weight: bold;">&#91;</span> <span style="color: #007800;">$?</span> <span style="color: #660033;">-eq</span> <span style="color: #ff0000;">&quot;0&quot;</span> <span style="color: #7a0874; font-weight: bold;">&#93;</span><span style="color: #7a0874; font-weight: bold;">&#93;</span>; <span style="color: #000000; font-weight: bold;">do</span> nosetests tests <span style="color: #660033;">-x</span>; <span style="color: #000000; font-weight: bold;">done</span></pre></td></tr></table></div>

<p><code>nosetests tests -x</code> lance tous les tests et plante dès le premier qui foire.</p>
<p><code>$? -eq "0"</code> vérifie le dernier code de retour, et continue si il est égal à 0 (ce qui veut dire &#8220;tout s&#8217;est bien passé&#8221; en langue Unix).</p>
<p>Ainsi les tests ont tourné pendant toute notre session de chasse au rayon fruits et légumes, et à au retour on a pu constaté qu&#8217;ils tournaient toujours. Il y a donc de forte chance que le bug ai été éradiqué, puisqu&#8217;avant il se montrait dans les 5 premiers lancements.</p>
<p>On peut aussi faire l&#8217;inverse: lancer une commande tant qu&#8217;elle foire:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #7a0874; font-weight: bold;">command</span>; <span style="color: #000000; font-weight: bold;">while</span> <span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #7a0874; font-weight: bold;">&#91;</span> <span style="color: #007800;">$?</span> <span style="color: #660033;">-gt</span> <span style="color: #ff0000;">&quot;0&quot;</span> <span style="color: #7a0874; font-weight: bold;">&#93;</span><span style="color: #7a0874; font-weight: bold;">&#93;</span>; <span style="color: #000000; font-weight: bold;">do</span> <span style="color: #7a0874; font-weight: bold;">command</span>; <span style="color: #000000; font-weight: bold;">done</span></pre></td></tr></table></div>

]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/repeter-une-commande-bash-jusqua-ca-marche-ou-que-ca-plante/feed/</wfw:commentRss>
		<slash:comments>5</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2012/08/Einstein.jpg" length="19483" type="image/jpg" />	</item>
	</channel>
</rss>
