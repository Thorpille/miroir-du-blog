<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Sam &#38; Max &#187; decorateur</title>
	<atom:link href="http://sametmax.com/tag/decorateur/feed/" rel="self" type="application/rss+xml" />
	<link>http://sametmax.com</link>
	<description>Du code, du cul</description>
	<lastBuildDate>Sat, 07 Nov 2015 10:56:13 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>http://wordpress.org/?v=4.1</generator>
	<item>
		<title>Update du tuto sur les décorateurs 1</title>
		<link>http://sametmax.com/update-du-tuto-sur-les-decorateurs/</link>
		<comments>http://sametmax.com/update-du-tuto-sur-les-decorateurs/#comments</comments>
		<pubDate>Wed, 26 Aug 2015 14:27:15 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[decorateur]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=16817</guid>
		<description><![CDATA[Lui aussi est en deux parties. La première était facile : uniquement les prints à changer. Les features  prog fonctionnelle n'ont pas beaucoup évolué entre Python 2 et 3 il faut dire.]]></description>
				<content:encoded><![CDATA[<p>Lui aussi est en <a href="http://sametmax.com/comprendre-les-decorateurs-python-pas-a-pas-partie-1/">deux</a> <a href="http://sametmax.com/comprendre-les-decorateur-python-pas-a-pas-partie-2/">parties</a>. La première était facile : uniquement les prints à changer. Les features de prog fonctionnelle n&#8217;ont pas beaucoup évolué entre Python 2 et 3 il faut dire.</p>
<p>Pour la partie 2, j&#8217;ai changé quelques phrases, mais surtout un exemple qui avait pété, non pas à cause de Python 3, mais parce qu&#8217;il tapait sur une page dont le contenu avait changé.</p>
<p>Bref, si vous avez envie de savoir comment écrire vos propres décorateurs, vous savez quoi faire.</p>
<p>Et sur une note complètement différente, voici à quoi ressemble un vaccum bed, une  pratique sexuelle très particulière où la personne est installée dans un sceau de plastique qu&#8217;on l&#8217;on met sous vide pour le faire coller à la peau :</p>
<p><iframe width="510" height="400" src="http://xhamster.com/xembed.php?video=1973829" frameborder="0" scrolling="no" allowfullscreen></iframe></p>
<p>Ensuite chacun fait ce qu&#8217;il veut : anneau vibrant, dildo, huile chaude&#8230;</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/update-du-tuto-sur-les-decorateurs/feed/</wfw:commentRss>
		<slash:comments>1</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2015/08/greyisbeautiful2.jpg" length="26236" type="image/jpg" />	</item>
		<item>
		<title>Un peu de fun avec les décorateurs</title>
		<link>http://sametmax.com/un-peu-de-fun-avec-les-decorateurs/</link>
		<comments>http://sametmax.com/un-peu-de-fun-avec-les-decorateurs/#comments</comments>
		<pubDate>Mon, 17 Nov 2014 01:06:51 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[callback]]></category>
		<category><![CDATA[decorateur]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[twisted]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=12648</guid>
		<description><![CDATA[Comme souvent, c'est le genre de feature qui peut être abusée, mais c'est parfois sympas de rapprocher une action juste au dessus de la fonction qui va être dans ce contexte. 
]]></description>
				<content:encoded><![CDATA[<p>Puisque la programmation asynchrone est au goût du jour, on se mange des callbacks un peu partout. Et ça alourdit toujours le code. Chaque langage, lib ou framework a essayé de trouver des astuces pour rendre tout ça plus digeste, et on a vu la naissance des Futures, Deferred, Promises, coroutines, yield from et autres joyeusetés.</p>
<p>Prenons par exemple un script Twisted. Déjà, Twisted, c&#8217;est pas vraiment l&#8217;exemple de la syntaxe Weight Watcher, ou alors si, mais avant le début du régime.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #808080; font-style: italic;"># -*- coding: utf-8 -*-</span>
&nbsp;
<span style="color: #483d8b;">&quot;&quot;&quot; Télécharge des pages et affiche leur, de manière asynchrone &quot;&quot;&quot;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">re</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># Ceci doit être pip installé</span>
<span style="color: #ff7700;font-weight:bold;">import</span> treq
<span style="color: #ff7700;font-weight:bold;">from</span> twisted.<span style="color: black;">internet</span>.<span style="color: black;">task</span> <span style="color: #ff7700;font-weight:bold;">import</span> react
<span style="color: #ff7700;font-weight:bold;">from</span> twisted.<span style="color: black;">internet</span>.<span style="color: black;">defer</span> <span style="color: #ff7700;font-weight:bold;">import</span> inlineCallbacks<span style="color: #66cc66;">,</span> returnValue
&nbsp;
<span style="color: #808080; font-style: italic;"># Soit on utilise la syntaxe 'inlineCallbacks', c'est à dire avec des yields</span>
<span style="color: #808080; font-style: italic;"># qui marquent les appels asynchrones.</span>
<span style="color: #66cc66;">@</span>inlineCallbacks
<span style="color: #ff7700;font-weight:bold;">def</span> get_title<span style="color: black;">&#40;</span>url<span style="color: black;">&#41;</span>:
    res <span style="color: #66cc66;">=</span> <span style="color: #ff7700;font-weight:bold;">yield</span> treq.<span style="color: black;">get</span><span style="color: black;">&#40;</span>url<span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># Ceci est asynchrone et non bloquant</span>
    html <span style="color: #66cc66;">=</span> <span style="color: #ff7700;font-weight:bold;">yield</span> res.<span style="color: black;">content</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># Ça aussi</span>
    <span style="color: #ff7700;font-weight:bold;">try</span>:
        val <span style="color: #66cc66;">=</span> <span style="color: #dc143c;">re</span>.<span style="color: black;">search</span><span style="color: black;">&#40;</span>r<span style="color: #483d8b;">''</span><span style="color: #66cc66;">,</span> html.<span style="color: black;">decode</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'utf8'</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>.<span style="color: black;">groups</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#93;</span>
    <span style="color: #ff7700;font-weight:bold;">except</span>:
        val <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">''</span>
&nbsp;
    returnValue<span style="color: black;">&#40;</span>val<span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># Soit on récupère un objet defer et on ajoute un callback manuellement</span>
<span style="color: #ff7700;font-weight:bold;">def</span> main<span style="color: black;">&#40;</span>reactor<span style="color: black;">&#41;</span>:
&nbsp;
    <span style="color: #808080; font-style: italic;"># Ceci est asynchrone et non bloquant</span>
    defer <span style="color: #66cc66;">=</span> get_title<span style="color: black;">&#40;</span><span style="color: #483d8b;">'http://sametmax.com/quest-ce-quun-callback/'</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># Ceci arrive une fois que get_title est terminé</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> cb<span style="color: black;">&#40;</span>title<span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>title.<span style="color: black;">upper</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> + <span style="color: #483d8b;">'!'</span><span style="color: black;">&#41;</span>
&nbsp;
    defer.<span style="color: black;">addCallback</span><span style="color: black;">&#40;</span>cb<span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># Pareil</span>
    autre_defer <span style="color: #66cc66;">=</span> get_title<span style="color: black;">&#40;</span><span style="color: #483d8b;">'https://github.com/sametmax/django-quicky'</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> cb<span style="color: black;">&#40;</span>title<span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>title.<span style="color: black;">upper</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> + <span style="color: #483d8b;">'!!!'</span><span style="color: black;">&#41;</span>
&nbsp;
    autre_defer.<span style="color: black;">addCallback</span><span style="color: black;">&#40;</span>cb<span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">return</span> defer
&nbsp;
react<span style="color: black;">&#40;</span>main<span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>D&#8217;une manière générale, je préfère la syntaxe à base de yields, même si elle oblige à se trimbaler le décorateur <code>inlineCallbacks</code> partout, à parsemer sa fonction de yields et à utiliser <code>returnValue</code> à la place de <code>return</code> puisque le mot clé est interdit dans les générateurs en Python 2.7.</p>
<p>Mais bon, ça reste facile à lire. On sait que les lignes avec <code>yield</code>, sont les appels bloquant qu&#8217;on demande à la boucle d’événements de traiter de manière asynchrone.</p>
<p>La syntaxe à base de callbacks est plus lourde, en revanche elle donne le contrôle sur la concurrence des callbacks puisqu&#8217;ils sont explicites au lieu d&#8217;être automatiquement ajoutés par magie. Elle parlera aussi plus aux dev Javascript qui ont l&#8217;habitude d&#8217;ajouter des callbacks manuellement.</p>
<p>Néanmoins, en JS, on a des fonctions anonymes plus flexibles, et on ferait donc plutôt une truc du genre :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">get_title<span style="color: black;">&#40;</span>url<span style="color: black;">&#41;</span>.<span style="color: black;">then</span><span style="color: black;">&#40;</span>function<span style="color: black;">&#40;</span>title<span style="color: black;">&#41;</span><span style="color: black;">&#123;</span>
    <span style="color: #808080; font-style: italic;"># faire un truc avec le résultat</span>
<span style="color: black;">&#125;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Et bien il se trouve qu&#8217;avec Python, bien qu&#8217;on ne le voit pas souvent, on peut avoir cette idée de la déclaration de son appel asynchrone juste au dessus de son callback, en utilisant des <a href="http://sametmax.com/comprendre-les-decorateurs-python-pas-a-pas-partie-1/">décorateurs</a>.</p>
<p>En effet, les décorateurs ne sont que du sucre syntaxique :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">@</span>truc
<span style="color: #ff7700;font-weight:bold;">def</span> bidule<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    chose</pre></td></tr></table></div>

<p>N&#8217;est en fait qu&#8217;un raccourci pour écrire :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> bidule<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    chose
&nbsp;
bidule <span style="color: #66cc66;">=</span> truc<span style="color: black;">&#40;</span>bidule<span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Du coup, on peut prendre n&#8217;importe quelle fonction, ou méthode, et l&#8217;utiliser comme décorateur :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">@</span>react
<span style="color: #ff7700;font-weight:bold;">def</span> main<span style="color: black;">&#40;</span>reactor<span style="color: black;">&#41;</span>:
&nbsp;
    then <span style="color: #66cc66;">=</span> get_title<span style="color: black;">&#40;</span><span style="color: #483d8b;">'http://sametmax.com/quest-ce-quun-callback/'</span><span style="color: black;">&#41;</span>.<span style="color: black;">addCallback</span>
    <span style="color: #66cc66;">@</span>then
    <span style="color: #ff7700;font-weight:bold;">def</span> cb<span style="color: black;">&#40;</span>title<span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>title.<span style="color: black;">upper</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> + <span style="color: #483d8b;">'!'</span><span style="color: black;">&#41;</span>
&nbsp;
    then <span style="color: #66cc66;">=</span> get_title<span style="color: black;">&#40;</span><span style="color: #483d8b;">'https://github.com/sametmax/django-quicky'</span><span style="color: black;">&#41;</span>.<span style="color: black;">addCallback</span>
    <span style="color: #66cc66;">@</span>then
    <span style="color: #ff7700;font-weight:bold;">def</span> cb<span style="color: black;">&#40;</span>title<span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>title.<span style="color: black;">upper</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> + <span style="color: #483d8b;">'!!!'</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">return</span> cb</pre></td></tr></table></div>

<p>Et en jouant avec <code>functools.partial</code>, on peut faire aussi des trucs rigolos.</p>
<p>Non pas que cette syntaxe soit le truc indispensable à connaître et à utiliser. Mais les gens n&#8217;y pensent jamais. On utilise pas assez les décorateurs.</p>
<p>Par exemple, combien de fois vous avez vu :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> main<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'Doh'</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">if</span> __name__ <span style="color: #66cc66;">==</span> <span style="color: #483d8b;">'__main__'</span>:
    main<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Certaines libs, comme begin, font des décorateurs pour ça :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> main<span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">if</span> __name__ <span style="color: #66cc66;">==</span> <span style="color: #483d8b;">'__main__'</span>:
        func<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Et du coup, dans son prog:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">@</span>main
<span style="color: #ff7700;font-weight:bold;">def</span> _<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'Doh'</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Comme souvent, c&#8217;est le genre de feature qui peut être abusée, mais c&#8217;est parfois sympa de rapprocher une action juste au dessus de la fonction qui va être dans ce contexte.</p>
<p>J&#8217;espère ainsi vous avoir inspiré pour mettre un hack ou deux en production détournant complètement l&#8217;usage des décorateurs et ajoutant quelques gouttes de plus dans le vase de la sécurité de votre emploi, ou votre licenciement.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/un-peu-de-fun-avec-les-decorateurs/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2014/11/BXbQyP3.jpg" length="74676" type="image/jpg" />	</item>
		<item>
		<title>Décorateur de trace 14</title>
		<link>http://sametmax.com/decorateur-de-trace/</link>
		<comments>http://sametmax.com/decorateur-de-trace/#comments</comments>
		<pubDate>Mon, 15 Apr 2013 17:33:32 +0000</pubDate>
		<dc:creator><![CDATA[xonop]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[decorateur]]></category>
		<category><![CDATA[inspect]]></category>
		<category><![CDATA[introspection]]></category>
		<category><![CDATA[log]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=5670</guid>
		<description><![CDATA[Suite aux superbes articles sur les <a href="http://comprendre-les-decorateurs-python-pas-a-pas-partie-1">décorateurs</a> et sur l'écriture des <a href="http://ecrire-des-logs-en-python/">logs en python</a> j'ai voulu mettre en pratique dans mon projet.
C'est là que les ennuis ont commencé !]]></description>
				<content:encoded><![CDATA[<p><em>(Ceci est un post invité de <a href="http://sametmax.com/author/xonop/">xonop</a> sous licence creative common 3.0 unported.)</em></p>
<p>Suite aux superbes articles sur les <a href="http://sametmax.com/comprendre-les-decorateurs-python-pas-a-pas-partie-1">décorateurs</a> et sur l&#8217;écriture des <a href="http://sametmax.com/ecrire-des-logs-en-python/">logs en python</a> j&#8217;ai voulu mettre en pratique dans mon projet.<br />
C&#8217;est là que les ennuis ont commencé !<br />
<span id="more-5670"></span></p>
<p><strong>Objectif :</strong></p>
<p>Créer un décorateur qui me permette de tracer le passage dans certaines méthodes.<br />
Celui-ci doit :</p>
<ul>
<li>Être débrayable facilement.</li>
<li>Récupérer automatiquement le nom de la méthode, sa classe et son module.</li>
</ul>
<p><strong>Première étape : le logger</strong></p>
<p>Avant toute chose mettons en place l&#8217;environnement pour pouvoir tracer en utilisant le module logging.<br />
Pour simplifier les exemples, nous associons un seul <em>handler</em> de type <em>terminal</em>.<br />
La fonction <code>log_debug</code> permet de faire appel au logger pour tracer une information.</p>
<p><code>logger.py</code> :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> functools
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">logging</span>
&nbsp;
__DECO_ACTIVATED <span style="color: #66cc66;">=</span> <span style="color: #008000;">True</span>
__logger <span style="color: #66cc66;">=</span> <span style="color: #008000;">None</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> init_logger<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">global</span> __logger
    __logger <span style="color: #66cc66;">=</span> <span style="color: #dc143c;">logging</span>.<span style="color: black;">getLogger</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
    __logger.<span style="color: black;">setLevel</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">logging</span>.<span style="color: black;">DEBUG</span><span style="color: black;">&#41;</span>
    terminalHandler <span style="color: #66cc66;">=</span> <span style="color: #dc143c;">logging</span>.<span style="color: black;">StreamHandler</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
    terminalHandler.<span style="color: black;">setLevel</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">logging</span>.<span style="color: black;">DEBUG</span><span style="color: black;">&#41;</span>
    __logger.<span style="color: black;">addHandler</span><span style="color: black;">&#40;</span>terminalHandler<span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> log_debug<span style="color: black;">&#40;</span>text<span style="color: black;">&#41;</span>:
    __logger.<span style="color: black;">debug</span><span style="color: black;">&#40;</span>text<span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p><strong>Deuxième étape : le décorateur, version basique</strong></p>
<p>Pour commencer, le décorateur débrayable :</p>
<p><code>logger.py</code> :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> log_decorator<span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #ff7700;font-weight:bold;">not</span> __DECO_ACTIVATED:
        <span style="color: #ff7700;font-weight:bold;">return</span> func
&nbsp;
    <span style="color: #66cc66;">@</span>functools.<span style="color: black;">wraps</span><span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> wrapped<span style="color: black;">&#40;</span>*args<span style="color: #66cc66;">,</span> **kwargs<span style="color: black;">&#41;</span>:
        __logger.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;BEGIN&quot;</span><span style="color: black;">&#41;</span>
        data <span style="color: #66cc66;">=</span> func<span style="color: black;">&#40;</span>*args<span style="color: #66cc66;">,</span> **kwargs<span style="color: black;">&#41;</span>
        __logger.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;END&quot;</span><span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> data
    <span style="color: #ff7700;font-weight:bold;">return</span> wrapped</pre></td></tr></table></div>

<p><strong>Remarques :</strong></p>
<ul>
<li>La fonction est décorée selon la valeur de la variable <code>__DECO_ACTIVATED</code>.</li>
<li>La fonction <a href="http://docs.python.org/3/library/functools.html#functools.wraps">wraps</a> du module <a href="http://docs.python.org/3/library/functools.html">functools</a> reporte les attributs de la fonction originale sur la version <em>wrappée</em> (dont les docstrings).</li>
</ul>
<p>Et maintenant un module pour tester ça :</p>
<p><code>main.py</code> :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> logger
&nbsp;
<span style="color: #ff7700;font-weight:bold;">class</span> Generic<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    <span style="color: #66cc66;">@</span>logger.<span style="color: black;">log_decorator</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> do_it<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> arg1<span style="color: black;">&#41;</span>:
        logger.<span style="color: black;">log_debug</span><span style="color: black;">&#40;</span>arg1<span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">if</span> __name__ <span style="color: #66cc66;">==</span> <span style="color: #483d8b;">&quot;__main__&quot;</span>:
    logger.<span style="color: black;">init_logger</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
    generic <span style="color: #66cc66;">=</span> Generic<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
    generic.<span style="color: black;">do_it</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;NOW&quot;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Et voilà le résultat :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">BEGIN
NOW
END</pre></td></tr></table></div>

<p><strong>Troisième étape : les noms de module et de fonction</strong></p>
<p>Ces informations se récupèrent facilement, voici la nouvelle version du décorateur :</p>
<p><code>logger.py</code> :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> log_decorator<span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #ff7700;font-weight:bold;">not</span> __DECO_ACTIVATED:
        <span style="color: #ff7700;font-weight:bold;">return</span> func
<span style="display:block;background-color: #ffc;">    module_name <span style="color: #66cc66;">=</span> func.__module__</span><span style="display:block;background-color: #ffc;">    func_name <span style="color: #66cc66;">=</span> func.__name__</span>&nbsp;
    <span style="color: #66cc66;">@</span>functools.<span style="color: black;">wraps</span><span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> wrapped<span style="color: black;">&#40;</span>*args<span style="color: #66cc66;">,</span> **kwargs<span style="color: black;">&#41;</span>:
<span style="display:block;background-color: #ffc;">        msg <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">&quot;Module={} Function={}&quot;</span>.<span style="color: black;">format</span><span style="color: black;">&#40;</span>module_name<span style="color: #66cc66;">,</span> func_name<span style="color: black;">&#41;</span></span>        __logger.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;BEGIN &quot;</span> + msg<span style="color: black;">&#41;</span>
        data <span style="color: #66cc66;">=</span> func<span style="color: black;">&#40;</span>*args<span style="color: #66cc66;">,</span> **kwargs<span style="color: black;">&#41;</span>
        __logger.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;END &quot;</span> + msg<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> data
    <span style="color: #ff7700;font-weight:bold;">return</span> wrapped</pre></td></tr></table></div>

<p>Et maintenant le résultat :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">BEGIN Module<span style="color: #66cc66;">=</span><span style="color: #dc143c;">__main__</span> Function<span style="color: #66cc66;">=</span>do_it
NOW
END Module<span style="color: #66cc66;">=</span><span style="color: #dc143c;">__main__</span> Function<span style="color: #66cc66;">=</span>do_it</pre></td></tr></table></div>

<p>Jusqu&#8217;ici tout va bien.</p>
<p><strong>Quatrième étape : le nom de la classe</strong></p>
<p>Et c&#8217;est maintenant que les choses se corsent !<br />
Tout d&#8217;abord, l&#8217;objet <code>func</code> que nous manipulons est une fonction et non une méthode de classe :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&lt;</span>function Generic.<span style="color: black;">do_it</span> at <span style="color: #ff4500;">0x00C70348</span><span style="color: #66cc66;">&gt;</span></pre></td></tr></table></div>

<p>En effet lors de l&#8217;exécution du décorateur, la classe en tant qu&#8217;objet n&#8217;existe pas encore.<br />
Il n&#8217;y a pas de lien direct entre la fonction et sa future classe.</p>
<p>Bon nombre de développeurs bien intentionnés nous conseillent d&#8217;utiliser <code>self</code> pour déterminer sa classe.</p>
<p><strong>Oui mais</strong> :</p>
<ul>
<li>Si la fonction n&#8217;est pas une méthode, pas de <code>self</code> !</li>
<li>La classe n&#8217;est pas obligatoirement celle de la méthode. Il peut s&#8217;agir d&#8217;une classe héritée.</li>
</ul>
<p>Pour s&#8217;en convaincre, voici le nouveau décorateur :</p>
<p><code>logger.py</code> :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> log_decorator<span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #ff7700;font-weight:bold;">not</span> __DECO_ACTIVATED:
        <span style="color: #ff7700;font-weight:bold;">return</span> func
    module_name <span style="color: #66cc66;">=</span> func.__module__
    func_name <span style="color: #66cc66;">=</span> func.__name__
&nbsp;
    <span style="color: #66cc66;">@</span>functools.<span style="color: black;">wraps</span><span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> wrapped<span style="color: black;">&#40;</span>*args<span style="color: #66cc66;">,</span> **kwargs<span style="color: black;">&#41;</span>:
<span style="display:block;background-color: #ffc;">        <span style="color: #ff7700;font-weight:bold;">try</span>:</span><span style="display:block;background-color: #ffc;">            class_name <span style="color: #66cc66;">=</span> args<span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#93;</span>.__class__.__name__</span><span style="display:block;background-color: #ffc;">        <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: #008000;">IndexError</span>:</span><span style="display:block;background-color: #ffc;">            class_name <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">&quot;&quot;</span></span><span style="display:block;background-color: #ffc;">        msg <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">&quot;Module={} Class={} Function={}&quot;</span>.<span style="color: black;">format</span><span style="color: black;">&#40;</span></span><span style="display:block;background-color: #ffc;">            module_name<span style="color: #66cc66;">,</span> class_name<span style="color: #66cc66;">,</span> func_name<span style="color: black;">&#41;</span></span>        __logger.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;BEGIN &quot;</span> + msg<span style="color: black;">&#41;</span>
        data <span style="color: #66cc66;">=</span> func<span style="color: black;">&#40;</span>*args<span style="color: #66cc66;">,</span> **kwargs<span style="color: black;">&#41;</span>
        __logger.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;END &quot;</span> + msg<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> data
    <span style="color: #ff7700;font-weight:bold;">return</span> wrapped</pre></td></tr></table></div>

<p>Et maintenant le module de tests :</p>
<p><code>main.py</code> :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> logger
&nbsp;
<span style="color: #ff7700;font-weight:bold;">class</span> Generic<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    <span style="color: #66cc66;">@</span>logger.<span style="color: black;">log_decorator</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> do_it<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> arg1<span style="color: black;">&#41;</span>:
        logger.<span style="color: black;">log_debug</span><span style="color: black;">&#40;</span>arg1<span style="color: black;">&#41;</span>
&nbsp;
<span style="display:block;background-color: #ffc;"><span style="color: #ff7700;font-weight:bold;">class</span> Specific<span style="color: black;">&#40;</span>Generic<span style="color: black;">&#41;</span>:</span><span style="display:block;background-color: #ffc;">    <span style="color: #66cc66;">@</span>logger.<span style="color: black;">log_decorator</span></span><span style="display:block;background-color: #ffc;">    <span style="color: #ff7700;font-weight:bold;">def</span> do_it<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> arg1<span style="color: black;">&#41;</span>:</span><span style="display:block;background-color: #ffc;">        <span style="color: #008000;">super</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>.<span style="color: black;">do_it</span><span style="color: black;">&#40;</span>arg1<span style="color: black;">&#41;</span></span>&nbsp;
<span style="color: #ff7700;font-weight:bold;">if</span> __name__ <span style="color: #66cc66;">==</span> <span style="color: #483d8b;">&quot;__main__&quot;</span>:
    logger.<span style="color: black;">init_logger</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="display:block;background-color: #ffc;">    specific <span style="color: #66cc66;">=</span> Specific<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></span><span style="display:block;background-color: #ffc;">    specific.<span style="color: black;">do_it</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;NOW&quot;</span><span style="color: black;">&#41;</span></span></pre></td></tr></table></div>

<p>Et le résultat tant attendu :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">BEGIN Module<span style="color: #66cc66;">=</span><span style="color: #dc143c;">__main__</span> Class<span style="color: #66cc66;">=</span>Specific Function<span style="color: #66cc66;">=</span>do_it
BEGIN Module<span style="color: #66cc66;">=</span><span style="color: #dc143c;">__main__</span> Class<span style="color: #66cc66;">=</span>Specific Function<span style="color: #66cc66;">=</span>do_it
NOW
END Module<span style="color: #66cc66;">=</span><span style="color: #dc143c;">__main__</span> Class<span style="color: #66cc66;">=</span>Specific Function<span style="color: #66cc66;">=</span>do_it
END Module<span style="color: #66cc66;">=</span><span style="color: #dc143c;">__main__</span> Class<span style="color: #66cc66;">=</span>Specific Function<span style="color: #66cc66;">=</span>do_it</pre></td></tr></table></div>

<p>Et là c&#8217;est le drâme, on a perdu la classe <code>Generic</code> ! Mais analysons plutôt l&#8217;exécution :</p>
<ul>
<li>Appel de la méthode <code>Specific.do_it()</code> vu que l&#8217;objet <code>generic</code> est une instance de cette classe.</li>
<li>Appel de la méthode <code>Generic.do_it()</code> par le biais de l&#8217;instruction <code>super().do_it()</code></li>
</ul>
<p>Comme prévu, la classe de l&#8217;objet <code>self</code> ne change pas que l&#8217;on soit dans une méthode de la classe ou de l&#8217;une de ses super-classes.</p>
<p><strong>Quatrième étape : autre approche</strong></p>
<p>Ne pouvant déterminer directement la classe d&#8217;appartenance de la fonction, essayons de la chercher dans le module.<br />
Pour commencer il nous faut l&#8217;objet <code>module</code> alors que nous ne connaissons que son nom.<br />
Le module <a href="http://docs.python.org/3/library/inspect.html">inspect</a> propose justement ce service grâce à <a href="http://docs.python.org/3/library/inspect.html#inspect.getmodule">getmodule</a>.<br />
Voici le décorateur modifié :</p>
<p><code>logger.py</code> :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">inspect</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> log_decorator<span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #ff7700;font-weight:bold;">not</span> __DECO_ACTIVATED:
        <span style="color: #ff7700;font-weight:bold;">return</span> func
    module_name <span style="color: #66cc66;">=</span> func.__module__
<span style="display:block;background-color: #ffc;">    module_obj <span style="color: #66cc66;">=</span> <span style="color: #dc143c;">inspect</span>.<span style="color: black;">getmodule</span><span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span></span><span style="display:block;background-color: #ffc;">    class_name <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">&quot;UNKNOWN&quot;</span></span><span style="display:block;background-color: #ffc;">    <span style="color: #ff7700;font-weight:bold;">for</span> key<span style="color: #66cc66;">,</span> obj <span style="color: #ff7700;font-weight:bold;">in</span> module_obj.<span style="color: #0000cd;">__dict__</span>.<span style="color: black;">items</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:</span><span style="display:block;background-color: #ffc;">        <span style="color: #ff7700;font-weight:bold;">try</span>:</span><span style="display:block;background-color: #ffc;">            members <span style="color: #66cc66;">=</span> obj.<span style="color: #0000cd;">__dict__</span></span><span style="display:block;background-color: #ffc;">            method <span style="color: #66cc66;">=</span> members<span style="color: black;">&#91;</span>func.__name__<span style="color: black;">&#93;</span></span><span style="display:block;background-color: #ffc;">            <span style="color: #ff7700;font-weight:bold;">if</span> method <span style="color: #66cc66;">==</span> func:</span><span style="display:block;background-color: #ffc;">                class_name <span style="color: #66cc66;">=</span> key</span><span style="display:block;background-color: #ffc;">                <span style="color: #ff7700;font-weight:bold;">break</span></span><span style="display:block;background-color: #ffc;">        <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: black;">&#40;</span><span style="color: #008000;">KeyError</span><span style="color: #66cc66;">,</span> <span style="color: #008000;">AttributeError</span><span style="color: black;">&#41;</span>:</span><span style="display:block;background-color: #ffc;">            <span style="color: #ff7700;font-weight:bold;">pass</span></span>    func_name <span style="color: #66cc66;">=</span> func.__name__
&nbsp;
    <span style="color: #66cc66;">@</span>functools.<span style="color: black;">wraps</span><span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> wrapped<span style="color: black;">&#40;</span>*args<span style="color: #66cc66;">,</span> **kwargs<span style="color: black;">&#41;</span>:
        msg <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">&quot;Module={} Class={} Function={}&quot;</span>.<span style="color: black;">format</span><span style="color: black;">&#40;</span>
            module_name<span style="color: #66cc66;">,</span> class_name<span style="color: #66cc66;">,</span> func_name<span style="color: black;">&#41;</span>
        __logger.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;BEGIN &quot;</span> + msg<span style="color: black;">&#41;</span>
        data <span style="color: #66cc66;">=</span> func<span style="color: black;">&#40;</span>*args<span style="color: #66cc66;">,</span> **kwargs<span style="color: black;">&#41;</span>
        __logger.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;END &quot;</span> + msg<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> data
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">return</span> wrapped</pre></td></tr></table></div>

<p>Pour rechercher la fonction, le décorateur doit :</p>
<ul>
<li>Lister les objets du module.</li>
<li>Rechercher pour chaque objet le nom de la fonction dans les attributs de celui-ci. Si l&#8217;attribut correspond à notre fonction, c&#8217;est gagné !</li>
</ul>
<p>Nous obtenons alors :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">BEGIN Module<span style="color: #66cc66;">=</span><span style="color: #dc143c;">__main__</span> Class<span style="color: #66cc66;">=</span>UNKNOWN Function<span style="color: #66cc66;">=</span>do_it
BEGIN Module<span style="color: #66cc66;">=</span><span style="color: #dc143c;">__main__</span> Class<span style="color: #66cc66;">=</span>UNKNOWN Function<span style="color: #66cc66;">=</span>do_it
NOW
END Module<span style="color: #66cc66;">=</span><span style="color: #dc143c;">__main__</span> Class<span style="color: #66cc66;">=</span>UNKNOWN Function<span style="color: #66cc66;">=</span>do_it
END Module<span style="color: #66cc66;">=</span><span style="color: #dc143c;">__main__</span> Class<span style="color: #66cc66;">=</span>UNKNOWN Function<span style="color: #66cc66;">=</span>do_it</pre></td></tr></table></div>

<p>Pas glop ça marche pas !<br />
Regardons le contenu du module avant la recherche :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>module_obj.<span style="color: #0000cd;">__dict__</span>.<span style="color: black;">keys</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
dict_keys<span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #483d8b;">'__builtins__'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'__name__'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'__file__'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'__doc__'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'__loader__'</span><span style="color: #66cc66;">,</span>
           <span style="color: #483d8b;">'__cached__'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'logger'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'__package__'</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Curieusement les classes n&#8217;apparaissent pas, mais c&#8217;est tout à fait normal.<br />
Comme vu précédemment, lors de l&#8217;exécution du décorateur la classe est en instance de création.<br />
Il faut donc faire cette recherche lors de l&#8217;exécution de la fonction <em>wrappée</em>.</p>
<p>Le décorateur devient donc :</p>
<p><code>logger.py</code> :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> log_decorator<span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #ff7700;font-weight:bold;">not</span> __DECO_ACTIVATED:
        <span style="color: #ff7700;font-weight:bold;">return</span> func
    module_name <span style="color: #66cc66;">=</span> func.__module__
    module_obj <span style="color: #66cc66;">=</span> <span style="color: #dc143c;">inspect</span>.<span style="color: black;">getmodule</span><span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span>
    func_name <span style="color: #66cc66;">=</span> func.__name__
&nbsp;
    <span style="color: #66cc66;">@</span>functools.<span style="color: black;">wraps</span><span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> wrapped<span style="color: black;">&#40;</span>*args<span style="color: #66cc66;">,</span> **kwargs<span style="color: black;">&#41;</span>:
<span style="display:block;background-color: #ffc;">        class_name <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">&quot;UNKNOWN&quot;</span></span><span style="display:block;background-color: #ffc;">        <span style="color: #ff7700;font-weight:bold;">for</span> key<span style="color: #66cc66;">,</span> obj <span style="color: #ff7700;font-weight:bold;">in</span> module_obj.<span style="color: #0000cd;">__dict__</span>.<span style="color: black;">items</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:</span><span style="display:block;background-color: #ffc;">            <span style="color: #ff7700;font-weight:bold;">try</span>:</span><span style="display:block;background-color: #ffc;">                members <span style="color: #66cc66;">=</span> obj.<span style="color: #0000cd;">__dict__</span></span><span style="display:block;background-color: #ffc;">                method <span style="color: #66cc66;">=</span> members<span style="color: black;">&#91;</span>func.__name__<span style="color: black;">&#93;</span></span><span style="display:block;background-color: #ffc;">                <span style="color: #ff7700;font-weight:bold;">if</span> method <span style="color: #66cc66;">==</span> func:</span><span style="display:block;background-color: #ffc;">                    class_name <span style="color: #66cc66;">=</span> key</span><span style="display:block;background-color: #ffc;">                    <span style="color: #ff7700;font-weight:bold;">break</span></span><span style="display:block;background-color: #ffc;">            <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: black;">&#40;</span><span style="color: #008000;">KeyError</span><span style="color: #66cc66;">,</span> <span style="color: #008000;">AttributeError</span><span style="color: black;">&#41;</span>:</span><span style="display:block;background-color: #ffc;">                <span style="color: #ff7700;font-weight:bold;">pass</span></span><span style="display:block;background-color: #ffc;">        msg <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">&quot;Module={} Class={} Function={}&quot;</span>.<span style="color: black;">format</span><span style="color: black;">&#40;</span></span><span style="display:block;background-color: #ffc;">            module_name<span style="color: #66cc66;">,</span> class_name<span style="color: #66cc66;">,</span> func_name<span style="color: black;">&#41;</span></span>        __logger.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;BEGIN &quot;</span> + msg<span style="color: black;">&#41;</span>
        data <span style="color: #66cc66;">=</span> func<span style="color: black;">&#40;</span>*args<span style="color: #66cc66;">,</span> **kwargs<span style="color: black;">&#41;</span>
        __logger.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;END &quot;</span> + msg<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> data
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">return</span> wrapped</pre></td></tr></table></div>

<p>Et le résultat :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">BEGIN Module<span style="color: #66cc66;">=</span><span style="color: #dc143c;">__main__</span> Class<span style="color: #66cc66;">=</span>UNKNOWN Function<span style="color: #66cc66;">=</span>do_it
BEGIN Module<span style="color: #66cc66;">=</span><span style="color: #dc143c;">__main__</span> Class<span style="color: #66cc66;">=</span>UNKNOWN Function<span style="color: #66cc66;">=</span>do_it
NOW
END Module<span style="color: #66cc66;">=</span><span style="color: #dc143c;">__main__</span> Class<span style="color: #66cc66;">=</span>UNKNOWN Function<span style="color: #66cc66;">=</span>do_it
END Module<span style="color: #66cc66;">=</span><span style="color: #dc143c;">__main__</span> Class<span style="color: #66cc66;">=</span>UNKNOWN Function<span style="color: #66cc66;">=</span>do_it</pre></td></tr></table></div>

<p>Pas glop 2 le retour !<br />
Faisons appel au débogueur suprême : <code>print</code></p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">key    <span style="color: #66cc66;">=</span> Generic
method <span style="color: #66cc66;">=</span> <span style="color: #66cc66;">&lt;</span>function Generic.<span style="color: black;">do_it</span> at <span style="color: #ff4500;">0x00D07C90</span><span style="color: #66cc66;">&gt;</span>
func   <span style="color: #66cc66;">=</span> <span style="color: #66cc66;">&lt;</span>function Specific.<span style="color: black;">do_it</span> at <span style="color: #ff4500;">0x00D07CD8</span><span style="color: #66cc66;">&gt;</span>
&nbsp;
key    <span style="color: #66cc66;">=</span> Specific
method <span style="color: #66cc66;">=</span> <span style="color: #66cc66;">&lt;</span>function Specific.<span style="color: black;">do_it</span> at <span style="color: #ff4500;">0x00D07D20</span><span style="color: #66cc66;">&gt;</span>
func   <span style="color: #66cc66;">=</span> <span style="color: #66cc66;">&lt;</span>function Specific.<span style="color: black;">do_it</span> at <span style="color: #ff4500;">0x00D07CD8</span><span style="color: #66cc66;">&gt;</span></pre></td></tr></table></div>

<p>Effectivement les références ne correspondent pas, et encore une fois, rien de plus normal.<br />
La fonction d&#8217;origine a été <em>wrappée</em> donc celle présente dans le module n&#8217;est plus celle d&#8217;origine.<br />
Qu&#8217;à cela ne tienne, recherchons-là !</p>
<p>Après la déclaration de la fonction <code>wrapped</code>, le décorateur la mémorise dans la variable <code>wrapped_function</code>.<br />
Elle sera utilisée à l&#8217;exécution de la fonction.</p>
<p><code>logger.py</code> :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> log_decorator<span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #ff7700;font-weight:bold;">not</span> __DECO_ACTIVATED:
        <span style="color: #ff7700;font-weight:bold;">return</span> func
    module_name <span style="color: #66cc66;">=</span> func.__module__
    module_obj <span style="color: #66cc66;">=</span> <span style="color: #dc143c;">inspect</span>.<span style="color: black;">getmodule</span><span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span>
    func_name <span style="color: #66cc66;">=</span> func.__name__
&nbsp;
    <span style="color: #66cc66;">@</span>functools.<span style="color: black;">wraps</span><span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> wrapped<span style="color: black;">&#40;</span>*args<span style="color: #66cc66;">,</span> **kwargs<span style="color: black;">&#41;</span>:
        class_name <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">&quot;UNKNOWN&quot;</span>
        <span style="color: #ff7700;font-weight:bold;">for</span> key<span style="color: #66cc66;">,</span> obj <span style="color: #ff7700;font-weight:bold;">in</span> module_obj.<span style="color: #0000cd;">__dict__</span>.<span style="color: black;">items</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
            <span style="color: #ff7700;font-weight:bold;">try</span>:
                members <span style="color: #66cc66;">=</span> obj.<span style="color: #0000cd;">__dict__</span>
                method <span style="color: #66cc66;">=</span> members<span style="color: black;">&#91;</span>func.__name__<span style="color: black;">&#93;</span>
<span style="display:block;background-color: #ffc;">                <span style="color: #ff7700;font-weight:bold;">if</span> method <span style="color: #66cc66;">==</span> wrapped_function:</span>                    class_name <span style="color: #66cc66;">=</span> key
                    <span style="color: #ff7700;font-weight:bold;">break</span>
            <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: black;">&#40;</span><span style="color: #008000;">KeyError</span><span style="color: #66cc66;">,</span> <span style="color: #008000;">AttributeError</span><span style="color: black;">&#41;</span>:
                <span style="color: #ff7700;font-weight:bold;">pass</span>
        msg <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">&quot;Module={} Class={} Function={}&quot;</span>.<span style="color: black;">format</span><span style="color: black;">&#40;</span>
            module_name<span style="color: #66cc66;">,</span> class_name<span style="color: #66cc66;">,</span> func_name<span style="color: black;">&#41;</span>
        __logger.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;BEGIN &quot;</span> + msg<span style="color: black;">&#41;</span>
        data <span style="color: #66cc66;">=</span> func<span style="color: black;">&#40;</span>*args<span style="color: #66cc66;">,</span> **kwargs<span style="color: black;">&#41;</span>
        __logger.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;END &quot;</span> + msg<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> data
&nbsp;
<span style="display:block;background-color: #ffc;">    wrapped_function <span style="color: #66cc66;">=</span> wrapped</span>    <span style="color: #ff7700;font-weight:bold;">return</span> wrapped</pre></td></tr></table></div>

<p>Et maintenant le résultat :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">BEGIN Module<span style="color: #66cc66;">=</span><span style="color: #dc143c;">__main__</span> Class<span style="color: #66cc66;">=</span>Specific Function<span style="color: #66cc66;">=</span>do_it
BEGIN Module<span style="color: #66cc66;">=</span><span style="color: #dc143c;">__main__</span> Class<span style="color: #66cc66;">=</span>Generic Function<span style="color: #66cc66;">=</span>do_it
NOW
END Module<span style="color: #66cc66;">=</span><span style="color: #dc143c;">__main__</span> Class<span style="color: #66cc66;">=</span>Generic Function<span style="color: #66cc66;">=</span>do_it
END Module<span style="color: #66cc66;">=</span><span style="color: #dc143c;">__main__</span> Class<span style="color: #66cc66;">=</span>Specific Function<span style="color: #66cc66;">=</span>do_it</pre></td></tr></table></div>

<p>Ouf ! Ca marche !</p>
<p>Au menu du prochain épisode : logger la valeur de certains paramètres passés à la fonction décorée.</p>
<p><em>Xavier O. avec l&#8217;aide précieuse de Laurent B.</em></p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/decorateur-de-trace/feed/</wfw:commentRss>
		<slash:comments>14</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2013/04/4Y6lBye.jpg" length="47403" type="image/jpg" />	</item>
	</channel>
</rss>
