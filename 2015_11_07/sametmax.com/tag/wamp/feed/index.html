<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Sam &#38; Max &#187; wamp</title>
	<atom:link href="http://sametmax.com/tag/wamp/feed/" rel="self" type="application/rss+xml" />
	<link>http://sametmax.com</link>
	<description>Du code, du cul</description>
	<lastBuildDate>Sat, 07 Nov 2015 10:56:13 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>http://wordpress.org/?v=4.1</generator>
	<item>
		<title>Jouons un peu avec Python 3.5 27</title>
		<link>http://sametmax.com/jouons-un-peu-avec-python-3-5/</link>
		<comments>http://sametmax.com/jouons-un-peu-avec-python-3-5/#comments</comments>
		<pubDate>Wed, 16 Sep 2015 16:31:38 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[async]]></category>
		<category><![CDATA[asyncio]]></category>
		<category><![CDATA[numpy]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[wamp]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=16918</guid>
		<description><![CDATA[Zeste de savoir a fait un <a href="http://zestedesavoir.com/articles/264/sortie-de-python-35/">fantastique article</a> présentant Python 3.5, je ne vais donc pas pas répéter inutilement ce qu’ils ont dit. Le but de ce post est plutôt de faire mumuse avec le nouveau joujou.]]></description>
				<content:encoded><![CDATA[<p>Zeste de savoir a fait un <a href="http://zestedesavoir.com/articles/264/sortie-de-python-35/">fantastique article</a> présentant Python 3.5, je ne vais donc pas répéter inutilement ce qu’ils ont dit. Le but de ce post est plutôt de faire mumuse avec le nouveau joujou.</p>
<p>La release est récente, mais fort heureusement on peut facilement l’installer. Sous Windows et Mac, il y a des <a href="https://www.python.org/downloads/release/python-350/">builds</a> tout chauds.</p>
<p>Pour linux, en attendant un repo tierce partie ou l’upgrade du système, on peut l’installer quelques commandes depuis les sources. Par exemple pour les distros basées sur Debian comme Ubuntu, ça ressemble à :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">$ <span style="color: #666666; font-style: italic;"># dependances pour compiler python</span>
$ <span style="color: #c20cb9; font-weight: bold;">sudo</span> <span style="color: #c20cb9; font-weight: bold;">apt-get install</span> build-essential libreadline-dev tk8.4-dev libsqlite3-dev libgdbm-dev libreadline6-dev liblzma-dev libbz2-dev libncurses5-dev libssl-dev python3-dev tk-dev
$ <span style="color: #c20cb9; font-weight: bold;">sudo</span> <span style="color: #c20cb9; font-weight: bold;">apt-get build-dep</span> python3 <span style="color: #666666; font-style: italic;"># juste pour etre sur :)</span>
&nbsp;
$ <span style="color: #666666; font-style: italic;"># téléchargement des sources</span>
$ <span style="color: #7a0874; font-weight: bold;">cd</span> <span style="color: #000000; font-weight: bold;">/</span>tmp
$ <span style="color: #c20cb9; font-weight: bold;">wget</span> https:<span style="color: #000000; font-weight: bold;">//</span>www.python.org<span style="color: #000000; font-weight: bold;">/</span>ftp<span style="color: #000000; font-weight: bold;">/</span>python<span style="color: #000000; font-weight: bold;">/</span>3.5.0<span style="color: #000000; font-weight: bold;">/</span>Python-3.5.0.tar.xz
$ <span style="color: #c20cb9; font-weight: bold;">tar</span> <span style="color: #660033;">-xvf</span> Python-3.5.0.tar.xz
$ <span style="color: #7a0874; font-weight: bold;">cd</span> Python-3.5.0
&nbsp;
$ <span style="color: #666666; font-style: italic;"># et on build</span>
$ .<span style="color: #000000; font-weight: bold;">/</span>configure
$ <span style="color: #c20cb9; font-weight: bold;">make</span>
$ <span style="color: #c20cb9; font-weight: bold;">sudo</span> <span style="color: #c20cb9; font-weight: bold;">make</span> altinstall 
<span style="color: #666666; font-style: italic;"># pas 'make install' qui écrase le python du système !</span>
&nbsp;
$ python3.5 <span style="color: #666666; font-style: italic;"># ahhhhhh</span>
Python 3.5.0 <span style="color: #7a0874; font-weight: bold;">&#40;</span>default, Sep <span style="color: #000000;">16</span> <span style="color: #000000;">2015</span>, <span style="color: #000000;">10</span>:<span style="color: #000000;">44</span>:<span style="color: #000000;">14</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> 
<span style="color: #7a0874; font-weight: bold;">&#91;</span>GCC 4.9.2<span style="color: #7a0874; font-weight: bold;">&#93;</span> on linux
Type <span style="color: #ff0000;">&quot;help&quot;</span>, <span style="color: #ff0000;">&quot;copyright&quot;</span>, <span style="color: #ff0000;">&quot;credits&quot;</span> or <span style="color: #ff0000;">&quot;license&quot;</span> <span style="color: #000000; font-weight: bold;">for</span> <span style="color: #c20cb9; font-weight: bold;">more</span> information.
<span style="color: #000000; font-weight: bold;">&gt;&gt;&gt;</span></pre></td></tr></table></div>

<p>Sur les centos-likes, c’est grosso merdo la même chose, sans le build-dep (mais plutôt un truc genre <code>sudo yum groupinstall 'Development Tools'</code>), et en remplaçant les <code>-dev</code> par <code>-devel</code>.</p>
<p><span class='embed-youtube' style='text-align:center; display: block;'><iframe class='youtube-player' type='text/html' width='1170' height='689' src='http://www.youtube.com/embed/TsgQdzzXEnY?version=3&#038;rel=1&#038;fs=1&#038;showsearch=0&#038;showinfo=1&#038;iv_load_policy=1&#038;wmode=transparent' frameborder='0' allowfullscreen='true'></iframe></span></p>
<h2>Nouvel opérateur</h2>
<p><code>@</code> est maintenant le nouvel opérateur de produit matriciel, mais il ne fait officiellement rien.</p>
<p>Comprenez par là que Python implémente l’opérateur, mais pas le produit en lui-même, la feature ayant été spécialement incluse pour faire plaisir aux utilisateurs de libs scientifiques type numpy.</p>
<p>On va donc tester ça sur le terrain. On se fait un petit env temporaire avec <a href="http://sametmax.com/mieux-que-python-virtualenvwrapper-pew/">pew</a> et on s’installe numpy :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">pew mktmpenv <span style="color: #660033;">-p</span> python3.5
pip <span style="color: #c20cb9; font-weight: bold;">install</span> pip setuptools <span style="color: #660033;">--upgrade</span>
pip <span style="color: #c20cb9; font-weight: bold;">install</span> numpy 
<span style="color: #666666; font-style: italic;"># encore un peu de compilation</span></pre></td></tr></table></div>

<p>Testons mon bon. L’ancienne manière de faire :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> a <span style="color: #66cc66;">=</span> np.<span style="color: #dc143c;">array</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">0</span><span style="color: black;">&#93;</span><span style="color: #66cc66;">,</span> <span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: black;">&#93;</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> b <span style="color: #66cc66;">=</span> np.<span style="color: #dc143c;">array</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">4</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: black;">&#93;</span><span style="color: #66cc66;">,</span> <span style="color: black;">&#91;</span><span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> np.<span style="color: black;">dot</span><span style="color: black;">&#40;</span>a<span style="color: #66cc66;">,</span> b<span style="color: black;">&#41;</span>
<span style="color: #dc143c;">array</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">4</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: black;">&#93;</span><span style="color: #66cc66;">,</span>
       <span style="color: black;">&#91;</span><span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Et la nouvelle :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> a <span style="color: #66cc66;">@</span> b
---------------------------------------------------------------------------
<span style="color: #008000;">TypeError</span>                                 Traceback <span style="color: black;">&#40;</span>most recent call last<span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&lt;</span>ipython-input-<span style="color: #ff4500;">10</span>-3d41f06f59bb<span style="color: #66cc66;">&gt;</span> <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #66cc66;">&lt;</span>module<span style="color: #66cc66;">&gt;</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
----<span style="color: #66cc66;">&gt;</span> <span style="color: #ff4500;">1</span> a <span style="color: #66cc66;">@</span> b
&nbsp;
<span style="color: #008000;">TypeError</span>: unsupported operand <span style="color: #008000;">type</span><span style="color: black;">&#40;</span>s<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> <span style="color: #66cc66;">@</span>: <span style="color: #483d8b;">'numpy.ndarray'</span> <span style="color: #ff7700;font-weight:bold;">and</span> <span style="color: #483d8b;">'numpy.ndarray'</span></pre></td></tr></table></div>

<p>Woops, apparemment numpy n’a pas encore implémenté le truc.</p>
<p>Bon. Bon, bon, bon. Comment on va tester alors&#8230; Ah, oui, y a une magic method :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">class</span> Array<span style="color: black;">&#40;</span>np.<span style="color: black;">ndarray</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">def</span> __matmul__<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> other<span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">return</span> np.<span style="color: black;">dot</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> other<span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #66cc66;">&gt;&gt;&gt;</span> a <span style="color: #66cc66;">=</span> a.<span style="color: black;">view</span><span style="color: black;">&#40;</span>Array<span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> b <span style="color: #66cc66;">=</span> b.<span style="color: black;">view</span><span style="color: black;">&#40;</span>Array<span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> a <span style="color: #66cc66;">@</span> b
Array<span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">4</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: black;">&#93;</span><span style="color: #66cc66;">,</span>
       <span style="color: black;">&#91;</span><span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Bon, voilà ce que ça donnera quand les devs de numpy auront implémenté le bouzin (la dernière ligne hein, pas tout le bordel avant). </p>
<p>Apparemment ça fait bander les matheux, donc je suppose que c’est une super nouvelle.</p>
<h2>% is back on bytes</h2>
<p>En python 2, on pouvait faire <code>"truc %s" % "bidule"</code> et <code>u"truc %s" % u"bidule"</code> et <code>b"truc %s" % u"bidule"</code> et ça a été viré en python 3 qui ne garde <code>%</code> que pour <code>str</code> et pas pour <code>bytes</code>.</p>
<p>Ca n’aurait pas été un problème si ce n’est que Python est très utilisé pour le réseau, et que construire un paquet qui mélange de la sémantique binaire et textuelle devient soudainement une grosse soupe de <code>decode()</code> et <code>encode()</code>.</p>
<p>Jour 1, test 3, suspense&#8230;</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #dc143c;">bytearray</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">66</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">108</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">117</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">101</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">32</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">112</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">114</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">105</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">101</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">115</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">116</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">32</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">115</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">97</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">121</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">115</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">58</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">32</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">37</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">115</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span> % b<span style="color: #483d8b;">&quot;wololo&quot;</span>
<span style="color: #dc143c;">bytearray</span><span style="color: black;">&#40;</span>b<span style="color: #483d8b;">'Blue priest says: wololo'</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Voilà ça c’est fait !</p>
<h2>os.scandir()</h2>
<p><code>os.path.walk()</code> est dans mon top 10 des APIs que je déteste le plus en Python, juste à côté de la gestion timezone. Avoir <code>os.walk()</code> en Python 3 qui retourne un générateur me ravit. Avoir une version 10 X plus rapide avec <code>scandir</code>, n’est-ce pas choupinet ?</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">os</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">list</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">os</span>.<span style="color: black;">scandir</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'/tmp/'</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
                       <span style="color: black;">&#91;</span><span style="color: #66cc66;">&lt;</span>DirEntry <span style="color: #483d8b;">'systemd-private-316509818ceb41488a4721c78dabb603-colord.service-eXUfPo'</span><span style="color: #66cc66;">&gt;,</span>
 <span style="color: #66cc66;">&lt;</span>DirEntry <span style="color: #483d8b;">'unity_support_test.0'</span><span style="color: #66cc66;">&gt;,</span>
 <span style="color: #66cc66;">&lt;</span>DirEntry <span style="color: #483d8b;">'config-err-7UpWeO'</span><span style="color: #66cc66;">&gt;,</span>
 <span style="color: #66cc66;">&lt;</span>DirEntry <span style="color: #483d8b;">'.ICE-unix'</span><span style="color: #66cc66;">&gt;,</span>
 <span style="color: #66cc66;">&lt;</span>DirEntry <span style="color: #483d8b;">'pip-rw_63q0_-unpack'</span><span style="color: #66cc66;">&gt;,</span>
 <span style="color: #66cc66;">&lt;</span>DirEntry <span style="color: #483d8b;">'systemd-private-316509818ceb41488a4721c78dabb603-systemd-timesyncd.service-eZumpq'</span><span style="color: #66cc66;">&gt;</span><span style="color: black;">&#93;</span></pre></td></tr></table></div>

<p>C’est très dommage que ça ne retourne pas des objets <code>Path</code> de <code>pathlib</code>, mais bon, les perfs, tout ça&#8230;</p>
<h2>Zipapp, le grand inaperçu</h2>
<p>Le saviez-vous ? Python peut exécuter un zip, ce qui permet de créer un script en plusieurs fichiers et de le partager comme un seul fichier. Non vous ne le saviez-vous-te-pas car personne n’en parle jamais. </p>
<p>La 3.5 vient avec un outil en ligne de commande pour faciliter la création de tels zip et une nouvelle extension (que l’installeur fera reconnaitre à Windows) pour cesdits fichiers : .pyz.</p>
<p>Je fais mon script :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">foo
├── bar.py
├── __init__.py
└── __main__.py</pre></td></tr></table></div>

<p>__main__.py est obligatoire, c’est ce qui sera lancé quand on exécutera notre script. Dedans je mets <code>import bar</code> et dans bar <code>print('wololo again')</code>.</p>
<p>Ensuite je fusionne tout ça :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">python <span style="color: #660033;">-m</span> zipapp foo</pre></td></tr></table></div>

<p>Et pouf, j’ai mon fichier foo.pyz :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">$ python3.5  foo.pyz
wololo again</pre></td></tr></table></div>

<p>Attention aux imports dedans, ils sont assez chiants à gérer.</p>
<h2>L’unpacking généralisé</h2>
<p>J’adore cette feature. J’adore toutes les features de la 3.5. Cette release est fantastique. Depuis la 3.3 chaque release est fantastique.</p>
<p>Mais bon, zeste de savoir l’a traité en long et en large donc rien à dire de plus, si ce n’est que j’avais raté un GROS truc :</p>
<ul>
<li>On peut faire de l’unpacking sur n’importe quel itérable.</li>
<li>On peut faire de l’unpacking dans les tuples.</li>
<li>Les parenthèses des tuples sont facultatives.</li>
</ul>
<p>Donc ces syntaxes sont valides :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> *<span style="color: #008000;">range</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span> *<span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">3</span><span style="color: black;">&#93;</span><span style="color: #66cc66;">,</span> *<span style="color: #483d8b;">'ea'</span>
<span style="color: black;">&#40;</span><span style="color: #ff4500;">0</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">3</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'e'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'a'</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> *<span style="color: black;">&#91;</span>x * x <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">range</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span><span style="color: black;">&#93;</span><span style="color: #66cc66;">,</span> *<span style="color: black;">&#123;</span><span style="color: #483d8b;">&quot;a&quot;</span>: <span style="color: #ff4500;">1</span><span style="color: black;">&#125;</span>.<span style="color: black;">values</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: black;">&#40;</span><span style="color: #ff4500;">0</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">4</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Ce qui peut être très chouette et aussi la porte ouverte à l’implémentation d’un sous-ensemble de Perl en Python. C’est selon l’abruti qui code.</p>
<h2>Type hints</h2>
<p>Ce qu’il faut bien comprendre avec les types hints, c’est que Python ne s’en sert pas. Il n’en fait rien. Que dalle. Nada. Peau de balle. Zob. Niet. Zero. La bulle. Néant. Null. None. Réforme gouvernementale.</p>
<p>Les types hints sont disponibles, mais Python ne va pas les traiter différemment d’autres annotations. Le but est de permettre à des outils externes (linter, IDE, etc) de se baser sur ces informations pour ajouter des fonctionnalités.</p>
<p>Pour l’instant, un seul le fait : <a href="http://mypy.readthedocs.org">mypy</a>.</p>
<p>Et là on sent bien que tout ça est tout neuf car si on fait <code>pip install mypy-lang</code>, on tombe sur une version buggée. Il faut donc l’installer directement depuis le repo, soit :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">pip install https://github.<span style="color: black;">com</span>/JukkaL/mypy/archive/master.<span style="color: #008000;">zip</span></pre></td></tr></table></div>

<p>Puis écriture d’une fonction annotée avec des types hints :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">&nbsp;
<span style="color: #ff7700;font-weight:bold;">from</span> typing <span style="color: #ff7700;font-weight:bold;">import</span> Iterable<span style="color: #66cc66;">,</span> Tuple
&nbsp;
PixelArray <span style="color: #66cc66;">=</span> Iterable<span style="color: black;">&#91;</span>Tuple<span style="color: black;">&#91;</span><span style="color: #008000;">int</span><span style="color: #66cc66;">,</span> <span style="color: #008000;">int</span><span style="color: #66cc66;">,</span> <span style="color: #008000;">int</span><span style="color: black;">&#93;</span><span style="color: black;">&#93;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> rgb2hex<span style="color: black;">&#40;</span>pixels: PixelArray<span style="color: black;">&#41;</span> -<span style="color: #66cc66;">&gt;</span> <span style="color: #008000;">list</span>:
    pattern <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">&quot;#{0:02x}{1:02x}{2:02x}&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: black;">&#91;</span>pattern.<span style="color: black;">format</span><span style="color: black;">&#40;</span>r<span style="color: #66cc66;">,</span> g<span style="color: #66cc66;">,</span> b<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> r<span style="color: #66cc66;">,</span> g<span style="color: #66cc66;">,</span> b <span style="color: #ff7700;font-weight:bold;">in</span> pixels<span style="color: black;">&#93;</span>
&nbsp;
&nbsp;
<span style="color: #808080; font-style: italic;"># ça marche :</span>
rgb2hex<span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
<span style="color: #808080; font-style: italic;"># ['#010203', '#010203']</span></pre></td></tr></table></div>

<p>La preuve que Python n’en fait rien :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">hex</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;fjdkls&quot;</span><span style="color: black;">&#41;</span>
---------------------------------------------------------------------------
<span style="color: #008000;">TypeError</span>                                 Traceback <span style="color: black;">&#40;</span>most recent call last<span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&lt;</span>ipython-input-<span style="color: #ff4500;">2</span>-be62b8f062fe<span style="color: #66cc66;">&gt;</span> <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #66cc66;">&lt;</span>module<span style="color: #66cc66;">&gt;</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
----<span style="color: #66cc66;">&gt;</span> <span style="color: #ff4500;">1</span> <span style="color: #008000;">hex</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;fjdkls&quot;</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #008000;">TypeError</span>: <span style="color: #483d8b;">'str'</span> <span style="color: #008000;">object</span> cannot be interpreted <span style="color: #ff7700;font-weight:bold;">as</span> an integer</pre></td></tr></table></div>

<p>Même la doc profite peu du typage :</p>
<pre>Help on function rgb2hex in module __main__:

rgb2hex(pixels:typing.Iterable) -> list
</pre>
<p>Mais si on met ça dans un fichier foo.py :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">from</span> essai <span style="color: #ff7700;font-weight:bold;">import</span> rgb2hex
&nbsp;
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>rgb2hex<span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;fdjksl&quot;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
res <span style="color: #66cc66;">=</span> rgb2hex<span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: black;">&#40;</span><span style="color: #ff4500;">3</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">4</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">5</span><span style="color: black;">&#41;</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>res + <span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Et qu&#8217;on le passe à la moulinette :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">$ mypy foo.<span style="color: black;">py</span> 
foo.<span style="color: black;">py</span>:<span style="color: #ff4500;">3</span>: error: Argument <span style="color: #ff4500;">1</span> to <span style="color: #483d8b;">&quot;rgb2hex&quot;</span> has incompatible <span style="color: #008000;">type</span> <span style="color: #483d8b;">&quot;str&quot;</span><span style="color: #66cc66;">;</span> expected Iterable<span style="color: black;">&#91;</span>...<span style="color: black;">&#93;</span>
foo.<span style="color: black;">py</span>:<span style="color: #ff4500;">5</span>: error: Unsupported operand <span style="color: #dc143c;">types</span> <span style="color: #ff7700;font-weight:bold;">for</span> + <span style="color: black;">&#40;</span>List<span style="color: black;">&#91;</span>Any<span style="color: black;">&#93;</span> <span style="color: #ff7700;font-weight:bold;">and</span> <span style="color: #483d8b;">&quot;int&quot;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Ensuite j’ai essayé de créer un stub file, c’est-à-dire de mettre les hints dans un fichier à part plutôt que directement dans le code. Ma fonction redevient :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> rgb2hex<span style="color: black;">&#40;</span>pixels<span style="color: black;">&#41;</span>:
    pattern <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">&quot;#{0:02x}{1:02x}{2:02x}&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: black;">&#91;</span>pattern.<span style="color: black;">format</span><span style="color: black;">&#40;</span>r<span style="color: #66cc66;">,</span> g<span style="color: #66cc66;">,</span> b<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> r<span style="color: #66cc66;">,</span> g<span style="color: #66cc66;">,</span> b <span style="color: #ff7700;font-weight:bold;">in</span> pixels<span style="color: black;">&#93;</span></pre></td></tr></table></div>

<p>Et mon fichier stub (même nom, mais avec extension .pyi) contient :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">from</span> typing <span style="color: #ff7700;font-weight:bold;">import</span> Iterable<span style="color: #66cc66;">,</span> Tuple
&nbsp;
PixelArray <span style="color: #66cc66;">=</span> Iterable<span style="color: black;">&#91;</span>Tuple<span style="color: black;">&#91;</span><span style="color: #008000;">int</span><span style="color: #66cc66;">,</span> <span style="color: #008000;">int</span><span style="color: #66cc66;">,</span> <span style="color: #008000;">int</span><span style="color: black;">&#93;</span><span style="color: black;">&#93;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> rgb2hex<span style="color: black;">&#40;</span>pixels: PixelArray<span style="color: black;">&#41;</span> -<span style="color: #66cc66;">&gt;</span> <span style="color: #008000;">list</span>:...</pre></td></tr></table></div>

<p>Les stubs sont donc bien des fichiers Python valides, mais avec une extension différente, et juste les signatures des fonctions (le corps du bloc est une <code>Ellipsis</code>).</p>
<p>Et poof, ça marche pareil :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">$ mypy foo.<span style="color: black;">py</span> 
foo.<span style="color: black;">py</span>:<span style="color: #ff4500;">3</span>: error: Argument <span style="color: #ff4500;">1</span> to <span style="color: #483d8b;">&quot;rgb2hex&quot;</span> has incompatible <span style="color: #008000;">type</span> <span style="color: #483d8b;">&quot;str&quot;</span><span style="color: #66cc66;">;</span> expected Iterable<span style="color: black;">&#91;</span>...<span style="color: black;">&#93;</span>
foo.<span style="color: black;">py</span>:<span style="color: #ff4500;">5</span>: error: Unsupported operand <span style="color: #dc143c;">types</span> <span style="color: #ff7700;font-weight:bold;">for</span> + <span style="color: black;">&#40;</span>List<span style="color: black;">&#91;</span>Any<span style="color: black;">&#93;</span> <span style="color: #ff7700;font-weight:bold;">and</span> <span style="color: #483d8b;">&quot;int&quot;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Il y a <a href="https://github.com/python/typeshed/tree/master/3">un repo</a> qui contient des fichiers stubs pour la stdlib. Vous pouvez y participer, c’est un moyen simple de contribuer à Python.</p>
<p>Bref, pour le moment ça demande encore un peu de maturité, mais je pense que d’ici quelques mois on aura des outils bien rodés pour faire tout ça automatiquement.</p>
<h2>Async/await</h2>
<p>La feature pub. Techniquement le truc qui a fait dire à tous ceux qui voulaient de l’asyncrone que Python en fait, c’était trop cool. Sauf que Python pouvait faire ça avec <code>yield from</code> avant, mais c’est sur que c’était super confusionant.</p>
<p>Maintenant on a un truc propre : pas de décorateur <code>@coroutine</code>, pas de syntaxe semblable aux générateurs, mais des méthodes magiques comme <code>__await__</code>  et de jolis mots-clés <code>async</code> et <code>await</code>.</p>
<p>Vu que Crossbar est maintenant compatible Python 3, et qu’il supporte asyncio pour les clients&#8230; Si on s’implémentait un petit wrapper WAMP pour s’amuser à voir ce que ressemblerait une API moderne pour du Websocket en Python ?</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">pip <span style="color: #c20cb9; font-weight: bold;">install</span> crossbar
crossbar init
crossbar start</pre></td></tr></table></div>

<p>(Ouhhhh, plein de zolies couleurs apparaissent dans ma console ! Ils ont fait des efforts cosmétiques chez Tavendo)</p>
<p>Bien, voici maintenant l’exemple d’un client WAMP de base codé avec asyncio selon l’ancienne API :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> asyncio
<span style="color: #ff7700;font-weight:bold;">from</span> autobahn.<span style="color: black;">asyncio</span>.<span style="color: black;">wamp</span> <span style="color: #ff7700;font-weight:bold;">import</span> ApplicationSession<span style="color: #66cc66;">,</span> ApplicationRunner
&nbsp;
<span style="color: #ff7700;font-weight:bold;">class</span> MyComponent<span style="color: black;">&#40;</span>ApplicationSession<span style="color: black;">&#41;</span>:
&nbsp;
    <span style="color: #66cc66;">@</span>asyncio.<span style="color: black;">coroutine</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> onJoin<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> details<span style="color: black;">&#41;</span>:
&nbsp;
        <span style="color: #808080; font-style: italic;"># on marque cette fonction comme appelable</span>
        <span style="color: #808080; font-style: italic;"># a distance en RPC</span>
        <span style="color: #ff7700;font-weight:bold;">def</span> add<span style="color: black;">&#40;</span>a<span style="color: #66cc66;">,</span> b<span style="color: black;">&#41;</span>:
            <span style="color: #ff7700;font-weight:bold;">return</span> a + b
        <span style="color: #008000;">self</span>.<span style="color: black;">register</span><span style="color: black;">&#40;</span>add<span style="color: #66cc66;">,</span> <span style="color: #483d8b;">&quot;add&quot;</span><span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># et on triche en l'appelant cash. J'ai</span>
        <span style="color: #808080; font-style: italic;"># la flemme de coder un deuxième client</span>
        <span style="color: #808080; font-style: italic;"># et ça passe quand même par le routeur</span>
        <span style="color: #808080; font-style: italic;"># donc merde</span>
        res <span style="color: #66cc66;">=</span> <span style="color: #ff7700;font-weight:bold;">yield</span> <span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #008000;">self</span>.<span style="color: black;">call</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;add&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Got result: {}&quot;</span>.<span style="color: black;">format</span><span style="color: black;">&#40;</span>res<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
&nbsp;
<span style="color: #ff7700;font-weight:bold;">if</span> __name__ <span style="color: #66cc66;">==</span> <span style="color: #483d8b;">'__main__'</span>:
    runner <span style="color: #66cc66;">=</span> ApplicationRunner<span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;ws://127.0.0.1:8080/ws&quot;</span><span style="color: #66cc66;">,</span>
        u<span style="color: #483d8b;">&quot;crossbardemo&quot;</span><span style="color: #66cc66;">,</span>
        debug_wamp<span style="color: #66cc66;">=</span><span style="color: #008000;">False</span><span style="color: #66cc66;">,</span>  <span style="color: #808080; font-style: italic;"># optional; log many WAMP details</span>
        debug<span style="color: #66cc66;">=</span><span style="color: #008000;">False</span><span style="color: #66cc66;">,</span>  <span style="color: #808080; font-style: italic;"># optional; log even more details</span>
    <span style="color: black;">&#41;</span>
    runner.<span style="color: black;">run</span><span style="color: black;">&#40;</span>MyComponent<span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Et ça marche nickel en 3.5. Mais qu’est-ce que c’est moche ! </p>
<p>On est <a href="https://github.com/tavendo/AutobahnPython/issues/472">en train de bosser</a> sur l’amélioration de l’API, mais je pense que ça va reste plus bas niveau que je le voudrais. </p>
<p>Donc, amusons-nous un peu à coder un truc plus sexy. Je vous préviens, le code du wrapper est velu, j’avais envie de me marrer un peu après les exemples ballots plus haut :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> asyncio
<span style="color: #ff7700;font-weight:bold;">from</span> autobahn.<span style="color: black;">asyncio</span>.<span style="color: black;">wamp</span> <span style="color: #ff7700;font-weight:bold;">import</span> ApplicationSession<span style="color: #66cc66;">,</span> ApplicationRunner
&nbsp;
<span style="color: #ff7700;font-weight:bold;">class</span> App:
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__init__</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> *args<span style="color: #66cc66;">,</span> **kwargs<span style="color: black;">&#41;</span>:
        <span style="color: #008000;">super</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>.<span style="color: #0000cd;">__init__</span><span style="color: black;">&#40;</span>*args<span style="color: #66cc66;">,</span> **kwargs<span style="color: black;">&#41;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">procedures</span> <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span><span style="color: black;">&#93;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">subscriptions</span> <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span><span style="color: black;">&#93;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">event_handlers</span>  <span style="color: #66cc66;">=</span> <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> run<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> url<span style="color: #66cc66;">=</span><span style="color: #483d8b;">&quot;ws://127.0.0.1:8080/ws&quot;</span><span style="color: #66cc66;">,</span>
                realm<span style="color: #66cc66;">=</span><span style="color: #483d8b;">&quot;realm1&quot;</span><span style="color: #66cc66;">,</span> debug_wamp<span style="color: #66cc66;">=</span><span style="color: #008000;">False</span><span style="color: #66cc66;">,</span> debug<span style="color: #66cc66;">=</span><span style="color: #008000;">False</span><span style="color: black;">&#41;</span>:
        runner <span style="color: #66cc66;">=</span> ApplicationRunner<span style="color: black;">&#40;</span>url<span style="color: #66cc66;">,</span> realm<span style="color: #66cc66;">,</span>
                                                     debug_wamp<span style="color: #66cc66;">=</span>debug_wamp<span style="color: #66cc66;">,</span>
                                                     debug<span style="color: #66cc66;">=</span>debug<span style="color: black;">&#41;</span>
        runner.<span style="color: black;">run</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> run_cmd<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> *args<span style="color: #66cc66;">,</span> **kwargs<span style="color: black;">&#41;</span>:
        <span style="color: #808080; font-style: italic;"># et on pourrait même ici mettre du parsing d'argument</span>
        <span style="color: #808080; font-style: italic;"># et de os.environ, mais j'ai la flemme</span>
        <span style="color: #ff7700;font-weight:bold;">if</span> __name__ <span style="color: #66cc66;">==</span> <span style="color: #483d8b;">'__main__'</span>:
            <span style="color: #008000;">self</span>.<span style="color: black;">run</span><span style="color: black;">&#40;</span>*args<span style="color: #66cc66;">,</span> **kwargs<span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># quelques décorateurs pour faire du déclaratif</span>
    <span style="color: #808080; font-style: italic;"># et remettre les paramètres dans le bon ordre</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> register<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> name<span style="color: #66cc66;">,</span> *args<span style="color: #66cc66;">,</span> **kwargs<span style="color: black;">&#41;</span>:
            <span style="color: #ff7700;font-weight:bold;">def</span> wrapper<span style="color: black;">&#40;</span>proc<span style="color: black;">&#41;</span>:
                <span style="color: #008000;">self</span>.<span style="color: black;">procedures</span>.<span style="color: black;">append</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span>name<span style="color: #66cc66;">,</span> proc<span style="color: #66cc66;">,</span> args<span style="color: #66cc66;">,</span> kwargs<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
                <span style="color: #ff7700;font-weight:bold;">return</span> proc
            <span style="color: #ff7700;font-weight:bold;">return</span> wrapper
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> subscribe<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> topic<span style="color: #66cc66;">,</span> *args<span style="color: #66cc66;">,</span> **kwargs<span style="color: black;">&#41;</span>:
            <span style="color: #ff7700;font-weight:bold;">def</span> wrapper<span style="color: black;">&#40;</span>callback<span style="color: black;">&#41;</span>:
                <span style="color: #008000;">self</span>.<span style="color: black;">procedures</span>.<span style="color: black;">append</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span>topic<span style="color: #66cc66;">,</span> callback<span style="color: #66cc66;">,</span> args<span style="color: #66cc66;">,</span> kwargs<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
                <span style="color: #ff7700;font-weight:bold;">return</span> callback
            <span style="color: #ff7700;font-weight:bold;">return</span> wrapper
&nbsp;
    <span style="color: #808080; font-style: italic;"># un système d'event interne</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> on<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> event<span style="color: black;">&#41;</span>:
            <span style="color: #ff7700;font-weight:bold;">def</span> wrapper<span style="color: black;">&#40;</span>callback<span style="color: black;">&#41;</span>:
                <span style="color: #008000;">self</span>.<span style="color: black;">event_handlers</span>.<span style="color: black;">setdefault</span><span style="color: black;">&#40;</span>event<span style="color: #66cc66;">,</span> <span style="color: black;">&#91;</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>.<span style="color: black;">append</span><span style="color: black;">&#40;</span>callback<span style="color: black;">&#41;</span>
                <span style="color: #ff7700;font-weight:bold;">return</span> callback
            <span style="color: #ff7700;font-weight:bold;">return</span> wrapper
&nbsp;
    async <span style="color: #ff7700;font-weight:bold;">def</span> trigger<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> event<span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">for</span> callback <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">self</span>.<span style="color: black;">event_handlers</span>.<span style="color: black;">get</span><span style="color: black;">&#40;</span>event<span style="color: #66cc66;">,</span> <span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>:
            await callback<span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">session</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># un peu de code de compatibilité avec l'API initiale</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__call__</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> *args<span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">class</span> CustomeSession<span style="color: black;">&#40;</span>ApplicationSession<span style="color: black;">&#41;</span>:
            async <span style="color: #ff7700;font-weight:bold;">def</span> onJoin<span style="color: black;">&#40;</span>session_self<span style="color: #66cc66;">,</span> details<span style="color: black;">&#41;</span>:
&nbsp;
                <span style="color: #808080; font-style: italic;"># on joint on fait tous les registers et tous les</span>
                <span style="color: #808080; font-style: italic;"># subscribes</span>
                <span style="color: #ff7700;font-weight:bold;">for</span> name<span style="color: #66cc66;">,</span> proc<span style="color: #66cc66;">,</span> args<span style="color: #66cc66;">,</span> kwargs <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">self</span>.<span style="color: black;">procedures</span>:
                     session_self.<span style="color: black;">register</span><span style="color: black;">&#40;</span>proc<span style="color: #66cc66;">,</span> name<span style="color: #66cc66;">,</span> *args<span style="color: #66cc66;">,</span> **kwargs<span style="color: black;">&#41;</span>
&nbsp;
                <span style="color: #ff7700;font-weight:bold;">for</span> topic<span style="color: #66cc66;">,</span> callback<span style="color: #66cc66;">,</span> args<span style="color: #66cc66;">,</span> kwargs <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">self</span>.<span style="color: black;">subscriptions</span>:
                     session_self.<span style="color: black;">subscribe</span><span style="color: black;">&#40;</span>proc<span style="color: #66cc66;">,</span> topic<span style="color: #66cc66;">,</span> *args<span style="color: #66cc66;">,</span> **kwargs<span style="color: black;">&#41;</span>
&nbsp;
                <span style="color: #808080; font-style: italic;"># on appelle les handlers de notre event</span>
                await <span style="color: #008000;">self</span>.<span style="color: black;">trigger</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'joined'</span><span style="color: black;">&#41;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">session</span> <span style="color: #66cc66;">=</span> CustomeSession<span style="color: black;">&#40;</span>*args<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">self</span>.<span style="color: black;">session</span></pre></td></tr></table></div>

<p>Évidement la coloration syntaxique ne suit pas sur nos <code>async</code>/<code>await</code>.</p>
<p>Bon, vous allez me dire, mais ça quoi ça sert tout ça ? Et bien, c’est une version tronquée et codée à l’arrache de l’<a href="https://github.com/tavendo/AutobahnPython/blob/master/autobahn/twisted/wamp.py#L322">API Application</a> pour Twisted&#8230; mais version asyncio.</p>
<p>C’est-à-dire que c’est une lib qui permet de faire le même exemple que le tout premier qu’on a vu dans cette partie &#8211; qui souvenez-vous était fort moche -, mais comme ça :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">app <span style="color: #66cc66;">=</span> App<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #66cc66;">@</span>app.<span style="color: black;">register</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'add'</span><span style="color: black;">&#41;</span>
async <span style="color: #ff7700;font-weight:bold;">def</span> add<span style="color: black;">&#40;</span>a<span style="color: #66cc66;">,</span> b<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">return</span> a + b
&nbsp;
<span style="color: #66cc66;">@</span>app.<span style="color: black;">on</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'joined'</span><span style="color: black;">&#41;</span>
async <span style="color: #ff7700;font-weight:bold;">def</span> _<span style="color: black;">&#40;</span>session<span style="color: black;">&#41;</span>:
    res <span style="color: #66cc66;">=</span> await session.<span style="color: black;">call</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;add&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Got result: {}&quot;</span>.<span style="color: black;">format</span><span style="color: black;">&#40;</span>res<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
app.<span style="color: black;">run_cmd</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Des jolis décorateurs ! Des jolis async ! Des jolis await !</p>
<p>Et tout ça tourne parfaitement sur 3.5 messieurs-dames.</p>
<p>Bref, on peut faire du WAMP avec une syntaxe claire et belle, il faut juste se bouger le cul pour coder une abstraction un peu propre. </p>
<p>Je pense que autobahn restera toujours un peu bas niveau. Donc il va falloir que quelqu’un se colle à faire une lib pour wrapper tout ça.</p>
<p>Des volontaires ?</p>
<p>Arf, je savais bien que ça allait me retomber sur la gueule.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/jouons-un-peu-avec-python-3-5/feed/</wfw:commentRss>
		<slash:comments>27</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2015/09/AE2pJJl.gif" length="429970" type="image/jpg" />	</item>
		<item>
		<title>Nouvelle release de crossbar : support de Python 3 ! 9</title>
		<link>http://sametmax.com/nouvelle-release-de-crossbar-support-de-python-3/</link>
		<comments>http://sametmax.com/nouvelle-release-de-crossbar-support-de-python-3/#comments</comments>
		<pubDate>Wed, 09 Sep 2015 15:13:22 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[crossbar]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[wamp]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=16908</guid>
		<description><![CDATA[L'équipe de Tavendo est à l'écoute de toutes les critiques de Crossbar et <a href="http://sametmax.com/presentation-de-wamp-round-2/">WAMP</a> en général, et je me suis fais un plaisir de leur rapporter toutes les merdes donc vous m'avez fait part.]]></description>
				<content:encoded><![CDATA[<p>L’équipe de Tavendo est à l’écoute de toutes les critiques de <a href="https://crossbar.io/">Crossbar</a> et <a href="http://sametmax.com/presentation-de-wamp-round-2/">WAMP</a> en général, et je me suis fait un plaisir de leur rapporter toutes les merdes dont vous m’avez fait part.</p>
<p>Cette <a href="https://groups.google.com/forum/#!topic/autobahnws/VvSM_mEQ0c0">nouvelle release</a> contient beaucoup de choses qui corrigent ou pallient un paquet de trucs relou dans le routeur Crossbar (et par conséquent la lib client Autobahn) :</p>
<ul>
<li>Support officiel de Python 3. Yes. Yes, yes yes !</li>
<li>Le debug a été complètement revu : meilleure console, meilleur login, meilleurs messages d’erreur et meilleur comportement en cas d’exceptions.</li>
<li>Un service dédié à l’upload de fichier intégré.</li>
<li>Un bridge HTTP complet qui permet d’utiliser Crossbar depuis n’importe quelle app qui peut faire des requêtes HTTP.</li>
</ul>
<p>Pour la suite, ils travaillent sur la doc, et l’amélioration de l’API. En attendant, on peut <code>pip install crossbar</code> et profiter de ces nouveautés sans avoir à passer par github.</p>
<p>De mon côté j&#8217;ai un article sur l&#8217;authentification avec Crossbar dans les cartons. ETA dans les 10 prochains jours.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/nouvelle-release-de-crossbar-support-de-python-3/feed/</wfw:commentRss>
		<slash:comments>9</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2015/09/rXRWFB0.jpg" length="292725" type="image/jpg" />	</item>
		<item>
		<title>Today is a glorious day 15</title>
		<link>http://sametmax.com/today-is-a-glorious-day/</link>
		<comments>http://sametmax.com/today-is-a-glorious-day/#comments</comments>
		<pubDate>Sun, 12 Jul 2015 21:29:59 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[crossbar]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[python 3]]></category>
		<category><![CDATA[twisted]]></category>
		<category><![CDATA[wamp]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=16600</guid>
		<description><![CDATA[pip install crossbar]]></description>
				<content:encoded><![CDATA[
<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">import</span> crossbar
<span style="color: #66cc66;">&gt;&gt;&gt;</span> crossbar.__version__
<span style="color: #483d8b;">'0.10.4'</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">import</span> twisted
<span style="color: #66cc66;">&gt;&gt;&gt;</span> twisted.__version__
<span style="color: #483d8b;">'15.2.1'</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">sys</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'Wait for it...'</span><span style="color: black;">&#41;</span>
Wait <span style="color: #ff7700;font-weight:bold;">for</span> it...
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #dc143c;">sys</span>.<span style="color: black;">version</span>
<span style="color: #483d8b;">'3.4.0 (default, Apr 11 2014, 13:05:11) <span style="color: #000099; font-weight: bold;">\n</span>[GCC 4.8.2]'</span></pre></td></tr></table></div>

]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/today-is-a-glorious-day/feed/</wfw:commentRss>
		<slash:comments>15</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2015/07/T5C15Zm.gif" length="996010" type="image/jpg" />	</item>
		<item>
		<title>Pendant ce temps, à Vera Cruz 8</title>
		<link>http://sametmax.com/pendant-ce-temps-a-vera-cruz/</link>
		<comments>http://sametmax.com/pendant-ce-temps-a-vera-cruz/#comments</comments>
		<pubDate>Sun, 10 May 2015 09:29:24 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[autobahn]]></category>
		<category><![CDATA[crossbar]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[wamp]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=16198</guid>
		<description><![CDATA[Pour une fois, ce n&#8217;est pas un article payé par Tavendo, mais bien un truc que je ponds par enthousiasme :) Pendant qu&#8217;on en parle pas, la stack WAMP continue d&#8217;évoluer, des mises à jours significatives ayant été apportées à Crossbar.io, ainsi qu&#8217;aux libs Python et JS d&#8217;autobahn. Parmi les plus intéressantes : Le code [&#8230;]]]></description>
				<content:encoded><![CDATA[<p>Pour une fois, ce n&#8217;est pas un article payé par Tavendo, mais bien un truc que je ponds par enthousiasme :)</p>
<p>Pendant qu&#8217;on en parle pas, la stack WAMP continue d&#8217;évoluer, des mises à jours significatives ayant été apportées à Crossbar.io, ainsi qu&#8217;aux libs Python et JS d&#8217;autobahn. Parmi les plus intéressantes :</p>
<ul>
<li>Le code passe de la licence Apache 2 à la licence MIT, augmentant la compatibilité avec un tas d&#8217;autres licences.</li>
<li>On peut faire un SUB avec un joker, et donc lier un seul callback à plusieurs événements.</li>
<li>On peut faire un register avec un joker également.</li>
<li>On peut choisir la stratégie à appliquer si plusieurs registers sont faits sur le même nom.</li>
<li>Une meta API permet d&#8217;être prévenu quand un client fait quelque chose ou de demander l&#8217;état des nœuds en cours.</li>
</ul>
<p>Inutile de dire que c&#8217;est trop cool.</p>
<p>Pour profiter de tout ça, il suffit de faire :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">pip <span style="color: #c20cb9; font-weight: bold;">install</span> crossbar autobahn <span style="color: #660033;">--upgrade</span></pre></td></tr></table></div>

<p>Et de télécharger la nouvelle version de la <a href="https://autobahn.s3.amazonaws.com/autobahnjs/latest/autobahn.min.jgz">dernière version</a> de la lib JS.</p>
<h2>Licence MIT</h2>
<p>Auparavant le travail de Tavendo était essentiellement sous Licence Apache. Une licence libre, certes, mais qui pouvait poser problème quand on mélangeait tout ça avec d&#8217;autres licences (par exemple, elle n&#8217;est pas compatible avec la GPL2). Avec la version 0.10, le code est maintenant sous licence MIT, beaucoup plus permissive.</p>
<h2>Joker pour les subs</h2>
<p>Supposez que vous faites un système de jeu d&#8217;échec donc chaque coup déclenche un événement &#8220;chess.game.[id_de_partie]&#8221;. C&#8217;est pratique, car seuls les clients intéressés à cette partie vont recevoir les événements. Mais si votre serveur doit enregistrer un log de tous les coups d&#8217;une partie, il faut que chaque client envoie AUSSI les coups au serveur explicitement.</p>
<p>C&#8217;était en tout cas vrai avant cette mise à jour, puisque maintenant on peut spécifier <a href="http://crossbar.io/docs/Pattern-Based-Subscriptions/">des jokers</a> dans les noms des topics au moment de l&#8217;abonnement.</p>
<p>Essentiellement il y a deux modes.</p>
<p>Le mode &#8220;prefix&#8221;, qui match tous les events qui commencent par ce nom :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family:monospace;">session.<span style="color: #660066;">subscribe</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">&quot;debut.du.nom.du.topic&quot;</span><span style="color: #339933;">,</span> callback<span style="color: #339933;">,</span> <span style="color: #009900;">&#123;</span> match<span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;prefix&quot;</span> <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
# matchera debut.<span style="color: #660066;">du</span>.<span style="color: #660066;">nom</span>.<span style="color: #660066;">du</span>.<span style="color: #660066;">topic</span>.<span style="color: #660066;">genial</span> et debut.<span style="color: #660066;">du</span>.<span style="color: #660066;">nom</span>.<span style="color: #660066;">du</span>.<span style="color: #660066;">topic</span>.<span style="color: #660066;">trop</span>.<span style="color: #660066;">cool</span></pre></td></tr></table></div>

<p>Et le mode &#8220;wildcard&#8221; qui permet, un peu comme les glob Unix (mais on utilise &#8220;..&#8221; au lieu de &#8220;*&#8221;&#8221;), de faire un texte à trou :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family:monospace;">session.<span style="color: #660066;">subscribe</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">&quot;nom.du.topic..general&quot;</span><span style="color: #339933;">,</span> callback<span style="color: #339933;">,</span> <span style="color: #009900;">&#123;</span> match<span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;wildcard&quot;</span> <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
# matchera <span style="color: #3366CC;">&quot;nom.du.topic.moins.general&quot;</span> et <span style="color: #3366CC;">&quot;nom.du.topic.oui.mon.general&quot;</span></pre></td></tr></table></div>

<p>Tous les callbacks qui matchent un topic seront appelés.</p>
<h2>Plusieurs clients pour la même procédure</h2>
<p>On peut utiliser le même principe que pour les sub avec joker, mais pour les procédures.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family:monospace;">session.<span style="color: #660066;">register</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">&quot;debut.du.nom.de.la.procedure&quot;</span><span style="color: #339933;">,</span> callback<span style="color: #339933;">,</span> <span style="color: #009900;">&#123;</span> match<span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;prefix&quot;</span> <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>    
session.<span style="color: #660066;">register</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">&quot;nom.de.la.procedure..generale&quot;</span><span style="color: #339933;">,</span> callback<span style="color: #339933;">,</span> <span style="color: #009900;">&#123;</span> match<span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;wildcard&quot;</span> <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre></td></tr></table></div>

<p>La différence avec le subscribe, c&#8217;est que seule UNE procédure est appelée. Dans les cas simples, un match exact prend le dessus sur un prefix (et le plus long prefix gagne toujours), qui prend le dessus sur un wildcard. Crossbar n&#8217;implemente pas encore de résolution pour deux wildcards en conflits, et je ne sais pas ce qu&#8217;il fait dans ce cas.</p>
<p>Il est aussi possible de <a href="http://crossbar.io/docs/Shared-Registrations/">de définir des règles</a> d&#8217;appels en faisant :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family:monospace;">session.<span style="color: #660066;">register</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">&quot;nom.de.la.procedure..generale&quot;</span><span style="color: #339933;">,</span> procedure1<span style="color: #339933;">,</span> <span style="color: #009900;">&#123;</span> invoke<span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;regle&quot;</span><span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre></td></tr></table></div>

<p>La règle peut être :</p>
<ul>
<li><strong>roundrobin</strong>: on prend la liste de clients, on regarde le dernier appelé, et on utilise le suivant.</li>
<li><strong>random</strong>: on prend un client au hasard.</li>
<li><strong>last</strong>: on prend le dernier client ajouté de la liste.</li>
<li><strong>first</strong>: on prend premier client ajouté à la liste.</li>
</ul>
<p>&#8220;roundrobin&#8221; et &#8220;random&#8221; sont pratiques pour faire du load balancing.</p>
<p>&#8220;last&#8221; et &#8220;first&#8221; sont pratique pour les mises à jour d&#8217;un client sans arrêter le serveur. En gros on rajoute un client, on attend un peu, &#8220;last&#8221; route tout sur le dernier client, donc le nouveau client prend les requêtes, et on peut arrêter le vieux clients sans souci. </p>
<h2>Meta RPC</h2>
<p>Crossbar met automatiquement à notre disposition des procédures distantes toutes faites qui donnent des informations sur l&#8217;état des clients et du routeur. Voici les RPC que vous pouvez maintenant faire :</p>
<ul>
<li><strong>wamp.session.list</strong>: lister les sessions des clients connectés au routeur.</li>
<li><strong>wamp.session.get</strong>: obtenir les infos d&#8217;un session pour un ID en particulier.</li>
<li><strong>wamp.session.count</strong>: obtenir le nombre de client connectés.</li>
<li><strong>wamp.registration.lookup</strong>: absolument aucune idée.</li>
<li><strong>wamp.registration.get</strong>: obtenir des infos sur une procédure distante enregistrée.</li>
<li><strong>wamp.registration.list_callees</strong>: lister les clients ayant enregistré pour une procédure avec ce nom.</li>
<li><strong>wamp.registration.count_callees</strong>: compter les clients ayant enregistré une procédure avec ce nom.</li>
<li><strong>wamp.registration.list</strong>: lister toutes les procédures distantes disponibles.</li>
<li><strong>wamp.registration.remove_callee</strong>: virer un client de la liste de des clients enregistrés pour cet procédure.</li>
<li><strong>wamp.subscription.lookup</strong>: toujours aucune idée.</li>
<li><strong>wamp.subscription.get</strong>: récupérer des infos sur l&#8217;abonnement avec cet ID.</li>
<li><strong>wamp.subscription.list_subscribers</strong>: lister les clients qui sont abonnés à ce sujet.</li>
<li><strong>wamp.subscription.count_subscribers</strong>: compter les clients abonnés à ce sujet.</li>
<li><strong>wamp.subscription.match</strong>: aucune idée.</li>
<li><strong>wamp.subscription.list</strong>: lister tous les sujets d&#8217;abonnement disponibles.</li>
<li><strong>wamp.subscription.remove_subscriber</strong>: </li>
<p> virer un client de la liste des abonnés à ce sujet.</ul>
<p>En gros, si vous voulez faire une admin qui vous permet de killer certains client ou rechercher si des events existent, vous utilisez ça.</p>
<h2>Meta SUB</h2>
<p>De même, le routeur envoie maintenant des publications sur des sujets concernant le cycle son cycle de vie et celui des clients. On peut donc s&#8217;abonner à ces meta topic pour réagir à l&#8217;activité de son système :</p>
<ul>
<li><strong>wamp.session.on_join</strong> : un client s&#8217;est connecté au routeur.</li>
<li><strong>wamp.session.on_leave</strong> : un client s&#8217;est déconnecté du routeur.</li>
<li><strong>wamp.subscription.on_create</strong> : un nouveau topic existe.</li>
<li><strong>wamp.subscription.on_subscribe</strong> : un client s&#8217;est abonné à un topic.</li>
<li><strong>wamp.subscription.on_unsubscribe</strong> : un client s&#8217;est désabonné à un topic.</li>
<li><strong>wamp.subscription.on_delete</strong> : un topic est retiré de la liste des topics disponibles.</li>
<li><strong>wamp.registration.on_create</strong> : une procédure distante porte ce nom pour la première fois.</li>
<li><strong>wamp.registration.on_register</strong> : un client propose ajoute un callable pour ce nom de procédure distante..</li>
<li><strong>wamp.registration.on_unregister</strong> : un client retire son callable pour ce nom de procédure distante. </li>
<li><strong>wamp.registration.on_delete</strong> : le nom de cette procédure n&#8217;a plus aucun callable lié.</li>
<li><strong>wamp.schema.on_define</strong> : aucune idée.</li>
<li><strong>wamp.schema.on_undefine</strong> : kamolox. </li>
</ul>
<p>Ce genre de truc est idéal pour faire un petit outil de monitoring pour son archi et voir ce qui se passe en temps réel.</p>
<h2>Le HTTP bridge est complet</h2>
<p>Le <a href="http://crossbar.io/docs/HTTP-Bridge-Services/">bridge HTTP</a> propose maintenant PUB/SUB, et tout RPC. On peut donc maintenant utiliser crossbar depuis n&#8217;importe quel app qui peut faire du HTTP : flask, pyramid, ruby on rails, du PHP pur, wget en ligne de commande et tout le bordel. C&#8217;est plus verbeux, mais ça dépanne bien.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/pendant-ce-temps-a-vera-cruz/feed/</wfw:commentRss>
		<slash:comments>8</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2015/05/uZyph09.gif" length="677811" type="image/jpg" />	</item>
		<item>
		<title>Un petit dashboard de monitoring avec Django et WAMP 7</title>
		<link>http://sametmax.com/un-petit-dashboard-de-monitoring-avec-django-et-wamp/</link>
		<comments>http://sametmax.com/un-petit-dashboard-de-monitoring-avec-django-et-wamp/#comments</comments>
		<pubDate>Sat, 07 Feb 2015 10:58:43 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[autobahn]]></category>
		<category><![CDATA[crossbar.io]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[wamp]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=15872</guid>
		<description><![CDATA[Crossbar.io vient avec un service "HTTP Pusher" qui permet d'envoyer une requête POST qui va se transformer en véritable publish WAMP.

Histoire d'illustrer tout ça, je vais vous montrer comment construire un petit service de monitoring avec Crossbar.io et Django.]]></description>
				<content:encoded><![CDATA[<p><em>Cet article est écrit dans le cadre de ma <a href="http://sametmax.com/full-disclosure/">collaboration</a> avec Tavendo.</em></p>
<p>On a déjà vu que <a href="http://sametmax.com/crossbar-le-futur-des-applications-web-python/">WAMP c&#8217;est cool</a>, mais c&#8217;est asynchrone et nos frameworks Web chéris WSGI <a href="http://sametmax.com/wamp-et-les-outils-de-dev-web-python-existants/">sont synchrones</a>.</p>
<p>J&#8217;ai donné une solution de contournement avec la lib <a href="http://sametmax.com/les-managers-le-detestent-faites-tourner-wamp-dans-django-avec-cette-astuce-insolite/">crochet</a> qui permet de faire tourner du twisted de manière synchrone dans son projet.</p>
<p>Néanmoins, beaucoup sont, j&#8217;en suis certain, à la recherche d&#8217;un truc plus simple. En effet, le bénéfice le plus immédiat de WAMP sont les notifications en temps réel. Et pour ça, crossbar vient avec le <a href="https://github.com/crossbario/crossbar/wiki/HTTP%20Pusher%20Service">HTTP PUSHER service</a> : quelques lignes de JSON dans le fichier de config de crossbar et zou, on peut publier sur un topic WAMP avec une simple requête POST :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family:monospace;"> <span style="color: #3366CC;">&quot;transports&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#91;</span>
    <span style="color: #009900;">&#123;</span>
       <span style="color: #3366CC;">&quot;type&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;web&quot;</span><span style="color: #339933;">,</span>
       <span style="color: #3366CC;">&quot;endpoint&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span>
          <span style="color: #3366CC;">&quot;type&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;tcp&quot;</span><span style="color: #339933;">,</span>
          <span style="color: #3366CC;">&quot;port&quot;</span><span style="color: #339933;">:</span> <span style="color: #CC0000;">8080</span>
       <span style="color: #009900;">&#125;</span><span style="color: #339933;">,</span>
       <span style="color: #3366CC;">&quot;paths&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span>
          ...
          <span style="color: #3366CC;">&quot;notify&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span>
             <span style="color: #3366CC;">&quot;type&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;pusher&quot;</span><span style="color: #339933;">,</span>
             <span style="color: #3366CC;">&quot;realm&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;realm1&quot;</span><span style="color: #339933;">,</span>
             <span style="color: #3366CC;">&quot;role&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;anonymous&quot;</span>
          <span style="color: #009900;">&#125;</span>
       <span style="color: #009900;">&#125;</span>
    <span style="color: #009900;">&#125;</span>
 <span style="color: #009900;">&#93;</span></pre></td></tr></table></div>

<p>Et derrière, pour publier un event sur le sujet &#8220;super_sujet&#8221;, on peut faire :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> requets
requests.<span style="color: black;">post</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;http://ip_du_router/pusher&quot;</span><span style="color: #66cc66;">,</span>
                  json<span style="color: #66cc66;">=</span><span style="color: black;">&#123;</span>
                      <span style="color: #483d8b;">'topic'</span>: <span style="color: #483d8b;">'super_sujet'</span>
                      <span style="color: #483d8b;">'args'</span>: <span style="color: black;">&#91;</span>queques<span style="color: #66cc66;">,</span> params<span style="color: #66cc66;">,</span> a<span style="color: #66cc66;">,</span> passer<span style="color: #66cc66;">,</span> si<span style="color: #66cc66;">,</span> on veut<span style="color: black;">&#93;</span>
                  <span style="color: black;">&#125;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Ceci va envoyer une requête POST à un service de crossbar qui va transformer ça en véritable publish WAMP.</p>
<p>Histoire d&#8217;illustrer tout ça, je vais vous montrer comment construire un petit service de monitoring avec Crossbar.io et Django. Pour suivre le tuto vous aurez besoin :</p>
<ul>
<li>De connaissances de base en JS.</li>
<li>De connaître le principe de WAMP.</li>
<li>De savoir installer des bibliothèques Python avec extensions sur votre machine. <a href="https://duckduckgo.com/l/?kh=-1&#038;uddg=http%3A%2F%2Fsametmax.com%2Fvotre-python-aime-les-pip%2F">pip</a> et <a href="http://sametmax.com/les-environnement-virtuels-python-virtualenv-et-virtualenvwrapper">virtualenv</a> sont vos amis.</li>
<li>De connaître Django. Même si le concept peut s&#8217;appliquer à Flask, Pyramid, ou autre.</li>
</ul>
<p><span class='embed-youtube' style='text-align:center; display: block;'><iframe class='youtube-player' type='text/html' width='1170' height='689' src='http://www.youtube.com/embed/e9Xtl22x5Sg?version=3&#038;rel=1&#038;fs=1&#038;showsearch=0&#038;showinfo=1&#038;iv_load_policy=1&#038;wmode=transparent' frameborder='0' allowfullscreen='true'></iframe></span></p>
<h2>Premiers pas</h2>
<p>Le but du jeu est d&#8217;avoir un petit client WAMP qu&#8217;on lance sur chaque machine qu&#8217;on veut monitorer. Celui-ci va, toutes les x secondes, récupérer l&#8217;usage CPU, RAM et disque et faire un publish WAMP.</p>
<div id="attachment_15876" style="width: 600px" class="wp-caption aligncenter"><a href="http://sametmax.com/wp-content/uploads/2015/02/architecture.png" class="grouped_elements" rel="tc-fancybox-group15872"><img src="http://sametmax.com/wp-content/uploads/2015/02/architecture.png" alt="Chaque machine possède un client WAMP" width="590" height="654" class="size-full wp-image-15876" /></a><p class="wp-caption-text">Chaque machine possède un client WAMP</p></div>
<p>A l&#8217;autre bout, on a un site Django qui a un modèle pour chaque machine monitorée, avec des valeurs pour dire si on est intéressé par le CPU, la RAM ou le disque et la valeur de x.</p>
<p>Une page affiche en temps réel tous les relevés pour toutes les machines. Si dans l&#8217;admin de Django on change un modèle, la page reflète ce changement.</p>
<div id="attachment_15877" style="width: 710px" class="wp-caption aligncenter"><a href="http://sametmax.com/wp-content/uploads/2015/02/dashboard.gif" class="grouped_elements" rel="tc-fancybox-group15872"><img src="http://sametmax.com/wp-content/uploads/2015/02/dashboard.gif" alt="Si je déclique &quot;CPU&quot; dans l&#039;admin Django, les CPUs ne sont plus affichés" width="700" height="650" class="size-full wp-image-15877" /></a><p class="wp-caption-text">Si je déclique &#8220;CPU&#8221; dans l&#8217;admin Django, les CPUs ne sont plus affichés</p></div>
<p> On aura donc besoin de django (<code>pip install Django</code>, ça c&#8217;est pas trop dur), requests (<code>pip install requests</code>, jusqu&#8217;ici tout va bien), et <a href="pythonhosted.org/psutil/">psutil</a>.</p>
<p>psutil est la lib Python qui va nous permettre de récupérer toutes le valeurs pour la RAM, le disque et le CPU. Elle utilise des extensions en C, il faut donc un compilateur et les headers Python. Sous Ubuntu, il faut donc faire :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">sudo</span> <span style="color: #c20cb9; font-weight: bold;">apt-get install</span> <span style="color: #c20cb9; font-weight: bold;">gcc</span> python-dev</pre></td></tr></table></div>

<p>Sous CentOS ça donne :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">yum groupinstall</span> <span style="color: #ff0000;">&quot;Development tools&quot;</span>
<span style="color: #c20cb9; font-weight: bold;">yum install</span> python-devel</pre></td></tr></table></div>

<p>Sous Mac, les headers Python devraient être inclus, mais il vous faut aussi GCC. Si vous avez xcode, vous avez déjà un compilateur, sinon, il existe un installeur <a href="https://github.com/kennethreitz/osx-gcc-installer#readme">plus léger</a>.</p>
<p>Sous windows, c&#8217;est un wheel donc rien à faire normalement.</p>
<p>Et reste plus qu&#8217;à <code>pip install psutil</code>.</p>
<p>Enfin il nous faudra, logique, <a href="http://crossbar.io/docs/Local-Installation/">installer crossbar</a>. <code>pip install crossbar</code>, sachant que <a href="http://crossbar.io/docs/Installation-on-Windows/">sous Windows</a> vous aurez besoin de <a href="http://sourceforge.net/projects/pywin32/files/pywin32/Build%20219/">PyWin32</a> et comme toujours, d&#8217;avoir les dossiers <code>C:\Python27\</code> and <code>C:\Python27\Scripts</code> dans votre <a href="http://sametmax.com/ajouter-un-chemin-a-la-variable-denvironnement-path-sous-windows/">PATH</a>.</p>
<h2>Le HTML</h2>
<p>On a besoin que d&#8217;une page. Afin de rendre le tuto agnostique, je l&#8217;ai fait en pur JS, pas de jQuery, pas d&#8217;Angular. Donc c&#8217;est verbeux :)</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="html" style="font-family:monospace;">&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta charset=&quot;utf-8&quot; /&gt;
&nbsp;
    &lt;!-- De quoi cacher un bloc facilement --&gt;
    &lt;style type=&quot;text/css&quot;&gt;
        .hide {display:none;}
    &lt;/style&gt;
&nbsp;
    &lt;!--
        La lib JS qui permet de parler WAMP .
&nbsp;
        Ici je suppose qu'on utilise un navigateur qui support websocket.
        Il est possible de faire du fallback sur flash ou long poll, mais
        ce sont des dépendances en plus.
    --&gt;
    &lt;script src=&quot;https://autobahn.s3.amazonaws.com/autobahnjs/latest/autobahn.min.jgz&quot;
           type=&quot;text/javascript&quot;&gt;&lt;/script&gt;
&nbsp;
&nbsp;
    &lt;!-- Tout notre code client, inline pour faciliter votre lecture --&gt;
    &lt;script type=&quot;text/javascript&quot;&gt;
&nbsp;
      /* Connexion à notre serveur WAMP */
      window.addEventListener(&quot;load&quot;, function(){
        var connection = new autobahn.Connection({
           url: 'ws://127.0.0.1:8080/ws',
           realm: 'realm1'
        });
&nbsp;
        /* Quand la connexion est ouverte, exécuter ce code */
        connection.onopen = function(session) {
&nbsp;
          var clients = document.getElementById(&quot;clients&quot;);
&nbsp;
          /* Quand on reçoit l'événement clientstats, lancer cette fonction */
          session.subscribe('clientstats', function(args){
            var stats = args[0];
            var serverNode = document.getElementById(stats.ip);
&nbsp;
            /*
                 Créer un li contenant un h2 et un dl pour ce client si
                 il n'est pas encore dans la page.
            */
            if (!serverNode){
                serverNode = document.createElement(&quot;li&quot;);
                serverNode.id = stats.ip;
                serverNode.appendChild(document.createElement(&quot;h2&quot;));
                serverNode.appendChild(document.createElement(&quot;dl&quot;));
                serverNode.firstChild.innerHTML = stats.name + &quot; (&quot; + stats.ip + &quot;)&quot;;
                clients.appendChild(serverNode);
&nbsp;
                // Cacher les infos du serveur si il est désactivé.
                session.subscribe('clientconfig.' + stats.ip, function(args){
                    var config = args[0];
                    if (config.disabled){
                        var serverNode = document.getElementById(config.ip);
                        serverNode.className = &quot;hide&quot;;
                    }
                });
&nbsp;
            }
&nbsp;
            // Remettre à zéro le contenu du li du serveur.
            serverNode.className = &quot;&quot;;
            var dl = serverNode.lastChild;
            while (dl.hasChildNodes()) {
                dl.removeChild(dl.lastChild);
            }
&nbsp;
            // Si on a des infos sur le CPU, les afficher
            if (stats.cpus){
                var cpus = document.createElement(&quot;dt&quot;);
                cpus.innerHTML = &quot;CPUs:&quot;;
                dl.appendChild(cpus);
                for (var i = 0; i &lt; stats.cpus.length; i++) {
                    var cpu = document.createElement(&quot;dd&quot;);
                    cpu.innerHTML = stats.cpus[i];
                    dl.appendChild(cpu);
                };
            }
&nbsp;
            // Si on a des infos sur l'espace disque, les afficher
            if (stats.disks){
                var disks = document.createElement(&quot;dt&quot;);
                disks.innerHTML = &quot;Disk usage:&quot;;
                dl.appendChild(disks);
                for (key in stats.disks) {
                    var disk = document.createElement(&quot;dd&quot;);
                    disk.innerHTML = &quot;&lt;strong&gt;&quot; + key + &quot;&lt;/strong&gt;: &quot; + stats.disks[key];
                    dl.appendChild(disk);
                };
            }
&nbsp;
            // Si on a des infos sur l'usage mémoire, les afficher.
            if (stats.memory){
                var memory = document.createElement(&quot;dt&quot;);
                memory.innerHTML = &quot;Memory:&quot;;
                dl.appendChild(memory);
                var memVal = document.createElement(&quot;dd&quot;);
                memVal.innerHTML = stats.memory;
                dl.appendChild(memVal);
            }
&nbsp;
          });
&nbsp;
        };
&nbsp;
        // Ouvrir la connexion avec le routeur WAMP.
        connection.open();
&nbsp;
      });
    &lt;/script&gt;
&nbsp;
    &lt;title&gt; Monitoring&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt; Monitoring &lt;/h1&gt;
    &lt;ul id=&quot;clients&quot;&gt;&lt;/ul&gt;
&lt;/body&gt;
&nbsp;
&lt;/html&gt;</pre></td></tr></table></div>

<p>Comme vous pouvez le voir, c&#8217;est beaucoup de JS ordinaire et du DOM. Les seules parties spécifiques à WAMP sont :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family:monospace;"><span style="color: #000066; font-weight: bold;">var</span> connection <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">new</span> autobahn.<span style="color: #660066;">Connection</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#123;</span>
           url<span style="color: #339933;">:</span> <span style="color: #3366CC;">'ws://127.0.0.1:8080/ws'</span><span style="color: #339933;">,</span>
           realm<span style="color: #339933;">:</span> <span style="color: #3366CC;">'realm1'</span>
        <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
connection.<span style="color: #660066;">onopen</span> <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>session<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
...
<span style="color: #009900;">&#125;</span>
connection.<span style="color: #660066;">open</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre></td></tr></table></div>

<p>Pour se connecter au serveur.</p>
<p>Et :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family:monospace;">session.<span style="color: #660066;">subscribe</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'nom_du_sujet'</span><span style="color: #339933;">,</span> <span style="color: #000066; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>args<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
...
<span style="color: #009900;">&#125;</span></pre></td></tr></table></div>

<p>Pour réagir à la publication d&#8217;un sujet WAMP.</p>
<h2>Le client de monitoring</h2>
<p>C&#8217;est la partie qui va aller sur chaque machine qu&#8217;on veut surveiller.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #808080; font-style: italic;"># -*- coding: utf-8 -*-</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">__future__</span> <span style="color: #ff7700;font-weight:bold;">import</span> division
&nbsp;
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">socket</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">import</span> requests
<span style="color: #ff7700;font-weight:bold;">import</span> psutil
&nbsp;
<span style="color: #ff7700;font-weight:bold;">from</span> autobahn.<span style="color: black;">twisted</span>.<span style="color: black;">wamp</span> <span style="color: #ff7700;font-weight:bold;">import</span> Application
<span style="color: #ff7700;font-weight:bold;">from</span> autobahn.<span style="color: black;">twisted</span>.<span style="color: black;">util</span> <span style="color: #ff7700;font-weight:bold;">import</span> sleep
&nbsp;
<span style="color: #ff7700;font-weight:bold;">from</span> twisted.<span style="color: black;">internet</span>.<span style="color: black;">defer</span> <span style="color: #ff7700;font-weight:bold;">import</span> inlineCallbacks
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> to_gib<span style="color: black;">&#40;</span><span style="color: #dc143c;">bytes</span><span style="color: #66cc66;">,</span> factor<span style="color: #66cc66;">=</span><span style="color: #ff4500;">2</span>**<span style="color: #ff4500;">30</span><span style="color: #66cc66;">,</span> suffix<span style="color: #66cc66;">=</span><span style="color: #483d8b;">&quot;GiB&quot;</span><span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot; Converti un nombre d'octets en gibioctets.
&nbsp;
        Ex : 1073741824 octets = 1073741824/2**30 = 1GiO
    &quot;&quot;&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #483d8b;">&quot;%0.2f%s&quot;</span> % <span style="color: black;">&#40;</span><span style="color: #dc143c;">bytes</span> / factor<span style="color: #66cc66;">,</span> suffix<span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> get_infos<span style="color: black;">&#40;</span>filters<span style="color: #66cc66;">=</span><span style="color: black;">&#123;</span><span style="color: black;">&#125;</span><span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot; Retourne la valeur actuelle de l'usage CPU, mémoire et disque.
&nbsp;
        Ces valeurs sont retournées sous la forme d'un dictionnaire :
&nbsp;
            {
                'cpus': ['x%', 'y%', etc],
                'memory': &quot;z%&quot;,
                'disk':{
                    '/partition/1': 'x/y (z%)',
                    '/partition/2': 'x/y (z%)',
                    etc
                }
            }
&nbsp;
        Le paramètre filter est un dico de la forme :
&nbsp;
            {'cpus': bool, 'memory':bool, 'disk':bool}
&nbsp;
        Il est utilisé pour décider d'inclure ou non les résultats des mesures
        pour les 3 types de ressource.
&nbsp;
    &quot;&quot;&quot;</span>
&nbsp;
    results <span style="color: #66cc66;">=</span> <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: black;">&#40;</span>filters.<span style="color: black;">get</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'show_cpus'</span><span style="color: #66cc66;">,</span> <span style="color: #008000;">True</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>:
        results<span style="color: black;">&#91;</span><span style="color: #483d8b;">'cpus'</span><span style="color: black;">&#93;</span> <span style="color: #66cc66;">=</span> <span style="color: #008000;">tuple</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;%s%%&quot;</span> % x <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> psutil.<span style="color: black;">cpu_percent</span><span style="color: black;">&#40;</span>percpu<span style="color: #66cc66;">=</span><span style="color: #008000;">True</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: black;">&#40;</span>filters.<span style="color: black;">get</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'show_memory'</span><span style="color: #66cc66;">,</span> <span style="color: #008000;">True</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>:
        memory <span style="color: #66cc66;">=</span> psutil.<span style="color: black;">phymem_usage</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
        results<span style="color: black;">&#91;</span><span style="color: #483d8b;">'memory'</span><span style="color: black;">&#93;</span> <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">'{used}/{total} ({percent}%)'</span>.<span style="color: black;">format</span><span style="color: black;">&#40;</span>
            used<span style="color: #66cc66;">=</span>to_gib<span style="color: black;">&#40;</span>memory.<span style="color: black;">active</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            total<span style="color: #66cc66;">=</span>to_gib<span style="color: black;">&#40;</span>memory.<span style="color: black;">total</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            percent<span style="color: #66cc66;">=</span>memory.<span style="color: black;">percent</span>
        <span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: black;">&#40;</span>filters.<span style="color: black;">get</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'show_disk'</span><span style="color: #66cc66;">,</span> <span style="color: #008000;">True</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>:
        disks <span style="color: #66cc66;">=</span> <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span>
        <span style="color: #ff7700;font-weight:bold;">for</span> device <span style="color: #ff7700;font-weight:bold;">in</span> psutil.<span style="color: black;">disk_partitions</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
            usage <span style="color: #66cc66;">=</span> psutil.<span style="color: black;">disk_usage</span><span style="color: black;">&#40;</span>device.<span style="color: black;">mountpoint</span><span style="color: black;">&#41;</span>
            disks<span style="color: black;">&#91;</span>device.<span style="color: black;">mountpoint</span><span style="color: black;">&#93;</span> <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">'{used}/{total} ({percent}%)'</span>.<span style="color: black;">format</span><span style="color: black;">&#40;</span>
                used<span style="color: #66cc66;">=</span>to_gib<span style="color: black;">&#40;</span>usage.<span style="color: black;">used</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
                total<span style="color: #66cc66;">=</span>to_gib<span style="color: black;">&#40;</span>usage.<span style="color: black;">total</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
                percent<span style="color: #66cc66;">=</span>usage.<span style="color: black;">percent</span>
            <span style="color: black;">&#41;</span>
        results<span style="color: black;">&#91;</span><span style="color: #483d8b;">'disks'</span><span style="color: black;">&#93;</span> <span style="color: #66cc66;">=</span> disks
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">return</span> results
&nbsp;
<span style="color: #808080; font-style: italic;"># On créé le client WAMP.</span>
app <span style="color: #66cc66;">=</span> Application<span style="color: black;">&#40;</span><span style="color: #483d8b;">'monitoring'</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># Ceci est l'IP publique de ma machine puisque</span>
<span style="color: #808080; font-style: italic;"># ce client doit pouvoir accéder à mon serveur</span>
<span style="color: #808080; font-style: italic;"># depuis l'extérieur.</span>
SERVER <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">'172.17.42.1'</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># D'abord on utilise une astuce pour connaître l'IP publique de cette</span>
<span style="color: #808080; font-style: italic;"># machine.</span>
s <span style="color: #66cc66;">=</span> <span style="color: #dc143c;">socket</span>.<span style="color: #dc143c;">socket</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">socket</span>.<span style="color: black;">AF_INET</span><span style="color: #66cc66;">,</span> <span style="color: #dc143c;">socket</span>.<span style="color: black;">SOCK_DGRAM</span><span style="color: black;">&#41;</span>
s.<span style="color: black;">connect</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;8.8.8.8&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">80</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #808080; font-style: italic;"># On attache un dictionnaire à l'app, ainsi</span>
<span style="color: #808080; font-style: italic;"># sa référence sera accessible partout.</span>
app._params <span style="color: #66cc66;">=</span> <span style="color: black;">&#123;</span><span style="color: #483d8b;">'name'</span>: <span style="color: #dc143c;">socket</span>.<span style="color: black;">gethostname</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'ip'</span>: s.<span style="color: black;">getsockname</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#93;</span><span style="color: black;">&#125;</span>
s.<span style="color: black;">close</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #66cc66;">@</span>app.<span style="color: #dc143c;">signal</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'onjoined'</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">@</span>inlineCallbacks
<span style="color: #ff7700;font-weight:bold;">def</span> called_on_joinded<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot; Boucle envoyant l'état de cette machine avec WAMP toutes les x secondes.
&nbsp;
        Cette fonction est exécutée quand le client &quot;joins&quot; le router, c'est
        à dire qu'il est connecté et authentifié, prêt à envoyer des messages
        WAMP.
    &quot;&quot;&quot;</span>
    <span style="color: #808080; font-style: italic;"># Ensuite on fait une requête post au serveur pour dire qu'on est</span>
    <span style="color: #808080; font-style: italic;"># actif et récupérer les valeurs de configuration de notre client.</span>
    app._params.<span style="color: black;">update</span><span style="color: black;">&#40;</span>requests.<span style="color: black;">post</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'http://'</span> + SERVER + <span style="color: #483d8b;">':8080/clients/'</span><span style="color: #66cc66;">,</span>
                                    data<span style="color: #66cc66;">=</span><span style="color: black;">&#123;</span><span style="color: #483d8b;">'ip'</span>: app._params<span style="color: black;">&#91;</span><span style="color: #483d8b;">'ip'</span><span style="color: black;">&#93;</span><span style="color: black;">&#125;</span><span style="color: black;">&#41;</span>.<span style="color: black;">json</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
&nbsp;
    <span style="color: #808080; font-style: italic;"># Puis on boucle indéfiniment</span>
    <span style="color: #ff7700;font-weight:bold;">while</span> <span style="color: #008000;">True</span>:
        <span style="color: #808080; font-style: italic;"># Chaque tour de boucle, on récupère les infos de notre machine</span>
        infos <span style="color: #66cc66;">=</span> <span style="color: black;">&#123;</span><span style="color: #483d8b;">'ip'</span>: app._params<span style="color: black;">&#91;</span><span style="color: #483d8b;">'ip'</span><span style="color: black;">&#93;</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'name'</span>: app._params<span style="color: black;">&#91;</span><span style="color: #483d8b;">'name'</span><span style="color: black;">&#93;</span><span style="color: black;">&#125;</span>
        infos.<span style="color: black;">update</span><span style="color: black;">&#40;</span>get_infos<span style="color: black;">&#40;</span>app._params<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># Si les stats sont a envoyer, on fait une publication WAMP.</span>
        <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #ff7700;font-weight:bold;">not</span> app._params<span style="color: black;">&#91;</span><span style="color: #483d8b;">'disabled'</span><span style="color: black;">&#93;</span>:
            app.<span style="color: black;">session</span>.<span style="color: black;">publish</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'clientstats'</span><span style="color: #66cc66;">,</span> infos<span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># Et on attend. Grâce à @inlineCallbacks, utiliser yield indique</span>
        <span style="color: #808080; font-style: italic;"># qu'on ne bloque pas ici, donc pendant ce temps notre client</span>
        <span style="color: #808080; font-style: italic;"># peut écouter les événements WAMP et y réagir.</span>
        <span style="color: #ff7700;font-weight:bold;">yield</span> sleep<span style="color: black;">&#40;</span>app._params<span style="color: black;">&#91;</span><span style="color: #483d8b;">'frequency'</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
&nbsp;
&nbsp;
<span style="color: #808080; font-style: italic;"># On dit qu'on est intéressé par les événements concernant clientconfig</span>
<span style="color: #66cc66;">@</span>app.<span style="color: black;">subscribe</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'clientconfig.'</span> + app._params<span style="color: black;">&#91;</span><span style="color: #483d8b;">'ip'</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">def</span> update_configuration<span style="color: black;">&#40;</span>args<span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot; Met à jour la configuration du client quand Django nous le demande. &quot;&quot;&quot;</span>
    app._params.<span style="color: black;">update</span><span style="color: black;">&#40;</span>args<span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># On démarre notre client.</span>
<span style="color: #ff7700;font-weight:bold;">if</span> __name__ <span style="color: #66cc66;">==</span> <span style="color: #483d8b;">'__main__'</span>:
    app.<span style="color: black;">run</span><span style="color: black;">&#40;</span>url<span style="color: #66cc66;">=</span><span style="color: #483d8b;">&quot;ws://%s:8080/ws&quot;</span> % SERVER<span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Le plus gros du code est <code>get_infos()</code> qui n&#8217;a rien à voir avec WAMP. C&#8217;est nous, manipulant <code>psutil</code> pour obtenir les relevés de cette machine. Je ne recommande bien évidement pas de faire ça en prod : une grosse fonction monolithique qui prend un dico en param. Mais c&#8217;est pour une démo, et ça me permet de grouper les instructions qui vont ensemble pour faciliter votre compréhension.</p>
<p>La partie qui concerne WAMP :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">app <span style="color: #66cc66;">=</span> Application<span style="color: black;">&#40;</span><span style="color: #483d8b;">'monitoring'</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #66cc66;">@</span>app.<span style="color: #dc143c;">signal</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'onjoined'</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">@</span>inlineCallbacks
<span style="color: #ff7700;font-weight:bold;">def</span> called_on_joinded<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    ...
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">while</span> <span style="color: #008000;">True</span>:
&nbsp;
        ...
        <span style="color: black;">app</span>.<span style="color: black;">session</span>.<span style="color: black;">publish</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'clientstats'</span><span style="color: #66cc66;">,</span> infos<span style="color: black;">&#41;</span>
        ...
        <span style="color: #ff7700;font-weight:bold;">yield</span> sleep<span style="color: black;">&#40;</span>app._params<span style="color: black;">&#91;</span><span style="color: #483d8b;">'frequency'</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p><code>app = Application('monitoring')</code> créé un client WAMP, et <code>@app.signal('onjoined')</code> nous dit de lancer la fonction quand notre client est connecté et prêt à envoyer des événements. <code>@inlineCallbacks</code> est une spécificité de Twisted qui nous permet d&#8217;écrire du code asynchrone sans avoir à mettre des callback partout : à la place on met des <code>yield.</code></p>
<p>Tout le boulot de notre client a lieu dans la boucle : <code>app.session.publish('clientstats', infos)</code> publie les nouvelles mesures de CPU/RAM/Disque via WAMP, puis attend un certain temps (<code>yield sleep(app._params['frequency'])</code>) avant de le faire à nouveau. L&#8217;attente n&#8217;est pas bloquante car elle se fait avec le <code>sleep</code> de Twisted.</p>
<p>N&#8217;oublions pas :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">@</span>app.<span style="color: black;">subscribe</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'clientconfig.'</span> + app._params<span style="color: black;">&#91;</span><span style="color: #483d8b;">'ip'</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">def</span> update_configuration<span style="color: black;">&#40;</span>args<span style="color: black;">&#41;</span>:
    app._params.<span style="color: black;">update</span><span style="color: black;">&#40;</span>args<span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>La fonction <code>update_configuration()</code> sera appelée à chaque fois qu&#8217;une publication WAMP sera faite sur le sujet <code>clientconfig.&lt;ip_du_client&gt;</code>. Notre fonction ne fait que mettre à jour la configuration du client, qui est un dico de la forme :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">    <span style="color: black;">&#123;</span><span style="color: #483d8b;">'cpus'</span>: <span style="color: #008000;">True</span><span style="color: #66cc66;">,</span>
    <span style="color: #483d8b;">'memory'</span>: <span style="color: #008000;">False</span><span style="color: #66cc66;">,</span>
    <span style="color: #483d8b;">'disk'</span>: <span style="color: #008000;">True</span><span style="color: #66cc66;">,</span>
    <span style="color: #483d8b;">'disabled'</span>: <span style="color: #008000;">False</span><span style="color: #66cc66;">,</span>
    <span style="color: #483d8b;">'frequency'</span>: <span style="color: #ff4500;">1</span><span style="color: black;">&#125;</span></pre></td></tr></table></div>

<p>C&#8217;est ce dico qui est utilisé par <code>get_infos()</code> pour choisir quelles mesures récupérer, et aussi par <code>sleep()</code> pour savoir combien de secondes attendre avant la prochaine mesure.</p>
<p>La valeur initiale de ce dico est récupérée au lancement du client, en faisant :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">app._params.<span style="color: black;">update</span><span style="color: black;">&#40;</span>requests.<span style="color: black;">post</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'http://'</span> + SERVER + <span style="color: #483d8b;">':8080/clients/'</span><span style="color: #66cc66;">,</span>
                                    data<span style="color: #66cc66;">=</span><span style="color: black;">&#123;</span><span style="color: #483d8b;">'ip'</span>: app._params<span style="color: black;">&#91;</span><span style="color: #483d8b;">'ip'</span><span style="color: black;">&#93;</span><span style="color: black;">&#125;</span><span style="color: black;">&#41;</span>.<span style="color: black;">json</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p><code>requests.post(url_du_serveur, data={'ip': app._params['ip']}).json()</code> fait en effet une requête POST vers une URL de django qui nous allons voir plus loin, et qui retourne la configuration du client portant cette IP sous forme de JSON.</p>
<p>On utilise donc une fois HTTP pour obtenir les valeurs de départs, et ensuite WAMP pour les mises à jours des futures valeurs. WAMP et HTTP ne s&#8217;excluent pas : ils sont complémentaires.</p>
<p>Petite parenthèse sur :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">SERVER <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">'172.17.42.1'</span>
&nbsp;
s <span style="color: #66cc66;">=</span> <span style="color: #dc143c;">socket</span>.<span style="color: #dc143c;">socket</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">socket</span>.<span style="color: black;">AF_INET</span><span style="color: #66cc66;">,</span> <span style="color: #dc143c;">socket</span>.<span style="color: black;">SOCK_DGRAM</span><span style="color: black;">&#41;</span>
s.<span style="color: black;">connect</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;8.8.8.8&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">80</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
app._params <span style="color: #66cc66;">=</span> <span style="color: black;">&#123;</span><span style="color: #483d8b;">'name'</span>: <span style="color: #dc143c;">socket</span>.<span style="color: black;">gethostname</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'ip'</span>: s.<span style="color: black;">getsockname</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#93;</span><span style="color: black;">&#125;</span>
s.<span style="color: black;">close</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>D&#8217;une part, j&#8217;ai mis l&#8217;IP du serveur qui va contenir Crossbar.io et Django en dur car je suis, je pense que maintenant vous le savez, une grosse feignasse. Mais en prod, vous me faites un paramètre, on est d&#8217;accord ? Ensuite, il faut que j&#8217;identifie mon client, ce que je fais avec l&#8217;adresse IP. Il me faut donc son adresse IP externe, et je l&#8217;obtiens avec une astuce consistant à me connecter à l&#8217;IP 8.8.8.8 (les DNS google \o/) et en fermant la connexion juste derrière. Ce me permet de voir comment les autres machines me voit depuis l’extérieur.</p>
<h2>Le site Django</h2>
<p>Puisque le prérequis de l&#8217;article et de connaître Django, ça va pas être trop dur.</p>
<p>On créé son projet et son app :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">django-admin startproject django_project
.<span style="color: #000000; font-weight: bold;">/</span>manage.py startapp django_app</pre></td></tr></table></div>

<p>On se rajoute un petit modèle qui contient la configuration de chaque client (vous vous souvenez, le fameux dico) :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #808080; font-style: italic;"># -*- coding: utf-8 -*-</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">import</span> requests
&nbsp;
<span style="color: #ff7700;font-weight:bold;">from</span> django.<span style="color: black;">db</span> <span style="color: #ff7700;font-weight:bold;">import</span> models
<span style="color: #ff7700;font-weight:bold;">from</span> django.<span style="color: black;">db</span>.<span style="color: black;">models</span>.<span style="color: black;">signals</span> <span style="color: #ff7700;font-weight:bold;">import</span> post_save
<span style="color: #ff7700;font-weight:bold;">from</span> django.<span style="color: black;">dispatch</span> <span style="color: #ff7700;font-weight:bold;">import</span> receiver
<span style="color: #ff7700;font-weight:bold;">from</span> django.<span style="color: black;">forms</span>.<span style="color: black;">models</span> <span style="color: #ff7700;font-weight:bold;">import</span> model_to_dict
&nbsp;
&nbsp;
<span style="color: #ff7700;font-weight:bold;">class</span> Client<span style="color: black;">&#40;</span>models.<span style="color: black;">Model</span><span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot; Configuration de notre client. &quot;&quot;&quot;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># Pour l'identifier.</span>
    ip <span style="color: #66cc66;">=</span> models.<span style="color: black;">GenericIPAddressField</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># Quelles données envoyer à notre dashboard</span>
    show_cpus <span style="color: #66cc66;">=</span> models.<span style="color: black;">BooleanField</span><span style="color: black;">&#40;</span>default<span style="color: #66cc66;">=</span><span style="color: #008000;">True</span><span style="color: black;">&#41;</span>
    show_memory <span style="color: #66cc66;">=</span> models.<span style="color: black;">BooleanField</span><span style="color: black;">&#40;</span>default<span style="color: #66cc66;">=</span><span style="color: #008000;">True</span><span style="color: black;">&#41;</span>
    show_disk <span style="color: #66cc66;">=</span> models.<span style="color: black;">BooleanField</span><span style="color: black;">&#40;</span>default<span style="color: #66cc66;">=</span><span style="color: #008000;">True</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># Arrêter d'envoyer les données</span>
    disabled <span style="color: #66cc66;">=</span> models.<span style="color: black;">BooleanField</span><span style="color: black;">&#40;</span>default<span style="color: #66cc66;">=</span><span style="color: #008000;">False</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># Fréquence de rafraîchissement des données</span>
    frequency <span style="color: #66cc66;">=</span> models.<span style="color: black;">IntegerField</span><span style="color: black;">&#40;</span>default<span style="color: #66cc66;">=</span><span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__unicode__</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">self</span>.<span style="color: black;">ip</span>
&nbsp;
&nbsp;
<span style="color: #66cc66;">@</span>receiver<span style="color: black;">&#40;</span>post_save<span style="color: #66cc66;">,</span> sender<span style="color: #66cc66;">=</span>Client<span style="color: #66cc66;">,</span> dispatch_uid<span style="color: #66cc66;">=</span><span style="color: #483d8b;">&quot;server_post_save&quot;</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">def</span> notify_server_config_changed<span style="color: black;">&#40;</span>sender<span style="color: #66cc66;">,</span> instance<span style="color: #66cc66;">,</span> **kwargs<span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot; Notifie un client que sa configuration a changé.
&nbsp;
        Cette fonction est lancée quand on sauvegarde un modèle Client,
        et fait une requête POST sur le bridge WAMP-HTTP, nous permettant
        de faire un publish depuis Django.
    &quot;&quot;&quot;</span>
    requests.<span style="color: black;">post</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;http://127.0.0.1:8080/notify&quot;</span><span style="color: #66cc66;">,</span>
                  json<span style="color: #66cc66;">=</span><span style="color: black;">&#123;</span>
                      <span style="color: #483d8b;">'topic'</span>: <span style="color: #483d8b;">'clientconfig.'</span> + instance.<span style="color: black;">ip</span><span style="color: #66cc66;">,</span>
                      <span style="color: #483d8b;">'args'</span>: <span style="color: black;">&#91;</span>model_to_dict<span style="color: black;">&#40;</span>instance<span style="color: black;">&#41;</span><span style="color: black;">&#93;</span>
                  <span style="color: black;">&#125;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>La partie modèle est connue. L&#8217;astuce est dans :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">@</span>receiver<span style="color: black;">&#40;</span>post_save<span style="color: #66cc66;">,</span> sender<span style="color: #66cc66;">=</span>Client<span style="color: #66cc66;">,</span> dispatch_uid<span style="color: #66cc66;">=</span><span style="color: #483d8b;">&quot;server_post_save&quot;</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">def</span> notify_server_config_changed<span style="color: black;">&#40;</span>sender<span style="color: #66cc66;">,</span> instance<span style="color: #66cc66;">,</span> **kwargs<span style="color: black;">&#41;</span>:
    requests.<span style="color: black;">post</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;http://127.0.0.1:8080/notify&quot;</span><span style="color: #66cc66;">,</span>
                  json<span style="color: #66cc66;">=</span><span style="color: black;">&#123;</span>
                      <span style="color: #483d8b;">'topic'</span>: <span style="color: #483d8b;">'clientconfig.'</span> + instance.<span style="color: black;">ip</span><span style="color: #66cc66;">,</span>
                      <span style="color: #483d8b;">'args'</span>: <span style="color: black;">&#91;</span>model_to_dict<span style="color: black;">&#40;</span>instance<span style="color: black;">&#41;</span><span style="color: black;">&#93;</span>
                  <span style="color: black;">&#125;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>On utilise ici les signaux Django, une fonctionnalité du framework qui nous permet de lancer une fonction quand quelque chose se passe. Ici on dit &#8220;lance cette fonction quand le modèle <code>Client</code> est modifié&#8221;.</p>
<p>Donc <code>notify_server_config_changed</code> va se lancer quand la config d&#8217;un client est modifiée, par exemple dans l&#8217;admin, et recevoir l&#8217;objet modifié via son paramètre <code>instance</code>.</p>
<p>On fait alors une petite requête POST sur <code>http://127.0.0.1:8080/notify</code>, l&#8217;URL sur laquelle on configurera plus loin notre service de push. En faisant une requête dessus, on va demander à Crossbar.io de transformer la requête HTTP en message publish WAMP, ici sur le sujet &#8216;clientconfig.&lt;ip_du_client&gt;&#8217;. On publie donc un message WAMP, depuis Django.</p>
<p>Ca marche depuis n&#8217;importe où, pas juste Django. Depuis le shell, depuis Flask, n&#8217;importe où on peut faire une requête HTTP vers le service de push de crossbar.</p>
<p>Ce message va être récupéré par notre client, où qu&#8217;il soit, puisqu&#8217;il est aussi connecté au routeur WAMP. Comme, je vous le rappelle, notre client fait ça :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">@</span>app.<span style="color: black;">subscribe</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'clientconfig.'</span> + app._params<span style="color: black;">&#91;</span><span style="color: #483d8b;">'ip'</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">def</span> update_configuration<span style="color: black;">&#40;</span>args<span style="color: black;">&#41;</span>:
    app._params.<span style="color: black;">update</span><span style="color: black;">&#40;</span>args<span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Il va recevoir ce message, et donc le contenu de <code>'args': [model_to_dict(instance)]</code>, c&#8217;est à dire la nouvelle configuration qu&#8217;on a changé en base de donnée. Il se met ainsi à jour immédiatement. La boucle est bouclée.</p>
<p>Comme on veut profiter de notre boucle toute bouclée, on rajoute le modèle dans l&#8217;admin :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">from</span> django.<span style="color: black;">contrib</span> <span style="color: #ff7700;font-weight:bold;">import</span> admin
&nbsp;
<span style="color: #808080; font-style: italic;"># Register your models here.</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">from</span> django_app.<span style="color: black;">models</span> <span style="color: #ff7700;font-weight:bold;">import</span> Client
&nbsp;
admin.<span style="color: #dc143c;">site</span>.<span style="color: black;">register</span><span style="color: black;">&#40;</span>Client<span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Ainsi, les configs des clients seront éditables dans l&#8217;admin, et quand on cliquera sur &#8220;save&#8221;, ça va lancer notre publish WAMP qui mettra à jour le bon client.</p>
<p>Le reste, c&#8217;est du fignolage. Une petite vue pour créer ou récupérer notre configuration de client au démarrage :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #808080; font-style: italic;"># -*- coding: utf-8 -*-</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">import</span> json
&nbsp;
<span style="color: #ff7700;font-weight:bold;">from</span> django.<span style="color: black;">http</span> <span style="color: #ff7700;font-weight:bold;">import</span> HttpResponse
<span style="color: #ff7700;font-weight:bold;">from</span> django_app.<span style="color: black;">models</span> <span style="color: #ff7700;font-weight:bold;">import</span> Client
<span style="color: #ff7700;font-weight:bold;">from</span> django.<span style="color: black;">views</span>.<span style="color: black;">decorators</span>.<span style="color: black;">csrf</span> <span style="color: #ff7700;font-weight:bold;">import</span> csrf_exempt
<span style="color: #ff7700;font-weight:bold;">from</span> django.<span style="color: black;">forms</span>.<span style="color: black;">models</span> <span style="color: #ff7700;font-weight:bold;">import</span> model_to_dict
&nbsp;
&nbsp;
<span style="color: #66cc66;">@</span>csrf_exempt
<span style="color: #ff7700;font-weight:bold;">def</span> clients<span style="color: black;">&#40;</span>request<span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot; Récupère la config d'un client en base de donnée et lui envoie.&quot;&quot;&quot;</span>
    client<span style="color: #66cc66;">,</span> created <span style="color: #66cc66;">=</span> Client.<span style="color: black;">objects</span>.<span style="color: black;">get_or_create</span><span style="color: black;">&#40;</span>ip<span style="color: #66cc66;">=</span>request.<span style="color: black;">POST</span><span style="color: black;">&#91;</span><span style="color: #483d8b;">'ip'</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> HttpResponse<span style="color: black;">&#40;</span>json.<span style="color: black;">dumps</span><span style="color: black;">&#40;</span>model_to_dict<span style="color: black;">&#40;</span>client<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span> content_type<span style="color: #66cc66;">=</span><span style="color: #483d8b;">'application/json'</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>On désactive la protection CSRF pour la démo, mais encore une fois, en prod, faites ça proprement, avec une jolie authentification pour protéger la vue, et tout, et tout.</p>
<p>Donc, cette vue récupère la configuration d&#8217;un client avec cette IP (la créant au besoin), et la retourne en JSON. Souvenez-vous, cela permet à notre client de faire :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">    app._params.<span style="color: black;">update</span><span style="color: black;">&#40;</span>requests.<span style="color: black;">post</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'http://'</span> + SERVER + <span style="color: #483d8b;">':8080/clients/'</span><span style="color: #66cc66;">,</span>
                                    data<span style="color: #66cc66;">=</span><span style="color: black;">&#123;</span><span style="color: #483d8b;">'ip'</span>: app._params<span style="color: black;">&#91;</span><span style="color: #483d8b;">'ip'</span><span style="color: black;">&#93;</span><span style="color: black;">&#125;</span><span style="color: black;">&#41;</span>.<span style="color: black;">json</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Au démarrage et se déclarer dans la base de données, tout en récupérant sa config.</p>
<p>On branche tout ça via <code>urls.py</code> :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">from</span> django.<span style="color: black;">conf</span>.<span style="color: black;">urls</span> <span style="color: #ff7700;font-weight:bold;">import</span> patterns<span style="color: #66cc66;">,</span> include<span style="color: #66cc66;">,</span> url
<span style="color: #ff7700;font-weight:bold;">from</span> django.<span style="color: black;">contrib</span> <span style="color: #ff7700;font-weight:bold;">import</span> admin
<span style="color: #ff7700;font-weight:bold;">from</span> django.<span style="color: black;">views</span>.<span style="color: black;">generic</span> <span style="color: #ff7700;font-weight:bold;">import</span> TemplateView
&nbsp;
urlpatterns <span style="color: #66cc66;">=</span> patterns<span style="color: black;">&#40;</span><span style="color: #483d8b;">''</span><span style="color: #66cc66;">,</span>
    url<span style="color: black;">&#40;</span>r<span style="color: #483d8b;">'^admin/'</span><span style="color: #66cc66;">,</span> include<span style="color: black;">&#40;</span>admin.<span style="color: #dc143c;">site</span>.<span style="color: black;">urls</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
    url<span style="color: black;">&#40;</span>r<span style="color: #483d8b;">'^clients/'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'django_app.views.clients'</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
    url<span style="color: black;">&#40;</span>r<span style="color: #483d8b;">'^$'</span><span style="color: #66cc66;">,</span> TemplateView.<span style="color: black;">as_view</span><span style="color: black;">&#40;</span>template_name<span style="color: #66cc66;">=</span><span style="color: #483d8b;">'dashboard.html'</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
<span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>L&#8217;admin, notre vue toute fraiche, et de quoi servir le HTML du début de l&#8217;article.</p>
<p>Y plus qu&#8217;à :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">.<span style="color: #000000; font-weight: bold;">/</span>manage.py syncdb</pre></td></tr></table></div>

<h2>Crossbar.io</h2>
<p>Finalement, tout ce qu&#8217;il reste, c&#8217;est notre bon crossbar :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">crossbar init</pre></td></tr></table></div>

<p>Ceci nous pond le dossier <code>.crossbar</code> dans lequel on a le fichier <code>config.json</code> qu&#8217;on édite pour qu&#8217;il ressemble à ça :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family:monospace;"><span style="color: #009900;">&#123;</span>
   <span style="color: #3366CC;">&quot;workers&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#91;</span>
      <span style="color: #009900;">&#123;</span>
         <span style="color: #3366CC;">&quot;type&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;router&quot;</span><span style="color: #339933;">,</span>
         <span style="color: #3366CC;">&quot;realms&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#91;</span>
            <span style="color: #009900;">&#123;</span>
               <span style="color: #3366CC;">&quot;name&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;realm1&quot;</span><span style="color: #339933;">,</span>
               <span style="color: #3366CC;">&quot;roles&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#91;</span>
                  <span style="color: #009900;">&#123;</span>
                     <span style="color: #3366CC;">&quot;name&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;anonymous&quot;</span><span style="color: #339933;">,</span>
                     <span style="color: #3366CC;">&quot;permissions&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#91;</span>
                        <span style="color: #009900;">&#123;</span>
                           <span style="color: #3366CC;">&quot;uri&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;*&quot;</span><span style="color: #339933;">,</span>
                           <span style="color: #3366CC;">&quot;publish&quot;</span><span style="color: #339933;">:</span> <span style="color: #003366; font-weight: bold;">true</span><span style="color: #339933;">,</span>
                           <span style="color: #3366CC;">&quot;subscribe&quot;</span><span style="color: #339933;">:</span> <span style="color: #003366; font-weight: bold;">true</span><span style="color: #339933;">,</span>
                           <span style="color: #3366CC;">&quot;call&quot;</span><span style="color: #339933;">:</span> <span style="color: #003366; font-weight: bold;">true</span><span style="color: #339933;">,</span>
                           <span style="color: #3366CC;">&quot;register&quot;</span><span style="color: #339933;">:</span> <span style="color: #003366; font-weight: bold;">true</span>
                        <span style="color: #009900;">&#125;</span>
                     <span style="color: #009900;">&#93;</span>
                  <span style="color: #009900;">&#125;</span>
               <span style="color: #009900;">&#93;</span>
            <span style="color: #009900;">&#125;</span>
         <span style="color: #009900;">&#93;</span><span style="color: #339933;">,</span>
         <span style="color: #3366CC;">&quot;transports&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#91;</span>
            <span style="color: #009900;">&#123;</span>
               <span style="color: #3366CC;">&quot;type&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;web&quot;</span><span style="color: #339933;">,</span>
               <span style="color: #3366CC;">&quot;endpoint&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span>
                  <span style="color: #3366CC;">&quot;type&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;tcp&quot;</span><span style="color: #339933;">,</span>
                  <span style="color: #3366CC;">&quot;port&quot;</span><span style="color: #339933;">:</span> <span style="color: #CC0000;">8080</span>
               <span style="color: #009900;">&#125;</span><span style="color: #339933;">,</span>
               <span style="color: #3366CC;">&quot;paths&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span>
                  <span style="color: #3366CC;">&quot;/&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span>
                     <span style="color: #3366CC;">&quot;type&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;wsgi&quot;</span><span style="color: #339933;">,</span>
                     <span style="color: #3366CC;">&quot;module&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;django_project.wsgi&quot;</span><span style="color: #339933;">,</span>
                     <span style="color: #3366CC;">&quot;object&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;application&quot;</span>
                  <span style="color: #009900;">&#125;</span><span style="color: #339933;">,</span>
                  <span style="color: #3366CC;">&quot;ws&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span>
                     <span style="color: #3366CC;">&quot;type&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;websocket&quot;</span>
                  <span style="color: #009900;">&#125;</span><span style="color: #339933;">,</span>
                  <span style="color: #3366CC;">&quot;notify&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span>
                     <span style="color: #3366CC;">&quot;type&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;pusher&quot;</span><span style="color: #339933;">,</span>
                     <span style="color: #3366CC;">&quot;realm&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;realm1&quot;</span><span style="color: #339933;">,</span>
                     <span style="color: #3366CC;">&quot;role&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;anonymous&quot;</span>
                  <span style="color: #009900;">&#125;</span><span style="color: #339933;">,</span>
                  <span style="color: #3366CC;">&quot;static&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span>
                     <span style="color: #3366CC;">&quot;type&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;static&quot;</span><span style="color: #339933;">,</span>
                     <span style="color: #3366CC;">&quot;directory&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;../static&quot;</span>
                  <span style="color: #009900;">&#125;</span>
               <span style="color: #009900;">&#125;</span>
            <span style="color: #009900;">&#125;</span>
         <span style="color: #009900;">&#93;</span>
      <span style="color: #009900;">&#125;</span>
   <span style="color: #009900;">&#93;</span>
<span style="color: #009900;">&#125;</span></pre></td></tr></table></div>

<p>La partie du haut c&#8217;est un peu l&#8217;équivalent du <code>chmod 777</code> de crossbar :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family:monospace;">         <span style="color: #3366CC;">&quot;type&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;router&quot;</span><span style="color: #339933;">,</span>
         <span style="color: #3366CC;">&quot;realms&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#91;</span>
            <span style="color: #009900;">&#123;</span>
               <span style="color: #3366CC;">&quot;name&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;realm1&quot;</span><span style="color: #339933;">,</span>
               <span style="color: #3366CC;">&quot;roles&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#91;</span>
                  <span style="color: #009900;">&#123;</span>
                     <span style="color: #3366CC;">&quot;name&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;anonymous&quot;</span><span style="color: #339933;">,</span>
                     <span style="color: #3366CC;">&quot;permissions&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#91;</span>
                        <span style="color: #009900;">&#123;</span>
                           <span style="color: #3366CC;">&quot;uri&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;*&quot;</span><span style="color: #339933;">,</span>
                           <span style="color: #3366CC;">&quot;publish&quot;</span><span style="color: #339933;">:</span> <span style="color: #003366; font-weight: bold;">true</span><span style="color: #339933;">,</span>
                           <span style="color: #3366CC;">&quot;subscribe&quot;</span><span style="color: #339933;">:</span> <span style="color: #003366; font-weight: bold;">true</span><span style="color: #339933;">,</span>
                           <span style="color: #3366CC;">&quot;call&quot;</span><span style="color: #339933;">:</span> <span style="color: #003366; font-weight: bold;">true</span><span style="color: #339933;">,</span>
                           <span style="color: #3366CC;">&quot;register&quot;</span><span style="color: #339933;">:</span> <span style="color: #003366; font-weight: bold;">true</span>
                        <span style="color: #009900;">&#125;</span>
                     <span style="color: #009900;">&#93;</span>
                  <span style="color: #009900;">&#125;</span>
               <span style="color: #009900;">&#93;</span>
            <span style="color: #009900;">&#125;</span>
         <span style="color: #009900;">&#93;</span><span style="color: #339933;">,</span></pre></td></tr></table></div>

<p>&#8220;Met moi en place un router avec un accès nommé realm1 qui autorise à tous les anonymes de tout faire&#8221;. Un realm est une notion de sécurité dans Crossbar.io qui permet de cloisonner les clients connectés, nous on va tout mettre sur le même realm, c&#8217;est pour une démo je vous dis.</p>
<p>Ensuite on rajoute les transports pour chaque techno qui nous intéresse. On va tout regrouper sur le port 8080 car Twisted peut écouter en HTTP et Websocket sur le même port :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family:monospace;"><span style="color: #3366CC;">&quot;transports&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#91;</span>
<span style="color: #009900;">&#123;</span>
   <span style="color: #3366CC;">&quot;type&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;web&quot;</span><span style="color: #339933;">,</span>
   <span style="color: #3366CC;">&quot;endpoint&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span>
      <span style="color: #3366CC;">&quot;type&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;tcp&quot;</span><span style="color: #339933;">,</span>
      <span style="color: #3366CC;">&quot;port&quot;</span><span style="color: #339933;">:</span> <span style="color: #CC0000;">8080</span>
   <span style="color: #009900;">&#125;</span><span style="color: #339933;">,</span></pre></td></tr></table></div>

<p>A la racine, on sert notre app Django :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family:monospace;">  <span style="color: #3366CC;">&quot;/&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span>
     <span style="color: #3366CC;">&quot;type&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;wsgi&quot;</span><span style="color: #339933;">,</span>
     <span style="color: #3366CC;">&quot;module&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;django_project.wsgi&quot;</span><span style="color: #339933;">,</span>
     <span style="color: #3366CC;">&quot;object&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;application&quot;</span>
  <span style="color: #009900;">&#125;</span><span style="color: #339933;">,</span></pre></td></tr></table></div>

<p>Car oui, crossbar peut servir votre app django en prod. Pas besoin de gunicorn. En fait même pas besoin d&#8217;nginx pour un site simple, car ça tient très bien la charge. On a juste à lui indiquer quelle variable (<code>application</code>) de quel fichier WSGI (<code>django_project/wsgi.py</code>) charger, et il s&#8217;occupe du reste.</p>
<p>Sur &#8216;/ws&#8217;, on écoute en Websocket :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family:monospace;"><span style="color: #3366CC;">&quot;ws&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span>
 <span style="color: #3366CC;">&quot;type&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;websocket&quot;</span>
<span style="color: #009900;">&#125;</span><span style="color: #339933;">,</span></pre></td></tr></table></div>

<p>WAMP passe par là, et c&#8217;est pour ça que nos clients se connectent en faisant <code>app.run(url="ws://%s:8080/ws" % SERVER)</code> et <code>autobahn.Connection({url: 'ws://127.0.0.1:8080/ws', realm: 'realm1'});</code>.</p>
<p>&#8216;/notify&#8217; va recevoir le bridge WAMP-HTTP :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family:monospace;"><span style="color: #3366CC;">&quot;notify&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span>
     <span style="color: #3366CC;">&quot;type&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;pusher&quot;</span><span style="color: #339933;">,</span>
     <span style="color: #3366CC;">&quot;realm&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;realm1&quot;</span><span style="color: #339933;">,</span>
     <span style="color: #3366CC;">&quot;role&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;anonymous&quot;</span>
  <span style="color: #009900;">&#125;</span></pre></td></tr></table></div>

<p>Tous les anonymes du <code>realm1</code> peuvent l&#8217;utiliser. Grâce à ça, on a pu faire depuis notre signal Django :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">    requests.<span style="color: black;">post</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;http://127.0.0.1:8080/notify&quot;</span><span style="color: #66cc66;">,</span>
                  json<span style="color: #66cc66;">=</span><span style="color: black;">&#123;</span>
                      <span style="color: #483d8b;">'topic'</span>: <span style="color: #483d8b;">'clientconfig.'</span> + instance.<span style="color: black;">ip</span><span style="color: #66cc66;">,</span>
                      <span style="color: #483d8b;">'args'</span>: <span style="color: black;">&#91;</span>model_to_dict<span style="color: black;">&#40;</span>instance<span style="color: black;">&#41;</span><span style="color: black;">&#93;</span>
                  <span style="color: black;">&#125;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Et donc publier un message WAMP, via un POST HTTP.</p>
<p>Enfin, on sert les fichiers statiques Django avec Crossbar (oui, il fait aussi ça :):</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family:monospace;"> <span style="color: #3366CC;">&quot;static&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #3366CC;">&quot;type&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;static&quot;</span><span style="color: #339933;">,</span>
    <span style="color: #3366CC;">&quot;directory&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;../static&quot;</span>
<span style="color: #009900;">&#125;</span></pre></td></tr></table></div>

<p>N&#8217;oubliez pas le de spécifier <code>STATIC_ROOT</code> dans le fichier settings et lancer <code>./manage.py collecstatic</code>.</p>
<p>Tout ça en place, on lance notre routeur :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #7a0874; font-weight: bold;">export</span> <span style="color: #007800;">PYTHONPATH</span>=<span style="color: #000000; font-weight: bold;">/</span>chemin<span style="color: #000000; font-weight: bold;">/</span>vers<span style="color: #000000; font-weight: bold;">/</span>votre<span style="color: #000000; font-weight: bold;">/</span>project
crossbar start</pre></td></tr></table></div>

<p>(Remplacer <code>export</code> par <code>set</code> sous Windows></p>
<p>La modification de <code>PYTHONPATH</code> est nécessaire pour que crossbar trouve votre fichier WSGI.</p>
<p>On visite <a href="http:127.0.0.1:8080/">http:127.0.0.1:8080/</a>, qui va charger notre template Django <code>dashboard.html</code>.</p>
<p>Chaque machine qui lance un client via <code>python client.py</code> va déclencher l&#8217;apparition des stats sur notre dashboard, qui seront mises à jour en temps réel.</p>
<p>Si on va sur <a href="http:127.0.0.1:8080/admin/">http:127.0.0.1:8080/admin/</a> et qu&#8217;on change la config d&#8217;un client, notre client s&#8217;adapte, et notre dashboard se met à jour automatiquement.</p>
<h2>Conclusion</h2>
<p>Notre projet ressemble à ceci au final :</p>
<pre>
.
├── client.py
├── .crossbar
│   ├── config.json
├── db.sqlite3
├── django_app
│   ├── admin.py
│   ├── __init__.py
│   ├── models.py
│   ├── templates
│   │   └── dashboard.html
│   └── views.py
├── django_project
│   ├── __init__.py
│   ├── settings.py
│   ├── urls.py
│   └── wsgi.py
├── static
└── manage.py

</pre>
<p>Vous pouvez récupérer le code <a href="https://github.com/sametmax/codes-des-articles/tree/master/2015/fevrier/tudo_django_wamp">ici</a>.</p>
<p>Finalement, très peu de code WAMP : un peu dans le JS, un peu dans le client. Et la seule chose qui lie WAMP à Django est la config crossbar qui ajoute le service HTTP PUSHER et notre requête POST dans <code>models.py</code></p>
<p>Cette technique n&#8217;est pas limitée à Django, et fonctionne bien pour toutes techno synchrones qui ne peut pas lancer un client WAMP directement en son sein. Pour le moment, le bridge HTTP-WAMP ne propose que PUB, pas de SUB, de pas de RPC. C&#8217;est déjà assez sympa pour avoir les notifications en temps réel un peu partout, et ça Tobias m&#8217;a dit qu&#8217;il ajoutera les autres actions dans un future proche.</p>
<p>En attendant, vous voyez le deal : on peut mélanger allègrement HTTP, WAMP, Python, JS, Client, Serveur, et monter sa petite architecture comme on le souhaite. Crossbar permet de démarrer du WSGI, mais aussi les clients WAMP sur la même machine et même n&#8217;importe quel process en ligne de commande (par exemple NodeJS) si besoin. C&#8217;est Mac Gyver ce truc.</p>
<p>On aurait pu écrire le client en Python 3 puisqu&#8217;il est sur une autre machine. Et en fait, si on lance Django en dehors de crossbar, aussi la partie Django en Python 3. Le code de crossbar n&#8217;est jamais modifié, on touche juste la configuration JSON.</p>
<p>Personnellement j&#8217;ai lancé plusieurs images <a href="http://sametmax.com/le-deploiement-par-conteneurs-avec-docker/">dockers</a> avec un client dedans à chaque fois, et c&#8217;est vraiment sympas de voir les machines se rajouter sur le dashboard en temps réel. On a une super sensation d&#8217;interactivité quand on change une valeur dans l&#8217;admin et qu&#8217;on voit le dashboard bouger.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/un-petit-dashboard-de-monitoring-avec-django-et-wamp/feed/</wfw:commentRss>
		<slash:comments>7</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2015/02/eded53891380c2bb5fd43858688b0554.jpg" length="246633" type="image/jpg" />	</item>
		<item>
		<title>Les managers le détestent : faites tourner WAMP dans Django avec cette astuce insolite 11</title>
		<link>http://sametmax.com/les-managers-le-detestent-faites-tourner-wamp-dans-django-avec-cette-astuce-insolite/</link>
		<comments>http://sametmax.com/les-managers-le-detestent-faites-tourner-wamp-dans-django-avec-cette-astuce-insolite/#comments</comments>
		<pubDate>Sun, 04 Jan 2015 19:45:07 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[autobahn]]></category>
		<category><![CDATA[crochet]]></category>
		<category><![CDATA[crossbar]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[flask]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[twisted]]></category>
		<category><![CDATA[wamp]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=15665</guid>
		<description><![CDATA[On peut utiliser WAMP, <code>directement</code> dans Django.]]></description>
				<content:encoded><![CDATA[<p>Il existe une lib appelée <a href="https://pypi.python.org/pypi/crochet">crochet</a> qui permet de faire marcher des API de twisted entre deux bouts de code bloquants. Certes, ça ne marche qu&#8217;en 2.7 et c&#8217;est pas hyper performant, mais on peut faire des trucs mignons du genre cette démo qui <a href="https://github.com/tavendo/AutobahnPython/tree/master/examples/twisted/wamp/app/crochet/example1">mélange flask et WAMP</a>.</p>
<p>C&#8217;est du pur Python, pas de process externe à gérer, c&#8217;est presque simple.</p>
<p>Bref, si on veut utiliser WAMP avec une app synchrone comme flask, c&#8217;est un bon moyen de s&#8217;y mettre. On aura jamais des perfs fantastiques, mais on peut pusher vers le browser.</p>
<p>Du coup je me suis demandé si on pouvait faire ça avec Django.</p>
<p>Évidement, ça a été un peu plus compliqué car par défaut <code>runserver</code> lance plusieurs workers et fait un peu de magie avec les threads. Mais après un peu de bidouillage, ça marche !</p>
<p>On peut utiliser WAMP, <code>directement</code> dans Django.</p>
<h2>Suivez le guide</h2>
<p>D&#8217;abord, on installe tout le bouzin (python 2.7, souvenez-vous) :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">pip <span style="color: #c20cb9; font-weight: bold;">install</span> crossbar crochet django</pre></td></tr></table></div>

<p>Il vous faudra un Django 1.7, le tout dernier, car il possède <a href="https://docs.djangoproject.com/en/dev/ref/applications/#django.apps.AppConfig.ready">une fonctionnalité</a> qui nous permet de lancer du code quand tout le framework est chargé.</p>
<p>Vous vous faites votre projet comme d&#8217;hab, et vous ouvrez le fichier de settings et au lieu de mettre votre app dans <code>INSTALLED_APPS</code>, vous rajoutez ça :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">INSTALLED_APPS <span style="color: #66cc66;">=</span> <span style="color: black;">&#40;</span>
    <span style="color: #483d8b;">'...'</span><span style="color: #66cc66;">,</span>
    <span style="color: #483d8b;">'votreapp.app.VotreAppConfig'</span>
<span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Puis dans le module de votre app, vous créez un fichier app.py, qui va contenir ça:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #808080; font-style: italic;"># -*- coding: utf-8 -*-</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">import</span> crochet
&nbsp;
<span style="color: #ff7700;font-weight:bold;">from</span> django.<span style="color: black;">apps</span> <span style="color: #ff7700;font-weight:bold;">import</span> AppConfig
&nbsp;
<span style="color: #808080; font-style: italic;"># On charge l'objet contenant la session WAMP définie dans la vue</span>
<span style="color: #ff7700;font-weight:bold;">from</span> votreapp.<span style="color: black;">views</span> <span style="color: #ff7700;font-weight:bold;">import</span> wapp
&nbsp;
<span style="color: #ff7700;font-weight:bold;">class</span> VotreAppConfig<span style="color: black;">&#40;</span>AppConfig<span style="color: black;">&#41;</span>:
    name <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">'votreapp'</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> ready<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #808080; font-style: italic;"># On dit a crochet de faire tourner notre app wamp dans sa popote qui</span>
        <span style="color: #808080; font-style: italic;"># isole le reactor de Twisted</span>
        <span style="color: #66cc66;">@</span>crochet.<span style="color: black;">run_in_reactor</span>
        <span style="color: #ff7700;font-weight:bold;">def</span> start_wamp<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
           <span style="color: #808080; font-style: italic;"># On démarre la session WAMP en se connectant au serveur</span>
           <span style="color: #808080; font-style: italic;"># publique de test</span>
           wapp.<span style="color: black;">run</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;wws://demo.crossbar.io/ws&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">&quot;realm1&quot;</span><span style="color: #66cc66;">,</span> start_reactor<span style="color: #66cc66;">=</span><span style="color: #008000;">False</span><span style="color: black;">&#41;</span>
        start_wamp<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>On passe à urls.py dans lequel on se rajoute des vues de démo :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">    url<span style="color: black;">&#40;</span>r<span style="color: #483d8b;">'^ping/'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'votreapp.views.ping'</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
    url<span style="color: black;">&#40;</span>r<span style="color: #483d8b;">'^$'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'votreapp.views.index'</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Puis dans notre fichier views.py, on met :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #808080; font-style: italic;"># -*- coding: utf-8 -*-</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">import</span> uuid
&nbsp;
<span style="color: #ff7700;font-weight:bold;">from</span> django.<span style="color: black;">shortcuts</span> <span style="color: #ff7700;font-weight:bold;">import</span> render
&nbsp;
<span style="color: #ff7700;font-weight:bold;">import</span> crochet
&nbsp;
<span style="color: #808080; font-style: italic;"># Crochet se démerde pour faire tourner le reactor twisted de</span>
<span style="color: #808080; font-style: italic;"># manière invisible. A lancer avant d'importer autobahn</span>
crochet.<span style="color: black;">setup</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">from</span> autobahn.<span style="color: black;">twisted</span>.<span style="color: black;">wamp</span> <span style="color: #ff7700;font-weight:bold;">import</span> Application
&nbsp;
<span style="color: #808080; font-style: italic;"># un objet qui contient une session WAMP</span>
wapp <span style="color: #66cc66;">=</span> Application<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># On enrobe les primitives de WAMP pour les rendre synchrones</span>
<span style="color: #66cc66;">@</span>crochet.<span style="color: black;">wait_for</span><span style="color: black;">&#40;</span>timeout<span style="color: #66cc66;">=</span><span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">def</span> publish<span style="color: black;">&#40;</span>topic<span style="color: #66cc66;">,</span> *args<span style="color: #66cc66;">,</span> **kwargs<span style="color: black;">&#41;</span>:
   <span style="color: #ff7700;font-weight:bold;">return</span> wapp.<span style="color: black;">session</span>.<span style="color: black;">publish</span><span style="color: black;">&#40;</span>topic<span style="color: #66cc66;">,</span> *args<span style="color: #66cc66;">,</span> **kwargs<span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #66cc66;">@</span>crochet.<span style="color: black;">wait_for</span><span style="color: black;">&#40;</span>timeout<span style="color: #66cc66;">=</span><span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">def</span> call<span style="color: black;">&#40;</span>name<span style="color: #66cc66;">,</span> *args<span style="color: #66cc66;">,</span> **kwargs<span style="color: black;">&#41;</span>:
   <span style="color: #ff7700;font-weight:bold;">return</span> wapp.<span style="color: black;">session</span>.<span style="color: black;">call</span><span style="color: black;">&#40;</span>name<span style="color: #66cc66;">,</span> *args<span style="color: #66cc66;">,</span> **kwargs<span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> register<span style="color: black;">&#40;</span>name<span style="color: #66cc66;">,</span> *args<span style="color: #66cc66;">,</span> **kwargs<span style="color: black;">&#41;</span>:
    <span style="color: #66cc66;">@</span>crochet.<span style="color: black;">run_in_reactor</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> decorator<span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span>:
        wapp.<span style="color: black;">register</span><span style="color: black;">&#40;</span>name<span style="color: #66cc66;">,</span> *args<span style="color: #66cc66;">,</span> **kwargs<span style="color: black;">&#41;</span><span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> decorator
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> subscribe<span style="color: black;">&#40;</span>name<span style="color: #66cc66;">,</span> *args<span style="color: #66cc66;">,</span> **kwargs<span style="color: black;">&#41;</span>:
    <span style="color: #66cc66;">@</span>crochet.<span style="color: black;">run_in_reactor</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> decorator<span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span>:
        wapp.<span style="color: black;">subscribe</span><span style="color: black;">&#40;</span>name<span style="color: #66cc66;">,</span> *args<span style="color: #66cc66;">,</span> **kwargs<span style="color: black;">&#41;</span><span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> decorator
&nbsp;
<span style="color: #808080; font-style: italic;"># Et hop, on peut utiliser nos outils WAMP !</span>
&nbsp;
<span style="color: #66cc66;">@</span>register<span style="color: black;">&#40;</span><span style="color: #483d8b;">'uuid'</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">def</span> get_uuid<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">return</span> uuid.<span style="color: black;">uuid4</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>.<span style="color: #008000;">hex</span>
&nbsp;
<span style="color: #66cc66;">@</span>subscribe<span style="color: black;">&#40;</span><span style="color: #483d8b;">'ping'</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">def</span> onping<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">with</span> <span style="color: #008000;">open</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'test'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'w'</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">as</span> f:
        f.<span style="color: black;">write</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'ping'</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># Et à côté, quelques vues django normales</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> index<span style="color: black;">&#40;</span>request<span style="color: black;">&#41;</span>:
    <span style="color: #808080; font-style: italic;"># pub et RPC en action côté Python</span>
    publish<span style="color: black;">&#40;</span><span style="color: #483d8b;">'ping'</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">print</span> call<span style="color: black;">&#40;</span><span style="color: #483d8b;">'uuid'</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">with</span> <span style="color: #008000;">open</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'test'</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">as</span> f:
        <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>f.<span style="color: black;">read</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> render<span style="color: black;">&#40;</span>request<span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'index.html'</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> ping<span style="color: black;">&#40;</span>request<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">return</span> render<span style="color: black;">&#40;</span>request<span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'ping.html'</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Après, un peu de templating pour que ça marche&#8230;</p>
<p>Index.html :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="html" style="font-family:monospace;">{% load staticfiles %}
&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta charset=&quot;utf-8&quot; /&gt;
    &lt;title&gt;
       UUID
    &lt;/title&gt;
&nbsp;
    &lt;script src=&quot;{% static 'autobahn.min.js' %}&quot;&gt;&lt;/script&gt;
    &lt;script type=&quot;text/javascript&quot;&gt;
      var connection = new autobahn.Connection({
         url: &quot;ws://localhost:8080/ws&quot;,
         realm: &quot;realm1&quot;
      });
&nbsp;
     connection.onopen = function (session) {
&nbsp;
        session.call(&quot;uuid&quot;).then(function (uuid) {
          var p = document.getElementById('uuid');
          p.innerHTML = uuid;
        });
     };
&nbsp;
     connection.open();
    &lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h2&gt;UUID&lt;/h2&gt;
&lt;p id=&quot;uuid&quot;&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;</pre></td></tr></table></div>

<p>ping.html :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: black;">&#123;</span>% load staticfiles %<span style="color: black;">&#125;</span>
<span style="color: #66cc66;">&lt;!</span>DOCTYPE html<span style="color: #66cc66;">&gt;</span>
<span style="color: #66cc66;">&lt;</span>html<span style="color: #66cc66;">&gt;</span>
  <span style="color: #66cc66;">&lt;</span>head<span style="color: #66cc66;">&gt;</span>
    <span style="color: #66cc66;">&lt;</span>meta charset<span style="color: #66cc66;">=</span><span style="color: #483d8b;">&quot;utf-8&quot;</span> /<span style="color: #66cc66;">&gt;</span>
    <span style="color: #66cc66;">&lt;</span>title<span style="color: #66cc66;">&gt;</span>
       Ping
    <span style="color: #66cc66;">&lt;</span>/title<span style="color: #66cc66;">&gt;</span>
&nbsp;
    <span style="color: #66cc66;">&lt;</span>script src<span style="color: #66cc66;">=</span><span style="color: #483d8b;">&quot;{% static 'autobahn.min.js' %}&quot;</span><span style="color: #66cc66;">&gt;&lt;</span>/script<span style="color: #66cc66;">&gt;</span>
    <span style="color: #66cc66;">&lt;</span>script <span style="color: #008000;">type</span><span style="color: #66cc66;">=</span><span style="color: #483d8b;">&quot;text/javascript&quot;</span><span style="color: #66cc66;">&gt;</span>
      var connection <span style="color: #66cc66;">=</span> <span style="color: #dc143c;">new</span> autobahn.<span style="color: black;">Connection</span><span style="color: black;">&#40;</span><span style="color: black;">&#123;</span>
         url: <span style="color: #483d8b;">&quot;ws://localhost:8080/ws&quot;</span><span style="color: #66cc66;">,</span>
         realm: <span style="color: #483d8b;">&quot;realm1&quot;</span>
      <span style="color: black;">&#125;</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">;</span>
&nbsp;
     connection.<span style="color: black;">onopen</span> <span style="color: #66cc66;">=</span> function <span style="color: black;">&#40;</span>session<span style="color: black;">&#41;</span> <span style="color: black;">&#123;</span>
&nbsp;
        session.<span style="color: black;">subscribe</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;ping&quot;</span><span style="color: #66cc66;">,</span> function <span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: black;">&#123;</span>
          var ul <span style="color: #66cc66;">=</span> document.<span style="color: black;">getElementById</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'ping'</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">;</span>
          var li <span style="color: #66cc66;">=</span> document.<span style="color: black;">createElement</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'li'</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">;</span>
          li.<span style="color: black;">innerHTML</span> <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">'Ping !'</span>
          ul.<span style="color: black;">appendChild</span><span style="color: black;">&#40;</span>li<span style="color: black;">&#41;</span><span style="color: #66cc66;">;</span>
        <span style="color: black;">&#125;</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">;</span>
     <span style="color: black;">&#125;</span><span style="color: #66cc66;">;</span>
&nbsp;
     connection.<span style="color: #008000;">open</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">;</span>
    <span style="color: #66cc66;">&lt;</span>/script<span style="color: #66cc66;">&gt;</span>
<span style="color: #66cc66;">&lt;</span>/head<span style="color: #66cc66;">&gt;</span>
<span style="color: #66cc66;">&lt;</span>body<span style="color: #66cc66;">&gt;</span>
<span style="color: #66cc66;">&lt;</span>h2<span style="color: #66cc66;">&gt;</span>Ping me <span style="color: #66cc66;">!&lt;</span>/h2<span style="color: #66cc66;">&gt;</span>
&nbsp;
<span style="color: #66cc66;">&lt;</span>ul <span style="color: #008000;">id</span><span style="color: #66cc66;">=</span><span style="color: #483d8b;">&quot;ping&quot;</span><span style="color: #66cc66;">&gt;</span>
<span style="color: #66cc66;">&lt;</span>/ul<span style="color: #66cc66;">&gt;</span>
<span style="color: #66cc66;">&lt;</span>/body<span style="color: #66cc66;">&gt;</span>
<span style="color: #66cc66;">&lt;</span>/html<span style="color: #66cc66;">&gt;</span></pre></td></tr></table></div>

<p>On ouvre la console, on lance son routeur :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">    crossbar init
    crossbar start</pre></td></tr></table></div>

<p>On lance dans une autre console son serveur Django :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">.<span style="color: #000000; font-weight: bold;">/</span>manage.py runserver</pre></td></tr></table></div>

<p>Et si on navigue sur <code>http://127.0.0.1:8000</code>, on récupère un UUID tout frais via RCP.</p>
<p>On peut aussi voir dans le shell que ça marche côté Python :</p>
<pre>94cfccf0899d4c42950788fa655b65ed
ping</pre>
<p>D’ailleurs un fichier nommé &#8220;test&#8221; est créé à la racine du projet.</p>
<p>Et si on navigue sur <code>http://127.0.0.1:8000/ping/</code> et qu&#8217;on refresh <code>http://127.0.0.1:8000</code> plusieurs fois, on voit la page se mettre à jour.</p>
<p>Achievement unlock : use WAMP and Django code in the same file.</p>
<h2>A partir de là</h2>
<p>Il y a plein de choses à faire.</p>
<p>On pourrait faire une lib qui wrap tout ça pour pas à avoir à le mettre dans son fichier de vue et qui utilise settings.py pour la configuration.</p>
<p>Il faut tester ça avec des setups plus gros pour voir comment ça se comporte avec gunicorn, plusieurs workers, le logging de Django, etc. Je suis à peu près sûr que les callbacks vont être registrés plusieurs fois et ça devrait faire des erreurs dans les logs (rien de grave ceci dit).</p>
<p>On pourrait aussi adapter le RPC pour qu&#8217;il utilise les cookies d&#8217;authentification Django, et pouvoir les protéger avec @login_required.</p>
<p>Mais un monde d&#8217;opportunités s&#8217;offrent à vous à partir de là.</p>
<p>Moi, ça fait 6 h que je taffe dessus, je vais me pieuter.</p>
<hr />
<p><a href="https://github.com/sametmax/codes-des-articles/tree/master/2015/janvier/wamp_et_django">Télécharger le code de l&#8217;article</a></p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/les-managers-le-detestent-faites-tourner-wamp-dans-django-avec-cette-astuce-insolite/feed/</wfw:commentRss>
		<slash:comments>11</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2015/01/index.jpeg" length="10867" type="image/jpg" />	</item>
		<item>
		<title>Bridge HTTP/WAMP 5</title>
		<link>http://sametmax.com/bridge-httpwamp/</link>
		<comments>http://sametmax.com/bridge-httpwamp/#comments</comments>
		<pubDate>Mon, 29 Dec 2014 10:07:59 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[bridge]]></category>
		<category><![CDATA[http]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[wamp]]></category>
		<category><![CDATA[wamp.ws]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=13072</guid>
		<description><![CDATA[Le principe : faire un client WAMP qui soit aussi client HTTP avec une API REST.]]></description>
				<content:encoded><![CDATA[<p>Il y a 4 gros freins à l&#8217;adoption de <a href="http://sametmax.com/presentation-de-wamp-round-2/">WAMP</a> :</p>
<ol>
<li>L&#8217;incompréhension de la techno. Les gens ne voient pas à quoi ça sert, ce qu&#8217;ils peuvent faire avec, et ont peur. Logique. Je vais pas les blâmer, c&#8217;est pareil avec toute nouvelle techo. S&#8217;investir dans un nouveau truc a un coût, surtout un truc jeune.</li>
<li>La doc. je vais travailler sur la question, mais c&#8217;est un travail de fond.</li>
<li>L&#8217;API : ça va avec les deux points plus haut. Il faut quelque chose de plus haut niveau. L&#8217;API <a href="http://sametmax.com/introduction-a-wamp-en-python/">flaskesque</a> est un bon début, il faut maintenant continuer dans ce sens.</li>
<li>L&#8217;intégration avec les anciennes technos. Par exemple, un site Django. Personne n&#8217;a envie de mettre toute son ancienne stack à la poubelle.</li>
</ol>
<p>Toute les libs qui introduisent une nouvelle façon de travailler rencontrent ce problème. Quand les ORM sont sortis, c&#8217;était pareil. Quand les Django et Rails, et Symfony sont sortis, c&#8217;était pareil.</p>
<p>Mais puisqu&#8217;on le sait, on peut agir.</p>
<p>Les 3 premiers points ont déjà un début de solution, ce qui nous intéresse c&#8217;est donc le 4ème point.</p>
<p>Il y a de nombreuses choses à faire pour l’intégration : authentification, actions bloquantes, communications&#8230;</p>
<p>On ne peut pas tout résoudre d&#8217;un coup, mais une solution qui ratisse large serait de créer un bridge HTTP/WAMP.</p>
<p>Le principe : faire un client WAMP qui soit aussi client HTTP avec une API REST.</p>
<h2>Fonctionnement</h2>
<p>En envoyant des requêtes HTTP avec un <a href="https://github.com/progrium/pyjwt">webtoken</a> pour s&#8217;authentifier, on peut faire un register/subscribe/call/publish sur le bridge en spécifiant une URL de callback. Le bridge transmet tout ça à routeur WAMP. Quand un événement arrive sur le bridge qui concerne une des URLs de callback, il fait une requête sur l&#8217;URL avec les infos arrivées via WAMP.</p>
<p>API :</p>
<p><code>POST /register/</code></p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family:monospace;"><span style="color: #009900;">&#123;</span>
    <span style="color: #006600; font-style: italic;">// token d'authentification</span>
    token<span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;fdjsklfqsdjm&quot;</span><span style="color: #339933;">,</span>
    <span style="color: #006600; font-style: italic;">// On enregistre des urls de callbacks pour chaque &quot;function&quot; exposées en RPC</span>
    <span style="color: #006600; font-style: italic;">// Quand le bridge reçoit un appel RPC via WAMP, il fera une requête POST</span>
    <span style="color: #006600; font-style: italic;">// sur la bonne URL. Votre app récupère les données via POST, et retourne</span>
    <span style="color: #006600; font-style: italic;">// du JSON que le bridge va transmettre via WAMP.</span>
    endpoints<span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span>
        <span style="color: #3366CC;">&quot;nom_fonction_1&quot;</span><span style="color: #339933;">:</span>  <span style="color: #3366CC;">&quot;http://localhost:8080/wamp/rpc/nom_fonction_1/&quot;</span><span style="color: #339933;">,</span>
        <span style="color: #3366CC;">&quot;nom_fonction_2&quot;</span><span style="color: #339933;">:</span>  <span style="color: #3366CC;">&quot;http://localhost:8080/wamp/rpc/nom_fonction_2/&quot;</span>
    <span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span></pre></td></tr></table></div>

<p><code>POST /subscribe/</code></p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family:monospace;"><span style="color: #009900;">&#123;</span>
    token<span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;fdjsklfqsdjm&quot;</span><span style="color: #339933;">,</span>
    <span style="color: #006600; font-style: italic;">// On enregistre des urls de callbacks chaque abonnement à un topic.</span>
    <span style="color: #006600; font-style: italic;">// Quand le bridge reçoit un message PUB via WAMP, il fera une requête POST</span>
    <span style="color: #006600; font-style: italic;">// sur la bonne URL. Votre app récupère les données via POST.</span>
    endpoints<span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span>
        <span style="color: #3366CC;">&quot;nom_fonction_1&quot;</span><span style="color: #339933;">:</span>  <span style="color: #3366CC;">&quot;http://localhost:8080/wamp/pub/nom_fonction_1/&quot;</span><span style="color: #339933;">,</span>
        <span style="color: #3366CC;">&quot;nom_fonction_2&quot;</span><span style="color: #339933;">:</span>  <span style="color: #3366CC;">&quot;http://localhost:8080/wamp/pub/nom_fonction_2/&quot;</span>
    <span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span></pre></td></tr></table></div>

<p><code>POST /call/nom_fonction/</code></p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family:monospace;"><span style="color: #009900;">&#123;</span>
    token<span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;fdjsklfqsdjm&quot;</span><span style="color: #339933;">,</span>
    <span style="color: #006600; font-style: italic;">// Le bridge fera l'appel RPC, récupère la valeur de retour, et la renvoie</span>
    <span style="color: #006600; font-style: italic;">// à cette URL via POST ou une erreur 500 en cas d'exception.</span>
    callback<span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;http://localhost:8080/wamp/callback/nom_fonction&quot;</span><span style="color: #339933;">,</span>
    <span style="color: #006600; font-style: italic;">// Les params à passer à l'appel RPC</span>
    params<span style="color: #339933;">:</span> <span style="color: #009900;">&#91;</span><span style="color: #3366CC;">'param1'</span><span style="color: #339933;">,</span> <span style="color: #3366CC;">'param2'</span><span style="color: #009900;">&#93;</span>
<span style="color: #009900;">&#125;</span></pre></td></tr></table></div>

<p><code>POST /publish/nom_sujet/</code></p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family:monospace;"><span style="color: #009900;">&#123;</span>
    token<span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;fdjsklfqsdjm&quot;</span><span style="color: #339933;">,</span>
    <span style="color: #006600; font-style: italic;">// Le bridge fera la publication WAMP</span>
    <span style="color: #006600; font-style: italic;">// Les params à passer lors de la publication</span>
    params<span style="color: #339933;">:</span> <span style="color: #009900;">&#91;</span><span style="color: #3366CC;">'param1'</span><span style="color: #339933;">,</span> <span style="color: #3366CC;">'param2'</span><span style="color: #009900;">&#93;</span>
<span style="color: #009900;">&#125;</span></pre></td></tr></table></div>

<p>On peut rajouter des fioritures : recharger le fichier de config qui contient les API keys, se désabonner, désinscrire un callback RPC, etc. </p>
<p>Bien entendu, du fait d&#8217;avoir un intermédiaire, c&#8217;est peu performant, mais suffisant pour permettre une communication entre des apps existantes et vos apps WAMP et mettre un pied dedans.</p>
<h2>Intégration poussée</h2>
<p>Ceci permet une intégration générique, de telle sorte que tout le monde puisse intégrer son app facilement avec quelques requêtes HTTP. Néanmoins, avoir un plugin pour son framework plug and play faciliterait la vie de beaucoup de gens.</p>
<p>Donc la partie 2, c&#8217;est de faire des apps pour les frameworks les plus courants qui wrappent tout ça.</p>
<p>Par exemple, pour Django, ça permettrait de faire :</p>
<p><code>settings.py</code></p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">WAMP_BRIDGE_URL <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">&quot;http://localhost:8181/&quot;</span></pre></td></tr></table></div>

<p><code>urls.py</code></p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">from</span> wamp_bridge.<span style="color: black;">adapters</span>.<span style="color: black;">django</span> <span style="color: #ff7700;font-weight:bold;">import</span> dispatcher
&nbsp;
urlpatterns +<span style="color: #66cc66;">=</span> <span style="color: black;">&#40;</span><span style="color: #483d8b;">''</span><span style="color: #66cc66;">,</span>
    url<span style="color: black;">&#40;</span><span style="color: #483d8b;">'/wamp/, dispatcher),
    ...
)</span></pre></td></tr></table></div>

<p><code>views.py</code></p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">from</span> wamp_bridge.<span style="color: black;">adapters</span>.<span style="color: black;">django</span> <span style="color: #ff7700;font-weight:bold;">import</span> publish<span style="color: #66cc66;">,</span> call<span style="color: #66cc66;">,</span> rpc<span style="color: #66cc66;">,</span> sub
&nbsp;
<span style="color: #66cc66;">@</span>rpc<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">def</span> nom_fonction_1<span style="color: black;">&#40;</span>val1<span style="color: #66cc66;">,</span> val2<span style="color: black;">&#41;</span>:
    <span style="color: #808080; font-style: italic;"># faire un truc</span>
&nbsp;
<span style="color: #66cc66;">@</span>sub<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">def</span> nom_topic_1<span style="color: black;">&#40;</span>val1<span style="color: #66cc66;">,</span> val2<span style="color: black;">&#41;</span>:
    <span style="color: #808080; font-style: italic;"># faire un truc</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> vue_normale<span style="color: black;">&#40;</span>request<span style="color: black;">&#41;</span>:
    publish<span style="color: black;">&#40;</span><span style="color: #483d8b;">'sujet'</span><span style="color: #66cc66;">,</span> <span style="color: black;">&#91;</span><span style="color: #483d8b;">'arg1'</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
    resultat <span style="color: #66cc66;">=</span> call<span style="color: black;">&#40;</span><span style="color: #483d8b;">'function'</span><span style="color: #66cc66;">,</span> <span style="color: black;">&#91;</span><span style="color: #483d8b;">'arg1'</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Ca répond pas à des questions du genre : &#8220;comment je fais pour garder mon authentification Django&#8221; mais c&#8217;est déjà super glucose.</p>
<h2>Implémentation</h2>
<p>On peut créer un bridge dans plein de langages, mais je pense que Python est le plus adapté.</p>
<p>Les clients JS utiliseraientt de toute façon nodeJS, qui n&#8217;a pas besoin de bridge, puisque déjà asynchrone. Un routeur en C demanderait de la compilation. PHP est trop moche. Java, c&#8217;est tout un bordel à setuper à chaque fois. C#, si il faut se taper Mono sous Linux&#8230;</p>
<p>En prime, le routeur crossbar est déjà en Python, donc a déjà tout sous la main pour le faire. On peut même penser à l&#8217;intégrer à crossbar plus tard histoire que ce soit batteries included.</p>
<p>Il faut une implémentation Python 2 et Python 3, donc une avec Twisted, et une avec asyncio.</p>
<p>Pour le client twisted, on peut fusionner le client WAMP ordinaire avec <a href="http://twistedmatrix.com/documents/14.0.0/web/howto/web-in-60/index.html</a> et <a href="https://github.com/dreid/treq">treq</a>.</p>
<p>Pour asyncio, il y a <a href="https://github.com/KeepSafe/aiohttp">aiohttp</a> qui fait client et serveur.</p>
<p>On met les clés API dans un fichier de conf ou une variable d&#8217;env, une auth via token, et yala.</p>
<p>C&#8217;est le genre de projet intéressant car pas trop gros, mais suffisamment complexe pour être un challenge surtout qu&#8217;il faudra des tests unitaires partout, de la doc, bref un truc propre.</p>
<p>Je laisse les specs là, des fois qu&#8217;il y ait quelqu&#8217;un qui ait des envies de code cet hiver et cherche un projet open source dans lequel se lancer.</p>
<p>Si on se sent un peut foufou, on peut même transformer ça en bridget HTTP <=> anything, avec des backends pour ce qu&#8217;on veut : IRC, XMPP, Redis, Trigger Happy&#8230;</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/bridge-httpwamp/feed/</wfw:commentRss>
		<slash:comments>5</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2014/12/UERQMjQ1YlE2Rmsx_o_robin-hood-men-in-tights-bridge-fight.jpg" length="15115" type="image/jpg" />	</item>
		<item>
		<title>Corrections des slides WAMP 8</title>
		<link>http://sametmax.com/corrections-des-slides-wamp/</link>
		<comments>http://sametmax.com/corrections-des-slides-wamp/#comments</comments>
		<pubDate>Thu, 25 Dec 2014 09:58:47 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[autobhan]]></category>
		<category><![CDATA[crossbar]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[tavendo]]></category>
		<category><![CDATA[wamp]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=13011</guid>
		<description><![CDATA[Suites aux commentaires, j'ai fais une refonte des dispos.]]></description>
				<content:encoded><![CDATA[<p>Suite aux commentaires, j&#8217;ai fais une refonte des dispos :</p>
<ul>
<li>Plus d&#8217;insistance sur la différence entre RPC et PUB/SUB.</li>
<li>Les exemples sont amenés plus tôt, et les schémas sont en premier.</li>
<li>Des lourdeurs et des redondances sont supprimées.</li>
<li>J&#8217;ai ajouté des réponses à quelques questions posées : perf, sécu, etc.</li>
</ul>
<p>Histoire d&#8217;éviter d&#8217;éparpiller des versions partout, je l&#8217;ai juste réup <a href="http://sametmax.com/presentation-de-wamp-round-2/">au même endroit</a>.</p>
<p>Merci, donc, pour toutes les remarques qui ont significativement permises d&#8217;améliorer la prez.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/corrections-des-slides-wamp/feed/</wfw:commentRss>
		<slash:comments>8</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2014/12/giphy.gif" length="616980" type="image/jpg" />	</item>
		<item>
		<title>Full disclosure 28</title>
		<link>http://sametmax.com/full-disclosure/</link>
		<comments>http://sametmax.com/full-disclosure/#comments</comments>
		<pubDate>Tue, 16 Dec 2014 15:32:26 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Philo et culture]]></category>
		<category><![CDATA[autobahn]]></category>
		<category><![CDATA[crossbar]]></category>
		<category><![CDATA[evangelism]]></category>
		<category><![CDATA[meta]]></category>
		<category><![CDATA[wamp]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=12883</guid>
		<description><![CDATA[On m'a contacté pour me demander si je n'étais pas chaud pour faire de l'évangélisme, rémunéré, autour de WAMP, Autobahn et Crossbar.]]></description>
				<content:encoded><![CDATA[<p>Depuis quelques jours je suis en discussion avec Tobias de Tavendo. Comme vous avez pu le remarquer avec mes précédents articles sur <a href="http://sametmax.com/crossbar-le-futur-des-applications-web-python/">WAMP</a> et <a href="http://sametmax.com/le-potentiel-de-wamp-autobahn-et-crossbar-io/">Crossbar</a> :</p>
<ul>
<li>Ils sont bons techniquement, et nuls pour expliquer ce qu&#8217;ils ont techniqué.</li>
<li>Cette techno est une techno de rêve pour moi. J&#8217;y crois à mort.</li>
<li>Je suis le seul à avoir pondu des explications décentes sur WAMP et Crossbar. Et ça n&#8217;a pas suffit à faire battre un cil.</li>
</ul>
<p>Bref, ils ont embauché des mecs de haute voltige pour la technique (du genre un contributeur PyPy). Et ils m&#8217;ont contacté pour me demander si je n&#8217;étais pas chaud pour faire de l&#8217;évangélisme, rémunéré, autour de WAMP, Autobahn et Crossbar.</p>
<p>L&#8217;idée : écrire des tutos, des articles, améliorer la doc, répondre sur le chan IRC, etc.</p>
<p>J&#8217;adore le concept, vu que j&#8217;aime leur projet et que je le faisais gratos avant, surtout qu&#8217;ils sont pas trop contraignants sur le temps que je vais passer dessus.</p>
<p>Donc voilà le deal : quand je vais pondre des tutos et des articles sur WAMP et Co, je vais d&#8217;abord les faire en français ici. Comme ça j&#8217;aurai les retours des lecteurs du blog qui pourront, comme d&#8217;habitude, me faire part de leurs douces remarques sur à quel point on ne pige rien.</p>
<p>Une fois la prose aiguisée, je traduis et je publie chez Tavendo.</p>
<p>Je disclose donc ici que vous verrez peut-être des prochaines rédactions qui seront attachées à une activité pro. Pas impartial donc. Mais bon, depuis quand je suis impartial ? Javascript c&#8217;est de la merde, et je préfère les rousses.</p>
<p>Par saucisse d&#8217;honnêteté, je signalerai chaque choucroute concernée avec un lien vers ce post.</p>
<p>Enfin, le contrat est pas signé encore, mais vu que je vais commencer à taffer dessus aujourd&#8217;hui, je pense à une première publication demain sous la forme d&#8217;un slide show expliquant avec de jolies diapos ce que sont WAMP, Autobahn et Crossbar. À quoi ça sert et ce qu&#8217;on peut faire avec.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/full-disclosure/feed/</wfw:commentRss>
		<slash:comments>28</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2014/12/0vC5kst.jpg" length="194264" type="image/jpg" />	</item>
		<item>
		<title>WAMP et les outils de dev Web Python existants 8</title>
		<link>http://sametmax.com/wamp-et-les-outils-de-dev-web-python-existants/</link>
		<comments>http://sametmax.com/wamp-et-les-outils-de-dev-web-python-existants/#comments</comments>
		<pubDate>Wed, 02 Jul 2014 05:21:09 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[wamp]]></category>
		<category><![CDATA[wsgi]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=11259</guid>
		<description><![CDATA[C'est tout naturellement qu'on a fini par me poser (par mail), ze question.]]></description>
				<content:encoded><![CDATA[<p>Même si on peut créer un site Web en utilisant uniquement des libs WAMP, tout comme on peut le faire en utilisant uniquement flask ou tornado, il arrive immanquablement le moment où on veut mélanger, intégrer, faire cohabiter les techos ensemble. D&#8217;abord parce qu&#8217;il y a des sites existants, et qu&#8217;on va pas les jeter à la poubelle. Ensuite parce que ce sont des techos qu&#8217;on connaît et pour lesquelles ils y a beaucoup d&#8217;outils, que l&#8217;on veut mettre à profit.</p>
<p>C&#8217;est tout naturellement qu&#8217;on a fini par me poser (par mail), ze question :</p>
<blockquote><p>Subject: crossabar et autobahn</p>
<p>Message Body:<br />
Ha bah oui vous l&#8217;avez cherché à nous parler de truc comme ça: ça interroge !</p>
<p>Je m&#8217;interroge donc sur la manière d&#8217;intégrer WAMP à django. Pour la perstistence des données (l&#8217;ORM qui simplifie la création des tables tout de même), pour l&#8217;authentication et l&#8217;authorization, pour la robustesse et versatilité apportée par django&#8230;</p>
<p>J&#8217;ai pour habitude de mettre pas mal de logique dans mes modèles et je me demandais si il n&#8217;y aurait pas moyen de pluguer WAMP dans ceux ci&#8230; exposer une méthode update en RPC avec passage de JSON ? Avec namespace automatique à partir de la classe ? </p>
<p>En fait remplacer: Angular+tastypie+django+nginx par Angular+WAMP+django+crossbar avec du coup le bonus de WAMP pour le pubsub que n&#8217;a pas AJAX.</p>
<p>Comment vous verriez un (petit &#8211; après relecture ça parait dur) mixin WAMP pour des modèles django auto-détectés, auto-exposés en RPC ?</p>
<p>J&#8217;ai du mal à voir quelle tactique utiliser. J&#8217;ai peur que ça finisse en refaire tout le travail que fait déjà (très bien) tastypie/RESTframework.</p>
<p>Comment modulariser (là ou est sensé briller WAMP) les services déjà offerts par django: celery, authentication, etc ?<br />
Ces services sont tous très dépendant du système de persistance des données (check des users, permissions, query) et donc l&#8217;approche plus monolithique de django n&#8217;est pas mauvaise car tout est lié et donc facilement manipulable au même endroit&#8230; où est le gain de WAMP dans ce cas, pour une application assez classique en fait ?</p>
<p>Merci encore pour cette découverte dans tous les cas. C&#8217;est top.</p>
<p>Du coup je me relis et ça part un peu dans tous les sens&#8230; désolé.</p>
</blockquote>
<p>Comme je me suis fendu d&#8217;une réponse bien longue, je vais la paster verbatim :</p>
<blockquote><p>
Bonjour,</p>
<p>C&#8217;est une très bonne question.</p>
<p>D&#8217;abord, il faut savoir qu&#8217;on ne peut pas faire tourner un routeur WAMP dans un process Django (ou tout autre app WSGI) car Django est synchrone. En plus, l&#8217;ORM de django est bloquant, donc même sans utiliser django, utiliser son ORM au sein de WAMP va bloquer la boucle d&#8217;événements et on perdra tout l&#8217;interêt d&#8217;avoir une techno temps réel.</p>
<p>(Note a posteriori : y a surement un truc à faire avec gevent ou des threads ici, mais je sais pas encore quoi)</p>
<p>Ici on a donc 3 problèmes à résoudre :</p>
<p>&#8211; comment faire communiquer django et son app WAMP ?<br />
&#8211; comment utiliser un ORM bloquant avec WAMP ?<br />
&#8211; comment auto générer une API WAMP ?</p>
<p>Ces 3 questions n&#8217;ont pas encore de réponse définitive puisque, comme je l&#8217;ai précisé, WAMP est une techno jeune, et donc il y a beaucoup à faire. Mes articles sont précisément là pour tenter de générer un enthousiasme et pousser les gens à améliorer les outils autour de WAMP.</p>
<p>Prenons les problèmes un par un :</p>
<p>Comment faire communiquer django et son app WAMP ?<br />
====================================</p>
<p>C&#8217;est le problème le plus facile à mon sens. Il faut coder une app WAMP qui fasse le bridge entre HTTP et WAMP. Quand on register côté app HTTP, on fait un post sur l&#8217;app WAMP (qui écoute aussi sur HTTP du coup) en fournissant une URL de callback. L&#8217;app WAMP fait le register, et quand on l&#8217;appelle, elle fait l&#8217;appel à l&#8217;app HTTP via l&#8217;url de callback, et retourne le résultat. On peut faire ça pour register, subscribe, call et publish, c&#8217;est le même principe.</p>
<p>(Note a posteriori : en me relisant moi-même je m&#8217;aperçois à quel point c&#8217;est pas clair. De toute façon il faudra que je le code un jour où l&#8217;autre, et avec un bon tuto pratique, la pilule passera mieux).</p>
<p>Ce faisant, on pourra appeler du WAMP côté app HTTP, et taper dans l&#8217;app HTTP côté client WAMP.</p>
<p>Une amorce de travail  a été fait pour coder un tel bridge. Pour le moment il n&#8217;y a que le publish :</p>
<p>https://groups.google.com/forum/#!searchin/autobahnws/http/autobahnws/SbobAnoWVlQ/FnGhdYXj9aIJ</p>
<p>Ce n&#8217;est pas très dur à coder, c&#8217;est juste un boulot chiant à faire.</p>
<p>Cela dit, ça ne résout pas le problème de l&#8217;authentification, qu&#8217;il faudra à un moment on un autre, se poser. Je pense qu&#8217;on va se diriger vers une authentification hybride, qui va utiliser le session ID en cookie, mais l&#8217;envoyer via un token. Encore un truc à travailler.</p>
<p>De même, on voudra sûrement créer quelques facilités pour intégrer ça dans les frameworks les plus connus en proposant une app prêt à plugger. Rien d&#8217;insurmontable donc, mais pas mal de taff.</p>
<p>Par contre, pour ce qui est des tasks queues, à mon avis une solution de task queue WAMP sera bien plus intéressante qu&#8217;une solution type celery car on peut envoyer des messages WAMP depuis les tâches et donc avertir en temps réel de l&#8217;avancement du process. Je voterais donc pour coder soi-même une alternative.</p>
<p>Comment utiliser un ORM bloquant avec WAMP ?<br />
===============================</p>
<p>Idéalement, il faudrait avoir des ORM non bloquant, mais on Python, on en a pas. On a quelques drivers non bloquant, notamment pour PostGres et Mongo, mais pas d&#8217;ORM, et ils demandent une forme de compilation d&#8217;extension C.</p>
<p>C&#8217;est là qu&#8217;on voit qu&#8217;on se traine la culture de l&#8217;API synchrone en Python, car côté NodeJS, ils commencent à avoir pas mal de solutions.</p>
<p>En l’occurrence, on a 3 solutions :</p>
<p>&#8211; utiliser le bridge dont je viens de parler pour garder les appels dans l&#8217;app HTTP.  Ca veut dire que quand on veut faire un appel à de la base de données, ça fait WAMP => HTTP => connexion à la base, aller-retour. C&#8217;est pas idéal.<br />
&#8211; créer une app WAMP pour héberger les appels bloquants et taper dedans en RPC. Une bonne solution à mon avis. Mais assez peu intuitive.<br />
&#8211; faire tous les appels dans un threads à part. Le plus simple. Un peu verbeux par contre.</p>
<p>Dans les deux derniers cas, on à quand même le problème des querysets qui sont lazy, notamment au niveau des foreign keys. Il faudra faire particulièrement attention à ne pas accidentellement faire des appels bloquant, par exemple dans le rendu du template. Une solution viable est de créer un wrapper qui fait le rendu du template dans un threads.</p>
<p>Bref, encore pas mal d&#8217;outils à developper.</p>
<p>On peut aussi se lancer dans l&#8217;écriture d&#8217;un ORM non bloquant. Une bonne année de travail avant d&#8217;avoir quelque chose qui soit compétitif.</p>
<p>Comment auto générer une API WAMP ?<br />
==========================</p>
<p>Là tu m&#8217;en poses une bonne.</p>
<p>C&#8217;est la suite logique, évidement, mais je n&#8217;avais jamais réfléchi aussi loin. C&#8217;est un taff énorme, surtout que ça dépend de l&#8217;outil derrière. La solution la plus simple c&#8217;est encore de faire un mapper dans le bridge HTTP-WAMP qui va traduire directement un appel WAMP en un appel JSON vers l&#8217;API générée par django-rest-framework ou autre.</p>
<p>Mais bon, je suis pas certains de la valeur ajoutée.</p>
<p>Je pense qu&#8217;il est difficile pour moi de répondre à cette question pour le moment car :</p>
<p>&#8211; je ne suis pas certain que WAMP soit un bon remplacement pour les API REST. Je pense plutôt que c&#8217;est un complément.<br />
&#8211; il y a toute la question de l&#8217;authentification. Encore et toujours.<br />
&#8211; il va falloir pas mal d&#8217;essais avec plusieurs architectures en prod (séparées, mixtes, mono culture&#8230;) pour pouvoir déterminer ce qui rend le mieux.</p>
<p>Mon intuition est qu&#8217;on utilise généralement 10% de l&#8217;API générée par les frameworks, et que la partie dont on a besoin à peut très bien se faire à la main. La raison pour laquelle les trucs comme django-rest-framework sont si pratiques, c&#8217;est qu&#8217;ils gèrent des problématiques comme l&#8217;authentification, la sérialisation et la pagination.</p>
<p>Je serais plutôt d&#8217;avis de s&#8217;attaquer à ça pour WAMP, et je pense qu&#8217;on s’apercevra que finalement, pour ses propres besoins, un API complète est overkill. Par contre, pour exposer une API au monde, c&#8217;est une autre histoire. J&#8217;ai eu récemment une discussion à propos de faire des APIs WAMP :) Il y a des possibilités fascinantes. Mais c&#8217;est peut être encore un peu loin tout ça.</p>
<p>Je pense que je vais publier cette réponse sur le blog, car tu soulèves des points très importants.</p></blockquote>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/wamp-et-les-outils-de-dev-web-python-existants/feed/</wfw:commentRss>
		<slash:comments>8</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2014/07/tumblr_n3pyweC7q71r539hzo1_500.png" length="804621" type="image/jpg" />	</item>
	</channel>
</rss>
