<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Sam &#38; Max &#187; dict</title>
	<atom:link href="http://sametmax.com/tag/dict/feed/" rel="self" type="application/rss+xml" />
	<link>http://sametmax.com</link>
	<description>Du code, du cul</description>
	<lastBuildDate>Sat, 07 Nov 2015 10:56:13 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>http://wordpress.org/?v=4.1</generator>
	<item>
		<title>Compter et  grouper : encore plus fainéant 6</title>
		<link>http://sametmax.com/compter-et-grouper-encore-plus-faineant/</link>
		<comments>http://sametmax.com/compter-et-grouper-encore-plus-faineant/#comments</comments>
		<pubDate>Wed, 01 Jul 2015 19:37:12 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[collections]]></category>
		<category><![CDATA[counter]]></category>
		<category><![CDATA[dict]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=16529</guid>
		<description><![CDATA[Après avoir bien galéré à créer un compteur à la main avec un dico, <a href="http://sametmax.com/aller-plus-loin-avec-les-hash-maps-en-python/">vous avez découvert</a> les joies des méthodes <code>dict.get</code> et <code>dict.setdefault</code>. Puis évidemment quelqu'un vous a pointé vers <code>collections.defaultdict</code>, et enfin, vous avez fini par découvrir <code>collections.Counter</code>. Joie.]]></description>
				<content:encoded><![CDATA[<p>Après avoir bien galéré à créer un compteur à la main avec un dico, <a href="http://sametmax.com/aller-plus-loin-avec-les-hash-maps-en-python/">vous avez découvert</a> les joies des méthodes <code>dict.get</code> et <code>dict.setdefault</code>. Puis évidemment quelqu&#8217;un vous a pointé vers <code>collections.defaultdict</code>, et enfin, vous avez fini par découvrir <code>collections.Counter</code>. Joie.</p>
<p>Le parcours est à peu près toujours le même quand on veut grouper ou compter des valeurs en Python.</p>
<p>Malgré cela, je vois encore des gens qui sous utilisent ces collections. Par exemple, <code>Counter</code> peut compter automatiquement :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">collections</span> <span style="color: #ff7700;font-weight:bold;">import</span> Counter
<span style="color: #66cc66;">&gt;&gt;&gt;</span> Counter<span style="color: black;">&#40;</span><span style="color: #483d8b;">'jfsqmfjdklmqfjsdqklmfjdsqhfdqsjkhfdshjkl'</span><span style="color: black;">&#41;</span>
    Counter<span style="color: black;">&#40;</span><span style="color: black;">&#123;</span><span style="color: #483d8b;">'j'</span>: <span style="color: #ff4500;">6</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'f'</span>: <span style="color: #ff4500;">6</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'q'</span>: <span style="color: #ff4500;">5</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'s'</span>: <span style="color: #ff4500;">5</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'d'</span>: <span style="color: #ff4500;">5</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'k'</span>: <span style="color: #ff4500;">4</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'l'</span>: <span style="color: #ff4500;">3</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'m'</span>: <span style="color: #ff4500;">3</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'h'</span>: <span style="color: #ff4500;">3</span><span style="color: black;">&#125;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Mais ce que ne réalisent pas beaucoup de développeurs, c&#8217;est que cet objet accepte n&#8217;importe quel itérable en paramètre. Nous sommes en Python, et rededjiou, je me tue à répéter que l&#8217;itération est la philosophie centrale du langage.</p>
<p>Donc le compteur peut prendre une expression génératrice en paramètre.</p>
<p>Par exemple, si vous voulez compter un truc un peu plus complexe que des éléments, comme mettons, le ratio de lignes commentées dans un fichier, vous n&#8217;avez pas besoin de faire ça :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">count <span style="color: #66cc66;">=</span> Counter<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">for</span> line <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">open</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'/etc/fstab'</span><span style="color: #66cc66;">,</span> encoding<span style="color: #66cc66;">=</span><span style="color: #483d8b;">'ascii'</span><span style="color: black;">&#41;</span>:
        count<span style="color: black;">&#91;</span>line.<span style="color: black;">startswith</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'#'</span><span style="color: black;">&#41;</span><span style="color: black;">&#93;</span> +<span style="color: #66cc66;">=</span> <span style="color: #ff4500;">1</span>
 <span style="color: #808080; font-style: italic;"># out : Counter({True: 10, False: 3})</span></pre></td></tr></table></div>

<p>Ceci marchera parfaitement :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">count <span style="color: #66cc66;">=</span> Counter<span style="color: black;">&#40;</span>line.<span style="color: black;">startswith</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'#'</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> line <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">open</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'/etc/fstab'</span><span style="color: #66cc66;">,</span> encoding<span style="color: #66cc66;">=</span><span style="color: #483d8b;">'ascii'</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #808080; font-style: italic;"># out : Counter({True: 10, False: 3})</span></pre></td></tr></table></div>

<p>Vous pouvez également utiliser des générateurs plus complexes. Combien de fichiers par types d&#8217;extensions ?</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">os</span>
<span style="color: #ff7700;font-weight:bold;">import</span> pathlib
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> get_extensions<span style="color: black;">&#40;</span>path<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">for</span> dirpath<span style="color: #66cc66;">,</span> dirnames<span style="color: #66cc66;">,</span> files <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #dc143c;">os</span>.<span style="color: black;">walk</span><span style="color: black;">&#40;</span>path<span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">for</span> name <span style="color: #ff7700;font-weight:bold;">in</span> files:
            ext <span style="color: #66cc66;">=</span> pathlib.<span style="color: black;">Path</span><span style="color: black;">&#40;</span>name<span style="color: black;">&#41;</span>.<span style="color: black;">suffix</span>
            <span style="color: #ff7700;font-weight:bold;">if</span> ext: <span style="color: #808080; font-style: italic;"># on ignore les fichiers sans extension</span>
                <span style="color: #ff7700;font-weight:bold;">yield</span> ext
&nbsp;
&nbsp;
Counter<span style="color: black;">&#40;</span>get_extensions<span style="color: black;">&#40;</span><span style="color: #483d8b;">'/etc'</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>.<span style="color: black;">most_common</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">9</span><span style="color: black;">&#41;</span>
 <span style="color: #808080; font-style: italic;"># Out : </span>
 <span style="color: #808080; font-style: italic;"># ('.conf', 632),</span>
 <span style="color: #808080; font-style: italic;"># ('.0', 348),</span>
 <span style="color: #808080; font-style: italic;"># ('.gz', 323),</span>
 <span style="color: #808080; font-style: italic;"># ('.jhansonxi', 207),</span>
 <span style="color: #808080; font-style: italic;"># ('.pem', 177),</span>
 <span style="color: #808080; font-style: italic;"># ('.load', 127),</span>
 <span style="color: #808080; font-style: italic;"># ('.ttb', 86),</span>
 <span style="color: #808080; font-style: italic;"># ('.ktb', 80),</span>
 <span style="color: #808080; font-style: italic;"># ('.kti', 55)]</span></pre></td></tr></table></div>

<p>Notez que le <code>Counter</code> peut faire plus que compter. Ici il nous donne les 9 plus grandes valeurs du classement, mais en prime, il peut aussi nous faire des opérations ensemblistes :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> c <span style="color: #66cc66;">=</span> Counter<span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;aabbbbbbbbbbbbcccc&quot;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> c &amp; Counter<span style="color: black;">&#40;</span><span style="color: #483d8b;">'aaaaaaaaaaaaaaabbcddddddd'</span><span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># valeurs min</span>
    Counter<span style="color: black;">&#40;</span><span style="color: black;">&#123;</span><span style="color: #483d8b;">'b'</span>: <span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'a'</span>: <span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'c'</span>: <span style="color: #ff4500;">1</span><span style="color: black;">&#125;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> c | Counter<span style="color: black;">&#40;</span><span style="color: #483d8b;">'aaaaaaaaaaaaaaabbcddddddd'</span><span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># valeurs max</span>
    Counter<span style="color: black;">&#40;</span><span style="color: black;">&#123;</span><span style="color: #483d8b;">'a'</span>: <span style="color: #ff4500;">15</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'b'</span>: <span style="color: #ff4500;">12</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'d'</span>: <span style="color: #ff4500;">7</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'c'</span>: <span style="color: #ff4500;">4</span><span style="color: black;">&#125;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Le compteur fournit par Python est donc naturellement très, très puissant.</p>
<p>Une autre chose qui est rarement faite : sous-classer ces types.</p>
<p>Par exemple, si vous avez souvent des opérations où il faut grouper des valeurs :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">collections</span> <span style="color: #ff7700;font-weight:bold;">import</span> defaultdict
&nbsp;
<span style="color: #ff7700;font-weight:bold;">class</span> Grouper<span style="color: black;">&#40;</span>defaultdict<span style="color: black;">&#41;</span>:
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__init__</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> iterable<span style="color: black;">&#41;</span>:
        <span style="color: #008000;">super</span><span style="color: black;">&#40;</span>Grouper<span style="color: #66cc66;">,</span> <span style="color: #008000;">self</span><span style="color: black;">&#41;</span>.<span style="color: #0000cd;">__init__</span><span style="color: black;">&#40;</span><span style="color: #008000;">list</span><span style="color: black;">&#41;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">update</span><span style="color: black;">&#40;</span>iterable<span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> update<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> iterable<span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">try</span>:
            iterable <span style="color: #66cc66;">=</span> iterable.<span style="color: black;">items</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: #008000;">AttributeError</span>:
            iterable <span style="color: #66cc66;">=</span> iterable
        <span style="color: #ff7700;font-weight:bold;">for</span> k<span style="color: #66cc66;">,</span> v <span style="color: #ff7700;font-weight:bold;">in</span> iterable:
            <span style="color: #008000;">self</span><span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span>.<span style="color: black;">append</span><span style="color: black;">&#40;</span>v<span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>On prend un default dict, on lui dit qu&#8217;un update ajoute les éléments à la liste en valeur plutôt que de la remplacer, et zou, vous avez un dictionnaire qui va grouper toutes les valeurs automatiquement.</p>
<p>Liste des fichiers par extensions ? Fastoche !</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> get_extensions<span style="color: black;">&#40;</span>path<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">for</span> dirpath<span style="color: #66cc66;">,</span> dirnames<span style="color: #66cc66;">,</span> files <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #dc143c;">os</span>.<span style="color: black;">walk</span><span style="color: black;">&#40;</span>path<span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">for</span> name <span style="color: #ff7700;font-weight:bold;">in</span> files:
            ext <span style="color: #66cc66;">=</span> pathlib.<span style="color: black;">Path</span><span style="color: black;">&#40;</span>name<span style="color: black;">&#41;</span>.<span style="color: black;">suffix</span>
            <span style="color: #ff7700;font-weight:bold;">if</span> ext: 
                <span style="color: #ff7700;font-weight:bold;">yield</span> ext<span style="color: #66cc66;">,</span> name <span style="color: #808080; font-style: italic;"># on rajoute le name ici</span>
&nbsp;
<span style="color: #66cc66;">&gt;&gt;&gt;</span>files <span style="color: #66cc66;">=</span> Grouper<span style="color: black;">&#40;</span>get_extensions<span style="color: black;">&#40;</span><span style="color: #483d8b;">'/etc'</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> files<span style="color: black;">&#91;</span><span style="color: #483d8b;">'.tti'</span><span style="color: black;">&#93;</span>
<span style="color: black;">&#91;</span><span style="color: #483d8b;">'en-na-ascii.tti'</span><span style="color: #66cc66;">,</span>
 <span style="color: #483d8b;">'numbers-french.tti'</span><span style="color: #66cc66;">,</span>
 <span style="color: #483d8b;">'devanagari.tti'</span><span style="color: #66cc66;">,</span>
 <span style="color: #483d8b;">'letters-cyrillic.tti'</span><span style="color: #66cc66;">,</span>
 <span style="color: #483d8b;">'punctuation-basic.tti'</span><span style="color: #66cc66;">,</span>
 <span style="color: #483d8b;">'malayalam.tti'</span><span style="color: #66cc66;">,</span>
 <span style="color: #483d8b;">'ascii-basic.tti'</span><span style="color: #66cc66;">,</span>
 <span style="color: #483d8b;">'spaces.tti'</span><span style="color: #66cc66;">,</span>
 <span style="color: #483d8b;">'letters-latin.tti'</span><span style="color: #66cc66;">,</span>
 <span style="color: #483d8b;">'letters-latin-dot8.tti'</span><span style="color: #66cc66;">,</span>
 <span style="color: #483d8b;">'en-chess.tti'</span><span style="color: #66cc66;">,</span>
 <span style="color: #483d8b;">'numbers-dot8.tti'</span><span style="color: #66cc66;">,</span>
 <span style="color: #483d8b;">'punctuation-tibetan.tti'</span><span style="color: #66cc66;">,</span>
 <span style="color: #483d8b;">'boxes.tti'</span><span style="color: #66cc66;">,</span>
 <span style="color: #483d8b;">'gujarati.tti'</span><span style="color: #66cc66;">,</span>
 <span style="color: #483d8b;">'numbers-nemeth.tti'</span><span style="color: #66cc66;">,</span>
 <span style="color: #483d8b;">'punctuation-alternate.tti'</span><span style="color: #66cc66;">,</span>
 <span style="color: #483d8b;">'common.tti'</span><span style="color: #66cc66;">,</span>
 <span style="color: #483d8b;">'blocks.tti'</span><span style="color: #66cc66;">,</span>
 <span style="color: #483d8b;">'gurmukhi.tti'</span><span style="color: #66cc66;">,</span>
 <span style="color: #483d8b;">'kannada.tti'</span><span style="color: #66cc66;">,</span>
 <span style="color: #483d8b;">'telugu.tti'</span><span style="color: #66cc66;">,</span>
 <span style="color: #483d8b;">'tamil.tti'</span><span style="color: #66cc66;">,</span>
 <span style="color: #483d8b;">'numbers-dot6.tti'</span><span style="color: #66cc66;">,</span>
 <span style="color: #483d8b;">'de-chess.tti'</span><span style="color: #66cc66;">,</span>
 <span style="color: #483d8b;">'control-latin.tti'</span><span style="color: #66cc66;">,</span>
 <span style="color: #483d8b;">'letters-tibetan.tti'</span><span style="color: #66cc66;">,</span>
 <span style="color: #483d8b;">'oriya.tti'</span><span style="color: #66cc66;">,</span>
 <span style="color: #483d8b;">'bengali.tti'</span><span style="color: black;">&#93;</span></pre></td></tr></table></div>

<p>Bref, compter et grouper sont des opérations si communes : ne vous faites par chier à refaire tout ça à la main.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/compter-et-grouper-encore-plus-faineant/feed/</wfw:commentRss>
		<slash:comments>6</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2015/07/DVKgxFH.gif" length="510930" type="image/jpg" />	</item>
		<item>
		<title>Views VS generators 6</title>
		<link>http://sametmax.com/views-vs-generators/</link>
		<comments>http://sametmax.com/views-vs-generators/#comments</comments>
		<pubDate>Wed, 25 Mar 2015 18:57:20 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[dict]]></category>
		<category><![CDATA[generator]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[view]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=15993</guid>
		<description><![CDATA[Avec Python 2.7, un outil appelé les "views" (les "vues") est apparu. Une vue est juste un enrobage qui permet de voir un objet d'une certaine façon, et de le manipuler d'une certaine façon (avec une autre API), sans changer cet objet.]]></description>
				<content:encoded><![CDATA[<p>Avec Python 2.7, un outil appelé les &#8220;views&#8221; (les &#8220;vues&#8221;) est apparu. Une vue est juste un enrobage qui permet de voir un objet d&#8217;une certaine façon, et de le manipuler d&#8217;une certaine façon (avec une autre API), sans changer cet objet.</p>
<p>Les vues ont surtout été notables pour leur apparition dans les dictionnaires avec Python 2.7:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">    <span style="color: #66cc66;">&gt;&gt;&gt;</span> scores <span style="color: #66cc66;">=</span> <span style="color: black;">&#123;</span><span style="color: #483d8b;">&quot;sam&quot;</span>: <span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">&quot;max&quot;</span>: <span style="color: #ff4500;">0</span><span style="color: black;">&#125;</span>
    <span style="color: #66cc66;">&gt;&gt;&gt;</span> scores.<span style="color: black;">items</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># retourne une lsite</span>
    <span style="color: black;">&#91;</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'max'</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">0</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: black;">&#40;</span><span style="color: #483d8b;">'sam'</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span><span style="color: black;">&#93;</span>
    <span style="color: #66cc66;">&gt;&gt;&gt;</span> scores.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># retourne un générateur</span>
    <span style="color: #66cc66;">&lt;</span>dictionary-itemiterator <span style="color: #008000;">object</span> at <span style="color: #ff4500;">0x7f8782a26628</span><span style="color: #66cc66;">&gt;</span>
    <span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">list</span><span style="color: black;">&#40;</span>scores.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># sans views</span>
    <span style="color: black;">&#91;</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'max'</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">0</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: black;">&#40;</span><span style="color: #483d8b;">'sam'</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span><span style="color: black;">&#93;</span>
    <span style="color: #66cc66;">&gt;&gt;&gt;</span> scores.<span style="color: black;">viewsitems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># avec views</span>
    Traceback <span style="color: black;">&#40;</span>most recent call last<span style="color: black;">&#41;</span>:
      File <span style="color: #483d8b;">&quot;&lt;ipython-input-12-dc0b08011047&gt;&quot;</span><span style="color: #66cc66;">,</span> line <span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #66cc66;">&lt;</span>module<span style="color: #66cc66;">&gt;</span>
        scores.<span style="color: black;">viewsitems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># avec views</span>
    <span style="color: #008000;">AttributeError</span>: <span style="color: #483d8b;">'dict'</span> <span style="color: #008000;">object</span> has no attribute <span style="color: #483d8b;">'viewsitems'</span>
&nbsp;
    <span style="color: #66cc66;">&gt;&gt;&gt;</span> scores.<span style="color: black;">viewitems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># retourne une vue</span>
    dict_items<span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'max'</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">0</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: black;">&#40;</span><span style="color: #483d8b;">'sam'</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Néanmoins personne ne les a vraiment utilisé, et c&#8217;est un tort. Elles sont en effet très performantes, et pour cette raison sont retournées par défaut avec <code>items()</code> en Python 3.</p>
<p>En effet, les vues ne sont qu&#8217;un enrobage : elles ne contiennent rien, et donc ne prennent pas beaucoup mémoire, tout comme les générateurs.</p>
<p>Mais contrairement aux générateurs, les vues ne se vident pas et peuvent exposer une API plus complète que les générateurs, comme par exemple déclarer une taille :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> items <span style="color: #66cc66;">=</span> scores.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">list</span><span style="color: black;">&#40;</span>items<span style="color: black;">&#41;</span>
<span style="color: black;">&#91;</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'max'</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">0</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: black;">&#40;</span><span style="color: #483d8b;">'sam'</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">list</span><span style="color: black;">&#40;</span>items<span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># woops</span>
<span style="color: black;">&#91;</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> items <span style="color: #66cc66;">=</span> scores.<span style="color: black;">viewitems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">list</span><span style="color: black;">&#40;</span>items<span style="color: black;">&#41;</span>
<span style="color: black;">&#91;</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'max'</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">0</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: black;">&#40;</span><span style="color: #483d8b;">'sam'</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">list</span><span style="color: black;">&#40;</span>items<span style="color: black;">&#41;</span>
<span style="color: black;">&#91;</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'max'</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">0</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: black;">&#40;</span><span style="color: #483d8b;">'sam'</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">len</span><span style="color: black;">&#40;</span>scores.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># nope</span>
Traceback <span style="color: black;">&#40;</span>most recent call last<span style="color: black;">&#41;</span>:
  File <span style="color: #483d8b;">&quot;&lt;ipython-input-21-9c7f250da51d&gt;&quot;</span><span style="color: #66cc66;">,</span> line <span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #66cc66;">&lt;</span>module<span style="color: #66cc66;">&gt;</span>
    <span style="color: #008000;">len</span><span style="color: black;">&#40;</span>scores.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #008000;">TypeError</span>: <span style="color: #008000;">object</span> of <span style="color: #008000;">type</span> <span style="color: #483d8b;">'dictionary-itemiterator'</span> has no <span style="color: #008000;">len</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">len</span><span style="color: black;">&#40;</span>scores.<span style="color: black;">viewitems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #ff4500;">2</span></pre></td></tr></table></div>

<p>Alors certes, on ne peut pas mettre des vues partout, et les générateurs restent utiles. Mais quand il est possible de les utiliser, et à moins d&#8217;avoir besoin d&#8217;une liste afin de modifier les valeurs in place, il n&#8217;y pas de raison de ne pas le faire : c&#8217;est le meilleur des deux mondes. </p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/views-vs-generators/feed/</wfw:commentRss>
		<slash:comments>6</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2015/03/magic-realism-paintings-illusions-rob-gonsalves-11.jpg" length="398794" type="image/jpg" />	</item>
		<item>
		<title>Chercher dans plusieurs dicts à la fois avec ChainMap 14</title>
		<link>http://sametmax.com/chercher-dans-plusieurs-dicts-a-la-fois-avec-chainmap/</link>
		<comments>http://sametmax.com/chercher-dans-plusieurs-dicts-a-la-fois-avec-chainmap/#comments</comments>
		<pubDate>Fri, 11 Jul 2014 08:09:25 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[dico]]></category>
		<category><![CDATA[dict]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=11382</guid>
		<description><![CDATA[Depuis Python 3.3 existe un nouvel outil pour travailler avec les dicos et j'étais complètement passé à côté : <a href="https://docs.python.org/3.3/library/collections.html#collections.ChainMap">ChainMap</a>.]]></description>
				<content:encoded><![CDATA[<p>Depuis Python 3.3 existe un nouvel outil pour travailler avec les dicos et j&#8217;étais complètement passé à côté : <a href="https://docs.python.org/3.3/library/collections.html#collections.ChainMap">ChainMap</a>.</p>
<p>Il permet de créer un objet qui se comporte comme un <a href="http://sametmax.com/aller-plus-loin-avec-les-hash-maps-en-python/">dict</a>, mais qui va chercher dans plusieurs dictionnaires.</p>
<p>Un exemple sera plus clair.</p>
<p>Imaginez que vous ayez un système de configuration avec des valeurs par défaut :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">default_config <span style="color: #66cc66;">=</span> <span style="color: black;">&#123;</span><span style="color: #483d8b;">'DEBUG'</span>: <span style="color: #008000;">False</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'HOST'</span>: <span style="color: #483d8b;">'localhost'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'PORT'</span>: <span style="color: #ff4500;">8080</span><span style="color: black;">&#125;</span></pre></td></tr></table></div>

<p>Puis votre utilisateur peut fournir un fichier de configuration <code>settings.py</code> qui contient :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">DEBUG <span style="color: #66cc66;">=</span> <span style="color: #008000;">True</span>
PORT <span style="color: #66cc66;">=</span> <span style="color: #ff4500;">8000</span></pre></td></tr></table></div>

<p>Et avec un peu de parsing, vous le récupérez sous forme de dico :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> settings
user_config <span style="color: #66cc66;">=</span> <span style="color: black;">&#123;</span>k: v <span style="color: #ff7700;font-weight:bold;">for</span> k<span style="color: #66cc66;">,</span> v <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">vars</span><span style="color: black;">&#40;</span>settings<span style="color: black;">&#41;</span>.<span style="color: black;">items</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k.<span style="color: black;">isupper</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#125;</span>
<span style="color: #808080; font-style: italic;">## {'DEBUG': True, 'PORT': 8000}</span></pre></td></tr></table></div>

<p>Puis l&#8217;utilisateur peut passer la config via la ligne de commande, et une fois il fait :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">--host 0.0.0.0</pre></td></tr></table></div>

<p>Et vous récupérez la config :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">cmd_config <span style="color: #66cc66;">=</span> <span style="color: black;">&#123;</span><span style="color: #483d8b;">&quot;HOST&quot;</span>: <span style="color: #483d8b;">&quot;0.0.0.0&quot;</span><span style="color: black;">&#125;</span></pre></td></tr></table></div>

<p>Maintenant il faut prendre tout ça en compte. La ligne de commande écrase le fichier de config qui écrase les valeurs par défaut :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">conf <span style="color: #66cc66;">=</span> <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span>
conf.<span style="color: black;">update</span><span style="color: black;">&#40;</span>default_config<span style="color: black;">&#41;</span>
conf.<span style="color: black;">update</span><span style="color: black;">&#40;</span>user_config<span style="color: black;">&#41;</span>
conf.<span style="color: black;">update</span><span style="color: black;">&#40;</span>cmd_config<span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>conf<span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># configuration finale</span>
<span style="color: #808080; font-style: italic;">## {'DEBUG': True, 'HOST': '0.0.0.0', 'PORT': 8000}</span></pre></td></tr></table></div>

<p>Ça va marcher, mais ça a plusieurs défauts : </p>
<ul>
<li>Si vos dicos sont très grands, vous prenez encore plus de place en mémoire.</li>
<li>Si vous modifiez <code>conf</code>, impossible de savoir quelle était sa valeur initiale.</li>
<li>Si vous modifiez <code>user_config</code>, il faut tout refusionner. Mais si vous avez modifié <code>conf</code> entre temps, comment vous assurer que vous n&#8217;allez pas écraser ces modifications ?</li>
<li>Si vous voulez temporairement faire une modification à conf, il faut de nouveau créer un dico en plus avec tout dedans.</li>
</ul>
<p>ChainMap résout ce problème en cherchant une clé dans une liste de dicos sous-jacent, mais en appliquant les modifications uniquement sur le premier dico.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">collections</span> <span style="color: #ff7700;font-weight:bold;">import</span> ChainMap
&nbsp;
<span style="color: #66cc66;">&gt;&gt;&gt;</span> conf <span style="color: #66cc66;">=</span> ChainMap<span style="color: black;">&#40;</span><span style="color: black;">&#123;</span><span style="color: black;">&#125;</span><span style="color: #66cc66;">,</span> <span style="color: #808080; font-style: italic;"># &lt;- ce mapping sera le seul modifié</span>
                    <span style="color: #808080; font-style: italic;"># les clés seront cherchées dans cet ordre :</span>
                    cmd_config<span style="color: #66cc66;">,</span> 
                    user_config<span style="color: #66cc66;">,</span> 
                    default_config<span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #66cc66;">&gt;&gt;&gt;</span> conf<span style="color: black;">&#91;</span><span style="color: #483d8b;">'HOST'</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #483d8b;">'0.0.0.0'</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> conf<span style="color: black;">&#91;</span><span style="color: #483d8b;">'DEBUG'</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">True</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> conf<span style="color: black;">&#91;</span><span style="color: #483d8b;">'PORT'</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff4500;">8000</span></pre></td></tr></table></div>

<p>Les dicos sont ici stockés par référence, ça ne prend pas de mémoire en plus, et si on modifie un dico :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">user_config<span style="color: black;">&#91;</span><span style="color: #483d8b;">'DEBUG'</span><span style="color: black;">&#93;</span> <span style="color: #66cc66;">=</span> <span style="color: #008000;">False</span></pre></td></tr></table></div>

<p>Alors c&#8217;est reflété par <code>ChainMap</code>:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> conf<span style="color: black;">&#91;</span><span style="color: #483d8b;">'DEBUG'</span><span style="color: black;">&#93;</span>
<span style="color: #008000;">False</span></pre></td></tr></table></div>

<p>Si on fait une modification, seul le dico le plus haut dans la chaine (ici notre dico vide), est modifié :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> conf<span style="color: black;">&#91;</span><span style="color: #483d8b;">&quot;PORT&quot;</span><span style="color: black;">&#93;</span> <span style="color: #66cc66;">=</span> <span style="color: #ff4500;">7777</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> conf
ChainMap<span style="color: black;">&#40;</span><span style="color: black;">&#123;</span><span style="color: #483d8b;">'PORT'</span>: <span style="color: #ff4500;">7777</span><span style="color: black;">&#125;</span><span style="color: #66cc66;">,</span> <span style="color: black;">&#123;</span><span style="color: #483d8b;">'HOST'</span>: <span style="color: #483d8b;">'0.0.0.0'</span><span style="color: black;">&#125;</span><span style="color: #66cc66;">,</span> <span style="color: black;">&#123;</span><span style="color: #483d8b;">'DEBUG'</span>: <span style="color: #008000;">False</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'PORT'</span>: <span style="color: #ff4500;">8000</span><span style="color: black;">&#125;</span><span style="color: #66cc66;">,</span> <span style="color: black;">&#123;</span><span style="color: #483d8b;">'DEBUG'</span>: <span style="color: #008000;">False</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'HOST'</span>: <span style="color: #483d8b;">'localhost'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'PORT'</span>: <span style="color: #ff4500;">8080</span><span style="color: black;">&#125;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Et si on a besoin d&#8217;un contexte temporaire, on peut créer un enfant :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> sub_conf <span style="color: #66cc66;">=</span> conf.<span style="color: black;">new_child</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> sub_conf
ChainMap<span style="color: black;">&#40;</span><span style="color: black;">&#123;</span><span style="color: black;">&#125;</span><span style="color: #66cc66;">,</span> <span style="color: black;">&#123;</span><span style="color: #483d8b;">'PORT'</span>: <span style="color: #ff4500;">7777</span><span style="color: black;">&#125;</span><span style="color: #66cc66;">,</span> <span style="color: black;">&#123;</span><span style="color: #483d8b;">'HOST'</span>: <span style="color: #483d8b;">'0.0.0.0'</span><span style="color: black;">&#125;</span><span style="color: #66cc66;">,</span> <span style="color: black;">&#123;</span><span style="color: #483d8b;">'DEBUG'</span>: <span style="color: #008000;">False</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'PORT'</span>: <span style="color: #ff4500;">8000</span><span style="color: black;">&#125;</span><span style="color: #66cc66;">,</span> <span style="color: black;">&#123;</span><span style="color: #483d8b;">'DEBUG'</span>: <span style="color: #008000;">False</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'HOST'</span>: <span style="color: #483d8b;">'localhost'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'PORT'</span>: <span style="color: #ff4500;">8080</span><span style="color: black;">&#125;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Cela crée un nouveau ChainMap, avec un dico vide en haut de la chaîne, qui permet donc de travailler temporairement avec de nouvelles valeurs, sans toucher au ChainMap d&#8217;origine. </p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/chercher-dans-plusieurs-dicts-a-la-fois-avec-chainmap/feed/</wfw:commentRss>
		<slash:comments>14</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2014/07/tumblr_n5nx1iJWNQ1r539hzo1_500.jpg" length="184953" type="image/jpg" />	</item>
		<item>
		<title>Aller plus loin avec les hash maps en Python 21</title>
		<link>http://sametmax.com/aller-plus-loin-avec-les-hash-maps-en-python/</link>
		<comments>http://sametmax.com/aller-plus-loin-avec-les-hash-maps-en-python/#comments</comments>
		<pubDate>Mon, 30 Jun 2014 03:28:26 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[dico]]></category>
		<category><![CDATA[dict]]></category>
		<category><![CDATA[dictionnaire]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=11217</guid>
		<description><![CDATA[Les hash map sont souvent sous-utilisés, surtout par les personnes venant d'un autre langage avec implémentation vraiment batardes du concept. Les array en PHP et les objet en Javascript étant parmi les pires exemples.]]></description>
				<content:encoded><![CDATA[<p>Les hash map sont souvent sous-utilisés, surtout par les personnes venant d&#8217;un autre langage avec implémentation vraiment batarde du concept. Les arrays en PHP et les objets en Javascript étant parmi les pires exemples.</p>
<p>Le point d&#8217;entrée pour les hash maps en Python, c&#8217;est le dictionnaire. Et la plupart des gens ont pigé le principe de l&#8217;association clé / valeur :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> d <span style="color: #66cc66;">=</span> <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> d<span style="color: black;">&#91;</span><span style="color: #483d8b;">'cle'</span><span style="color: black;">&#93;</span> <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">'valeur'</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> d<span style="color: black;">&#91;</span><span style="color: #483d8b;">'cle'</span><span style="color: black;">&#93;</span>
<span style="color: #483d8b;">'valeur'</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> d<span style="color: black;">&#91;</span><span style="color: #483d8b;">'pas cle'</span><span style="color: black;">&#93;</span>
Traceback <span style="color: black;">&#40;</span>most recent call last<span style="color: black;">&#41;</span>:
  File <span style="color: #483d8b;">&quot;&lt;ipython-input-12-eed7cf6f5344&gt;&quot;</span><span style="color: #66cc66;">,</span> line <span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #66cc66;">&lt;</span>module<span style="color: #66cc66;">&gt;</span>
    d<span style="color: black;">&#91;</span><span style="color: #483d8b;">'pas cle'</span><span style="color: black;">&#93;</span>
<span style="color: #008000;">KeyError</span>: <span style="color: #483d8b;">'pas cle'</span></pre></td></tr></table></div>

<p>L’intérêt du dictionnaire étant qu&#8217;accéder à une clé est très rapide (c&#8217;est <a href="http://sametmax.com/complexite-algorithmique-pourquoi-tant-de-n/">une opération O(1)</a>), tout comme vérifier qu&#8217;une clé est présente dans le dico :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #483d8b;">'cle'</span> <span style="color: #ff7700;font-weight:bold;">in</span> d
<span style="color: #008000;">True</span></pre></td></tr></table></div>

<p>Mais généralement les gens s&#8217;arrêtent là.</p>
<h2>Itération</h2>
<p>Parfois, ils vont plus loin, et tentent l&#8217;itération dessus :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> scores <span style="color: #66cc66;">=</span> <span style="color: black;">&#123;</span><span style="color: #483d8b;">&quot;Joe&quot;</span>: <span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">&quot;Jonh&quot;</span>: <span style="color: #ff4500;">5</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">&quot;Jack&quot;</span>: <span style="color: #ff4500;">3</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">&quot;Jenny&quot;</span>: <span style="color: #ff4500;">7</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">&quot;Jeanne&quot;</span>: <span style="color: #ff4500;">0</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">&quot;July&quot;</span>: <span style="color: #ff4500;">3</span><span style="color: black;">&#125;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">for</span> score <span style="color: #ff7700;font-weight:bold;">in</span> scores:
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>score<span style="color: black;">&#41;</span>
...
<span style="color: black;">Jenny</span>
Jack
Joe
July
Jonh
Jeanne</pre></td></tr></table></div>

<p>Ils s’aperçoivent qu&#8217;on peut uniquement récupérer les clés, et essayent de faire ça :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">for</span> nom <span style="color: #ff7700;font-weight:bold;">in</span> scores:
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>nom<span style="color: #66cc66;">,</span> scores<span style="color: black;">&#91;</span>nom<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
...
<span style="color: black;">Jenny</span> <span style="color: #ff4500;">7</span>
Jack <span style="color: #ff4500;">3</span>
Joe <span style="color: #ff4500;">1</span>
July <span style="color: #ff4500;">3</span>
Jonh <span style="color: #ff4500;">5</span>
Jeanne <span style="color: #ff4500;">0</span></pre></td></tr></table></div>

<p>Rapidement ils sont corrigés par quelques collègues qui leur expliquent qu&#8217;on peut faire ceci :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">for</span> nom<span style="color: #66cc66;">,</span> score <span style="color: #ff7700;font-weight:bold;">in</span> scores.<span style="color: black;">items</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>nom<span style="color: #66cc66;">,</span> score<span style="color: black;">&#41;</span>
...
<span style="color: black;">Jenny</span> <span style="color: #ff4500;">7</span>
Jack <span style="color: #ff4500;">3</span>
Joe <span style="color: #ff4500;">1</span>
July <span style="color: #ff4500;">3</span>
Jonh <span style="color: #ff4500;">5</span>
Jeanne <span style="color: #ff4500;">0</span></pre></td></tr></table></div>

<p>Sans vraiment expliquer pourquoi. Si vous êtes curieux, cela marche grâce à l&#8217;<a href="http://sametmax.com/tag/unpacking/">unpacking</a>.</p>
<p>Ensuite ils vont chercher à afficher des choses dans l&#8217;ordre, mais un dictionnaire n&#8217;est pas ordonné. Là commencent les embrouilles : dans l&#8217;ordre des clés, des valeurs ou dans l&#8217;ordre d&#8217;insertion ?</p>
<p>Dans l&#8217;ordre des clés ou des valeurs, il faut se taper le <a href="http://sametmax.com/ordonner-en-python/">tri</a> à chaque fois :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">for</span> nom<span style="color: #66cc66;">,</span> score <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">sorted</span><span style="color: black;">&#40;</span>scores.<span style="color: black;">items</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>nom<span style="color: #66cc66;">,</span> score<span style="color: black;">&#41;</span>
...
<span style="color: black;">Jack</span> <span style="color: #ff4500;">3</span>
Jeanne <span style="color: #ff4500;">0</span>
Jenny <span style="color: #ff4500;">7</span>
Joe <span style="color: #ff4500;">1</span>
Jonh <span style="color: #ff4500;">5</span>
July <span style="color: #ff4500;">3</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">for</span> nom<span style="color: #66cc66;">,</span> score <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">sorted</span><span style="color: black;">&#40;</span>scores.<span style="color: black;">items</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span> key<span style="color: #66cc66;">=</span><span style="color: #ff7700;font-weight:bold;">lambda</span> x: x<span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>nom<span style="color: #66cc66;">,</span> score<span style="color: black;">&#41;</span>
...
<span style="color: black;">Jeanne</span> <span style="color: #ff4500;">0</span>
Joe <span style="color: #ff4500;">1</span>
Jack <span style="color: #ff4500;">3</span>
July <span style="color: #ff4500;">3</span>
Jonh <span style="color: #ff4500;">5</span>
Jenny <span style="color: #ff4500;">7</span></pre></td></tr></table></div>

<p>Dans l&#8217;ordre d&#8217;insertion par contre, ce n&#8217;est pas possible avec le dictionnaire. Mais voilà l&#8217;astuce : le hash map en Python, ce n&#8217;est pas QUE le type <code>dict</code>.</p>
<p>Pour ce problème, on peut utiliser <code>collections.OrderedDict</code> :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">collections</span> <span style="color: #ff7700;font-weight:bold;">import</span> OrderedDict
<span style="color: #66cc66;">&gt;&gt;&gt;</span> d <span style="color: #66cc66;">=</span> OrderedDict<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> d<span style="color: black;">&#91;</span><span style="color: #483d8b;">'Jeanne'</span><span style="color: black;">&#93;</span> <span style="color: #66cc66;">=</span> <span style="color: #ff4500;">3</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> d<span style="color: black;">&#91;</span><span style="color: #483d8b;">'Jack'</span><span style="color: black;">&#93;</span> <span style="color: #66cc66;">=</span> <span style="color: #ff4500;">2</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> d<span style="color: black;">&#91;</span><span style="color: #483d8b;">'July'</span><span style="color: black;">&#93;</span> <span style="color: #66cc66;">=</span> <span style="color: #ff4500;">6</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">for</span> nom<span style="color: #66cc66;">,</span> score <span style="color: #ff7700;font-weight:bold;">in</span> d.<span style="color: black;">items</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>nom<span style="color: #66cc66;">,</span> score<span style="color: black;">&#41;</span>
...
<span style="color: black;">Jeanne</span> <span style="color: #ff4500;">3</span>
Jack <span style="color: #ff4500;">2</span>
July <span style="color: #ff4500;">6</span></pre></td></tr></table></div>

<p>Après il y a le rare problème, mais tout de même existant, de la très très grosse structure de données que l&#8217;on veut itérer dans l&#8217;ordre de clés :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">random</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> l <span style="color: #66cc66;">=</span> <span style="color: #008000;">range</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">10000000</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #dc143c;">random</span>.<span style="color: black;">shuffle</span><span style="color: black;">&#40;</span>l<span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Si on fait un sort dessus, ça prend plusieurs secondes :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> l.<span style="color: black;">sort</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Imaginez avec un dico qui contient un million de clés sous forme de texte. La lecture dans l&#8217;ordre sera très, très lente. Parfois ce n&#8217;est pas grave, et parfois c&#8217;est très emmerdant.</p>
<p>La stdlib de Python ne permet pas de répondre à ce problème facilement. On pourrait bricoler quelque chose avec <a href="http://sametmax.com/heapq-le-module-python-incompris/">heapq</a>, mais franchement, c&#8217;est se casser la tête pour rien.</p>
<p>Le plus simple est d&#8217;utiliser une lib externe, par exemple l&#8217;excellente <a href="https://github.com/grantjenks/sorted_containers">sorted_container</a>, qui en plus d&#8217;être très rapide, est en pur Python. Du coup, un peu de <a href="http://sametmax.com/votre-python-aime-les-pip/">pip</a> :</p>
<p><code>pip install sortedcontainer</code></p>
<p>Et on est bon.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">from</span> sortedcontainers <span style="color: #ff7700;font-weight:bold;">import</span> SortedDict
<span style="color: #66cc66;">&gt;&gt;&gt;</span> d <span style="color: #66cc66;">=</span> SortedDict<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> d<span style="color: black;">&#91;</span><span style="color: #483d8b;">'Joe'</span><span style="color: black;">&#93;</span> <span style="color: #66cc66;">=</span> <span style="color: #ff4500;">1</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> d<span style="color: black;">&#91;</span><span style="color: #483d8b;">'Jeanne'</span><span style="color: black;">&#93;</span> <span style="color: #66cc66;">=</span> <span style="color: #ff4500;">6</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> d<span style="color: black;">&#91;</span><span style="color: #483d8b;">'July'</span><span style="color: black;">&#93;</span> <span style="color: #66cc66;">=</span> <span style="color: #ff4500;">3</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> d<span style="color: black;">&#91;</span><span style="color: #483d8b;">'John'</span><span style="color: black;">&#93;</span> <span style="color: #66cc66;">=</span> <span style="color: #ff4500;">3</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">for</span> nom<span style="color: #66cc66;">,</span> score <span style="color: #ff7700;font-weight:bold;">in</span> d.<span style="color: black;">items</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>nom<span style="color: #66cc66;">,</span> score<span style="color: black;">&#41;</span>
...
<span style="color: black;">Jeanne</span> <span style="color: #ff4500;">6</span>
Joe <span style="color: #ff4500;">1</span>
John <span style="color: #ff4500;">3</span>
July <span style="color: #ff4500;">3</span></pre></td></tr></table></div>

<p>SortedDict s&#8217;assure que le dictionnaire reste ordonné à chaque insertion d&#8217;un élément, et ainsi, vous évite de devoir faire un tri tout à la fin.</p>
<h2>Initialisation</h2>
<p>La plupart du temps, on utilise la notation littérale. Mais le constructeur <code>dict</code> trouve son utilité dans le fait qu&#8217;il accepte un itérable de tuples en paramètre :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">dict</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;a&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;b&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
<span style="color: black;">&#123;</span><span style="color: #483d8b;">'a'</span>: <span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'b'</span>: <span style="color: #ff4500;">2</span><span style="color: black;">&#125;</span></pre></td></tr></table></div>

<p>La plupart du temps, les gens n&#8217;en voient pas l&#8217;utilité. Mais il faut se rappeler que tout le langage Python est organisé autour de l&#8217;itération. Je ne cesse de le répéter, en Python, l&#8217;itération est tout.</p>
<p>De fait, cette particularité du constructeur du dico vous permet de créer des dictionnaires à partir de structures existantes inattendues&#8230;</p>
<p>Prendre deux séquences et les pairer :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> personnes <span style="color: #66cc66;">=</span> <span style="color: black;">&#40;</span><span style="color: #483d8b;">'Joe'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'John'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'Jean-Michel'</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> scores <span style="color: #66cc66;">=</span> <span style="color: black;">&#40;</span><span style="color: #ff4500;">4</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">10</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">34</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">zip</span><span style="color: black;">&#40;</span>personnes<span style="color: #66cc66;">,</span> scores<span style="color: black;">&#41;</span>
<span style="color: black;">&#91;</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'Joe'</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">4</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: black;">&#40;</span><span style="color: #483d8b;">'John'</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">10</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: black;">&#40;</span><span style="color: #483d8b;">'Jean-michel'</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">34</span><span style="color: black;">&#41;</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">dict</span><span style="color: black;">&#40;</span><span style="color: #008000;">zip</span><span style="color: black;">&#40;</span>personnes<span style="color: #66cc66;">,</span> scores<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: black;">&#123;</span><span style="color: #483d8b;">'Jean-michel'</span>: <span style="color: #ff4500;">34</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'John'</span>: <span style="color: #ff4500;">10</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'Joe'</span>: <span style="color: #ff4500;">4</span><span style="color: black;">&#125;</span></pre></td></tr></table></div>

<p>Pairer les deux derniers champs du résultat d&#8217;une commande :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">subprocess</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> df <span style="color: #66cc66;">=</span> <span style="color: #dc143c;">subprocess</span>.<span style="color: black;">check_output</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'df'</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>df<span style="color: black;">&#41;</span>
Sys. <span style="color: black;">de</span> fichiers       blocks de 1K  Utilisé Disponible Uti% Monté sur
/dev/sda7                   <span style="color: #ff4500;">7972000</span>  <span style="color: #ff4500;">6614840</span>     <span style="color: #ff4500;">929156</span>  <span style="color: #ff4500;">88</span>% /
none                              <span style="color: #ff4500;">4</span>        <span style="color: #ff4500;">0</span>          <span style="color: #ff4500;">4</span>   <span style="color: #ff4500;">0</span>% /<span style="color: #dc143c;">sys</span>/fs/cgroup
udev                        <span style="color: #ff4500;">1968688</span>        <span style="color: #ff4500;">4</span>    <span style="color: #ff4500;">1968684</span>   <span style="color: #ff4500;">1</span>% /dev
tmpfs                        <span style="color: #ff4500;">395896</span>     <span style="color: #ff4500;">1112</span>     <span style="color: #ff4500;">394784</span>   <span style="color: #ff4500;">1</span>% /run
none                           <span style="color: #ff4500;">5120</span>        <span style="color: #ff4500;">0</span>       <span style="color: #ff4500;">5120</span>   <span style="color: #ff4500;">0</span>% /run/lock
none                        <span style="color: #ff4500;">1979472</span>      <span style="color: #ff4500;">160</span>    <span style="color: #ff4500;">1979312</span>   <span style="color: #ff4500;">1</span>% /run/shm
none                         <span style="color: #ff4500;">102400</span>       <span style="color: #ff4500;">44</span>     <span style="color: #ff4500;">102356</span>   <span style="color: #ff4500;">1</span>% /run/<span style="color: #dc143c;">user</span>
/dev/sda5                  <span style="color: #ff4500;">65438480</span> <span style="color: #ff4500;">57693436</span>    <span style="color: #ff4500;">4397852</span>  <span style="color: #ff4500;">93</span>% /media/sam/
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">dict</span><span style="color: black;">&#40;</span>l.<span style="color: black;">split</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#91;</span>-<span style="color: #ff4500;">2</span>:<span style="color: black;">&#93;</span> <span style="color: #ff7700;font-weight:bold;">for</span> l <span style="color: #ff7700;font-weight:bold;">in</span>  <span style="color: #008000;">list</span><span style="color: black;">&#40;</span>df.<span style="color: black;">split</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'<span style="color: #000099; font-weight: bold;">\n</span>'</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>:<span style="color: black;">&#93;</span> <span style="color: #ff7700;font-weight:bold;">if</span> l<span style="color: black;">&#41;</span>
<span style="color: black;">&#123;</span><span style="color: #483d8b;">'31%'</span>: <span style="color: #483d8b;">'/media/truecrypt1'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'1%'</span>: <span style="color: #483d8b;">'/run/user'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'93%'</span>: <span style="color: #483d8b;">'/media/sam'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'88%'</span>: <span style="color: #483d8b;">'/'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'0%'</span>: <span style="color: #483d8b;">'/run/lock'</span><span style="color: black;">&#125;</span></pre></td></tr></table></div>

<p>Depuis Python 2.7, cette fonctionnalité est partiellement phagocytée par la syntaxe pour <a href="http://sametmax.com/python-love-les-listes-en-intention-partie/">les intentions</a> sur les dicos :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">pprint</span> <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">pprint</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #dc143c;">pprint</span><span style="color: black;">&#40;</span> <span style="color: black;">&#123;</span>line: num <span style="color: #ff7700;font-weight:bold;">for</span> num<span style="color: #66cc66;">,</span> line <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">enumerate</span><span style="color: black;">&#40;</span><span style="color: #008000;">open</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'/etc/fstab'</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span><span style="color: black;">&#125;</span><span style="color: black;">&#41;</span>
<span style="color: black;">&#123;</span><span style="color: #483d8b;">'#<span style="color: #000099; font-weight: bold;">\n</span>'</span>: <span style="color: #ff4500;">6</span><span style="color: #66cc66;">,</span>
 <span style="color: #483d8b;">'# / was on /dev/sda7 during installation<span style="color: #000099; font-weight: bold;">\n</span>'</span>: <span style="color: #ff4500;">8</span><span style="color: #66cc66;">,</span>
 <span style="color: #483d8b;">'# /etc/fstab: static file system information.<span style="color: #000099; font-weight: bold;">\n</span>'</span>: <span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span>
 <span style="color: #483d8b;">'# &lt;file system&gt; &lt;mount point&gt;   &lt;type&gt;  &lt;options&gt;       &lt;dump&gt;  &lt;pass&gt;<span style="color: #000099; font-weight: bold;">\n</span>'</span>: <span style="color: #ff4500;">7</span><span style="color: #66cc66;">,</span>
 <span style="color: #483d8b;">&quot;# Use 'blkid' to print the universally unique identifier for a<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span>: <span style="color: #ff4500;">3</span><span style="color: #66cc66;">,</span>
 <span style="color: #483d8b;">'# device; this may be used with UUID= as a more robust way to name devices<span style="color: #000099; font-weight: bold;">\n</span>'</span>: <span style="color: #ff4500;">4</span><span style="color: #66cc66;">,</span>
 <span style="color: #483d8b;">'# swap was on /dev/sda6 during installation<span style="color: #000099; font-weight: bold;">\n</span>'</span>: <span style="color: #ff4500;">10</span><span style="color: #66cc66;">,</span>
 <span style="color: #483d8b;">'# that works even if disks are added and removed. See fstab(5).<span style="color: #000099; font-weight: bold;">\n</span>'</span>: <span style="color: #ff4500;">5</span><span style="color: #66cc66;">,</span>
 <span style="color: #483d8b;">'UUID=4c0455fb-ff57-466a-8d1f-22b575129f4f none            swap    sw              0       0<span style="color: #000099; font-weight: bold;">\n</span>'</span>: <span style="color: #ff4500;">11</span><span style="color: #66cc66;">,</span>
 <span style="color: #483d8b;">'UUID=4f560031-1058-4eb6-a51e-b7991dfc6db7 /               ext4    errors=remount-ro 0       1<span style="color: #000099; font-weight: bold;">\n</span>'</span>: <span style="color: #ff4500;">9</span><span style="color: #66cc66;">,</span>
 <span style="color: #483d8b;">'UUID=b27f7e93-60c0-4efa-bfae-5ac21a8f4e3c /media/sam ext4 auto,user,rw,exec 0 0<span style="color: #000099; font-weight: bold;">\n</span>'</span>: <span style="color: #ff4500;">12</span><span style="color: black;">&#125;</span></pre></td></tr></table></div>

<p>Cela dit, on n&#8217;a pas toujours besoin de clés ET de valeurs pour créer un dictionnaire. Ainsi, si on a une liste de n&#8217;clés qu&#8217;on veut toutes initialiser à la même valeur, la très peu connue méthode <code>fromkeys</code> nous rendra bien service :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> personnes <span style="color: #66cc66;">=</span> <span style="color: black;">&#40;</span><span style="color: #483d8b;">'Joe'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'John'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'Jean-michel'</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">dict</span>.<span style="color: black;">fromkeys</span><span style="color: black;">&#40;</span>personnes<span style="color: #66cc66;">,</span> <span style="color: #ff4500;">0</span><span style="color: black;">&#41;</span>
<span style="color: black;">&#123;</span><span style="color: #483d8b;">'Jean-michel'</span>: <span style="color: #ff4500;">0</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'John'</span>: <span style="color: #ff4500;">0</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'Joe'</span>: <span style="color: #ff4500;">0</span><span style="color: black;">&#125;</span></pre></td></tr></table></div>

<p>De même, on peut ne pas vouloir initialiser un dico, mais vouloir une valeur par défaut pour toutes les clés.  <code>collections.defaultdict</code> est fait pour ça. En plus, les valeurs peuvent être dynamiques :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">collections</span> <span style="color: #ff7700;font-weight:bold;">import</span> defaultdict
<span style="color: #66cc66;">&gt;&gt;&gt;</span> scores <span style="color: #66cc66;">=</span> defaultdict<span style="color: black;">&#40;</span><span style="color: #ff7700;font-weight:bold;">lambda</span>: <span style="color: #ff4500;">0</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> scores<span style="color: black;">&#91;</span><span style="color: #483d8b;">'Joe'</span><span style="color: black;">&#93;</span>
<span style="color: #ff4500;">0</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> scores<span style="color: black;">&#91;</span><span style="color: #483d8b;">'Joe'</span><span style="color: black;">&#93;</span> <span style="color: #66cc66;">=</span> <span style="color: #ff4500;">1</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> scores<span style="color: black;">&#91;</span><span style="color: #483d8b;">'Joe'</span><span style="color: black;">&#93;</span>
<span style="color: #ff4500;">1</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> scores<span style="color: black;">&#91;</span><span style="color: #483d8b;">'July'</span><span style="color: black;">&#93;</span>
<span style="color: #ff4500;">0</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">datetime</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> naissances <span style="color: #66cc66;">=</span> defaultdict<span style="color: black;">&#40;</span><span style="color: #dc143c;">datetime</span>.<span style="color: #dc143c;">datetime</span>.<span style="color: black;">utcnow</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> naissances<span style="color: black;">&#91;</span><span style="color: #483d8b;">'Joe'</span><span style="color: black;">&#93;</span>
<span style="color: #dc143c;">datetime</span>.<span style="color: #dc143c;">datetime</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">2014</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">6</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">29</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">6</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">58</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">11</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">412202</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Enfin, je sais que tous les tutos du monde en Python utilisent le dictionnaire pour montrer une forme ou une aute de compteur. Mais si vous avez VRAIMENT besoin d&#8217;un compteur, utilisez <code>collections.Counter</code> qui est un objet avec l&#8217;interface d&#8217;un dictionnaire mais avec tout ce qu&#8217;il faut pour compter :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">collections</span> <span style="color: #ff7700;font-weight:bold;">import</span> Counter
<span style="color: #66cc66;">&gt;&gt;&gt;</span> c <span style="color: #66cc66;">=</span> Counter<span style="color: black;">&#40;</span><span style="color: #483d8b;">'abbbac'</span><span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># comptage automatique</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> c
Counter<span style="color: black;">&#40;</span><span style="color: black;">&#123;</span><span style="color: #483d8b;">'b'</span>: <span style="color: #ff4500;">3</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'a'</span>: <span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'c'</span>: <span style="color: #ff4500;">1</span><span style="color: black;">&#125;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> c<span style="color: black;">&#91;</span><span style="color: #483d8b;">'c'</span><span style="color: black;">&#93;</span>
<span style="color: #ff4500;">1</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> c<span style="color: black;">&#91;</span><span style="color: #483d8b;">'d'</span><span style="color: black;">&#93;</span> <span style="color: #808080; font-style: italic;"># pas de KeyError</span>
<span style="color: #ff4500;">0</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> c<span style="color: black;">&#91;</span><span style="color: #483d8b;">'z'</span><span style="color: black;">&#93;</span> +<span style="color: #66cc66;">=</span> <span style="color: #ff4500;">1</span> <span style="color: #808080; font-style: italic;"># pas de KeyError</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> c<span style="color: black;">&#91;</span><span style="color: #483d8b;">'z'</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> c.<span style="color: black;">most_common</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># et en bonus</span>
<span style="color: black;">&#91;</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'b'</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: black;">&#40;</span><span style="color: #483d8b;">'a'</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span><span style="color: black;">&#93;</span></pre></td></tr></table></div>

<h2>Clé en main</h2>
<p>Récupérer une clé si on ne sait pas si elle est présente est une opération courante, et la documentation montre généralement ça :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">try</span>:
   val <span style="color: #66cc66;">=</span> dico<span style="color: black;">&#91;</span><span style="color: #483d8b;">'cle'</span><span style="color: black;">&#93;</span>
<span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: #008000;">KeyError</span>:
   val <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">'valeur par defaut'</span></pre></td></tr></table></div>

<p>Bien que ce soit parfaitement valide, c&#8217;est généralement se faire chier pour rien puisqu&#8217;on peut faire ça en une ligne :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">   val <span style="color: #66cc66;">=</span> dico.<span style="color: black;">get</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'cle'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'valeur par defaut'</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Néanmoins la méthode <code>get()</code> est très connue. Moins connue est la méthode <code>setdefault</code>. En effet, parfois on veut faire plutôt ceci :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">try</span>:
   val <span style="color: #66cc66;">=</span> dico<span style="color: black;">&#91;</span><span style="color: #483d8b;">'cle'</span><span style="color: black;">&#93;</span>
<span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: #008000;">KeyError</span>:
   dico<span style="color: black;">&#91;</span><span style="color: #483d8b;">'cle'</span><span style="color: black;">&#93;</span> <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">'valeur par defaut'</span>
   val <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">'valeur par defaut'</span></pre></td></tr></table></div>

<p>Et ça peut également se faire en une ligne :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">   val <span style="color: #66cc66;">=</span> dico.<span style="color: black;">setdefault</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'cle'</span><span style="color: #66cc66;">,</span> valeur par defaut<span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>J&#8217;aimerais aussi en profiter pour rappeler que les clés des dicos peuvent être n&#8217;importe quel objet hashable, pas juste une string ou un int. Notamment, <a href="http://sametmax.com/de-linteret-des-tuples-comme-cle-de-dictionnaire/">les tuples sont des clés valides</a>, et comme l&#8217;opérateur tuple <a href="http://sametmax.com/10-trucs-que-je-deteste-en-python/">est la virgule et non la parenthèse</a>, cette syntaxe est parfaitement valide :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> d <span style="color: #66cc66;">=</span> <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> d<span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span> <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">'tresor'</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> d<span style="color: black;">&#91;</span><span style="color: #ff4500;">3</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">3</span><span style="color: black;">&#93;</span> <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">'mine'</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> d
<span style="color: black;">&#123;</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span>: <span style="color: #483d8b;">'tresor'</span><span style="color: #66cc66;">,</span> <span style="color: black;">&#40;</span><span style="color: #ff4500;">3</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span>: <span style="color: #483d8b;">'mine'</span><span style="color: black;">&#125;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> d<span style="color: black;">&#91;</span><span style="color: #ff4500;">3</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">3</span><span style="color: black;">&#93;</span>
<span style="color: #483d8b;">'mine'</span></pre></td></tr></table></div>

<p>Parmi les objets utilisables comme clés :</p>
<ul>
<li>Les frozenset.</li>
<li>Les <a href="http://sametmax.com/le-namedtuple-la-structure-mal-aimee/">namedtuples</a></li>
<li>Les instances de <a href="http://sametmax.com/le-guide-ultime-et-definitif-sur-la-programmation-orientee-objet-en-python-a-lusage-des-debutants-qui-sont-rassures-par-les-textes-detailles-qui-prennent-le-temps-de-tout-expliquer-partie-1/">vos classes</a></li>
</ul>
<p>Si vous avez un doute, il est facile de savoir si un objet est hashable ou pas :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">collections</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">isinstance</span><span style="color: black;">&#40;</span><span style="color: black;">&#123;</span><span style="color: black;">&#125;</span><span style="color: #66cc66;">,</span> <span style="color: #dc143c;">collections</span>.<span style="color: black;">Hashable</span><span style="color: black;">&#41;</span>
<span style="color: #008000;">False</span>
<span style="color: #66cc66;">&gt;&gt;</span> <span style="color: #008000;">isinstance</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">0</span><span style="color: #66cc66;">,</span> <span style="color: #dc143c;">collections</span>.<span style="color: black;">Hashable</span><span style="color: black;">&#41;</span>
<span style="color: #008000;">True</span></pre></td></tr></table></div>

<h2>Mon dico à moi, c&#8217;est le meilleur</h2>
<p>On peut tout à fait hériter du type dictionnaire pour obtenir un type qui a des fonctionnalités que le type original n&#8217;a pas :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">class</span> MonDico<span style="color: black;">&#40;</span><span style="color: #008000;">dict</span><span style="color: black;">&#41;</span>:
...     <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__add__</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> other<span style="color: black;">&#41;</span>:
...         <span style="color: #dc143c;">new</span> <span style="color: #66cc66;">=</span> <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span>
...         <span style="color: #dc143c;">new</span>.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>
...         <span style="color: #dc143c;">new</span>.<span style="color: black;">update</span><span style="color: black;">&#40;</span>other<span style="color: black;">&#41;</span>
...         <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #dc143c;">new</span>
...
<span style="color: #66cc66;">&gt;&gt;&gt;</span> d1 <span style="color: #66cc66;">=</span> MonDico<span style="color: black;">&#40;</span>a<span style="color: #66cc66;">=</span><span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> b<span style="color: #66cc66;">=</span><span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> d2 <span style="color: #66cc66;">=</span> MonDico<span style="color: black;">&#40;</span>b<span style="color: #66cc66;">=</span><span style="color: #ff4500;">3</span><span style="color: #66cc66;">,</span> c<span style="color: #66cc66;">=</span><span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> d1 + d2
<span style="color: black;">&#123;</span><span style="color: #483d8b;">'a'</span>: <span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'c'</span>: <span style="color: #ff4500;">3</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'b'</span>: <span style="color: #ff4500;">3</span><span style="color: black;">&#125;</span></pre></td></tr></table></div>

<p>Mais c&#8217;est assez rare. La plupart du temps on veut plutôt rajouter des fonctionnalités de conteneur à un type existant. Dans ce cas, les <a href="http://sametmax.com/le-guide-ultime-et-definitif-sur-la-programmation-orientee-objet-en-python-a-lusage-des-debutants-qui-sont-rassures-par-les-textes-detailles-qui-prennent-le-temps-de-tout-expliquer-partie-6/">méthodes magiques</a> viennent à la rescousse. Par exemple :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">class</span> Phrase<span style="color: black;">&#40;</span><span style="color: #008000;">object</span><span style="color: black;">&#41;</span>:
&nbsp;
   <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__init__</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> <span style="color: #dc143c;">string</span><span style="color: black;">&#41;</span>:
      <span style="color: #008000;">self</span>.<span style="color: black;">words</span> <span style="color: #66cc66;">=</span> <span style="color: #dc143c;">string</span>.<span style="color: black;">split</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
   <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__getitem__</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> word<span style="color: black;">&#41;</span>:
      <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: black;">&#91;</span>i <span style="color: #ff7700;font-weight:bold;">for</span> i<span style="color: #66cc66;">,</span> w <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">enumerate</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">words</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> w <span style="color: #66cc66;">==</span> word<span style="color: black;">&#93;</span>
&nbsp;
<span style="color: #66cc66;">&gt;&gt;&gt;</span> p <span style="color: #66cc66;">=</span> Phrase<span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Une petite puce pique plus qu'une grosse puce ne pique&quot;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> p<span style="color: black;">&#91;</span><span style="color: #483d8b;">'petite'</span><span style="color: black;">&#93;</span>
<span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> p<span style="color: black;">&#91;</span><span style="color: #483d8b;">'puce'</span><span style="color: black;">&#93;</span>
<span style="color: black;">&#91;</span><span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">7</span><span style="color: black;">&#93;</span></pre></td></tr></table></div>

<p>Hey oui, les hash maps en Python, c&#8217;est un sujet qui peut aller très, très loin. C&#8217;est ce qui est merveilleux avec ce langage, on peut rapidement programmer en effleurant juste la surface, sans se noyer. Et si on a besoin d&#8217;aller plus loin, des profondeurs abyssales de features nous attendent.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/aller-plus-loin-avec-les-hash-maps-en-python/feed/</wfw:commentRss>
		<slash:comments>21</slash:comments>
		</item>
		<item>
		<title>Mesurer les performances d&#8217;un snippet Python 6</title>
		<link>http://sametmax.com/mesurer-les-performances-dun-snippet-python/</link>
		<comments>http://sametmax.com/mesurer-les-performances-dun-snippet-python/#comments</comments>
		<pubDate>Sat, 08 Jun 2013 20:20:52 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[dict]]></category>
		<category><![CDATA[merge]]></category>
		<category><![CDATA[perf]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=6369</guid>
		<description><![CDATA[L'open source c'est fantastique. Github c'est merveilleux. On parle de <a href="http://sametmax.com/batbelt-la-lib-des-petits-outils-python-qui-vont-bien/">batbelt</a>, et paf, quelques jours plus tard on a notre <a href="https://github.com/sametmax/Bat-belt/pull/1">première contribution</a>.]]></description>
				<content:encoded><![CDATA[<p>Ca fait longtemps que j&#8217;avais pas musique.</p>

<!-- iframe plugin v.2.9 wordpress.org/plugins/iframe/ -->
<iframe width="420" height="315" src="http://www.youtube.com/embed/qeMFqkcPYcg" frameborder="0" scrolling="no" class="iframe-class"></iframe>

<p>L&#8217;open source c&#8217;est fantastique. Github c&#8217;est merveilleux. On parle de <a href="http://sametmax.com/batbelt-la-lib-des-petits-outils-python-qui-vont-bien/">batbelt</a>, et paf, quelques jours plus tard on a notre <a href="https://github.com/sametmax/Bat-belt/pull/1">première contribution</a>.</p>
<p>Ce qui est sympa avec cette lib, c&#8217;est que ce sont des fonctions simples et courtes, axées sur des tâches très précises. Le code est donc généralement <a href="https://github.com/sametmax/Bat-belt/blob/master/batbelt/structs.py">intéressant à lire</a>, mais pas trop compliqué, et on tombe souvent sur des cas d&#8217;école.</p>
<p>C&#8217;est le cas de cette modification de la fonction <code>dmerge()</code>. Originalement, <code>dmerge</code> permet de créer un dictionnaire à partir de la fusion de de 2 autres dicos, et ça marchait comme ça:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> dmerge<span style="color: black;">&#40;</span>d1<span style="color: #66cc66;">,</span> d2<span style="color: black;">&#41;</span>:
    d <span style="color: #66cc66;">=</span> <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span>
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d1<span style="color: black;">&#41;</span>
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d2<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> d</pre></td></tr></table></div>

<p>Facile à comprendre, rapide, simple, et le comportement par défaut est intuitif : si une clé est en double, la clé du deuxième dico écrase la première.</p>
<p>Comme le <a href="http://sametmax.com/batbelt-la-lib-des-petits-outils-python-qui-vont-bien/#comment-9657">précisait Etienne,</a> ce comportement est néanmoins un parmi de nombreux possibles. On pourrait aussi vouloir:</p>
<ul>
<li>Lever une exception en cas de doublon.</li>
<li>Concaténer ou additionner les doublons.</li>
<li>Mettre les doublons dans une liste.</li>
<li>Garder la valeur originale en cas de doublon.</li>
<li>Prendre la valeur la plus grande / petite en cas de doublon.</li>
<li>Etc.</li>
</ul>
<p>Pour cela, notre contributeur a proposé qu&#8217;on puisse passer en paramètre une fonction qui choisit quelle valeur garder en cas de doublon. Le code devient donc :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> dmerge<span style="color: black;">&#40;</span>d1<span style="color: #66cc66;">,</span> d2<span style="color: #66cc66;">,</span> merge_func<span style="color: #66cc66;">=</span><span style="color: #ff7700;font-weight:bold;">lambda</span> v1<span style="color: #66cc66;">,</span> v2: v2<span style="color: black;">&#41;</span>:
    d <span style="color: #66cc66;">=</span> <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span>
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#40;</span>k<span style="color: #66cc66;">,</span> v<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k<span style="color: #66cc66;">,</span> v <span style="color: #ff7700;font-weight:bold;">in</span> d1.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> d2<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#40;</span>k<span style="color: #66cc66;">,</span> v<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k<span style="color: #66cc66;">,</span> v <span style="color: #ff7700;font-weight:bold;">in</span> d2.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> d1<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#40;</span>k<span style="color: #66cc66;">,</span> merge_func<span style="color: black;">&#40;</span>v<span style="color: #66cc66;">,</span> d2<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k<span style="color: #66cc66;">,</span> v <span style="color: #ff7700;font-weight:bold;">in</span> d1.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">in</span> d2<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> d</pre></td></tr></table></div>

<p>Avoir une valeur par défaut nous permet de garder le comportement initial. Pour cela on utilise une <a href="http://sametmax.com/fonctions-anonymes-en-python-ou-lambda/">lambda</a>. C&#8217;est ce qu&#8217;on appelle l&#8217;injection de dépendance.</p>
<p>Comme j&#8217;ai bien faire mumuse avec Python, je me suis demandé : &#8220;quelle est la stratégie de merge la plus rapide ?&#8221;. J&#8217;ai donc fait plusieurs tests de merge, avec plusieurs algos. Voici ce que ça donne:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"> <span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">itertools</span> <span style="color: #ff7700;font-weight:bold;">import</span> chain
&nbsp;
&nbsp;
 <span style="color: #ff7700;font-weight:bold;">def</span> dmerge1<span style="color: black;">&#40;</span>d1<span style="color: #66cc66;">,</span> d2<span style="color: #66cc66;">,</span> merge_func<span style="color: #66cc66;">=</span><span style="color: #008000;">None</span><span style="color: black;">&#41;</span>:
     <span style="color: #483d8b;">&quot;&quot;&quot;
         Mon premier essai, en virant la lambda et en utilisant itertools.
     &quot;&quot;&quot;</span>
     d <span style="color: #66cc66;">=</span> <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">if</span> merge_func <span style="color: #ff7700;font-weight:bold;">is</span> <span style="color: #008000;">None</span>:
&nbsp;
         d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d1<span style="color: black;">&#41;</span>
         d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d2<span style="color: black;">&#41;</span>
         <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">for</span> k<span style="color: #66cc66;">,</span> v <span style="color: #ff7700;font-weight:bold;">in</span> chain<span style="color: black;">&#40;</span>d1.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span> d2.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>:
         <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">in</span> d1 <span style="color: #ff7700;font-weight:bold;">and</span> k <span style="color: #ff7700;font-weight:bold;">in</span> d2:
             d<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span> <span style="color: #66cc66;">=</span> merge_func<span style="color: black;">&#40;</span>d1<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span><span style="color: #66cc66;">,</span> d2<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
         <span style="color: #ff7700;font-weight:bold;">else</span>:
             d<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span> <span style="color: #66cc66;">=</span> v
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
&nbsp;
&nbsp;
 <span style="color: #ff7700;font-weight:bold;">def</span> dmerge2<span style="color: black;">&#40;</span>d1<span style="color: #66cc66;">,</span> d2<span style="color: #66cc66;">,</span> merge_func<span style="color: #66cc66;">=</span><span style="color: #ff7700;font-weight:bold;">lambda</span> v1<span style="color: #66cc66;">,</span> v2: v2<span style="color: black;">&#41;</span>:
     <span style="color: #483d8b;">&quot;&quot;&quot;
         Le code du PR original
     &quot;&quot;&quot;</span>
     d <span style="color: #66cc66;">=</span> <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span>
     d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#40;</span>k<span style="color: #66cc66;">,</span> v<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k<span style="color: #66cc66;">,</span> v <span style="color: #ff7700;font-weight:bold;">in</span> d1.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> d2<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
     d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#40;</span>k<span style="color: #66cc66;">,</span> v<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k<span style="color: #66cc66;">,</span> v <span style="color: #ff7700;font-weight:bold;">in</span> d2.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> d1<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
     d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#40;</span>k<span style="color: #66cc66;">,</span> merge_func<span style="color: black;">&#40;</span>v<span style="color: #66cc66;">,</span> d2<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k<span style="color: #66cc66;">,</span> v <span style="color: #ff7700;font-weight:bold;">in</span> d1.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">in</span> d2<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
&nbsp;
 <span style="color: #ff7700;font-weight:bold;">def</span> dmerge3<span style="color: black;">&#40;</span>d1<span style="color: #66cc66;">,</span> d2<span style="color: #66cc66;">,</span> merge_func<span style="color: #66cc66;">=</span><span style="color: #008000;">None</span><span style="color: black;">&#41;</span>:
     <span style="color: #483d8b;">&quot;&quot;&quot;
        Un mélange du code original et de mon premier essai.
     &quot;&quot;&quot;</span>
     d <span style="color: #66cc66;">=</span> <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span>
&nbsp;
     d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d1<span style="color: black;">&#41;</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">if</span> merge_func <span style="color: #ff7700;font-weight:bold;">is</span> <span style="color: #008000;">None</span>:
         d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d2<span style="color: black;">&#41;</span>
         <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">for</span> k<span style="color: #66cc66;">,</span> v <span style="color: #ff7700;font-weight:bold;">in</span> d2.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
         <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">in</span> d:
             d<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span> <span style="color: #66cc66;">=</span> merge_func<span style="color: black;">&#40;</span>d<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span><span style="color: #66cc66;">,</span> v<span style="color: black;">&#41;</span>
         <span style="color: #ff7700;font-weight:bold;">else</span>:
             d<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span> <span style="color: #66cc66;">=</span> v
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
&nbsp;
&nbsp;
 <span style="color: #ff7700;font-weight:bold;">def</span> dmerge4<span style="color: black;">&#40;</span>d1<span style="color: #66cc66;">,</span> d2<span style="color: #66cc66;">,</span> merge_func<span style="color: #66cc66;">=</span><span style="color: #008000;">None</span><span style="color: black;">&#41;</span>:
     <span style="color: #483d8b;">&quot;&quot;&quot;
         Le code original, en virant la lambda
     &quot;&quot;&quot;</span>
     d <span style="color: #66cc66;">=</span> <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">if</span> merge_func <span style="color: #ff7700;font-weight:bold;">is</span> <span style="color: #008000;">None</span>:
         d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d1<span style="color: black;">&#41;</span>
         d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d2<span style="color: black;">&#41;</span>
         <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
     d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#40;</span>k<span style="color: #66cc66;">,</span> v<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k<span style="color: #66cc66;">,</span> v <span style="color: #ff7700;font-weight:bold;">in</span> d1.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> d2<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
     d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#40;</span>k<span style="color: #66cc66;">,</span> v<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k<span style="color: #66cc66;">,</span> v <span style="color: #ff7700;font-weight:bold;">in</span> d2.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> d1<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
     d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#40;</span>k<span style="color: #66cc66;">,</span> merge_func<span style="color: black;">&#40;</span>v<span style="color: #66cc66;">,</span> d2<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k<span style="color: #66cc66;">,</span> v <span style="color: #ff7700;font-weight:bold;">in</span> d1.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">in</span> d2<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
&nbsp;
 <span style="color: #ff7700;font-weight:bold;">if</span> __name__ <span style="color: #66cc66;">==</span> <span style="color: #483d8b;">&quot;__main__&quot;</span>:
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">random</span>
     <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">timeit</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'Generate test dicts'</span><span style="color: black;">&#41;</span>
&nbsp;
     <span style="color: #808080; font-style: italic;"># pour que le test soit juste, il faut créer plusieurs types de dicos:</span>
     <span style="color: #808080; font-style: italic;"># des longs, et des courts avec plein de collisions ou moins</span>
     d1 <span style="color: #66cc66;">=</span> <span style="color: black;">&#123;</span><span style="color: #dc143c;">random</span>.<span style="color: black;">randint</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">0</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>: <span style="color: #483d8b;">'d1'</span> <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">xrange</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">10000</span><span style="color: black;">&#41;</span><span style="color: black;">&#125;</span>
     d2 <span style="color: #66cc66;">=</span> <span style="color: black;">&#123;</span><span style="color: #dc143c;">random</span>.<span style="color: black;">randint</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">0</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>: <span style="color: #483d8b;">'d2'</span> <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">xrange</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">10000</span><span style="color: black;">&#41;</span><span style="color: black;">&#125;</span>
     d3 <span style="color: #66cc66;">=</span> <span style="color: black;">&#123;</span><span style="color: #dc143c;">random</span>.<span style="color: black;">randint</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">0</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">10000000</span><span style="color: black;">&#41;</span>: <span style="color: #483d8b;">'d1'</span> <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">xrange</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">1000000</span><span style="color: black;">&#41;</span><span style="color: black;">&#125;</span>
     d4 <span style="color: #66cc66;">=</span> <span style="color: black;">&#123;</span><span style="color: #dc143c;">random</span>.<span style="color: black;">randint</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">0</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">10000000</span><span style="color: black;">&#41;</span>: <span style="color: #483d8b;">'d2'</span> <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">xrange</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">1000000</span><span style="color: black;">&#41;</span><span style="color: black;">&#125;</span>
&nbsp;
     merge_to_list <span style="color: #66cc66;">=</span> <span style="color: #ff7700;font-weight:bold;">lambda</span> a<span style="color: #66cc66;">,</span> b: <span style="color: black;">&#91;</span>a<span style="color: #66cc66;">,</span> b<span style="color: black;">&#93;</span>
&nbsp;
     <span style="color: #808080; font-style: italic;"># ensuite il faut s'assurer que toutes ces fonctions retournent bien</span>
     <span style="color: #808080; font-style: italic;"># la même chose</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Testing returns value all match&quot;</span><span style="color: black;">&#41;</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">assert</span> <span style="color: black;">&#40;</span>dmerge1<span style="color: black;">&#40;</span>d1<span style="color: #66cc66;">,</span> d2<span style="color: black;">&#41;</span> <span style="color: #66cc66;">==</span> dmerge2<span style="color: black;">&#40;</span>d1<span style="color: #66cc66;">,</span> d2<span style="color: black;">&#41;</span>
             <span style="color: #66cc66;">==</span> dmerge3<span style="color: black;">&#40;</span>d1<span style="color: #66cc66;">,</span> d2<span style="color: black;">&#41;</span> <span style="color: #66cc66;">==</span> dmerge4<span style="color: black;">&#40;</span>d1<span style="color: #66cc66;">,</span> d2<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">assert</span> <span style="color: black;">&#40;</span>dmerge1<span style="color: black;">&#40;</span>d1<span style="color: #66cc66;">,</span> d2<span style="color: #66cc66;">,</span> merge_to_list<span style="color: black;">&#41;</span> <span style="color: #66cc66;">==</span> dmerge2<span style="color: black;">&#40;</span>d1<span style="color: #66cc66;">,</span> d2<span style="color: #66cc66;">,</span> merge_to_list<span style="color: black;">&#41;</span>
            <span style="color: #66cc66;">==</span> dmerge3<span style="color: black;">&#40;</span>d1<span style="color: #66cc66;">,</span> d2<span style="color: #66cc66;">,</span> merge_to_list<span style="color: black;">&#41;</span> <span style="color: #66cc66;">==</span> dmerge4<span style="color: black;">&#40;</span>d1<span style="color: #66cc66;">,</span> d2<span style="color: #66cc66;">,</span> merge_to_list<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">assert</span> <span style="color: black;">&#40;</span>dmerge1<span style="color: black;">&#40;</span>d3<span style="color: #66cc66;">,</span> d4<span style="color: black;">&#41;</span> <span style="color: #66cc66;">==</span> dmerge2<span style="color: black;">&#40;</span>d3<span style="color: #66cc66;">,</span> d4<span style="color: black;">&#41;</span>
             <span style="color: #66cc66;">==</span> dmerge3<span style="color: black;">&#40;</span>d3<span style="color: #66cc66;">,</span> d4<span style="color: black;">&#41;</span> <span style="color: #66cc66;">==</span> dmerge4<span style="color: black;">&#40;</span>d3<span style="color: #66cc66;">,</span> d4<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">assert</span> <span style="color: black;">&#40;</span>dmerge1<span style="color: black;">&#40;</span>d3<span style="color: #66cc66;">,</span> d4<span style="color: #66cc66;">,</span> merge_to_list<span style="color: black;">&#41;</span> <span style="color: #66cc66;">==</span> dmerge2<span style="color: black;">&#40;</span>d3<span style="color: #66cc66;">,</span> d4<span style="color: #66cc66;">,</span> merge_to_list<span style="color: black;">&#41;</span>
             <span style="color: #66cc66;">==</span> dmerge3<span style="color: black;">&#40;</span>d3<span style="color: #66cc66;">,</span> d4<span style="color: #66cc66;">,</span> merge_to_list<span style="color: black;">&#41;</span> <span style="color: #66cc66;">==</span> dmerge4<span style="color: black;">&#40;</span>d3<span style="color: #66cc66;">,</span> d4<span style="color: #66cc66;">,</span> merge_to_list<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">assert</span> <span style="color: black;">&#40;</span>dmerge1<span style="color: black;">&#40;</span>d1<span style="color: #66cc66;">,</span> d4<span style="color: black;">&#41;</span> <span style="color: #66cc66;">==</span> dmerge2<span style="color: black;">&#40;</span>d1<span style="color: #66cc66;">,</span> d4<span style="color: black;">&#41;</span>
             <span style="color: #66cc66;">==</span> dmerge3<span style="color: black;">&#40;</span>d1<span style="color: #66cc66;">,</span> d4<span style="color: black;">&#41;</span> <span style="color: #66cc66;">==</span> dmerge4<span style="color: black;">&#40;</span>d1<span style="color: #66cc66;">,</span> d4<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">assert</span> <span style="color: black;">&#40;</span>dmerge1<span style="color: black;">&#40;</span>d1<span style="color: #66cc66;">,</span> d4<span style="color: #66cc66;">,</span> merge_to_list<span style="color: black;">&#41;</span> <span style="color: #66cc66;">==</span> dmerge2<span style="color: black;">&#40;</span>d1<span style="color: #66cc66;">,</span> d4<span style="color: #66cc66;">,</span> merge_to_list<span style="color: black;">&#41;</span>
             <span style="color: #66cc66;">==</span> dmerge3<span style="color: black;">&#40;</span>d1<span style="color: #66cc66;">,</span> d4<span style="color: #66cc66;">,</span> merge_to_list<span style="color: black;">&#41;</span> <span style="color: #66cc66;">==</span> dmerge4<span style="color: black;">&#40;</span>d1<span style="color: #66cc66;">,</span> d4<span style="color: #66cc66;">,</span> merge_to_list<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
&nbsp;
     <span style="color: #808080; font-style: italic;"># enfin on lance l'évaluation du temps d'éxécution avec timeit()</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Start timing&quot;</span><span style="color: black;">&#41;</span>
&nbsp;
&nbsp;
     <span style="color: #808080; font-style: italic;"># ce code est exécuté une fois par appel de timeit</span>
     <span style="color: #808080; font-style: italic;"># notez l'astuce 'from __main__ import x' qui importe du code</span>
     <span style="color: #808080; font-style: italic;"># du fichier en cours, ce qui sert rarement</span>
     setup <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">'''from __main__ import (dmerge1, dmerge2, dmerge3, dmerge4,
                                      d1, d2, d3, d4, merge_to_list)'''</span>
&nbsp;
&nbsp;
&nbsp;
     <span style="color: #808080; font-style: italic;"># ensuite on fait des appels à timeit : </span>
     <span style="color: #808080; font-style: italic;"># - le premier paramètre est le code à mesurer: il faut qu'il </span>
     <span style="color: #808080; font-style: italic;">#   soit le plus simple et court possible</span>
     <span style="color: #808080; font-style: italic;"># - le second et le code d'initialisation avant le test (hors mesure)</span>
     <span style="color: #808080; font-style: italic;"># - le 3e est le nombre de fois que le code va être appelé. </span>
&nbsp;
&nbsp;
     <span style="color: #808080; font-style: italic;"># on va tester chaque fonction pour chaque type de dico, une fois</span>
     <span style="color: #808080; font-style: italic;"># avec l'approche par défaut, et une fois avec une fonction de merge</span>
     <span style="color: #808080; font-style: italic;"># personnalisée</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Lots of collisions&quot;</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Default merge strategy&quot;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;1&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge1(d1, d2)&quot;</span><span style="color: #66cc66;">,</span> setup<span style="color: #66cc66;">=</span>setup<span style="color: #66cc66;">,</span> number<span style="color: #66cc66;">=</span><span style="color: #ff4500;">1000000</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;2&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge2(d1, d2)&quot;</span><span style="color: #66cc66;">,</span> setup<span style="color: #66cc66;">=</span>setup<span style="color: #66cc66;">,</span> number<span style="color: #66cc66;">=</span><span style="color: #ff4500;">1000000</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;3&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge3(d1, d2)&quot;</span><span style="color: #66cc66;">,</span> setup<span style="color: #66cc66;">=</span>setup<span style="color: #66cc66;">,</span> number<span style="color: #66cc66;">=</span><span style="color: #ff4500;">1000000</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;4&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge4(d1, d2)&quot;</span><span style="color: #66cc66;">,</span> setup<span style="color: #66cc66;">=</span>setup<span style="color: #66cc66;">,</span> number<span style="color: #66cc66;">=</span><span style="color: #ff4500;">1000000</span><span style="color: black;">&#41;</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Custom merge strategy&quot;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;1&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge1(d1, d2, merge_to_list)&quot;</span><span style="color: #66cc66;">,</span>
                               setup<span style="color: #66cc66;">=</span>setup<span style="color: #66cc66;">,</span> number<span style="color: #66cc66;">=</span><span style="color: #ff4500;">100000</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;2&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge2(d1, d2, merge_to_list)&quot;</span><span style="color: #66cc66;">,</span>
                               setup<span style="color: #66cc66;">=</span>setup<span style="color: #66cc66;">,</span> number<span style="color: #66cc66;">=</span><span style="color: #ff4500;">100000</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;3&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge3(d1, d2, merge_to_list)&quot;</span><span style="color: #66cc66;">,</span>
                               setup<span style="color: #66cc66;">=</span>setup<span style="color: #66cc66;">,</span> number<span style="color: #66cc66;">=</span><span style="color: #ff4500;">100000</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;4&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge4(d1, d2, merge_to_list)&quot;</span><span style="color: #66cc66;">,</span>
                               setup<span style="color: #66cc66;">=</span>setup<span style="color: #66cc66;">,</span> number<span style="color: #66cc66;">=</span><span style="color: #ff4500;">100000</span><span style="color: black;">&#41;</span>
&nbsp;
&nbsp;
    <span style="color: #808080; font-style: italic;"># le nombre de répétitions est bien plus faible ici car sinon le test</span>
    <span style="color: #808080; font-style: italic;"># est très très long</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Long dictionaries&quot;</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Default merge strategy&quot;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;1&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge1(d3, d4)&quot;</span><span style="color: #66cc66;">,</span> setup<span style="color: #66cc66;">=</span>setup<span style="color: #66cc66;">,</span> number<span style="color: #66cc66;">=</span><span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;2&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge2(d3, d4)&quot;</span><span style="color: #66cc66;">,</span> setup<span style="color: #66cc66;">=</span>setup<span style="color: #66cc66;">,</span> number<span style="color: #66cc66;">=</span><span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;3&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge3(d3, d4)&quot;</span><span style="color: #66cc66;">,</span> setup<span style="color: #66cc66;">=</span>setup<span style="color: #66cc66;">,</span> number<span style="color: #66cc66;">=</span><span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;4&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge4(d3, d4)&quot;</span><span style="color: #66cc66;">,</span> setup<span style="color: #66cc66;">=</span>setup<span style="color: #66cc66;">,</span> number<span style="color: #66cc66;">=</span><span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Custom merge strategy&quot;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;1&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge1(d3, d4, merge_to_list)&quot;</span><span style="color: #66cc66;">,</span>
                               setup<span style="color: #66cc66;">=</span>setup<span style="color: #66cc66;">,</span> number<span style="color: #66cc66;">=</span><span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;2&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge2(d3, d4, merge_to_list)&quot;</span><span style="color: #66cc66;">,</span>
                               setup<span style="color: #66cc66;">=</span>setup<span style="color: #66cc66;">,</span> number<span style="color: #66cc66;">=</span><span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;3&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge3(d3, d4, merge_to_list)&quot;</span><span style="color: #66cc66;">,</span>
                               setup<span style="color: #66cc66;">=</span>setup<span style="color: #66cc66;">,</span> number<span style="color: #66cc66;">=</span><span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;4&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge4(d3, d4, merge_to_list)&quot;</span><span style="color: #66cc66;">,</span>
                               setup<span style="color: #66cc66;">=</span>setup<span style="color: #66cc66;">,</span> number<span style="color: #66cc66;">=</span><span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Mixed dictionaries&quot;</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Default merge strategy&quot;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;1&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge1(d1, d4)&quot;</span><span style="color: #66cc66;">,</span> setup<span style="color: #66cc66;">=</span>setup<span style="color: #66cc66;">,</span> number<span style="color: #66cc66;">=</span><span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;2&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge2(d1, d4)&quot;</span><span style="color: #66cc66;">,</span> setup<span style="color: #66cc66;">=</span>setup<span style="color: #66cc66;">,</span> number<span style="color: #66cc66;">=</span><span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;3&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge3(d1, d4)&quot;</span><span style="color: #66cc66;">,</span> setup<span style="color: #66cc66;">=</span>setup<span style="color: #66cc66;">,</span> number<span style="color: #66cc66;">=</span><span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;4&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge4(d1, d4)&quot;</span><span style="color: #66cc66;">,</span> setup<span style="color: #66cc66;">=</span>setup<span style="color: #66cc66;">,</span> number<span style="color: #66cc66;">=</span><span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Custom merge strategy&quot;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;1&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge1(d1, d4, merge_to_list)&quot;</span><span style="color: #66cc66;">,</span>
                              setup<span style="color: #66cc66;">=</span>setup<span style="color: #66cc66;">,</span> number<span style="color: #66cc66;">=</span><span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;2&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge2(d1, d4, merge_to_list)&quot;</span><span style="color: #66cc66;">,</span>
                              setup<span style="color: #66cc66;">=</span>setup<span style="color: #66cc66;">,</span> number<span style="color: #66cc66;">=</span><span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;3&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge3(d1, d4, merge_to_list)&quot;</span><span style="color: #66cc66;">,</span>
                              setup<span style="color: #66cc66;">=</span>setup<span style="color: #66cc66;">,</span> number<span style="color: #66cc66;">=</span><span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;4&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge4(d1, d4, merge_to_list)&quot;</span><span style="color: #66cc66;">,</span>
                              setup<span style="color: #66cc66;">=</span>setup<span style="color: #66cc66;">,</span> number<span style="color: #66cc66;">=</span><span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
&nbsp;
&nbsp;
<span style="color: #808080; font-style: italic;"># Et voici le résultat que ça nous ressort. On voit clairement </span>
<span style="color: #808080; font-style: italic;"># que la 3eme fonction donne les meilleurs perfs, du coup</span>
<span style="color: #808080; font-style: italic;"># c'est celle qu'on a choisit</span>
&nbsp;
 <span style="color: #808080; font-style: italic;">## Generate test dicts</span>
 <span style="color: #808080; font-style: italic;">## Testing returns value all match</span>
 <span style="color: #808080; font-style: italic;">## Start timing</span>
 <span style="color: #808080; font-style: italic;">## Lots of collisions</span>
 <span style="color: #808080; font-style: italic;">## Default merge strategy</span>
 <span style="color: #808080; font-style: italic;">## 1 19.9299340248</span>
 <span style="color: #808080; font-style: italic;">## 2 148.185166121</span>
 <span style="color: #808080; font-style: italic;">## 3 21.2276539803</span>
 <span style="color: #808080; font-style: italic;">## 4 21.2074358463</span>
 <span style="color: #808080; font-style: italic;">## Custom merge strategy</span>
 <span style="color: #808080; font-style: italic;">## 1 30.646312952</span>
 <span style="color: #808080; font-style: italic;">## 2 18.522135973</span>
 <span style="color: #808080; font-style: italic;">## 3 14.0125968456</span>
 <span style="color: #808080; font-style: italic;">## 4 18.5139119625</span>
 <span style="color: #808080; font-style: italic;">## Long dictionaries</span>
 <span style="color: #808080; font-style: italic;">## Default merge strategy</span>
 <span style="color: #808080; font-style: italic;">## 1 84.4819910526</span>
 <span style="color: #808080; font-style: italic;">## 2 383.444111109</span>
 <span style="color: #808080; font-style: italic;">## 3 80.7273669243</span>
 <span style="color: #808080; font-style: italic;">## 4 86.0287930965</span>
 <span style="color: #808080; font-style: italic;">## Custom merge strategy</span>
 <span style="color: #808080; font-style: italic;">## 1 294.41114521</span>
 <span style="color: #808080; font-style: italic;">## 2 377.38009119</span>
 <span style="color: #808080; font-style: italic;">## 3 154.505481005</span>
 <span style="color: #808080; font-style: italic;">## 4 256.771039963</span>
 <span style="color: #808080; font-style: italic;">## Mixed dictionaries</span>
 <span style="color: #808080; font-style: italic;">## Default merge strategy</span>
 <span style="color: #808080; font-style: italic;">## 1 19.9574320316</span>
 <span style="color: #808080; font-style: italic;">## 2 87.1410660744</span>
 <span style="color: #808080; font-style: italic;">## 3 19.3570361137</span>
 <span style="color: #808080; font-style: italic;">## 4 19.524998188</span>
 <span style="color: #808080; font-style: italic;">## Custom merge strategy</span>
 <span style="color: #808080; font-style: italic;">## 1 60.6157000065</span>
 <span style="color: #808080; font-style: italic;">## 2 86.3876900673</span>
 <span style="color: #808080; font-style: italic;">## 3 59.0331327915</span>
 <span style="color: #808080; font-style: italic;">## 4 87.0504939556</span>
 <span style="color: #808080; font-style: italic;">## [Finished in 2494.7s]</span></pre></td></tr></table></div>

<p> Le test complet a pris en tout 2494.7s, soit 41 minutes, pour tourner sur ma machine, et je l&#8217;ai lancé plusieurs fois avec différentes modifs au fil de la journée. Il faut vraiment est un geek pour aimer faire ce genre de connerie. Parce que soyons honnête, tout le monde s&#8217;en branle des perfs de cette fonction :-)</p>
<p> Il faut savoir aussi qu&#8217;après coup j&#8217;ai réalisé que son code utilisait des listes en intention, et non des <a href="http://sametmax.com/python-love-les-listes-en-intention-partie-2/">expressions génératrices</a>, ce qui fait qu&#8217;il faut attendre que toute la liste soit générée avec que <code>update()</code> fasse son travail.</p>
<p> Il y avait donc des cas supplémentaires à tester et j&#8217;avais mergé son code dans batbelt. Arf, l&#8217;optimisation n&#8217;a jamais de fin ^^</p>
<p> Bref, j&#8217;ai relancé un test avec avec des listes en intentions (et même avec des expressions ternaires ce qui donne des trucs capilotractés):</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> dmerge1<span style="color: black;">&#40;</span>d1<span style="color: #66cc66;">,</span> d2<span style="color: #66cc66;">,</span> merge_func<span style="color: #66cc66;">=</span><span style="color: #008000;">None</span><span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;
        Une version de l'ancien dmerge3 qui utilise une expression génératrice.
    &quot;&quot;&quot;</span>
    d <span style="color: #66cc66;">=</span> <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span>
&nbsp;
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d1<span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">if</span> merge_func <span style="color: #ff7700;font-weight:bold;">is</span> <span style="color: #008000;">None</span>:
        d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d2<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>k<span style="color: #66cc66;">,</span> <span style="color: black;">&#40;</span>v <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> d <span style="color: #ff7700;font-weight:bold;">else</span> merge_func<span style="color: black;">&#40;</span>d<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span><span style="color: #66cc66;">,</span> v<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k<span style="color: #66cc66;">,</span> v <span style="color: #ff7700;font-weight:bold;">in</span> d2.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
&nbsp;
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> dmerge2<span style="color: black;">&#40;</span>d1<span style="color: #66cc66;">,</span> d2<span style="color: #66cc66;">,</span> merge_func<span style="color: #66cc66;">=</span><span style="color: #ff7700;font-weight:bold;">lambda</span> v1<span style="color: #66cc66;">,</span> v2: v2<span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;
        La version du proposée par notre gentil contributeur, mais
        avec des expressions génératrices à la place des listes en 
        intention.
    &quot;&quot;&quot;</span>
    d <span style="color: #66cc66;">=</span> <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span>
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>k<span style="color: #66cc66;">,</span> v<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k<span style="color: #66cc66;">,</span> v <span style="color: #ff7700;font-weight:bold;">in</span> d1.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> d2<span style="color: black;">&#41;</span>
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>k<span style="color: #66cc66;">,</span> v<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k<span style="color: #66cc66;">,</span> v <span style="color: #ff7700;font-weight:bold;">in</span> d2.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> d1<span style="color: black;">&#41;</span>
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>k<span style="color: #66cc66;">,</span> merge_func<span style="color: black;">&#40;</span>v<span style="color: #66cc66;">,</span> d2<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k<span style="color: #66cc66;">,</span> v <span style="color: #ff7700;font-weight:bold;">in</span> d1.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">in</span> d2<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
&nbsp;
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> dmerge3<span style="color: black;">&#40;</span>d1<span style="color: #66cc66;">,</span> d2<span style="color: #66cc66;">,</span> merge_func<span style="color: #66cc66;">=</span><span style="color: #008000;">None</span><span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;
      La version la plus rapide du test précédent.
    &quot;&quot;&quot;</span>
    d <span style="color: #66cc66;">=</span> <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span>
&nbsp;
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d1<span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">if</span> merge_func <span style="color: #ff7700;font-weight:bold;">is</span> <span style="color: #008000;">None</span>:
        d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d2<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">for</span> k<span style="color: #66cc66;">,</span> v <span style="color: #ff7700;font-weight:bold;">in</span> d2.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">in</span> d:
            d<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span> <span style="color: #66cc66;">=</span> merge_func<span style="color: black;">&#40;</span>d<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span><span style="color: #66cc66;">,</span> v<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">else</span>:
            d<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span> <span style="color: #66cc66;">=</span> v
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> dmerge4<span style="color: black;">&#40;</span>d1<span style="color: #66cc66;">,</span> d2<span style="color: #66cc66;">,</span> merge_func<span style="color: #66cc66;">=</span><span style="color: #008000;">None</span><span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;
        La version proposée par notre contributeur, optimisée comme un connard.
    &quot;&quot;&quot;</span>
    d <span style="color: #66cc66;">=</span> <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">if</span> merge_func <span style="color: #ff7700;font-weight:bold;">is</span> <span style="color: #008000;">None</span>:
        d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d1<span style="color: black;">&#41;</span>
        d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d2<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>k<span style="color: #66cc66;">,</span> v<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k<span style="color: #66cc66;">,</span> v <span style="color: #ff7700;font-weight:bold;">in</span> d1.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> d2<span style="color: black;">&#41;</span>
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>k<span style="color: #66cc66;">,</span> v<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k<span style="color: #66cc66;">,</span> v <span style="color: #ff7700;font-weight:bold;">in</span> d2.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> d1<span style="color: black;">&#41;</span>
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>k<span style="color: #66cc66;">,</span> merge_func<span style="color: black;">&#40;</span>v<span style="color: #66cc66;">,</span> d2<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k<span style="color: #66cc66;">,</span> v <span style="color: #ff7700;font-weight:bold;">in</span> d1.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">in</span> d2<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
&nbsp;
<span style="color: #808080; font-style: italic;">## Generate test dicts</span>
<span style="color: #808080; font-style: italic;">## Testing returns value all match</span>
<span style="color: #808080; font-style: italic;">## Start timing</span>
<span style="color: #808080; font-style: italic;">## Lots of collisions</span>
<span style="color: #808080; font-style: italic;">## Default merge strategy</span>
<span style="color: #808080; font-style: italic;">## 1 12.2690660954</span>
<span style="color: #808080; font-style: italic;">## 2 97.121183157</span>
<span style="color: #808080; font-style: italic;">## 3 12.1084120274</span>
<span style="color: #808080; font-style: italic;">## 4 12.6807589531</span>
<span style="color: #808080; font-style: italic;">## Custom merge strategy</span>
<span style="color: #808080; font-style: italic;">## 1 8.73903894424</span>
<span style="color: #808080; font-style: italic;">## 2 12.0493769646</span>
<span style="color: #808080; font-style: italic;">## 3 8.00074601173</span>
<span style="color: #808080; font-style: italic;">## 4 11.4764301777</span>
<span style="color: #808080; font-style: italic;">## Long dictionaries</span>
<span style="color: #808080; font-style: italic;">## Default merge strategy</span>
<span style="color: #808080; font-style: italic;">## 1 54.5233860016</span>
<span style="color: #808080; font-style: italic;">## 2 218.695598841</span>
<span style="color: #808080; font-style: italic;">## 3 70.213809967</span>
<span style="color: #808080; font-style: italic;">## 4 61.8348701</span>
<span style="color: #808080; font-style: italic;">## Custom merge strategy</span>
<span style="color: #808080; font-style: italic;">## 1 103.258821964</span>
<span style="color: #808080; font-style: italic;">## 2 217.720175982</span>
<span style="color: #808080; font-style: italic;">## 3 96.5204670429</span>
<span style="color: #808080; font-style: italic;">## 4 214.480421066</span>
<span style="color: #808080; font-style: italic;">## Mixed dictionaries</span>
<span style="color: #808080; font-style: italic;">## Default merge strategy</span>
<span style="color: #808080; font-style: italic;">## 1 19.169850111</span>
<span style="color: #808080; font-style: italic;">## 2 66.9599928856</span>
<span style="color: #808080; font-style: italic;">## 3 19.4371211529</span>
<span style="color: #808080; font-style: italic;">## 4 19.5183057785</span>
<span style="color: #808080; font-style: italic;">## Custom merge strategy</span>
<span style="color: #808080; font-style: italic;">## 1 64.7940750122</span>
<span style="color: #808080; font-style: italic;">## 2 66.9712991714</span>
<span style="color: #808080; font-style: italic;">## 3 58.5918440819</span>
<span style="color: #808080; font-style: italic;">## 4 67.5281140804</span>
<span style="color: #808080; font-style: italic;">## [Finished in 1619.3s]</span></pre></td></tr></table></div>

<p>La bonne nouvelle pour moi, c&#8217;est que l&#8217;algo 3 est toujours le plus rapide, j&#8217;ai pas à re pusher.</p>
<p>Mais il est intéressant de constater que globalement les 4 tests mettent 1619.3s à s’exécuter. Globalement utiliser des expressions génératrices boost bien les perfs.</p>
<hr />
<p><a href="https://github.com/sametmax/codes-des-articles/blob/master/2013/juin/perf.py">Télécharger le code de l&#8217;article.</a></p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/mesurer-les-performances-dun-snippet-python/feed/</wfw:commentRss>
		<slash:comments>6</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2013/06/rmhtBR7.jpg" length="92496" type="image/jpg" />	</item>
		<item>
		<title>Les vues sur des collections en Python 15</title>
		<link>http://sametmax.com/les-vues-sur-des-collections-en-python/</link>
		<comments>http://sametmax.com/les-vues-sur-des-collections-en-python/#comments</comments>
		<pubDate>Sat, 03 Nov 2012 18:57:02 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[dict]]></category>
		<category><![CDATA[generators]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[strings]]></category>
		<category><![CDATA[views]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=2785</guid>
		<description><![CDATA[Python 3 introduit de nombreux changements qui ont été backportés dans Python 2.7. Parmis eux, les vues, qui sont un concept assez mal expliqué dans la documentation standard.]]></description>
				<content:encoded><![CDATA[<p>Python 3 introduit de nombreux changements qui ont été backportés dans Python 2.7. Parmi eux, les vues, qui sont un concept assez mal expliqué dans la documentation standard.</p>
<h2>Dictionary views</h2>
<p>Quand on voulait travailler sur les valeurs d&#8217;un dictionnaire en Python, on avait deux choix:</p>
<ul>
<li>faire <code>dict.values()</code> et récupérer une liste entière. Créant une liste entière en mémoire.</li>
<li>faire <code>dict.itervalues()</code>, et récupérer un générateur. Mais qui ne peut être lu qu&#8217;une fois.</li>
</ul>
<p>Les vues sont une solution intermédiaire: ce sont des objets qui prennent peu de mémoire, mais qui peuvent être lus plusieurs fois.</p>
<p>Exemple:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> scores <span style="color: #66cc66;">=</span> <span style="color: black;">&#123;</span><span style="color: #483d8b;">'foo'</span>: <span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'bar'</span>: <span style="color: #ff4500;">0</span><span style="color: black;">&#125;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> val <span style="color: #66cc66;">=</span> scores.<span style="color: black;">viewvalues</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">print</span> val
dict_values<span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">0</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff4500;">1</span> <span style="color: #ff7700;font-weight:bold;">in</span> val
<span style="color: #008000;">True</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: black;">&#91;</span>x * <span style="color: #ff4500;">2</span> <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> val<span style="color: black;">&#93;</span>
<span style="color: black;">&#91;</span><span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">0</span><span style="color: black;">&#93;</span></pre></td></tr></table></div>

<p>Contrairement à une liste, les vues issues d&#8217;un dictionnaire ne supportent pas le slicing ou l&#8217;assignation et il n&#8217;y a aucune garantie d&#8217;ordre des éléments. De plus, elles ne peuvent être modifiées.</p>
<p>Bref, <strong>une vue ne contient rien</strong>, c&#8217;est juste un objet qui, quand on accède à son contenu, va le chercher dans le dictionnaire et vous le retourne. C&#8217;est ce qu&#8217;on appelle un objet proxy: il vous donne l&#8217;illusion d&#8217;accéder directement aux données pour vous faciliter la vie, généralement en vous les présentant sous une forme différente: ici un itérable.</p>
<p>On peut récupérer des vues pour les valeurs, mais également pour les clés et les couples clés / valeurs. Ces deux types de vues se comportent en plus comme des <a href="http://sametmax.com/ce-que-vous-ne-saviez-pas-sur-les-collections-en-python/">sets</a>:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> scores.<span style="color: black;">viewitems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
dict_items<span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'foo'</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: black;">&#40;</span><span style="color: #483d8b;">'bar'</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">0</span><span style="color: black;">&#41;</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> scores.<span style="color: black;">viewkeys</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> | <span style="color: black;">&#91;</span><span style="color: #ff4500;">3</span><span style="color: #66cc66;">,</span><span style="color: black;">&#93;</span>
<span style="color: #008000;">set</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">3</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'foo'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'bar'</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Puisqu&#8217;il est rare d&#8217;avoir besoin d&#8217;une vraie liste, et comme les vues sont une très bonne alternative aux générateurs, <code>dict.values</code> et consorts retournent des vues en Python 3.</p>
<p>Maintenant vous allez me dire &#8220;Mais si les vues sont une si bonne alternative aux générateurs, pourquoi on ne remplace pas tous les générateurs par des vues ?&#8221;. </p>
<p>Tout simplement parce que ce n&#8217;est pas possible. Un générateur est un mécanisme standard qui permet de produire des valeurs une par une. N&#8217;importe qui peut créer un générateur, car c&#8217;est un concept portable d&#8217;un problème à un autre. On peut l&#8217;appliquer à de nombreuses choses: algorithme, flux de données, fichier, etc. </p>
<p>Une vue n&#8217;est qu&#8217;un proxy qui permet de voir une <a href="http://sametmax.com/quest-ce-quune-structure-de-donnees/">structure de données</a> sous une autre forme. Il faut coder une vue par type de structure de données, car la vue va chercher les données dans cette structure quand on lui demande. Le code est donc différent à chaque fois.</p>
<p>Python ne permet pas de créer soi-même des vues, mais créer un proxy, c&#8217;est à dire un objet qui retourne les valeurs d&#8217;un autre objet quand on l&#8217;interroge, peut se faire à la main dans tout langage de programmation. Ainsi vous pourriez créer un proxy qui ressemble a une vue des clés d&#8217;un dico très simplement:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">class</span> keyview<span style="color: black;">&#40;</span><span style="color: #008000;">object</span><span style="color: black;">&#41;</span>:
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__init__</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> d<span style="color: black;">&#41;</span>:
        <span style="color: #008000;">self</span>.<span style="color: black;">d</span> <span style="color: #66cc66;">=</span> d
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__iter__</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">self</span>.<span style="color: black;">d</span>.<span style="color: black;">iterkeys</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #66cc66;">&gt;&gt;&gt;</span> view <span style="color: #66cc66;">=</span> keyview<span style="color: black;">&#40;</span>scores<span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> view:
...     <span style="color: #ff7700;font-weight:bold;">print</span> x
...     
<span style="color: black;">foo</span>
bar
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">list</span><span style="color: black;">&#40;</span>view<span style="color: black;">&#41;</span>
<span style="color: black;">&#91;</span><span style="color: #483d8b;">'foo'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'bar'</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span></pre></td></tr></table></div>

<p>L&#8217;implémentation réelle de Python (en C&#8230;) ne fait pas vraiment grand chose de plus, juste un travail d&#8217;optimisation pour être plus rapide.</p>
<h2>memoryview</h2>
<p>Les memory views suivent le même principe, mais appliqué à toute structure de données qui supporte le buffer protocole (un certain nombre de méthodes avec un nom et un comportement défini par ce protocole) comme celles trouvées dans le module <code>struct</code> ou <code>array</code>. La structure de données la plus connue qui suit le buffer protocole est la chaîne de caractères.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> s <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">'Sam &amp; Max eat the road with a Github fork'</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> ms <span style="color: #66cc66;">=</span> memoryview<span style="color: black;">&#40;</span>s<span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> ms<span style="color: black;">&#91;</span>-<span style="color: #ff4500;">1</span><span style="color: black;">&#93;</span>
<span style="color: #483d8b;">'k'</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> ms<span style="color: black;">&#91;</span>:<span style="color: #ff4500;">9</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&lt;</span>memory at <span style="color: #ff4500;">0x25ded60</span><span style="color: #66cc66;">&gt;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #483d8b;">''</span>.<span style="color: black;">join</span><span style="color: black;">&#40;</span>ms<span style="color: black;">&#91;</span>:<span style="color: #ff4500;">9</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
<span style="color: #483d8b;">'Sam &amp; Max'</span></pre></td></tr></table></div>

<p>Le principal intérêt de la memory view appliquée aux strings, c&#8217;est que tout slicing retourne une nouvelle memory view. On peut donc travailler sur des parties de la chaînes sans créer une nouvelle chaîne en mémoire.</p>
<p>En revanche, les chaînes unicodes ne sont pas supportées. Il vous faudra jouer avec <code>encode()</code> et <code>decode()</code>.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/les-vues-sur-des-collections-en-python/feed/</wfw:commentRss>
		<slash:comments>15</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2012/11/fenetretravaux.jpg" length="392879" type="image/jpg" />	</item>
	</channel>
</rss>
