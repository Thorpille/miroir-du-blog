<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Sam &#38; Max &#187; c</title>
	<atom:link href="http://sametmax.com/tag/c/feed/" rel="self" type="application/rss+xml" />
	<link>http://sametmax.com</link>
	<description>Du code, du cul</description>
	<lastBuildDate>Sat, 07 Nov 2015 10:56:13 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>http://wordpress.org/?v=4.1</generator>
	<item>
		<title>Lire un format binaire en Python avec struct 22</title>
		<link>http://sametmax.com/lire-un-format-binaire-en-python-avec-struct/</link>
		<comments>http://sametmax.com/lire-un-format-binaire-en-python-avec-struct/#comments</comments>
		<pubDate>Fri, 26 Jun 2015 06:51:28 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[binaire]]></category>
		<category><![CDATA[c]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=16503</guid>
		<description><![CDATA[Une suite de valeurs ne veut rien dire en soit, et même le sacro-saint binaire supposé être le socle de toute l'informatique n'a aucun sens si on ne connaît pas le format de ce qu'il doit représenter.

Pour autant, cela ne veut pas dire qu'il n'existe pas des formats prépondérant, et en informatique, beaucoup de données binaires sont organisées pour correspondre aux structures de données du langage C.]]></description>
				<content:encoded><![CDATA[<p>Une suite de valeurs ne veut rien dire en soi, et même le sacro-saint binaire supposé être le socle de toute l&#8217;informatique n&#8217;a aucun sens si on ne connaît pas le format utilisé pour ce qu&#8217;il doit représenter.</p>
<p>Toujours la même opposition entre données et représentation.</p>
<p>Par exemple, le binaire peut représenter <a href="http://sametmax.com/la-fin-du-mystere-du-binaire-nananere/">un chiffre en base 2</a> ou <a href="http://sametmax.com/lencoding-en-python-une-bonne-fois-pour-toute/">un texte encodé</a>.</p>
<p>Pour autant, cela ne veut pas dire qu&#8217;il n&#8217;existe pas des formats prépondérant. En informatique, beaucoup de données binaires sont organisées pour correspondre aux structures de données du langage C, ces dernières étant une implémentation du standard <a href="https://fr.wikipedia.org/wiki/IEEE_754">IEEE 754</a> (en effet les strings sont des arrays d&#8217;int en C, donc le texte et les nombres sont des suites de chiffres).</p>
<p>Par exemple, si vous créez un array numpy contenant des nombres de 0 à 1000 stockés en int32 et sauvegardez son contenu dans un fichier :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">import</span> numpy
<span style="color: #66cc66;">&gt;&gt;&gt;</span> numpy.<span style="color: black;">arange</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">0</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1000</span><span style="color: #66cc66;">,</span> dtype<span style="color: #66cc66;">=</span>np.<span style="color: black;">int32</span><span style="color: black;">&#41;</span>.<span style="color: black;">tofile</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'/tmp/data'</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Le fichier va ici contenir une suite de 1 et de 0 représentant 1000 entiers, chacun comme un paquet de 4 octets organisés selon la sémantique que comprend le langage C.</p>
<p>Pour avoir une idée de l&#8217;organisation du contenu, on peut prendre un éditeur hexa qui vous affichera :</p>
<pre>0000 0000 0100 0000 0200 0000 0300 0000 0400 0000 0500 0000 0600 0000 0700 0000 0800 0000 0900 0000 0a00 0000 0b00 0000 0c00 0000 0d00 0000 0e00 0000 0f00 0000 1000 0000 1100 0000 1200 0000 1300 0000</pre>
<p>Ça se lit ainsi :</p>
<pre>
0000 0000 => 0
0100 0000 => 1
0200 0000 => 2
0300 0000 => 3
0400 0000 => 4
0500 0000 => 5
0600 0000 => 6
0700 0000 => 7
0800 0000 => 8
0900 0000 => 9
0a00 0000 => 10
0b00 0000 => 11
0c00 0000 => 12
0d00 0000 => 13
0e00 0000 => 14
0f00 0000 => 15
1000 0000 => 16
1100 0000 => 17
1200 0000 => 18
1300 0000 => 19
...</pre>
<p>Numpy étant codé en C, cela semble plutôt logique qu&#8217;il dump tout ça dans ce format.</p>
<p>Mais c&#8217;est une représentation tellement courante que de nombreux formats standards l&#8217;utilisent. Par exemple, les archives et les images stockent souvent leurs données ainsi.</p>
<p>Prenez le format d&#8217;image PNG, la <a href="https://tools.ietf.org/html/rfc2083">RFC indique</a> que la taille de l&#8217;image est stockée dans le fichier sous la forme de deux entiers représentés par 4 octets chacun, ordonnés en <a href="https://fr.wikipedia.org/wiki/Endianness">big-endian</a>, entre l&#8217;octet 16 et l&#8217;octet 24.</p>
<p>On peut donc récupérer ces informations en lisant son fichier image :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">with</span> <span style="color: #008000;">open</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'image.png'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'rb'</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">as</span> f:
    taille <span style="color: #66cc66;">=</span> f.<span style="color: black;">read</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">24</span><span style="color: black;">&#41;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">16</span>:<span style="color: #ff4500;">24</span><span style="color: black;">&#93;</span></pre></td></tr></table></div>

<p>Le problème étant : comment lire cette info ? C&#8217;est un blob binaire qui ne veut rien dire pour Python :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>taille<span style="color: black;">&#41;</span>
b<span style="color: #483d8b;">'<span style="color: #000099; font-weight: bold;">\x</span>00<span style="color: #000099; font-weight: bold;">\x</span>00<span style="color: #000099; font-weight: bold;">\x</span>07<span style="color: #000099; font-weight: bold;">\x</span>80<span style="color: #000099; font-weight: bold;">\x</span>00<span style="color: #000099; font-weight: bold;">\x</span>00<span style="color: #000099; font-weight: bold;">\x</span>048'</span></pre></td></tr></table></div>

<p>Le module <a href="https://docs.python.org/3.4/library/struct.html">struct</a> est fait pour ça, on lui passe une donnée au format structure C, et il la convertit en type Python. Cela marche <del datetime="2015-06-26T06:29:30+00:00">ansi</del>, pardon, ainsi :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #dc143c;">struct</span>.<span style="color: black;">unpack</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'motif_du_format_a_convertir'</span><span style="color: #66cc66;">,</span> donnee<span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Le format à convertir est une chaîne de caractères qui contient des symboles décrivant la structure de la donnée qu&#8217;on souhaite récupérer. Little-endian ou big-endian ? String, Int, Bool ?</p>
<p>Pour la taille de la photo, on sait qu&#8217;il y a deux entiers, non signés (une taille ne va pas être négative), en big-endian. D&#8217;après la doc de <code>struct</code>, on peut lui désigner un entier non signé avec &#8216;I&#8217;, et il faut les qualifier avec &#8216;>&#8217; pour l&#8217;ordre big-endian. Du coup:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">taille <span style="color: #66cc66;">=</span> <span style="color: #dc143c;">struct</span>.<span style="color: black;">unpack</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'&gt;II'</span><span style="color: #66cc66;">,</span> taille<span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>taille<span style="color: black;">&#41;</span>
<span style="color: black;">&#40;</span><span style="color: #ff4500;">1920</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1080</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Il se trouve que mon image de test est un screenshot et que mon écran a une résolution de 1920&#215;1080 :)</p>
<p>On peut faire l&#8217;opération inverse avec <code>struct.pack</code>, et bien entendu manipuler des formats plus complexes : il suffit de changer le motif qui représente le format à convertir.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/lire-un-format-binaire-en-python-avec-struct/feed/</wfw:commentRss>
		<slash:comments>22</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2015/06/a.gif" length="743276" type="image/jpg" />	</item>
		<item>
		<title>Embeder Python dans du C ou C++ 6</title>
		<link>http://sametmax.com/embeder-python-dans-du-c-ou-c/</link>
		<comments>http://sametmax.com/embeder-python-dans-du-c-ou-c/#comments</comments>
		<pubDate>Wed, 14 Jan 2015 03:21:25 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[c]]></category>
		<category><![CDATA[compiler]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=15727</guid>
		<description><![CDATA[L'implémentation de référence de Python est écrite en C, et son API est exposée et bien <a href="https://docs.python.org/2/c-api/">documentée</a>. Il est donc possible de créer des objets Python, charger un module Python ou exécuter une fonction Python depuis un code C et compiler tout ça.]]></description>
				<content:encoded><![CDATA[<p>L&#8217;implémentation de référence de Python est écrite en C, et son API est exposée et bien <a href="https://docs.python.org/2/c-api/">documentée</a>. Il est donc possible de créer des objets Python, charger un module Python ou exécuter une fonction Python depuis un code C/C++ et compiler tout ça.</p>
<p>Mettons que j&#8217;ai dans un fichier <code>biblio.py</code> :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> yolo<span style="color: black;">&#40;</span>arg<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">return</span> arg.<span style="color: black;">upper</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> + <span style="color: #483d8b;">' !!'</span></pre></td></tr></table></div>

<p>Je peux écrire un fichier <code>prog.c</code> qui l&#8217;utilise :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="c" style="font-family:monospace;"><span style="color: #339933;">#include &lt;Python.h&gt;</span>
&nbsp;
<span style="color: #993333;">int</span> main <span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #666666; font-style: italic;">// PyObject est un wrapper Python autour des objets qu'on</span>
    <span style="color: #666666; font-style: italic;">// va échanger enter le C et Python.</span>
    PyObject <span style="color: #339933;">*</span>retour<span style="color: #339933;">,</span> <span style="color: #339933;">*</span>module<span style="color: #339933;">,</span> <span style="color: #339933;">*</span>fonction<span style="color: #339933;">,</span> <span style="color: #339933;">*</span>arguments<span style="color: #339933;">;</span>
    <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>resultat<span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #666666; font-style: italic;">// Initialisation de l'interpréteur. A cause du GIL, on ne peut</span>
    <span style="color: #666666; font-style: italic;">// avoir qu'une instance de celui-ci à la fois.</span>
    Py_Initialize<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>   
&nbsp;
    <span style="color: #666666; font-style: italic;">// Import du script. </span>
    PySys_SetPath<span style="color: #009900;">&#40;</span><span style="color: #ff0000;">&quot;.&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">// Le dossier en cours n'est pas dans le PYTHON PATH</span>
    module <span style="color: #339933;">=</span> PyImport_ImportModule<span style="color: #009900;">&#40;</span><span style="color: #ff0000;">&quot;biblio&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #666666; font-style: italic;">// Récupération de la fonction</span>
    fonction <span style="color: #339933;">=</span> PyObject_GetAttrString<span style="color: #009900;">&#40;</span>module<span style="color: #339933;">,</span> <span style="color: #ff0000;">&quot;yolo&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #666666; font-style: italic;">// Création d'un PyObject de type string. Py_BuildValue peut créer</span>
    <span style="color: #666666; font-style: italic;">// tous les types de base Python. Voir :</span>
    <span style="color: #666666; font-style: italic;">// https://docs.python.org/2/c-api/arg.html#c.Py_BuildValue</span>
    arguments <span style="color: #339933;">=</span> Py_BuildValue<span style="color: #009900;">&#40;</span><span style="color: #ff0000;">&quot;(s)&quot;</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">&quot;Leroy Jenkins&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> 
&nbsp;
    <span style="color: #666666; font-style: italic;">// Appel de la fonction.</span>
    retour <span style="color: #339933;">=</span> PyEval_CallObject<span style="color: #009900;">&#40;</span>fonction<span style="color: #339933;">,</span> arguments<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #666666; font-style: italic;">// Conversion du PyObject obtenu en string C</span>
    PyArg_Parse<span style="color: #009900;">&#40;</span>retour<span style="color: #339933;">,</span> <span style="color: #ff0000;">&quot;s&quot;</span><span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>resultat<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #000066;">printf</span><span style="color: #009900;">&#40;</span><span style="color: #ff0000;">&quot;Resultat: %s<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span> resultat<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #666666; font-style: italic;">// On ferme cet interpréteur.</span>
    Py_Finalize<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> 
    <span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span></pre></td></tr></table></div>

<p>Là je mets du C, mais la seule vraie différence avec du C++, c&#8217;est qu&#8217;on aurait <code>cout</code> au lieu de <code>printf</code>.</p>
<p>Pour compiler tout ça, il faut les headers Python et un compilateur. Sous Ubuntu, c&#8217;est un simple :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">sudo</span> <span style="color: #c20cb9; font-weight: bold;">apt-get install</span> python-dev <span style="color: #c20cb9; font-weight: bold;">gcc</span></pre></td></tr></table></div>

<p>Et on a tout nos <code>.h</code> dans /usr/include/python2.7. On gccise :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">gcc</span> -I<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>include<span style="color: #000000; font-weight: bold;">/</span>python2.7 prog.c -lpython2.7 <span style="color: #660033;">-o</span> prog <span style="color: #660033;">-Wall</span>  <span style="color: #000000; font-weight: bold;">&amp;&amp;</span> .<span style="color: #000000; font-weight: bold;">/</span>prog</pre></td></tr></table></div>

<p>Même pas un warning, c&#8217;est beau.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">.<span style="color: #000000; font-weight: bold;">/</span>prog
Resultat: LEROY JENKINS <span style="color: #000000; font-weight: bold;">!!</span></pre></td></tr></table></div>

<p>C&#8217;est un exemple simple, mais comme vous le savez je suis une grosse burne en C, donc je ne pourrai pas porter l&#8217;expérience plus loin.</p>
<p>Je ne le recommande pas pour rendre votre programme scriptable en Python. Il <a href="http://twistedmatrix.com/users/glyph/rant/extendit.html">vaut mieux</a> permettre à Python d&#8217;appeler votre code C dans ce cas. Des outils comme <a href="https://cffi.readthedocs.org/en/release-0.8/">cffi</a> rendent cela beaucoup plus facile et rentable que tout faire tout le taff à la main. D&#8217;ailleurs si quelqu&#8217;un est chaud pour faire un tuto sur cffi&#8230;</p>
<p>Non, c&#8217;est plus dans le cas où vous avez un programme C, un programme Python, et votre programme C veut utiliser le programme Python sans avoir à tout réécrire. Ou pour le cas où vous avez décidé d&#8217;écrire une grosse partie de votre programme en Python pour profiter de sa productivité, mais que vous ne pouvez pas installer Python sur la machine sur laquelle vous aller installer le programme. Bon, y a <a href="https://github.com/pyinstaller/pyinstaller/wiki">PyInstaller</a> et <a href="http://nuitka.net/">Nuitka</a> pour ça également hein, donc tentez avant de tout embeder comme un bourrin.</p>
<p>Ça reste intéressant de voir les entrailles de CPython et à quel point il joue bien avec les langages bas niveaux.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/embeder-python-dans-du-c-ou-c/feed/</wfw:commentRss>
		<slash:comments>6</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2015/01/tumblr_mv7qein3JN1r539hzo1_400.jpg" length="64870" type="image/jpg" />	</item>
		<item>
		<title>Peut-on compiler un programme Python ? 28</title>
		<link>http://sametmax.com/peut-on-compiler-un-programme-python/</link>
		<comments>http://sametmax.com/peut-on-compiler-un-programme-python/#comments</comments>
		<pubDate>Sun, 11 May 2014 16:58:00 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[c]]></category>
		<category><![CDATA[compilation]]></category>
		<category><![CDATA[cython]]></category>
		<category><![CDATA[exe]]></category>
		<category><![CDATA[executable]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=10245</guid>
		<description><![CDATA[Cython visait les perfs, l'intégration, faire des dll/so en Python, et du coup, dans l'excitation, tout le monde a loupé un petit détail minuscule.

Les mecs avaient implémenté un compilateur Python => C complet.]]></description>
				<content:encoded><![CDATA[<p>Sans répit, des hordes d&#8217;OP ont demandé sur Stackoverflow comment compiler un programme Python. La plupart du temps, pour des raisons d’obfuscation ou pour faire un joli .exe. Et inlassablement, les devs bienveillants leur répondaient que Python était un langage interprété, et donc non compilable.</p>
<p>Commença alors la lente fuite des impatients vers Go qui permettait de le faire si facilement.</p>
<p>Et puis arriva <a href="http://cython.org/">Cython</a>, qui promettait de permettre de transformer du Python en C, afin de l&#8217;embarquer dans un autre code C, ou permettre des appels de C vers Python et inversement plus facile.</p>
<p>Cela visait les perfs, l&#8217;intégration, faire des dll/so en Python, et du coup, dans l&#8217;excitation, tout le monde a loupé un petit détail minuscule.</p>
<p>Les mecs avaient implémenté un compilateur Python => C complet.</p>
<p>En fait, Cython permet &#8211; et c&#8217;est la que c&#8217;est fun car c&#8217;est un effet de bord presque involontaire &#8211; de créer un programme compilé <strong>autonome</strong> en Python. Et avec la toolchain classique en plus.</p>
<p>Ça peut gérer les dépendances, et ça marche même avec des trucs compilés balèzes du genre PyQT. </p>
<p>Je sens le chapiteau se dresser sous la braguette, alors voici la démo&#8230;</p>
<p>Pour montrer qu&#8217;on ne fait pas que du &#8220;Hello World&#8221;, je vais utiliser des dépendances assez complexes : <a href="http://lxml.de">lxml</a> (qui contient une extension C compilée), <a href="http://sametmax.com/sept-petites-libs-qui-changent-la-vie-dun-dev-python/">path.py, requests</a> et <a href="http://sametmax.com/la-plus-belle-maniere-de-parser-les-arguments-de-script-en-python/">docopt</a> :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #483d8b;">&quot;&quot;&quot;
    Download a file and save it to a location.
&nbsp;
    Usage:
        downloader.py &lt;target&gt; [&lt;location&gt;]
&quot;&quot;&quot;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">import</span> requests
<span style="color: #ff7700;font-weight:bold;">import</span> docopt
&nbsp;
<span style="color: #ff7700;font-weight:bold;">from</span> lxml.<span style="color: black;">html</span> <span style="color: #ff7700;font-weight:bold;">import</span> parse
<span style="color: #ff7700;font-weight:bold;">from</span> path <span style="color: #ff7700;font-weight:bold;">import</span> path
&nbsp;
args <span style="color: #66cc66;">=</span> docopt.<span style="color: black;">docopt</span><span style="color: black;">&#40;</span>__doc__<span style="color: black;">&#41;</span>
&nbsp;
p <span style="color: #66cc66;">=</span> path<span style="color: black;">&#40;</span>args<span style="color: black;">&#91;</span><span style="color: #483d8b;">'&lt;location&gt;'</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>.<span style="color: black;">realpath</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">if</span> p.<span style="color: black;">isdir</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    p <span style="color: #66cc66;">=</span> p / path<span style="color: black;">&#40;</span>args<span style="color: black;">&#91;</span><span style="color: #483d8b;">'&lt;target&gt;'</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>.<span style="color: black;">namebase</span>
&nbsp;
p.<span style="color: black;">write_bytes</span><span style="color: black;">&#40;</span>requests.<span style="color: black;">get</span><span style="color: black;">&#40;</span>args<span style="color: black;">&#91;</span><span style="color: #483d8b;">'&lt;target&gt;'</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>.<span style="color: black;">content</span><span style="color: black;">&#41;</span>
&nbsp;
title <span style="color: #66cc66;">=</span> parse<span style="color: black;">&#40;</span>p<span style="color: black;">&#41;</span>.<span style="color: black;">getroot</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>.<span style="color: black;">find</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'head'</span><span style="color: black;">&#41;</span>.<span style="color: black;">find</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'title'</span><span style="color: black;">&#41;</span>.<span style="color: black;">text</span>
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'Downloaded &quot;%s&quot;'</span> % title<span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Je ne m&#8217;encombre pas de gestion d&#8217;erreurs, juste suffisamment d&#8217;appels pour faire travailler les dépendances.</p>
<p>Qui dit compilation, dit environnement. Pour ma part, je suis sous Ubuntu 14.04 et je vais me compiler un petit programme en Python 3, avec lesquels il me faut installer Cython et <a href="http://sametmax.com/votre-python-aime-les-pip/">pip</a> pour Python 3, de quoi compiler du C, et les dépendances de notre script :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">$ <span style="color: #c20cb9; font-weight: bold;">sudo</span> <span style="color: #c20cb9; font-weight: bold;">apt-get install</span> <span style="color: #c20cb9; font-weight: bold;">gcc</span> cython3 python-pip3 python3-lxml
$ pip3 <span style="color: #c20cb9; font-weight: bold;">install</span> requests docopt path.py</pre></td></tr></table></div>

<p>Je n&#8217;ai même pas eu besoin d&#8217;installer les headers de lxml. Vive le Dieu des geeks.</p>
<p>L&#8217;utilisation de Cython dans notre cas est assez simple : on lui dit de transformer notre module en module C. <code>--embed</code> lui dit d&#8217;inclure l&#8217;interpréteur Python dedans.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #666666;">$ </span>cython3 downloader.py <span style="color: #660033;">-o</span> downloader.c <span style="color: #660033;">--embed</span></pre></td></tr></table></div>

<p>On obtient un fichier C bien copieux :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">$ <span style="color: #c20cb9; font-weight: bold;">head</span> downloader.c
<span style="color: #000000; font-weight: bold;">/*</span> Generated by Cython 0.20.1post0 <span style="color: #7a0874; font-weight: bold;">&#40;</span>Debian 0.20.1+git90-g0e6e38e-1ubuntu2<span style="color: #7a0874; font-weight: bold;">&#41;</span> on Sun May <span style="color: #000000;">11</span> <span style="color: #000000;">22</span>:<span style="color: #000000;">53</span>:<span style="color: #000000;">18</span> <span style="color: #000000;">2014</span> <span style="color: #000000; font-weight: bold;">*/</span>
&nbsp;
<span style="color: #666666; font-style: italic;">#define PY_SSIZE_T_CLEAN</span>
<span style="color: #666666; font-style: italic;">#ifndef CYTHON_USE_PYLONG_INTERNALS</span>
<span style="color: #666666; font-style: italic;">#ifdef PYLONG_BITS_IN_DIGIT</span>
<span style="color: #666666; font-style: italic;">#define CYTHON_USE_PYLONG_INTERNALS 0</span>
<span style="color: #666666; font-style: italic;">#else</span>
<span style="color: #666666; font-style: italic;">#include &quot;pyconfig.h&quot;</span>
<span style="color: #666666; font-style: italic;">#ifdef PYLONG_BITS_IN_DIGIT</span>
<span style="color: #666666; font-style: italic;">#define CYTHON_USE_PYLONG_INTERNALS 1</span></pre></td></tr></table></div>

<p>Il ne reste plus qu&#8217;à compiler ce dernier :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #666666;">$ </span><span style="color: #c20cb9; font-weight: bold;">gcc</span> <span style="color: #660033;">-Os</span> <span style="color: #660033;">-I</span> <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>include<span style="color: #000000; font-weight: bold;">/</span>python3.4m  downloader.c <span style="color: #660033;">-o</span> download -lpython3.4m <span style="color: #660033;">-lpthread</span> <span style="color: #660033;">-lm</span> <span style="color: #660033;">-lutil</span> <span style="color: #660033;">-ldl</span></pre></td></tr></table></div>

<p>J&#8217;ai mis <code>-I /usr/include/python3.4m</code> et <code>-lpython3.4m</code> car les headers de Python sont là dedans sur ma machine. Le reste, ce sont des options que j&#8217;ai copier / coller sur le Web car GCC a plus de flags qu&#8217;une ambassade américaine et que j&#8217;ai des choses plus importantes à retenir, comme par exemple la recette du guacamole.</p>
<p>On obtient un exécutable tout à fait exécutablatoire :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">$ <span style="color: #c20cb9; font-weight: bold;">chmod</span> u+x downloader
$ .<span style="color: #000000; font-weight: bold;">/</span>downloader <span style="color: #666666; font-style: italic;"># docopt marche :)</span>
Usage:
       downloader.py <span style="color: #000000; font-weight: bold;">&lt;</span>target<span style="color: #000000; font-weight: bold;">&gt;</span> <span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #000000; font-weight: bold;">&lt;</span>location<span style="color: #000000; font-weight: bold;">&gt;</span><span style="color: #7a0874; font-weight: bold;">&#93;</span></pre></td></tr></table></div>

<p>Et ça télécharge comme prévu :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">$ .<span style="color: #000000; font-weight: bold;">/</span>downloader http:<span style="color: #000000; font-weight: bold;">//</span>sametmax.com index.html
Downloaded <span style="color: #ff0000;">&quot;Sam &amp; Max: Python, Django, Git et du cul | Deux développeurs en vadrouille qui se sortent les doigts du code&quot;</span></pre></td></tr></table></div>

<p>Le script Python original fait 472 octets, le binaire obtenu 28,7 ko. Mais ce n&#8217;est pas standalone, puisque je n&#8217;ai pas demandé la compilation des dépendances (je viens de le tester sur une autre Ubuntu, il pleure que requests n&#8217;est pas installé). Je vous laisse vous faire chier à trouver comment faire pour répondre à votre cas de figure exact, mais ça implique d&#8217;utiliser <a href="https://github.com/cython/cython/blob/master/bin/cython_freeze">cython_freeze</a>.</p>
<p>Après tout, cet article est intitulé &#8220;Peut on compiler un programme Python ?&#8221; et non &#8220;Tuto pour rendre un script Python stand alone&#8221;. Je ne suis pas fou.</p>
<p>Apparemment ça marche sous Windows et Mac, même si je n&#8217;ai pas de quoi tester sous la main (bon, si j&#8217;ai une partition Windows, mais faut rebooter, tout réinstaller, merde quoi&#8230;).</p>
<p>Donc si vous voulez faire une application en Python et la rendre stand alone, l&#8217;obfusquer, pondre un exe pour rendre le téléchargement facile, rassurer les gens ou simplement ignorer les mises à jours des libs de l&#8217;OS, Cython est une bonne piste.</p>
<p>Petit bonus, votre programme sera plus rapide, car il saute l&#8217;étape d&#8217;interprétation. Bien entendu, vous récoltez les galères qui viennent avec la compilation, à savoir les différentes architectures, le linking vers les libs qui peuvent changer de place ou de versions, etc.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/peut-on-compiler-un-programme-python/feed/</wfw:commentRss>
		<slash:comments>28</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2014/05/GljHFMU.jpg" length="39194" type="image/jpg" />	</item>
		<item>
		<title>Le choix d&#8217;un langage influence le fun de votre carrière 32</title>
		<link>http://sametmax.com/le-choix-dun-langage-influence-le-fun-de-votre-carriere/</link>
		<comments>http://sametmax.com/le-choix-dun-langage-influence-le-fun-de-votre-carriere/#comments</comments>
		<pubDate>Tue, 14 May 2013 09:47:04 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Philo et culture]]></category>
		<category><![CDATA[c]]></category>
		<category><![CDATA[java]]></category>
		<category><![CDATA[list]]></category>
		<category><![CDATA[php]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[ruby]]></category>
		<category><![CDATA[scala]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=6095</guid>
		<description><![CDATA[Les langages de programmation sont censés être des technologies neutres, mais comme toute chose utilisée dans le monde réel pour des usages concrets et nombreux, l'humain finit par leur donner une orientation, une préférence.]]></description>
				<content:encoded><![CDATA[<p>Les langages de programmation sont censés être des technologies neutres, mais comme toute chose utilisée dans le monde réel pour des usages concrets et nombreux, l&#8217;humain finit par leur donner une orientation, une préférence.</p>
<p>De fait, chaque langage finit par être plus utilisé dans certains types de métiers ou d&#8217;activités, pour certains types de projets, dans certains environnements. Plus important encore, un langage appelle d&#8217;autres outils, et un certain type de collègue, et même si, comme d&#8217;habitude, la généralisation est un piège à con, il y a bien des stéréotypes visibles qui se dégagent.</p>
<p>Ainsi, Java et PHP sont des langages pour lesquels il est très facile de trouver du travail. Il y a une telle base de code là dehors qu&#8217;il y a des annonces partout, et tout le temps. En revanche, les environnements Java sont généralement très très lourds à manipuler. Pas en terme de performance (Java est aujourd&#8217;hui très rapide), mais en terme de charge de travail : énormément de configuration, beaucoup d&#8217;abstractions et de design pattern imbriqués, des APIs et des formats très verbeux&#8230;</p>
<p>Travailler dans un monde Java, c&#8217;est généralement travailler à un rythme lent, plus souvent dans des grosses boîtes, pour des systèmes assez larges avec un grosse inertie. Ne vous attendez pas à des Java-party avec vos collègues après le boulot.</p>
<p>PHP, c&#8217;est la même chose, avec des projets et composants plus simples (dans des entreprises de toutes tailles), et souvent bien plus dégueulasses. Non pas qu&#8217;on ne puisse pas écrire du PHP propre, mais 15 ans de PHP codé à l&#8217;arrache ne s&#8217;effacent pas avec quelques années de Symfony, et autre cakePHP. Du coup on hérite souvent d&#8217;un projet moche comme ta mère. </p>
<p>Bref, Java et PHP vous garantissent un job, mais les projets sont rarement marrants, et l&#8217;ambiance au taff sera pas pumped up. Par contre il y a de la doc et des tutos, même si généralement ceux pour PHP sont de meilleure qualité que pour Java (qui peuvent être assez indigestes).</p>
<p>Il y a une alternative intermédiaire : le C#. Beau langage, beaux outils, c&#8217;est propre sans être trop lourd, et la base de code est pas à vomir. Mais on reste dans le corporate, et la plupart du temps, sur du 98% Microsoft ou affiliés. </p>
<p>Après vous avez des langages spécialisés comme Erlang, Scala, Lisp. Là, trouver du taff sera généralement un challenge. Ce n&#8217;est pas le genre de truc qu&#8217;on voit partout. Et le niveau sera difficile : un débutant peut arriver avec la bite et le couteau dans un projet PHP, mais si vous vous pointez avec 3 mois d&#8217;expérience sur une gateway jabber haute tolérance, le bidouillage ça va pas le faire. </p>
<p>Ce sont des langages qu&#8217;il faut choisir si on aime le taff de haut niveau, la débrouillardise et les solutions intelligentes. En général les missions sont super intéressantes, mais la reconversion est dure. Par contre, vous rencontrerez des collègues qui valent le détour.</p>
<p>Puis il y a les langages de bas niveau, type C/C++. Aujourd&#8217;hui, c&#8217;est massivement des missions scientifiques ou de l&#8217;embarqué : analyse d&#8217;image, cartes électroniques, petites machines, etc. Il y a encore des trucs pas cool genre Windev (j&#8217;ai un pote coincé là dedans, c&#8217;est triste, fuyez ces annonces), mais ce n&#8217;est plus la majorité. Ces langages, c&#8217;est une question de tempérament. Est-ce que vous aimez la minutie ? L&#8217;efficacité des algos ? Le travail sous contrainte technique ? Si oui, alors ce genre de taff peut être très sympa. Sinon, choisissez un langage plus dynamique.</p>
<p>Ensuite il y a les langages de niches : Cobol, Power Builder, etc. Là c&#8217;est généralement des projets de merde très bien payés. Plus personne ne veut coder avec ces trucs, mais ça coûte trop cher à changer. Les jeunes sont acceptés, les formations offertes, le salaire de début de carrière est bon, mais par contre, le code est un truc de mémé. C&#8217;est pas mal pour commencer une carrière et se faire un peu de thune, mais faut savoir en sortir, et ça ne donne pas de bonnes habitudes en prog.</p>
<p>Et pour finir il y des langages dit &#8220;modernes&#8221; (ce qui est un abus&#8230; de langage, car ils ne datent pas d&#8217;hier) comme Python, Ruby ou Javascript. Le côté &#8220;moderne&#8221; vient surtout du fait qu&#8217;ils sont maintenant très adaptés à des projets modernes, où la souplesse de développement a priorité sur le reste des caractéristiques. Choisissez ces langages si vous visez des missions, principalement Web, sur des produits récents. Ce sont les communautés les plus sympas et dynamiques, ça brasse pas mal dans le milieu et c&#8217;est assez jeune. Mais un grand nombre de start up, donc il faut pas chercher la sécurité de l&#8217;emploi.</p>
<p>Une petite parenthèse pour Python tout de même : il n&#8217;est pas autant limité au Web et on le voit aussi beaucoup dans le secteur scientifique et bancaire. C&#8217;est sa versatilité et la facilité de reconversion qu&#8217;il offre qui me fait dire que c&#8217;est un très bon choix comme premier langage. Mais. Car il y a un &#8220;mais&#8221;. Trouver une offre Python sera plus difficile qu&#8217;une offre Ruby, et BEAUCOUP plus difficile qu&#8217;une offre PHP ou Java. Après perso je n&#8217;ai jamais connu le chômage.</p>
<p>Warning ! Il faut faire gaffe à se lancer dans le dev Web. C&#8217;est très tentant, mais contrairement aux autres carrières, ça veut dire <a href="http://sametmax.com/evolution-de-la-courbe-dapprentissage-dun-dev-front-end/">une courbe d&#8217;apprentissage beaucoup plus longue</a>. Vous ne pouvez pas juste apprendre votre langage, ses libs et son env et vous vendre comme &#8220;expert&#8221;.</p>
<p>J&#8217;ai laissé pas mal de truc de côté, comme l&#8217;objective C, Haskell, Smalltalk, le Bash, Perl et <a href="http://99-bottles-of-beer.net">quelques milliers d&#8217;autres langages</a>. On ne peut pas tout faire, et je voudrais surtout peindre un tableau global du marché. En me relisant, je me dis que c&#8217;est bourré d&#8217;idées reçues, qu&#8217;il y a plein d&#8217;exceptions, etc. Mais je pense que les infos données peuvent permettre à des gens qui se posent la question de l&#8217;orientation de prendre une décision moins mauvaise que &#8220;je lance un D20 et on verra bien&#8221;.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/le-choix-dun-langage-influence-le-fun-de-votre-carriere/feed/</wfw:commentRss>
		<slash:comments>32</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2013/05/m6UwO0w.jpg" length="28964" type="image/jpg" />	</item>
		<item>
		<title>Appeler du code C depuis Python avec ctypes 28</title>
		<link>http://sametmax.com/appeler-du-code-c-depuis-python-avec-ctypes/</link>
		<comments>http://sametmax.com/appeler-du-code-c-depuis-python-avec-ctypes/#comments</comments>
		<pubDate>Sun, 05 May 2013 06:55:40 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[c]]></category>
		<category><![CDATA[ctypes]]></category>
		<category><![CDATA[dll]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[so]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=5811</guid>
		<description><![CDATA[On vous a dit et répété que Python c'était un super langage de glu et que ça pouvait très facilement s'interfacer avec les binaires produits par du C. Mais jusqu'à quel point ?]]></description>
				<content:encoded><![CDATA[<p>On vous a dit et répété que Python c&#8217;était un super langage de glu et que ça pouvait très facilement s&#8217;interfacer avec les binaires produits par du C. Mais jusqu&#8217;à quel point ?</p>
<p>En vérité c&#8217;est extrêmement simple : Python permet de se mapper directement sur un .dll ou un .so, et d&#8217;appeler n&#8217;importe quelle fonction qu&#8217;il contient depuis le code Python comme si c&#8217;était une fonction normale. Il n&#8217;y a rien à installer, c&#8217;est fourni d&#8217;office.</p>
<p>On peut tester ça facilement. Je ponds une lib d&#8217;une folle puissance grâce à mes talents de codeurs C internationalement connus dans le quartier :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="c" style="font-family:monospace;"><span style="color: #339933;">#include&lt;stdio.h&gt;</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
Attend un pointeur sur un array de caractères (une chaîne en C) 
et l'affiche.
*/</span>
dit_papa<span style="color: #009900;">&#40;</span><span style="color: #993333;">char</span> <span style="color: #339933;">*</span> p<span style="color: #009900;">&#41;</span>
<span style="color: #009900;">&#123;</span>
    <span style="color: #000066;">printf</span><span style="color: #009900;">&#40;</span><span style="color: #ff0000;">&quot;%s<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span> p<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span>
&nbsp;
&nbsp;
<span style="color: #808080; font-style: italic;">/*
Attend deux entiers et les multiple
*/</span>
multiplier<span style="color: #009900;">&#40;</span><span style="color: #993333;">long</span> a<span style="color: #339933;">,</span> <span style="color: #993333;">long</span> b<span style="color: #009900;">&#41;</span>
<span style="color: #009900;">&#123;</span>
    <span style="color: #b1b100;">return</span> a <span style="color: #339933;">*</span> b<span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
Attend un pointeur de pointeur sur un array de char
parce qu'on aime les risques.
*/</span>
jakadi<span style="color: #009900;">&#40;</span><span style="color: #993333;">char</span> <span style="color: #339933;">**</span> p<span style="color: #009900;">&#41;</span>
<span style="color: #009900;">&#123;</span>
    <span style="color: #000066;">printf</span><span style="color: #009900;">&#40;</span><span style="color: #ff0000;">&quot;%s<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span> <span style="color: #339933;">*</span>p<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span></pre></td></tr></table></div>

<p>On compile tout ça. Comme je suis sous Nunux, j&#8217;utilise GCC et j&#8217;obtiens un .so, mais sous Windows c&#8217;est pareil avec VisualStudio et les .dll.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">gcc</span> <span style="color: #660033;">-shared</span> -Wl,-soname,ZeLib <span style="color: #660033;">-o</span> ZeLib.so <span style="color: #660033;">-fPIC</span> ZeLib.c</pre></td></tr></table></div>

<p>ZeLib.so est prête et frétille d&#8217;impatience à l&#8217;idée de vous servir. Il ne reste plus qu&#8217;à lancer le shell Python&#8230;</p>
<p>D&#8217;abord on fait ses imports, c&#8217;est dans la lib standard tout ça :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">import</span> ctypes</pre></td></tr></table></div>

<p>Ensuite on se bind sur le binaire, il faut préciser un chemin absolu sinon ça ne marche pas :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> zelib <span style="color: #66cc66;">=</span> ctypes.<span style="color: black;">CDLL</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;/home/sam/Work/projet/ZeLib.so&quot;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Et derrière on peut appeler une fonction (Python fait la <a href="http://docs.python.org/2/library/ctypes.html?highlight=ctypes#fundamental-data-types">conversion entre tous les types</a> de bases Python et C) :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> res <span style="color: #66cc66;">=</span> zelib.<span style="color: black;">multiplier</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">print</span> res
<span style="color: #ff4500;">6</span></pre></td></tr></table></div>

<p>Si on veut faire des chaînes, on ne peut pas passer de l&#8217;unicode. Comme mon shell a toutes les chaînes en unicode par défaut, je dois <a href="http://sametmax.com/lencoding-en-python-une-bonne-fois-pour-toute/">encoder</a> dans le charset de sortie (sur mon système, c&#8217;est UTF8):</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> zelib.<span style="color: black;">dit_papa</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;papa&quot;</span>.<span style="color: black;">encode</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'utf8'</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
papa
<span style="color: #ff4500;">5</span></pre></td></tr></table></div>

<p>Notez au passage que la fonction retourne quelque chose même si je n&#8217;ai pas précisé de valeur de retour. Du coup j&#8217;aurais mieux fait de mettre un bon <code>return 0 </code>à la fin.</p>
<p>Si on veut appeler une fonction qui attend un pointeur, il faut d&#8217;abord caster son type en un type C, puis appeler <code>by_ref</code> dessus, qui va passer l&#8217;argument par référence, plutôt que par valeur :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">from</span> ctypes <span style="color: #ff7700;font-weight:bold;">import</span> *
<span style="color: #66cc66;">&gt;&gt;&gt;</span> s <span style="color: #66cc66;">=</span> ctypes.<span style="color: black;">c_char_p</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'kiwi'</span>.<span style="color: black;">encode</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'utf8'</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> zelib.<span style="color: black;">jakadi</span><span style="color: black;">&#40;</span>byref<span style="color: black;">&#40;</span>s<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
kiwi
<span style="color: #ff4500;">5</span></pre></td></tr></table></div>

<p>Voilà.</p>
<p>Voilà, voilà.</p>
<p>Bon attention quand même, le C n&#8217;est pas aussi conciliant que le Python : le debug est plus dur (pas de stacktrace, mais un bon vieux core dump), pas de completion dans ipython, et on peut même planter la VM si on se débrouille bien :-) N&#8217;oubliez pas non plus que Python 64 bits ne peut pas taper dans des DLL 32 bits et inversement.</p>
<p>P.S: je ne vais pas mettre le code C à télécharger et le code Python, franchement, il est pas énorme. Donc petite exception dans cet article : y a rien à DL et la syntaxe est pas à base de comments.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/appeler-du-code-c-depuis-python-avec-ctypes/feed/</wfw:commentRss>
		<slash:comments>28</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2013/05/1fem1pip1pul.jpg" length="588534" type="image/jpg" />	</item>
	</channel>
</rss>
