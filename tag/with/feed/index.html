<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Sam &#38; Max &#187; with</title>
	<atom:link href="http://sametmax.com/tag/with/feed/" rel="self" type="application/rss+xml" />
	<link>http://sametmax.com</link>
	<description>Du code, du cul</description>
	<lastBuildDate>Sat, 07 Nov 2015 10:56:13 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>http://wordpress.org/?v=4.1</generator>
	<item>
		<title>Batbelt, la lib des petits outils Python qui vont bien 15</title>
		<link>http://sametmax.com/batbelt-la-lib-des-petits-outils-python-qui-vont-bien/</link>
		<comments>http://sametmax.com/batbelt-la-lib-des-petits-outils-python-qui-vont-bien/#comments</comments>
		<pubDate>Mon, 03 Jun 2013 08:57:33 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[decorator]]></category>
		<category><![CDATA[iterable]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[snippets]]></category>
		<category><![CDATA[with]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=6327</guid>
		<description><![CDATA[A force de coder plein de projets, il y a des opérations qui reviennent très souvent. Ces traitements sont petits et complètement sans relation, difficile d'en faire quelque chose. J'ai tout de même finit par en faire un lib, batbelt, qui au final n'est qu'une grosse collections de snippets que j'utilise régulièrement.]]></description>
				<content:encoded><![CDATA[<p>A force de coder plein de projets, il y a des opérations qui reviennent très souvent. Ces traitements sont petits et complètement sans relation, difficile d&#8217;en faire quelque chose. J&#8217;ai tout de même finit par en faire un lib, <a href="https://github.com/sametmax/Bat-belt/">batbelt</a>, qui au final n&#8217;est qu&#8217;une grosse collections de snippets que j&#8217;utilise régulièrement. Il y a aussi des trucs que j&#8217;utilise moins ou des astuces / hacks un peu crades, c&#8217;est toujours pratique pour geeker à l&#8217;arrache vite fait. Vous allez d&#8217;ailleurs retrouver des bouts de code dont j&#8217;ai déjà parlé sur le site</p>
<p><code><a href="http://sametmax.com/votre-python-aime-les-pip/">pip</a> install batbelt</code></p>
<p>Et la plupart des fonctions sont accessible avec un <code>from batbelt import...</code></p>
<p>Voici les choses qui pourraient vous intéresser le plus dans batbelt&#8230;</p>
<h2>To timestamp</h2>
<p>Mais combien de fois j&#8217;ai du la coder celle-là ? En plus l&#8217;inverse existe, alors pourquoi, mon Dieu, pourquoi ?</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">datetime</span> <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">datetime</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> to_timestamp<span style="color: black;">&#40;</span><span style="color: #dc143c;">datetime</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">2000</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #ff4500;">946692061</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #dc143c;">datetime</span>.<span style="color: black;">fromtimestamp</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">946688461</span><span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># tu as codé celle là et pas l'autre connard !</span>
<span style="color: #dc143c;">datetime</span>.<span style="color: #dc143c;">datetime</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">2000</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<h2>Récupérer une valeur dans une structure de données imbriquée</h2>
<p>Au lieu de faire :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">try</span>:
    res <span style="color: #66cc66;">=</span> data<span style="color: black;">&#91;</span><span style="color: #483d8b;">'cle'</span><span style="color: black;">&#93;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#93;</span><span style="color: black;">&#91;</span><span style="color: #483d8b;">'autre cle'</span><span style="color: black;">&#93;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span><span style="color: black;">&#93;</span>
<span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: black;">&#40;</span><span style="color: #008000;">KeyError</span><span style="color: #66cc66;">,</span> <span style="color: #008000;">IndexError</span><span style="color: black;">&#41;</span>:
    res <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">&quot;valeur&quot;</span></pre></td></tr></table></div>

<p>On peut faire :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">get<span style="color: black;">&#40;</span>data<span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'cle'</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">0</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'autre cle'</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> default<span style="color: #66cc66;">=</span><span style="color: #483d8b;">&quot;valeur&quot;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<h2>Récupérer la valeur d&#8217;un attribut dans un attribut dans un attribut&#8230;</h2>
<p>Pareil, mais pour les attributs.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">try</span>:
    devise <span style="color: #66cc66;">=</span> voiture.<span style="color: black;">moteur</span>.<span style="color: black;">prix</span>.<span style="color: black;">devise</span>
<span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: #008000;">AttributeError</span>:
    devise <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">&quot;euro&quot;</span></pre></td></tr></table></div>

<p>On peut faire :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">devise <span style="color: #66cc66;">=</span> attr<span style="color: black;">&#40;</span>voiture<span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'moteur'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'prix'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'devise'</span><span style="color: #66cc66;">,</span> default<span style="color: #66cc66;">=</span><span style="color: #483d8b;">'euro'</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<h2>Itérons, mon bon</h2>
<p>Ces fonctions retournent des générateurs qui permettent d&#8217;itérer par morceau ou par fenêtre glissante.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">for</span> <span style="color: #dc143c;">chunk</span> <span style="color: #ff7700;font-weight:bold;">in</span> chunks<span style="color: black;">&#40;</span>l<span style="color: #66cc66;">,</span> <span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span>:
...     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #008000;">list</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">chunk</span><span style="color: black;">&#41;</span>
...
<span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span>
<span style="color: black;">&#91;</span><span style="color: #ff4500;">3</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">4</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">5</span><span style="color: black;">&#93;</span>
<span style="color: black;">&#91;</span><span style="color: #ff4500;">6</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">7</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">8</span><span style="color: black;">&#93;</span>
<span style="color: black;">&#91;</span><span style="color: #ff4500;">9</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">for</span> slide <span style="color: #ff7700;font-weight:bold;">in</span> window<span style="color: black;">&#40;</span>l<span style="color: #66cc66;">,</span> <span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span>:
...     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #008000;">list</span><span style="color: black;">&#40;</span>slide<span style="color: black;">&#41;</span>
...
<span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span>
<span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">3</span><span style="color: black;">&#93;</span>
<span style="color: black;">&#91;</span><span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">3</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">4</span><span style="color: black;">&#93;</span>
<span style="color: black;">&#91;</span><span style="color: #ff4500;">3</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">4</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">5</span><span style="color: black;">&#93;</span>
<span style="color: black;">&#91;</span><span style="color: #ff4500;">4</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">5</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">6</span><span style="color: black;">&#93;</span>
<span style="color: black;">&#91;</span><span style="color: #ff4500;">5</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">6</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">7</span><span style="color: black;">&#93;</span>
<span style="color: black;">&#91;</span><span style="color: #ff4500;">6</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">7</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">8</span><span style="color: black;">&#93;</span>
<span style="color: black;">&#91;</span><span style="color: #ff4500;">7</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">8</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">9</span><span style="color: black;">&#93;</span></pre></td></tr></table></div>

<p>Ça devrait être en standard dans Python.</p>
<p>Parfois on veut juste le premier élément d&#8217;une collection. Ou juste le premier à être vrai:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> first<span style="color: black;">&#40;</span><span style="color: #008000;">xrange</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">10</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #ff4500;">0</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> first_true<span style="color: black;">&#40;</span><span style="color: #008000;">xrange</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">10</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #ff4500;">1</span></pre></td></tr></table></div>

<p>Marche avec n&#8217;importe quel itérable, contrairement à <code>[0]</code> qui ne marche que sur les indexables. Et en prime on peut spécifier une valeur par défaut:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> first<span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#93;</span><span style="color: #66cc66;">,</span> default<span style="color: #66cc66;">=</span><span style="color: #483d8b;">&quot;What the one thing we say to the God of Death ?&quot;</span><span style="color: black;">&#41;</span>
<span style="color: #483d8b;">'What the one thing we say to the God of Death ?'</span></pre></td></tr></table></div>

<h2>Set ordonné</h2>
<p>On a des dicts ordonnés dans la lib standard, mais pas de set ordonné. On en a pas besoin souvent, mais ça peut être TRES pratique, et TRES chiant à implémenter soi-même.</p>
<p>Donc acte.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">set</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">3</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>: <span style="color: #808080; font-style: italic;"># booooooo</span>
...     <span style="color: #ff7700;font-weight:bold;">print</span> x
...
<span style="color: #ff4500;">1</span>
<span style="color: #ff4500;">2</span>
<span style="color: #ff4500;">3</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> sset<span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">3</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>: <span style="color: #808080; font-style: italic;"># clap clap !</span>
...     <span style="color: #ff7700;font-weight:bold;">print</span> x
...
<span style="color: #ff4500;">3</span>
<span style="color: #ff4500;">2</span>
<span style="color: #ff4500;">1</span></pre></td></tr></table></div>

<p>Attention, c&#8217;est pas la structure de données la plus rapide du monde&#8230;</p>
<h2>Je suis une feignasse et j&#8217;aime les one-liners sur les dicos</h2>
<p>Je ne comprends pas pourquoi <code>+</code> ne fonctionne pas sur les dico.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> dmerge<span style="color: black;">&#40;</span><span style="color: black;">&#123;</span><span style="color: #483d8b;">&quot;a&quot;</span>: <span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">&quot;b&quot;</span>: <span style="color: #ff4500;">2</span><span style="color: black;">&#125;</span><span style="color: #66cc66;">,</span> <span style="color: black;">&#123;</span><span style="color: #483d8b;">&quot;b&quot;</span>: <span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">&quot;c&quot;</span>: <span style="color: #ff4500;">3</span><span style="color: black;">&#125;</span><span style="color: black;">&#41;</span>
<span style="color: black;">&#123;</span><span style="color: #483d8b;">'a'</span>: <span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'c'</span>: <span style="color: #ff4500;">3</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'b'</span>: <span style="color: #ff4500;">2</span><span style="color: black;">&#125;</span></pre></td></tr></table></div>

<p>Ne modifie pas les dictionnaires originaux.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">from</span> batbelt.<span style="color: black;">structs</span> <span style="color: #ff7700;font-weight:bold;">import</span> rename
<span style="color: #66cc66;">&gt;&gt;&gt;</span> rename<span style="color: black;">&#40;</span><span style="color: black;">&#123;</span><span style="color: #483d8b;">&quot;a&quot;</span>: <span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">&quot;b&quot;</span>: <span style="color: #ff4500;">2</span><span style="color: black;">&#125;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> rename<span style="color: black;">&#40;</span><span style="color: black;">&#123;</span><span style="color: #483d8b;">&quot;a&quot;</span>: <span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">&quot;b&quot;</span>: <span style="color: #ff4500;">2</span><span style="color: black;">&#125;</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'b'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'z'</span><span style="color: black;">&#41;</span>
<span style="color: black;">&#123;</span>u<span style="color: #483d8b;">'a'</span>: <span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> u<span style="color: #483d8b;">'z'</span>: <span style="color: #ff4500;">2</span><span style="color: black;">&#125;</span></pre></td></tr></table></div>

<p>Modifie le dictionnaire original et n&#8217;est PAS thread safe.</p>
<p>Et le cas tordu mais tellement satisfaisant :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">from</span> batbelt.<span style="color: black;">structs</span> <span style="color: #ff7700;font-weight:bold;">import</span> unpack
<span style="color: #66cc66;">&gt;&gt;&gt;</span> dct <span style="color: #66cc66;">=</span> <span style="color: black;">&#123;</span><span style="color: #483d8b;">'a'</span>: <span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'b'</span>: <span style="color: #ff4500;">4</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'z'</span>: <span style="color: #ff4500;">42</span><span style="color: black;">&#125;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> a<span style="color: #66cc66;">,</span> b<span style="color: #66cc66;">,</span> c <span style="color: #66cc66;">=</span> unpack<span style="color: black;">&#40;</span>dct<span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'a'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'b'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'c'</span><span style="color: #66cc66;">,</span> default<span style="color: #66cc66;">=</span><span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> a
<span style="color: #ff4500;">2</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> b
<span style="color: #ff4500;">4</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> c
<span style="color: #ff4500;">1</span></pre></td></tr></table></div>

<h2>Slugifier</h2>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> slugify<span style="color: black;">&#40;</span>u<span style="color: #483d8b;">&quot;Hélo Whorde&quot;</span><span style="color: black;">&#41;</span>
helo-whorde</pre></td></tr></table></div>

<p>Il y a pas mal de réglages possibles avec <code>slugify()</code>, mais je vous laisse les découvrir :-) Cette fonction fait partie du sous-module <code>strings</code>, qui contient d&#8217;autres utilitaires comme <code>escape_html/unescape_html</code> (qui transforme les caractères spéciaux en HTML entities et inversement) ou <code>json_dumps/json_loads</code> (qui fait un dump / load du JSON en prenant en compte le type <codde>datetime</codde>).</p>
<h2>Importer une classe ou une fonction depuis une string</h2>
<p>Dès que vous faites un fichier de config vous avez besoin de ce genre de truc, mais la fonction <code>__import__</code> a une signature uber-zarb. Voici une version beaucoup plus simple:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">TaClasse <span style="color: #66cc66;">=</span> import_from_path<span style="color: black;">&#40;</span><span style="color: #483d8b;">'foo.bar.TaClasse'</span><span style="color: black;">&#41;</span>
ton_obj <span style="color: #66cc66;">=</span> TaClasse<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<h2>Capturer les prints</h2>
<p>Parfois on a une lib qui <code>print</code> plutôt que de retourner une valeur. C&#8217;est très chiant. J&#8217;ai donc fait un context manager qui permet de récupérer tout ce qui est printé dans le block du <code>with</code>.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">with</span> capture_ouput<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">as</span> <span style="color: black;">&#40;</span>stdout<span style="color: #66cc66;">,</span> stderr<span style="color: black;">&#41;</span>:
...    <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;hello&quot;</span><span style="color: #66cc66;">,</span>
...
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">print</span> stdout.<span style="color: black;">read</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
hello</pre></td></tr></table></div>

<h2>Créer un décorateur qui accepte des arguments</h2>
<p>Même dans le cas où vous avez parfaitement compris les décorateurs grâce à un très <a href="http://sametmax.com/comprendre-les-decorateurs-python-pas-a-pas-partie-1/">bon tuto</a> (^^), se souvenir de comment faire un décorateur qui attend des arguments en paramètre, c&#8217;est mission impossible. Voici donc un décorateur&#8230; pour créer un décorateur.</p>
<p>Étape un, écrire votre décorateur :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #808080; font-style: italic;"># tout les arguments après 'func' sont ceux que votre décorateur acceptera</span>
<span style="color: #66cc66;">@</span>decorator_with_args<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">def</span> votre_decorateur<span style="color: black;">&#40;</span>func<span style="color: #66cc66;">,</span> arg1<span style="color: #66cc66;">,</span> arg2<span style="color: #66cc66;">=</span><span style="color: #008000;">None</span><span style="color: black;">&#41;</span>:
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">if</span> arg1:
        <span style="color: #808080; font-style: italic;"># faire un truc</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># ici on fait juste le truc habituel des décorateurs</span>
    <span style="color: #808080; font-style: italic;"># wrapper, appel de la fonction wrappée et retour du wrapper...</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> wrapper<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
        <span style="color: #808080; font-style: italic;"># arg2 est dans une closure, on peut donc l'utiliser dans</span>
        <span style="color: #808080; font-style: italic;"># la fonction appelée</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> func<span style="color: black;">&#40;</span>arg2<span style="color: black;">&#41;</span>
&nbsp;
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">return</span> wrapper</pre></td></tr></table></div>

<p>Et on peut utiliser son décorateur tranquile-bilou :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">@</span>votre_decorateur<span style="color: black;">&#40;</span><span style="color: #008000;">False</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">def</span> hop<span style="color: black;">&#40;</span>un_arg<span style="color: black;">&#41;</span>:
    <span style="color: #808080; font-style: italic;"># faire un truc dans la fonction décorée</span></pre></td></tr></table></div>

<h2>Les processus parallèles finissent toujours par se rencontrer à l&#8217;infini et corrompre leurs données</h2>
<p>Mais en attendant on en a quand même besoin. Parfois un petit worker, c&#8217;est sympa, pas besoin de faire compliqué et de sortir des libs de task queue complètes:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">&nbsp;
<span style="color: #ff7700;font-weight:bold;">from</span> batbelt.<span style="color: black;">parallel</span> <span style="color: #ff7700;font-weight:bold;">import</span> worker
&nbsp;
<span style="color: #66cc66;">@</span>worker<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">def</span> une_tache<span style="color: black;">&#40;</span>arg<span style="color: black;">&#41;</span>:
    <span style="color: #808080; font-style: italic;"># faire un truc avec arg</span>
    arg <span style="color: #66cc66;">=</span> arg + <span style="color: #ff4500;">10</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> arg
&nbsp;
&nbsp;
<span style="color: #808080; font-style: italic;"># on demarre le worker</span>
process <span style="color: #66cc66;">=</span> une_tache.<span style="color: black;">start</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># on balance des tâches au worker</span>
<span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">range</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">10</span><span style="color: black;">&#41;</span>:
    process.<span style="color: black;">put</span><span style="color: black;">&#40;</span>x<span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># on récupère les résultats (optionnel)</span>
<span style="color: #808080; font-style: italic;"># ca peut être dans un fichier différent</span>
<span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">range</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">10</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">print</span> process.<span style="color: black;">get</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;">## 10</span>
<span style="color: #808080; font-style: italic;">## 11</span>
<span style="color: #808080; font-style: italic;">## 12</span>
<span style="color: #808080; font-style: italic;">## 13</span>
<span style="color: #808080; font-style: italic;">## 14</span>
<span style="color: #808080; font-style: italic;">## 15</span>
<span style="color: #808080; font-style: italic;">## 16</span>
<span style="color: #808080; font-style: italic;">## 17</span>
<span style="color: #808080; font-style: italic;">## 18</span>
<span style="color: #808080; font-style: italic;">## 19</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># on arrête le worker</span>
process.<span style="color: black;">stop</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Le worker est un subprocess par défaut, mais vous pouvez en faire un thread avec @worker(method=&#8221;tread&#8221;). Toujours utile, par exemple pour avec un processeur de mails qui envoit tous les mails hors du cycle requête / réponse de votre site Web. Par contre si votre process meurt la queue est perdue.</p>
<h2>Template du pauvre</h2>
<p>Avec format(), on a déjà un mini-langage de template intégré. Pas de boucle, mais pour des tâches simples ça suffit. Du coup j&#8217;ai une fonction <code>render()</code> qui prend un fichier de template au format string Python et qui écrit le résultat dans un autre. Pratique pour faire des fichiers de conf configurable.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">from</span> batbelt.<span style="color: black;">strings</span> <span style="color: #ff7700;font-weight:bold;">import</span> render
&nbsp;
render<span style="color: black;">&#40;</span><span style="color: #483d8b;">'truc.conf.tpl'</span><span style="color: #66cc66;">,</span> <span style="color: black;">&#123;</span><span style="color: #483d8b;">&quot;var&quot;</span>: <span style="color: #483d8b;">&quot;value&quot;</span><span style="color: black;">&#125;</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">&quot;/etc/truc.conf&quot;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Il y a aussi des implémentations de Singleton, du Null Pattern, etc. Mais ça s&#8217;utilise moins souvent alors je vais pas faire une tartine.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/batbelt-la-lib-des-petits-outils-python-qui-vont-bien/feed/</wfw:commentRss>
		<slash:comments>15</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2013/06/7ZNvVOR.jpg" length="296662" type="image/jpg" />	</item>
		<item>
		<title>Capturer l&#8217;affichage des prints d&#8217;un code Python 8</title>
		<link>http://sametmax.com/capturer-laffichage-des-prints-dun-code-python/</link>
		<comments>http://sametmax.com/capturer-laffichage-des-prints-dun-code-python/#comments</comments>
		<pubDate>Sat, 29 Sep 2012 14:03:36 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[context manager]]></category>
		<category><![CDATA[hack]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[with]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=2343</guid>
		<description><![CDATA[Hier j’ai eu rencontré le travail d’une de ces fameuses personnes qui pensent que la réutilisabilité c’est pour les pédés, et qui font des scripts dont la moitié des infos renvoyées sont printées au milieu de blocs de code de 50 lignes, sans possibilité de les récupérer.]]></description>
				<content:encoded><![CDATA[<p>Hier j&#8217;ai eu rencontré le travail d&#8217;une de ces fameuses personnes qui pensent que la ré-utilisabilité c&#8217;est pour les pédés, et qui font des scripts dont la moitié des infos renvoyées sont printées au milieu de blocs de code de 50 lignes, sans possibilité de les récupérer.</p>
<p>Heureusement, avec un petit hack, on peut capturer ce qu&#8217;affiche un autre code, et sauver le bébé, l&#8217;eau du bain, et même le canard en plastique.</p>
<h2>Le code pour les gens pressés</h2>
<p>J&#8217;ai enrobé l&#8217;astuce dans un <a href="http://sametmax.com/les-context-managers-et-le-mot-cle-with-en-python/">context manager</a>, ça rend l&#8217;utilisation plus simple.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">sys</span>
<span style="color: #ff7700;font-weight:bold;">from</span> io <span style="color: #ff7700;font-weight:bold;">import</span> BytesIO
<span style="color: #ff7700;font-weight:bold;">from</span> contextlib <span style="color: #ff7700;font-weight:bold;">import</span> contextmanager
&nbsp;
<span style="color: #66cc66;">@</span>contextmanager
<span style="color: #ff7700;font-weight:bold;">def</span> capture_ouput<span style="color: black;">&#40;</span>stdout_to<span style="color: #66cc66;">=</span><span style="color: #008000;">None</span><span style="color: #66cc66;">,</span> stderr_to<span style="color: #66cc66;">=</span><span style="color: #008000;">None</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">try</span>:
&nbsp;
        stdout<span style="color: #66cc66;">,</span> stderr <span style="color: #66cc66;">=</span> <span style="color: #dc143c;">sys</span>.<span style="color: black;">stdout</span><span style="color: #66cc66;">,</span> <span style="color: #dc143c;">sys</span>.<span style="color: black;">stderr</span>
        <span style="color: #dc143c;">sys</span>.<span style="color: black;">stdout</span> <span style="color: #66cc66;">=</span> c1 <span style="color: #66cc66;">=</span> stdout_to <span style="color: #ff7700;font-weight:bold;">or</span> BytesIO<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
        <span style="color: #dc143c;">sys</span>.<span style="color: black;">stderr</span> <span style="color: #66cc66;">=</span> c2 <span style="color: #66cc66;">=</span> stderr_to <span style="color: #ff7700;font-weight:bold;">or</span> BytesIO<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">yield</span> c1<span style="color: #66cc66;">,</span> c2
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">finally</span>:
&nbsp;
        <span style="color: #dc143c;">sys</span>.<span style="color: black;">stdout</span> <span style="color: #66cc66;">=</span> stdout
        <span style="color: #dc143c;">sys</span>.<span style="color: black;">stderr</span> <span style="color: #66cc66;">=</span> stderr
&nbsp;
        <span style="color: #ff7700;font-weight:bold;">try</span>:
            c1.<span style="color: black;">flush</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
            c1.<span style="color: black;">seek</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: black;">&#40;</span><span style="color: #008000;">ValueError</span><span style="color: #66cc66;">,</span> <span style="color: #008000;">IOError</span><span style="color: black;">&#41;</span>:
            <span style="color: #ff7700;font-weight:bold;">pass</span>
&nbsp;
        <span style="color: #ff7700;font-weight:bold;">try</span>:
            c2.<span style="color: black;">flush</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
            c2.<span style="color: black;">seek</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: black;">&#40;</span><span style="color: #008000;">ValueError</span><span style="color: #66cc66;">,</span> <span style="color: #008000;">IOError</span><span style="color: black;">&#41;</span>:
            <span style="color: #ff7700;font-weight:bold;">pass</span></pre></td></tr></table></div>

<p>Notez l&#8217;usage de <a href="http://sametmax.com/comment-utiliser-yield-et-les-generateurs-en-python/">yield</a>.</p>
<p>Et ça s&#8217;utilise comme ça:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">with</span> capture_output<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">as</span> stdout<span style="color: #66cc66;">,</span> stderr:
    fonction_qui_fait_que_printer_la_biatch<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">print</span> stdout.<span style="color: black;">read</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># on récupère le contenu des prints</span></pre></td></tr></table></div>

<p>Attention, le code n&#8217;est pas thread safe, c&#8217;est fait pour hacker un code crade, pas pour devenir une institution. Mais c&#8217;est fort pratique dans notre cas précis.</p>
<h2>Comment ça marche ?</h2>
<p><code>stdin</code> (entrée standard), <code>stdout</code> (sortie standard) et <code>stderr</code> (sortie des erreurs) sont des file like objects, c&#8217;est à dire qu&#8217;ils implémentent l&#8217;interface d&#8217;un objet fichier: on peut les ouvrir, les lire, y écrire et les fermer avec des méthodes portant le même nom et acceptant les mêmes paramètres.</p>
<p>L&#8217;avantage d&#8217;avoir une interface commune, c&#8217;est qu&#8217;on peut du coup échanger un file like objet par un autre.</p>
<p>Par exemple on peut faire ceci:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">sys</span>
log <span style="color: #66cc66;">=</span> <span style="color: #008000;">open</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'/tmp/log'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'w'</span><span style="color: black;">&#41;</span>
<span style="color: #dc143c;">sys</span>.<span style="color: black;">stdout</span> <span style="color: #66cc66;">=</span> log <span style="color: #808080; font-style: italic;"># hop, on hijack la sortie standard</span>
<span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Hello&quot;</span>
log.<span style="color: black;">close</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Comme <code>print</code> écrit dans <code>stdout</code>, en remplaçant <code>stdout</code> par un fichier, <code>print</code> va du coup écrire dans le fichier.</p>
<p>Mais ce code est fort dangereux, car il remplace <code>stdout</code> de manière définitive. Du coup, si du code <code>print</code> après, il va écrire dans le fichier, même les libs externes, car <code>stdout</code> est le même pour tout le monde dans le process Python courant.</p>
<p>Du coup, il est de bon ton de s&#8217;assurer la restauration de <code>stdout</code> à son état d&#8217;origine:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">sys</span>
log <span style="color: #66cc66;">=</span> <span style="color: #008000;">open</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'/tmp/log'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'w'</span><span style="color: black;">&#41;</span>
bak <span style="color: #66cc66;">=</span> <span style="color: #dc143c;">sys</span>.<span style="color: black;">stdout</span> <span style="color: #808080; font-style: italic;"># on sauvegarde l'ancien stdout</span>
<span style="color: #dc143c;">sys</span>.<span style="color: black;">stdout</span> <span style="color: #66cc66;">=</span> log
<span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Hello&quot;</span>
log.<span style="color: black;">close</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #dc143c;">sys</span>.<span style="color: black;">stdout</span> <span style="color: #66cc66;">=</span> bak <span style="color: #808080; font-style: italic;"># on restore stdout</span></pre></td></tr></table></div>

<p>Comme je le disais plus haut, ceci n&#8217;est évidement pas thread safe, puisqu&#8217;entre la hijacking et la restoration de <code>stdout</code>, un autre thread peut faire un <code>print</code>.</p>
<p>Dans notre context manager, on utilise <code>BytesIO()</code> et non un fichier. <code>BytesIO</code> est un file like objet qui permet de récupérer un flux de bits en mémoire. Donc on fait écrire <code>print</code> dedans, ainsi on a tout ce qu&#8217;on affiche qui se sauvegarde en mémoire.</p>
<p>Bien entendu, vous pouvez créé vos propres file like objects, par exemple un objet qui affiche à l&#8217;écran ET capture la sortie. Par exemple, pour mitiger le problème de l&#8217;absence de thread safe: 99% des libs n&#8217;ont pas besoin du vrai <code>stdout</code>, juste d&#8217;un truc qui <code>print</code>.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">sys</span>
<span style="color: #ff7700;font-weight:bold;">from</span> io <span style="color: #ff7700;font-weight:bold;">import</span> BytesIO
&nbsp;
<span style="color: #ff7700;font-weight:bold;">class</span> PersistentStdout<span style="color: black;">&#40;</span><span style="color: #008000;">object</span><span style="color: black;">&#41;</span>:
&nbsp;
    old_stdout <span style="color: #66cc66;">=</span> <span style="color: #dc143c;">sys</span>.<span style="color: black;">stdout</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__init__</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #008000;">self</span>.<span style="color: black;">memory</span> <span style="color: #66cc66;">=</span> BytesIO<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> write<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> s<span style="color: black;">&#41;</span>:
        <span style="color: #008000;">self</span>.<span style="color: black;">memory</span>.<span style="color: black;">write</span><span style="color: black;">&#40;</span>s<span style="color: black;">&#41;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">old_stdout</span>.<span style="color: black;">write</span><span style="color: black;">&#40;</span>s<span style="color: black;">&#41;</span>
&nbsp;
&nbsp;
old_stdout <span style="color: #66cc66;">=</span> <span style="color: #dc143c;">sys</span>.<span style="color: black;">stdout</span>
<span style="color: #dc143c;">sys</span>.<span style="color: black;">stdout</span> <span style="color: #66cc66;">=</span> PersistentStdout<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;test&quot;</span> <span style="color: #808080; font-style: italic;"># ceci est capturé et affiché</span>
&nbsp;
<span style="color: #dc143c;">sys</span>.<span style="color: black;">stdout</span>.<span style="color: black;">memory</span>.<span style="color: black;">seek</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#41;</span>
res <span style="color: #66cc66;">=</span> <span style="color: #dc143c;">sys</span>.<span style="color: black;">stdout</span>.<span style="color: black;">memory</span>.<span style="color: black;">read</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #dc143c;">sys</span>.<span style="color: black;">stdout</span> <span style="color: #66cc66;">=</span> PersistentStdout.<span style="color: black;">old_stdout</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">print</span> res <span style="color: #808080; font-style: italic;"># résultat de la capture</span></pre></td></tr></table></div>

<p>Pour cette raison le code du context manager permet de passer le file like objet à utiliser en argument. On notera aussi que si on souhaite rediriger <code>stdout</code> mais pas <code>stderr</code> et <a href="https://www.youtube.com/watch?v=WousdWP-5vY">vice-versa</a>, il suffit de passer <code>sys.stdout</code> et <code>sys.stderr</code> en argument :-)</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/capturer-laffichage-des-prints-dun-code-python/feed/</wfw:commentRss>
		<slash:comments>8</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2012/09/belkin-f8v234eawht-apl.jpg" length="12571" type="image/jpg" />	</item>
		<item>
		<title>Les context managers et le mot clé with en Python 13</title>
		<link>http://sametmax.com/les-context-managers-et-le-mot-cle-with-en-python/</link>
		<comments>http://sametmax.com/les-context-managers-et-le-mot-cle-with-en-python/#comments</comments>
		<pubDate>Mon, 03 Sep 2012 17:56:43 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[contextmanager]]></category>
		<category><![CDATA[decorator]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[with]]></category>
		<category><![CDATA[yield]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=1987</guid>
		<description><![CDATA[Le mot clé <code>with</code> est utilisé comme dans aucun autre langage en Python. Au premier abord mystérieux, il agit en fait comme les <a href="http://sametmax.com/comprendre-les-decorateurs-python-pas-a-pas-partie-1/">décorateurs</a> en permettant d'exécuter du code automatiquement avant et après un autre code. Mais à l'image des décorateurs, tout ce qu'il fait pourrait être écrit à la main sans utiliser le mot clé <code>with</code>. Utiliser <code>with</code> est <a href="http://sametmax.com/jadore-les-context-managers-python/">une question de style</a>.
]]></description>
				<content:encoded><![CDATA[<p>Le mot clé <code>with</code> est utilisé comme dans aucun autre langage en Python. Au premier abord mystérieux, il agit en fait comme les <a href="http://sametmax.com/comprendre-les-decorateurs-python-pas-a-pas-partie-1/">décorateurs</a> en permettant d&#8217;exécuter du code automatiquement avant et après un autre code. Mais à l&#8217;image des décorateurs, tout ce qu&#8217;il fait pourrait être écrit à la main sans utiliser le mot clé <code>with</code>. Utiliser <code>with</code> est <a href="http://sametmax.com/jadore-les-context-managers-python/">une question de style</a>.</p>
<p>Supposons que vous vouliez afficher quelque chose avant un bout de code, et après un bout de code, même si celui-ci rate. Vous feriez quelque chose comme ça:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> truc<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;machin&quot;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Avant&quot;</span>
<span style="color: #ff7700;font-weight:bold;">try</span>:
    truc<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">finally</span>:
    <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Après&quot;</span></pre></td></tr></table></div>

<p>Et ça va afficher:</p>
<pre>Avant
machin
Après</pre>
<p>Et avec:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> truc<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;machin&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">raise</span> <span style="color: #008000;">Exception</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'Fail !'</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>&#8216;Après&#8217; sera quand même affiché. Ça plantera, mais la dernière action sera toujours faite.</p>
<p>Si vous le faites souvent, vous voudrez factoriser du code. Un des moyens de le faire est d&#8217;utiliser les context managers.</p>
<h2>Créer son propre context manager</h2>
<p>Un context manager est une classe <strong>ordinaire</strong> en Python. Sa seule spécificité est de déclarer une méthode <code>__enter__()</code> et une méthode <code>__exit__()</code>. Ces méthodes sont des méthodes <strong>ordinaires</strong>, leur nom spécial est juste là par convention, et en les nommant ainsi on s&#8217;assure qu&#8217;elles seront détectées et utilisées automatiquement.</p>
<p>Notre code là haut peut donc se réécrire ainsi:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">class</span> MonSuperContextManager<span style="color: black;">&#40;</span><span style="color: #008000;">object</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">def</span> __enter__<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Avant&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> __exit__<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> <span style="color: #008000;">type</span><span style="color: #66cc66;">,</span> value<span style="color: #66cc66;">,</span> <span style="color: #dc143c;">traceback</span><span style="color: black;">&#41;</span>:
        <span style="color: #808080; font-style: italic;"># faites pas attention aux paramètres, ce sont toutes les infos</span>
        <span style="color: #808080; font-style: italic;"># automatiquement passées à __exit__ et qui servent pour inspecter</span>
        <span style="color: #808080; font-style: italic;"># une éventuelle exception</span>
        <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Après&quot;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">with</span> MonSuperContextManager<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    truc<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>L&#8217;avantage de with est multiple:</p>
<ul>
<li>Il permet de visualiser très précisément où on entre dans l&#8217;action et où on en sort (c&#8217;est un seul block)</li>
<li>Il permet de réutiliser les actions faite à l&#8217;entrée et à la sortie de l&#8217;action.</li>
<li>Même si une exception est levée, l&#8217;action de sortie sera exécutée juste avant le plantage. <code>__exit__</code> est en effet garantie d&#8217;être appelée quoiqu&#8217;il arrive. Bon, évidement, si il y a une coupure de courant&#8230;</li>
</ul>
<p>En gros, créer un context manager, c&#8217;est faire un raccourci lisible pour <code>try</code>/<code>finally</code>. Point.</p>
<h2>Un exemple utile de context manager</h2>
<p>Supposons que vous ayez beaucoup de travail à faire dans plein de dossiers. Vous voulez vous assurer que vous allez dans le dossier de travail, puis que vous retournez au dossier initial à chaque fois.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">os</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">class</span> Cd<span style="color: black;">&#40;</span>objet<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__init__</span><span style="color: black;">&#40;</span>dirname<span style="color: black;">&#41;</span>:
        <span style="color: #008000;">self</span>.<span style="color: black;">dirname</span> <span style="color: #66cc66;">=</span> dirname
    <span style="color: #ff7700;font-weight:bold;">def</span> __enter__<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #008000;">self</span>.<span style="color: black;">curdir</span> <span style="color: #66cc66;">=</span> <span style="color: #dc143c;">os</span>.<span style="color: black;">getcwd</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
        <span style="color: #dc143c;">os</span>.<span style="color: black;">chdir</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">dirname</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> __exit__<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> <span style="color: #008000;">type</span><span style="color: #66cc66;">,</span> value<span style="color: #66cc66;">,</span> <span style="color: #dc143c;">traceback</span><span style="color: black;">&#41;</span>:
        <span style="color: #dc143c;">os</span>.<span style="color: black;">chdir</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">curdir</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>On l&#8217;utilise comme ça:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #808080; font-style: italic;"># ici on est dans /home/moi</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">with</span> Cd<span style="color: black;">&#40;</span><span style="color: #483d8b;">'/'</span><span style="color: black;">&#41;</span>:
&nbsp;
    <span style="color: #808080; font-style: italic;"># faire un truc dans /</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">with</span> Cd<span style="color: black;">&#40;</span><span style="color: #483d8b;">'/opt'</span><span style="color: black;">&#41;</span>:
&nbsp;
        <span style="color: #808080; font-style: italic;"># faire un truc dans /opt</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># ici on est dans /</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># ici on est dans /home/moi</span></pre></td></tr></table></div>

<p>C&#8217;est d&#8217;ailleurs ce que fait <a href="http://sametmax.com/travailler-moins-pour-gagner-plus-en-15-minutes-avec-python-fabric/">fabric</a>.</p>
<h2>Le mot clé <code>as</code></h2>
<p>Tout ce qu&#8217;on retourne dans <code>__enter__</code> peut être récupéré grâce au mot clé <code>as</code>. Imaginons un context manager qui permette d&#8217;ouvrir un fichier et de le fermer automatiquement:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">class</span> OpenFile<span style="color: black;">&#40;</span>objet<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__init__</span><span style="color: black;">&#40;</span>filename<span style="color: #66cc66;">,</span> mode<span style="color: #66cc66;">=</span><span style="color: #483d8b;">'r'</span><span style="color: black;">&#41;</span>:
        <span style="color: #008000;">self</span>.<span style="color: black;">filename</span> <span style="color: #66cc66;">=</span> filename
        <span style="color: #008000;">self</span>.<span style="color: black;">mode</span> <span style="color: #66cc66;">=</span> mode
    <span style="color: #ff7700;font-weight:bold;">def</span> __enter__<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #008000;">self</span>.<span style="color: #008000;">file</span> <span style="color: #66cc66;">=</span> <span style="color: #008000;">open</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">filename</span><span style="color: #66cc66;">,</span> <span style="color: #008000;">self</span>.<span style="color: black;">mode</span><span style="color: black;">&#41;</span>
        <span style="color: #808080; font-style: italic;"># ici on retourne l'objet fichier, il sera accessible avec &quot;as&quot;</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">self</span>.<span style="color: #008000;">file</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> __exit__<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> <span style="color: #008000;">type</span><span style="color: #66cc66;">,</span> value<span style="color: #66cc66;">,</span> <span style="color: #dc143c;">traceback</span><span style="color: black;">&#41;</span>:
        <span style="color: #008000;">self</span>.<span style="color: #008000;">file</span>.<span style="color: black;">close</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>On l&#8217;utilise comme ceci:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">with</span> OpenFile<span style="color: black;">&#40;</span><span style="color: #483d8b;">'/etc/fstab'</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">as</span> f:
    <span style="color: #ff7700;font-weight:bold;">for</span> line <span style="color: #ff7700;font-weight:bold;">in</span> f:
        <span style="color: #ff7700;font-weight:bold;">print</span> line</pre></td></tr></table></div>

<p><code>f</code> va contenir ici l&#8217;objet fichier, car nous l&#8217;avons retourné dans <code>__enter__</code>. A la fin du bloc <code>with</code>, le fichier sera fermé automatiquement.</p>
<p>Et devinez quoi, Python possède déjà un context manager qui fait ça:.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">with</span> <span style="color: #008000;">open</span><span style="color: black;">&#40;</span>vot_fichier_msieu_dames<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">as</span> f:
   <span style="color: #808080; font-style: italic;"># faire un truc</span></pre></td></tr></table></div>

<h2>Context managers sous forme de fonctions</h2>
<p>Faire les choses sous forme de classes, c&#8217;est pratique quand on a beaucoup de logique à encapsuler. Mais la plupart des context managers sont très simples. Pour cette raison, Python vient avec plein d&#8217;outils pour se simplifier la vie avec <code>with</code> dans un module judicieusement nommé <code>contextlib</code>.</p>
<p>Pour l&#8217;utiliser, il faut avoir des notions sur les décorateurs, et le mot clé <a href="http://sametmax.com/comment-utiliser-yield-et-les-generateurs-en-python/">yield</a>. Si ce n&#8217;est pas votre cas, restez sur la version sous forme de classe :-)</p>
<p>Supposons que l&#8217;on veuille recréer le context manager <code>open</code>:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">from</span> contextlib <span style="color: #ff7700;font-weight:bold;">import</span> contextmanager
&nbsp;
<span style="color: #66cc66;">@</span>contextmanager
<span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #008000;">open</span><span style="color: black;">&#40;</span>filename<span style="color: #66cc66;">,</span> mode<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">try</span>:
        f <span style="color: #66cc66;">=</span> <span style="color: #008000;">open</span><span style="color: black;">&#40;</span>filename<span style="color: #66cc66;">,</span> mode<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">yield</span> f
    <span style="color: #ff7700;font-weight:bold;">finally</span>:
        f.<span style="color: black;">close</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Bon, c&#8217;est simplifié, hein, le vrai est plus robuste que ça.</p>
<p>Comment ça marche ?</p>
<p>D&#8217;abord, on utilise le décorateur <code>@contextmanager</code> pour dire à Python que la fonction sera un context manager.</p>
<p>Ensuite, on fait un <code>try</code>/<code>finally</code> (il est pas automatique comme avec <code>__enter__</code> et <code>__exit__</code>).</p>
<p><code>yield</code> sépare le code en deux: tout ce qui est avant est l&#8217;équivalent de <code>__enter__</code>, tout ce qui est après est l&#8217;équivalent de <code>__exit__</code>. Ce qui est &#8220;yieldé&#8221; est ce que l&#8217;on récupère avec le mot clé <code>as</code>.</p>
<h2>Context manager et décorateur, le shampoing deux en un</h2>
<p>Ces deux fonctionnalités se ressemblent beaucoup: elles permettent toutes les deux de lancer du code automatiquement avant et après un code tiers. La seule différence est que le context manager le fait à la demande, alors que le décorateur s&#8217;applique à la définition d&#8217;une fonction.</p>
<p>Quand on sait comment ils marchent, il est facile de faire un context manager utilisable également en tant que décorateur.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">from</span> functools <span style="color: #ff7700;font-weight:bold;">import</span> wraps
&nbsp;
<span style="color: #ff7700;font-weight:bold;">class</span> ContextDecorator<span style="color: black;">&#40;</span><span style="color: #008000;">object</span><span style="color: black;">&#41;</span>:
    <span style="color: #808080; font-style: italic;"># __call__ est une méthode magique appelée quand on utilise () sur un objet</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__call__</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> f<span style="color: black;">&#41;</span>:
        <span style="color: #808080; font-style: italic;"># bon, cette partie là suppose que vous savez comment marche un</span>
        <span style="color: #808080; font-style: italic;"># décorateur, si c'est pas le cas, retournez lire l'article sur S&amp;amp;M</span>
        <span style="color: #808080; font-style: italic;"># linké dans le premier paragraphe</span>
        <span style="color: #66cc66;">@</span>wraps<span style="color: black;">&#40;</span>f<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">def</span> decorated<span style="color: black;">&#40;</span>*args<span style="color: #66cc66;">,</span> **kwds<span style="color: black;">&#41;</span>:
            <span style="color: #808080; font-style: italic;"># notez le with appelé sur soi-même, c'est y pas mignon !</span>
            <span style="color: #ff7700;font-weight:bold;">with</span> <span style="color: #008000;">self</span>:
                <span style="color: #ff7700;font-weight:bold;">return</span> f<span style="color: black;">&#40;</span>*args<span style="color: #66cc66;">,</span> **kwds<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> decorated</pre></td></tr></table></div>

<p>Et voilà, il suffit d&#8217;hériter de ça, et on a un décorateur + context manager. Par exemple, si on veut timer un truc:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">datetime</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">class</span> TimeIt<span style="color: black;">&#40;</span>ContextDecorator<span style="color: black;">&#41;</span>:
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> __enter__<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #008000;">self</span>.<span style="color: black;">start</span> <span style="color: #66cc66;">=</span> <span style="color: #dc143c;">datetime</span>.<span style="color: #dc143c;">datetime</span>.<span style="color: black;">now</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #008000;">self</span>.<span style="color: black;">start</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> __exit__<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> <span style="color: #008000;">type</span><span style="color: #66cc66;">,</span> value<span style="color: #66cc66;">,</span> <span style="color: #dc143c;">traceback</span><span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: black;">&#40;</span><span style="color: #dc143c;">datetime</span>.<span style="color: #dc143c;">datetime</span>.<span style="color: black;">now</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> -<span style="color: #008000;">self</span>.<span style="color: black;">start</span><span style="color: black;">&#41;</span>.<span style="color: black;">total_seconds</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Timer juste un appel:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> foo<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    <span style="color: #808080; font-style: italic;"># faire un truc</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">with</span> TimeIt<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    foo<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Timer tous les appels:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">@</span>TimeIt<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">def</span> foo<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
   <span style="color: #808080; font-style: italic;"># faire un truc</span></pre></td></tr></table></div>

<p>Notez que <a href="http://docs.python.org/py3k/library/contextlib.html#contextlib.ContextDecorator">ContextDecorator</a> est présent par défaut dans le module <code>contextlib</code> sous Python 3.2.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/les-context-managers-et-le-mot-cle-with-en-python/feed/</wfw:commentRss>
		<slash:comments>13</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2012/09/shampooing-demelant-chien-demavic-laboratoire-2-1-z-345-34502.jpg" length="25075" type="image/jpg" />	</item>
		<item>
		<title>J&#8217;adore les context managers Python</title>
		<link>http://sametmax.com/jadore-les-context-managers-python/</link>
		<comments>http://sametmax.com/jadore-les-context-managers-python/#comments</comments>
		<pubDate>Tue, 24 Jul 2012 15:15:53 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[contextmanager]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[file]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[with]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=1296</guid>
		<description><![CDATA[Loin de moi l'idée de faire un tuto ce matin sur les context managers, mais j'ai juste l'envie d'énoncer tout haut mon amour cette fonctionnalité.]]></description>
				<content:encoded><![CDATA[<p>En Python il y a plein de trucs pas du tout indispensables: les metaclasses, <a href="http://sametmax.com/comprendre-les-decorateurs-python-pas-a-pas-partie-1/">les décorateurs</a>, les <a href="http://sametmax.com/python-love-les-listes-en-intention-partie/">listes en intentions</a>&#8230; Elles sont là uniquement pour rendre le langage plus agréable à l&#8217;usage, mais on pourrait faire sans. Les context managers en font partie. Loin de moi l&#8217;idée de faire un tuto ce matin sur les context managers, mais j&#8217;ai juste l&#8217;envie d&#8217;énoncer tout haut mon amour cette fonctionnalité.</p>
<p>Prenez un model Django Media: vous transcodez ce media, vous faites souvent des opérations dans son dossier. Il faut s&#8217;assurer que ça marche. Et quand ça foire, il faut s&#8217;assurer que l&#8217;on a bien nettoyé le répertoire de travail.</p>
<p>Hop:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">class</span> Media<span style="color: black;">&#40;</span>models.<span style="color: black;">Model</span><span style="color: black;">&#41;</span>:
&nbsp;
    <span style="color: black;">&#91;</span>...<span style="color: black;">&#93;</span>
&nbsp;
    <span style="color: #66cc66;">@</span>contextmanager
    <span style="color: #ff7700;font-weight:bold;">def</span> in_dir<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> delete_on_error<span style="color: #66cc66;">=</span><span style="color: #008000;">False</span><span style="color: black;">&#41;</span>:
        <span style="color: #808080; font-style: italic;"># si vous ne comprenez pas ce code, ne vous en faites pas,</span>
        <span style="color: #808080; font-style: italic;"># c'est du Python avancé</span>
        <span style="color: #ff7700;font-weight:bold;">try</span>:
            <span style="color: #dc143c;">os</span>.<span style="color: black;">makedirs</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: #008000;">dir</span><span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: black;">&#40;</span><span style="color: #008000;">OSError</span><span style="color: #66cc66;">,</span> <span style="color: #008000;">IOError</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">as</span> e:
            <span style="color: #ff7700;font-weight:bold;">pass</span>
&nbsp;
        <span style="color: #ff7700;font-weight:bold;">try</span>:
            <span style="color: #ff7700;font-weight:bold;">yield</span> <span style="color: #008000;">self</span>.<span style="color: #008000;">dir</span>
        <span style="color: #ff7700;font-weight:bold;">except</span>:
            <span style="color: #ff7700;font-weight:bold;">if</span> delete_on_error:
                <span style="color: #dc143c;">shutil</span>.<span style="color: black;">rmtree</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: #008000;">dir</span><span style="color: black;">&#41;</span>
            <span style="color: #ff7700;font-weight:bold;">raise</span></pre></td></tr></table></div>

<p>Et voilà, Max dans ses scripts de transcoding magiques n&#8217;a pas à se poser de question. Il a juste à faire:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">with</span> media.<span style="color: black;">in_dir</span><span style="color: black;">&#40;</span>delete_on_error<span style="color: #66cc66;">=</span><span style="color: #008000;">True</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">as</span> d:
    <span style="color: #808080; font-style: italic;"># faire des trucs avec le dossier dont le chemin est dans &quot;d&quot;</span></pre></td></tr></table></div>

<p>Le chemin spécifique pour ce média est garanti d&#8217;exister. </p>
<p>Si il y a une exception, le dossier est garanti d&#8217;être nettoyé.</p>
<p>C&#8217;est simple, c&#8217;est propre, c&#8217;est beau. J&#8217;aime.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/jadore-les-context-managers-python/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2012/07/sugar1.jpg" length="19402" type="image/jpg" />	</item>
	</channel>
</rss>
