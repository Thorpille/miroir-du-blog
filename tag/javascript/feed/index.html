<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Sam &#38; Max &#187; javascript</title>
	<atom:link href="http://sametmax.com/tag/javascript/feed/" rel="self" type="application/rss+xml" />
	<link>http://sametmax.com</link>
	<description>Du code, du cul</description>
	<lastBuildDate>Sat, 07 Nov 2015 10:56:13 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>http://wordpress.org/?v=4.1</generator>
	<item>
		<title>Aux couleurs du site 11</title>
		<link>http://sametmax.com/aux-couleurs-du-site/</link>
		<comments>http://sametmax.com/aux-couleurs-du-site/#comments</comments>
		<pubDate>Wed, 22 Jul 2015 10:41:26 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[javascript]]></category>
		<category><![CDATA[multiboards]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=16645</guid>
		<description><![CDATA[On est en train de tweaker un peut <a href="http://multiboards.net/">multiboards.net</a> Max et moi, et il a voulu ajouter un feature rigolote : les flux sont affichés avec une palette de couleur proche de celle du site. ]]></description>
				<content:encoded><![CDATA[<p>On est en train de tweaker un peu <a href="http://multiboards.net/">multiboards.net</a> Max et moi, et il a voulu ajouter un feature rigolote : les flux sont affichés avec une palette de couleurs proche de celle du site.</p>
<p>Comme récupérer les couleurs d&#8217;un site est compliqué, on s&#8217;est rabattus sur les couleurs du favicon, qui en théorie doit résumer l&#8217;identité d&#8217;un site. Ce n&#8217;est pas parfait, mais c&#8217;est plus simple à implémenter.</p>
<p>Au début, on avait écrit une solution avec Pillow et numpy. Ça marchait très bien, mais des extensions compilées juste pour faire de la déco c&#8217;était un peu lourd, surtout si un jour on libère le code source (mais vu comme les sources sont dégueues et qu&#8217;on a pas de doc, pour le moment c&#8217;est pas gagné).</p>
<p>On a donc changé notre fusil d&#8217;épaule, et on a choisit une nouvelle technique : faire la moitié du taff côté client.</p>
<h2>Récupérer le favicon côté serveur</h2>
<p>On ne peut pas faire des requêtes cross domain en JS, donc on doit toujours récupérer l&#8217;image côté serveur. <code>get_favicon_url()</code> parse le site à coup de regex (c&#8217;est mal mais ça évite de rajouter BeautifulSoup en dépendance pour une balise) pour récupérer son URL sur la page donnée, ou à défaut, sur la page à la racine du site. On se donne plusieurs essais en cas d&#8217;erreurs de réseau :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">&nbsp;
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">urllib</span>
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">urlparse</span> 
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> get_favicon_url<span style="color: black;">&#40;</span>url<span style="color: #66cc66;">,</span> retry<span style="color: #66cc66;">=</span><span style="color: #ff4500;">3</span><span style="color: #66cc66;">,</span> try_home_page<span style="color: #66cc66;">=</span><span style="color: #008000;">True</span><span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot; Try to find a favicon url on the given page &quot;&quot;&quot;</span>
&nbsp;
    parsed_url <span style="color: #66cc66;">=</span> <span style="color: #dc143c;">urlparse</span>.<span style="color: #dc143c;">urlparse</span><span style="color: black;">&#40;</span>url<span style="color: black;">&#41;</span>
    url_root <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">&quot;%s://%s&quot;</span> % <span style="color: black;">&#40;</span>parsed_url.<span style="color: black;">scheme</span><span style="color: #66cc66;">,</span> parsed_url.<span style="color: black;">netloc</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">try</span>:
        <span style="color: #808080; font-style: italic;"># try to get it using a regex on the current URL</span>
        html <span style="color: #66cc66;">=</span> fetch_url<span style="color: black;">&#40;</span>url<span style="color: #66cc66;">,</span> retry<span style="color: #66cc66;">=</span>retry<span style="color: black;">&#41;</span>
        html <span style="color: #66cc66;">=</span> html.<span style="color: black;">decode</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'ascii'</span><span style="color: #66cc66;">,</span> errors<span style="color: #66cc66;">=</span><span style="color: #483d8b;">'ignore'</span><span style="color: black;">&#41;</span>
        pattern <span style="color: #66cc66;">=</span> r<span style="color: #483d8b;">&quot;&quot;&quot;
                               href=(?:&quot;|')<span style="color: #000099; font-weight: bold;">\s</span>*
                               (?P&lt;favicon&gt;[^<span style="color: #000099; font-weight: bold;">\s</span>'&quot;]*favicon.[a-zA-Z]{3,4})
                               <span style="color: #000099; font-weight: bold;">\s</span>*(?:&quot;|')
                          &quot;&quot;&quot;</span>
&nbsp;
        match <span style="color: #66cc66;">=</span> <span style="color: #dc143c;">re</span>.<span style="color: black;">search</span><span style="color: black;">&#40;</span>pattern<span style="color: #66cc66;">,</span> html<span style="color: #66cc66;">,</span> <span style="color: #dc143c;">re</span>.<span style="color: black;">U</span>|<span style="color: #dc143c;">re</span>.<span style="color: black;">VERBOSE</span><span style="color: black;">&#41;</span>
        favicon_url <span style="color: #66cc66;">=</span> match.<span style="color: black;">groups</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#93;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: #008000;">IOError</span>:
        <span style="color: #808080; font-style: italic;"># this is a network error so eventually, let it crash</span>
        <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #ff7700;font-weight:bold;">not</span> try_home_page:
            <span style="color: #ff7700;font-weight:bold;">raise</span>
        <span style="color: #808080; font-style: italic;"># try with the home page, maybe this one is accessible</span>
        favicon_url <span style="color: #66cc66;">=</span> get_favicon_url<span style="color: black;">&#40;</span>url_root<span style="color: #66cc66;">,</span> retry<span style="color: #66cc66;">=</span>retry<span style="color: #66cc66;">,</span>
                                                       try_home_page<span style="color: #66cc66;">=</span><span style="color: #008000;">False</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: black;">&#40;</span><span style="color: #008000;">IndexError</span><span style="color: #66cc66;">,</span> <span style="color: #008000;">AttributeError</span><span style="color: black;">&#41;</span>:
        <span style="color: #808080; font-style: italic;"># url is not on this page, try the home page</span>
        <span style="color: #ff7700;font-weight:bold;">if</span> try_home_page:
            <span style="color: #ff7700;font-weight:bold;">return</span> get_favicon_url<span style="color: black;">&#40;</span>url_root<span style="color: #66cc66;">,</span> retry<span style="color: #66cc66;">=</span>retry<span style="color: #66cc66;">,</span> try_home_page<span style="color: #66cc66;">=</span><span style="color: #008000;">False</span><span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># can't find the favicon url, default to standard url</span>
        favicon_url <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">'/favicon.ico'</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># make sure to have the domain of the original website in the favicon url</span>
    <span style="color: #ff7700;font-weight:bold;">if</span> url_root <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> favicon_url:
        favicon_url <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">&quot;%s/%s&quot;</span> % <span style="color: black;">&#40;</span>url_root<span style="color: #66cc66;">,</span> favicon_url.<span style="color: black;">lstrip</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'/'</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">return</span> favicon_url
&nbsp;
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> fetch_favicon<span style="color: black;">&#40;</span>url<span style="color: #66cc66;">,</span> retry<span style="color: #66cc66;">=</span><span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot; Returns the bytes of the favicon of this site &quot;&quot;&quot;</span>
    favicon_url <span style="color: #66cc66;">=</span> get_favicon_url<span style="color: black;">&#40;</span>url<span style="color: #66cc66;">,</span> retry<span style="color: #66cc66;">=</span>retry<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> fetch_url<span style="color: black;">&#40;</span>favicon_url<span style="color: #66cc66;">,</span> retry<span style="color: #66cc66;">=</span>retry<span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p><code>fetch_favicon()</code> télécharge l&#8217;image proprement dite et retourne les bits tels quels. Notez que tout ça est synchrone et bloquant, mais heureusement le traffic de multiboards est sans doute trop faible pour poser problème.</p>
<h2>Exposer le résultat au client</h2>
<p>Ensuite il faut faire le lien entre le client et le serveur. On fait donc un petit routing (c&#8217;est du bottle) qui va retourner tout ça en base64 afin qu&#8217;on puisse l&#8217;utiliser directement dans un objet <code>Image</code> JS :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">&nbsp;
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">base64</span>
<span style="color: #ff7700;font-weight:bold;">from</span> bottle <span style="color: #ff7700;font-weight:bold;">import</span> post<span style="color: #66cc66;">,</span> HTTPError
&nbsp;
<span style="color: #66cc66;">@</span>post<span style="color: black;">&#40;</span><span style="color: #483d8b;">'/favicon'</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">def</span> fetch_favicon_base64<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot; Return the favicon URL from a website &quot;&quot;&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">try</span>:
        url <span style="color: #66cc66;">=</span> request.<span style="color: black;">POST</span><span style="color: black;">&#91;</span><span style="color: #483d8b;">'url'</span><span style="color: black;">&#93;</span>
    <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: #008000;">KeyError</span>:
        <span style="color: #ff7700;font-weight:bold;">raise</span> HTTPError<span style="color: black;">&#40;</span><span style="color: #ff4500;">400</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">&quot;You must pass a site URL&quot;</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">try</span>:
        <span style="color: #808080; font-style: italic;"># return favicon as base64 url to be easily included in</span>
        <span style="color: #808080; font-style: italic;"># a img tag</span>
        favicon <span style="color: #66cc66;">=</span> fetch_favicon<span style="color: black;">&#40;</span>url<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> b<span style="color: #483d8b;">'data:image/x-icon;base64,'</span> + <span style="color: #dc143c;">base64</span>.<span style="color: black;">b64encode</span><span style="color: black;">&#40;</span>favicon<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: black;">&#40;</span><span style="color: #008000;">IOError</span><span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">raise</span> HTTPError<span style="color: black;">&#40;</span><span style="color: #ff4500;">400</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">&quot;Unable to find any favicon URL&quot;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<h2>Récupérer la palette côté client</h2>
<p>Avec un peu d&#8217;AJAX sur notre vue, on récupère les bits de l&#8217;image, et on fout le tout dans un objet <code>Image</code> qu&#8217;on passe à la lib <a href="http://lokeshdhakar.com/projects/color-thief/">ColorThief</a>. Cette dernière nous renvoie un array avec la palette. On convertit tout ça en code hexadécimal, et on diminue la luminosité de certaines couleurs pour rendre le texte plus lisible.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family:monospace;"> $.<span style="color: #660066;">post</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'/favicon'</span><span style="color: #339933;">,</span> <span style="color: #009900;">&#123;</span>url<span style="color: #339933;">:</span> url<span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span>.<span style="color: #660066;">done</span><span style="color: #009900;">&#40;</span><span style="color: #000066; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>data<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
&nbsp;
        <span style="color: #006600; font-style: italic;">// load an image with the base64 data of the favicon</span>
        <span style="color: #000066; font-weight: bold;">var</span> image <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">new</span> Image<span style="color: #339933;">;</span>
        image.<span style="color: #660066;">src</span> <span style="color: #339933;">=</span> data<span style="color: #339933;">;</span>
        image.<span style="color: #660066;">onload</span> <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
&nbsp;
            <span style="color: #006600; font-style: italic;">// ask ColorThief for the main favicon colors</span>
            <span style="color: #000066; font-weight: bold;">var</span> colorThief <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">new</span> ColorThief<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
            <span style="color: #000066; font-weight: bold;">var</span> bc <span style="color: #339933;">=</span> colorThief.<span style="color: #660066;">getPalette</span><span style="color: #009900;">&#40;</span>image<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
            <span style="color: #006600; font-style: italic;">// some tools to convert the RGB array into</span>
            <span style="color: #006600; font-style: italic;">// rgb hex string</span>
            <span style="color: #000066; font-weight: bold;">function</span> componentToHex<span style="color: #009900;">&#40;</span>c<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
                <span style="color: #000066; font-weight: bold;">var</span> hex <span style="color: #339933;">=</span> c.<span style="color: #660066;">toString</span><span style="color: #009900;">&#40;</span><span style="color: #CC0000;">16</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
                <span style="color: #000066; font-weight: bold;">return</span> hex.<span style="color: #660066;">length</span> <span style="color: #339933;">==</span> <span style="color: #CC0000;">1</span> <span style="color: #339933;">?</span> <span style="color: #3366CC;">&quot;0&quot;</span> <span style="color: #339933;">+</span> hex <span style="color: #339933;">:</span> hex<span style="color: #339933;">;</span>
            <span style="color: #009900;">&#125;</span>
&nbsp;
            <span style="color: #000066; font-weight: bold;">function</span> rgbToHex<span style="color: #009900;">&#40;</span>array<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
                <span style="color: #000066; font-weight: bold;">return</span> componentToHex<span style="color: #009900;">&#40;</span>array<span style="color: #009900;">&#91;</span><span style="color: #CC0000;">0</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">+</span> componentToHex<span style="color: #009900;">&#40;</span>array<span style="color: #009900;">&#91;</span><span style="color: #CC0000;">1</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">+</span> componentToHex<span style="color: #009900;">&#40;</span>array<span style="color: #009900;">&#91;</span><span style="color: #CC0000;">2</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
            <span style="color: #009900;">&#125;</span>
&nbsp;
            <span style="color: #006600; font-style: italic;">// make the color brigther</span>
            <span style="color: #000066; font-weight: bold;">function</span> increase_brightness<span style="color: #009900;">&#40;</span>hex<span style="color: #339933;">,</span> percent<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
&nbsp;
                <span style="color: #006600; font-style: italic;">// convert 3 char codes --&gt; 6, e.g. `E0F` --&gt; `EE00FF`</span>
                <span style="color: #000066; font-weight: bold;">if</span><span style="color: #009900;">&#40;</span>hex.<span style="color: #660066;">length</span> <span style="color: #339933;">==</span> <span style="color: #CC0000;">3</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
                    hex <span style="color: #339933;">=</span> hex.<span style="color: #660066;">replace</span><span style="color: #009900;">&#40;</span><span style="color: #009966; font-style: italic;">/(.)/g</span><span style="color: #339933;">,</span> <span style="color: #3366CC;">'$1$1'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
                <span style="color: #009900;">&#125;</span>
&nbsp;
                <span style="color: #000066; font-weight: bold;">var</span> r <span style="color: #339933;">=</span> parseInt<span style="color: #009900;">&#40;</span>hex.<span style="color: #660066;">substr</span><span style="color: #009900;">&#40;</span><span style="color: #CC0000;">0</span><span style="color: #339933;">,</span> <span style="color: #CC0000;">2</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> <span style="color: #CC0000;">16</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span>
                    g <span style="color: #339933;">=</span> parseInt<span style="color: #009900;">&#40;</span>hex.<span style="color: #660066;">substr</span><span style="color: #009900;">&#40;</span><span style="color: #CC0000;">2</span><span style="color: #339933;">,</span> <span style="color: #CC0000;">2</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> <span style="color: #CC0000;">16</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span>
                    b <span style="color: #339933;">=</span> parseInt<span style="color: #009900;">&#40;</span>hex.<span style="color: #660066;">substr</span><span style="color: #009900;">&#40;</span><span style="color: #CC0000;">4</span><span style="color: #339933;">,</span> <span style="color: #CC0000;">2</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> <span style="color: #CC0000;">16</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
                <span style="color: #000066; font-weight: bold;">return</span> <span style="color: #3366CC;">''</span> <span style="color: #339933;">+</span>
                   <span style="color: #009900;">&#40;</span><span style="color: #009900;">&#40;</span><span style="color: #CC0000;">0</span><span style="color: #339933;">|</span><span style="color: #009900;">&#40;</span><span style="color: #CC0000;">1</span><span style="color: #339933;">&lt;&lt;</span><span style="color: #CC0000;">8</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">+</span> r <span style="color: #339933;">+</span> <span style="color: #009900;">&#40;</span><span style="color: #CC0000;">256</span> <span style="color: #339933;">-</span> r<span style="color: #009900;">&#41;</span> <span style="color: #339933;">*</span> percent <span style="color: #339933;">/</span> <span style="color: #CC0000;">100</span><span style="color: #009900;">&#41;</span>.<span style="color: #660066;">toString</span><span style="color: #009900;">&#40;</span><span style="color: #CC0000;">16</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span>.<span style="color: #660066;">substr</span><span style="color: #009900;">&#40;</span><span style="color: #CC0000;">1</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">+</span>
                   <span style="color: #009900;">&#40;</span><span style="color: #009900;">&#40;</span><span style="color: #CC0000;">0</span><span style="color: #339933;">|</span><span style="color: #009900;">&#40;</span><span style="color: #CC0000;">1</span><span style="color: #339933;">&lt;&lt;</span><span style="color: #CC0000;">8</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">+</span> g <span style="color: #339933;">+</span> <span style="color: #009900;">&#40;</span><span style="color: #CC0000;">256</span> <span style="color: #339933;">-</span> g<span style="color: #009900;">&#41;</span> <span style="color: #339933;">*</span> percent <span style="color: #339933;">/</span> <span style="color: #CC0000;">100</span><span style="color: #009900;">&#41;</span>.<span style="color: #660066;">toString</span><span style="color: #009900;">&#40;</span><span style="color: #CC0000;">16</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span>.<span style="color: #660066;">substr</span><span style="color: #009900;">&#40;</span><span style="color: #CC0000;">1</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">+</span>
                   <span style="color: #009900;">&#40;</span><span style="color: #009900;">&#40;</span><span style="color: #CC0000;">0</span><span style="color: #339933;">|</span><span style="color: #009900;">&#40;</span><span style="color: #CC0000;">1</span><span style="color: #339933;">&lt;&lt;</span><span style="color: #CC0000;">8</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">+</span> b <span style="color: #339933;">+</span> <span style="color: #009900;">&#40;</span><span style="color: #CC0000;">256</span> <span style="color: #339933;">-</span> b<span style="color: #009900;">&#41;</span> <span style="color: #339933;">*</span> percent <span style="color: #339933;">/</span> <span style="color: #CC0000;">100</span><span style="color: #009900;">&#41;</span>.<span style="color: #660066;">toString</span><span style="color: #009900;">&#40;</span><span style="color: #CC0000;">16</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span>.<span style="color: #660066;">substr</span><span style="color: #009900;">&#40;</span><span style="color: #CC0000;">1</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
            <span style="color: #009900;">&#125;</span>
&nbsp;
            <span style="color: #006600; font-style: italic;">/* Define board colors */</span>
            <span style="color: #000066; font-weight: bold;">var</span> header <span style="color: #339933;">=</span>  <span style="color: #3366CC;">'#'</span> <span style="color: #339933;">+</span> rgbToHex<span style="color: #009900;">&#40;</span>bc<span style="color: #009900;">&#91;</span><span style="color: #CC0000;">0</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
            <span style="color: #000066; font-weight: bold;">var</span> odd <span style="color: #339933;">=</span> <span style="color: #3366CC;">'#'</span> <span style="color: #339933;">+</span> increase_brightness<span style="color: #009900;">&#40;</span>rgbToHex<span style="color: #009900;">&#40;</span>bc<span style="color: #009900;">&#91;</span><span style="color: #CC0000;">1</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> <span style="color: #CC0000;">90</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
            <span style="color: #000066; font-weight: bold;">var</span> even <span style="color: #339933;">=</span> <span style="color: #3366CC;">'#'</span> <span style="color: #339933;">+</span> increase_brightness<span style="color: #009900;">&#40;</span>rgbToHex<span style="color: #009900;">&#40;</span>bc<span style="color: #009900;">&#91;</span><span style="color: #CC0000;">2</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> <span style="color: #CC0000;">90</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre></td></tr></table></div>

<p>Est-ce que la feature est utile ? Je ne sais pas, c&#8217;est un peu gadget, mais c&#8217;était marrant à faire, et c&#8217;est vrai qu&#8217;on identifie bien chaque site sur la page du coup. </p>
<p>L&#8217;idée ici est que le serveur et le client travaillent en équipe, et que grâce au navigateur on a une stack de traitement image/audio/video à portée de code. D&#8217;ailleurs on a viré le plugin flash des radios pour le remplacer par du chteumeuleu 5.</p>
<p>On peut imaginer la même chose avec tous les outils côtés en JS, ceci incluant les préprocesseurs et minifieurs JS ou CSS : pas besoin d&#8217;installer Node pour faire tourner tout ça, il suffit de déléguer le boulot à un tab du browser. Pour améliorer la stack, on pourrait par ailleurs utiliser du RPC avec WAMP et même prévenir le navigateur quand un fichier est prêt avec PUB/SUB afin qu&#8217;il le recharge. Vous avez vu comme j&#8217;arrive toujours à placer crossbar ?</p>
<p>J&#8217;ai un pote qui va venir dans quelques jours pour creuser cette idée qui permettrait d&#8217;avoir en pur Python une sorte de livereload sans extension, sans gros GUI, qui transpile tout et rafraichit tout avec un simple fichier de config. Peut être aurons nous le temps de faire un proto.</p>
<p>C&#8217;était l&#8217;inspiration du jour, passez une excellente canicule !</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/aux-couleurs-du-site/feed/</wfw:commentRss>
		<slash:comments>11</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2015/07/LPYCHKx.jpg" length="86941" type="image/jpg" />	</item>
		<item>
		<title>La mort du tuto angular 27</title>
		<link>http://sametmax.com/la-mort-du-tuto-angular/</link>
		<comments>http://sametmax.com/la-mort-du-tuto-angular/#comments</comments>
		<pubDate>Sun, 14 Jun 2015 18:25:29 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Philo et culture]]></category>
		<category><![CDATA[angularjs]]></category>
		<category><![CDATA[javascript]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=16389</guid>
		<description><![CDATA[<a href="http://sametmax.com/je-me-te-tate-a-arreter-le-tuto-angular/">J'avais demandé</a> si il y avait encore des gens intéressés par le <a href="http://sametmax.com/angularjs-pour-les-utilisateurs-de-jquery-partie-2/">tuto angularjs</a> que j'avais commencé. En effet les ressources sur Angular sont généralement de mauvaise qualité, et la réponse avait été un gros OUI.]]></description>
				<content:encoded><![CDATA[<p><a href="http://sametmax.com/je-me-te-tate-a-arreter-le-tuto-angular/">J&#8217;avais demandé</a> si il y avait encore des gens intéressés par le <a href="http://sametmax.com/angularjs-pour-les-utilisateurs-de-jquery-partie-2/">tuto angularjs</a> que j&#8217;avais commencé. En effet les ressources sur Angular sont généralement de mauvaise qualité, et la réponse avait été un gros OUI.</p>
<p>Je m&#8217;étais donc mis en tête de continuer. Malgré <a href="https://www.youtube.com/watch?v=KJ_xAwSeFR8">la mort annoncée du framework</a>. Malgré <a href="http://www.i-programmer.info/news/167-javascript/7932-angularjs-20-is-radically-different-.html">une V2 qui va tout casser</a>.</p>
<p>Voyez-vous, j&#8217;aime Angular. Bien que je pense que pour des grosses apps une approche comme ReactJS + BackboneJS est plus saine, pour une petit app rapide ou du prototypage c&#8217;est très productif et pratique.</p>
<p>En plus, je n&#8217;aime vraiment pas manquer à mes engagements, et en presque 3 ans de ce blog, je les ai tenu. J&#8217;ai toujours publié les articles promis. Toujours répondu aux mails. Parfois avec des mois de retard, certes, mais je n&#8217;ai signé aucun contrat moral sur les deadlines :)</p>
<p>Je vais néanmoins faire une exception ici et envoyer le tuto Angular au cimetière. Toute mes excuses à ceux qui l&#8217;attendaient.</p>
<p>Bien sûr il y a le fait que j&#8217;ai beaucoup de travail. Cependant si c&#8217;était la cause principale je n&#8217;écrirais plus ici car ça me demande des heures et des heures chaque semaine.</p>
<p>C&#8217;est surtout qu&#8217;il se trouve que j&#8217;avorte régulièrement des tentatives de retravailler dessus. C&#8217;est un signe de manque de motivation certain, et je viens d&#8217;en comprendre aujourd&#8217;hui la raison : c&#8217;est du Javascript.</p>
<p>Jusqu&#8217;ici le blog s&#8217;était autorisé régulièrement des sorties de la ligne éditoriale, mais un tel travail, un guide complet sur Angular, enterine le JS comme un sujet majeur du site.</p>
<p>Or ce n&#8217;est pas le cas.</p>
<p><a href="http://sametmax.com/un-gros-troll-de-plus-sur-javacscript/">Je n&#8217;aime pas Javascript.</a></p>
<p>Du coup non seulement me motiver à faire le dossier me demande une énorme énergie (qui pour le moment se transforme en procrastination coupable), mais en prime je me dis que c&#8217;est dépenser des ressources pour faire le taff d&#8217;une communauté qu&#8217;au final je ne supporte que par obligation professionnelle.</p>
<p>Le résultat est donc que bien que je vais continuer à parler de JS et à coder en JS (programmation Web oblige), je ne vais pas lui accorder autant de place sur S&#038;M ou dans mes heures de loisir.</p>
<p>Je remercie ceux qui prennent le temps de le faire, après tout je profite de leur travail. De mon côté, je vais me concentrer sur les domaines qui me sont plus chers, et parler d&#8217;autre chose uniquement de manière ponctuelle. L&#8217;investissement me parait plus judicieux.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/la-mort-du-tuto-angular/feed/</wfw:commentRss>
		<slash:comments>27</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2015/06/you-trusted-me.gif" length="777074" type="image/jpg" />	</item>
		<item>
		<title>Je me te tâte à arrêter le tuto Angular 35</title>
		<link>http://sametmax.com/je-me-te-tate-a-arreter-le-tuto-angular/</link>
		<comments>http://sametmax.com/je-me-te-tate-a-arreter-le-tuto-angular/#comments</comments>
		<pubDate>Thu, 15 Jan 2015 04:25:58 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[angularjs]]></category>
		<category><![CDATA[guide]]></category>
		<category><![CDATA[javascript]]></category>
		<category><![CDATA[meta]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=15736</guid>
		<description><![CDATA[Malgré les <a href="https://medium.com/este-js-framework/what-i-would-recommend-instead-of-angular-js-62b057d8a9e">critiques</a>, j'aime beaucoup AngularJS. Mais à <a href="http://www.i-programmer.info/news/167-javascript/7932-angularjs-20-is-radically-different-.html">l'annonce</a> de la version 2 d'Angular complètement incompatible avec la version 1, seulement quelques années après sa sorties, des questions <a href="http://www.quirksmode.org/blog/archives/2015/01/the_problem_wit.html">se sont posées</a> sur l'avenir du framework.]]></description>
				<content:encoded><![CDATA[<p>Malgré les <a href="https://medium.com/este-js-framework/what-i-would-recommend-instead-of-angular-js-62b057d8a9e">critiques</a>, j&#8217;aime beaucoup AngularJS. Mais à <a href="http://www.i-programmer.info/news/167-javascript/7932-angularjs-20-is-radically-different-.html">l&#8217;annonce</a> de la version 2 d&#8217;Angular complètement incompatible avec la version 1, seulement quelques années après sa sortie, des questions <a href="http://www.quirksmode.org/blog/archives/2015/01/the_problem_wit.html">se sont posées</a> sur l&#8217;avenir du framework.</p>
<p>J&#8217;utilise AngularJS pour certains de mes projets, je suis payé pour former sur AngularJS et j&#8217;ai commencé à écrire <a href="http://sametmax.com/angularjs-pour-les-utilisateurs-de-jquery-partie-1/">un guide</a> sur le sujet.</p>
<p>Mais je me demande franchement si ça vaut le coup de s&#8217;investir plus.</p>
<p>Je vais continuer à l&#8217;utiliser pour mes projets actuels, tout en regardant du côté de la concurrence <a href="http://facebook.github.io/flux/">ici</a> et <a href="http://facebook.github.io/react/">là</a>.</p>
<p>Si j&#8217;écris l&#8217;article, ce n&#8217;est pas pour vous alarmer. Ni même pour vous dire &#8220;arrêtez d&#8217;utiliser Angular&#8221;. Je pense que la V1 va être maintenue par la communauté pendant des années.</p>
<p>Non, je me demande simplement si ça vaut le coup que je me casse le cul à finir le guide.</p>
<p>J&#8217;ai du travail à la pelle, le<a href="http://sametmax.com/un-gros-guide-bien-gras-sur-les-tests-unitaires-en-python-partie-1/"> guide sur les tests en Python</a>, <a href="https://github.com/sametmax/Django--an-app-at-a-time/tree/fran%C3%A7ais">Django une app à la fois</a>, 0bin à porter en Python 3&#8230;</p>
<p>Bref, est-ce que vous êtes toujours aussi intéressés par ce guide ?</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/je-me-te-tate-a-arreter-le-tuto-angular/feed/</wfw:commentRss>
		<slash:comments>35</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2015/01/bbiydaX.gif" length="265415" type="image/jpg" />	</item>
		<item>
		<title>Qu&#8217;est-ce que les websockets et à quoi ça sert ? 8</title>
		<link>http://sametmax.com/quest-ce-que-les-websockets-et-a-quoi-ca-sert/</link>
		<comments>http://sametmax.com/quest-ce-que-les-websockets-et-a-quoi-ca-sert/#comments</comments>
		<pubDate>Tue, 30 Dec 2014 04:51:57 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[http]]></category>
		<category><![CDATA[javascript]]></category>
		<category><![CDATA[protocol]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[web]]></category>
		<category><![CDATA[websocket]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=15615</guid>
		<description><![CDATA[<blockquote>Le protocole WebSocket vise à développer un canal de communication full-duplex sur un socket TCP.</blockquote>

LOL. C'est clair non ?

Vous inquiétez pas, tonton Sam est là.]]></description>
				<content:encoded><![CDATA[<blockquote><p>Le protocole WebSocket vise à développer un canal de communication full-duplex sur un socket TCP.</p></blockquote>
<p>LOL. C&#8217;est clair non ?</p>
<p>Vous inquiétez pas, tonton Sam est là.</p>
<p>Le Web a évolué. On est passé de Gopher a HTTP 1 puis 1.1. Et on a eu AJAX pour rafraîchir la page sans tout recharger.</p>
<p>Et maintenant on a des apps complètes qui font des centaines de requêtes au serveur alors même que l&#8217;utilisateur ne change pas de page. D&#8217;ailleurs, je parie que plein de gens ne savent même plus ce qu&#8217;est une page&#8230;</p>
<p>Le problème c&#8217;est qu&#8217;AJAX, c&#8217;est toujours HTTP, et HTTP est sans état (stateless) : il ne garde aucune information en mémoire d&#8217;une requête à l&#8217;autre. Ça a des avantages, mais cela implique qu&#8217;à chaque requête, il faut ouvrir une connexion et la refermer. Ce qui bouffe quelques ms à chaque fois, et d&#8217;autant plus si on utilise SSL.</p>
<p>Une autre limite, c&#8217;est que le serveur ne peut pas envoyer de données au client (ici le navigateur) si le client ne fait pas une requête au préalable. Du coup, pour savoir si il y a quelque chose de nouveau, le navigateur doit régulièrement faire des requêtes au serveur ou utiliser des gros hacks comme le long polling.</p>
<p>Les websockets (c&#8217;est un abus de langage, on devrait parler du protocole Websocket) ont été créés pour répondre à ces besoins : elles permettent d&#8217;ouvrir une connexion permanente entre le navigateur et le serveur. Ainsi, chaque requête est plus rapide, et plus légère. En prime, le serveur peut envoyer des requêtes au navigateur pour le prévenir qu&#8217;il y a du nouveau.</p>
<p>Ceci permet de faire tout ce que permettait de faire AJAX mais en plus rapide, et en plus léger. Et également d&#8217;envoyer des notifications (ce contenu a changé, un message est arrivé, l&#8217;autre joueur a fait cette action&#8230;) au navigateur au moment où l&#8217;événement se produit.</p>
<p>En gros, de faire des apps Web quasi temps réel.</p>
<p>Il existe d&#8217;autre technos pour faire cela : applets Java, flash, comet, server sent events&#8230;</p>
<p>Mais aucune n&#8217;ont décollé. Websocket est donc aujourd&#8217;hui la solution de facto.</p>
<h2>Caractéristiques</h2>
<p>Le protocole Websocket utilise l&#8217;abréviation <code>ws</code> et <code>wss</code> si SSL, les URLs vers des endpoints websocket ressemblent donc à : <code>ws://domaine.tld/chemin/vers/truc/</code>.</p>
<p>Intelligemment, il utilise un handshake compatible avec celui de HTTP, permettant à un serveur de gérer les deux sur les mêmes ports. Donc on peut faire du Websocket sur le port 80 et 443. Néanmoins, certains proxy se gourent quand ils voient du websocket non chiffré et gauffrent votre connexion en la traitant comme du HTTP. Donc si vous voulez une app solide, investissez dans un certif SSL.</p>
<p>Tout ça fonctionne à partir de IE10. Notez comme IE est devenu le standard de ce qui ce fait de moins bien à tel point que je n&#8217;ai même pas besoin de vous parler des autres, vous savez que ça marche. Il existe en plus des <a href="https://github.com/gimite/web-socket-js">plugins flash</a> pour simuler des websockets sur les navigateurs anciens, c&#8217;est à dire les encore plus vieux IE.</p>
<p>Par défaut, les websockets permettent de faire de requêtes crossdomain, contrairement à AJAX. Avec les nouvelles apps qui utilisent NodeJS en local (comme <a href="http://getpopcornti.me/">popcorntime</a>) on peut imaginer une nouvelle type d&#8217;attaque : une page web qui se connecte à un serveur websocket local de votre machine. Comme les websockets sont souvent utilisées pour du RPC, il y a du potentiel.</p>
<h2>Bon, ta gueule, et montre le code</h2>

<!-- iframe plugin v.2.9 wordpress.org/plugins/iframe/ -->
<iframe width="100%" height="300" src="http://jsfiddle.net/rpecs5f1/embedded/result,js" allowfullscreen="allowfullscreen" frameborder="0" scrolling="no" class="iframe-class"></iframe>

<p>Vous noterez que ce qui prend du temps dans l&#8217;exemple c&#8217;est la connexion, qu&#8217;on ne fait qu&#8217;une fois. Ensuite l&#8217;échange de données est super rapide.</p>
<p>Ceci est un exemple Javascript, mais un client websocket n&#8217;est pas forcément un navigateur. En fait, c&#8217;est très précisément le cas avec <a href="http://sametmax.com/presentation-de-wamp-round-2/">WAMP</a>, dont les clients peuvent être des programmes Python, Objective C, Java, C++, etc. L&#8217;avantage de WAMP, c&#8217;est qu&#8217;il automatise toute la machinerie pour découper la logique de son programme en divers fonctions et services, plutôt que d&#8217;avoir à tout faire à la main avec <code>send()</code> et <code>onmessage()</code>.</p>
<p>Dans tous les cas, il vous faudra un serveur qui supporte les Websockets pour l&#8217;utiliser. En Python, c&#8217;est Tornado ou Twisted (sur lequel est basé le serveur WAMP crossbar). En Javascript, c&#8217;est NodeJS. Quoi qu&#8217;il en soit, il vous faut un logiciel qui gère l&#8217;IO de manière <a href="http://sametmax.com/quelle-est-la-difference-entre-bloquer-et-en-cours-dexecution/">non bloquante</a>, car il y a de nombreuses connexions ouvertes en simultanées, si on veut que ça soit performant.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/quest-ce-que-les-websockets-et-a-quoi-ca-sert/feed/</wfw:commentRss>
		<slash:comments>8</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2014/12/ybWpMif.jpg" length="81034" type="image/jpg" />	</item>
		<item>
		<title>Introduction au currying  3</title>
		<link>http://sametmax.com/introduction-au-currying/</link>
		<comments>http://sametmax.com/introduction-au-currying/#comments</comments>
		<pubDate>Fri, 12 Dec 2014 19:37:00 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[comprehension-lists]]></category>
		<category><![CDATA[currying]]></category>
		<category><![CDATA[fonction]]></category>
		<category><![CDATA[javascript]]></category>
		<category><![CDATA[lambda]]></category>
		<category><![CDATA[listes en intention]]></category>
		<category><![CDATA[programmation functionelle]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=12693</guid>
		<description><![CDATA[Le currying (ou Curryfication pour les frencofans) est le nom donné à une technique de programmation qui consiste à créer une fonction à partir d'une autre fonction et d'une liste partielle de paramètres destinés à celle-ci. On retrouve massivement cette technique en programmation fonctionnelle puisqu'elle permet de créer une fonction pure à partir d'une autre fonction pure. C'est une forme de réutilisabilité de code.]]></description>
				<content:encoded><![CDATA[<p>Le currying (ou Curryfication pour les frencofans) est le nom donné à une technique de programmation qui consiste à créer une fonction à partir d&#8217;une autre fonction et d&#8217;une liste partielle de paramètres destinés à celle-ci. On retrouve massivement cette technique en programmation fonctionnelle puisqu&#8217;elle permet de créer une fonction pure à partir d&#8217;une autre fonction pure. C&#8217;est une forme de réutilisabilité de code.</p>
<p>La forme la plus simple de currying est de réécrire une fonction appelant l&#8217;autre. Par exemple, soit une fonction pour multiplier tous les éléments d&#8217;un itérable :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> multiply<span style="color: black;">&#40;</span>iterable<span style="color: #66cc66;">,</span> number<span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot; Multiplie tous les éléments d'un itérable par un nombre.
&nbsp;
        Exemple :
&nbsp;
            &gt;&gt;&gt; list(multiply([1, 2, 3], 2))
            [2, 4, 6]
    &quot;&quot;&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: black;">&#40;</span>x * number <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> iterable<span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>On peut ensuite créer une fonction qui multipliera par 2 tous les éléments d&#8217;un itérable :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> doubled<span style="color: black;">&#40;</span>iterable<span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot; Multiplie tous les éléments d'un itérable par un 2.
&nbsp;
        Exemple :
&nbsp;
            &gt;&gt;&gt; list(doubled([1, 2, 3]))
            [2, 4, 6]
    &quot;&quot;&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> multiply<span style="color: black;">&#40;</span>iterable<span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>C&#8217;est une forme de currying. On créé une fonction qui fait ce que fait une autre fonction, mais avec des arguments par défaut.</p>
<p>Python possède une fonction pour faire ça automatiquement avec n&#8217;importe quelle fonction :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">from</span> functools <span style="color: #ff7700;font-weight:bold;">import</span> partial 
<span style="color: #66cc66;">&gt;&gt;&gt;</span> tripled <span style="color: #66cc66;">=</span> partial<span style="color: black;">&#40;</span>multiply<span style="color: #66cc66;">,</span> number<span style="color: #66cc66;">=</span><span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># on curryfie ici</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">list</span><span style="color: black;">&#40;</span>tripled<span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">3</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># nouvelle fonction avec un seul argument</span>
<span style="color: black;">&#91;</span><span style="color: #ff4500;">3</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">6</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">9</span><span style="color: black;">&#93;</span></pre></td></tr></table></div>

<p>Cela marche car, je vous le rappelle, les fonctions sont des objets en Python. On peut mettre une fonction (je ne parle pas de son résultat) dans une variable, passer une fonction en paramètre ou retourner une fonction dans une autre fonction. <strong>Les fonctions sont manipulables</strong>.</p>
<p>Il n&#8217;est pas rare d&#8217;utiliser les fonctions anonymes comme outils curryfication. En Python, on ferait ça avec une <a href="http://sametmax.com/fonctions-anonymes-en-python-ou-lambda/">lambda</a> :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> tripled <span style="color: #66cc66;">=</span> <span style="color: #ff7700;font-weight:bold;">lambda</span> x: multiple<span style="color: black;">&#40;</span>x<span style="color: #66cc66;">,</span> <span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span> 
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">list</span><span style="color: black;">&#40;</span>tripled<span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">3</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: black;">&#91;</span><span style="color: #ff4500;">3</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">6</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">9</span><span style="color: black;">&#93;</span></pre></td></tr></table></div>

<p>Certains outils, comme <a href="http://buzzdecafe.github.io/code/2014/05/16/introducing-ramda/">Ramda</a> en Javascript, vont plus loin, et exposent des fonctions qui se curryfient automatiquement.</p>
<p>Pour ce faire, il faut inverser l&#8217;ordre qu&#8217;on mettrait intuitivement aux arguments dans la déclaration d&#8217;une fonction :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #808080; font-style: italic;"># au lieu de multiply(iterable, number), on a :</span>
<span style="color: #ff7700;font-weight:bold;">def</span> multiply<span style="color: black;">&#40;</span>number<span style="color: #66cc66;">,</span> iterable<span style="color: #66cc66;">=</span><span style="color: #008000;">None</span><span style="color: black;">&#41;</span>:
    <span style="color: #808080; font-style: italic;"># Si on a pas d'itérable passé, on curryfie</span>
    <span style="color: #ff7700;font-weight:bold;">if</span> iterable <span style="color: #ff7700;font-weight:bold;">is</span> <span style="color: #008000;">None</span>:
        <span style="color: #ff7700;font-weight:bold;">return</span> partial<span style="color: black;">&#40;</span>multiply<span style="color: #66cc66;">,</span> number<span style="color: #66cc66;">=</span>number<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: black;">&#40;</span>x * number <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> iterable<span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Ainsi :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">list</span><span style="color: black;">&#40;</span>multiply<span style="color: black;">&#40;</span><span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span> <span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">3</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># pas de currying</span>
<span style="color: black;">&#91;</span><span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">4</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">6</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> quintuple <span style="color: #66cc66;">=</span> multiply<span style="color: black;">&#40;</span><span style="color: #ff4500;">5</span><span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># currying automatique</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">list</span><span style="color: black;">&#40;</span>quintuple<span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">3</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: black;">&#91;</span><span style="color: #ff4500;">5</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">10</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">15</span><span style="color: black;">&#93;</span></pre></td></tr></table></div>

<p>L’intérêt de ce style, c&#8217;est qu&#8217;on peut composer des traitements à partir de plusieurs sous traitements, presque déclarativement :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> remove<span style="color: black;">&#40;</span><span style="color: #008000;">filter</span><span style="color: #66cc66;">,</span> iterable<span style="color: #66cc66;">=</span><span style="color: #008000;">None</span><span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot; Retire tous les éléments d'un itérable correspondant au filtre.
&nbsp;
        Exemple :
&nbsp;
            &gt;&gt;&gt; list(remove(lambda x: x &gt;= 4, [1, 2, 3, 4, 5]))
            [1, 2, 3]
    &quot;&quot;&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">if</span> iterable <span style="color: #ff7700;font-weight:bold;">is</span> <span style="color: #008000;">None</span>:
        <span style="color: #ff7700;font-weight:bold;">return</span> partial<span style="color: black;">&#40;</span>remove<span style="color: #66cc66;">,</span> <span style="color: #008000;">filter</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: black;">&#40;</span>x <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> iterable <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #008000;">filter</span><span style="color: black;">&#40;</span>x<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #66cc66;">&gt;&gt;&gt;</span> smalls <span style="color: #66cc66;">=</span> remove<span style="color: black;">&#40;</span><span style="color: #ff7700;font-weight:bold;">lambda</span> x: x <span style="color: #66cc66;">&gt;=</span> <span style="color: #ff4500;">4</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">list</span><span style="color: black;">&#40;</span>smalls<span style="color: black;">&#40;</span>tripled<span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">3</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">4</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># le traitement est auto descriptif</span>
<span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">3</span><span style="color: black;">&#93;</span></pre></td></tr></table></div>

<p>Néanmoins, il faut savoir que ce style n&#8217;est pas pythonique. En effet, en Python on préférera généralement utiliser des suites suite de générateurs. Soit par <a href="http://sametmax.com/python-love-les-listes-en-intention-partie-2/">intention</a>, soit via <a href="http://sametmax.com/comment-utiliser-yield-et-les-generateurs-en-python/">yield</a>.</p>
<p>Notre exemple serait alors :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> tripled <span style="color: #66cc66;">=</span> <span style="color: black;">&#40;</span>x * <span style="color: #ff4500;">3</span> <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">3</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">4</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> smalls <span style="color: #66cc66;">=</span> <span style="color: black;">&#40;</span>x <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> tripled <span style="color: #ff7700;font-weight:bold;">if</span> x <span style="color: #66cc66;">&lt;=</span> <span style="color: #ff4500;">4</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">list</span><span style="color: black;">&#40;</span>smalls<span style="color: black;">&#41;</span>
<span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">3</span><span style="color: black;">&#93;</span></pre></td></tr></table></div>

<p>De plus, cette technique suppose qu&#8217;on ne profitera pas de certaines fonctionnalités, comme les paramètres par défaut des fonctions Python.</p>
<p>C&#8217;est toutefois une bonne chose à connaître. C&#8217;est occasionnellement utile en Python et peut produire des solutions très élégantes. C&#8217;est également une bonne chose à comprendre pour aborder d&#8217;autres langages plus fonctionnels qui les utilisent bien plus comme le Javascript, le Lisp, ou carrément le Haskell.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/introduction-au-currying/feed/</wfw:commentRss>
		<slash:comments>3</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2014/12/tumblr_n5zg0woqTQ1r539hzo1_500.jpg" length="68286" type="image/jpg" />	</item>
		<item>
		<title>AngularJS pour les utilisateurs de jQuery : partie 2 6</title>
		<link>http://sametmax.com/angularjs-pour-les-utilisateurs-de-jquery-partie-2/</link>
		<comments>http://sametmax.com/angularjs-pour-les-utilisateurs-de-jquery-partie-2/#comments</comments>
		<pubDate>Mon, 27 Oct 2014 06:53:27 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[angularjs]]></category>
		<category><![CDATA[javascript]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=12561</guid>
		<description><![CDATA[Après une intro sans trop de code, on va passer à du concret.]]></description>
				<content:encoded><![CDATA[<p>Après une intro sans trop de code, on va passer à du concret.</p>
<p><span class='embed-youtube' style='text-align:center; display: block;'><iframe class='youtube-player' type='text/html' width='1170' height='689' src='http://www.youtube.com/embed/6Kbv1OpIpaA?version=3&#038;rel=1&#038;fs=1&#038;showsearch=0&#038;showinfo=1&#038;iv_load_policy=1&#038;wmode=transparent' frameborder='0' allowfullscreen='true'></iframe></span></p>
<p>Pour apprivoiser la bête, on va comme d&#8217;habitude lui faire donner la patte et dire bonjour :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="html" style="font-family:monospace;">&lt;!doctype html&gt;
&lt;!-- Lien entre l'app et la page --&gt;
&lt;html ng-app=&quot;tuto&quot;&gt;
  &lt;head&gt;
    &lt;meta charset=&quot;utf-8&quot; /&gt;
    &lt;title&gt;Hello Angular&lt;/title&gt;
    &lt;script src=&quot;https://ajax.googleapis.com/ajax/libs/angularjs/1.2.26/angular.js&quot;&gt;&lt;/script&gt;
    &lt;script type=&quot;text/javascript&quot;&gt;
&nbsp;
    // Déclaration de l'app
    var app = angular.module('tuto', [])
&nbsp;
    // Lancement du code quand angular est prêt
    app.run(function(){
        alert('Hello !')
    })
&nbsp;
    &lt;/script&gt;
  &lt;/head&gt;
  &lt;body&gt;
  &lt;/body&gt;
&lt;/html&gt;</pre></td></tr></table></div>

<p>Pour comprendre ce snippet, il faut réaliser qu&#8217;Angular est d&#8217;abord et avant tout un moyen d&#8217;organiser son code, et qu&#8217;il vous incite à le séparer en conteneurs :</p>
<ul>
<li>Des modules, qu&#8217;on appelle aussi apps. Ce sont les boîtes qui contiennent les autres boîtes. L&#8217;équivalent des apps Django, en fait : on peut mettre tout le programme dedans, mais on peut aussi en faire une lib réutilisable.</li>
<li>Les providers : des fournisseurs de services. Tout le code métier est dedans.</li>
<li>Les directives : tout le code de manipulation du DOM est dedans.</li>
<li>Les contrôleurs : fait le lien entre le HTML et les données.</li>
</ul>
<p>Dans ce code, nous déclarons un module (ou app, c&#8217;est kif-kif) nommé &#8220;tuto&#8221; et n&#8217;ayant aucune dépendance (le second paramètre est un array vide) :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family:monospace;"><span style="color: #000066; font-weight: bold;">var</span> app <span style="color: #339933;">=</span> angular.<span style="color: #660066;">module</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'tuto'</span><span style="color: #339933;">,</span> <span style="color: #009900;">&#91;</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span></pre></td></tr></table></div>

<p>Les apps ne font pas grand chose. <strong>Ce sont de gros namespaces avec des dépendances</strong>, c&#8217;est à dire qui déclarent les autres apps nécessaires à leur fonctionnement. Par défaut, aucune autre app n&#8217;est obligatoire pour lancer notre code, donc on ne déclare aucune dépendance.</p>
<p>Il y a juste un piège qu&#8217;il faut connaître. Si je fais :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family:monospace;"><span style="color: #000066; font-weight: bold;">var</span> app <span style="color: #339933;">=</span> angular.<span style="color: #660066;">module</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'tuto'</span><span style="color: #009900;">&#41;</span></pre></td></tr></table></div>

<p>(notez l&#8217;absence de second paramètre)</p>
<p>Angular va tenter de me chercher la référence d&#8217;app du nom de &#8220;tuto&#8221; qui existe déjà. L&#8217;absence de dépendance se note donc avec un array vide, et non l&#8217;absence d&#8217;array. Subtilité piégeuse s&#8217;il en est. Vu qu&#8217;on n&#8217;aura pas besoin de déclarer de dépendances avant longtemps, inutile de vous crisper dessus, je vous l&#8217;indique juste pour le débuggage qui va immanquablement arriver le jour où vous oublierez l&#8217;array vide.</p>
<p>Ensuite, on fait le lien entre notre code HTML et l&#8217;app via :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="html" style="font-family:monospace;">&lt;html ng-app=&quot;tuto&quot;&gt;</pre></td></tr></table></div>

<p><code>ng-app</code> est ce qu&#8217;on appelle une directive. Toutes les directives préfixées <code>ng-</code> sont fournies avec le framework et déjà chargées, prêtes à être utilisées. Une directive est un bout de code Javascript appliqué à du HTML, dans ce cas précis via un attribut.</p>
<p>Vous vous souvenez dans les années 2000 comme on vous faisait chier avec le fait de ne pas mettre de Javascript inline dans du HTML ? Les directives, c&#8217;est du Javascript inline qui ne dit pas son nom.</p>
<p><strong>Chaque page doit être liée à une app, et une seule.</strong> Si on ne met pas <code>ng-app</code>, notre code ne se chargera pas, si on en met 2, ça foire. C&#8217;est le point d&#8217;entrée de notre code. Nous déclarons donc que cette page sera gérée par notre app &#8220;tuto&#8221;.</p>
<p>Puis lance notre hello tonitruant :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family:monospace;">    app.<span style="color: #660066;">run</span><span style="color: #009900;">&#40;</span><span style="color: #000066; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
        alert<span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'Hello !'</span><span style="color: #009900;">&#41;</span>
    <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span></pre></td></tr></table></div>

<p><code>app</code> est la variable contenant la référence à notre app, et en utilisant la méthode <code>.run</code>, on lui passe un <a href="http://sametmax.com/quest-ce-quun-callback/">callback</a> à appeler quand l&#8217;app sera prête.</p>
<p>Il y a plusieurs choses à réaliser ici :</p>
<ul>
<li>C&#8217;est un callback, donc le code de la fonction ne s&#8217;exécute pas tout de suite. Il sera lancé après l&#8217;initialisation de l&#8217;app.</li>
<li>C&#8217;est ce qu&#8217;il y a de plus proche du <code>$.ready</code> de jQuery.</li>
<li>On n&#8217;utilise presque jamais ce code avec Angular.</li>
</ul>
<p>Vous allez me dire, mais espèce de pignouf, pourquoi tu nous montres un code que personne n&#8217;utilise ?</p>
<p>Et bien parce que le titre du dossier est <em>AngularJS pour les utilisateurs de jQuery</em>, du coup je vous mets en terrain connu.</p>
<p>Mais la vérité, c&#8217;est qu&#8217;un vrai hello d&#8217;Angular ressemble à ça :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="html" style="font-family:monospace;">&lt;!doctype html&gt;
&lt;html ng-app=&quot;tuto&quot;&gt;
  &lt;head&gt;
    &lt;meta charset=&quot;utf-8&quot; /&gt;
    &lt;title&gt;Hello Angular&lt;/title&gt;
    &lt;script src=&quot;https://ajax.googleapis.com/ajax/libs/angularjs/1.2.26/angular.js&quot;&gt;&lt;/script&gt;
    &lt;script type=&quot;text/javascript&quot;&gt;
&nbsp;
    /* La je recréé l'app à chaque fois pour des raisons de praticité, mais
        dans un vrai code vous auriez ça dans un fichier à part, une seule
        fois */
    var app = angular.module('tuto', [])
&nbsp;
    // Création d'un controller, et attachement d'une variable au scope.
    app.controller('HelloCtrl', function($scope){
        // Attachement d'une donnée au scope
        $scope.hello = &quot;Hello&quot;
    })
&nbsp;
    &lt;/script&gt;
  &lt;/head&gt;
  &lt;body ng-controller=&quot;HelloCtrl&quot;&gt;
    &lt;!-- Affichage du message attaché au scope --&gt;
    &lt;h1&gt;{{ hello }}&lt;/h1&gt;
  &lt;/body&gt;
&lt;/html&gt;</pre></td></tr></table></div>

<p>Et là il y a beaucoup à dire.</p>
<p>Premièrement, contrairement à jQuery, il n&#8217;y a pas de notion de préparation du DOM. En vérité, on peut mettre son code Angular en vrac, et Angular va initialiser tout son monde dans le bon ordre, et exécuter ce qu&#8217;il faut au bon moment. Et ce bon moment est parfois avant que le DOM soit prêt.</p>
<p>Mais vous n&#8217;avez pas à vous en soucier.</p>
<p>Car avec Angular, on manipule très rarement le DOM. Très peu de <code>$('selecteur')</code>, <code>$node.bind()</code> et autre <code>$node.append()</code>, à part dans les directives.</p>
<p>La majorité de votre taf va être de définir des données en pur Javascript, de dire où elles vont dans la page, et de les manipuler en Javascript pendant qu&#8217;Angular s&#8217;occupe de mettre la page à jour automatiquement.</p>
<p>Nous avons pas mal de nouvelles notions ici. D&#8217;abord, le contrôleur&#8230;</p>
<p><strong>C&#8217;est un bout de code qu&#8217;on va lier à un bout de HTML</strong> via la directive <code>ng-controller</code> :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="html" style="font-family:monospace;">  &lt;body ng-controller=&quot;HelloCtrl&quot;&gt;
    ...
  &lt;/body&gt;</pre></td></tr></table></div>

<p>Le contrôleur va être responsable de mettre à disposition des données pour ce bout de HTML. On peut lier  autant de contrôleurs qu&#8217;on veut dans une page, et même les imbriquer. Ici, on dit que notre contrôleur <code>HelloCtrl</code> est responsable de mettre des données à disposition pour le tag <code>body</code> et tout ce qu&#8217;il contient.</p>
<p>On fait rarement des contrôleurs qui ratissent aussi large dans de vraies apps, mais pour notre exercice, c&#8217;est très bien.</p>
<p>Comment met-on à disposition des données ? Qu&#8217;est-ce que veut dire &#8220;mettre à disposition&#8221; ? Quelles données ?</p>
<p>Notre contrôleur ressemble à ceci :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="html" style="font-family:monospace;">    app.controller('HelloCtrl', function($scope){
        $scope.hello = &quot;Hello&quot;
    })</pre></td></tr></table></div>

<p>La fonction de callback sera exécutée quand <code>ng-controller="HelloCtrl"</code> sera activé automatiquement par Angular. Vous n&#8217;avez pas à vous souciez de quand, il le fera au moment le plus optimisé.</p>
<p>La seule chose dont vous avez à vous soucier, c&#8217;est ce que vous allez mettre dedans.</p>
<p>Et il y a ici deux nouvelles notions :</p>
<ul>
<li>L&#8217;injection de dépendances.</li>
<li>Le service (je vous explique ce qu&#8217;est un service plus loin) <code>$scope</code>.</li>
</ul>
<p>L&#8217;injection de dépendance fait partie de ces trucs qu&#8217;Angular fait automatiquement pour vous. Quand vous déclarez une variable dans le callback d&#8217;un contrôleur, Angular va chercher ce nom en mémoire, et récupérer le service qui porte ce nom. S&#8217;il ne le trouve pas, il plante.</p>
<p>Une fois qu&#8217;il a trouvé le service, il va attendre tranquillement le bon moment pour appeler le callback. Ce moment opportun arrivant, il va lui passer le service en paramètre. On dit qu&#8217;il lui &#8220;injecte&#8221; le service.</p>
<p>En relisant ces paragraphes, je réalise qu&#8217;il y a un mélange de plein de termes : contrôleurs, services, injection, bla, bla, bla.</p>
<p>Voilà le deal :</p>
<ol>
<li>Vous déclarez un contrôleur et vous le liez à du HTML via <code>ng-controller</code>.</li>
<li>Dans ce contrôleur vous dites &#8220;j&#8217;ai besoin du service Machin&#8221;</li>
<li>Angular cherche s&#8217;il connaît Machin. Si non, il plante.</li>
<li>Angular prépare le HTML, décide qu&#8217;il est prêt, appelle votre contrôleur et lui passe Machin en paramètre automatiquement.</li>
</ol>
<p>Les services sont justes des d&#8217;objets javascript ordinaires, qu&#8217;on a nommés d&#8217;une certaine manière pour qu&#8217;Angular puisse les injecter. C&#8217;est tout.</p>
<p>En effet, pour résoudre le problèmes d&#8217;espace de nom en Javascript et d&#8217;organisation d&#8217;une grosse application, les créateurs d&#8217;Angular on créé un grand registre. On enregistre notre code dedans sous un nom (<code>Angular.module('nom_de_l_app')</code>, <code>app.controller('nom_du_controller')</code>, etc.), et Angular récupère le bon code au bon moment. C&#8217;est essentiellement un moyen de pallier au fait que Javascript est dégueulasse.</p>
<p>Donc, plutôt que de faire des imports comme en Python, on va déclarer une variable en paramètre, et Angular injecte le bon objet pour vous. C&#8217;est bizarre, mais on s&#8217;habitue.</p>
<p>Du coup, là :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family:monospace;">app.<span style="color: #660066;">controller</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'HelloCtrl'</span><span style="color: #339933;">,</span> <span style="color: #000066; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>$scope<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span></pre></td></tr></table></div>

<p>Je dis &#8220;crée moi le contrôleur nommé &#8216;HelloCtrl&#8217;, et quand tu vas appeler le callback, passe lui l&#8217;objet nommé &#8216;$scope&#8217; en paramètre. Fais ça au bon moment, je m&#8217;en branle, je veux pas le savoir. Démmerde toi, on a tous des problèmes.&#8221;</p>
<p>Le résultat, c&#8217;est que votre fonction sera exécutée automatiquement au bon moment, et qu&#8217;elle aura <code>$scope</code> qui lui sera passé.</p>
<p>Alors à quoi sert ce <code>$scope</code> ?</p>
<p>C&#8217;est simple : tout ce qui est attaché en attribut de <code>$scope</code> est accessible dans le HTML géré par ce contrôleur. Quand je fais :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family:monospace;">    app.<span style="color: #660066;">controller</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'HelloCtrl'</span><span style="color: #339933;">,</span> <span style="color: #000066; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>$scope<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
        $scope.<span style="color: #660066;">hello</span> <span style="color: #339933;">=</span> <span style="color: #3366CC;">&quot;Hello&quot;</span>
    <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span></pre></td></tr></table></div>

<p>Et que après je lie mon contrôleur au HTML :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="html" style="font-family:monospace;">  &lt;body ng-controller=&quot;HelloCtrl&quot;&gt;
    &lt;!-- Affichage du message attaché au scope --&gt;
    &lt;h1&gt;{{ hello }}&lt;/h1&gt;
  &lt;/body&gt;</pre></td></tr></table></div>

<p>Ma variable <code>hello</code> est disponible ici (via les petites moustaches qu&#8217;on verra au prochain chapitre), parce que je suis dans <code>body</code> qui est géré par le contrôleur <code>HelloCtrl</code> qui contient un <code>$scope</code> avec l&#8217;attribut <code>hello</code>. Fiou ! Ca en fait des couches. Mais Angular, c&#8217;est comme <del>un orgre</del> un onion.</p>
<p>Vous touchez ici du doigt l&#8217;essence même du boulot des contrôleurs, et à peu près leur unique but : mettre des données à disposition du HTML. C&#8217;est le C de <a href="http://sametmax.com/quest-de-que-mvc-et-a-quoi-ca-sert/">MVC</a>.</p>
<p>C&#8217;est pour cette raison que je vous ai répété &#8220;Angular va tout faire au bon moment, vous n&#8217;avez pas à vous soucier de quand&#8221;. Ceci est en effet très frustrant à entendre quand on vient du monde de jQuery puisque qu&#8217;on doit savoir exactement quand on fait les choses : il faut que le DOM soit prêt, il faut que les éléments sur lesquels on travaille existent, il faut qu&#8217;on puisse récupérer des nodes et en ajouter.</p>
<p>Avec Angular, on ne fait rien de tout ça. On va déclarer ses données dans le contrôleur, et dire où elles doivent être mises dans la page. Angular se charge de faire le lien pour vous quand le HTML est prêt, quand le Javascript est chargé, quand les Dieux sont avec vous&#8230;</p>
<hr />
<a href="https://github.com/sametmax/codes-des-articles/tree/master/2014/octobre"><br />
Télécharger le code de l&#8217;article.</a></p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/angularjs-pour-les-utilisateurs-de-jquery-partie-2/feed/</wfw:commentRss>
		<slash:comments>6</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2014/10/index.jpeg" length="8147" type="image/jpg" />	</item>
		<item>
		<title>Servir des fichiers statiques avec nginx 10</title>
		<link>http://sametmax.com/servir-des-fichiers-statiques-avec-nginx/</link>
		<comments>http://sametmax.com/servir-des-fichiers-statiques-avec-nginx/#comments</comments>
		<pubDate>Thu, 23 Oct 2014 06:20:02 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[css]]></category>
		<category><![CDATA[javascript]]></category>
		<category><![CDATA[nginx]]></category>
		<category><![CDATA[static]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=10490</guid>
		<description><![CDATA[C'est un truc donc j'ai tout le temps besoin, alors l'article servira de pense bête. ]]></description>
				<content:encoded><![CDATA[<p>C&#8217;est un truc dont j&#8217;ai tout le temps besoin, alors l&#8217;article servira de pense bête. Marre de chercher à chaque fois :</p>
<pre>
        # sur django, on met tout dans /static/, donc par habitude je le fais
        # pour tout
        location /static/ {

            # Le dossier doit contenir le dossier 'static'. Par exemple si votre
            # arbo est /home/sametmax/repo/static, le chemin sera
            # /home/sametmax/repo. Rassurez-vous, personne n'aura accès aux
            # autres sous dossiers de "repo".
            root  /chemin/absolu/vers/dossier/;

            # On active la compression
            gzip  on;
            gzip_http_version 1.0;
            gzip_vary on;
            gzip_comp_level 6;
            gzip_proxied any;
            gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;
            gzip_buffers 16 8k;

            # Sauf pour les vieux nav
            gzip_disable ~@~\MSIE [1-6].(?!.*SV1)~@~];

            # On dit au navigateur de le mettre en cache pour 3 mois. Faites gaffe,
            # mettez un param dans les url de vos balises script/link qui change
            # à chaque version du fichier, sinon vous ne pourrez pas mettre à jour
            # vos fichiers.
            expires modified +90d;
        }
</pre>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/servir-des-fichiers-statiques-avec-nginx/feed/</wfw:commentRss>
		<slash:comments>10</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2014/10/81RMYJLMA-L__AA1500_.jpg" length="204738" type="image/jpg" />	</item>
		<item>
		<title>AngularJS pour les utilisateurs de jQuery : partie 1 31</title>
		<link>http://sametmax.com/angularjs-pour-les-utilisateurs-de-jquery-partie-1/</link>
		<comments>http://sametmax.com/angularjs-pour-les-utilisateurs-de-jquery-partie-1/#comments</comments>
		<pubDate>Tue, 02 Sep 2014 09:55:36 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[angularjs]]></category>
		<category><![CDATA[javascript]]></category>
		<category><![CDATA[meh]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=12170</guid>
		<description><![CDATA[Angular rend l'utilisation de JS plus supportable, mais possède une très grosse courbe d'apprentissage bien pentue, avec des ressources vraiment mal foutues.]]></description>
				<content:encoded><![CDATA[<p>Après avoir sondé un peu Twitter, le sujet intéresse, et il est très, mais alors, très mal traité ailleurs sur le net. Malgré mon aversion, <a href="http://sametmax.com/un-gros-troll-de-plus-sur-javacscript/">bien connue</a>, pour javascript, je m&#8217;en bouffe beaucoup, prog Web oblige.</p>
<p>Angular rend l&#8217;utilisation de JS plus supportable, mais possède une très grosse courbe d&#8217;apprentissage bien pentue, avec des ressources vraiment mal foutues.</p>
<p>Et surtout, le problème vient de l&#8217;habitude de jQuery.</p>
<p>AngularJS est l&#8217;anti-jQuery, ça ne fonctionne pas du tout pareil, mais personne n&#8217;est là pour vous montrer comment faire la transition. Ce sera le but de ce dossier, un dossier qui va être long car ce framework est un gros morceau.</p>
<h2>Quand utiliser AngularJS ?</h2>
<p>Tous les sites ne sont pas faits pour être créés avec Angular. En effet, si votre site est essentiellement composé de contenu statique, avec juste un peu de dynamique pour quelques widgets, Angular n&#8217;a aucun intérêt.</p>
<p>Angular est lourd à mettre en œuvre, on va donc se faire chier à sortir le bazooka quand on monte au front, pas quand on fait une garde de nuit en rase campagne.</p>
<p>Malgré le fait que Google interprète maintenant les pages en JS, le texte reste roi, et Angular vous force à faire des pages en pur JS, rendant le référencement aléatoire de votre contenu. Les hacks que l&#8217;on voit un peu partout sur la toile pour compenser cela sont très loin d&#8217;obtenir l&#8217;effet d&#8217;un référencement naturel de contenu facilement accessible à l&#8217;ancienne.</p>
<p>En fait, le plus gros défaut d&#8217;Angular, c&#8217;est qu&#8217;il ne permet pas, pour le moment, de faire de la dégradation gracieuse. Soit le mec a Javascript et il a accès au site. Soit le site est illisible.</p>
<p>jQuery a donc encore de beaux jours devant lui.</p>
<p>Typiquement, on ne prendra pas Angular pour :</p>
<ul>
<li>La partie publique d&#8217;un blog de type WordPress.</li>
<li>Un wiki type Wikipédia.</li>
<li>Un forum ou site collaboratif.</li>
<li>Un tube vidéo.</li>
</ul>
<p>Ce sont des sites dont le contenu est important. On veut que les moteurs de recherche puisse les indexer de fond en comble. On veut que ce soit lisible sans JS et par les aveugles (sauf le tube vidéo :-D). Les ajouts de JS se feront par petites touches.</p>
<p>On utilisera plutôt Angular pour :</p>
<ul>
<li>Une app grand public.</li>
<li>La partie admin d&#8217;un blog.</li>
<li>Un logiciel d&#8217;entreprise.</li>
<li>Un réseau social.</li>
</ul>
<p>Ce sont des sites pour lesquels l&#8217;ergonomie est plus importante que le contenu. Le public est captif, et on peut exiger Javascript, prix à payer pour une expérience utilisateur moderne.</p>
<p>Vous noterez qu&#8217;il y a une certaine opposition entre vieux format (wiki, forum, blog) et format contemporain (app, réseau social). Ce n&#8217;est pas un hasard. Les premiers sont orientés contenu, les seconds orientés usage. C&#8217;est ainsi que le Web a évolué, et Angular est là exactement pour répondre à cette évolution.</p>
<p>Il est néanmoins tout à fait possible de faire des choses hybrides. Rien n&#8217;empêche de faire des parties du sites statiques, et d&#8217;autres très dynamiques, de mélanger les deux sur une même page. Par exemple, sur un blog, vous pouvez mettre l&#8217;article en statique pour le ref et la facilité de consultation, et la partie commentaires en Angular, pour améliorer l&#8217;expérience utilisateur.</p>
<h2>Que va apporter Angular ?</h2>
<p>Les avantages sont doubles.</p>
<p>D&#8217;abords, il y a les avantages pour vous, le développeur. Angular vous force en effet à utiliser un style Javascript très propre qui tend à découpler les composants, isoler les services, lisser les angles et refaire le papier peint à fleur. L&#8217;application en devient plus propre, plus facile à faire évoluer et à maintenir. Toutes les bonnes pratiques d&#8217;organisation d&#8217;une app JS ont une réponse angularesque. Ce n&#8217;est pas forcément celle que vous voulez, mais elle marche.</p>
<p>Ensuite, Angular va vous rendre plus productif. Pas tout de suite, évidement, coincés que vous êtes dans votre logique jQuerinne. Mais une fois le cap passé, coder beaucoup de JS sera immensément plus simple et plus rapide, car Angular vous épargne beaucoup de logique répétitive.</p>
<p>En prime, ce framework est orienté tests. Ce n&#8217;est pas obligatoire, mais c&#8217;est bien plus facile qu&#8217;avec des modules jQuery.</p>
<p>Mais il y a également les avantages pour l&#8217;utilisateur. Puisque qu&#8217;Angular est complètement dynamique, il bénéficiera automatiquement d&#8217;une app plus réactive, avec moins de rechargements, plus de fonctionnalités aussi. En effet, vous rechignerez moins à rajouter cette fonction &#8220;delete-row&#8221; si vous savez que ça vous prend 3 lignes de code.</p>
<p>Attention cependant, il y a aussi des inconvénients.</p>
<p>Angular est lourd, c&#8217;est long à charger, ça bouffe de la ressource pour chaque tab, et si vous avez beaucoup de traitements sur une page, vous avez intérêt à optimiser votre race le bouzin sinon ça va ramer. Tout le monde n&#8217;est pas sur une machine de dev propre à 8 cœurs avec une ligne ADSL qui a tout compris.</p>
<p>En fait, si votre site est destiné à être consulté ainsi : je cherche, je consulte du contenu, et je m&#8217;en vais, charger Angular est un pur gâchis. Il faut au moins que l&#8217;on interagisse un peu avec le site pour que ça vaille le coup : créer du contenu, manipuler des informations, se faire notifier, etc.</p>
<p>Et puis il y a la tentation, la tentation forte de tout faire à la main côté client. Avec son lot de problèmes de sécurité (le delete qui fait pas de vérif), de merdier dans l&#8217;histo de navigation (le clic du milieu qui marche pas, le back qui back pas où on veut), les sessions qui font des siennes (je suis déco, mais y mon avartar là, pourquoi ?), etc.</p>
<p>Angular n&#8217;est pas une solution pour le bidouilleur Javascript de devenir soudainement grand programmeur Web, et ne dispense pas de coder correctement.</p>
<h2>Si je fais de l&#8217;Angular, je dois faire du NodeJS ?</h2>
<p>Non.</p>
<p>Angular est une techno parfaitement neutre, elle est limitée au client, et par conséquent, vous êtes libres de choisir votre techno côté serveur : .Net, PHP, Ruby, Java, Python&#8230;</p>
<p>Par contre, pour les tests, les outils sont très orientés autour de l&#8217;écosystème NodeJS : npm, grunt, PhantomJS, etc. Il va falloir mettre les mains dans le cambouis, avec son lot de trucs qui s&#8217;installent pas, de dépendances mal branlées, de doc pas à jour, de code JS peu expressif et tout le bordel. C&#8217;est tout le problème du JS, la communauté a gardé le côté crade et à l&#8217;arrache du langage. Heureusement, ils ont récupéré les designers du monde Ruby, donc vous aurez des tutos obsolètes, mais très jolis.</p>
<h2>Ok, mais je peux faire quoi avec ?</h2>
<p>Car finalement, quand on n&#8217;a pas utilisé Angular, on se demande finalement qu&#8217;est-ce que ça apporte par rapport à jQuery.</p>
<p>Essentiellement, c&#8217;est que ça divise par 100 les manipulations du DOM. Avec Angular, on met ses données dans un tableau d&#8217;objets JS, on indique où les afficher, et on manipule ensuite notre array. Le DOM est mis à jour sans qu&#8217;on doive s&#8217;en soucier.</p>
<p>Ça à l&#8217;air de rien comme ça, mais si vous ouvrez vos fichiers JS avec jQuery, vous verrez qu&#8217;ils sont blindés de <code>.click()</code>code et de <code>.append()</code>. C&#8217;est la majorité du code ! Code qu&#8217;on a pas besoin d&#8217;écrire avec Angular.</p>
<p>L&#8217;organisation d&#8217;Angular invite aussi naturellement à écrire un code linéaire. Pas de blocs dans des blocs dans des blocs, chaînes de callbacks et amas de closures. Il y en a toujours, mais bien moins.</p>
<p>Après, on fait finalement la même chose qu&#8217;on ferait avec jQuery, mais plus facilement. Ce qui explique qu&#8217;on fait rarement une app full JS avec jQuery, ce qui est infernal à coder, alors qu&#8217;on le fait systématiquement avec Angular, car c&#8217;est son milieu naturel.</p>
<p>Ce qui va vous surprendre avec cette façon de faire, c&#8217;est que tout ce qui s&#8217;affiche dans la page passe par Angular. En fait, on a généralement une API REST, et Angular en front pour afficher le site. Pas trop de templating côté serveur.</p>
<p>Et on verra des exemples concrets de tout ça dans <a href="http://sametmax.com/angularjs-pour-les-utilisateurs-de-jquery-partie-2/">les parties suivantes</a> :)</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/angularjs-pour-les-utilisateurs-de-jquery-partie-1/feed/</wfw:commentRss>
		<slash:comments>31</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2014/09/FaeriesAireandDeathWaltz1.gif" length="724555" type="image/jpg" />	</item>
		<item>
		<title>Rendre un élément scrollable avec Angular 8</title>
		<link>http://sametmax.com/rendre-un-element-scrollable-avec-angular/</link>
		<comments>http://sametmax.com/rendre-un-element-scrollable-avec-angular/#comments</comments>
		<pubDate>Tue, 01 Jul 2014 09:30:20 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[angularjs]]></category>
		<category><![CDATA[javascript]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=11240</guid>
		<description><![CDATA[Petit snippet que j'utilise dans mes apps angular. Ça permet de définir un comportement quand l'utilisateur scroll au dessus d'un élément. Typiquement, augmenter la valeur d'un champ, faire défiler un carousel, etc. Il faut, bien entendu, éviter que la page scroll elle-même.]]></description>
				<content:encoded><![CDATA[<p>Petit snippet que j&#8217;utilise dans mes apps angular. Ça permet de définir un comportement quand l&#8217;utilisateur scrolle au-dessus d&#8217;un élément. Typiquement, augmenter la valeur d&#8217;un champ, faire défiler un carousel, etc. Il faut, bien entendu, éviter que la page scrolle elle-même.</p>
<h2>Implémentation</h2>

<div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family:monospace;">app.<span style="color: #660066;">directive</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'wheelable'</span><span style="color: #339933;">,</span> <span style="color: #000066; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
<span style="color: #3366CC;">&quot;use strict&quot;</span><span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #006600; font-style: italic;">/* On définit sur quels attributs on va mettre les callbacks */</span>
  <span style="color: #000066; font-weight: bold;">var</span> directive <span style="color: #339933;">=</span> <span style="color: #009900;">&#123;</span>
      scope<span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span>
          <span style="color: #3366CC;">'onWheelUp'</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">'&amp;onwheelup'</span><span style="color: #339933;">,</span>
          <span style="color: #3366CC;">'onWheelDown'</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">'&amp;onwheeldown'</span>
      <span style="color: #009900;">&#125;</span>
  <span style="color: #009900;">&#125;</span><span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #006600; font-style: italic;">/* On limite la directive aux attributs */</span>
  directive.<span style="color: #660066;">restrict</span> <span style="color: #339933;">=</span> <span style="color: #3366CC;">'A'</span><span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #006600; font-style: italic;">/* Le code qu'active la directive quand on la pose sur l'élément */</span>
  directive.<span style="color: #660066;">link</span> <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>$scope<span style="color: #339933;">,</span> element<span style="color: #339933;">,</span> attributes<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
&nbsp;
      <span style="color: #006600; font-style: italic;">/* On attache un callback à tous les événements de scrolling */</span>
      element.<span style="color: #660066;">bind</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'mousewheel wheel'</span><span style="color: #339933;">,</span> <span style="color: #000066; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>e<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
&nbsp;
        <span style="color: #006600; font-style: italic;">/* On vérifie si l'utilisateur scroll up ou down */</span>
        <span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>e.<span style="color: #660066;">originalEvent</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
          e <span style="color: #339933;">=</span> e.<span style="color: #660066;">originalEvent</span><span style="color: #339933;">;</span>
        <span style="color: #009900;">&#125;</span>
        <span style="color: #000066; font-weight: bold;">var</span> delta <span style="color: #339933;">=</span> <span style="color: #009900;">&#40;</span>e.<span style="color: #660066;">wheelDelta</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">?</span> e.<span style="color: #660066;">wheelDelta</span> <span style="color: #339933;">:</span> <span style="color: #339933;">-</span>e.<span style="color: #660066;">deltaY</span><span style="color: #339933;">;</span>
        <span style="color: #000066; font-weight: bold;">var</span> isScrollingUp <span style="color: #339933;">=</span> <span style="color: #009900;">&#40;</span>e.<span style="color: #660066;">detail</span> <span style="color: #339933;">||</span> delta <span style="color: #339933;">&gt;</span> <span style="color: #CC0000;">0</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
        <span style="color: #006600; font-style: italic;">/* On appelle le bon callback utilisateur */</span>
        <span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>isScrollingUp<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
          $scope.$apply<span style="color: #009900;">&#40;</span>$scope.<span style="color: #660066;">onWheelUp</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #009900;">&#125;</span> <span style="color: #000066; font-weight: bold;">else</span> <span style="color: #009900;">&#123;</span>
          $scope.$apply<span style="color: #009900;">&#40;</span>$scope.<span style="color: #660066;">onWheelDown</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #009900;">&#125;</span>
&nbsp;
        <span style="color: #006600; font-style: italic;">/* On évite que la page scrolle */</span>
        e.<span style="color: #660066;">preventDefault</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
      <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span><span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #000066; font-weight: bold;">return</span> directive<span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre></td></tr></table></div>

<h2>Usage</h2>
<p>Comme pour toutes les directives qui impliquent des callbacks, il faut définir des fonctions et les attacher à votre scope dans un controleur (ou un service attaché au controleur) :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family:monospace;">app.<span style="color: #660066;">controller</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'FooCtrl'</span><span style="color: #339933;">,</span> <span style="color: #000066; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>$scope<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
<span style="color: #3366CC;">&quot;use strict&quot;</span><span style="color: #339933;">;</span>
  $scope.<span style="color: #660066;">votreCallBackPourQuandCaScrollDown</span> <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
    <span style="color: #006600; font-style: italic;">// faire un truc par exemple moi je l'utilise pour changer</span>
    <span style="color: #006600; font-style: italic;">// la valeur de l'élément.</span>
  <span style="color: #009900;">&#125;</span><span style="color: #339933;">;</span>
  $scope.<span style="color: #660066;">votreCallBackPourQuandCaScrollDown</span> <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
    <span style="color: #006600; font-style: italic;">// faire un autre truc</span>
  <span style="color: #009900;">&#125;</span><span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre></td></tr></table></div>

<p>La directive s&#8217;utilise en mettant l&#8217;attribut <code>wheelable</code> sur l&#8217;élément qu&#8217;on veut rendre scrollable. Ensuite on déclare dans les attributs <code>onwheeldown</code> et <code>onwheelup</code> le code à exécuter, et zou :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="html" style="font-family:monospace;">&lt;div ng-controller=&quot;FooCtrl&quot;&gt;
  ...
  &lt;input type=&quot;text&quot; wheelable
         onwheeldown=&quot;votreCallBackPourQuandCaScrollDown()&quot;
         onwheelup=&quot;votreCallBackPourQuandCaScrollUp()&quot;
         &gt;
  ...
&lt;/div&gt;</pre></td></tr></table></div>

]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/rendre-un-element-scrollable-avec-angular/feed/</wfw:commentRss>
		<slash:comments>8</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2014/07/R36fqO3.gif" length="272833" type="image/jpg" />	</item>
		<item>
		<title>Petite démo pragmatique d&#8217;un usage de WAMP en Python 47</title>
		<link>http://sametmax.com/introduction-a-wamp-en-python/</link>
		<comments>http://sametmax.com/introduction-a-wamp-en-python/#comments</comments>
		<pubDate>Thu, 26 Jun 2014 07:27:03 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[autobahn]]></category>
		<category><![CDATA[crossbar]]></category>
		<category><![CDATA[javascript]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[wamp]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=11146</guid>
		<description><![CDATA[Vu que dernièrement je vous ai bien gavé avec WAMP, ça mérite un tuto non ?]]></description>
				<content:encoded><![CDATA[<p><em>L&#8217;API a changé depuis, j&#8217;ai donc mis à jour l&#8217;article pour refléter ces changements</em></p>
<p>Vu que dernièrement je vous ai bien gavé avec <a href="http://sametmax.com/crossbar-le-futur-des-applications-web-python/">WAMP</a>, ça mérite un tuto non ?</p>
<p>Il se trouve que l&#8217;équipe derrière WAMP a publié plus tôt que prévu une version de leurs libs contenant l&#8217;API flaskesque sur laquelle on bosse. L&#8217;idée est que même si on n&#8217;a pas encore les tests unitaires, on peut déjà jouer avec.</p>
<p>Maintenant il me fallait un projet sexy, histoire de donner envie. Donc j&#8217;ai fouillé dans ce qui se faisait côté temps réel (essentiellement du NodeJS et du Tornado, mais pas que) pour trouver l&#8217;inspiration.</p>
<p>Et j&#8217;ai trouvé un truc très sympa : <a href="http://news.softpedia.com/news/YouTube-Will-Turn-Your-Phone-into-a-Smart-TV-Remote-318286.shtml">un player vidéo piloté à distance.</a></p>
<p>En effet, n&#8217;est-il pas chiant de regarder une vidéo en ligne sur son ordi posé sur la commode pendant qu&#8217;on est enfoncé dans le canap ? Si on veut faire pause ou changer le son, il faut se lever, arg.</p>
<p>Les problèmes du tiers monde, c&#8217;est du pipi de chat à côté. Ils ont de la chance, eux, ils ne connaissent pas le streaming.</p>
<p><strong>Voici donc le projet : </strong></p>
<p>Une page avec un player HTML 5 et un QR code.</p>
<div id="attachment_11151" style="width: 335px" class="wp-caption aligncenter"><a href="http://sametmax.com/wp-content/uploads/2014/06/video.png" class="grouped_elements" rel="tc-fancybox-group11146"><img class="size-full wp-image-11151" title="Pour simplifier la démo, on peut cliquer sur le QR code est avoir la télécommande dans un autre tab pour ceux qui n'ont pas de smartphone ou d'app de scan de QRCode." src="http://sametmax.com/wp-content/uploads/2014/06/video.png" alt="Capture d'écran de la démo, côté player" width="325" height="186" /></a><p class="wp-caption-text">Pour simplifier la démo, on peut cliquer sur le QR code et avoir la télécommande dans un autre tab pour ceux qui n&#8217;ont pas de smartphone ou d&#8217;app de scan de QRCode.</p></div>
<p>Si on scanne le QR code avec son téléphone, il vous envoie sur une page avec une télécommande pour contrôler le player sans bouger votre cul :</p>
<div id="attachment_11152" style="width: 306px" class="wp-caption aligncenter"><a href="http://sametmax.com/wp-content/uploads/2014/06/controles.png" class="grouped_elements" rel="tc-fancybox-group11146"><img class="size-full wp-image-11152" title="Évidement, c'est basique. Je vais pas m'amuser à faire un produit complet juste pour un truc dont le code source ne sera même pas regardé par la plupart d'entre vous. Je vous connais, bandes de feignasses !" src="http://sametmax.com/wp-content/uploads/2014/06/controles.png" alt="Capture d'écrand de la démo, côté contrôles" width="296" height="370" /></a><p class="wp-caption-text">Évidement, c&#8217;est basique. Je vais pas m&#8217;amuser à faire un produit complet juste pour un truc dont le code source ne sera même pas regardé par la plupart d&#8217;entre vous. Je vous connais, bandes de feignasses !</p></div>
<p>Et vous allez voir, c&#8217;est même pas dur à faire.</p>
<p>Démo en ligne:</p>
<p style="margin: 1em; text-align: center;"><a style="font-size: 2em;" href="https://demo.crossbar.io/videocontrol/">La démo</a></p>
<p><a href="https://github.com/sametmax/codes-des-articles/tree/master/2014/juin/video_remote">Vous pouvez télécharger le code ici</a>.</p>
<p>Pour comprendre ce qui va suivre, il va vous falloir les bases en prog Javascript et Python, ainsi que bien comprendre la notion de <a href="http://sametmax.com/quest-ce-quun-callback/">callback</a>. Être à l&#8217;aise avec <a href="http://sametmax.com/deferred-future-et-promise-le-pourquoi-le-comment-et-quand-est-ce-quon-mange">promises</a> peut aider.</p>
<p>Et pour bien digérer ce paté, rien ne vaut un peu de son :</p>
<p><span class='embed-youtube' style='text-align:center; display: block;'><iframe class='youtube-player' type='text/html' width='1170' height='689' src='http://www.youtube.com/embed/FU4cnelEdi4?version=3&#038;rel=1&#038;fs=1&#038;showsearch=0&#038;showinfo=1&#038;iv_load_policy=1&#038;wmode=transparent' frameborder='0' allowfullscreen='true'></iframe></span></p>
<h2>Le Chteumeuleu</h2>
<p>Il va nous falloir deux pages Web, une pour le player vidéo, et une pour la télécommande.</p>
<p>Le player :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="html" style="font-family:monospace;">&nbsp;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
   &lt;title&gt;Video&lt;/title&gt;
   &lt;meta charset='utf-8'&gt;
   &lt;!-- Chargement des dépendances : autobahn pour WAMP
   et qrcode pour générer le QR code. Bien entendu, je
   vous invite à ne pas les hotlinker dans vos projets,
   mais pour la démo c'est plus simple. --&gt;
   &lt;script src=&quot;https://autobahn.s3.amazonaws.com/autobahnjs/latest/autobahn.min.jgz&quot;
           type=&quot;text/javascript&quot;&gt;&lt;/script&gt;
   &lt;script src=&quot;http://davidshimjs.github.com/qrcodejs/qrcode.min.js&quot;
           type=&quot;text/javascript&quot;&gt;&lt;/script&gt;
&nbsp;
   &lt;style type=&quot;text/css&quot;&gt;
      #vid {
         /* Taille de la video */
         width:427px;
         height:240px;
      }
      /* Centrage avec la méthode Rache */
      #container {
          width:427px;
          margin:auto;
      }
      #ctrllink {
          display:block;
          width:256px;
          margin:auto;
      }
   &lt;/style&gt;
&nbsp;
&lt;/head&gt;
&lt;body&gt;
&lt;div id=&quot;container&quot;&gt;
  &lt;p&gt;
&nbsp;
   &lt;!-- Pareil, je hotlink la video, mais ne faites pas ça
   à la maison les enfants. Surtout que les perfs du
   serveur du W3C sont merdiques et ça bufferise à mort. --&gt;
    &lt;video id=&quot;vid&quot;
           class=&quot;video-js vjs-default-skin&quot;
           controls preload=&quot;auto&quot;
           poster=&quot;http://media.w3.org/2010/05/sintel/poster.png&quot; &gt;
    &lt;source id='ogv'
      src=&quot;http://media.w3.org/2010/05/sintel/trailer.ogv&quot;
      type='video/ogg'&gt;
    &lt;source id='mp4'
      src=&quot;http://media.w3.org/2010/05/sintel/trailer.mp4&quot;
      type='video/mp4'&gt;
    &lt;source id='webm'
      src=&quot;http://media.w3.org/2010/05/sintel/trailer.webm&quot;
      type='video/webm'&gt;
    &lt;/video&gt;
  &lt;/p&gt;
  &lt;p&gt;
    &lt;a id=&quot;ctrllink&quot; href=&quot;#&quot; target=&quot;_blank&quot;&gt;
      &lt;span id=&quot;qrcode&quot;&gt;&lt;/span&gt;
    &lt;/a&gt;
  &lt;/p&gt;
 &lt;/div&gt;
&nbsp;
&lt;/body&gt;</pre></td></tr></table></div>

<p>Et la télécommande :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="html" style="font-family:monospace;">&nbsp;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;title&gt;Télécommande&lt;/title&gt;
  &lt;meta charset='utf-8'&gt;
  &lt;script src=&quot;https://autobahn.s3.amazonaws.com/autobahnjs/latest/autobahn.min.jgz&quot;
         type=&quot;text/javascript&quot;&gt;&lt;/script&gt;
  &lt;!-- Zoom du viewport sur mobile pour éviter d'avoir
       à le faire à la main. --&gt;
  &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;&gt;
  &lt;style type=&quot;text/css&quot;&gt;
    #controls {
      width:350px;
      margin:auto;
    }
    #controls button {
      font-size: 1em;
    }
    #controls input {
      vertical-align:middle;
       width: 200px;
       height:20px;
   }
  &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;p id=&quot;controls&quot;&gt;
    &lt;!-- Marrant de se dire qu'en 2000, le JS inline était
         considéré comme démoniaque, et maintenant avec
         angularjs et cie, c'est exactement ce que tout
         le monde fait...
         Bref, on attache le clic sur nos contrôles à des
         méthodes de notre objet qui va se charger de la
         logique. --&gt;
&nbsp;
    &lt;button id=&quot;play&quot; onclick=&quot;control.togglePlay()&quot;&gt;Play&lt;/button&gt;
    &lt;input id=&quot;volume&quot;
                    onchange=&quot;control.volume(this.value)&quot;
                    type=&quot;range&quot;&gt;
  &lt;/p&gt;
&lt;/body&gt;</pre></td></tr></table></div>

<p>Rien d&#8217;incroyable. C&#8217;est du HTML, un peu de CSS, on charge les dépendances en JS. Classique.</p>
<p>Vu qu&#8217;on utilise des ressources hotlinkées par souci de simplicité, <strong>il vous faudra être connecté à Internet.</strong></p>
<h2>Setup du routeur</h2>
<p>On va travailler avec Python 2.7 puisque Crossbar.io est uniquement en 2.7 et que je n&#8217;ai pas envie de vous faire installer deux versions de Python juste pour le tuto.</p>
<p>Il nous faut avant tout un serveur HTTP pour servir les fichiers HTML et un routeur WAMP. On installe donc Crossbar.io :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">pip <span style="color: #c20cb9; font-weight: bold;">install</span> crossbar</pre></td></tr></table></div>

<p>Ca va aussi installer autobahn, twisted et tout le bordel.</p>
<p>On va ensuite dans le dossier qui contient ses fichiers HTML, et on créé le fichier de config de Crossbar.io avec un petit :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">crossbar init</pre></td></tr></table></div>

<p>Vous noterez la création d&#8217;un dossier <code>.crossbar</code> qui contient un fichier <code>config.json</code>. C&#8217;est la config de crossbar. <strong>Videz moi ce fichier</strong>, on va le remplir avec notre config :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family:monospace;"><span style="color: #009900;">&#123;</span>
   <span style="color: #3366CC;">&quot;workers&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#91;</span>
      <span style="color: #009900;">&#123;</span>
         <span style="color: #3366CC;">&quot;type&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;router&quot;</span><span style="color: #339933;">,</span>
         <span style="color: #3366CC;">&quot;realms&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#91;</span>
            <span style="color: #009900;">&#123;</span>
               <span style="color: #3366CC;">&quot;name&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;realm1&quot;</span><span style="color: #339933;">,</span>
               <span style="color: #3366CC;">&quot;roles&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#91;</span>
                  <span style="color: #009900;">&#123;</span>
                     <span style="color: #3366CC;">&quot;name&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;anonymous&quot;</span><span style="color: #339933;">,</span>
                     <span style="color: #3366CC;">&quot;permissions&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#91;</span>
                        <span style="color: #009900;">&#123;</span>
                           <span style="color: #3366CC;">&quot;uri&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;*&quot;</span><span style="color: #339933;">,</span>
                           <span style="color: #3366CC;">&quot;publish&quot;</span><span style="color: #339933;">:</span> <span style="color: #003366; font-weight: bold;">true</span><span style="color: #339933;">,</span>
                           <span style="color: #3366CC;">&quot;subscribe&quot;</span><span style="color: #339933;">:</span> <span style="color: #003366; font-weight: bold;">true</span><span style="color: #339933;">,</span>
                           <span style="color: #3366CC;">&quot;call&quot;</span><span style="color: #339933;">:</span> <span style="color: #003366; font-weight: bold;">true</span><span style="color: #339933;">,</span>
                           <span style="color: #3366CC;">&quot;register&quot;</span><span style="color: #339933;">:</span> <span style="color: #003366; font-weight: bold;">true</span>
                        <span style="color: #009900;">&#125;</span>
                     <span style="color: #009900;">&#93;</span>
                  <span style="color: #009900;">&#125;</span>
               <span style="color: #009900;">&#93;</span>
            <span style="color: #009900;">&#125;</span>
         <span style="color: #009900;">&#93;</span><span style="color: #339933;">,</span>
         <span style="color: #3366CC;">&quot;transports&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#91;</span>
            <span style="color: #009900;">&#123;</span>
               <span style="color: #3366CC;">&quot;type&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;web&quot;</span><span style="color: #339933;">,</span>
               <span style="color: #3366CC;">&quot;endpoint&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span>
                  <span style="color: #3366CC;">&quot;type&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;tcp&quot;</span><span style="color: #339933;">,</span>
                  <span style="color: #3366CC;">&quot;port&quot;</span><span style="color: #339933;">:</span> <span style="color: #CC0000;">8080</span><span style="color: #339933;">,</span>
                  <span style="color: #3366CC;">&quot;interface&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;0.0.0.0&quot;</span>
               <span style="color: #009900;">&#125;</span><span style="color: #339933;">,</span>
               <span style="color: #3366CC;">&quot;paths&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span>
                  <span style="color: #3366CC;">&quot;/&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span>
                     <span style="color: #3366CC;">&quot;type&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;static&quot;</span><span style="color: #339933;">,</span>
                     <span style="color: #3366CC;">&quot;directory&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;..&quot;</span>
                  <span style="color: #009900;">&#125;</span><span style="color: #339933;">,</span>
                  <span style="color: #3366CC;">&quot;ws&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span>
                     <span style="color: #3366CC;">&quot;type&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;websocket&quot;</span><span style="color: #339933;">,</span>
                  <span style="color: #009900;">&#125;</span>
               <span style="color: #009900;">&#125;</span>
            <span style="color: #009900;">&#125;</span>
         <span style="color: #009900;">&#93;</span>
      <span style="color: #009900;">&#125;</span>
   <span style="color: #009900;">&#93;</span>
<span style="color: #009900;">&#125;</span></pre></td></tr></table></div>

<p>Crossbar est en effet un gestionnaire de processus : il ne gère vraiment rien lui même. Il démarre d&#8217;autres processus, appelés workers, à qui il délègue le travail. </p>
<p>On définit dans ce fichier de config quels processus (les workers) lancer quand Crossbar.io démarre. Les valeurs qu&#8217;on utilise disent de créer un seul worker de type &#8220;router&#8221;, c&#8217;est à dire un worker capable de gérer les entrées et les sorties WAMP. Hey oui, le routeur n&#8217;est qu&#8217;un worker comme les autres :)</p>
<p>Il y a d&#8217;autres sortes de workers, mais aujourd&#8217;hui on s&#8217;en branle.</p>
<p>Dans notre config du worker router, on crée d&#8217;abord un realm, qui est juste un namespace avec des permissions. Si un client WAMP se connecte à ce routeur, il doit choisir un realm (qui est juste un nom), et il ne peut parler qu&#8217;avec les clients du même realm. C&#8217;est une cloture quoi.</p>
<p>Dans un realm, on définit des roles qui déclarent quelles opérations PUB/SUB et RPC on a le droit de faire. Ici on dit que tout le monde (anonymous) a le droit de tout faire sur toutes les urls (&#8220;uri&#8221;:  &#8216;*&#8221;) histoire de pas se faire chier. Si on met en prod, évidement on va se pencher sur la sécurité et faire ça plus proprement.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family:monospace;"><span style="color: #3366CC;">&quot;realms&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#91;</span>
<span style="color: #009900;">&#123;</span>
   <span style="color: #3366CC;">&quot;name&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;realm1&quot;</span><span style="color: #339933;">,</span>
   <span style="color: #3366CC;">&quot;roles&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#91;</span>
      <span style="color: #009900;">&#123;</span>
         <span style="color: #3366CC;">&quot;name&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;anonymous&quot;</span><span style="color: #339933;">,</span>
         <span style="color: #3366CC;">&quot;permissions&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#91;</span>
            <span style="color: #009900;">&#123;</span>
               <span style="color: #3366CC;">&quot;uri&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;*&quot;</span><span style="color: #339933;">,</span>
               <span style="color: #3366CC;">&quot;publish&quot;</span><span style="color: #339933;">:</span> <span style="color: #003366; font-weight: bold;">true</span><span style="color: #339933;">,</span>
               <span style="color: #3366CC;">&quot;subscribe&quot;</span><span style="color: #339933;">:</span> <span style="color: #003366; font-weight: bold;">true</span><span style="color: #339933;">,</span>
               <span style="color: #3366CC;">&quot;call&quot;</span><span style="color: #339933;">:</span> <span style="color: #003366; font-weight: bold;">true</span><span style="color: #339933;">,</span>
               <span style="color: #3366CC;">&quot;register&quot;</span><span style="color: #339933;">:</span> <span style="color: #003366; font-weight: bold;">true</span>
            <span style="color: #009900;">&#125;</span>
         <span style="color: #009900;">&#93;</span>
      <span style="color: #009900;">&#125;</span>
   <span style="color: #009900;">&#93;</span>
<span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#93;</span><span style="color: #339933;">,</span></pre></td></tr></table></div>

<p>Puis on définit les transports, c&#8217;est à dire sur quoi notre worker va ouvrir ses oreilles pour écouter les messages entrant :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family:monospace;"><span style="color: #3366CC;">&quot;transports&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#91;</span>
            <span style="color: #009900;">&#123;</span>
               <span style="color: #3366CC;">&quot;type&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;web&quot;</span><span style="color: #339933;">,</span>
               <span style="color: #3366CC;">&quot;endpoint&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span>
                  <span style="color: #3366CC;">&quot;type&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;tcp&quot;</span><span style="color: #339933;">,</span>
                  <span style="color: #3366CC;">&quot;port&quot;</span><span style="color: #339933;">:</span> <span style="color: #CC0000;">8080</span><span style="color: #339933;">,</span>
                  <span style="color: #3366CC;">&quot;interface&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;0.0.0.0&quot;</span>
               <span style="color: #009900;">&#125;</span><span style="color: #339933;">,</span>
               <span style="color: #3366CC;">&quot;paths&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span>
                  <span style="color: #3366CC;">&quot;/&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span>
                     <span style="color: #3366CC;">&quot;type&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;static&quot;</span><span style="color: #339933;">,</span>
                     <span style="color: #3366CC;">&quot;directory&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;..&quot;</span>
                  <span style="color: #009900;">&#125;</span><span style="color: #339933;">,</span>
                  <span style="color: #3366CC;">&quot;ws&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span>
                     <span style="color: #3366CC;">&quot;type&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;websocket&quot;</span><span style="color: #339933;">,</span>
                  <span style="color: #009900;">&#125;</span>
               <span style="color: #009900;">&#125;</span>
            <span style="color: #009900;">&#125;</span>
        <span style="color: #009900;">&#93;</span></pre></td></tr></table></div>

<p>Encore une fois on en déclare un seul, de type &#8220;web&#8221;. Ce transport peut écouter HTTP et Websocket sur le même port. On lui dit d&#8217;écouter sur &#8220;0.0.0.0:8080&#8243; :</p>
<p><lang="javascript"><br />
&#8220;endpoint&#8221;: {<br />
  &#8220;type&#8221;: &#8220;tcp&#8221;,<br />
  &#8220;port&#8221;: 8080,<br />
  &#8220;interface&#8221;: &#8220;0.0.0.0&#8221;<br />
},</lang></p>
<p>Ensuite on dit que si quelqu&#8217;un arrive sur &#8220;/&#8221;, on sert en HTTP les fichiers statiques histoire que nos pages Web soient servies :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family:monospace;"><span style="color: #3366CC;">&quot;/&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span>
 <span style="color: #3366CC;">&quot;type&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;static&quot;</span><span style="color: #339933;">,</span>
 <span style="color: #3366CC;">&quot;directory&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;..&quot;</span>
<span style="color: #009900;">&#125;</span><span style="color: #339933;">,</span></pre></td></tr></table></div>

<p>Si on arrive sur &#8220;/ws&#8221;, on route les requêtes WAMP via Websocket :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family:monospace;"><span style="color: #3366CC;">&quot;ws&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span>
 <span style="color: #3366CC;">&quot;type&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;websocket&quot;</span><span style="color: #339933;">,</span>
<span style="color: #009900;">&#125;</span></pre></td></tr></table></div>

<p>Le routeur est prêt, on lance Crossbar.io :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">$ crossbar start
<span style="color: #000000;">2015</span>-01-07 <span style="color: #000000;">20</span>:02:<span style="color: #000000;">55</span>+0700 <span style="color: #7a0874; font-weight: bold;">&#91;</span>Controller  <span style="color: #000000;">26914</span><span style="color: #7a0874; font-weight: bold;">&#93;</span> Log opened.
<span style="color: #000000;">2015</span>-01-07 <span style="color: #000000;">20</span>:02:<span style="color: #000000;">55</span>+0700 <span style="color: #7a0874; font-weight: bold;">&#91;</span>Controller  <span style="color: #000000;">26914</span><span style="color: #7a0874; font-weight: bold;">&#93;</span> ============================== Crossbar.io ==============================
&nbsp;
<span style="color: #000000;">2015</span>-01-07 <span style="color: #000000;">20</span>:02:<span style="color: #000000;">55</span>+0700 <span style="color: #7a0874; font-weight: bold;">&#91;</span>Controller  <span style="color: #000000;">26914</span><span style="color: #7a0874; font-weight: bold;">&#93;</span> Crossbar.io 0.9.12-<span style="color: #000000;">2</span> starting
<span style="color: #000000;">2015</span>-01-07 <span style="color: #000000;">20</span>:02:<span style="color: #000000;">55</span>+0700 <span style="color: #7a0874; font-weight: bold;">&#91;</span>Controller  <span style="color: #000000;">26914</span><span style="color: #7a0874; font-weight: bold;">&#93;</span> Running on CPython using EPollReactor reactor
<span style="color: #000000;">2015</span>-01-07 <span style="color: #000000;">20</span>:02:<span style="color: #000000;">55</span>+0700 <span style="color: #7a0874; font-weight: bold;">&#91;</span>Controller  <span style="color: #000000;">26914</span><span style="color: #7a0874; font-weight: bold;">&#93;</span> Starting from node directory <span style="color: #000000; font-weight: bold;">/</span>home<span style="color: #000000; font-weight: bold;">/</span>sam<span style="color: #000000; font-weight: bold;">/</span>Work<span style="color: #000000; font-weight: bold;">/</span>sametmax<span style="color: #000000; font-weight: bold;">/</span>code_des_articles<span style="color: #000000; font-weight: bold;">/</span><span style="color: #000000;">2014</span><span style="color: #000000; font-weight: bold;">/</span>juin<span style="color: #000000; font-weight: bold;">/</span>video_remote<span style="color: #000000; font-weight: bold;">/</span>.crossbar
<span style="color: #000000;">2015</span>-01-07 <span style="color: #000000;">20</span>:02:<span style="color: #000000;">55</span>+0700 <span style="color: #7a0874; font-weight: bold;">&#91;</span>Controller  <span style="color: #000000;">26914</span><span style="color: #7a0874; font-weight: bold;">&#93;</span> Starting from <span style="color: #7a0874; font-weight: bold;">local</span> configuration <span style="color: #ff0000;">'/home/sam/Work/sametmax/code_des_articles/2014/juin/video_remote/.crossbar/config.json'</span>
<span style="color: #000000;">2015</span>-01-07 <span style="color: #000000;">20</span>:02:<span style="color: #000000;">55</span>+0700 <span style="color: #7a0874; font-weight: bold;">&#91;</span>Controller  <span style="color: #000000;">26914</span><span style="color: #7a0874; font-weight: bold;">&#93;</span> Warning, could not <span style="color: #000000; font-weight: bold;">set</span> process title <span style="color: #7a0874; font-weight: bold;">&#40;</span>setproctitle not installed<span style="color: #7a0874; font-weight: bold;">&#41;</span>
<span style="color: #000000;">2015</span>-01-07 <span style="color: #000000;">20</span>:02:<span style="color: #000000;">55</span>+0700 <span style="color: #7a0874; font-weight: bold;">&#91;</span>Controller  <span style="color: #000000;">26914</span><span style="color: #7a0874; font-weight: bold;">&#93;</span> Warning: process utilities not available
<span style="color: #000000;">2015</span>-01-07 <span style="color: #000000;">20</span>:02:<span style="color: #000000;">55</span>+0700 <span style="color: #7a0874; font-weight: bold;">&#91;</span>Controller  <span style="color: #000000;">26914</span><span style="color: #7a0874; font-weight: bold;">&#93;</span> No WAMPlets detected <span style="color: #000000; font-weight: bold;">in</span> enviroment.
<span style="color: #000000;">2015</span>-01-07 <span style="color: #000000;">20</span>:02:<span style="color: #000000;">55</span>+0700 <span style="color: #7a0874; font-weight: bold;">&#91;</span>Controller  <span style="color: #000000;">26914</span><span style="color: #7a0874; font-weight: bold;">&#93;</span> Starting Router with ID <span style="color: #ff0000;">'worker1'</span> ..
<span style="color: #000000;">2015</span>-01-07 <span style="color: #000000;">20</span>:02:<span style="color: #000000;">55</span>+0700 <span style="color: #7a0874; font-weight: bold;">&#91;</span>Controller  <span style="color: #000000;">26914</span><span style="color: #7a0874; font-weight: bold;">&#93;</span> Entering reactor event loop ...
<span style="color: #000000;">2015</span>-01-07 <span style="color: #000000;">20</span>:02:<span style="color: #000000;">55</span>+0700 <span style="color: #7a0874; font-weight: bold;">&#91;</span>Router      <span style="color: #000000;">26917</span><span style="color: #7a0874; font-weight: bold;">&#93;</span> Log opened.
<span style="color: #000000;">2015</span>-01-07 <span style="color: #000000;">20</span>:02:<span style="color: #000000;">55</span>+0700 <span style="color: #7a0874; font-weight: bold;">&#91;</span>Router      <span style="color: #000000;">26917</span><span style="color: #7a0874; font-weight: bold;">&#93;</span> Warning: could not <span style="color: #000000; font-weight: bold;">set</span> worker process title <span style="color: #7a0874; font-weight: bold;">&#40;</span>setproctitle not installed<span style="color: #7a0874; font-weight: bold;">&#41;</span>
<span style="color: #000000;">2015</span>-01-07 <span style="color: #000000;">20</span>:02:<span style="color: #000000;">55</span>+0700 <span style="color: #7a0874; font-weight: bold;">&#91;</span>Router      <span style="color: #000000;">26917</span><span style="color: #7a0874; font-weight: bold;">&#93;</span> Running under CPython using EPollReactor reactor
<span style="color: #000000;">2015</span>-01-07 <span style="color: #000000;">20</span>:02:<span style="color: #000000;">56</span>+0700 <span style="color: #7a0874; font-weight: bold;">&#91;</span>Router      <span style="color: #000000;">26917</span><span style="color: #7a0874; font-weight: bold;">&#93;</span> Entering event loop ..
<span style="color: #000000;">2015</span>-01-07 <span style="color: #000000;">20</span>:02:<span style="color: #000000;">56</span>+0700 <span style="color: #7a0874; font-weight: bold;">&#91;</span>Router      <span style="color: #000000;">26917</span><span style="color: #7a0874; font-weight: bold;">&#93;</span> Warning: process utilities not available
<span style="color: #000000;">2015</span>-01-07 <span style="color: #000000;">20</span>:02:<span style="color: #000000;">56</span>+0700 <span style="color: #7a0874; font-weight: bold;">&#91;</span>Controller  <span style="color: #000000;">26914</span><span style="color: #7a0874; font-weight: bold;">&#93;</span> Router with ID <span style="color: #ff0000;">'worker1'</span> and PID <span style="color: #000000;">26917</span> started
<span style="color: #000000;">2015</span>-01-07 <span style="color: #000000;">20</span>:02:<span style="color: #000000;">56</span>+0700 <span style="color: #7a0874; font-weight: bold;">&#91;</span>Controller  <span style="color: #000000;">26914</span><span style="color: #7a0874; font-weight: bold;">&#93;</span> Router <span style="color: #ff0000;">'worker1'</span>: realm <span style="color: #ff0000;">'realm1'</span> started
<span style="color: #000000;">2015</span>-01-07 <span style="color: #000000;">20</span>:02:<span style="color: #000000;">56</span>+0700 <span style="color: #7a0874; font-weight: bold;">&#91;</span>Controller  <span style="color: #000000;">26914</span><span style="color: #7a0874; font-weight: bold;">&#93;</span> Router <span style="color: #ff0000;">'worker1'</span>: role <span style="color: #ff0000;">'role1'</span> started on realm <span style="color: #ff0000;">'realm1'</span>
<span style="color: #000000;">2015</span>-01-07 <span style="color: #000000;">20</span>:02:<span style="color: #000000;">56</span>+0700 <span style="color: #7a0874; font-weight: bold;">&#91;</span>Router      <span style="color: #000000;">26917</span><span style="color: #7a0874; font-weight: bold;">&#93;</span> Site starting on <span style="color: #000000;">8080</span>
<span style="color: #000000;">2015</span>-01-07 <span style="color: #000000;">20</span>:02:<span style="color: #000000;">56</span>+0700 <span style="color: #7a0874; font-weight: bold;">&#91;</span>Controller  <span style="color: #000000;">26914</span><span style="color: #7a0874; font-weight: bold;">&#93;</span> Router <span style="color: #ff0000;">'worker1'</span>: transport <span style="color: #ff0000;">'transport1'</span> started</pre></td></tr></table></div>

<h2>Setup du client</h2>
<p>Pour cette démo, le serveur n&#8217;a pas grand chose à faire. On pourrait en fait la faire sans aucun code Python, mais ça va nous simplifier la vie et donner un peut de grain à moudre pour le tuto.</p>
<p>En effet, on a deux problématiques que le serveur va résoudre facilement pour nous : <strong>créer un ID unique pour le player et récupérer l&#8217;IP sur le réseau local.</strong></p>
<p>L&#8217;ID, c&#8217;est simplement que si plusieurs personnes lancent en même temps un player, on ne veut pas que les télécommandes puissent lancer un ordre à un autre player que le sien. On pourrait utiliser un timestamp, mais ils sont contigus, n&#8217;importe quel script kiddies pourrait faire un script pour foutre la merde. On va donc créer un ID unique qui ne soit pas facilement prévisible. Javascript n&#8217;a rien pour faire ça en natif, et c&#8217;est un peu con de charger une lib de plus pour ça alors que Python peut le faire pour nous.</p>
<p>L&#8217;IP, c&#8217;est parce qu&#8217;il faut donner l&#8217;adresse de notre machine contient notre routeur. Et le téléphone qui sert de télécommande doit se connecter à ce routeur. Il faut donc qu&#8217;il connaisse l&#8217;adresse de celui-ci, donc on va la mettre dans notre QR code.</p>
<p>Cela veut dire aussi que le téléphone doit être sur le même réseau local pour que ça fonctionne. <strong>Donc mettez votre téléphone en Wifi, pas en 3G.</strong></p>
<p>Voilà ce que donne notre code WAMP côté serveur :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #808080; font-style: italic;"># -*- coding: utf-8 -*-</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">from</span> autobahn.<span style="color: black;">twisted</span>.<span style="color: black;">wamp</span> <span style="color: #ff7700;font-weight:bold;">import</span> Application
&nbsp;
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">socket</span>
<span style="color: #ff7700;font-weight:bold;">import</span> uuid
&nbsp;
<span style="color: #808080; font-style: italic;"># Comme pour flask, l'objet app</span>
<span style="color: #808080; font-style: italic;"># est ce qui lie tous les éléments</span>
<span style="color: #808080; font-style: italic;"># de notre code ensemble. On lui donne</span>
<span style="color: #808080; font-style: italic;"># un nom, ici &quot;demo&quot;</span>
app <span style="color: #66cc66;">=</span> Application<span style="color: black;">&#40;</span><span style="color: #483d8b;">'demo'</span><span style="color: black;">&#41;</span>
<span style="color: #808080; font-style: italic;"># Bien que l'app va démarrer un serveur</span>
<span style="color: #808080; font-style: italic;"># pour nous, l'app est bien un CLIENT</span>
<span style="color: #808080; font-style: italic;"># du serveur WAMP. Le serveur démarré</span>
<span style="color: #808080; font-style: italic;"># automatiquement n'est qu'une facilité</span>
<span style="color: #808080; font-style: italic;"># pour le dev. En prod on utiliserait</span>
<span style="color: #808080; font-style: italic;"># crossbar.</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># Juste un conteneur pour y mettre notre IP</span>
app._data <span style="color: #66cc66;">=</span> <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># On déclare que cette fonction sera appelée</span>
<span style="color: #808080; font-style: italic;"># quand l'app se sera connectée au serveur WAMP.</span>
<span style="color: #808080; font-style: italic;"># Ceci permet de lancer du code juste après</span>
<span style="color: #808080; font-style: italic;"># le app.run() que l'on voit en bas du fichier.</span>
<span style="color: #808080; font-style: italic;"># '_' est une convention en Python pour dire</span>
<span style="color: #808080; font-style: italic;"># &quot;ce nom n'a aucune importance, c'est du code</span>
<span style="color: #808080; font-style: italic;"># jetable qu'on utilisera une seule fois&quot;.</span>
<span style="color: #66cc66;">@</span>app.<span style="color: #dc143c;">signal</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'onjoined'</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">def</span> _<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
   <span style="color: #808080; font-style: italic;"># On récupère notre adresse IP sur le réseau local</span>
   <span style="color: #808080; font-style: italic;"># C'est une astuce qui demande de se connecter et donc</span>
   <span style="color: #808080; font-style: italic;">#  à une IP externe, on a besoin d'une connexion internet.</span>
   s <span style="color: #66cc66;">=</span> <span style="color: #dc143c;">socket</span>.<span style="color: #dc143c;">socket</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">socket</span>.<span style="color: black;">AF_INET</span><span style="color: #66cc66;">,</span> <span style="color: #dc143c;">socket</span>.<span style="color: black;">SOCK_DGRAM</span><span style="color: black;">&#41;</span>
   s.<span style="color: black;">connect</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;8.8.8.8&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">80</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
   <span style="color: #808080; font-style: italic;"># On stocke l'adresse IP locale dans un conteneur</span>
   <span style="color: #808080; font-style: italic;"># qui sera accessible partout ailleur.</span>
   app._data<span style="color: black;">&#91;</span><span style="color: #483d8b;">'LOCAL_IP'</span><span style="color: black;">&#93;</span> <span style="color: #66cc66;">=</span> s.<span style="color: black;">getsockname</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#93;</span>
   s.<span style="color: black;">close</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># On déclare que la fonction &quot;ip()&quot; est appelable</span>
<span style="color: #808080; font-style: italic;"># via RCP. Ce qui veut dire que tout autre client</span>
<span style="color: #808080; font-style: italic;"># WAMP peut obtenir le résultat de cette fonction.</span>
<span style="color: #808080; font-style: italic;"># Donc on va pouvoir l'appeler depuis notre navigateur.</span>
<span style="color: #808080; font-style: italic;"># Comme notre app s'appelle &quot;demo&quot; et notre fonction</span>
<span style="color: #808080; font-style: italic;"># s'appelle &quot;ip&quot;, un client pourra l'appeler en faisant</span>
<span style="color: #808080; font-style: italic;"># &quot;demo.ip&quot;.</span>
<span style="color: #66cc66;">@</span>app.<span style="color: black;">register</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">def</span> ip<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
   <span style="color: #808080; font-style: italic;"># On ne fait que retourner l'IP locale. Rien de fou.</span>
   <span style="color: #ff7700;font-weight:bold;">return</span> app._data<span style="color: black;">&#91;</span><span style="color: #483d8b;">'LOCAL_IP'</span><span style="color: black;">&#93;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># Je voulais appeler cette fonction distante &quot;uuid&quot;, mais ça</span>
<span style="color: #808080; font-style: italic;"># override le module Python uuid. Ce n'est pas une bonne</span>
<span style="color: #808080; font-style: italic;"># idée. Je l'appelle donc 'get_uuid' mais je déclare le</span>
<span style="color: #808080; font-style: italic;"># namespace complet dans register(). Un client WAMP pourra donc</span>
<span style="color: #808080; font-style: italic;"># bien l'appeler via &quot;demo.uuid&quot;.</span>
<span style="color: #808080; font-style: italic;"># Notez que ce namespace doit toujours s'écrire</span>
<span style="color: #808080; font-style: italic;"># truc.machine.bidule. Pas truc/machin ou truc:machin.</span>
<span style="color: #808080; font-style: italic;"># ou truc et bidule.MACHIN.</span>
<span style="color: #66cc66;">@</span>app.<span style="color: black;">register</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'demo.uuid'</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">def</span> get_uuid<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
   <span style="color: #808080; font-style: italic;"># Retourne un UUID, sans les tirets.</span>
   <span style="color: #808080; font-style: italic;"># ex: b27f7e9360c04efabfae5ac21a8f4e3c</span>
   <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">str</span><span style="color: black;">&#40;</span>uuid.<span style="color: black;">uuid4</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>.<span style="color: black;">replace</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'-'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">''</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># On lance notre client qui va se connecter au</span>
<span style="color: #808080; font-style: italic;"># routeur.</span>
<span style="color: #ff7700;font-weight:bold;">if</span> __name__ <span style="color: #66cc66;">==</span> <span style="color: #483d8b;">'__main__'</span>:
    app.<span style="color: black;">run</span><span style="color: black;">&#40;</span>url<span style="color: #66cc66;">=</span><span style="color: #483d8b;">&quot;ws://127.0.0.1:8080/ws&quot;</span><span style="color: black;">&#41;</span>
<span style="color: #808080; font-style: italic;"># On ne peut rien mettre comme code ici, il faut le</span>
<span style="color: #808080; font-style: italic;"># mettre dans @app.signal('onjoined') si on veut</span>
<span style="color: #808080; font-style: italic;"># entrer du code après que l'app soit lancée.</span></pre></td></tr></table></div>

<p>Et on lance notre app dans un autre terminal:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">python app.py</pre></td></tr></table></div>

<p>Nous avons maintenant Crossbar.io qui tourne d&#8217;une console, et le client Python qui tourne dans une seconde console, connecté au routeur.</p>
<h2>Le lecteur vidéo</h2>
<p>Il nous faut maintenant définir le comportement de notre lecteur vidéo, un client WAMP Javascript. Il s&#8217;agit essentiellement de se connecter au serveur WAMP, et d&#8217;échanger des messages via RPC ou PUB/SUB :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family:monospace;">  <span style="color: #000066; font-weight: bold;">var</span> player <span style="color: #339933;">=</span> <span style="color: #009900;">&#123;</span><span style="color: #009900;">&#125;</span><span style="color: #339933;">;</span>
  <span style="color: #000066; font-weight: bold;">var</span> url<span style="color: #339933;">;</span>
  <span style="color: #006600; font-style: italic;">/* On va utiliser du pur JS histoire de pas mélanger
    des notions de jQuery dans le tas. Je ne vais
    PAS utiliser les best practices sinon vous allez
    être noyés dans des détails */</span>
&nbsp;
  <span style="color: #006600; font-style: italic;">/* Lancer le code une fois que la page est chargée */</span>
  window.<span style="color: #660066;">addEventListener</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">&quot;load&quot;</span><span style="color: #339933;">,</span> <span style="color: #000066; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
&nbsp;
    <span style="color: #006600; font-style: italic;">/* Connexion au serveur WAMP. J'utilise
       les valeurs par défaut du serveur de
       dev. On ouvre explicitement la connection
       à la fin du script. */</span>
    <span style="color: #000066; font-weight: bold;">var</span> connection <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">new</span> autobahn.<span style="color: #660066;">Connection</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#123;</span>
       url<span style="color: #339933;">:</span> <span style="color: #3366CC;">'ws://'</span> <span style="color: #339933;">+</span> window.<span style="color: #660066;">location</span>.<span style="color: #660066;">hostname</span> <span style="color: #339933;">+</span> <span style="color: #3366CC;">':8080/ws'</span><span style="color: #339933;">,</span>
       realm<span style="color: #339933;">:</span> <span style="color: #3366CC;">'realm1'</span>
    <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #006600; font-style: italic;">/* Lancer ce code une fois que la connexion
       est réussie. Notez que je ne gère pas
       les erreurs dans dans une APP JS, c'est
       un puits sans fond. */</span>
    connection.<span style="color: #660066;">onopen</span> <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">function</span> <span style="color: #009900;">&#40;</span>session<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
&nbsp;
      <span style="color: #006600; font-style: italic;">/* Appel de la fonction ip() sur le serveur */</span>
      session.<span style="color: #660066;">call</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'demo.ip'</span><span style="color: #009900;">&#41;</span>
&nbsp;
      <span style="color: #006600; font-style: italic;">/* Une fois qu'on a récupéré l'IP,
         on peut fabriquer l'URL de notre
         projet et on appelle la fonction
         get_uuid() du serveur */</span>
      .<span style="color: #660066;">then</span><span style="color: #009900;">&#40;</span><span style="color: #000066; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>ip<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
        url <span style="color: #339933;">=</span> <span style="color: #3366CC;">'http://'</span> <span style="color: #339933;">+</span> ip <span style="color: #339933;">+</span> <span style="color: #3366CC;">':8000'</span><span style="color: #339933;">;</span>
        <span style="color: #000066; font-weight: bold;">return</span> session.<span style="color: #660066;">call</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'demo.uuid'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
      <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span>
&nbsp;
      <span style="color: #006600; font-style: italic;">/* Une fois qu'on a l'UUID, on peut commencer
         à gérer la partie télécommande */</span>
      .<span style="color: #660066;">then</span><span style="color: #009900;">&#40;</span><span style="color: #000066; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>uuid<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
&nbsp;
        <span style="color: #006600; font-style: italic;">/* Création du QR code avec le lien pointant
           sur la bonne URL. On met l'ID dans le hash. */</span>
        <span style="color: #000066; font-weight: bold;">var</span> controlUrl <span style="color: #339933;">=</span> url <span style="color: #339933;">+</span> <span style="color: #3366CC;">'/control.html#'</span> <span style="color: #339933;">+</span> uuid<span style="color: #339933;">;</span>
        <span style="color: #000066; font-weight: bold;">var</span> codeDiv <span style="color: #339933;">=</span> document.<span style="color: #660066;">getElementById</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">&quot;qrcode&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #000066; font-weight: bold;">new</span> QRCode<span style="color: #009900;">&#40;</span>codeDiv<span style="color: #339933;">,</span> controlUrl<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #000066; font-weight: bold;">var</span> ctrllink <span style="color: #339933;">=</span> document.<span style="color: #660066;">getElementById</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">&quot;ctrllink&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        ctrllink.<span style="color: #660066;">href</span> <span style="color: #339933;">=</span> controlUrl<span style="color: #339933;">;</span>
&nbsp;
        <span style="color: #006600; font-style: italic;">/* Notre travail consiste essentiellement à
           manipuler cet élément */</span>
        <span style="color: #000066; font-weight: bold;">var</span> video <span style="color: #339933;">=</span> document.<span style="color: #660066;">getElementById</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">&quot;vid&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
        <span style="color: #006600; font-style: italic;">/* On attache déclare 4 fonctions comme étant
           appelable à distance. Ces fonctions sont
           appelables en utilisant le nom composé
           de notre ID et de l'action qu'on souhaite
           faire. Ex:
           'b27f7e9360c04efabfae5ac21a8f4e3c.play'
           pour appeler &quot;play&quot; sur notre session. */</span>
        session.<span style="color: #660066;">register</span><span style="color: #009900;">&#40;</span>uuid <span style="color: #339933;">+</span> <span style="color: #3366CC;">'.play'</span><span style="color: #339933;">,</span> <span style="color: #000066; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
           video.<span style="color: #660066;">play</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
        session.<span style="color: #660066;">register</span><span style="color: #009900;">&#40;</span>uuid <span style="color: #339933;">+</span> <span style="color: #3366CC;">'.pause'</span><span style="color: #339933;">,</span> <span style="color: #000066; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
           video.<span style="color: #660066;">pause</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
        session.<span style="color: #660066;">register</span><span style="color: #009900;">&#40;</span>uuid <span style="color: #339933;">+</span> <span style="color: #3366CC;">'.volume'</span><span style="color: #339933;">,</span> <span style="color: #000066; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>val<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
           video.<span style="color: #660066;">volume</span> <span style="color: #339933;">=</span> val<span style="color: #009900;">&#91;</span><span style="color: #CC0000;">0</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">;</span>
        <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
        session.<span style="color: #660066;">register</span><span style="color: #009900;">&#40;</span>uuid <span style="color: #339933;">+</span> <span style="color: #3366CC;">'.status'</span><span style="color: #339933;">,</span> <span style="color: #000066; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>val<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
          <span style="color: #000066; font-weight: bold;">return</span> <span style="color: #009900;">&#123;</span>
            <span style="color: #3366CC;">'playing'</span><span style="color: #339933;">:</span> <span style="color: #339933;">!</span>video.<span style="color: #660066;">paused</span><span style="color: #339933;">,</span>
            <span style="color: #3366CC;">'volume'</span><span style="color: #339933;">:</span> video.<span style="color: #660066;">volume</span>
          <span style="color: #009900;">&#125;</span><span style="color: #339933;">;</span>
        <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
&nbsp;
&nbsp;
       <span style="color: #006600; font-style: italic;">/* Quelqu'un peut très bien
           appuyer sur play directement sur cette page.
&nbsp;
          Il faut donc réagir si l'utilisateur le fait,
          publier un événement via WAMP pour permettre
          à notre télécommande de se mettre à jour
          */</span>
       video.<span style="color: #660066;">addEventListener</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'play'</span><span style="color: #339933;">,</span> <span style="color: #000066; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
         <span style="color: #006600; font-style: italic;">/* On publie un message indiquant que
            le player a recommencé à lire la vidéo.
            */</span>
         session.<span style="color: #660066;">publish</span><span style="color: #009900;">&#40;</span>uuid <span style="color: #339933;">+</span> <span style="color: #3366CC;">'.play'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
       <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
        video.<span style="color: #660066;">addEventListener</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'pause'</span><span style="color: #339933;">,</span> <span style="color: #000066; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
          session.<span style="color: #660066;">publish</span><span style="color: #009900;">&#40;</span>uuid <span style="color: #339933;">+</span> <span style="color: #3366CC;">'.pause'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
        video.<span style="color: #660066;">addEventListener</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'volumechange'</span><span style="color: #339933;">,</span> <span style="color: #000066; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
          session.<span style="color: #660066;">publish</span><span style="color: #009900;">&#40;</span>uuid <span style="color: #339933;">+</span> <span style="color: #3366CC;">'.volume'</span><span style="color: #339933;">,</span> <span style="color: #009900;">&#91;</span>video.<span style="color: #660066;">volume</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
     <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #006600; font-style: italic;">/* Ouverture de la connection une fois que tous les
       callbacks sont bien en place.*/</span>
    connection.<span style="color: #660066;">open</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre></td></tr></table></div>

<h2>Code de la télécommande</h2>
<p>La télécommande est notre dernier client WAMP (on peut avoir plein de clients WAMP, ne vous inquiétez, ça tient 6000 connections simultanées sur un tout petit Raspberry PI). </p>
<p>Son code a pour but d&#8217;envoyer des ordres au player HTML5, mais aussi de mettre à jour son UI si le player change d&#8217;état.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family:monospace;"><span style="color: #006600; font-style: italic;">/* L'objet qui se charge de la logique de nos
   controles play/pause et changement de
   volume.
   Rien de fou, il change l'affichage
   du bouton et du slider selon qu'on
   est en pause/play et la valeur du
   volume.
   */</span>
<span style="color: #000066; font-weight: bold;">var</span> control <span style="color: #339933;">=</span> <span style="color: #009900;">&#123;</span>
   playing<span style="color: #339933;">:</span> <span style="color: #003366; font-weight: bold;">false</span><span style="color: #339933;">,</span>
   setPlaying<span style="color: #339933;">:</span> <span style="color: #000066; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>val<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
      control.<span style="color: #660066;">playing</span> <span style="color: #339933;">=</span> val<span style="color: #339933;">;</span>
      <span style="color: #000066; font-weight: bold;">var</span> button <span style="color: #339933;">=</span> window.<span style="color: #660066;">document</span>.<span style="color: #660066;">getElementById</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'play'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
      <span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #339933;">!</span>val<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
         button.<span style="color: #660066;">innerHTML</span> <span style="color: #339933;">=</span> <span style="color: #3366CC;">'Play'</span>
      <span style="color: #009900;">&#125;</span> <span style="color: #000066; font-weight: bold;">else</span> <span style="color: #009900;">&#123;</span>
         button.<span style="color: #660066;">innerHTML</span> <span style="color: #339933;">=</span> <span style="color: #3366CC;">'Pause'</span><span style="color: #339933;">;</span>
      <span style="color: #009900;">&#125;</span>
   <span style="color: #009900;">&#125;</span><span style="color: #339933;">,</span>
   setVolume<span style="color: #339933;">:</span> <span style="color: #000066; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>val<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
      <span style="color: #000066; font-weight: bold;">var</span> slider <span style="color: #339933;">=</span> window.<span style="color: #660066;">document</span>.<span style="color: #660066;">getElementById</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'volume'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
      slider.<span style="color: #660066;">value</span> <span style="color: #339933;">=</span> val<span style="color: #339933;">;</span>
   <span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span><span style="color: #339933;">;</span>
window.<span style="color: #660066;">onload</span> <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
  <span style="color: #000066; font-weight: bold;">var</span> connection <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">new</span> autobahn.<span style="color: #660066;">Connection</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#123;</span>
    url<span style="color: #339933;">:</span> <span style="color: #3366CC;">'ws://'</span> <span style="color: #339933;">+</span> window.<span style="color: #660066;">location</span>.<span style="color: #660066;">hostname</span> <span style="color: #339933;">+</span> <span style="color: #3366CC;">':8080/ws'</span><span style="color: #339933;">,</span>
    realm<span style="color: #339933;">:</span> <span style="color: #3366CC;">'realm1'</span>
  <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
  connection.<span style="color: #660066;">onopen</span> <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">function</span> <span style="color: #009900;">&#40;</span>session<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
&nbsp;
    <span style="color: #006600; font-style: italic;">/* Récupération de l'ID dans le hash de l'URL */</span>
    <span style="color: #000066; font-weight: bold;">var</span> uuid <span style="color: #339933;">=</span> window.<span style="color: #660066;">location</span>.<span style="color: #660066;">hash</span>.<span style="color: #660066;">replace</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'#'</span><span style="color: #339933;">,</span> <span style="color: #3366CC;">''</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #006600; font-style: italic;">/* Mise à jour des controles selon le status actuel
       du player grace à un appel RPC vers notre autre
       page. */</span>
    session.<span style="color: #660066;">call</span><span style="color: #009900;">&#40;</span>uuid <span style="color: #339933;">+</span> <span style="color: #3366CC;">'.status'</span><span style="color: #009900;">&#41;</span>.<span style="color: #660066;">then</span><span style="color: #009900;">&#40;</span><span style="color: #000066; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>status<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
&nbsp;
      control.<span style="color: #660066;">setPlaying</span><span style="color: #009900;">&#40;</span>status<span style="color: #009900;">&#91;</span><span style="color: #3366CC;">'playing'</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
      control.<span style="color: #660066;">setVolume</span><span style="color: #009900;">&#40;</span>status<span style="color: #009900;">&#91;</span><span style="color: #3366CC;">'volume'</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span>
&nbsp;
      <span style="color: #006600; font-style: italic;">/* On attache l'appui sur les contrôles à
         un appel de la fonction play() sur le
         player distant. L'uuid nous permet
         de n'envoyer l'événement que sur le
         bon player. */</span>
      control.<span style="color: #660066;">togglePlay</span> <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
        <span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>control.<span style="color: #660066;">playing</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
          session.<span style="color: #660066;">call</span><span style="color: #009900;">&#40;</span>uuid <span style="color: #339933;">+</span> <span style="color: #3366CC;">'.pause'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
          control.<span style="color: #660066;">setPlaying</span><span style="color: #009900;">&#40;</span><span style="color: #003366; font-weight: bold;">false</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #009900;">&#125;</span> <span style="color: #000066; font-weight: bold;">else</span> <span style="color: #009900;">&#123;</span>
          session.<span style="color: #660066;">call</span><span style="color: #009900;">&#40;</span>uuid <span style="color: #339933;">+</span> <span style="color: #3366CC;">'.play'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
          control.<span style="color: #660066;">setPlaying</span><span style="color: #009900;">&#40;</span><span style="color: #003366; font-weight: bold;">true</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #009900;">&#125;</span>
      <span style="color: #009900;">&#125;</span><span style="color: #339933;">;</span>
&nbsp;
      control.<span style="color: #660066;">volume</span> <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>val<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
        session.<span style="color: #660066;">call</span><span style="color: #009900;">&#40;</span>uuid <span style="color: #339933;">+</span> <span style="color: #3366CC;">'.volume'</span><span style="color: #339933;">,</span> <span style="color: #009900;">&#91;</span>val <span style="color: #339933;">/</span> <span style="color: #CC0000;">100</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
      <span style="color: #009900;">&#125;</span><span style="color: #339933;">;</span>
&nbsp;
      <span style="color: #006600; font-style: italic;">/* On ajoute un callback sur les événements
         de changement de status du player. Si
         quelqu'un fait play/pause ou change le
         volume, on veut mettre à jour la page. */</span>
      session.<span style="color: #660066;">subscribe</span><span style="color: #009900;">&#40;</span>uuid <span style="color: #339933;">+</span> <span style="color: #3366CC;">'.play'</span><span style="color: #339933;">,</span> <span style="color: #000066; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
        control.<span style="color: #660066;">setPlaying</span><span style="color: #009900;">&#40;</span><span style="color: #003366; font-weight: bold;">true</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
      <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
      session.<span style="color: #660066;">subscribe</span><span style="color: #009900;">&#40;</span>uuid <span style="color: #339933;">+</span> <span style="color: #3366CC;">'.pause'</span><span style="color: #339933;">,</span> <span style="color: #000066; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
        control.<span style="color: #660066;">setPlaying</span><span style="color: #009900;">&#40;</span><span style="color: #003366; font-weight: bold;">false</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
      <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
      session.<span style="color: #660066;">subscribe</span><span style="color: #009900;">&#40;</span>uuid <span style="color: #339933;">+</span> <span style="color: #3366CC;">'.volume'</span><span style="color: #339933;">,</span> <span style="color: #000066; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>val<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
        control.<span style="color: #660066;">setVolume</span><span style="color: #009900;">&#40;</span>val<span style="color: #009900;">&#91;</span><span style="color: #CC0000;">0</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">*</span> <span style="color: #CC0000;">100</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
      <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span><span style="color: #339933;">;</span>
&nbsp;
  connection.<span style="color: #660066;">open</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span><span style="color: #339933;">;</span></pre></td></tr></table></div>

<h2>En résumé</h2>
<p>Voici à quoi ressemble le projet final :</p>
<pre>.
├── app.py
├── control.html
├── .crossbar
│   └── config.json
└── index.html
</pre>
<div id="attachment_11173" style="width: 499px" class="wp-caption aligncenter"><a href="http://sametmax.com/wp-content/uploads/2014/06/demo_video_wamp.png" class="grouped_elements" rel="tc-fancybox-group11146"><img class="size-full wp-image-11173" title="Bien que l'app Python lance le serveur automatiquement et de manière invisible, c'est bien un composant à part." src="http://sametmax.com/wp-content/uploads/2014/06/demo_video_wamp.png" alt="Schéma de fonctionnement de la démo" width="489" height="346" /></a><p class="wp-caption-text">Bien que l&#8217;app Python lance le serveur automatiquement et de manière invisible, c&#8217;est bien un composant à part.</p></div>
<p>Pour ce projet, on aura utilisé :</p>
<ul>
<li><a href="http://wamp.ws/">WAMP</a>: le protocole qui permet de faire communiquer en temps réel des parties d&#8217;application via RPC et PUB/SUB.</li>
<li><a href="http://autobahn.ws/js/">Autobahn.js</a>: une lib pour créer des clients WAMP en javascript.</li>
<li><a href="http://autobahn.ws/python/">Autobahn.py</a>: une lib pour créer des clients WAMP en Python.</li>
<li><a href="http://crossbar.io/">Crossbar.io</a>: un routeur WAMP.</li>
</ul>
<p>Il y a pas mal de notions à prendre en compte.</p>
<p>D&#8217;abord, le <strong>RPC</strong>.</p>
<p>Cela permet à un client de dire &#8220;les autres clients peuvent appeler cette fonction à distance&#8221;. On l&#8217;utilise pour exposer <code>ip()</code> et <code>get_uuid()</code> sur notre serveur et notre Javascript peut donc les appeler. Mais on l&#8217;utilise AUSSI pour qu&#8217;une des pages (le player) expose <code>play()</code>, <code>pause()</code> et <code>volume()</code> et que l&#8217;autre page (notre télécommande) puisse les utiliser.</p>
<p>La grosse différence, c&#8217;est que <code>ip()</code> peut être appelé par tous les clients en utilisant &#8220;demo.ip&#8221; alors que <code>play()</code> ne peut être appelé que par les clients qui connaissent l&#8217;ID du player, puisqu&#8217;il faut utiliser &#8220;&lt;id&gt;.play&#8221;.</p>
<p>Ensuite, il y a le <strong>PUB/SUB</strong>.</p>
<p>Cela permet à un client de dire &#8220;j&#8217;écoute tous les messages adressés à ce nom&#8221;. Et un autre client peut envoyer un message (on appelle ça aussi un événement, c&#8217;est pareil) sur ce nom, de telle sorte que tous les clients abonnés le reçoivent.</p>
<p>On l&#8217;utilise pour que notre télécommande dise &#8220;j&#8217;écoute tous les messages qui concernent les changements de status du player.&#8221; De l&#8217;autre côté, quand on clique sur un contrôle du player, on envoie un message précisant si le volume a changé, ou si on a appuyé sur play/pause. La télécommande peut ainsi mettre son UI à jour et refléter par exemple, la nouvelle valeur du volume.</p>
<p>Cela résume bien les usages principaux de ces deux outils :</p>
<ul>
<li>RPC permet de donner un ordre ou récupérer une information.</li>
<li>PUB/SUB permet de (se) tenir au courant d&#8217;un événement.</li>
</ul>
<p>Voici le workflow de notre projet :</p>
<ul>
<li>On lance un serveur WAMP.</li>
<li>On connecte des clients dessus (du code Python ou Js dans notre exemple).</li>
<li>Les clients déclarent les fonctions qu&#8217;ils exposent en RPC et les événements qu&#8217;ils écoutent en PUB/SUB.</li>
<li>Ensuite on réagit aux actions utilisateurs et on fait les appels RPC et les publications PUB/SUB en conséquence.</li>
</ul>
<p><strong>Si vous virez tous les commentaires, vous verrez que le code est en fait vraiment court pour une application aussi complexe.</strong></p>
<p>Encore une fois, il est possible de le faire sans WAMP, ce sera juste plus compliqué. Je vous invite à essayer de le faire pour vous rendre compte. Avec PHP, Ruby ou une app WSGI, c&#8217;est pas marrant du tout. Avec NodeJs, c&#8217;est plus simple, mais il faut quand même se taper la logique de gestion RPC et PUB/SUB à la main ou installer pas mal de libs en plus.</p>
<p>WAMP rend ce genre d&#8217;app triviale à écrire. Enfin triviale parce que là j&#8217;ignore tous les edge cases, évidemment. Pour un produit solide, il faut toujours suer un peu.</p>
<h2>Les limites du truc</h2>
<p>C&#8217;est du Python 2.7. Bientôt on pourra le faire avec asyncio et donc Python 3.4, mais malheureusement sans le serveur de dev.</p>
<p>Heureusement, Twisted est en cours de portage vers Python 3, et donc tout finira par marcher en 3.2+.</p>
<p>C&#8217;est du HTML5, mais bien entendu, rien ne vous empêche de faire ça avec du Flash si ça vous amuse.</p>
<p>C&#8217;est du WebSocket, mais on peut utiliser un peu de Flash pour <a href="https://github.com/gimite/web-socket-js">simuler WebSocket</a> pour les vieux navigateurs qui ne le supportent pas.</p>
<p>Non, la vraie limite c&#8217;est encore la jeunesse du projet : pas d&#8217;autoreload pour le serveur (super chiant de devoir le faire à la main à chaque fois qu&#8217;on modifie le code) et les erreurs côté serveur se lisent dans la console JS, et pas dans le terminal depuis lequel on a lancé le serveur. Plein de petits détails comme ça.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/introduction-a-wamp-en-python/feed/</wfw:commentRss>
		<slash:comments>47</slash:comments>
<enclosure url="http://media.w3.org/2010/05/sintel/trailer.ogv" length="12965718" type="video/ogg" />
<enclosure url="http://media.w3.org/2010/05/sintel/trailer.mp4" length="4372373" type="video/mp4" />
<enclosure url="http://media.w3.org/2010/05/sintel/trailer.webm" length="3091780" type="video/webm" />
	<enclosure url="http://sametmax.com/wp-content/uploads/2014/06/FqebLW21.png" length="439958" type="image/jpg" />	</item>
	</channel>
</rss>
