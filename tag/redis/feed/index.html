<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Sam &#38; Max &#187; redis</title>
	<atom:link href="http://sametmax.com/tag/redis/feed/" rel="self" type="application/rss+xml" />
	<link>http://sametmax.com</link>
	<description>Du code, du cul</description>
	<lastBuildDate>Sat, 07 Nov 2015 10:56:13 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>http://wordpress.org/?v=4.1</generator>
	<item>
		<title>Utilisateurs en ligne avec le sorted set de Redis 7</title>
		<link>http://sametmax.com/utilisateurs-en-ligne-avec-le-sorted-set-de-redis/</link>
		<comments>http://sametmax.com/utilisateurs-en-ligne-avec-le-sorted-set-de-redis/#comments</comments>
		<pubDate>Sat, 25 Jul 2015 08:48:50 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[redis]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=16676</guid>
		<description><![CDATA[Beaucoup de gens sous exploitent Redis en se cantonnant à un usage clé/valeur, voir pour les plus aguéris à la liste ou le hash.

Mais derrière sa simplicité d'usage, l'outil possède une grande richesse de fonctionalités comme le PUB/SUB, l'<a href="http://sametmax.com/le-compteur-mal-connu-lhyperloglog/">hyperloglog</a> et les sorted sets.

C'est de ces derniers dont on va parler.]]></description>
				<content:encoded><![CDATA[<p>Beaucoup de gens sous exploitent Redis en se cantonnant à un usage clé/valeur, voire pour les plus aguérris à la liste ou le hash.</p>
<p>Mais derrière sa simplicité d&#8217;usage, l&#8217;outil possède une grande richesse de fonctionnalités comme le PUB/SUB, l&#8217;<a href="http://sametmax.com/le-compteur-mal-connu-lhyperloglog/">hyperloglog</a> et les sorted sets.</p>
<p>C&#8217;est de ces derniers dont on va parler.</p>
<p>En effet, dernièrement j&#8217;ai dû mettre en place un petit compteur des visiteurs en ligne, et c&#8217;est typiquement quelque chose qui fusille une base de données car ça fait une écriture ou une lecture à chaque changement de vue.</p>
<p>Redis est idéal pour ça, le truc tenant 100 000 écritures / seconde, et perdre 4 secondes d&#8217;historique du compteur en cas de crash est le cadet de mes soucis.</p>
<p>Pour compter les visiteurs, il nous faut non seulement un moyen d&#8217;incrémenter le compteur, mais aussi de le décrémenter quand le visiteur n&#8217;est plus en ligne. J&#8217;utiliserais WAMP, Crossbar pourrait me donner l&#8217;information à tout moment via l&#8217;<a href="http://sametmax.com/pendant-ce-temps-a-vera-cruz/">API meta</a>, mais sur un site HTTP only il n&#8217;y a aucun événement qui nous signale &#8220;l&#8217;utilisateur n&#8217;est plus connecté&#8221;.</p>
<p>Le seule moyen de savoir qu&#8217;un utilisateur n&#8217;est plus connecté est de garder une trace de lui et de la faire expirer quand on n&#8217;a pas de nouvelle depuis un temps supérieur à une durée raisonnable (calculée avec précision ) 10 minutes par l&#8217;<a href="http://sametmax.com/rapport-de-lindms-le-niveau-des-developpeurs/">INDMS</a>).</p>
<p>Problème, on peut bien faire expirer des clés avec Redis, mais on ne peut pas lister ces clés (la fonction <code>keys()</code> le fait mais avec des perfs désastreuses et l&#8217;auteur du logiciel la conseille uniquement pour regarder l&#8217;état de son serveur depuis la console). D&#8217;un autre côté on a des listes, mais l&#8217;expiration concerne toute la liste, pas juste un élément.</p>
<p>Une manière de contourner le problème est d&#8217;utiliser un sorted set, une structure de données Redis qui a les caractéristiques suivantes :</p>
<ul>
<li>Clé/valeur, mais la clé est forcément du texte, et la valeur forcément un chiffre.</li>
<li>Les clés sonts uniques.</li>
<li>Les valeurs peuvent être en doublons.</li>
<li>Les paires sont toujours ordonnées peu importe le nombre d&#8217;insertions.</li>
<li>L&#8217;ordre se fait sur les valeurs, qu&#8217;on appelle le score.</li>
</ul>
<p>En gros, c&#8217;est comme un dictionnaire, mais ordonné, qui ressemble à :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: black;">&#123;</span>
    <span style="color: #483d8b;">'cle'</span>: <span style="color: #ff4500;">789789</span>
    <span style="color: #483d8b;">'cle2'</span>: <span style="color: #ff4500;">78999</span>
    <span style="color: #483d8b;">'cle3'</span>: <span style="color: #ff4500;">6</span>
<span style="color: black;">&#125;</span></pre></td></tr></table></div>

<p>Comme toutes les structures de données un peu exotiques, on se demande à quoi ça sert d&#8217;avoir des caratéristiques aussi précises et ce qu&#8217;on peut bien en faire.</p>
<p>La réponse est comme d&#8217;hab, &#8220;plein de choses&#8221;, mais nous on va en faire un compteur :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">datetime</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">import</span> redis
&nbsp;
<span style="color: #808080; font-style: italic;"># connection à redis</span>
con <span style="color: #66cc66;">=</span> redis.<span style="color: black;">StrictRedis</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># On appelle cette vue avec ajax, ignorant les</span>
<span style="color: #808080; font-style: italic;"># utilisateurs sans JS qui de toute façon sont des </span>
<span style="color: #808080; font-style: italic;"># anarco communistes qui ne rapportent</span>
<span style="color: #808080; font-style: italic;"># pas d'argent et fument des joins</span>
<span style="color: #808080; font-style: italic;"># Cette partie dépend de votre framework</span>
<span style="color: #66cc66;">@</span>ajax<span style="color: black;">&#40;</span><span style="color: #483d8b;">'/counter'</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">def</span> add_user_count<span style="color: black;">&#40;</span>request<span style="color: black;">&#41;</span>:
&nbsp;
    <span style="color: #808080; font-style: italic;"># la clé d'accès à notre sorted set</span>
    counter_key <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">&quot;users:online&quot;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># un id unique pour notre visiteur. Ca dépend du</span>
    <span style="color: #808080; font-style: italic;"># framework web</span>
    user_id <span style="color: #66cc66;">=</span> request.<span style="color: black;">session</span>.<span style="color: #008000;">id</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># Calcul du timestamp de maintenant et d'il y a 10 minutes</span>
    <span style="color: #808080; font-style: italic;"># car ils vont nous servir de score max et min.</span>
    now <span style="color: #66cc66;">=</span> <span style="color: black;">&#40;</span><span style="color: #dc143c;">datetime</span>.<span style="color: black;">utcnow</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> - <span style="color: #dc143c;">datetime</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">1970</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>.<span style="color: black;">total_seconds</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
    ten_minutes_ago <span style="color: #66cc66;">=</span> now - <span style="color: black;">&#40;</span><span style="color: #ff4500;">60</span> * <span style="color: #ff4500;">10</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># On ajoute l'utilisateur dans le sorted set. S'il existait déjà, son</span>
    <span style="color: #808080; font-style: italic;"># ancienne valeur est remplacée, sinon elle est créée. Comme c'est</span>
    <span style="color: #808080; font-style: italic;"># forcément le plus récent timestamp, il est tout en haut du sorted set</span>
    con.<span style="color: black;">zadd</span><span style="color: black;">&#40;</span>counter_key<span style="color: #66cc66;">,</span> now<span style="color: #66cc66;">,</span> user_id<span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># Le sorted set ressemble donc à ça :</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># {</span>
&nbsp;
    <span style="color: #808080; font-style: italic;">#     &quot;userid&quot;: 809809890, # timestamp de dernière requete</span>
    <span style="color: #808080; font-style: italic;">#     &quot;userid2&quot;: 809809885, # timestamp plus ancien</span>
    <span style="color: #808080; font-style: italic;">#     &quot;userid3&quot;: 809809880 # timestamp encore plus ancien</span>
    <span style="color: #808080; font-style: italic;">#     ...</span>
    <span style="color: #808080; font-style: italic;"># }</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># On retire toutes les entrées du sorted set avec un score</span>
    <span style="color: #808080; font-style: italic;"># qui est plus petit que le timestamp d'il y a 10 minutes</span>
    <span style="color: #808080; font-style: italic;"># histoire de pas saturer la mémoire.</span>
    con.<span style="color: black;">zremrangebyscore</span><span style="color: black;">&#40;</span>online_user_key<span style="color: #66cc66;">,</span> <span style="color: #ff4500;">0</span><span style="color: #66cc66;">,</span> ten_minutes_ago<span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># Et on récupére le nombre de visiteurs en ligne entre maintenant</span>
    <span style="color: #808080; font-style: italic;"># et 10 minutes.</span>
    visitors <span style="color: #66cc66;">=</span> con.<span style="color: black;">zcount</span><span style="color: black;">&#40;</span>online_user_key<span style="color: #66cc66;">,</span> ten_minutes_ago<span style="color: #66cc66;">,</span> now<span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">return</span> visitors</pre></td></tr></table></div>

<p>Notez que toutes ces étapes sont très rapides, que ce soit l&#8217;insertion, la suppression ou le compte du total grâce aux fantastiques perfs de Redis. J&#8217;aime Redis. Je suce la bite de Redis goulument.</p>
<p>La précision n&#8217;est pas parfaite, mais compter les utilisateurs est plus un art (divinatoire) qu&#8217;une science et avoir un chiffre précis à 2, 3% prêt est suffisant pour nous.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/utilisateurs-en-ligne-avec-le-sorted-set-de-redis/feed/</wfw:commentRss>
		<slash:comments>7</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2015/07/Capture-du-2015-07-25-104217.png" length="134036" type="image/jpg" />	</item>
		<item>
		<title>Redis : pourquoi et comment ? 23</title>
		<link>http://sametmax.com/redis-pourquoi-et-comment/</link>
		<comments>http://sametmax.com/redis-pourquoi-et-comment/#comments</comments>
		<pubDate>Tue, 14 Oct 2014 11:31:17 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[hash]]></category>
		<category><![CDATA[hyperloglog]]></category>
		<category><![CDATA[list]]></category>
		<category><![CDATA[pub/sub]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[redis]]></category>
		<category><![CDATA[set]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=12279</guid>
		<description><![CDATA[Redis fait partie de ces technologies tellement utiles et simples à mettre en oeuvre qu'il est facile d'oublier toutes les personnes qui ne savent toujours pas ce que c'est. D'autant plus qu'on l'associe avec beaucoup d'étiquettes : cache, queues, pub/sub, base de données, nosql... Et qu'est-ce que Redis comparé à Memcache, MongoDB, MySQL, RabbitMQ, des technos qui n'ont rien à voir et auxquelles on le compare ?

Bref, c'est pas clair tout ça.]]></description>
				<content:encoded><![CDATA[<p>Redis fait partie de ces technologies tellement utiles et simples à mettre en oeuvre qu&#8217;il est facile d&#8217;oublier toutes les personnes qui ne savent toujours pas ce que c&#8217;est. D&#8217;autant plus qu&#8217;on l&#8217;associe avec beaucoup d&#8217;étiquettes : cache, queues, pub/sub, base de données, nosql&#8230; Et qu&#8217;est-ce que Redis comparé à Memcache, MongoDB, MySQL, RabbitMQ, des technos qui n&#8217;ont rien à voir et auxquelles on le compare ?</p>
<p>Bref, c&#8217;est pas clair tout ça.</p>
<p><span class='embed-youtube' style='text-align:center; display: block;'><iframe class='youtube-player' type='text/html' width='1170' height='689' src='http://www.youtube.com/embed/6VAkOhXIsI0?version=3&#038;rel=1&#038;fs=1&#038;showsearch=0&#038;showinfo=1&#038;iv_load_policy=1&#038;wmode=transparent' frameborder='0' allowfullscreen='true'></iframe></span></p>
<h2>Hello redis</h2>
<h3>D&#8217;abord, installer le bouzin. </h3>
<p>Si vous êtes sous Linux, Redis est dans votre gestionnaire de paquets. Par exemple, sous Ubuntu :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">sudo</span> <span style="color: #c20cb9; font-weight: bold;">apt-get install</span> redis-server</pre></td></tr></table></div>

<p>Pour Mac, via macport :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">sudo</span> port <span style="color: #c20cb9; font-weight: bold;">install</span> redis
<span style="color: #c20cb9; font-weight: bold;">sudo</span> port load redis</pre></td></tr></table></div>

<p>Je crois que <code>brew install redis</code> marche aussi pour les amateurs de homebrew.</p>
<p>Pour Windows, il y a un exe à télécharger <a href="https://github.com/MSOpenTech/redis/blob/2.8/bin/release/redis-2.8.17.zip">ici</a>.</p>
<p>Mais le plus fun avec redis, c&#8217;est que même quand il y a pas de binaire, c&#8217;est le truc le plus facile du monde <a href="https://github.com/MSOpenTech/redis/blob/2.8/bin/release/redis-2.8.17.zip">à compiler.</a> Et Dieu sait que je hais la compilation, donc quand je vous dis que c&#8217;est simple, c&#8217;est que c&#8217;est mega, ultra, simple.</p>
<h3>Ensuite lui faire dire bonjour.</h3>
<p>Utiliser Redis se fait à base de commandes, dont <a href="http://redis.io/commands">la liste est sur le site officiel</a>. On peut envoyer ces commandes depuis n&#8217;importe quel langage, mais Redis fournit un shell qui permet de rentrer ces commandes directement:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">$ redis-cli <span style="color: #666666; font-style: italic;"># lancer le shell redis</span>
127.0.0.1:<span style="color: #000000;">6379</span><span style="color: #000000; font-weight: bold;">&gt;</span>  ECHO <span style="color: #ff0000;">&quot;Hello&quot;</span>
<span style="color: #ff0000;">&quot;Hello&quot;</span></pre></td></tr></table></div>

<h2>Redis comme base de données clés/valeurs expirables</h2>
<p>L&#8217;usage de base de Redis, c&#8217;est de stocker des valeurs associées à des clés. Le serveur Redis est comme un gigantesque Hash Map, dictionnaire Python, object Javascript, Array associatif en PHP&#8230; En premier lieu, donc, on utilise Redis pour stocker des choses ainsi :</p>
<pre>"cle1" => valeur1
"cle2" => valeur2
etc</pre>
<p>La clé doit être une chaîne de caractères, de préférence ASCII. La valeur peut être n&#8217;importe quoi, vraiment, mais généralement c&#8217;est un gros bloc de texte, un entier ou un blob binaire.</p>
<p>Ca s&#8217;utilise avec les commandes <code>SET</code> et <code>GET</code>, qui peuvent, comme toutes les commandes, être tapées dans le shell de Redis :</p>
<pre>127.0.0.1:6379> GET une_cle
(nil)
127.0.0.1:6379> SET une_cle "Une valeur"
OK
127.0.0.1:6379> GET une_cle
"Une valeur"
127.0.0.1:6379> SET une_cle 780708
OK
127.0.0.1:6379> GET une_cle
"780708"</pre>
<p>Ce genre d&#8217;usage est surtout sollicité pour stocker des paramètres de configurations ou des compteurs.</p>
<p>En effet, la plupart des opérations sur les clés sont atomiques, rendant ce genre d&#8217;usage idéal. On peut même incrémenter ou décrémenter une valeur avec <code>INCR</code> et <code>DECR</code> atomiquement :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">127.0.0.1:<span style="color: #000000;">6379</span><span style="color: #000000; font-weight: bold;">&gt;</span> INCR une_cle
<span style="color: #7a0874; font-weight: bold;">&#40;</span>integer<span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #000000;">780709</span>
127.0.0.1:<span style="color: #000000;">6379</span><span style="color: #000000; font-weight: bold;">&gt;</span> INCR une_cle
<span style="color: #7a0874; font-weight: bold;">&#40;</span>integer<span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #000000;">780710</span>
127.0.0.1:<span style="color: #000000;">6379</span><span style="color: #000000; font-weight: bold;">&gt;</span> DECR une_cle
<span style="color: #7a0874; font-weight: bold;">&#40;</span>integer<span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #000000;">780709</span>
127.0.0.1:<span style="color: #000000;">6379</span><span style="color: #000000; font-weight: bold;">&gt;</span></pre></td></tr></table></div>

<p>Vous allez me dire, mais quel intérêt ? Je peux déjà faire ça avec une variable. Certes, mais Redis est accessible depuis n&#8217;importe quel programme de votre serveur. Vous pouvez donc facilement partager des valeurs entre vos processus. Par exemple, avec Django, on a souvent plusieurs workers WSGI, et Redis permet donc de partager des informations entre ces workers. Pour cette raison, on peut utiliser Redis pour créer un <a href="https://github.com/antirez/redlock-rb">lock partagé</a>.</p>
<p>Ainsi, un paramètre dynamique peut être changé et lu depuis tous les process de votre projet en utilisant Redis, et la valeur sera garantie d&#8217;être à jour. On peut bien entendu faire ça avec une base de données ordinaire, mais Redis a un plus : la performance.</p>
<p>En effet, Redis est par défaut configuré pour garder toutes les données de sa base en mémoire vive. Pour cette raison, il est très, très rapide, supportant 100000 lectures/écritures par seconde. Si vous comptez le nombre de visiteurs en ligne pour l&#8217;afficher sur chaque page, votre base de données vous dira merci de plutôt demander à Redis.</p>
<p>Plus encore, les clés peuvent expirer :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">127.0.0.1:<span style="color: #000000;">6379</span><span style="color: #000000; font-weight: bold;">&gt;</span> SET une_autre_cle <span style="color: #ff0000;">&quot;Tu ne le sais pas mais tu es deja mort&quot;</span>
OK
127.0.0.1:<span style="color: #000000;">6379</span><span style="color: #000000; font-weight: bold;">&gt;</span> EXPIRE une_autre_cle <span style="color: #000000;">5</span> <span style="color: #666666; font-style: italic;"># cette clé expire dans 5 secondes</span>
<span style="color: #7a0874; font-weight: bold;">&#40;</span>integer<span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #000000;">1</span>
127.0.0.1:<span style="color: #000000;">6379</span><span style="color: #000000; font-weight: bold;">&gt;</span> GET une_autre_cle
<span style="color: #ff0000;">&quot;Tu ne le sais pas mais tu es deja mort&quot;</span>
127.0.0.1:<span style="color: #000000;">6379</span><span style="color: #000000; font-weight: bold;">&gt;</span> GET une_autre_cle
<span style="color: #ff0000;">&quot;Tu ne le sais pas mais tu es deja mort&quot;</span>
127.0.0.1:<span style="color: #000000;">6379</span><span style="color: #000000; font-weight: bold;">&gt;</span> GET une_autre_cle
<span style="color: #ff0000;">&quot;Tu ne le sais pas mais tu es deja mort&quot;</span>
127.0.0.1:<span style="color: #000000;">6379</span><span style="color: #000000; font-weight: bold;">&gt;</span> GET une_autre_cle
<span style="color: #7a0874; font-weight: bold;">&#40;</span>nil<span style="color: #7a0874; font-weight: bold;">&#41;</span>
127.0.0.1:<span style="color: #000000;">6379</span><span style="color: #000000; font-weight: bold;">&gt;</span> GET une_autre_cle
<span style="color: #7a0874; font-weight: bold;">&#40;</span>nil<span style="color: #7a0874; font-weight: bold;">&#41;</span></pre></td></tr></table></div>

<p>La limite en taille de ce qu&#8217;on peut stocker par couple est <a href="http://sametmax.com/les-limites-theoriques-de-redis/">assez large</a>.</p>
<p>On peut également utiliser <code>EXPIREAT</code> et un timestamp unique si on a une date en tête.</p>
<p>Cette caractéristique le rend similaire à Memcache, qui est basé sur des clés/valeurs en mémoire qui peuvent expirer. Et comme Memcache, cela fait de Redis un outil idéal pour gérer du cache : faites une opération longue, stockez-là avec une clé, mettez lui une date d&#8217;expiration et pouf, vous avez une valeur cachée globale à votre app.</p>
<p>Redis a néanmoins 3 différences majeures qui le sépare de Memcache :</p>
<ul>
<li>Redis sauvegarde régulièrement toutes les données sur le disque. Si vous rebootez le serveur, vous perdez au pire, quelques secondes de données. Avec Memcache, vous perdez tout.</li>
<li>Memcache possède des fonctionalités de clusterisation que n&#8217;a pas encore Redis, bien que ce soit actuellement en beta.</li>
<li>Redis peut faire bien plus que du stockage clé/valeur.</li>
</ul>
<h2>Redis comme base NoSQL zarbie</h2>
<p>Redis n&#8217;a pas besoin d&#8217;un schéma particulier à définir pour pouvoir sauvegarder ses données, mais n&#8217;est pas pour autant limité à une forme d&#8217;organisation basique. En fait, des types très proches de ceux qu&#8217;on trouve dans le langage Python sont disponibles pour stocker internalement les données, et ils sont <a href="http://redis.io/topics/data-types-intro">décrits dans son excellente doc</a>.</p>
<h3>Liste</h3>
<p>Une <a href="http://redis.io/commands#list">liste</a> est juste une collection ordonnée d&#8217;éléments. On utilise toujours la logique de clé, mais au lieu d&#8217;une valeur, on a une séquence d&#8217;éléments.</p>
<p>Cela permet d&#8217;avoir :</p>
<pre>cle => [
	valeur1,
	valeur2,
	...
]</pre>
<p>Dans le shell :</p>
<pre>127.0.0.1:6379> lpush batman na
(integer) 1
127.0.0.1:6379> lpush batman na
(integer) 2
127.0.0.1:6379> lpush batman na
(integer) 3
127.0.0.1:6379> lpush batman na
(integer) 4
127.0.0.1:6379> lpush batman na
(integer) 5
127.0.0.1:6379> lpush batman na
(integer) 6
127.0.0.1:6379> llen batman
(integer) 6
127.0.0.1:6379> LINDEX batman 3
"na"
127.0.0.1:6379> LINDEX batman 10
(nil)
127.0.0.1:6379> LRANGE batman 0 -1 # du début au dernier élément
1) "na"
2) "na"
3) "na"
4) "na"
5) "na"
6) "na"
127.0.0.1:6379> LRANGE batman 2 3
1) "na"
2) "na"
127.0.0.1:6379></pre>
<p>On peut faire toutes les opérations qu&#8217;on a l&#8217;habitude de faire sur des listes : récupérer un élément, en ajouter un, en retirer un, faire du LIFO, du FIFO, du pipo, etc.</p>
<p>Utile pour créer des files d&#8217;attente, des journaux d&#8217;évènements (pensez jeux vidéos) ou plus simplement une valeur de config plus complexe qu&#8217;une entrée.</p>
<h3>Hash</h3>
<p><a href="http://redis.io/commands#hash">Le Hash</a> se comporte comme un Hash Map, dictionnaire Python, object Javascript, Array associatif en PHP&#8230; Bref, comme Redis lui-même en fait, mais sans expiration de clé. Cela permet d&#8217;avoir :</p>
<pre>cle => {
	cle : valeur,
	cle : valeur,
}</pre>
<p>Dans le shell :</p>
<pre>127.0.0.1:6379> HSET scores titi 1
(integer) 1
127.0.0.1:6379> HSET scores grosminet 0
(integer) 1
127.0.0.1:6379> HSET scores tom 0
(integer) 1
127.0.0.1:6379> HSET scores jerry 1
(integer) 1
127.0.0.1:6379> HGET scores jerry
"1"
127.0.0.1:6379> HGETALL scores
1) "titi"
2) "1"
3) "grosminet"
4) "0"
5) "tom"
6) "0"
7) "jerry"
8) "1"
127.0.0.1:6379></pre>
<p>Notez encore une fois qu&#8217;il n&#8217;est pas utile de vérifier que la clé existe avant de rajouter une valeur dans le hash, bien qu&#8217;il y ait une commande pour le faire. Si on essaye de récupérer une clé qui n&#8217;existe pas, Redis retourne <code>nil</code>.</p>
<p>Le hash est fort pratique pour toute forme de compteurs groupés, ou juste pour mettre en cache des relations. Redis n&#8217;ayant pas de <code>JOIN</code>, on utilise parfois un hash pour faire le lien entre deux listes par exemple.</p>
<h3>Set</h3>
<p>Comme les sets en Python, le <a href="http://redis.io/commands#set">set</a> est une collection NON ordonnée d&#8217;éléments uniques. Il ne peut pas y avoir de doublons dans un set, et vérifier si un élément fait partie d&#8217;un set est une opération très rapide. Ils permettent aussi de faire des opérations ensemblistes de manière performante, par exemple vérifier quels éléments d&#8217;un set sont ou non dans un autre set.</p>
<pre>cle => { valeur1, valeur2, ...}</pre>
<p>Dans le shell :</p>
<pre>127.0.0.1:6379> SADD ip 192.168.1.1
(integer) 1
127.0.0.1:6379> SADD ip 192.168.1.1 # ajouter 2x le même ne fait rien
(integer) 0
127.0.0.1:6379> SADD ip 192.168.1.1
(integer) 0
127.0.0.1:6379> SADD ip 192.168.1.2
(integer) 1
127.0.0.1:6379> SADD ip 192.168.1.3
(integer) 1
127.0.0.1:6379> SCARD ip
(integer) 3
127.0.0.1:6379> SMEMBERS ip
1) "192.168.1.2"
2) "192.168.1.1"
3) "192.168.1.3"
127.0.0.1:6379> SADD ip:banned 192.168.1.3 # le ":" est une séparateur courant pour les clés
(integer) 1
127.0.0.1:6379> SADD ip:banned 192.168.1.10 # ip:banned est un AUTRE set
(integer) 1
127.0.0.1:6379> SINTER ip ip:banned # trouver les IP qui sont dans les 2 sets
1) "192.168.1.3"</pre>
<p>On va utiliser les sets pour éviter les doublons (tirage au sort par exemple) ou pour vérifier facilement une appartenance (notion de groupes, de permissions, etc.).</p>
<p>Le set possède une variante, le <a href="http://redis.io/commands#sorted_set">set ordonné</a>, qui associe à chaque élément du set un score. On peut changer ce score, l&#8217;incrémenter ou le décrémenter atomiquement, avoir deux scores égaux&#8230; Et au final, récupérer le set dans l&#8217;ordre ascendant ou descendant des scores. </p>
<pre>cle => { valeur1 (1), valeur2 (3), ...}</pre>
<p>Dans le shell :</p>
<pre>127.0.0.1:6379> zadd participants 1 staline
(integer) 1
127.0.0.1:6379> zadd participants 1 hitler
(integer) 1
127.0.0.1:6379> zadd participants 2 "pol pot"
(integer) 1
127.0.0.1:6379> zadd participants 1999 "rainbow dash"
(integer) 1
127.0.0.1:6379> zrange participants 0 - 1
(error) ERR value is not an integer or out of range
127.0.0.1:6379> zrange participants 0 -1 
1) "hitler"
2) "staline"
3) "pol pot"
4) "rainbow dash"
127.0.0.1:6379> zrange participants 0 -1 withscores
1) "hitler"
2) "1"
3) "staline"
4) "1"
5) "pol pot"
6) "2"
7) "rainbow dash"
8) "1999"
</pre>
<h3>HyperLogLog</h3>
<p>J&#8217;ai déjà parlé de l&#8217;HyperLogLog <a href="http://sametmax.com/le-compteur-mal-connu-lhyperloglog/">ici</a> et <a href="http://redis.io/commands#hyperloglog">celui de Redis</a> fonctionne pareil. Cette structure de données permettra de faire des compteurs d&#8217;éléments uniques, comme par exemple un compteur de visiteurs ou de gens connectés, qui soit approximatif (+ ou &#8211; 1%) mais prenne une taille fixe en mémoire.</p>
<p>Dans le shell :</p>
<pre>127.0.0.1:6379> PFADD connectes toto
(integer) 1
127.0.0.1:6379> PFADD connectes toto
(integer) 0
127.0.0.1:6379> PFADD connectes toto
(integer) 0
127.0.0.1:6379> PFADD connectes tata
(integer) 1
127.0.0.1:6379> PFADD connectes titi
(integer) 1
127.0.0.1:6379> PFADD connectes tutu
(integer) 1
127.0.0.1:6379> PFADD connectes tutu
(integer) 0
127.0.0.1:6379> PFADD connectes tutu
(integer) 0
127.0.0.1:6379> PFADD connectes tete
(integer) 1
127.0.0.1:6379> PFADD connectes bob
(integer) 1
127.0.0.1:6379> PFcount connectes
(integer) 6
127.0.0.1:6379>
</pre>
<h2>Redis comme super pote de Python</h2>
<p>Vu que Redis est simple à installer et à configurer, c&#8217;est un outil qu&#8217;on dégaine facilement, même pour un petit script, pas forcément pour une grosse app Web. Par exemple, je fais une analyse de mon serveur, plutôt que de stocker le résultat dans un fichier, je peux mettre tout ça dans Redis, c&#8217;est tellement pratique.</p>
<p>D&#8217;abord, la <a href="https://pypi.python.org/pypi/redis/">lib</a> pour communiquer avec Redis est à un <a href="http://sametmax.com/votre-python-aime-les-pip/">pip</a> du clavier :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">pip <span style="color: #c20cb9; font-weight: bold;">install</span> redis</pre></td></tr></table></div>

<p>Ensuite, si vous utilisez le client <code>StrictRedis</code>, l&#8217;API est exactement la même que les commandes du shell :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">import</span> redis
<span style="color: #66cc66;">&gt;&gt;&gt;</span> r <span style="color: #66cc66;">=</span> redis.<span style="color: black;">StrictRedis</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> r.<span style="color: black;">hgetall</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'scores'</span><span style="color: black;">&#41;</span>
<span style="color: black;">&#123;</span>b<span style="color: #483d8b;">'titi'</span>: b<span style="color: #483d8b;">'1'</span><span style="color: #66cc66;">,</span> b<span style="color: #483d8b;">'tom'</span>: b<span style="color: #483d8b;">'0'</span><span style="color: #66cc66;">,</span> b<span style="color: #483d8b;">'jerry'</span>: b<span style="color: #483d8b;">'1'</span><span style="color: #66cc66;">,</span> b<span style="color: #483d8b;">'grosminet'</span>: b<span style="color: #483d8b;">'0'</span><span style="color: black;">&#125;</span></pre></td></tr></table></div>

<p>Il existe aussi des drivers asynchrones pour tornado, twisted et asyncio.</p>
<h2>Redis comme message broker</h2>
<p>J&#8217;aime le <a href="http://redis.io/commands#pubsub">pub/sub</a>, je pense qu&#8217;après mon <a href="http://sametmax.com/introduction-a-wamp-en-python/">enthousiasme</a> pour WAMP.ws, c&#8217;est clair.</p>
<p>Redis met à disposition des primitives pour créer des files d&#8217;attente de messages et les lire, comme une version simplifiée de RabbitMQ ou Crossbar.io. Pour que ce soit intéressant, il nous faut deux process. D&#8217;abord un shell Python qui écoute les messages arrivant sur la file &#8220;sametmax&#8221; :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">import</span> redis
<span style="color: #66cc66;">&gt;&gt;&gt;</span> r <span style="color: #66cc66;">=</span> redis.<span style="color: black;">StrictRedis</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> listener <span style="color: #66cc66;">=</span> r.<span style="color: black;">pubsub</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> listener.<span style="color: black;">subscribe</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #483d8b;">'sametmax'</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">for</span> item <span style="color: #ff7700;font-weight:bold;">in</span> listener.<span style="color: black;">listen</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
...     <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>item<span style="color: black;">&#41;</span>
...</pre></td></tr></table></div>

<p>Le code va bloquer, et affichera quelque chose à chaque fois qu&#8217;il reçoit un message.</p>
<p>Du coup si je fais ceci dans le shell Redis :</p>
<pre>127.0.0.1:6379> publish sametmax yolo
(integer) 1
127.0.0.1:6379> publish sametmax carpediem
(integer) 1
127.0.0.1:6379> publish sametmax wololo
(integer) 1
127.0.0.1:6379> publish sametmax2 oyooyo
(integer) 0
127.0.0.1:6379></pre>
<p>Mon shell python va afficher :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: black;">&#123;</span><span style="color: #483d8b;">'type'</span>: <span style="color: #483d8b;">'subscribe'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'pattern'</span>: <span style="color: #008000;">None</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'channel'</span>: b<span style="color: #483d8b;">'sametmax'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'data'</span>: <span style="color: #ff4500;">1</span><span style="color: black;">&#125;</span>
<span style="color: black;">&#123;</span><span style="color: #483d8b;">'type'</span>: <span style="color: #483d8b;">'message'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'pattern'</span>: <span style="color: #008000;">None</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'channel'</span>: b<span style="color: #483d8b;">'sametmax'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'data'</span>: b<span style="color: #483d8b;">'yolo'</span><span style="color: black;">&#125;</span>
<span style="color: black;">&#123;</span><span style="color: #483d8b;">'type'</span>: <span style="color: #483d8b;">'message'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'pattern'</span>: <span style="color: #008000;">None</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'channel'</span>: b<span style="color: #483d8b;">'sametmax'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'data'</span>: b<span style="color: #483d8b;">'carpediem'</span><span style="color: black;">&#125;</span>
<span style="color: black;">&#123;</span><span style="color: #483d8b;">'type'</span>: <span style="color: #483d8b;">'message'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'pattern'</span>: <span style="color: #008000;">None</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'channel'</span>: b<span style="color: #483d8b;">'sametmax'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'data'</span>: b<span style="color: #483d8b;">'wololo'</span><span style="color: black;">&#125;</span></pre></td></tr></table></div>

<p>Il n&#8217;a pas affiché <code>oyooyo</code> puisque c&#8217;est sur une autre channel.</p>
<p>C&#8217;est une méthode assez simple de faire du pub/sub. C&#8217;est bas niveau, il n&#8217;y a pas de RPC, il faut boucler à la main et créer soit-même la mécanique pour arrêter d&#8217;écouter ou faire du multitask, mais c&#8217;est facile pour débuter. Pour cette raison, plein de gens utilisent une solution bricolée là-dessus pour faire du pub/sub.</p>
<h2>Et donc</h2>
<p>Non seulement Redis est facile à installer, simple à utiliser et performant, mais en plus il est accessible depuis de nombreux langages. Ajoutez à cela ses très nombreuses fonctionnalités, et vous avez là un système qui est installé par défaut sur la plupart de mes serveurs. Par ailleurs, suivez <a href="http://antirez.com/latest/0">le blog de l&#8217;auteur</a>, ce mec est un génie. Il écrit pas souvent, mais quand il écrit, c&#8217;est passionant, et humble. C&#8217;est beau.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/redis-pourquoi-et-comment/feed/</wfw:commentRss>
		<slash:comments>23</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2014/10/BkUjyyCCQAA3i_T.jpg-medium.jpg" length="41148" type="image/jpg" />	</item>
		<item>
		<title>Le compteur mal connu : l&#8217;HyperLogLog 13</title>
		<link>http://sametmax.com/le-compteur-mal-connu-lhyperloglog/</link>
		<comments>http://sametmax.com/le-compteur-mal-connu-lhyperloglog/#comments</comments>
		<pubDate>Tue, 07 Oct 2014 14:02:58 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[redis]]></category>
		<category><![CDATA[sets]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=12353</guid>
		<description><![CDATA[Non, <a href="https://en.wikipedia.org/wiki/HyperLogLog">ce n'est pas une faute de frappe</a>. l'HyperLogLog est un algo qui permet de compter approximativement des éléments uniques en prenant très peu de mémoire.
]]></description>
				<content:encoded><![CDATA[<p>Non, <a href="https://en.wikipedia.org/wiki/HyperLogLog">ce n&#8217;est pas une faute de frappe</a>. l&#8217;HyperLogLog est un algo qui permet de compter approximativement des éléments uniques en prenant très peu de mémoire.</p>
<p>Prenez par exemple un compteur d&#8217;IP uniques. En Python, on l&#8217;implémenterait en mettant les adresses IP dans un <code>set()</code> (puisqu&#8217;ils éliminent les doublons) et pour obtenir le nombre d&#8217;IP uniques, on ferait <code>len()</code> sur le <code>set</code>.</p>
<p>Une bonne stratégie, performante (les sets sont très rapides pour ce genre d&#8217;usage), simple, mais avec un défaut : la taille du <code>set</code> ne va cesser d&#8217;augmenter au fur et à mesure qu&#8217;on le remplit d&#8217;IP puisqu&#8217;il nous faut l&#8217;historique de toutes celles rencontrées pour éviter les doublons.</p>
<p>L&#8217;HyperLogLog répond à cette problématique : il tient un journal probabiliste qui va se remplir au fur et à mesure qu&#8217;on rencontre des nouveaus éléments. On peut ensuite demander au journal combien d&#8217;éléments uniques il a rencontré, et il répond avec une marge d&#8217;erreur.</p>
<p><strong>Avantage </strong>: la taille en mémoire est fixe.<br />
<strong>Désavantage </strong>: le compteur n&#8217;est pas parfaitement précis.</p>
<p>La précision obtenue est dépendante de la place en mémoire, par exemple si on on tolère 1% d&#8217;erreur, le journal prendra au maximum 12kb, permettant de compter jusqu&#8217;à 2^64 items.</p>
<p>Bref, si vous faites juste un compteur à afficher en pied de page de votre site, c&#8217;est un très bon compromis. On peut accepter d&#8217;avoir un peu plus ou un peu moins de visiteurs que la réalité qui s&#8217;affiche, sachant que la stat elle-même n&#8217;est pas vraiment réprésentative de la réalité (IP != de visiteurs uniques).</p>
<p>En Python, il existe une lib (uniquement 2.7 il me semble) pour ça :</p>
<pre lang="bash>pip install hyperloglog</pre>
<p>Et ça s&#8217;utilise très simplement :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">import</span> hyperloglog<span style="color: #66cc66;">,</span> <span style="color: #dc143c;">random</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> hll <span style="color: #66cc66;">=</span> hyperloglog.<span style="color: black;">HyperLogLog</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">0.01</span><span style="color: black;">&#41;</span>  <span style="color: #808080; font-style: italic;"># on accepte une erreur de 1%</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> hll.<span style="color: black;">add</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;119.250.66.95&quot;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #008000;">len</span><span style="color: black;">&#40;</span>hll<span style="color: black;">&#41;</span>  
<span style="color: #ff4500;">1</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> hll.<span style="color: black;">add</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;119.250.66.95&quot;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #008000;">len</span><span style="color: black;">&#40;</span>hll<span style="color: black;">&#41;</span>  
<span style="color: #ff4500;">1</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> hll.<span style="color: black;">add</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;219.81.118.147&quot;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #008000;">len</span><span style="color: black;">&#40;</span>hll<span style="color: black;">&#41;</span>  
<span style="color: #ff4500;">2</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">xrange</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">1000</span><span style="color: black;">&#41;</span>:
... <span style="color: black;">ip</span> <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">&quot;.&quot;</span>.<span style="color: black;">join</span><span style="color: black;">&#40;</span><span style="color: #008000;">str</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">random</span>.<span style="color: black;">randint</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">255</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">range</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">4</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
... <span style="color: #ff7700;font-weight:bold;">print</span> ip
... <span style="color: black;">hll</span>.<span style="color: black;">add</span><span style="color: black;">&#40;</span>ip<span style="color: black;">&#41;</span>
114.208.49.91
11.72.239.16
67.56.229.66
191.62.59.163
61.104.232.43
110.58.69.141
246.123.30.234
244.246.65.219
98.93.193.114
185.143.143.69
191.177.161.213
...
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #008000;">len</span><span style="color: black;">&#40;</span>hll<span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># 1000 items unique. Environ :)</span>
<span style="color: #ff4500;">1004</span></pre></td></tr></table></div>

<p>Vous pouvez également profiter de l&#8217;HyperLogLog via une <a href="http://tapoueh.org/blog/2013/02/25-postgresql-hyperloglog">extension PostGres</a> ou en utilisant une version récente de <a href="http://redis.io/commands#hyperloglog">Redis</a>.</p>
<p>La plupart des compteurs sur les sites sont complètement bidons, alors vous, honnête que vous êtes, embrassez l&#8217;approximatif ! C&#8217;est presque la vérité. Presque.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/le-compteur-mal-connu-lhyperloglog/feed/</wfw:commentRss>
		<slash:comments>13</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2014/10/verite12.jpg" length="42937" type="image/jpg" />	</item>
		<item>
		<title>NoSQL : arrêtons de dire n&#8217;importe quoi 39</title>
		<link>http://sametmax.com/nosql-arretons-de-dire-nimporte-quoi/</link>
		<comments>http://sametmax.com/nosql-arretons-de-dire-nimporte-quoi/#comments</comments>
		<pubDate>Sat, 22 Mar 2014 10:26:06 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[cassandra]]></category>
		<category><![CDATA[couchdb]]></category>
		<category><![CDATA[elastic search]]></category>
		<category><![CDATA[memecache]]></category>
		<category><![CDATA[mongodb]]></category>
		<category><![CDATA[mysql]]></category>
		<category><![CDATA[nosql]]></category>
		<category><![CDATA[postgre]]></category>
		<category><![CDATA[redis]]></category>
		<category><![CDATA[riak]]></category>
		<category><![CDATA[solr]]></category>
		<category><![CDATA[sql]]></category>
		<category><![CDATA[sqlite]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=9844</guid>
		<description><![CDATA[J'ai regardé le mouvement NoSQL évoluer au fil des années. On y retrouve à peu prêt tout ce qui fait l'informatique depuis que le monde IT est monde : brillance et troll, hype et génie, utile et gadget, buzz et fact, sam et max, etc.]]></description>
				<content:encoded><![CDATA[<p>J&#8217;ai regardé le mouvement NoSQL évoluer au fil des années. On y retrouve à peu près tout ce qui fait l&#8217;informatique depuis que le monde IT est monde : brillance et troll, hype et génie, utile et gadget, buzz et fact, sam et max, etc.</p>
<p>De plus on peut mettre n&#8217;importe quoi sous le label NoSQL, et du coup ça a été fait. En fait un fichier est déjà une base de données NoSQL :)</p>
<p>Mais rant mise à part, des projets comme redis, riak, elastic search ou mongodb changent vraiment la donne.</p>
<p>Malheureusement, tout comme d&#8217;autres technos du moment (prog asychrone, tout-http, pre-processeurs, generateurs&#8230;), les gens ont tendance à l&#8217;utiliser comme la barre de fer, la silver bullet, le passe-partout, le tournevis sonique, bref, le truc à tout faire.</p>
<p>L&#8217;adage populaire dit &#8220;quand on a un bon marteau, tous les problèmes ressemblent à des clous&#8221;. Or, je constate qu&#8217;au dessus de ça, les dev appliquent aussi souvent le dicton préféré d&#8217;un de mes colocs : &#8220;arrête de taper si fort, prend un plus gros marteau&#8221;. </p>
<p>Ca donne du NoSQL utilisé partout, pour tout, brandi comme LA solution, vendu à des débutants comme une panacée de traitement d&#8217;informations. Zob, vous vous doutez bien que ça pose problème, non ?</p>
<h2>Anti-fact 1 : NoSql, c&#8217;est plus facile pour démarrer</h2>
<p>Il n&#8217;existe pas à l&#8217;heure actuelle de base NoSQL embarquée qui arrive à la cheville de SQLite : ça marche partout, dans tous les langages, sans rien à avoir installer ou configurer pour la plupart des langages.</p>
<p>Dès que vous demandez à un débutant d&#8217;installer un truc, vous rajoutez une barrière d&#8217;entrée énorme.</p>
<p>De plus, il y a beaucoup, beaucoup, beaucoup plus d&#8217;hébergeurs qui fournissent du SQL que du NoSQL en solution par défaut. Et comme toute les technos legacy, il y a 100 fois plus de doc.</p>
<p>Enfin, il y a la fameuse question du &#8220;quoi&#8221; ? Quel système allez-vous installer ? Couch ? Casssandra ? Mongo ? On parle de NoSQL, ou de schemaless ? C&#8217;est pas la même chose ? Memcache et Redis, c&#8217;est que pour le cache ? Elastic Search, c&#8217;est que pour la recherche de texte ? Les données géographiques, je les mets dans quoi, mongo ou un GIS spécialisé ? Attends, j&#8217;ai entendu parler d&#8217;une super bdd de graph&#8230;</p>
<p>L&#8217;abondance de solutions, le manque de recul et les informations contradictoires disponibles rendent non seulement le choix difficile, mais en plus hasardeux. Car contrairement au monde du SQL, se gourrer en NoSQL peut vous pourir toute votre archi.</p>
<p>Souvenez-vous qu&#8217;il est beaucoup plus difficile de migrer son système de base de données NoSQL d&#8217;une solution à une autre car il n&#8217;y a pas ce petit détail en commun entre les produits : le SQL justement.</p>
<h2>Anti-fact 2 : Avec NoSql, pas besoin de réfléchir à son modèle de données</h2>
<p>Je crois que c&#8217;est ce qui me fait le plus grincer des dents. Les gens qui disent qu&#8217;on peut tout mettre dedans, hop, et on verra plus tard. J&#8217;ai vu les pires modèles de données possibles stockés en MongoDb ou Redis, parceque les gars qui avaient travaillé dessus avait juste dumpé leurs données sans réfléchir.</p>
<p>Une base NoSQL ne vous oblige pas à formaliser votre schéma, mais ça ne veut CERTAINEMENT PAS dire qu&#8217;il ne faut pas le faire. L&#8217;auteur de Redis a très bien <a rhef="http://oldblog.antirez.com/post/reply-open-minded-reader.html">expliqué le problème</a> (je graisse pour donner une effet dramatique et puissant au message) :</p>
<blockquote><p>Redis is not the kind of system where you can insert data and then argue about how to fetch those data in creative ways. Not at all, the whole idea of its data model, and part of the fact that it will be so fast to retrieve your data, is that <strong>you need to think in terms of organising your data for fetching</strong>. You need to design with the query patterns in mind.</p></blockquote>
<p>C&#8217;est vrai pour tout système dans lequel on met ses données, SQL, NoSQL, fichier, mémoire, le tiroir de votre bureau&#8230;</p>
<p>Il faut penser au type des données, leurs formats, les relations entre les éléments, comment et à quelle fréquence vous allez les écrire, les lire, garantir la consistence de leurs relations et leur fraicheur (ou pas d&#8217;ailleurs, mais il faut en faire le choix). Les bases SQL sont contraignantes parce qu&#8217;elles vous obligent à penser, dès le début, en ces termes.</p>
<p>C&#8217;est vrai, vous êtes de grandes personnes, a priori vous savez ce que vous faites, vous n&#8217;avez pas besoin qu&#8217;on vous FORCE à le faire. C&#8217;est pour ça que j&#8217;aime le typage dynamique. Je ne veux pas que tu me demandes mes papiers pour déclarer une variable, je sais ce que je fais.</p>
<p>Seulement <strong>il faut le faire</strong>, et ce n&#8217;est souvent pas fait. Pire, le modèle n&#8217;est généralement jamais formalisé NULLE PART. Un schéma, c&#8217;est une doc. Sans doc, le coût d&#8217;entrée dans votre projet est élevé, sa maintenance est galère, le potentiel de bug lors de l&#8217;évolution est plus grand. Mais une doc c&#8217;est chiant à écrire et à tenir à jour.</p>
<p>C&#8217;est un des intéressants effets secondaires des ORMs : les classes de définition sont le modèle documenté dans sa structure, ses relations, ses limites, ses contraintes, ses tests et vérifications, etc. La doc par le code, j&#8217;adore.</p>
<h2>Anti-fact 3 : NoSql, c&#8217;est plus performant</h2>
<p>A chaque fois qu&#8217;on lit &#8220;x est plus performant que z&#8221;, il faut faire une pause et réfléchir deux minutes. Généralement il y a un piège.</p>
<p>Les performances, ça dépend toujours du contexte. Par exemple, Redis est plus performant à la lecture et l&#8217;écriture, mais les données doivent tenir en RAM, sinon ça bouffe sur la mémoire virtuelle. Autre chose, Redis est très lent à démarrer sur des gros jeux de données (ça peut aller à plusieurs minutes si vous avez des Go). MongoDB doit normalement pouvoir tenir une augmentation de charge de manière prédictive en rajoutant des noeuds. Mais sur un seul noeud, c&#8217;est toujours moins performant qu&#8217;un PostGres. Et 0.01 % des sites ont besoin de plus d&#8217;un serveur.</p>
<p>Par ailleurs, les performances sont très dépendantes de l&#8217;anti-fact 2. Il faut créer les bons index, avoir un cache correctement ajusté, faire des requêtes intelligentes. Pour tous les systèmes.</p>
<p>Bref, encore une fois, NoSQL n&#8217;est pas une techno magique. Il est contre-productif, et j&#8217;ai envie de dire même irrespectueux envers ses collègues, de la vendre comme telle.</p>
<h2>Anti-fact 4 : NoSQL remplace le SQL</h2>
<p>Tweeter tourne sur MySQL ET Memcache.</p>
<p>Stackoverflow utiliser SQL Server 2008 ET Redis.</p>
<p>Il y a carrément des sites qui <a href="http://www.plotprojects.com/why-we-use-postgresql-and-slick/">utilisent PostGres et MongoDb en parallèle</a>. En fait, il y a <a href="http://www.infoq.com/news/2013/02/MoSQL">des outils</a> pour les faire collaborer. </p>
<p>Nous sur notre plus gros site on utilise Redis pour les sessions, les compteurs, les crawlers, les queues et passer des données entre process. <strong>Pas juste pour le cache.</strong> On utilise PostGres pour les données complexes avec des queries lourdes. Et on utilise Solr pour le moteur de recherche. </p>
<p>Les bases NoSQL sont des nouveaux outils, qui sont mieux adaptés à CERTAINS usages ou à CERTAINS contextes. Pas tout, tout le temps, partout. C&#8217;est un outil en plus, pas un obligatoire remplaçant.</p>
<p>Par ailleurs, on peut utiliser PostGres comme une base de données <a href="http://thebuild.com/presentations/pg-as-nosql-pgday-fosdem-2013.pdf">clé-valeur</a> ou <a href="http://www.reddit.com/comments/1q3skb">JSON</a>, on peut mettre SQLite complètement en mémoire vive, on peut utiliser MySQL comme un moteur de recherche de texte&#8230; Multiplier les points of failures dans une archi n&#8217;est pas toujours une bonne idée. Ces outils qu&#8217;on considère comme de l&#8217;histoire ancienne ont beaucoup plus de ressource que vous ne l&#8217;imaginez. Ils sont ultra performants. Des années et des années d&#8217;optimisation.</p>
<p>Le monde de la tech n&#8217;est jamais lisse. Jamais.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/nosql-arretons-de-dire-nimporte-quoi/feed/</wfw:commentRss>
		<slash:comments>39</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2014/03/tumblr_n2sg6nrtxX1r539hzo1_500.jpg" length="80694" type="image/jpg" />	</item>
		<item>
		<title>La stack techno qu&#8217;on utilise pour faire un site Web, et pourquoi 29</title>
		<link>http://sametmax.com/la-stack-techno-quon-utilise-pour-faire-un-site-web-et-pourquoi/</link>
		<comments>http://sametmax.com/la-stack-techno-quon-utilise-pour-faire-un-site-web-et-pourquoi/#comments</comments>
		<pubDate>Mon, 11 Nov 2013 06:40:38 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[celery]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[fabric]]></category>
		<category><![CDATA[mysql]]></category>
		<category><![CDATA[nginx]]></category>
		<category><![CDATA[nosql]]></category>
		<category><![CDATA[postgres]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[redis]]></category>
		<category><![CDATA[vm]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=7648</guid>
		<description><![CDATA[Une stack techno n'est pas une référence. Il n'y a pas de combo absolu qui rox absolument tout, c'est une question de contexte technique, financier, humain...

Mais c'est vrai que ça aide bien d'avoir sous les yeux les pratiques des autres.]]></description>
				<content:encoded><![CDATA[<p>Une stack techno n&#8217;est pas une référence. Il n&#8217;y a pas de combo absolu qui rox absolument tout, c&#8217;est une question de contexte technique, financier, humain&#8230;</p>
<p>Mais c&#8217;est vrai que ça aide bien d&#8217;avoir sous les yeux les pratiques des autres.</p>
<p>Je ne vais pas expliquer pourquoi Python, <a href="http://sametmax.com/10-raisons-pour-lesquelles-je-suis-toujours-marie-a-python/">je l&#8217;ai déjà fait</a>.</p>
<p>Commençons plutôt par la partie purement Web, pour laquelle on utilise Django, le framework Web Python.</p>
<p>Max et moi avons tout deux fait du PHP avant, j&#8217;ai tâté des frameworks internes, du Symfony et plus tard du Zope. J&#8217;ai regardé du côté de Pyramid et de ses prédécesseurs, et Django est celui qui me plaît le plus. J&#8217;ai juste un peu forcé la main à Max :-)</p>
<p>Car oui, le framework a été avant tout un choix de goût.</p>
<p>Ce n&#8217;est pas un choix de performances : le framework n&#8217;a aucun impact dessus. Aucun. Les architectures ont un impact. Le framework, non. Votre bottleneck sera sur les IO, pas sur le CPU. Le choix de technos asynchrones peut avoir un impact, mais ce n&#8217;est pas une question de framework. Tornado, Twisted ou NodeJS, on s&#8217;en fout. </p>
<p>Donc Django, essentiellement parce qu&#8217;il me plait. Et il me plaît pour ces raisons :</p>
<ul>
<li>Il y a un bon équilibre entre découplage et intégration. En général c&#8217;est soit très découplé et mal intégré, soit très bien intégré et très couplé.</li>
<li>C&#8217;est bien foutu et bien documenté. Et c&#8217;est stable. Vraiment très stable. Les core devs sont hyper sérieux.</li>
<li>C&#8217;est très versatile et ça peut faire plein de trucs out of the box, petits comme gros.</li>
<li>C&#8217;est assez facile à apprendre. Ça reste un framework, donc ce n&#8217;est pas la plus simple des démarches, mais dans le royaume des frameworks de cette taille, ça reste vraiment le plus simple.</li>
<li>La communauté est fantastique : il y a des centaines d&#8217;apps qui couvrent pratiquement tous les besoins.</li>
<li>Et bien entendu, c&#8217;est en Python.</li>
</ul>
<p>En terme de base de données, on a fait du MySQL pendant longtemps. Ça a plutôt bien marché. Maintenant je commence mes nouveaux projets avec PostGres, qui est plus solide. Parfois je fais juste du Sqlite, parce que ça suffit.</p>
<p>Pas de NoSQL. Après plusieurs expériences avec MongoDB et CouchDB, je n&#8217;ai pas été convaincu que les bénéfices dépassaient le coût. Il faudrait un article complet là-dessus (qu&#8217;on m&#8217;a d&#8217;ailleurs demandé).</p>
<p>Question OS. c&#8217;est du CentOS avec Max (il a plus l&#8217;habitude) ou du Ubuntu Server pour mes autres projets. Je reste sur les LTS. Ce n&#8217;est pas un choix très réfléchi, c&#8217;est surtout par habitude.</p>
<p>Pas de machine virtuelle. On a essayé, sans y trouver un grand intérêt :</p>
<ul>
<li>Il faut quand même faire des scripts de migration, donc autant s&#8217;en servir pour le déploiement.</li>
<li>On perd en perfs.</li>
<li>Les erreurs liées au mal-fonctionnement d&#8217;une VM sont absolument indébuggables.</li>
<li>Si on ne fait pas la VM soit-même, il faut mettre ses couilles dans les mains d&#8217;un prestataire de service. J&#8217;ai horreur de ça.</li>
<li>Trouver des gens avec la compétence pour gérer une VM, c&#8217;est difficile. Un script de déploiement, c&#8217;est du code que tout dev saura déjà lire. Par extension ça veut dire que je m&#8217;y replonge facilement des semaines plus tard.</li>
</ul>
<p>Et donc pour le déploiement, j&#8217;utilise <a href="http://sametmax.com/travailler-moins-pour-gagner-plus-en-15-minutes-avec-python-fabric/">fabric</a>, avec <a href="https://github.com/ronnix/fabtools/">fabtools</a>.</p>
<p>Ce n&#8217;est pas la solution la plus efficace, d&#8217;autant que ça limite à Python 2.7, mais c&#8217;est la plus simple. C&#8217;est juste du code Python. N&#8217;importe qui peut comprendre le déploiement en 15 minutes. Ça se modifie vite, s&#8217;adapte facilement. </p>
<p>Il faut comprendre qu&#8217;on a jamais plus d&#8217;une dizaine de serveurs pour un projet, ces choix sont donc faits en fonction de cela. Il va sans dire que si vous gérez un parc de centaines de machines, ça ne sera pas du tout le même choix technique. Peut être que Chef ou des VM seront alors carrément plus intéressants. Peut être que le NoSQL et sa capacité au scaling sera bien plus rentable.</p>
<p>Il ne s&#8217;agit pas de décrier les technos que nous n&#8217;utilisons pas. Il s&#8217;agit juste de dire, voilà les choix que nous avons faits, dans tel contexte, pour telles (bonnes ou mauvaises) raisons.</p>
<p>Durant les dernières années, on a ajouté <a href="http://redis.io/">Redis</a> à notre stack. C&#8217;est un outil fantastique qui sert à tout : de la base de données pour les trucs simples (il y a des fois ou un schéma est overkill) à la solution de caching. C&#8217;est ce qu&#8217;on a de plus proche du NoSQL.</p>
<p>L&#8217;outil est tellement simple à installer (vraiment le degré zero de la maintenance, c&#8217;est beau) et à utiliser que ça ne vaut juste pas le coup de s&#8217;en priver. </p>
<p>Du coup, plus de memcache. Toutes les grosses requêtes sont sauvegardées dans Redis, dès qu&#8217;on fait un script qui a besoin de persistance temporaire, Redis, pour communiquer entre plusieurs process, Redis, pour toutes les opérations qui ont besoin de grosses perfs comme les stats, Redis. Vive Redis.</p>
<p>D&#8217;ailleurs on utilise Redis aussi comme broker pour notre gestionnaire de queues et de taches : <a href="sametmax.com/files-de-taches-et-taches-recurrentes-avec-celery/">celery</a>. Si vous pythonez, je vous recommande chaudement celery pour toutes les tâches en background, les crawlers, les chaînes de process, etc.</p>
<p>On a aussi du moteur de recherche. Là on tape dans du <a href="http://lucene.apache.org/solr/">Solr</a> (avec <a href="http://haystacksearch.org/">haystack</a>). C&#8217;est très puissant, en tout cas syntaxiquement car ça ne fait pas de sémantique. Ne vous attendez donc pas à rattraper Google. Mais c&#8217;est aussi méga chiant à configurer et très lourd. Je pense qu&#8217;un jour on va migrer sur <a href="http://www.elasticsearch.org/">ElasticSearch</a>, mais c&#8217;est pas la priorité. Don&#8217;t fix what ain&#8217;t broken.</p>
<p>Devant tout ça on a <a href="http://nginx.org/">Nginx</a>. Comme beaucoup on a fait Apache => Cherokee => lighttp => nginx. Et franchement, je ne reviendrai jamais en arrière : plus léger, plus rapide, plus facile à installer et à configurer, plus versatile. Nginx fait tout, et mieux. </p>
<p>En proxy on a du <a href="http://gunicorn.org/">gunicorn</a>. Parce qu&#8217;on avait la flemme de configurer uwsgi et qu&#8217;on a pris l&#8217;habitude.</p>
<p>Après on utilise plein de libs, de petits outils, etc. Mais ça c&#8217;est le gros de notre archi.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/la-stack-techno-quon-utilise-pour-faire-un-site-web-et-pourquoi/feed/</wfw:commentRss>
		<slash:comments>29</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2013/11/nZ9b9.jpg" length="67160" type="image/jpg" />	</item>
		<item>
		<title>Files de tâches et tâches récurrentes avec Celery 24</title>
		<link>http://sametmax.com/files-de-taches-et-taches-recurrentes-avec-celery/</link>
		<comments>http://sametmax.com/files-de-taches-et-taches-recurrentes-avec-celery/#comments</comments>
		<pubDate>Sat, 27 Jul 2013 07:57:12 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[celery]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[redis]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=6880</guid>
		<description><![CDATA[Quand on a traiter des choses bloquantes, avec des dépendances, des flux complexes ou des actions répétitives, créer des files d'attente peut se révéler très judicieux.
]]></description>
				<content:encoded><![CDATA[<p>Quand on a à traiter des choses bloquantes, avec des dépendances, des flux complexes ou des actions répétitives, créer des files d&#8217;attente peut se révéler très judicieux.</p>
<p>Par exemple lancer la génération d&#8217;un gros zip sur le clic d&#8217;un utilisateur, télécharger plein fichiers en parallèle pour son site de cul, lancer des calculs sur plusieurs machines et récupérer le résultat, encoder des videos en arrière plan, etc.</p>
<p>Le problème, c&#8217;est que fabriquer des files d&#8217;attente à la main, ça mène généralement à une grosse galère. La première boîte dans laquelle j&#8217;ai travaillé avait tout un système de queues à base de PHP + SQL fait à la main qui tapait dans du MySQL, c&#8217;était pas marrant du tout</p>
<p>Je fais une pause, et je note que le potentiel de jeux de mots sur cet article est fortement élevé. Mais je resterai fort.</p>
<p>Locking, priorité, dépendance, asynchronicité, concurrence, sérialisation, encoding, stockage, accessibilité, load balancing&#8230; Toutes ces problématiques sont bien vicieuses et chronophages. Il vaut mieux utiliser une lib solide et éprouvée.</p>
<p>Je resterai fort.</p>
<p><a href="https://pypi.python.org/pypi/kombu/2.2.0">Kombu</a> est une telle lib, mais elle est lourde et complexe à utiliser. J&#8217;avais fais le choix de la prendre pour un gros projet avec Max, je le regrette sur le long terme : c&#8217;est dur à maintenir et à faire évoluer. Le code est vraiment pas sympa.</p>
<p>Heureusement il existe une bibliothèque qui se met au dessus de Kombu pour et nous expose juste les fonctionnalités que l&#8217;on souhaite : <a href="http://www.celeryproject.org/">celery</a>.</p>
<p>Fort.</p>
<p>Celery est simple pour démarrer, mais très puissant si on rentre dans le détail, et croyez moi, le détail, on peut y rentrer très très profondément.</p>
<p>F&#8230;</p>
<h2>Installation</h2>
<p>Qui dit file d&#8217;attente, dit stockage. Il faut bien mettre les tâches quelque part et communiquer avec ce quelque part. En base de données ? Dans un gestionnaire de messages ? En mémoire ? Dans un cache ?</p>
<p>Celery résout le problème en proposant la même interface, quelque soit le support. Actuellement, on peut utiliser :</p>
<ul>
<li>RabbitMQ</li>
<li>Redis</li>
<li>MongoDB</li>
<li>Beanstalk CouchDB</li>
<li>SQLAlchemy ou l&#8217;ORM Django (et donc toutes les bases de données supportées comme Sqlite, MySQL, PostGres&#8230;)</li>
<li>Amazon SQS</li>
</ul>
<p>Dans notre exemple, nous allons le faire avec Redis car :</p>
<ul>
<li>Redis est très simple à installer et à configurer.</li>
<li>Nous on utilise déjà du Redis partout.</li>
<li>Aucun risque de locking.</li>
</ul>
<p>Pour ceux qui ont pas redis, c&#8217;est généralement dans les dépôts. Par exemple sur Ubuntu :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">sudo</span> <span style="color: #c20cb9; font-weight: bold;">apt-get install</span> redis-server</pre></td></tr></table></div>

<p>Il n&#8217;y a rien à faire de plus, ça tourne, c&#8217;est configuré avec des valeurs par défaut qui sont saines. Je vous l&#8217;ai dis, redis, c&#8217;est fantastiquement bien foutu.</p>
<p>Ensuite on install celery et la lib d&#8217;accès à redis en Python qui porte un nom très original :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">pip <span style="color: #c20cb9; font-weight: bold;">install</span> celery redis</pre></td></tr></table></div>

<p>Ca devrait compiler un peu, et comme hab avec les extensions en C, assurez vous d&#8217;avoir un compilateur et les headers en place comme indiqué dans l&#8217;article sur <a href="http://sametmax.com/votre-python-aime-les-pip/">pip</a>.</p>
<p>Ensuite on peut créer ses tâches. Créez un module, par exemple <em>tasks.py</em> :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">urllib2</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">collections</span> <span style="color: #ff7700;font-weight:bold;">import</span> Counter
&nbsp;
<span style="color: #ff7700;font-weight:bold;">from</span> celery <span style="color: #ff7700;font-weight:bold;">import</span> Celery
&nbsp;
<span style="color: #808080; font-style: italic;"># Configuration de celery. Ceci peut aussi se faire dans un fichier de config.</span>
<span style="color: #808080; font-style: italic;"># Ici on dit à celery que pour le module 'tasks', on va utiliser redis</span>
<span style="color: #808080; font-style: italic;"># comme broker (passeur de massage) et comme result backend (stockage du</span>
<span style="color: #808080; font-style: italic;"># resultat des tâches).</span>
celery <span style="color: #66cc66;">=</span> Celery<span style="color: black;">&#40;</span><span style="color: #483d8b;">'tasks'</span><span style="color: #66cc66;">,</span> broker<span style="color: #66cc66;">=</span><span style="color: #483d8b;">'redis://localhost'</span><span style="color: #66cc66;">,</span> backend<span style="color: #66cc66;">=</span><span style="color: #483d8b;">'redis://localhost'</span><span style="color: black;">&#41;</span>
&nbsp;
&nbsp;
<span style="color: #808080; font-style: italic;"># Et voici notre première tâche. C'est une fonction Python normale, décorée</span>
<span style="color: #808080; font-style: italic;"># avec un decorateur de celery. Elle prend une URL, et calcule le nombre</span>
<span style="color: #808080; font-style: italic;"># de lettre &quot;e&quot; qu'il y a dans la page.</span>
<span style="color: #66cc66;">@</span>celery.<span style="color: black;">task</span>
<span style="color: #ff7700;font-weight:bold;">def</span> ecount<span style="color: black;">&#40;</span>url<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">return</span> Counter<span style="color: black;">&#40;</span><span style="color: #dc143c;">urllib2</span>.<span style="color: black;">urlopen</span><span style="color: black;">&#40;</span>url<span style="color: black;">&#41;</span>.<span style="color: black;">read</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: black;">&#91;</span><span style="color: #483d8b;">'e'</span><span style="color: black;">&#93;</span></pre></td></tr></table></div>

<p>On lance ensuite le processus celery dans un terminal (en production, mettez ça dans supervisord ou systemd pour que ça démarre automatiquement) :</p>
<pre>
[test] sam ~/Bureau/celery_test $ celery -A tasks worker -B --loglevel=info

 -------------- celery@sam v3.0.21 (Chiastic Slide)
---- **** -----
--- * ***  * -- Linux-3.2.0-48-generic-x86_64-with-Ubuntu-12.04-precise
-- * - **** ---
- ** ---------- [config]
- ** ---------- .> broker:      redis://localhost:6379//
- ** ---------- .> app:         tasks:0x2a2fa50
- ** ---------- .> concurrency: 4 (processes)
- *** --- * --- .> events:      OFF (enable -E to monitor this worker)
-- ******* ----
--- ***** ----- [queues]
 -------------- .> celery:      exchange:celery(direct) binding:celery


[Tasks]
  . tasks.ecount

[2013-07-26 13:22:21,631: INFO/Beat] Celerybeat: Starting..
[2013-07-26 13:04:51,274: WARNING/MainProcess] celery@sam ready.
[2013-07-26 13:04:51,280: INFO/MainProcess] consumer: Connected to redis://localhost:6379//.
</pre>
<p><code>-A</code> précise le module à importer, <code>-B</code> démarre le beat (on verra ça plus tard), <code>worker</code> dit à celery que démarrer des processus de consommation de files d&#8217;attente (par défaut 4 qui travaillent en parallèle), et <code>--loglevel=info</code> va nous permettre d&#8217;avoir un affichage verbeux pour comprendre ce qui se passe.</p>
<p>Votre file d&#8217;attente est prête, et frétille d&#8217;impatience.</p>
<h2>Lancer une tâche</h2>
<p>A partir de là, vous pouvez envoyer des tâches dans la file d&#8217;attente, depuis n&#8217;importe où :</p>
<ul>
<li>Un script.</li>
<li>Un serveur Web (par exemple une vue Django).</li>
<li>Un programme sur un autre serveur (même si il faudrait alors configurer redis pour qu&#8217;il écoute sur les ports extérieurs, ce qui n&#8217;est pas le cas ici par simplicité).</li>
<li>etc</li>
</ul>
<p>Plusieurs programmes peuvent envoyer plein de tâches, en même temps, et elles vont se loger dans la file d&#8217;attente, sans bloquer le programme qui les a envoyé.</p>
<p>Par exemple, depuis le shell :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">from</span> tasks <span style="color: #ff7700;font-weight:bold;">import</span> ecount
<span style="color: #66cc66;">&gt;&gt;&gt;</span> res <span style="color: #66cc66;">=</span> ecount.<span style="color: black;">delay</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'http://danstonchat.com'</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Ceci ne bloque pas mon shell, la ligne s&#8217;exécute immédiatement. La fonction <code>ecount</code> n&#8217;est pas appelée depuis le shell, elle est dans la file d&#8217;attente et sera appelée par un des processus (les fameux &#8216;worker&#8217;) qui consomment la queue. Du côté de la file, on peut voir dans le log :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #000000;">2013</span>-07-<span style="color: #000000;">26</span> <span style="color: #000000;">14</span>:<span style="color: #000000;">18</span>:08,<span style="color: #000000;">609</span>: INFO<span style="color: #000000; font-weight: bold;">/</span>MainProcess<span style="color: #7a0874; font-weight: bold;">&#93;</span> Got task from broker: tasks.ecount<span style="color: #7a0874; font-weight: bold;">&#91;</span>599a52ea-ef6b-<span style="color: #000000;">4499</span>-981d-cd17fab592df<span style="color: #7a0874; font-weight: bold;">&#93;</span>
<span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #000000;">2013</span>-07-<span style="color: #000000;">26</span> <span style="color: #000000;">14</span>:<span style="color: #000000;">18</span>:09,070: INFO<span style="color: #000000; font-weight: bold;">/</span>MainProcess<span style="color: #7a0874; font-weight: bold;">&#93;</span> Task tasks.ecount<span style="color: #7a0874; font-weight: bold;">&#91;</span>599a52ea-ef6b-<span style="color: #000000;">4499</span>-981d-cd17fab592df<span style="color: #7a0874; font-weight: bold;">&#93;</span> succeeded <span style="color: #000000; font-weight: bold;">in</span> 0.446974039078s: <span style="color: #000000;">1242</span></pre></td></tr></table></div>

<p>On a donc notre tâche qui a bien été traitée.</p>
<p>On peut récupérer le résultat dans le shell :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> res.<span style="color: black;">state</span>
<span style="color: #483d8b;">'PENDING'</span></pre></td></tr></table></div>

<p>Ah&#8230; La tâche n&#8217;est pas encore terminée. Et un peu plus tard :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> res.<span style="color: black;">state</span>
<span style="color: #483d8b;">'SUCCESS'</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> res.<span style="color: black;">result</span>
<span style="color: #ff4500;">1242</span></pre></td></tr></table></div>

<p>Lancer une tâche est bien entendu peu intéressant, les listes d&#8217;attente sont vraiment sympa quand on a plein de tâches à lancer, par plein de processus différents :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">results <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span>ecount.<span style="color: black;">delay</span><span style="color: black;">&#40;</span>url<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> url <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: black;">&#40;</span><span style="color: #483d8b;">'http://google.com'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'http://sametmax.com'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'http://sebsauvage.com'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'http://multiboards.com'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'http://0bin.net'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'http://danstonchat.com'</span><span style="color: black;">&#41;</span><span style="color: black;">&#93;</span></pre></td></tr></table></div>


<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #000000;">2013</span>-07-<span style="color: #000000;">26</span> <span style="color: #000000;">14</span>:<span style="color: #000000;">25</span>:<span style="color: #000000;">46</span>,<span style="color: #000000;">646</span>: INFO<span style="color: #000000; font-weight: bold;">/</span>MainProcess<span style="color: #7a0874; font-weight: bold;">&#93;</span> Got task from broker: tasks.ecount<span style="color: #7a0874; font-weight: bold;">&#91;</span>5d072a7b-29f8-4ea6-8d92-6a4c1740d724<span style="color: #7a0874; font-weight: bold;">&#93;</span>
<span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #000000;">2013</span>-07-<span style="color: #000000;">26</span> <span style="color: #000000;">14</span>:<span style="color: #000000;">25</span>:<span style="color: #000000;">46</span>,<span style="color: #000000;">649</span>: INFO<span style="color: #000000; font-weight: bold;">/</span>MainProcess<span style="color: #7a0874; font-weight: bold;">&#93;</span> Got task from broker: tasks.ecount<span style="color: #7a0874; font-weight: bold;">&#91;</span>402f6a4f-6b35-4f62-a786-9a5ba27707d2<span style="color: #7a0874; font-weight: bold;">&#93;</span>
<span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #000000;">2013</span>-07-<span style="color: #000000;">26</span> <span style="color: #000000;">14</span>:<span style="color: #000000;">25</span>:<span style="color: #000000;">46</span>,<span style="color: #000000;">650</span>: INFO<span style="color: #000000; font-weight: bold;">/</span>MainProcess<span style="color: #7a0874; font-weight: bold;">&#93;</span> Got task from broker: tasks.ecount<span style="color: #7a0874; font-weight: bold;">&#91;</span>bbe46b1b-<span style="color: #000000;">4719</span>-4c42-bd2f-21e4d72e613e<span style="color: #7a0874; font-weight: bold;">&#93;</span>
<span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #000000;">2013</span>-07-<span style="color: #000000;">26</span> <span style="color: #000000;">14</span>:<span style="color: #000000;">25</span>:<span style="color: #000000;">46</span>,<span style="color: #000000;">652</span>: INFO<span style="color: #000000; font-weight: bold;">/</span>MainProcess<span style="color: #7a0874; font-weight: bold;">&#93;</span> Got task from broker: tasks.ecount<span style="color: #7a0874; font-weight: bold;">&#91;</span>8fb35186-66e2-4eae-a40c-fc42e500ab9d<span style="color: #7a0874; font-weight: bold;">&#93;</span>
<span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #000000;">2013</span>-07-<span style="color: #000000;">26</span> <span style="color: #000000;">14</span>:<span style="color: #000000;">25</span>:<span style="color: #000000;">46</span>,<span style="color: #000000;">653</span>: INFO<span style="color: #000000; font-weight: bold;">/</span>MainProcess<span style="color: #7a0874; font-weight: bold;">&#93;</span> Got task from broker: tasks.ecount<span style="color: #7a0874; font-weight: bold;">&#91;</span>fc63f5db-8ade-<span style="color: #000000;">4383</span>-b719-c3d6390ca246<span style="color: #7a0874; font-weight: bold;">&#93;</span>
<span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #000000;">2013</span>-07-<span style="color: #000000;">26</span> <span style="color: #000000;">14</span>:<span style="color: #000000;">25</span>:<span style="color: #000000;">46</span>,<span style="color: #000000;">654</span>: INFO<span style="color: #000000; font-weight: bold;">/</span>MainProcess<span style="color: #7a0874; font-weight: bold;">&#93;</span> Got task from broker: tasks.ecount<span style="color: #7a0874; font-weight: bold;">&#91;</span>8434e21d-79ea-<span style="color: #000000;">4559</span>-a90e-92e2bc2b9dc7<span style="color: #7a0874; font-weight: bold;">&#93;</span>
<span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #000000;">2013</span>-07-<span style="color: #000000;">26</span> <span style="color: #000000;">14</span>:<span style="color: #000000;">25</span>:<span style="color: #000000;">47</span>,<span style="color: #000000;">144</span>: INFO<span style="color: #000000; font-weight: bold;">/</span>MainProcess<span style="color: #7a0874; font-weight: bold;">&#93;</span> Task tasks.ecount<span style="color: #7a0874; font-weight: bold;">&#91;</span>bbe46b1b-<span style="color: #000000;">4719</span>-4c42-bd2f-21e4d72e613e<span style="color: #7a0874; font-weight: bold;">&#93;</span> succeeded <span style="color: #000000; font-weight: bold;">in</span> 0.479865789413s: <span style="color: #000000;">27</span>
<span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #000000;">2013</span>-07-<span style="color: #000000;">26</span> <span style="color: #000000;">14</span>:<span style="color: #000000;">25</span>:<span style="color: #000000;">47</span>,<span style="color: #000000;">242</span>: INFO<span style="color: #000000; font-weight: bold;">/</span>MainProcess<span style="color: #7a0874; font-weight: bold;">&#93;</span> Task tasks.ecount<span style="color: #7a0874; font-weight: bold;">&#91;</span>5d072a7b-29f8-4ea6-8d92-6a4c1740d724<span style="color: #7a0874; font-weight: bold;">&#93;</span> succeeded <span style="color: #000000; font-weight: bold;">in</span> 0.578661203384s: <span style="color: #000000;">609</span>
<span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #000000;">2013</span>-07-<span style="color: #000000;">26</span> <span style="color: #000000;">14</span>:<span style="color: #000000;">25</span>:<span style="color: #000000;">47</span>,<span style="color: #000000;">501</span>: INFO<span style="color: #000000; font-weight: bold;">/</span>MainProcess<span style="color: #7a0874; font-weight: bold;">&#93;</span> Task tasks.ecount<span style="color: #7a0874; font-weight: bold;">&#91;</span>fc63f5db-8ade-<span style="color: #000000;">4383</span>-b719-c3d6390ca246<span style="color: #7a0874; font-weight: bold;">&#93;</span> succeeded <span style="color: #000000; font-weight: bold;">in</span> 0.35736989975s: <span style="color: #000000;">263</span>
<span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #000000;">2013</span>-07-<span style="color: #000000;">26</span> <span style="color: #000000;">14</span>:<span style="color: #000000;">25</span>:<span style="color: #000000;">47</span>,<span style="color: #000000;">645</span>: INFO<span style="color: #000000; font-weight: bold;">/</span>MainProcess<span style="color: #7a0874; font-weight: bold;">&#93;</span> Task tasks.ecount<span style="color: #7a0874; font-weight: bold;">&#91;</span>8434e21d-79ea-<span style="color: #000000;">4559</span>-a90e-92e2bc2b9dc7<span style="color: #7a0874; font-weight: bold;">&#93;</span> succeeded <span style="color: #000000; font-weight: bold;">in</span> 0.403187036514s: <span style="color: #000000;">1270</span>
<span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #000000;">2013</span>-07-<span style="color: #000000;">26</span> <span style="color: #000000;">14</span>:<span style="color: #000000;">25</span>:<span style="color: #000000;">47</span>,<span style="color: #000000;">815</span>: INFO<span style="color: #000000; font-weight: bold;">/</span>MainProcess<span style="color: #7a0874; font-weight: bold;">&#93;</span> Task tasks.ecount<span style="color: #7a0874; font-weight: bold;">&#91;</span>8fb35186-66e2-4eae-a40c-fc42e500ab9d<span style="color: #7a0874; font-weight: bold;">&#93;</span> succeeded <span style="color: #000000; font-weight: bold;">in</span> 1.14100408554s: <span style="color: #000000;">23</span>
<span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #000000;">2013</span>-07-<span style="color: #000000;">26</span> <span style="color: #000000;">14</span>:<span style="color: #000000;">25</span>:<span style="color: #000000;">49</span>,010: INFO<span style="color: #000000; font-weight: bold;">/</span>MainProcess<span style="color: #7a0874; font-weight: bold;">&#93;</span> Task tasks.ecount<span style="color: #7a0874; font-weight: bold;">&#91;</span>402f6a4f-6b35-4f62-a786-9a5ba27707d2<span style="color: #7a0874; font-weight: bold;">&#93;</span> succeeded <span style="color: #000000; font-weight: bold;">in</span> 2.34633708s: <span style="color: #000000;">3158</span></pre></td></tr></table></div>

<p>Car du coup on sait que ces multiples tâches ne vont pas bloquer le processus en cour, mais qu&#8217;en plus la charge sera répartie sur le nombre de workers qu&#8217;on a décidé au départ, ni plus (surcharge du serveur), ni moins (traitement trop lent).</p>
<h2>Comment je sais quand une tâche est terminée ?</h2>
<p>On peut attendre que la tâche soit terminée :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">print</span> res.<span style="color: black;">wait</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #ff4500;">9999</span></pre></td></tr></table></div>

<p>Mais ce n&#8217;est pas vraiment le but. On cherche avant tout à ce que les tâches soient non bloquantes, et exécutées dans un processus à part voir potentiellement distribuées sur plusieurs serveurs. </p>
<p>Par ailleurs, Celery n&#8217;est pas un remplacement d&#8217;un système de traitement asynchrone comme Tornado ou NodeJS, il n&#8217;est pas fait pour envoyer des réponses asynchrones à l&#8217;utilisateur. Il est fait pour faire des tâches en background, répartir la charge et ordonner le traitement. Bien entendu, on peut faire communiquer un système asynchrone avec celery comme <a href="https://github.com/mher/tornado-celery">ici</a> ou <a href="http://cyberfart.blogspot.fr/2012/11/tornado-celery-integration.html">ici</a>, mais c&#8217;est une autre histoire.</p>
<p>Concentrons nous sur les tâches.</p>
<p>La question de &#8220;Comment je sais quand une tâche est terminée ?&#8221; est souvent traduisible par &#8220;comment je réagis à une tâche pour lancer du code quand elle s&#8217;est terminée sans erreur ?&#8221;.</p>
<p>Et là, il y une solution toute simple :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">res <span style="color: #66cc66;">=</span> tache1.<span style="color: black;">s</span><span style="color: black;">&#40;</span>arg1<span style="color: #66cc66;">,</span> arg2<span style="color: black;">&#41;</span> | tache2.<span style="color: black;">s</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> | tache3.<span style="color: black;">s</span><span style="color: black;">&#40;</span>arg1<span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Ceci va créer une chaîne de tâches. Quand la première se termine, la deuxième se lance en recevant le résultat de la première en argument.</p>
<p><code>s()</code> fabrique une sous-tâche, c&#8217;est à dire une tâche à envoyer dans la file plus tard avec des arguments pré-enregistrés. Dans notre exemple, celery va lancer <code>tache1</code> avec deux arguments, puis si ça marche, va appeler <code>tache2</code> en lui passant le résultat de <code>tache1</code> comme argument, puis si ça marche, va appeler <code>tache3</code> avec le résultat de <code>tache2</code> en premier argument et <code>arg1</code> en second argument.</p>
<p>En fait, celery vient avec tout <a href="http://docs.celeryproject.org/en/latest/userguide/canvas.html?highlight=group">un tas d&#8217;outils</a> pour exécuter des tâches dépendantes les unes des autres : par groupes, par chaînes, par morceaux, etc. Mais de toute façon, vous pouvez appeler une tâche&#8230; à l&#8217;intérieur d&#8217;une autre tâche. Donc parti de là vous pouvez faire pas mal de choses.</p>
<h2>Comment je fais pour faire une tâche récurrente ?</h2>
<p>C&#8217;est là qu&#8217;intervient le &#8220;beat&#8221; dont j&#8217;ai parlé tout à l&#8217;heure. Avec cette option, celery va vérifier toutes les secondes si il n&#8217;y a pas une tâche répétitive à lancer, et la mettre dans une file d&#8217;attente, à la manière d&#8217;un cron.</p>
<p>Il suffit de définir une tâche comme <code>periodic_task</code> pour qu&#8217;elle soit lancée régulièrement.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">smtplib</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">from</span> celery.<span style="color: black;">schedules</span> <span style="color: #ff7700;font-weight:bold;">import</span> crontab
<span style="color: #ff7700;font-weight:bold;">from</span> celery.<span style="color: black;">decorators</span> <span style="color: #ff7700;font-weight:bold;">import</span> periodic_task
&nbsp;
<span style="color: #808080; font-style: italic;"># va executer la tâche à 5h30, 13h30 et 23h30 tous les lundi</span>
<span style="color: #808080; font-style: italic;"># run_every accepte aussi un timedelta, pour par exemple dire &quot;toutes les 10m&quot;</span>
<span style="color: #66cc66;">@</span>periodic_task<span style="color: black;">&#40;</span>run_every<span style="color: #66cc66;">=</span>crontab<span style="color: black;">&#40;</span>hour<span style="color: #66cc66;">=</span><span style="color: #483d8b;">'5,13,23'</span><span style="color: #66cc66;">,</span> minute<span style="color: #66cc66;">=</span><span style="color: #ff4500;">30</span><span style="color: #66cc66;">,</span> day_of_week<span style="color: #66cc66;">=</span><span style="color: #483d8b;">'monday'</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">def</span> is_alive<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;
        Vérifie que le blog est toujours en ligne, et si ce n'est pas le cas,
        envoie un mail en panique.
    &quot;&quot;&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #dc143c;">urllib2</span>.<span style="color: black;">urlopen</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'http://sametmax.com'</span><span style="color: black;">&#41;</span>.<span style="color: #dc143c;">code</span> <span style="color: #66cc66;">!=</span> <span style="color: #ff4500;">200</span>:
        mail <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">'lesametlemax__AT__gmail.com'</span>.<span style="color: black;">replace</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'__AT__'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'@'</span><span style="color: black;">&#41;</span>
        server <span style="color: #66cc66;">=</span> <span style="color: #dc143c;">smtplib</span>.<span style="color: black;">SMTP</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'smtp.gmail.com:587'</span><span style="color: black;">&#41;</span>
        server.<span style="color: black;">starttls</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
        server.<span style="color: black;">login</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'root'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'admin123'</span><span style="color: black;">&#41;</span>
        server.<span style="color: black;">sendmail</span><span style="color: black;">&#40;</span>mail<span style="color: #66cc66;">,</span> mail<span style="color: #66cc66;">,</span> msg<span style="color: black;">&#41;</span>
        server.<span style="color: black;">quit</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Il y a de <a href="http://docs.celeryproject.org/en/latest/userguide/periodic-tasks.html?highlight=cron">bons exemples</a> sur la syntaxe sur <code>crontab()</code> dans la doc.</p>
<p>D&#8217;une manière générale, <a href="http://docs.celeryproject.org/en/latest/getting-started/introduction.html">la doc de Celery est très très riche</a>, donc plongez vous dedans si cet article ne répond pas à vos besoins, car si ça peut être mis dans une file, ça peut être fait par Celery.</p>
<h2>Note de fin</h2>
<p>Celery n&#8217;autoreload pas le code, donc redémarrez les workers à chaque fois que vous modifiez vos tasks.</p>
<p>Attention aussi aux tâches récurrentes, la suivante peut se lancer avant que la précédente soit terminée. C&#8217;est à vous de faire des tâches <a href="https://fr.wikipedia.org/wiki/Idempotent">idempotentes</a>, ou alors de mettre en place <a href="http://docs.celeryproject.org/en/latest/tutorials/task-cookbook.html#cookbook-task-serial">un système de locking</a>.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/files-de-taches-et-taches-recurrentes-avec-celery/feed/</wfw:commentRss>
		<slash:comments>24</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2013/07/zdFRjr1.jpg" length="76872" type="image/jpg" />	</item>
		<item>
		<title>Comment Redis et Memcache font expirer leurs données 12</title>
		<link>http://sametmax.com/comment-redis-et-memcache-font-expirer-leurs-donnees/</link>
		<comments>http://sametmax.com/comment-redis-et-memcache-font-expirer-leurs-donnees/#comments</comments>
		<pubDate>Thu, 28 Feb 2013 12:04:02 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[architecture]]></category>
		<category><![CDATA[mecached]]></category>
		<category><![CDATA[redis]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=5184</guid>
		<description><![CDATA[Redis et Memcache ont des opérations d'insertion de complexité O(1) (très rapide). Malgré ça ils proposent tout deux l'expiration de clé.]]></description>
				<content:encoded><![CDATA[<p>Redis et Memcache ont des opérations d&#8217;insertion de complexité O(1) (très rapide). Malgré ça ils proposent tout deux l&#8217;expiration de clé.</p>
<p>Et je me suis demandé : comment ils font ? Comment je pourrais fais ça si je devais le coder en Python ?</p>
<p>En effet, rechercher une clé expirée prend du temps. J&#8217;ai pensé à utiliser <a href="http://sametmax.com/heapq-le-module-python-incompris/">heapq</a>, mais l&#8217;insertion serait en 0(log(n)) (temps dépendant du nombre d&#8217;items), donc rapide, mais loin des perfs de Redis et Memcache.</p>
<p>Même si on garde à l&#8217;esprit qu&#8217;ils sont codés en C, et donc plus rapide, ça m&#8217;a turlupiné. Comment ils font ces cons ?</p>
<p>La réponse est surprenant : ils font la même chose que <a href="http://0bin.net">0bin</a> !</p>
<p><a href="http://www.memcachier.com/documentation/memcache-user-guide/">Memcache</a> :</p>
<blockquote><p>Memcache doesn’t evict keys when their expiration time expires, as doing so isn’t possible while still guaranteeing O(1) operation times. Instead expiration is more of a way to say how long until a key should be considered stale. When a GET is performed, Memcache checks if the key’s expiration time is still valid before returning it.</p></blockquote>
<p><a href="http://redis.io/commands/expire">Redis</a> :</p>
<blockquote><p>Redis keys are expired in two ways: a passive way, and an active way. A key is actively expired simply when some client tries to access it, and the key is found to be timed out. Of course this is not enough as there are expired keys that will never be accessed again. This keys should be expired anyway, so periodically Redis test a few keys at random among keys with an expire set. All the keys that are already expired are deleted from the keyspace.</p></blockquote>
<p>Memcache et Redis ne cherchent donc pas les clés, ils vérifient l&#8217;expiration à l&#8217;accès de la clé et suppriment le contenu si c&#8217;est dépassé.</p>
<p>Redis va plus loin en régulièrement prenant des clés <strong>au hasard</strong> et en checkant leur date d&#8217;expiration.</p>
<div id="attachment_5185" style="width: 260px" class="wp-caption aligncenter"><a href="http://sametmax.com/wp-content/uploads/2013/02/nQrJypO.gif" class="grouped_elements" rel="tc-fancybox-group5184"><img class="size-full wp-image-5185" title="Comment il fait ? Ah bah il fait pas." src="http://sametmax.com/wp-content/uploads/2013/02/nQrJypO.gif" alt="Gif de Tealc' buvant un café très chaud" width="250" height="136" /></a><p class="wp-caption-text">Comment il fait ? Ah bah il fait pas.</p></div>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/comment-redis-et-memcache-font-expirer-leurs-donnees/feed/</wfw:commentRss>
		<slash:comments>12</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2013/02/RNJUv.jpg" length="62975" type="image/jpg" />	</item>
		<item>
		<title>&#8216;Redis&#8217; object has no attribute &#8216;connection&#8217;</title>
		<link>http://sametmax.com/redis-object-has-no-attribute-connection/</link>
		<comments>http://sametmax.com/redis-object-has-no-attribute-connection/#comments</comments>
		<pubDate>Wed, 20 Feb 2013 11:10:21 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[redis]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=4461</guid>
		<description><![CDATA[Solution très conne à un problème très con.]]></description>
				<content:encoded><![CDATA[<p>Solution très conne à un problème très con.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">pip <span style="color: #c20cb9; font-weight: bold;">install</span> <span style="color: #660033;">--upgrade</span> redis django-redis-cache django-redis-sessions</pre></td></tr></table></div>

<p>L&#8217;api de la lib Python Redis a changé, et si vous utilisez des libs qui en dépendent, certains seront plus à jour. C&#8217;est balot, mais ça nous a turlupiné.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/redis-object-has-no-attribute-connection/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2013/02/wow_red_xiii_cat_druid_.jpg" length="152046" type="image/jpg" />	</item>
		<item>
		<title>Les limites théoriques de redis 4</title>
		<link>http://sametmax.com/les-limites-theoriques-de-redis/</link>
		<comments>http://sametmax.com/les-limites-theoriques-de-redis/#comments</comments>
		<pubDate>Sun, 22 Jul 2012 19:55:14 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[redis]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=1267</guid>
		<description><![CDATA[En théorie hein...]]></description>
				<content:encoded><![CDATA[<p><a href="https://groups.google.com/forum/?fromgroups#!topic/redis-db/n9smY0qNQYs">Nombre de clés max</a>: 2^64-1<br />
Nombre d&#8217;éléments max dans un set: 2^64-1<br />
Nombre d&#8217;éléments max dans une liste: 2^32-1<br />
Nombre d&#8217;éléments max dans une liste: 2^64-1<br />
<a href="https://groups.google.com/forum/?fromgroups#!topic/redis-db/HH4z-8mHNLM">Taille maximum d&#8217;une clé</a>: 2^31 octets<br />
<a href="http://stackoverflow.com/questions/5606106/what-is-the-maximum-value-size-you-can-store-in-redis">Taille maximum d&#8217;une valeur de type string</a>: 512 Mo<br />
<a href="https://groups.google.com/forum/?fromgroups#!topic/redis-db/yjU4XCkZ6HA">Nombre max de DB</a>: virtuellement infinie, mais s&#8217;attendre à des problèmes de perf si on dépasse 1000, et le fichier de conf met la limite à 16 par défaut.</p>
<p>Ca va, il y a de la marge.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/les-limites-theoriques-de-redis/feed/</wfw:commentRss>
		<slash:comments>4</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2012/07/banner_redis-300dpi-0315a8013afee137cce47b474541d7f1.png" length="25230" type="image/jpg" />	</item>
		<item>
		<title>Redis &#8211; Effacer plusieurs clefs à l&#8217;aide la commande * (wildcard)</title>
		<link>http://sametmax.com/redis-effacer-plusieurs-clefs-a-laide-la-commande-wildcard/</link>
		<comments>http://sametmax.com/redis-effacer-plusieurs-clefs-a-laide-la-commande-wildcard/#comments</comments>
		<pubDate>Sun, 17 Jun 2012 12:37:53 +0000</pubDate>
		<dc:creator><![CDATA[Max]]></dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[clef]]></category>
		<category><![CDATA[del]]></category>
		<category><![CDATA[redis]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=927</guid>
		<description><![CDATA[Comment effacer plusieurs clef sous Redis en une ligne de commande.]]></description>
				<content:encoded><![CDATA[<p>Lorsque l&#8217;on utilise <a href="http://redis.io/">Redis</a> on a du mal à ne pas y mettre de tout et n&#8217;importe quoi, du coup on se retrouve avec plein de données en RAM. Il arrive au moment d&#8217;une update où l&#8217;on aimerait bien effacer certaines clefs en mémoire. Voici une petite astuce qui m&#8217;a permis de sélectivement effacer la clef video-id.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">redis-cli KEYS <span style="color: #ff0000;">&quot;video-id:*&quot;</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">xargs</span> <span style="color: #660033;">-0</span> redis-cli DEL</pre></td></tr></table></div>

]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/redis-effacer-plusieurs-clefs-a-laide-la-commande-wildcard/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2012/06/erase-memory.jpg" length="428372" type="image/jpg" />	</item>
	</channel>
</rss>
