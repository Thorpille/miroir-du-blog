<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Sam &#38; Max &#187; coroutine</title>
	<atom:link href="http://sametmax.com/tag/coroutine/feed/" rel="self" type="application/rss+xml" />
	<link>http://sametmax.com</link>
	<description>Du code, du cul</description>
	<lastBuildDate>Sat, 07 Nov 2015 10:56:13 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>http://wordpress.org/?v=4.1</generator>
	<item>
		<title>Qu&#8217;est-ce qu&#8217;une coroutine en Python, et à quoi ça sert ? 10</title>
		<link>http://sametmax.com/quest-ce-quune-coroutine-en-python-et-a-quoi-ca-sert/</link>
		<comments>http://sametmax.com/quest-ce-quune-coroutine-en-python-et-a-quoi-ca-sert/#comments</comments>
		<pubDate>Sat, 13 Dec 2014 23:37:06 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[coroutine]]></category>
		<category><![CDATA[generators]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[yield]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=12854</guid>
		<description><![CDATA[Si vous avez aimé les générateurs, vous avez du creuser un peu <code>yield</code> et vous apercevoir qu'on pouvait créer des coroutines avec. Mais sans vraiment comprendre ce que ça faisait.]]></description>
				<content:encoded><![CDATA[<p>Si vous avez aimé les générateurs, vous avez du creuser un peu <code>yield</code> et vous apercevoir qu&#8217;on pouvait créer des coroutines avec. Mais sans vraiment comprendre ce que ça faisait.</p>
<p>On va se faire une petit intro. C&#8217;est un sujet vraiment avancé, donc si vous avez autre chose de moins compliqué à comprendre en Python (n&#8217;importe quoi à part les métaclasses :)), ne vous prenez pas la tête sur cet article. Ecoutez juste la musique :</p>
<p><span class='embed-youtube' style='text-align:center; display: block;'><iframe class='youtube-player' type='text/html' width='1170' height='689' src='http://www.youtube.com/embed/zqKZ_WIK5ms?version=3&#038;rel=1&#038;fs=1&#038;showsearch=0&#038;showinfo=1&#038;iv_load_policy=1&#038;wmode=transparent' frameborder='0' allowfullscreen='true'></iframe></span></p>
<p>D&#8217;abord, rappel sur le fonctionnement des générateurs (qui sont un prérequis de l&#8217;article, donc si besoin, relisez le <a href="http://sametmax.com/comment-utiliser-yield-et-les-generateurs-en-python/">tuto dédié</a>) :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> soleil<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'Premier next()'</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'Yield 1'</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">yield</span> <span style="color: #ff4500;">1</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'Deuxième next()'</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'Yield 2'</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">yield</span> <span style="color: #ff4500;">2</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'Troisième next()'</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'Yield 3'</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">yield</span> <span style="color: #ff4500;">3</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># pas de quatrième next(),</span>
    <span style="color: #808080; font-style: italic;"># donc on ne passe jamais ici</span>
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'Pas vu'</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># rappel, ceci ne déclenche pas le code </span>
<span style="color: #808080; font-style: italic;"># de soleil() puisqu'il y a yield dedans</span>
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Creation du generateur&quot;</span><span style="color: black;">&#41;</span>
undeuxtrois <span style="color: #66cc66;">=</span> soleil<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># On execute le code jusqu'au yield 1</span>
res <span style="color: #66cc66;">=</span> next<span style="color: black;">&#40;</span>undeuxtrois<span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'res = %s'</span> % res<span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># On execute le code jusqu'au yield 2</span>
res <span style="color: #66cc66;">=</span> next<span style="color: black;">&#40;</span>undeuxtrois<span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'res = %s'</span> % res<span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># On execute le code jusqu'au yield 3</span>
res <span style="color: #66cc66;">=</span> next<span style="color: black;">&#40;</span>undeuxtrois<span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'res = %s'</span> % res<span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'Good bye'</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;">## Premier next()</span>
<span style="color: #808080; font-style: italic;">## Yield 1</span>
<span style="color: #808080; font-style: italic;">## res = 1</span>
<span style="color: #808080; font-style: italic;">## Deuxième next()</span>
<span style="color: #808080; font-style: italic;">## Yield 2</span>
<span style="color: #808080; font-style: italic;">## res = 2</span>
<span style="color: #808080; font-style: italic;">## Troisième next()</span>
<span style="color: #808080; font-style: italic;">## Yield 3</span>
<span style="color: #808080; font-style: italic;">## res = 3</span>
<span style="color: #808080; font-style: italic;">## Good bye</span></pre></td></tr></table></div>

<p>Chaque fois qu&#8217;on appelle <code>next()</code> sur le générateur, il va exécuter le code jusqu&#8217;au prochain <code>yield</code>, et retourner la valeur de celui-ci, puis mettre le générateur en pause.</p>
<p>On peut assigner le résultat d&#8217;un <code>yield</code>, mais si on fait des <code>next()</code>, on obtient toujours <code>None</code> :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> lune<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'Premier next()'</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'Yield 1'</span><span style="color: black;">&#41;</span>
    x <span style="color: #66cc66;">=</span> <span style="color: black;">&#40;</span><span style="color: #ff7700;font-weight:bold;">yield</span> <span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'Deuxième next()'</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'Avant le yield 2, x = %s'</span> % x<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'Yield 2'</span><span style="color: black;">&#41;</span>
    x <span style="color: #66cc66;">=</span> <span style="color: black;">&#40;</span><span style="color: #ff7700;font-weight:bold;">yield</span> <span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'Troisième next()'</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'Avant le yield 3, x = %s'</span> % x<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'Yield 3'</span><span style="color: black;">&#41;</span>
    x <span style="color: #66cc66;">=</span> <span style="color: black;">&#40;</span><span style="color: #ff7700;font-weight:bold;">yield</span> <span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'Pas vu'</span><span style="color: black;">&#41;</span>
&nbsp;
&nbsp;
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Creation du generateur&quot;</span><span style="color: black;">&#41;</span>
generateur <span style="color: #66cc66;">=</span> lune<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
res <span style="color: #66cc66;">=</span> next<span style="color: black;">&#40;</span>generateur<span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'res = %s'</span> % res<span style="color: black;">&#41;</span>
&nbsp;
res <span style="color: #66cc66;">=</span> next<span style="color: black;">&#40;</span>generateur<span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'res = %s'</span> % res<span style="color: black;">&#41;</span>
&nbsp;
res <span style="color: #66cc66;">=</span> next<span style="color: black;">&#40;</span>generateur<span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'res = %s'</span> % res<span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'Good bye'</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;">## Creation du generateur</span>
<span style="color: #808080; font-style: italic;">## Premier next()</span>
<span style="color: #808080; font-style: italic;">## Yield 1</span>
<span style="color: #808080; font-style: italic;">## res = 1</span>
<span style="color: #808080; font-style: italic;">## Deuxième next()</span>
<span style="color: #808080; font-style: italic;">## Avant le yield 2, x = None</span>
<span style="color: #808080; font-style: italic;">## Yield 2</span>
<span style="color: #808080; font-style: italic;">## res = 2</span>
<span style="color: #808080; font-style: italic;">## Troisième next()</span>
<span style="color: #808080; font-style: italic;">## Avant le yield 3, x = None</span>
<span style="color: #808080; font-style: italic;">## Yield 3</span>
<span style="color: #808080; font-style: italic;">## res = 3</span>
<span style="color: #808080; font-style: italic;">## Good bye</span></pre></td></tr></table></div>

<p>La raison est que cette valeur doit venir de l&#8217;extérieur. Pour la fournir, il faut utiliser la méthode <code>send()</code> et non la fonction <code>next()</code>.</p>
<p>Mais elle ne fonctionne pas du tout pareil. En fait, si on l&#8217;appelle cash pistache, ça plante :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Creation du generateur&quot;</span><span style="color: black;">&#41;</span>
generateur <span style="color: #66cc66;">=</span> lune<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
res <span style="color: #66cc66;">=</span> generateur.<span style="color: black;">send</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;A&quot;</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'res = %s'</span> % res<span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;">## Creation du generateur</span>
<span style="color: #808080; font-style: italic;">## Traceback (most recent call last):</span>
<span style="color: #808080; font-style: italic;">## File &quot;test.py&quot;, line 24, in </span>
<span style="color: #808080; font-style: italic;">##   res = generateur.send(&quot;A&quot;)</span>
<span style="color: #808080; font-style: italic;">##     TypeError: can't send non-None value to a just-started generator</span></pre></td></tr></table></div>

<p>C&#8217;est parce que, contrairement à <code>next()</code> qui va jusqu&#8217;au prochain <code>yield</code>, <code>send()</code> PART du dernier <code>yield</code> atteint pour aller au suivant.</p>
<p>Il faut donc d&#8217;abord arriver à un premier <code>yield</code> avant de faire un <code>send()</code>. On peut le faire en utilisant au moins un <code>next()</code>.</p>
<p>Voici donc notre nouveau code :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> lune<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'On fait au moins un next()'</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'Yield 1'</span><span style="color: black;">&#41;</span>
&nbsp;
    x <span style="color: #66cc66;">=</span> <span style="color: black;">&#40;</span><span style="color: #ff7700;font-weight:bold;">yield</span> <span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'Premier send(), x = %s'</span> % x<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'Yield 2'</span><span style="color: black;">&#41;</span>
&nbsp;
    x <span style="color: #66cc66;">=</span> <span style="color: black;">&#40;</span><span style="color: #ff7700;font-weight:bold;">yield</span> <span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'Deuxième send(), x = %s'</span> % x<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'Yield 3'</span><span style="color: black;">&#41;</span>
&nbsp;
    x <span style="color: #66cc66;">=</span> <span style="color: black;">&#40;</span><span style="color: #ff7700;font-weight:bold;">yield</span> <span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># Comme on fait un next() et 3 send()</span>
    <span style="color: #808080; font-style: italic;"># on arrive là</span>
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'Troisième send(), x = %s'</span> % x<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'YOLOOOOO'</span><span style="color: black;">&#41;</span>
&nbsp;
&nbsp;
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Creation du generateur&quot;</span><span style="color: black;">&#41;</span>
generateur <span style="color: #66cc66;">=</span> lune<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
next<span style="color: black;">&#40;</span>generateur<span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># Ou generateur.send(None)</span>
&nbsp;
res <span style="color: #66cc66;">=</span> generateur.<span style="color: black;">send</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;A&quot;</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'res = %s'</span> % res<span style="color: black;">&#41;</span>
&nbsp;
res <span style="color: #66cc66;">=</span> generateur.<span style="color: black;">send</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;B&quot;</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'res = %s'</span> % res<span style="color: black;">&#41;</span>
&nbsp;
res <span style="color: #66cc66;">=</span> generateur.<span style="color: black;">send</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;C&quot;</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'res = %s'</span> % res<span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'Good bye'</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;">## Creation du generateur</span>
<span style="color: #808080; font-style: italic;">## On fait au moins un next()</span>
<span style="color: #808080; font-style: italic;">## Yield 1</span>
<span style="color: #808080; font-style: italic;">## Premier send(), x = A</span>
<span style="color: #808080; font-style: italic;">## Yield 2</span>
<span style="color: #808080; font-style: italic;">## res = 2</span>
<span style="color: #808080; font-style: italic;">## Deuxième send(), x = B</span>
<span style="color: #808080; font-style: italic;">## Yield 3</span>
<span style="color: #808080; font-style: italic;">## res = 3</span>
<span style="color: #808080; font-style: italic;">## Troisième send(), x = C</span>
<span style="color: #808080; font-style: italic;">## YOLOOOOO</span>
<span style="color: #808080; font-style: italic;">## Traceback (most recent call last):</span>
<span style="color: #808080; font-style: italic;">##   File &quot;test.py&quot;, line 33, in </span>
<span style="color: #808080; font-style: italic;">##     res = generateur.send(&quot;C&quot;)</span>
<span style="color: #808080; font-style: italic;">## StopIteration</span></pre></td></tr></table></div>

<p><code>send()</code> agit donc comme <code>next()</code>. Il va aller jusqu&#8217;au prochain <code>yield</code> et lui faire retourner sa valeur. Mais il y a des différences :</p>
<ul>
<li>Elle doit partir d&#8217;un précédent <code>yield</code>.</li>
<li>Donc il faut au moins avoir atteint un <code>yield</code> via <code>next()</code>.</li>
<li>Ce précédent <code>yield</code> peut retourner une valeur : celle passée via <code>send(val).</code></li>
</ul>
<p>La valeur peut être n&#8217;importe quel objet : string, int, classe, list, etc.</p>
<p>Bref, <code>send()</code> permet de créer un générateur donc le comportement n&#8217;est pas figé dans le marbre.</p>
<p>Par exemple :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> creer_fontaine<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    contenu <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">&quot;soda&quot;</span> 
    <span style="color: #ff7700;font-weight:bold;">while</span> <span style="color: #008000;">True</span>:
        x <span style="color: #66cc66;">=</span> <span style="color: #ff7700;font-weight:bold;">yield</span> contenu
        <span style="color: #ff7700;font-weight:bold;">if</span> x:
            contenu <span style="color: #66cc66;">=</span> x
&nbsp;
&nbsp;
fontaine <span style="color: #66cc66;">=</span> creer_fontaine<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">range</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">5</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>next<span style="color: black;">&#40;</span>fontaine<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># on change le contenu de la fontaine</span>
fontaine.<span style="color: black;">send</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;lait&quot;</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">range</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">5</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>next<span style="color: black;">&#40;</span>fontaine<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
soda
soda
soda
soda
soda
lait
lait
lait
lait
lait</pre></td></tr></table></div>

<p>On peut même s&#8217;en servir pour faire des trucs chelou comme injecter une dépendance à la volée ou contrôler le flux de son générateur :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> fuckitjaiplusdenomcool<span style="color: black;">&#40;</span>start<span style="color: #66cc66;">,</span> inc<span style="color: #66cc66;">=</span><span style="color: #ff7700;font-weight:bold;">lambda</span> x: x + <span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span>:
    x <span style="color: #66cc66;">=</span> start
    <span style="color: #808080; font-style: italic;"># on controle le flux du générateur en changeant</span>
    <span style="color: #808080; font-style: italic;"># la valeur de x qui peut tout stopper</span>
    <span style="color: #ff7700;font-weight:bold;">while</span> x:
        sent <span style="color: #66cc66;">=</span> <span style="color: #ff7700;font-weight:bold;">yield</span> x
        <span style="color: #ff7700;font-weight:bold;">if</span> sent:
            inc <span style="color: #66cc66;">=</span> sent
        <span style="color: #808080; font-style: italic;"># la valeur de x dépend de ce bout de code</span>
        <span style="color: #808080; font-style: italic;"># qui est injectable</span>
        x <span style="color: #66cc66;">=</span> inc<span style="color: black;">&#40;</span>x<span style="color: black;">&#41;</span>
&nbsp;
&nbsp;
generateur <span style="color: #66cc66;">=</span> fuckitjaiplusdenomcool<span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> generateur:
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>x<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">if</span> x &amp;gt<span style="color: #66cc66;">;</span> <span style="color: #ff4500;">10</span>:
        <span style="color: #808080; font-style: italic;"># si on dépasse 10, on décrémente</span>
        generateur.<span style="color: black;">send</span><span style="color: black;">&#40;</span><span style="color: #ff7700;font-weight:bold;">lambda</span> x: x - <span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;">## 1</span>
<span style="color: #808080; font-style: italic;">## 2</span>
<span style="color: #808080; font-style: italic;">## 3</span>
<span style="color: #808080; font-style: italic;">## 4</span>
<span style="color: #808080; font-style: italic;">## 5</span>
<span style="color: #808080; font-style: italic;">## 6</span>
<span style="color: #808080; font-style: italic;">## 7</span>
<span style="color: #808080; font-style: italic;">## 8</span>
<span style="color: #808080; font-style: italic;">## 9</span>
<span style="color: #808080; font-style: italic;">## 10</span>
<span style="color: #808080; font-style: italic;">## 11</span>
<span style="color: #808080; font-style: italic;">## 9</span>
<span style="color: #808080; font-style: italic;">## 8</span>
<span style="color: #808080; font-style: italic;">## 7</span>
<span style="color: #808080; font-style: italic;">## 6</span>
<span style="color: #808080; font-style: italic;">## 5</span>
<span style="color: #808080; font-style: italic;">## 4</span>
<span style="color: #808080; font-style: italic;">## 3</span>
<span style="color: #808080; font-style: italic;">## 2</span>
<span style="color: #808080; font-style: italic;">## 1</span></pre></td></tr></table></div>

<p>Mais bon, pas la peine de rentrer dans des cas si compliqués.</p>
<p>Néanmoins, un cas d&#8217;usage de <code>send()</code> est de créer une coroutine. Une coroutine est simplement une tâche.</p>
<p>C&#8217;est un bout de code qui fait une tache, avec un bout d&#8217;initialisation, et un bout de finalisation, et un bout d&#8217;exécution.</p>
<p>Par exemple, j&#8217;ai un filtre qui prend un fichier rempli d&#8217;adresses IP. Il va recevoir du texte, et si le texte contient une adresse IP, il le signale, et remplit un compteur sur le disque.</p>
<p>Si on devait coder ça en objet on dirait :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">re</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">class</span> Filtre:
&nbsp;
    <span style="color: #808080; font-style: italic;"># initialisation</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__init__</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> ipfile<span style="color: #66cc66;">,</span> counterfile<span style="color: black;">&#41;</span>:
&nbsp;
        <span style="color: #ff7700;font-weight:bold;">with</span> <span style="color: #008000;">open</span><span style="color: black;">&#40;</span>ipfile<span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'r'</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">as</span> f:
            <span style="color: #008000;">self</span>.<span style="color: black;">banned_ips</span> <span style="color: #66cc66;">=</span> <span style="color: #008000;">set</span><span style="color: black;">&#40;</span>f<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">with</span> <span style="color: #008000;">open</span><span style="color: black;">&#40;</span>counterfile<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">as</span> f:
            <span style="color: #008000;">self</span>.<span style="color: black;">count</span> <span style="color: #66cc66;">=</span> <span style="color: #008000;">int</span><span style="color: black;">&#40;</span>f.<span style="color: black;">read</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">counterfile</span> <span style="color: #66cc66;">=</span> <span style="color: #008000;">open</span><span style="color: black;">&#40;</span>counterfile<span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'w'</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> check<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> line<span style="color: black;">&#41;</span>:
        <span style="color: #808080; font-style: italic;"># récupère les ip et check celles qui sont </span>
        <span style="color: #808080; font-style: italic;"># à filtrer</span>
        ips <span style="color: #66cc66;">=</span> <span style="color: #dc143c;">re</span>.<span style="color: black;">findall</span><span style="color: black;">&#40;</span> r<span style="color: #483d8b;">'[0-9]+(?:<span style="color: #000099; font-weight: bold;">\.</span>[0-9]+){3}'</span><span style="color: #66cc66;">,</span> line<span style="color: black;">&#41;</span>
        bad_ips <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span>ip <span style="color: #ff7700;font-weight:bold;">for</span> ip <span style="color: #ff7700;font-weight:bold;">in</span> ips <span style="color: #ff7700;font-weight:bold;">if</span> ip <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">self</span>.<span style="color: black;">banned_ips</span><span style="color: black;">&#93;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># si il y a des ip à filtrer, on incrémente le compteur</span>
        <span style="color: #ff7700;font-weight:bold;">if</span> bad_ips:
            <span style="color: #008000;">self</span>.<span style="color: black;">count</span> +<span style="color: #66cc66;">=</span> <span style="color: #008000;">len</span><span style="color: black;">&#40;</span>bad_ips<span style="color: black;">&#41;</span>
            <span style="color: #008000;">self</span>.<span style="color: black;">counterfile</span>.<span style="color: black;">seek</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#41;</span>
            <span style="color: #008000;">self</span>.<span style="color: black;">counterfile</span>.<span style="color: black;">write</span><span style="color: black;">&#40;</span><span style="color: #008000;">str</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">count</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># on retourn les valeurs trouvées</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> bad_ips
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> close<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #008000;">self</span>.<span style="color: black;">counterfile</span>.<span style="color: black;">close</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>On l&#8217;utiliserait comme ça :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">f <span style="color: #66cc66;">=</span> Filtre<span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;/chemin/vers/liste&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">&quot;/chemin/vers/counteur&quot;</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">for</span> line <span style="color: #ff7700;font-weight:bold;">in</span> text:
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>f.<span style="color: black;">check</span><span style="color: black;">&#40;</span>line<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
f.<span style="color: black;">close</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Notez que pour une tâche, l&#8217;API est toujours la même : initialiser, exécuter la tâche autant de fois que nécessaire, puis finaliser.</p>
<p>Les coroutines sont un mot qu&#8217;on met sur ce principe (initialiser, exec, finaliser), mais avec une API sous forme de générateur. Le même code en coroutine :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> filtre<span style="color: black;">&#40;</span>ipfile<span style="color: #66cc66;">,</span> counterfile<span style="color: black;">&#41;</span>:
&nbsp;
    <span style="color: #808080; font-style: italic;"># Initialisation</span>
    <span style="color: #ff7700;font-weight:bold;">with</span> <span style="color: #008000;">open</span><span style="color: black;">&#40;</span>ipfile<span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'r'</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">as</span> f:
        banned_ips <span style="color: #66cc66;">=</span> <span style="color: #008000;">set</span><span style="color: black;">&#40;</span>f<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">with</span> <span style="color: #008000;">open</span><span style="color: black;">&#40;</span>counterfile<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">as</span> f:
        count <span style="color: #66cc66;">=</span> <span style="color: #008000;">int</span><span style="color: black;">&#40;</span>f.<span style="color: black;">read</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
    counterfile <span style="color: #66cc66;">=</span> <span style="color: #008000;">open</span><span style="color: black;">&#40;</span>counterfile<span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'w'</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># Exécution</span>
    bad_ips <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span><span style="color: black;">&#93;</span>
    <span style="color: #ff7700;font-weight:bold;">while</span> <span style="color: #008000;">True</span>:
&nbsp;
        <span style="color: #ff7700;font-weight:bold;">try</span>:
            <span style="color: #808080; font-style: italic;"># entree et sortie de notre send(), qui équivaut</span>
            <span style="color: #808080; font-style: italic;"># aux params de &quot;check()&quot;</span>
            line <span style="color: #66cc66;">=</span> <span style="color: #ff7700;font-weight:bold;">yield</span> bad_ips
&nbsp;
        <span style="color: #808080; font-style: italic;"># GeneratorExit est levé is on fait generator.close()</span>
        <span style="color: #808080; font-style: italic;"># On ne peut pas ignorer cette erreur, mais</span>
        <span style="color: #808080; font-style: italic;"># on peut mettre du code de finalisation ici.</span>
        <span style="color: #808080; font-style: italic;"># Bon en vrai faudrait faire un finally quelque part</span>
        <span style="color: #808080; font-style: italic;"># mais c'est pour l'exemple bande de peer reviewers</span>
        <span style="color: #ff7700;font-weight:bold;">except</span> GeneratorExit:
                counterfile.<span style="color: black;">close</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
        ips <span style="color: #66cc66;">=</span> <span style="color: #dc143c;">re</span>.<span style="color: black;">findall</span><span style="color: black;">&#40;</span> r<span style="color: #483d8b;">'[0-9]+(?:<span style="color: #000099; font-weight: bold;">\.</span>[0-9]+){3}'</span><span style="color: #66cc66;">,</span> line<span style="color: black;">&#41;</span>
        bad_ips <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span>ip <span style="color: #ff7700;font-weight:bold;">for</span> ip <span style="color: #ff7700;font-weight:bold;">in</span> ips <span style="color: #ff7700;font-weight:bold;">if</span> ip <span style="color: #ff7700;font-weight:bold;">in</span> banned_ips<span style="color: black;">&#93;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># si il y a des ip à filtrer, on incrémente le compteur</span>
        <span style="color: #ff7700;font-weight:bold;">if</span> bad_ips:
            count +<span style="color: #66cc66;">=</span> <span style="color: #008000;">len</span><span style="color: black;">&#40;</span>bad_ips<span style="color: black;">&#41;</span>
            counterfile.<span style="color: black;">seek</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#41;</span>
            counterfile.<span style="color: black;">write</span><span style="color: black;">&#40;</span><span style="color: #008000;">str</span><span style="color: black;">&#40;</span>count<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>On l&#8217;utiliserait comme ça :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">f <span style="color: #66cc66;">=</span> filtre<span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;/chemin/vers/liste&quot;</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">&quot;/chemin/vers/counteur&quot;</span><span style="color: black;">&#41;</span>
next<span style="color: black;">&#40;</span>f<span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">for</span> line <span style="color: #ff7700;font-weight:bold;">in</span> text:
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>f.<span style="color: black;">send</span><span style="color: black;">&#40;</span>line<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #808080; font-style: italic;"># ceci raise GeneratorExit</span>
f.<span style="color: black;">close</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre></td></tr></table></div>

<p>Généralement on veut pas se faire chier à appeler <code>next()</code> à chaque fois, donc toutes les libs à base de coroutine ont ce genre de décorateur :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> coroutine<span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">def</span> wrapper<span style="color: black;">&#40;</span>*arg<span style="color: #66cc66;">,</span> **kwargs<span style="color: black;">&#41;</span>:
        generator <span style="color: #66cc66;">=</span> func<span style="color: black;">&#40;</span>*arg<span style="color: #66cc66;">,</span> **kwargs<span style="color: black;">&#41;</span>
        next<span style="color: black;">&#40;</span>generator<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> generator
    <span style="color: #ff7700;font-weight:bold;">return</span> wrapper</pre></td></tr></table></div>

<p>Afin de pouvoir faire ça :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">@</span>coroutine
<span style="color: #ff7700;font-weight:bold;">def</span> filtre<span style="color: black;">&#40;</span>ipfile<span style="color: #66cc66;">,</span> counterfile<span style="color: black;">&#41;</span>:
    ...</pre></td></tr></table></div>

<p>Ca a un double usage : ça appelle <code>next()</code> automatiquement, et ça signale que la fonction est destinée à être utilisée comme coroutine.</p>
<p>Mais voilà, c&#8217;est tout, une coroutine c&#8217;est juste ça : utiliser un générateur pour faire une tâche qui consiste à s&#8217;initialiser, faire un traitement plusieurs fois, et optionellement, se finaliser. On utilisera une coroutine pour ne pas reinventer la roue car c&#8217;est un problème bien défini, qui a une solution. D&#8217;autant qu&#8217;une coroutine bouffe moins de ressources qu&#8217;une classe.</p>
<p>Les usages avancés des coroutines impliquent de chaîner plusieurs coroutines, comme des tuyaux.</p>
<p>Souvenez-vous, en Python il est courant de chaîner des générateurs :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> mettre_au_carre<span style="color: black;">&#40;</span>iterable<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> iterable:
        <span style="color: #ff7700;font-weight:bold;">yield</span> x * x
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> filtrer_les_pairs<span style="color: black;">&#40;</span>iterable<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> iterable:
        <span style="color: #ff7700;font-weight:bold;">if</span> x % <span style="color: #ff4500;">2</span> <span style="color: #66cc66;">==</span> <span style="color: #ff4500;">0</span>:
            <span style="color: #ff7700;font-weight:bold;">yield</span> x
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> strigifier<span style="color: black;">&#40;</span>iterable<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> iterable:
        <span style="color: #ff7700;font-weight:bold;">yield</span> <span style="color: #008000;">str</span><span style="color: black;">&#40;</span>x<span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># on pipe les données d'un générateur à l'autre</span>
nombres <span style="color: #66cc66;">=</span> <span style="color: #008000;">range</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">10</span><span style="color: black;">&#41;</span>
carres <span style="color: #66cc66;">=</span> mettre_au_carre<span style="color: black;">&#40;</span>nombres<span style="color: black;">&#41;</span>
carres_pairs <span style="color: #66cc66;">=</span> filtrer_les_pairs<span style="color: black;">&#40;</span>carres<span style="color: black;">&#41;</span>
fete_du_string <span style="color: #66cc66;">=</span> strigifier<span style="color: black;">&#40;</span>carres_pairs<span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> fete_du_string:
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">repr</span><span style="color: black;">&#40;</span>x<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;">## '0'</span>
<span style="color: #808080; font-style: italic;">## '4'</span>
<span style="color: #808080; font-style: italic;">## '16'</span>
<span style="color: #808080; font-style: italic;">## '36'</span>
<span style="color: #808080; font-style: italic;">## '64'</span></pre></td></tr></table></div>

<p>On peut faire pareil avec les coroutines. Cependant, la logique est inversée : au lieu de lire les données, on les envoie :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">@</span>coroutine
<span style="color: #ff7700;font-weight:bold;">def</span> mettre_au_carre<span style="color: black;">&#40;</span>ouput<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">while</span> <span style="color: #008000;">True</span>:
        x <span style="color: #66cc66;">=</span> <span style="color: black;">&#40;</span><span style="color: #ff7700;font-weight:bold;">yield</span><span style="color: black;">&#41;</span>
        ouput.<span style="color: black;">send</span><span style="color: black;">&#40;</span>x * x<span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #66cc66;">@</span>coroutine
<span style="color: #ff7700;font-weight:bold;">def</span> filtrer_les_paires<span style="color: black;">&#40;</span>ouput<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">while</span> <span style="color: #008000;">True</span>:
        x <span style="color: #66cc66;">=</span> <span style="color: black;">&#40;</span><span style="color: #ff7700;font-weight:bold;">yield</span><span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">if</span> x % <span style="color: #ff4500;">2</span> <span style="color: #66cc66;">==</span> <span style="color: #ff4500;">0</span>:
            ouput.<span style="color: black;">send</span><span style="color: black;">&#40;</span>x<span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #66cc66;">@</span>coroutine
<span style="color: #ff7700;font-weight:bold;">def</span> strigifier<span style="color: black;">&#40;</span>ouput<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">while</span> <span style="color: #008000;">True</span>:
        x <span style="color: #66cc66;">=</span> <span style="color: black;">&#40;</span><span style="color: #ff7700;font-weight:bold;">yield</span><span style="color: black;">&#41;</span>
        ouput.<span style="color: black;">send</span><span style="color: black;">&#40;</span><span style="color: #008000;">str</span><span style="color: black;">&#40;</span>x<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #66cc66;">@</span>coroutine
<span style="color: #ff7700;font-weight:bold;">def</span> afficher<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">while</span> <span style="color: #008000;">True</span>:
        x <span style="color: #66cc66;">=</span> <span style="color: black;">&#40;</span><span style="color: #ff7700;font-weight:bold;">yield</span><span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>x<span style="color: black;">&#41;</span>
&nbsp;
nombres <span style="color: #66cc66;">=</span> <span style="color: #008000;">range</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">10</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># chaque coroutine est la sortie d'une autre</span>
afficheur <span style="color: #66cc66;">=</span> afficher<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
fete_du_string <span style="color: #66cc66;">=</span> strigifier<span style="color: black;">&#40;</span>afficheur<span style="color: black;">&#41;</span>
paires <span style="color: #66cc66;">=</span> filtrer_les_paires<span style="color: black;">&#40;</span>fete_du_string<span style="color: black;">&#41;</span>
carre <span style="color: #66cc66;">=</span> mettre_au_carre<span style="color: black;">&#40;</span>paires<span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># on envoit les données vers la première coroutine</span>
<span style="color: #808080; font-style: italic;"># et elle fait suivre aux autres</span>
<span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> nombres:
    carre.<span style="color: black;">send</span><span style="color: black;">&#40;</span>x<span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;">## '0'</span>
<span style="color: #808080; font-style: italic;">## '4'</span>
<span style="color: #808080; font-style: italic;">## '16'</span>
<span style="color: #808080; font-style: italic;">## '36'</span>
<span style="color: #808080; font-style: italic;">## '64'</span></pre></td></tr></table></div>

<p>Vous allez me dire : &#8220;ça fait la même chose, et c&#8217;est plus compliqué, quel interêt ?&#8221;.</p>
<p>En fait, ça ne fait pas exactement la même chose.</p>
<p>Dans le cas des générateurs ordinaires, on déclenche le traitement par la fin. On fait une boucle qui demande quelle est la prochaine donnée, et si il y en a une, on l&#8217;affiche. C&#8217;est pratique si on sait qu&#8217;on a des données sous la main car on demande (<code>next()</code> est appelée par la boucle <code>for</code>) la donnée suivante à chaque fois : c&#8217;est du PULL.</p>
<p>Mais que se passe-t-il si on n&#8217;a pas encore les données ? Si on traite des données qui arrivent par évenement ?</p>
<p>Par exemple, si on écrit un serveur HTTP qui doit réagir aux requêtes ?</p>
<p>Dans ce cas, on ne peut envoyer (<code>send()</code>) la donnée suivante dans notre pipeline de générateurs uniquement quand elle arrive, et les coroutines font exactement cela : c&#8217;est du PUSH.</p>
<p>En résumé :</p>
<ul>
<li><code>yield</code> permet de faire des générateurs</li>
<li>On peut demander la prochaine valeur du générateur avec <code>next()</code>. Dans ce cas, le code s&#8217;exécute jusqu&#8217;au prochain <code>yield</code>.</li>
<li>On peut envoyer une valeur au générateur avec <code>send()</code>. Dans ce cas, on DOIT partir d&#8217;un <code>yield</code> existant duquel on récupère la valeur envoyée via une assignation. Donc il faut au moins un <code>next()</code> avant d&#8217;utiliser un <code>send()</code> et un signe égal sur le <code>yield</code>.</li>
<li><code>send()</code> va aussi aller au prochain <code>yield</code> et retourner sa valeur.</li>
<li>Une coroutine n&#8217;est qu&#8217;une formalisation de la manière d&#8217;éffectuer une tâche avec un init, une exécution et une finalisation optionelle en utilisant un générateur. C&#8217;est une solution générique à un problème courant, mais plus léger qu&#8217;une classe.</li>
<li>Généralement on décore les générateurs coroutines avec un décorateur <code>@coroutine</code> pour s&#8217;éviter d&#8217;appeler <code>next()</code> à la main et notifier l&#8217;usage qu&#8217;il est fait de ce générateur.</li>
<li>On peut chaîner des coroutines comme on chaîne des générateurs, mais au lieu de lire les données une à une (PULL), on les envoie une par une (PUSH). Cela est pratique quand on ne sait pas à l&#8217;avance quand une nouvelle donnée va arriver.</li>
</ul>
<p>Si vous êtes arrivé jusqu&#8217;ici, vous méritez un cookie.</p>
<p>Ca tombe bien, ce blog utilise des cookies, et la loi m&#8217;oblige à vous le notifier.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/quest-ce-quune-coroutine-en-python-et-a-quoi-ca-sert/feed/</wfw:commentRss>
		<slash:comments>10</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2014/12/d2rD4tZ.jpg" length="66279" type="image/jpg" />	</item>
	</channel>
</rss>
