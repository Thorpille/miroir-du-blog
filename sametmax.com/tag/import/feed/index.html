<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Sam &#38; Max: Python, Django, Git et du cul &#187; import</title>
	<atom:link href="http://sametmax.com/tag/import/feed/" rel="self" type="application/rss+xml" />
	<link>http://sametmax.com</link>
	<description>Deux développeurs en vadrouille qui se sortent les doigts du code</description>
	<lastBuildDate>Mon, 02 Dec 2013 10:02:45 +0000</lastBuildDate>
	<language>en</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>http://wordpress.org/?v=3.3.1</generator>
	<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2F&amp;language=en_US&amp;category=text&amp;title=Sam+%26amp%3B+Max%3A+Python%2C+Django%2C+Git+et+du+cul&amp;description=Deux+d%C3%A9veloppeurs+en+vadrouille+qui+se+sortent+les+doigts+du+code&amp;tags=blog" type="text/html" />
		<item>
		<title>Pourquoi il faut éviter import * en Python</title>
		<link>http://sametmax.com/pourquoi-il-faut-eviter-import-en-python/</link>
		<comments>http://sametmax.com/pourquoi-il-faut-eviter-import-en-python/#comments</comments>
		<pubDate>Mon, 25 Nov 2013 07:00:41 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[import]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[splat]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=8082</guid>
		<description><![CDATA[Vous l'avez sans doute lu 100 fois, mais savez-vous pourquoi ?]]></description>
			<content:encoded><![CDATA[<p>Ne pas utiliser l&#8217;<a href="http://sametmax.com/operateur-splat-ou-etoile-en-python/">opérateur splat</a> dans un import, vous l&#8217;avez sans doute lu 100 fois, mais savez-vous pourquoi ?</p>
<p>Regardez la fonction <code>open</code> :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">help</span><span style="color: black;">&#40;</span><span style="color: #008000;">open</span><span style="color: black;">&#41;</span>
    <span style="color: #008000;">open</span><span style="color: black;">&#40;</span>name<span style="color: black;">&#91;</span>, mode<span style="color: black;">&#91;</span>, buffering<span style="color: black;">&#93;</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span> -<span style="color: #66cc66;">&gt;</span> <span style="color: #008000;">file</span> <span style="color: #008000;">object</span>
&nbsp;
    Open a <span style="color: #008000;">file</span> using the <span style="color: #008000;">file</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #008000;">type</span>, returns a <span style="color: #008000;">file</span> <span style="color: #008000;">object</span>.  <span style="color: black;">This</span> <span style="color: #ff7700;font-weight:bold;">is</span> the
    preferred way to <span style="color: #008000;">open</span> a <span style="color: #008000;">file</span>.  <span style="color: black;">See</span> <span style="color: #008000;">file</span>.__doc__ <span style="color: #ff7700;font-weight:bold;">for</span> further information.
<span style="color: black;">&#40;</span>END<span style="color: black;">&#41;</span></pre></div></div>

<p>Maintenant, si j&#8217;importe le module <code>os</code>, ça ne change rien :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">os</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">help</span><span style="color: black;">&#40;</span><span style="color: #008000;">open</span><span style="color: black;">&#41;</span>
    <span style="color: #008000;">open</span><span style="color: black;">&#40;</span>name<span style="color: black;">&#91;</span>, mode<span style="color: black;">&#91;</span>, buffering<span style="color: black;">&#93;</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span> -<span style="color: #66cc66;">&gt;</span> <span style="color: #008000;">file</span> <span style="color: #008000;">object</span>
&nbsp;
    Open a <span style="color: #008000;">file</span> using the <span style="color: #008000;">file</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #008000;">type</span>, returns a <span style="color: #008000;">file</span> <span style="color: #008000;">object</span>.  <span style="color: black;">This</span> <span style="color: #ff7700;font-weight:bold;">is</span> the
    preferred way to <span style="color: #008000;">open</span> a <span style="color: #008000;">file</span>.  <span style="color: black;">See</span> <span style="color: #008000;">file</span>.__doc__ <span style="color: #ff7700;font-weight:bold;">for</span> further information.
<span style="color: black;">&#40;</span>END<span style="color: black;">&#41;</span></pre></div></div>

<p>Si par contre j&#8217;importe tout le contenu du module <code>os</code>, sans namespace :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">os</span> <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #66cc66;">*</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">help</span><span style="color: black;">&#40;</span><span style="color: #008000;">open</span><span style="color: black;">&#41;</span>
    <span style="color: #008000;">open</span><span style="color: black;">&#40;</span>filename, flag <span style="color: black;">&#91;</span>, mode=0777<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span> -<span style="color: #66cc66;">&gt;</span> fd
&nbsp;
    Open a <span style="color: #008000;">file</span> <span style="color: black;">&#40;</span><span style="color: #ff7700;font-weight:bold;">for</span> low level IO<span style="color: black;">&#41;</span>.
<span style="color: black;">&#40;</span>END<span style="color: black;">&#41;</span></pre></div></div>

<p>La différence ?</p>
<p>Dans le premier cas, on a la fonction <code>open()</code> built-in de Python. Dans le second cas, la fonction <code>os.open()</code> a été importée et a remplacée la fonction <code>open()</code>.</p>
<p>Ici le bug sera très difficile à trouver, car les deux fonctions ont presque la même signature :</p>
<p><code>open(name[, mode[, buffering]]) -> file object</code></p>
<p>VS </p>
<p><code>open(filename, flag [, mode=0777]) -> fd</code></p>
<p>Et en plus un usage très similaire.</p>
<p>Bottom line, <code>import *</code>, c&#8217;est pour les sessions shell. Dans vos fichiers de code, ne l&#8217;utilisez pas, vous ne savez pas ce que vous importez.</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=8082&amp;md5=e41900ebed59acfdf42fcf7ebddfac09" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/pourquoi-il-faut-eviter-import-en-python/feed/</wfw:commentRss>
		<slash:comments>11</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fpourquoi-il-faut-eviter-import-en-python%2F&amp;language=en_GB&amp;category=text&amp;title=Pourquoi+il+faut+%C3%A9viter+import+%2A+en+Python&amp;description=Ne+pas+utiliser+l%26%238217%3Bop%C3%A9rateur+splat+dans+un+import%2C+vous+l%26%238217%3Bavez+sans+doute+lu+100+fois%2C+mais+savez-vous+pourquoi+%3F+Regardez+la+fonction+open+%3A+%26gt%3B%26gt%3B%26gt%3B+help%26%2340%3Bopen%26%2341%3B+open%26%2340%3Bname%26%2391%3B%2C+mode%26%2391%3B%2C+buffering%26%2393%3B%26%2393%3B%26%2341%3B+-%26gt%3B...&amp;tags=import%2Cpython%2Csplat%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/11/pyclusion.jpg" length="72541" type="image/jpg" />	</item>
		<item>
		<title>Vous pouvez mettre du code dans __init__.py</title>
		<link>http://sametmax.com/vous-pouvez-mettre-du-code-dans-__init__-py/</link>
		<comments>http://sametmax.com/vous-pouvez-mettre-du-code-dans-__init__-py/#comments</comments>
		<pubDate>Wed, 26 Jun 2013 11:20:04 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[import]]></category>
		<category><![CDATA[init]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[__init__]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=3472</guid>
		<description><![CDATA[Le fichier <em>__init__.py</em> ne sert pas qu'à <a href="http://sametmax.com/les-imports-en-python/">déclarer un dossier comme un package importable</a>. C'est aussi le code exécuté automatiquement, une seule fois, quand on importe le module.]]></description>
			<content:encoded><![CDATA[<p>Le fichier <em>__init__.py</em> ne sert pas qu&#8217;à <a href="http://sametmax.com/les-imports-en-python/">déclarer un dossier comme un package importable</a>. C&#8217;est aussi le code exécuté automatiquement, une seule fois, quand on importe le module.</p>
<p>Du coup vous pouvez mettre dedans tout code Python que vous souhaitez lancer à l&#8217;import. On y voit souvent :</p>
<ul>
<li>Initialisation du cache.</li>
<li>Constantes comme <code>__version__</code>.</li>
<li>Import d&#8217;autres modules pour les mettre dans l&#8217;espace de nom courant.</li>
<li>Check de dépendances.</li>
<li>Aliasing.</li>
<li>Monkey patching and hacks tout moches qui sont là temporairement pour 6 ans.</li>
</ul>
<p>Je vous déconseille de mettre trop de code dans le fichier <em>__init__.py</em>, notamment du code métier. C&#8217;est une mauvaise habitude que l&#8217;on peut voir dans le code de Django par exemple. Car ça veut dire que l&#8217;import du package déclenche ce code, qui lui-même importe d&#8217;autres modules, qui déclenche d&#8217;autres codes, etc. Cela donne des effets de bord à l&#8217;import, alors que l&#8217;import d&#8217;un simple package est quelque chose que l&#8217;on veut généralement ne pas avoir beaucoup d&#8217;effets.</p>
<p>Dans Django par exemple, c&#8217;est ce qui fait que beaucoup de modules lèvent une exception à l&#8217;import :</p>
<p><code>django.core.exceptions.ImproperlyConfigured: Requested setting X but settings are not configured. </code></p>
<p>Alors qu&#8217;ils n&#8217;ont pas du tout besoin des settings pour fonctionner.</p>
<p>Si vous avez besoin que votre classe <code>Bidule</code> soit directement importable dans votre package <code>machin</code>, faites dans <em>machin/__init__.py</em> :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">from</span> .<span style="color: black;">module_qui_contient_bidule</span> <span style="color: #ff7700;font-weight:bold;">import</span> Bidule</pre></div></div>

<p>Du coup vous pourrez faire n&#8217;importe où ailleurs:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">from</span> machin <span style="color: #ff7700;font-weight:bold;">import</span> Bidule</pre></div></div>

<p>C&#8217;est bien plus propre que de mettre tout le code de <code>Bidule</code> dans le <em>__init__.py</em>.</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=3472&amp;md5=2daf10a1153a39b9d0d97872a04a914d" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/vous-pouvez-mettre-du-code-dans-__init__-py/feed/</wfw:commentRss>
		<slash:comments>10</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fvous-pouvez-mettre-du-code-dans-__init__-py%2F&amp;language=en_GB&amp;category=text&amp;title=Vous+pouvez+mettre+du+code+dans+__init__.py&amp;description=Le+fichier+__init__.py+ne+sert+pas+qu%26%238217%3B%C3%A0+d%C3%A9clarer+un+dossier+comme+un+package+importable.+C%26%238217%3Best+aussi+le+code+ex%C3%A9cut%C3%A9+automatiquement%2C+une+seule+fois%2C+quand+on+importe+le+module.+Du+coup...&amp;tags=import%2Cinit%2Cpython%2C__init__%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/06/UHM9zrZ.jpg" length="59179" type="image/jpg" />	</item>
		<item>
		<title>Les imports en Python</title>
		<link>http://sametmax.com/les-imports-en-python/</link>
		<comments>http://sametmax.com/les-imports-en-python/#comments</comments>
		<pubDate>Thu, 16 May 2013 09:13:27 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[import]]></category>
		<category><![CDATA[module]]></category>
		<category><![CDATA[package]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=6127</guid>
		<description><![CDATA[Un jour vous avez du écrire votre propre module. Vous n'aviez pas vraiment réfléchi à la question. C'était juste une petite lib pour regrouper des fonctions. Ou juste une app Django. Un truc tout simple. Mais les imports ont soudainement cessé de devenir clairs. Ça ne marchait pas. Rien ne marchait. Vous aviez des <code>sys.path.append</code> partout juste au cas où et c'était encore pire.

Vous avez donc décidé de vous remettre à PHP, au moins le <code>include</code> utilise les chemins de fichiers, et ça, c'est facile.]]></description>
			<content:encoded><![CDATA[<p>Je suis fan de carmina burrana depuis l&#8217;age de 12 ans, alors pourquoi pas O Fortuna comme musique d&#8217;ambiance :</p>

<!-- iframe plugin v:2.3 - wordpress.org/extend/plugins/iframe/ -->
<iframe width="420" height="315" src="http://www.youtube.com/embed/nIwrgAnx6Q8" frameborder="0" scrolling="no" class="iframe-class"></iframe>
<p>Les imports, c&#8217;était fastoche. Vous étiez dans votre petit programme, et pour importer un module de la lib standard, vous faisiez:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> module</pre></div></div>

<p>Par exemple :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">os</span></pre></div></div>

<p>Et pour importer une classe ou une fonction de cette lib, vous faisiez :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">from</span> module <span style="color: #ff7700;font-weight:bold;">import</span> fonction
<span style="color: #ff7700;font-weight:bold;">from</span> module <span style="color: #ff7700;font-weight:bold;">import</span> Classe</pre></div></div>

<p>Par exemple :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">from</span> hashlib <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">md5</span>
<span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">xml</span>.<span style="color: black;">etree</span> <span style="color: #ff7700;font-weight:bold;">import</span> Element</pre></div></div>

<p>Parfois, c&#8217;était un peu plus compliqué, mais ça allait encore. Des fois il fallait importer un sous-module :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">from</span> package.<span style="color: black;">sous_package</span> <span style="color: #ff7700;font-weight:bold;">import</span> module</pre></div></div>

<p>Par exemple :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">xml</span>.<span style="color: black;">sax</span> <span style="color: #ff7700;font-weight:bold;">import</span> saxutils</pre></div></div>

<p>Mais ça allait encore.</p>
<p>Et puis un jour vous avez du écrire votre propre module. Vous n&#8217;aviez pas vraiment réfléchi à la question. C&#8217;était juste une petite lib pour regrouper des fonctions. Ou juste une app Django. Un truc tout simple. Mais les imports ont soudainement cessé de devenir clairs. Ça ne marchait pas. Rien ne marchait. Vous aviez des <code>sys.path.append</code> partout juste au cas où et c&#8217;était encore pire.</p>
<p>Vous avez donc décidé de vous remettre à PHP, au moins le <code>include</code> utilise les chemins de fichiers, et ça, c&#8217;est facile.</p>
<h2>Sous le capot</h2>
<p>Quand vous utilisez <code>import</code>, sous le capot Python utilise le fonction <code>__import__</code>. Malgré ses <code>__</code> dans le nom, c&#8217;est une fonction ordinaire, et vous pouvez d&#8217;ailleurs l&#8217;utiliser vous-même :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #dc143c;">os</span> = <span style="color: #008000;">__import__</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'os'</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #dc143c;">os</span>.<span style="color: black;">path</span>.<span style="color: black;">join</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'s'</span>, <span style="color: #483d8b;">'ton'</span>, <span style="color: #483d8b;">'mon'</span>, <span style="color: #483d8b;">'g'</span><span style="color: black;">&#41;</span>
u<span style="color: #483d8b;">'s/ton/mon/g'</span></pre></div></div>

<p>En fait, importer un module, c&#8217;est créer un objet module qui est assigné à une variable tout à fait normale :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">type</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">os</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&lt;</span>type <span style="color: #483d8b;">'module'</span><span style="color: #66cc66;">&gt;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #dc143c;">os</span> = <span style="color: #483d8b;">&quot;on peut ecraser un module&quot;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #dc143c;">os</span>.<span style="color: black;">path</span>
Traceback <span style="color: black;">&#40;</span>most recent call last<span style="color: black;">&#41;</span>:
  File <span style="color: #483d8b;">&quot;&lt;ipython-input-12-e34748f24345&gt;&quot;</span>, line <span style="color: #ff4500;">1</span>, <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #66cc66;">&lt;</span>module<span style="color: #66cc66;">&gt;</span>
    <span style="color: #dc143c;">os</span>.<span style="color: black;">path</span>
<span style="color: #008000;">AttributeError</span>: <span style="color: #483d8b;">'unicode'</span> <span style="color: #008000;">object</span> has no attribute <span style="color: #483d8b;">'path'</span>
&nbsp;
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">sys</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">type</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">sys</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&lt;</span>type <span style="color: #483d8b;">'module'</span><span style="color: #66cc66;">&gt;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #dc143c;">sys</span> = <span style="color: #483d8b;">&quot;je t'ecrase la tronche&quot;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">type</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">sys</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&lt;</span>type <span style="color: #483d8b;">'unicode'</span><span style="color: #66cc66;">&gt;</span></pre></div></div>

<p>Le mécanisme de module Python n&#8217;est donc pas un truc à part, c&#8217;est un objet comme le reste, qui contient des attributs. Les attributs sont les variables et les fonctions du module.</p>
<p>Pour charger un module, la fonction <code>__import__</code> passe par les étapes suivantes :</p>
<ol>
<li>Chercher si le module <code>os</code> existe.</li>
<li>Chercher si le module a déjà été importé. Si oui, s&#8217;arrêter ici et renvoyer le module existant.</li>
<li>Si non, chercher si il a été déjà compilé en .pyc.</li>
<li>Si ce n&#8217;est pas le cas, compiler le fichier .py en .pyc.</li>
<li>Charger le bytecode du fichier pyc.</li>
<li>Créer un objet module vide.</li>
<li>Éxecuter le bytecode dans le contexte de l&#8217;objet module et remplir ce dernier avec le résultat.</li>
<li>Ajouter l&#8217;objet module dans <code>sys.modules</code>, un dictionnaire qui contient tous les modules déjà chargés.</li>
<li>Retourner le module pour pouvoir l&#8217;assigner à une variable, par défaut la variable porte son nom.</li>
</ol>
<p>La fonction <code>__import__</code> est donc très complexe, et d&#8217;ailleurs si vous voulez l&#8217;utiliser pour des trucs plus compliqués qu&#8217;un simple import de module, vous allez galérer car sa signature est vraiment zarb.</p>
<p>Mais pour vous, seule l&#8217;étape 1 est importante à comprendre. C&#8217;est l&#8217;étape à laquelle tout se joue.</p>
<h2>Comment Python définit quel module importer ?</h2>
<p>C&#8217;est la partie vraiment difficile, en effet si un import ne marche pas, c&#8217;est très souvent parce que Python ne trouve pas le module que vous voulez. Et la raison pour laquelle il ne le trouve pas, c&#8217;est que vous ne comprenez pas comment il cherche.</p>
<p>Python utilise ce qu&#8217;on appelle le PYTHON PATH pour chercher les modules importables. C&#8217;est une variable système qui contient une liste de dossiers. Par exemple, sur ma machine, elle contient ceci :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: black;">&#91;</span><span style="color: #483d8b;">''</span>,
 <span style="color: #483d8b;">'/usr/bin'</span>,
 <span style="color: #483d8b;">'/usr/local/lib/python2.7/dist-packages/grin-1.2.1-py2.7.egg'</span>,
 <span style="color: #483d8b;">'/usr/lib/python2.7'</span>,
 <span style="color: #483d8b;">'/usr/lib/python2.7/plat-linux2'</span>,
 <span style="color: #483d8b;">'/usr/lib/python2.7/lib-tk'</span>,
 <span style="color: #483d8b;">'/usr/lib/python2.7/lib-old'</span>,
 <span style="color: #483d8b;">'/usr/lib/python2.7/lib-dynload'</span>,
 <span style="color: #483d8b;">'/home/sam/.local/lib/python2.7/site-packages'</span>,
 <span style="color: #483d8b;">'/usr/local/lib/python2.7/dist-packages'</span>,
 <span style="color: #483d8b;">'/usr/local/lib/python2.7/dist-packages/setuptools-0.6c11-py2.7.egg-info'</span>,
 <span style="color: #483d8b;">'/usr/lib/python2.7/dist-packages'</span>,
 <span style="color: #483d8b;">'/usr/lib/python2.7/dist-packages/PIL'</span>,
 <span style="color: #483d8b;">'/usr/lib/python2.7/dist-packages/gst-0.10'</span>,
 <span style="color: #483d8b;">'/usr/lib/python2.7/dist-packages/gtk-2.0'</span>,
 <span style="color: #483d8b;">'/usr/lib/pymodules/python2.7'</span>,
 <span style="color: #483d8b;">'/usr/lib/python2.7/dist-packages/ubuntu-sso-client'</span>,
 <span style="color: #483d8b;">'/usr/lib/python2.7/dist-packages/ubuntuone-client'</span>,
 <span style="color: #483d8b;">'/usr/lib/python2.7/dist-packages/ubuntuone-control-panel'</span>,
 <span style="color: #483d8b;">'/usr/lib/python2.7/dist-packages/ubuntuone-couch'</span>,
 <span style="color: #483d8b;">'/usr/lib/python2.7/dist-packages/ubuntuone-installer'</span>,
 <span style="color: #483d8b;">'/usr/lib/python2.7/dist-packages/ubuntuone-storage-protocol'</span>,
 <span style="color: #483d8b;">'/usr/lib/python2.7/dist-packages/wx-2.6-gtk2-unicode'</span>,
 <span style="color: #483d8b;">'/usr/lib/python2.7/dist-packages/IPython/extensions'</span><span style="color: black;">&#93;</span></pre></div></div>

<p> Donc, quand vous faites <code>import os</code>, Python va faire une boucle <code>for</code> là dessus et chercher dans chaque dossier si un package (un dossier avec un fichier <code>__init__.py</code>) ou un module (un fichier avec l&#8217;extension <em>.py</em>) nommé <code>os</code> existe.</p>
<p> Dès qu&#8217;il en trouve un, il s&#8217;arrête de chercher et l&#8217;importe. Si il n&#8217;en trouve pas, il va lever une <code>ImportError</code>.</p>
<p> Ce qui signifie que si votre module n&#8217;est PAS dans le PYTHON PATH, vous ne pouvez PAS l&#8217;importer. C&#8217;est impossible.</p>
<p> La grande majorité des problèmes d&#8217;import vient du fait que le module que vous essayez d&#8217;importer n&#8217;est pas dans le PYTHON PATH.</p>
<p> Maintenant, la grande question, c&#8217;est :</p>
<h2>Qu&#8217;est-ce qui est dans le PYTHON PATH ?</h2>
<p>Par défault, les dossiers <em>sites-packages</em> et <em>dist-packages</em> dans le dossier d&#8217;installation Python sont dans le PYTHON PATH. Quelques autres sont ajoutés selon les systèmes, mais vous pouvez toujours compter sur <em>sites-packages</em> et <em>dist-packages</em> pour être dans le PYTHON PATH. Quand vous installez une lib, par exemple avec <a href="http://sametmax.com/votre-python-aime-les-pip/">pip</a>, c&#8217;est là dedans que la lib va s&#8217;installer, pour être sûre de pouvoir être importée.</p>
<p>Quand vous êtes dans un <a href="http://sametmax.com/les-environnement-virtuels-python-virtualenv-et-virtualenvwrapper/">virtualenv</a>, les dossiers <em>sites-packages</em> et <em>dist-packages</em> de l&#8217;environnement virtuel sont ajoutés au PYTHON PATH.</p>
<p>Mais tout ça ne change pas grand chose pour vous. En effet, vous n&#8217;allez pas mettre VOTRE code dans les dossiers <em>sites-packages</em> et <em>dist-packages</em>.</p>
<p>C&#8217;est pour cela que Python possède un mécanisme supplémentaire : le dossier qui contient le module sur lequel vous lancez la commande <code>python</code> est automatiquement ajouté au PYTHON PATH.</p>
<h2>Le PYTHON PATH, en pratique</h2>
<p>Supposons que je sois dans le dossier <em>/home/sam/Bureau</em> et que j&#8217;aie dedans ce package. Voici à quoi ressemble mon arbo (<a href="https://github.com/sametmax/codes-des-articles/blob/master/2013/mai/test_imports.zip">téléchargez l&#8217;arbo vierge</a> pour vos tests):</p>
<pre><strong>/home/sam/Bureau # <-- je suis ici</strong>
.
`-- test_imports
    |-- __init__.py
    |-- package_tout_en_haut
    |   |-- __init__.py
    |   |-- autre_sous_package
    |   |   |-- __init__.py
    |   |   `-- autre_module_en_bas.py
    |   |-- sous_module.py
    |   `-- sous_package
    |       |-- __init__.py
    |       |-- autre_module_en_bas.py
    |       |-- autre_sous_package
    |       |   |-- __init__.py
    |       |   `-- autre_module_en_bas.py
    |       `-- module_tout_en_bas.py
    `-- top_module.py</pre>
<p>Si je lance un shell Python depuis ce dossier ou un script Python contenu dans ce dossier, je peux faire <code>import test_imports</code>, car <em>/home/sam/Bureau</em> est automatiquement ajouté au PYTHON PATH.</p>
<p>Je peux donc faire :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">import</span> test_imports
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">from</span> test_imports <span style="color: #ff7700;font-weight:bold;">import</span> package_tout_en_haut
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">from</span> test_imports <span style="color: #ff7700;font-weight:bold;">import</span> top_module
test_imports.<span style="color: black;">top_module</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">from</span> test_imports.<span style="color: black;">package_tout_en_haut</span> <span style="color: #ff7700;font-weight:bold;">import</span> sous_module
test_imports.<span style="color: black;">package_tout_en_haut</span>.<span style="color: black;">sous_module</span></pre></div></div>

<p>Mais si je me mets ici dans <em>./package_tout_en_haut/sous_package</em> :</p>
<pre>/home/sam/Bureau
.
`-- test_imports
    |-- __init__.py
    |-- package_tout_en_haut
    |   |-- __init__.py
    |   |-- autre_sous_package
    |   |   |-- __init__.py
    |   |   `-- autre_module_en_bas.py
    |   |-- sous_module.py
    |   `-- <strong>sous_package     # <-- je suis ici</strong>
    |       |-- __init__.py
    |       |-- autre_module_en_bas.py
    |       |-- autre_sous_package
    |       |   |-- __init__.py
    |       |   `-- autre_module_en_bas.py
    |       |-- module_tout_en_bas.py
    `-- top_module.py</pre>
<p>Je ne peux PAS importer <code>test_imports</code>, ni dans un shell, ni depuis un module de ce dossier :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">import</span> test_imports
Traceback <span style="color: black;">&#40;</span>most recent call last<span style="color: black;">&#41;</span>:
  File <span style="color: #483d8b;">&quot;&lt;stdin&gt;&quot;</span>, line <span style="color: #ff4500;">1</span>, <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #66cc66;">&lt;</span>module<span style="color: #66cc66;">&gt;</span>
<span style="color: #008000;">ImportError</span>: No module named test_imports</pre></div></div>

<p>En effet, comme je lance la commande Python depuis</p>
<p> <em>./package_tout_en_haut/sous_package</em></p>
<p> alors</p>
<p> <em>./package_tout_en_haut/sous_package</em> </p>
<p> <strong>EST</strong> ajouté au PYTHON PATH, mais </p>
<p> <em>/home/sam/Bureau/</em> </p>
<p> n&#8217;est <strong>PAS</strong> ajouté au PYTHON PATH.</p>
<p>Je ne peux donc PAS faire</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">from</span> test_imports <span style="color: #ff7700;font-weight:bold;">import</span> top_module</pre></div></div>

<p>depuis un fichier comme </p>
<p><em>.test_imports/package_tout_en_haut/sous_package/autre_module_en_bas.py</em> </p>
<p>et exécuter directement</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">python autre_module_en_bas.<span style="color: black;">py</span></pre></div></div>

<p>ni même</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">python ./test_imports/package_tout_en_haut/sous_package/autre_module_en_bas.<span style="color: black;">py</span></pre></div></div>

<p>Je peux faire</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">from</span> test_imports <span style="color: #ff7700;font-weight:bold;">import</span> top_module</pre></div></div>

<p>depuis </p>
<p><em>autre_module_en_bas.py</em> </p>
<p>uniquement si je lance un script Python tout en haut de mon arbo qui importe </p>
<p><em>autre_module_en_bas.py</em>.</p>
<h2>Mais alors, comment on fait ?<br />
</h2>
<p>Il faut s&#8217;assurer que le dossier qui contient <code>test_imports</code>, notre module racine, soit TOUJOURS dans le PYTHON PATH.</p>
<p>Il y a plusieurs possibilités pour cela.</p>
<p>La première, c&#8217;est que notre lib va être utilisée une fois installée avec pip. Dans ce cas, on s&#8217;en branle, <code>test_imports</code> sera dans sites-packages automatiquement, et on pourra faire <code>from test_imports import top_module </code> de partout joyeusement.</p>
<p>Mais souvent, ce n&#8217;est pas le cas, votre code n&#8217;est pas fait pour être installé.</p>
<p>La seconde technique consiste à s&#8217;assurer que l&#8217;on appelle TOUJOURS la commande Python depuis le dossier qui est tout au dessus. C&#8217;est ce que fait django avec sa commande <code>./manage.py</code> par exemple.</p>
<p>Vous avez votre projet :</p>
<pre>./manage.py
projet</pre>
<p>Et tout passe par <code>python manage.py</code>, qui est au dessus de projet, donc le dossier est bien ajouté au PYTHON PATH, et tout va bien.</p>
<p>Dans votre cas ça veut dire vous assurer qu&#8217;on lance toujours votre programme depuis un script d&#8217;entrée qui est tout en haut de votre arborescence.</p>
<p>Ca veut dire que vous devez avoir un point d&#8217;entrée UNIQUE pour votre package.</p>
<p>Mais parfois ça ne convient pas. Dans le cas des tests unitaires par exemple, il vous faut un point d&#8217;entrée spécialement pour les tests.</p>
<p>Pour ce genre de scénario, il faut donc avoir le dossier qui les contient <strong>à côté</strong> de votre package.  Ainsi, si j&#8217;avais des tests unitaires, je devrais faire un dossier <em>tests</em> à côté du dossier <em>test_imports</em>. Par exemple, transformer mon arbo en un truc comme ça :</p>
<pre>src
   |_ test_imports
   |_ tests
</pre>
<p>Afin que je lance les tests en faisant <code>python tests</code> depuis <em>src</em>. Et dans mes fichiers de tests, je pourrai faire des <code>from test_imports import truc</code>.</p>
<p>La manière dont vous organisez votre projet est donc très importante en Python, et si vous avez des problèmes d&#8217;import, la première chose à faire est de changer sa structure. Il n&#8217;y a pas de magie.</p>
<p>La dernière possibilité, quand tout a échoué, c&#8217;est de rajouter à la main le dossier dans le PYTHON PATH. <code>sys.path</code> est une simple liste, on peut donc faire un <code>append()</code> dessus.</p>
<p>Par exemple, si je veux absolument (mais je ne devrais pas :-)) pouvoir faire :</p>
<p><code>python .test_imports/package_tout_en_haut/sous_package/autre_module_en_bas.py</code> et importer <code>test_imports</code> dans <em>autre_module_en_bas.py</em>, je peux faire un truc du genre :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">os</span>
&nbsp;
dossier = <span style="color: #dc143c;">os</span>.<span style="color: black;">path</span>.<span style="color: black;">dirname</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">os</span>.<span style="color: black;">path</span>.<span style="color: black;">abspath</span><span style="color: black;">&#40;</span>__file__<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">while</span> <span style="color: #ff7700;font-weight:bold;">not</span> dossier.<span style="color: black;">endswith</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'test_imports'</span><span style="color: black;">&#41;</span>:
    dossier = <span style="color: #dc143c;">os</span>.<span style="color: black;">path</span>.<span style="color: black;">dirname</span><span style="color: black;">&#40;</span>dossier<span style="color: black;">&#41;</span>
&nbsp;
dossier = <span style="color: #dc143c;">os</span>.<span style="color: black;">path</span>.<span style="color: black;">dirname</span><span style="color: black;">&#40;</span>dossier<span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">if</span> dossier <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #dc143c;">sys</span>.<span style="color: black;">path</span>:
    <span style="color: #dc143c;">sys</span>.<span style="color: black;">path</span>.<span style="color: black;">append</span><span style="color: black;">&#40;</span>dossier<span style="color: black;">&#41;</span></pre></div></div>

<p>Ce code va remonter dans l&#8217;arbo jusqu&#8217;à tomber sur le chemin du dossier <em>test_imports</em> et ajouter son dossier parent au PYTHON PATH.</p>
<p>Ce n&#8217;est pas le truc le plus propre du monde, mais ça peut dépanner.</p>
<h2>Imports absolus et relatifs</h2>
<p>Si vous êtes dans <em>./package_tout_en_haut/sous_package</em> :</p>
<pre>/home/sam/Bureau
.
`-- test_imports
    |-- __init__.py
    |-- package_tout_en_haut
    |   |-- __init__.py
    |   |-- autre_sous_package
    |   |   |-- __init__.py
    |   |   `-- autre_module_en_bas.py
    |   |-- sous_module.py
    |   `-- <strong>sous_package     # <-- je suis ici</strong>
    |       |-- __init__.py
    |       |-- autre_module_en_bas.py
    |       |-- autre_sous_package
    |       |   |-- __init__.py
    |       |   `-- autre_module_en_bas.py
    |       |-- module_tout_en_bas.py
    |       `-- test_imports  # <-- autre package nommé test_imports
    |           `-- sous_module.py
    `-- top_module.py</pre>
<p>Vous voyez que vous avez deux packages nommés <em>test_imports</em>.</p>
<p>Si vous écrivez <code>import test_imports</code> dans <em>autre_module_en_bas.py</em>, que va-t-il se passer ?</p>
<p>C'est le module tout en bas qui va être importé.</p>
<p>Ce n'est pas forcément ce que vous voulez. Python 3 corrige cela en permettant des imports relatifs, et Python 2.7 peut en bénéficier en important tout en haut du module :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">__future__</span> <span style="color: #ff7700;font-weight:bold;">import</span> absolute_import</pre></div></div>

<p>En faisant cela, vous obtenez le comportement de Python 3 dans Python 2.7, et vous pourrez alors choisir entre faire :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> test_imports <span style="color: #808080; font-style: italic;"># importe le module tout en haut</span>
<span style="color: #ff7700;font-weight:bold;">import</span> .<span style="color: black;">test_imports</span> <span style="color: #808080; font-style: italic;"># import le module dans le même dossier</span>
<span style="color: #ff7700;font-weight:bold;">from</span> .<span style="color: black;">test_imports</span> <span style="color: #ff7700;font-weight:bold;">import</span> sous_module
<span style="color: #ff7700;font-weight:bold;">from</span> test_imports <span style="color: #ff7700;font-weight:bold;">import</span> top_module</pre></div></div>

<p>Je vous recommande de toujours utiliser <em>from __future__ import absolute_import</em>. Ca ne coûte rien, et c'est plus cohérent. Par contre, vous ne pourrez pas tester <em>from __future__ import absolute_import</em> dans le shell, donc cet exemple ne marche pas dans ipython, mais il fonctionne parfaitement dans vos modules.</p>
<p>On peut aussi faire des imports relatifs du package contenant avec :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">from</span> .. <span style="color: #ff7700;font-weight:bold;">import</span> truc
<span style="color: #ff7700;font-weight:bold;">from</span> ..<span style="color: black;">package</span> <span style="color: #ff7700;font-weight:bold;">import</span> machin</pre></div></div>

<p>N'oubliez pas que ceci ne marche que :</p>
<ul>
<li>Si <code>from __future__ import absolute_import</code> est activé.</li>
<li>Le package tout en haut (celui qui contient tous les autres) est dans le PYTHON PATH</li>
</ul>
<p>Sinon, ça ne sert A RIEN. Ce n'est pas comme un <em>../</em> dans un bash. Ça ne remonte pas d'un dossier. C'est juste une notation pour dire j'utilise celui la plutôt que l'autre, quand il y a ambiguité.</p>
<h2>Pièges des imports</h2>
<h3>Package sans init</h3>
<p>Si vous avez :</p>
<pre>.
`-- test_imports
    |-- __init__.py
    |-- package_sans_init
    |   `-- nada.py</pre>
<p><em>nada.py</em> n'est pas importable, car <em>package_sans_init</em> ne contient pas de fichier <em>__init__.py</em>, même si <em>test_imports</em> est dans le PYTHON PATH. Ce comportement est corrigé en Python 3, et tout sous-dossier d'un package importable est automatiquement importable, qu'il contienne un <em>__init__.py</em> ou non.</p>
<h3>Imports circulaires</h3>
<p>J'en ai déjà parlé <a href="http://sametmax.com/quelques-erreurs-tordues-et-leurs-solutions-en-python/">ici</a>.</p>
<p>Vous avez :</p>
<pre>.
`-- test_imports
    |-- __init__.py
    |-- package_tout_en_haut
    |   |-- __init__.py
    |   `-- sous_package
    |       |-- __init__.py
    |       |-- autre_module_en_bas.py
    |       `-- module_tout_en_bas.py</pre>
<p>Et vous importez <code>autre_module_en_bas</code> dans <code>module_tout_en_bas</code> et inversement. Non seulement ça ne marchera pas, mais en plus l'erreur est déroutante :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #008000;">ImportError</span>: No module named module_tout_en_bas</pre></div></div>

<p>Oui vous avez bien lu, il va vous dire que le module n'existe pas !</p>
<p>Il n'y a pas non plus de solution propre à ce problème : soit vous fusionnez vos deux fichiers, soit vous faites un 3eme module qui utilise ces deux modules (et ces deux modules n'importent pas ce 3eme module).</p>
<p>Sinon il y a la solution crade : mettre un des imports dans un appel de fonction ou de méthode comme ça:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> truc<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">import</span> module_tout_en_bas
    module_tout_en_bas.<span style="color: black;">bidule</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre></div></div>

<p>Parfois, ça dépanne :-) On ne tue pas des chatons non plus, donc si ça ne devient pas une habitude, ça peut passer.</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=6127&amp;md5=6dfcefd6dd5011b94280860d37ab983d" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/les-imports-en-python/feed/</wfw:commentRss>
		<slash:comments>14</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fles-imports-en-python%2F&amp;language=en_GB&amp;category=text&amp;title=Les+imports+en+Python&amp;description=Je+suis+fan+de+carmina+burrana+depuis+l%26%238217%3Bage+de+12+ans%2C+alors+pourquoi+pas+O+Fortuna+comme+musique+d%26%238217%3Bambiance+%3A+Les+imports%2C+c%26%238217%3B%C3%A9tait+fastoche.+Vous+%C3%A9tiez+dans+votre+petit+programme%2C...&amp;tags=import%2Cmodule%2Cpackage%2Cpython%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/05/tumblr_mj4zt7GH891r539hzo1_500.jpg" length="77621" type="image/jpg" />	</item>
		<item>
		<title>Include / require / import en javascript</title>
		<link>http://sametmax.com/include-require-import-en-javascript/</link>
		<comments>http://sametmax.com/include-require-import-en-javascript/#comments</comments>
		<pubDate>Thu, 03 Jan 2013 15:04:33 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[import]]></category>
		<category><![CDATA[include]]></category>
		<category><![CDATA[javascript]]></category>
		<category><![CDATA[require]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=3977</guid>
		<description><![CDATA[On ne peut pas inclure un script dans un script en JS. Il n'y a pas de mot clé <code>import</code>, <code>include</code> ou <code>require</code>.

On peut néanmoins trouve un moyen d'inclure du code en le téléchargeant et en l'incluant dans la page.]]></description>
			<content:encoded><![CDATA[<p>On ne peut pas inclure un script dans un script en JS dans un navigateur Web. Il n&#8217;y a pas de mot clé <code>import</code>, <code>include</code> ou <code>require</code>.</p>
<p>On peut néanmoins trouver un moyen d&#8217;inclure du code en le téléchargeant et en l&#8217;incluant dans la page.</p>
<h2>Solution 1, la bourrine</h2>
<p>On peut faire une requête GET et un <code>eval sur</code>. C&#8217;est dangereux. C&#8217;est bancal. Ca marche que pour le domaine en cours. C&#8217;est pas une bonne idée. Je ne vous le montre donc pas.</p>
<h2>Solution 2, la maline</h2>
<p>On va créer une balise <code>&lt;script&gt;&lt;/script&gt;</code> et la faire pointer sur le fichier à télécharger. Ainsi on utilise le mécanisme naturel pour le navigateur d&#8217;include du code.</p>

<div class="wp_syntax"><div class="code"><pre class="javascript" style="font-family:monospace;">var include = function(url, callback){
&nbsp;
    /* on crée une balise<span style="color: #339933;">&lt;</span>script type<span style="color: #339933;">=</span><span style="color: #3366CC;">&quot;text/javascript&quot;</span><span style="color: #339933;">&gt;&lt;/</span>script<span style="color: #339933;">&gt;</span> */
    var script = document.createElement('script');
    script.type = 'text/javascript';
&nbsp;
    /* On fait pointer la balise sur le script qu'on veut charger
       avec en prime un timestamp pour éviter les problèmes de cache
    */
&nbsp;
    script.src = url + '?' + (new Date().getTime());
&nbsp;
    /* On dit d'exécuter cette fonction une fois que le script est chargé */
    if (callback) {
        script.onreadystatechange = callback;
        script.onload = script.onreadystatechange;
    }
&nbsp;
    /* On rajoute la balise script dans le head, ce qui démarre le téléchargement */
    document.getElementsByTagName('head')[0].appendChild(script);
}</pre></div></div>

<p>Ca s&#8217;utilise comme ça:</p>

<div class="wp_syntax"><div class="code"><pre class="javascript" style="font-family:monospace;">include<span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'http://adressedemonscript.com/fichier.js'</span><span style="color: #339933;">,</span> <span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    code à exécuter une fois que le script est chargé
<span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span></pre></div></div>

<p>La partie <a href="http://sametmax.com/quest-ce-quun-callback/">callback</a> est très importante. En effet, si vous essayez d&#8217;exécuter du code <strong>après</strong> <code>include()</code> qui dépend du code chargé <strong>par</strong> <code>include()</code>, ça va foirer : le code n&#8217;est pas encore téléchargé. En effet, les navigateurs téléchargent les balises scripts en arrière plan et en parallèle :</p>

<div class="wp_syntax"><div class="code"><pre class="javascript" style="font-family:monospace;">include<span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'http://adressedemonscript.com/fichier.js'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
code à exécyter une fois que le script est chargé</pre></div></div>

<p>Il faut donc mettre ce code dans un callback, pour garantir qu&#8217;il soit lancé quand le script a terminé de chargé.</p>
<h2>Solution 3, la coquine</h2>
<p>jQuery, encore et toujours, possède un raccourcis pour faire tout ça pour vous:</p>

<div class="wp_syntax"><div class="code"><pre class="javascript" style="font-family:monospace;">$<span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'http://adressedemonscript.com/fichier.js'</span><span style="color: #339933;">,</span> <span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    code à exécuter une fois que le script est chargé
<span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span></pre></div></div>

 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=3977&amp;md5=1374a11b2d312b98816e58e65fcf5b5a" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/include-require-import-en-javascript/feed/</wfw:commentRss>
		<slash:comments>17</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Finclude-require-import-en-javascript%2F&amp;language=en_GB&amp;category=text&amp;title=Include+%2F+require+%2F+import+en+javascript&amp;description=On+ne+peut+pas+inclure+un+script+dans+un+script+en+JS+dans+un+navigateur+Web.+Il+n%26%238217%3By+a+pas+de+mot+cl%C3%A9+import%2C+include+ou+require.+On+peut+n%C3%A9anmoins...&amp;tags=import%2Cinclude%2Cjavascript%2Crequire%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2012/12/Car-Carrier-RoRo-TransAtlantic-Import-Service-Maps.gif" length="22360" type="image/jpg" />	</item>
		<item>
		<title>Se faciliter les imports avec les fichiers *.pth</title>
		<link>http://sametmax.com/se-faciliter-les-imports-avec-les-fichiers-pth/</link>
		<comments>http://sametmax.com/se-faciliter-les-imports-avec-les-fichiers-pth/#comments</comments>
		<pubDate>Mon, 10 Sep 2012 16:49:24 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[import]]></category>
		<category><![CDATA[path]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[python path]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=2082</guid>
		<description><![CDATA[Dans un article, nous parlions des extensions alternatives en Python, et notamment de l'usage des fichiers <em>*.pth</em>. Néanmoins cette extension est souvent mal comprise, et voici un comment en profiter au maximum.]]></description>
			<content:encoded><![CDATA[<p>Dans un article, nous parlions des <a href="http://sametmax.com/astuces-python-en-vrac/">extensions alternatives en Python</a>, et notamment de l&#8217;usage des fichiers <em>*.pth</em>. Néanmoins cette extension est souvent mal comprise, et voici un comment en profiter au maximum.</p>
<p>En Python, on a souvent des problèmes d&#8217;import: la lib est dans un dossier au dessous, ou à côté, ou à l&#8217;autre bout du disque dur, et ça plantouille parceque Python ne trouve pas le module.</p>
<p>Il existe plein de moyens de jouer avec le fameux <code>PYTHON_PATH</code> qui contient la liste des dossiers dans lesquelles chercher les libs, et la plupart sont fort verbeuses et répétitives, du genre:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">os</span>
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">sys</span>
&nbsp;
CUR_DIR = <span style="color: #dc143c;">os</span>.<span style="color: black;">path</span>.<span style="color: black;">dirname</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">os</span>.<span style="color: black;">path</span>.<span style="color: black;">realpath</span><span style="color: black;">&#40;</span>__file__<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #dc143c;">sys</span>.<span style="color: black;">path</span>.<span style="color: black;">extend</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span>
    <span style="color: #dc143c;">os</span>.<span style="color: black;">path</span>.<span style="color: black;">join</span><span style="color: black;">&#40;</span>CUR_DIR, <span style="color: #483d8b;">'apps'</span><span style="color: black;">&#41;</span>,
    <span style="color: #dc143c;">os</span>.<span style="color: black;">path</span>.<span style="color: black;">join</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">os</span>.<span style="color: black;">path</span>.<span style="color: black;">dirname</span><span style="color: black;">&#40;</span>CUR_DIR<span style="color: black;">&#41;</span>, <span style="color: #483d8b;">'libs'</span><span style="color: black;">&#41;</span>,
    <span style="color: #dc143c;">os</span>.<span style="color: black;">path</span>.<span style="color: black;">join</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">os</span>.<span style="color: black;">path</span>.<span style="color: black;">realpath</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'~'</span><span style="color: black;">&#41;</span>, <span style="color: #483d8b;">'.local_libs'</span><span style="color: black;">&#41;</span>
<span style="color: black;">&#93;</span><span style="color: black;">&#93;</span><span style="color: black;">&#125;</span></pre></div></div>

<p>Une manière simple est d&#8217;utiliser un fichier <em>*.pth</em>: on créé un fichier texte, on le nomme <em>comme-on-veut.pth</em> (moi je me fais pas chier, je le nomme .pth comme ça c&#8217;est court et c&#8217;est caché sous nunux), et on liste tous les dossiers qu&#8217;on veut ajouter au <code>PYTHON_PATH</code>, y compris avec des chemins relatifs.</p>
<p>Oui mais, argh parmi les argh, la première fois qu&#8217;on le fait, ça ne marche pas. Alors on cherche dans la doc, et là, fustration, on apprend que les fichiers <em>*.pth</em> ne sont parsés que dans les sites directories, c&#8217;est à dire les dossiers officiels du système dans lesquels sont censés être les libs de la bibliothèque standard. Donc pas le dossier courant.</p>
<p>Eh oui, ces fichiers ont été conçus pour faciliter les déploiements, du genre quand on fait un setup.py pour son app, pas pour nous, pauvres mortels.</p>
<p>Heureusement il y a une solution Sam et Max à tout, et ici elle consiste à faire:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">os</span>
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">site</span>
&nbsp;
CUR_DIR = <span style="color: #dc143c;">os</span>.<span style="color: black;">path</span>.<span style="color: black;">dirname</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">os</span>.<span style="color: black;">path</span>.<span style="color: black;">realpath</span><span style="color: black;">&#40;</span>__file__<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #dc143c;">site</span>.<span style="color: black;">addsitedir</span><span style="color: black;">&#40;</span>CUR_DIR<span style="color: black;">&#41;</span></pre></div></div>

<p>Quelque part dans son code n&#8217;importe où qui est sûr d&#8217;être éxécuté tôt, par exemple dans Django, dans le <em>settings.py</em>. Ca ajoute le dossier du projet en tant que site directory, et donc le fichier <em>.pth</em> est parsé. On peut alors dumper son listing dedans sans avoir à le répéter dans tous les scripts et fichiers qui doivent l&#8217;utiliser (et ainsi modifier cette liste facilement).</p>
<p>Attention cependant, celà rajoute votre dossier de projet dans le <code>PYTHON_PATH</code>, rendant tout ce qu&#8217;il contient importable. Normalement, c&#8217;est ce que vous voulez, mais si ce n&#8217;est pas le cas, vous pouvez avoir une gestion plus fine en ajoutant juste le fichier .pth avec <code>site.addpackage(CUR_DIR, 'fichier.pth', set())</code></p>
<h2>La feature de magie noire</h2>
<p>Dans les fichiers <em>*.pth</em>, il y a un support limité de la syntaxe Python: on peut commenter des lignes avec <code>#</code> et faire des <code>import truc</code>. </p>
<p>Sauf que si vous êtes curieux, vous verrez le détail qui tue dans l&#8217;implémentation:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">if</span> line.<span style="color: black;">startswith</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;import &quot;</span>, <span style="color: #483d8b;">&quot;import<span style="color: #000099; font-weight: bold;">\t</span>&quot;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">exec</span> line</pre></div></div>

<p>On peut donc virtuellement mettre n&#8217;importe quel code Python dans les fichiers <em>*.pth</em>. Par exemple:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">../foo
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">sys</span><span style="color: #66cc66;">;</span> <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Foo a été ajouté au PYTHON PATH&quot;</span></pre></div></div>

<p>Va afficher &#8220;Foo a été ajouté au PYTHON PATH&#8221; au démarrage du programme. Amusant. Et tellement de potentiels pour faire des trucs tordus !</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=2082&amp;md5=bb0af1319d87aa471e954c4726cdc67b" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/se-faciliter-les-imports-avec-les-fichiers-pth/feed/</wfw:commentRss>
		<slash:comments>1</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fse-faciliter-les-imports-avec-les-fichiers-pth%2F&amp;language=en_GB&amp;category=text&amp;title=Se+faciliter+les+imports+avec+les+fichiers+%2A.pth&amp;description=Dans+un+article%2C+nous+parlions+des+extensions+alternatives+en+Python%2C+et+notamment+de+l%26%238217%3Busage+des+fichiers+%2A.pth.+N%C3%A9anmoins+cette+extension+est+souvent+mal+comprise%2C+et+voici+un+comment+en+profiter...&amp;tags=import%2Cpath%2Cpython%2Cpython+path%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2012/09/yoda-vs-hulk.jpg" length="118963" type="image/jpg" />	</item>
		<item>
		<title>Astuces Python en vrac</title>
		<link>http://sametmax.com/astuces-python-en-vrac/</link>
		<comments>http://sametmax.com/astuces-python-en-vrac/#comments</comments>
		<pubDate>Fri, 03 Aug 2012 13:15:35 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[import]]></category>
		<category><![CDATA[iterable]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[slice]]></category>
		<category><![CDATA[yield]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=1463</guid>
		<description><![CDATA[Je n'arrive pas à trouver un lien entre tous ces trucs, alors un bon vrac fera l'affaire.]]></description>
			<content:encoded><![CDATA[<p>Je n&#8217;arrive pas à trouver un lien entre tous ces trucs, alors un bon vrac fera l&#8217;affaire.</p>
<h2>Float accepte de parser l&#8217;infini<br />
</h2>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> infini = <span style="color: #008000;">float</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'inf'</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> infini
inf
<span style="color: #66cc66;">&gt;&gt;&gt;</span> infini + <span style="color: #ff4500;">1</span>
inf
<span style="color: #66cc66;">&gt;&gt;&gt;</span> infini - <span style="color: #ff4500;">1</span>
inf
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">float</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'-inf'</span><span style="color: black;">&#41;</span>
-inf
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">float</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'-inf'</span><span style="color: black;">&#41;</span> + <span style="color: #ff4500;">1</span>
-inf
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">float</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'inf'</span><span style="color: black;">&#41;</span> + <span style="color: #008000;">float</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'-inf'</span><span style="color: black;">&#41;</span>
nan</pre></div></div>

<p>Attention, il est très probable que ce soit dépendant de l&#8217;implémentation CPython.</p>
<h2><code>Iter()</code> peut prendre un callable en argument</h2>
<p><code>iter()</code>, c&#8217;est la fonction qui créé un générateur à partir d&#8217;un itérable:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> generateur = <span style="color: #008000;">iter</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span>, <span style="color: #ff4500;">3</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> generateur.<span style="color: black;">next</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #ff4500;">1</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> generateur.<span style="color: black;">next</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #ff4500;">2</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> generateur.<span style="color: black;">next</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #ff4500;">3</span></pre></div></div>

<p>Il se trouve qu&#8217;il a aussi une autre forme: <code>iter(callable, sentinel)</code>.</p>
<p>Sous cette forme, il va créer une générateur qui appelle <code>callable</code> jusqu&#8217;à ce que la valeur <code>sentinel</code> apparaisse.</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">datetime</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #dc143c;">datetime</span>.<span style="color: #dc143c;">datetime</span>.<span style="color: black;">now</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>.<span style="color: black;">strftime</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;%S&quot;</span><span style="color: black;">&#41;</span>
<span style="color: #483d8b;">'45'</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> generateur = <span style="color: #008000;">iter</span><span style="color: black;">&#40;</span><span style="color: #ff7700;font-weight:bold;">lambda</span>: <span style="color: #dc143c;">datetime</span>.<span style="color: #dc143c;">datetime</span>.<span style="color: black;">now</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>.<span style="color: black;">strftime</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;%S&quot;</span><span style="color: black;">&#41;</span>, <span style="color: #483d8b;">&quot;59&quot;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> generateur.<span style="color: black;">next</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #483d8b;">'56'</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> generateur.<span style="color: black;">next</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #483d8b;">'57'</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> generateur.<span style="color: black;">next</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #483d8b;">'58'</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> generateur.<span style="color: black;">next</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
Traceback <span style="color: black;">&#40;</span>most recent call last<span style="color: black;">&#41;</span>:
  File <span style="color: #483d8b;">&quot;&lt;ipython-input-45-6c9f9efdd35c&gt;&quot;</span>, line <span style="color: #ff4500;">1</span>, <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #66cc66;">&lt;</span>module<span style="color: #66cc66;">&gt;</span>
    generateur.<span style="color: black;">next</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #008000;">StopIteration</span></pre></div></div>

<h2>Chainer les comparateurs</h2>
<p>Histoire de diminuer le nombre de <code>if</code>:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> a, b, c, d = <span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span>, <span style="color: #ff4500;">3</span>, <span style="color: #ff4500;">4</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> a <span style="color: #66cc66;">&lt;</span> b <span style="color: #66cc66;">&lt;</span> c <span style="color: #66cc66;">&lt;</span> d
<span style="color: #008000;">True</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> a == <span style="color: #ff4500;">1</span> <span style="color: #66cc66;">&gt;</span> b -<span style="color: #ff4500;">2</span>
<span style="color: #008000;">True</span></pre></div></div>

<h2>Le mot clé <code>else</code>, en dehors de <code>if</code></h2>
<p><code>Else</code> ne s&#8217;applique pas qu&#8217;aux conditions, mais aussi aux exceptions et aux boucles.</p>
<p>Dans une boucle for, la clause <code>else</code> est exécutée à la fin de l&#8217;itération si il n&#8217;y a pas eu de <code>break</code>.</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">random</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> lst = <span style="color: black;">&#91;</span><span style="color: #dc143c;">random</span>.<span style="color: black;">randint</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">5</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">xrange</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">5</span><span style="color: black;">&#41;</span><span style="color: black;">&#93;</span>
... <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> lst:
...     <span style="color: #ff7700;font-weight:bold;">if</span> x == <span style="color: #ff4500;">5</span>:
...         <span style="color: #ff7700;font-weight:bold;">break</span>
... <span style="color: #ff7700;font-weight:bold;">else</span>:
...     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;5 n'a jamais été trouvé&quot;</span></pre></div></div>

<p>Dans la gestion des exceptions, <code>else</code> est éxécuté si <code>catch</code> n&#8217;est jamais appelé:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">try</span>:
    <span style="color: #008000;">open</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'fichier'</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: #008000;">IOError</span>:
    <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Une IO Error est arrivée&quot;</span>
<span style="color: #ff7700;font-weight:bold;">else</span>:
    <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Tout s'est bien passé&quot;</span>
<span style="color: #ff7700;font-weight:bold;">finally</span>:
    <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Toujours éxécuté&quot;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Exécuté si on est rentré dans except ou else&quot;</span></pre></div></div>

<h2>Continuation de lignes avec les parenthèses</h2>
<p><code>\</code> sur les longues lignes, ça va 5 minutes.</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">from</span> force <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: black;">&#40;</span>rouge, bleu, jaune, vert, noir, blanc, rose, fushia,
                   vermeille, vers_a_pois_jaune, call<span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># ici le multi line édit de sublime text m'a vachement aidé</span>
<span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: black;">&#40;</span>rouge.<span style="color: black;">transformation</span> <span style="color: #ff7700;font-weight:bold;">and</span> bleu.<span style="color: black;">transformation</span> <span style="color: #ff7700;font-weight:bold;">and</span> jaune.<span style="color: black;">transformation</span>
        <span style="color: #ff7700;font-weight:bold;">and</span> vert.<span style="color: black;">transformation</span> <span style="color: #ff7700;font-weight:bold;">and</span> noir.<span style="color: black;">transformation</span> <span style="color: #ff7700;font-weight:bold;">and</span> blanc.<span style="color: black;">transformation</span>
        <span style="color: #ff7700;font-weight:bold;">and</span> rose.<span style="color: black;">transformation</span> <span style="color: #ff7700;font-weight:bold;">and</span> fushia.<span style="color: black;">transformation</span>
        <span style="color: #ff7700;font-weight:bold;">and</span>  vermeille.<span style="color: black;">transformation</span> <span style="color: #ff7700;font-weight:bold;">and</span> vers_a_pois_jaune.<span style="color: black;">transformation</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;C'est bon là je crois qu'on a tout le monde sauf erreur de ma part&quot;</span>
           <span style="color: #483d8b;">&quot; dans le comptage... Ah non merde il manque jaune devant marron &quot;</span>
           <span style="color: #483d8b;">&quot;derrière&quot;</span><span style="color: black;">&#41;</span>
    call<span style="color: black;">&#40;</span>force=<span style="color: #483d8b;">'jaune_devant_marron_derriere'</span>, message=<span style="color: #483d8b;">&quot;Ramène ton cul tout&quot;</span>
                                                       <span style="color: #483d8b;">&quot;de suite !&quot;</span><span style="color: black;">&#41;</span></pre></div></div>

<h2>Les extensions <code>.pyw</code>, <code>.pyo</code> et <code>.pth</code></h2>
<p>Vous croyiez qu&#8217;il n&#8217;y avait que <code>.py</code> et <code>.pyc</code> dans la vie ? Ah, jeunes padawans&#8230;</p>
<p><code>.pyw</code> est juste un renommage, il permet, sous Windows, de ne pas ouvrir de terminal quand on lance le script (ce qui est préférable quand on a déjà une UI)</p>
<p><code>.pyo</code> est l&#8217;extension générée quand on lance la commande <code>python</code> avec l&#8217;option <code>-o</code> (optimize). Pour le moment il retire juste les <code>assert</code>.</p>
<p><code>.pth</code> est l&#8217;extension qu&#8217;on donne à un simple fichier texte qui contient une liste de chemins de dossiers. Posé à la racine d&#8217;un site directory, il dit à Python de rajouter automatiquement ces dossiers au Python Path, ce qui évite de manipuler <code>sys.path</code>.</p>
<h2>Lever une exception à nouveau</h2>
<p>Il suffit d&#8217;utiliser <code>raise</code> sans paramètre. Pratique quand on ne veut pas interrompre la remontée d&#8217;exception, et insérer un traitement juste avant que l&#8217;exception se déclenche (en opposition à <code>finally</code> qui garanti le traitement, pas le moment de celui-ci.)</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">try</span>:
    <span style="color: #008000;">open</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'fichier'</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: #008000;">IOError</span>:
    <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;pouet&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">raise</span></pre></div></div>

<h2>Passer une valeur à un générateur</h2>
<p>Vous aimez <a href="http://sametmax.com/comment-utiliser-yield-et-les-generateurs-en-python/">yield</a> ? Vous en abusez ? Sachez qu&#8217;on peut faire plus vicieux encore:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> je_te_yield_tu_me_yield<span style="color: black;">&#40;</span>lst<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> lst:
        nouvelle_liste = <span style="color: #ff7700;font-weight:bold;">yield</span> x
        <span style="color: #ff7700;font-weight:bold;">if</span> nouvelle_liste <span style="color: #ff7700;font-weight:bold;">is</span> <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #008000;">None</span>:
            <span style="color: #ff7700;font-weight:bold;">for</span> z <span style="color: #ff7700;font-weight:bold;">in</span> nouvelle_liste:
                <span style="color: #ff7700;font-weight:bold;">print</span> z</pre></div></div>

<p>Le truc tordu est qu&#8217;ici <code>yield</code> est dans un assignement. Non seulement il retourne une valeur, mais en plus il en récupère une. <code>send()</code> permet de passer une valeur à <code>yield</code> à son prochain retour (sinon la valeur reçue est toujours <code>None</code>):</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> generateur = je_te_yield_tu_me_yield<span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span>, <span style="color: #ff4500;">3</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> generateur.<span style="color: black;">next</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #ff4500;">1</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> generateur.<span style="color: black;">next</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #ff4500;">2</span>    
<span style="color: #66cc66;">&gt;&gt;&gt;</span> generateur.<span style="color: black;">send</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'a'</span>, <span style="color: #483d8b;">'b'</span>, <span style="color: #483d8b;">'c'</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
a
b
c
<span style="color: #ff4500;">3</span></pre></div></div>

<h2>On peut inverser les booléens avec 1/0 et vice-versa</h2>
<p>Les booléens ne sont qu&#8217;une surcouche des entiers, et même si:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">type</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span> 
<span style="color: #66cc66;">&lt;</span>type <span style="color: #483d8b;">'int'</span><span style="color: #66cc66;">&gt;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">type</span><span style="color: black;">&#40;</span><span style="color: #008000;">bool</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&lt;</span>type <span style="color: #483d8b;">'type'</span><span style="color: #66cc66;">&gt;</span></pre></div></div>

<p>Dans la pratique:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff4500;">1</span> == <span style="color: #008000;">True</span>
<span style="color: #008000;">True</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff4500;">0</span> == <span style="color: #008000;">False</span>
<span style="color: #008000;">True</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff4500;">2</span> == <span style="color: #008000;">True</span>
<span style="color: #008000;">False</span></pre></div></div>

<p>On peut donc les interchanger:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">True</span> + <span style="color: #ff4500;">1</span> <span style="color: #808080; font-style: italic;"># pas sur que ce soit utile</span>
<span style="color: #ff4500;">2</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> lst = <span style="color: black;">&#91;</span><span style="color: #483d8b;">'a'</span>, <span style="color: #483d8b;">'b'</span><span style="color: black;">&#93;</span> <span style="color: #808080; font-style: italic;"># par contre ça c'est cool pour les binary trees</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> lst<span style="color: black;">&#91;</span><span style="color: #008000;">False</span><span style="color: black;">&#93;</span>
<span style="color: #483d8b;">'a'</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> lst<span style="color: black;">&#91;</span><span style="color: #008000;">True</span><span style="color: black;">&#93;</span>
<span style="color: #483d8b;">'b'</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> fin_de_phrase = <span style="color: #008000;">True</span> <span style="color: #808080; font-style: italic;"># et ça c'est TRES pratique pour le formating</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;... d'une longue histoire&quot;</span> + <span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;.&quot;</span> <span style="color: #66cc66;">*</span> fin_de_phrase<span style="color: black;">&#41;</span>
... <span style="color: black;">d</span><span style="color: #483d8b;">'une longue histoire.
&gt;&gt;&gt; fin_de_phrase = False
&gt;&gt;&gt; print &quot;... d'</span>une longue histoire<span style="color: #483d8b;">&quot; + (&quot;</span>.<span style="color: #483d8b;">&quot; * fin_de_phrase)
... d'une longue histoire</span></pre></div></div>

<h2><code>_</code> contient la dernière sortie sur le shell</h2>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> _
<span style="color: #483d8b;">'b'</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff4500;">1</span> + <span style="color: #ff4500;">1</span>
<span style="color: #ff4500;">2</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> _
<span style="color: #ff4500;">2</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> _ + <span style="color: #ff4500;">1</span>
<span style="color: #ff4500;">3</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> a = <span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span>, <span style="color: #ff4500;">3</span><span style="color: black;">&#93;</span>
<span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span>, <span style="color: #ff4500;">3</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> _.<span style="color: black;">append</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">4</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> a
<span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span>, <span style="color: #ff4500;">3</span>, <span style="color: #ff4500;">4</span><span style="color: black;">&#93;</span></pre></div></div>

<p>Ca ne marche que dans le shell, et uniquement sur ce qui est affiché à l&#8217;écran. Si vous n&#8217;affichez pas la valeur, <code>_</code> ne change pas. Attention à ne pas trop compter sur <code>_</code> car il est très volatile.</p>
<h2><code>Enumerate()</code> accepte un index de départ</h2>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">for</span> i, elem <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">enumerate</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'azerty'</span><span style="color: black;">&#41;</span>:
...     <span style="color: #ff7700;font-weight:bold;">print</span> i, elem
...     
<span style="color: #ff4500;">0</span> a
<span style="color: #ff4500;">1</span> z
<span style="color: #ff4500;">2</span> e
<span style="color: #ff4500;">3</span> r
<span style="color: #ff4500;">4</span> t
<span style="color: #ff4500;">5</span> y
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">for</span> i, elem <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">enumerate</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'azerty'</span>, <span style="color: #ff4500;">10</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">print</span> i, elem
...     
<span style="color: #ff4500;">10</span> a
<span style="color: #ff4500;">11</span> z
<span style="color: #ff4500;">12</span> e
<span style="color: #ff4500;">13</span> r
<span style="color: #ff4500;">14</span> t
<span style="color: #ff4500;">15</span> y</pre></div></div>

<h2>On peut assigner et supprimer des slices</h2>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> a = <span style="color: #008000;">range</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">10</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> a
<span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span>, <span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span>, <span style="color: #ff4500;">3</span>, <span style="color: #ff4500;">4</span>, <span style="color: #ff4500;">5</span>, <span style="color: #ff4500;">6</span>, <span style="color: #ff4500;">7</span>, <span style="color: #ff4500;">8</span>, <span style="color: #ff4500;">9</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> a<span style="color: black;">&#91;</span>:<span style="color: #ff4500;">5</span><span style="color: black;">&#93;</span> = <span style="color: black;">&#91;</span><span style="color: #ff4500;">42</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> a
<span style="color: black;">&#91;</span><span style="color: #ff4500;">42</span>, <span style="color: #ff4500;">5</span>, <span style="color: #ff4500;">6</span>, <span style="color: #ff4500;">7</span>, <span style="color: #ff4500;">8</span>, <span style="color: #ff4500;">9</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> a<span style="color: black;">&#91;</span>:<span style="color: #ff4500;">1</span><span style="color: black;">&#93;</span> = <span style="color: #008000;">range</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">5</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> a
<span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span>, <span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span>, <span style="color: #ff4500;">3</span>, <span style="color: #ff4500;">4</span>, <span style="color: #ff4500;">5</span>, <span style="color: #ff4500;">6</span>, <span style="color: #ff4500;">7</span>, <span style="color: #ff4500;">8</span>, <span style="color: #ff4500;">9</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">del</span> a<span style="color: black;">&#91;</span>::<span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> a
<span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">3</span>, <span style="color: #ff4500;">5</span>, <span style="color: #ff4500;">7</span>, <span style="color: #ff4500;">9</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> a<span style="color: black;">&#91;</span>::<span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span> = a<span style="color: black;">&#91;</span>::-<span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> a
<span style="color: black;">&#91;</span><span style="color: #ff4500;">9</span>, <span style="color: #ff4500;">3</span>, <span style="color: #ff4500;">5</span>, <span style="color: #ff4500;">7</span>, <span style="color: #ff4500;">1</span><span style="color: black;">&#93;</span></pre></div></div>

<h2><code>import braces</code></h2>
<p>Si vous n&#8217;aimez pas les espaces pour l&#8217;indentation, vous pouvez faire:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">__future__</span> <span style="color: #ff7700;font-weight:bold;">import</span> braces</pre></div></div>

 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=1463&amp;md5=59b2ec224fa2b7064ecfa1d14b4f6729" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/astuces-python-en-vrac/feed/</wfw:commentRss>
		<slash:comments>8</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fastuces-python-en-vrac%2F&amp;language=en_GB&amp;category=text&amp;title=Astuces+Python+en+vrac&amp;description=Je+n%26%238217%3Barrive+pas+%C3%A0+trouver+un+lien+entre+tous+ces+trucs%2C+alors+un+bon+vrac+fera+l%26%238217%3Baffaire.+Float+accepte+de+parser+l%26%238217%3Binfini+%26gt%3B%26gt%3B%26gt%3B+infini+%3D+float%26%2340%3B%27inf%27%26%2341%3B+%26gt%3B%26gt%3B%26gt%3B+infini+inf+%26gt%3B%26gt%3B%26gt%3B...&amp;tags=import%2Citerable%2Cpython%2Cslice%2Cyield%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2012/08/48672-bureau-dependance-bordel-foutoir-desordre-rangemen.jpg" length="36541" type="image/jpg" />	</item>
		<item>
		<title>Quelques erreurs tordues et leurs solutions en Python</title>
		<link>http://sametmax.com/quelques-erreurs-tordues-et-leurs-solutions-en-python/</link>
		<comments>http://sametmax.com/quelques-erreurs-tordues-et-leurs-solutions-en-python/#comments</comments>
		<pubDate>Sun, 24 Jun 2012 02:29:56 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[encodage]]></category>
		<category><![CDATA[encoding]]></category>
		<category><![CDATA[erreur]]></category>
		<category><![CDATA[error]]></category>
		<category><![CDATA[generator]]></category>
		<category><![CDATA[import]]></category>
		<category><![CDATA[iterable]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=995</guid>
		<description><![CDATA[Bien que Python soit un langage dont l'une des grandes qualités est la cohérence, voici une liste d'erreurs et leurs solutions qui ont tendance à énerver.
]]></description>
			<content:encoded><![CDATA[<p>Quand vous débuggez, rappelez-vous que <a href="http://sametmax.com/debugger-en-python-les-bases-de-pdb/">pdb est votre ami</a>, et qu&#8217;il est souvent bon de <a href="http://sametmax.com/purger-les-fichiers-pyc-et-un-hook-git-en-bonus/">supprimer tous les fichiers <code>.pyc</code></a> pour éviter la confusion. Mais parfois l&#8217;erreur semble n&#8217;avoir aucun sens. Bien que Python soit un langage dont l&#8217;une des grandes qualités soit la cohérence, voici une liste d&#8217;erreurs et leurs solutions qui ont tendance à énerver (les erreurs hein, pas les solutions).</p>
<h2><code>NameError: name 'x' is not defined</code></h2>
<p>Python plante en annonçant que la variable n&#8217;est pas définie. Vous allez à la ligne donnée, et elle est là. Vous vérifiez qu&#8217;il n&#8217;y a pas de faute de frappe (genre un zéro mélangé avec la lettre O), ni une majuscule ou une minuscule échangée quelque part (Python est sensible à la casse).</p>
<p>Et rien.</p>
<p>Tout est niquel.</p>
<p>Alors pourquoi ça plante bordel de merde ?</p>
<p>Et bien ce message qui n&#8217;aide absolument pas peut venir du fait que <a href="http://sametmax.com/closure-en-python-et-javascript/">les closures sont en lecture seule en Python</a>. En résumé, vous avez essayé de faire un truc comme ça:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">chose = <span style="color: #483d8b;">'truc'</span>
<span style="color: #ff7700;font-weight:bold;">def</span> fonction<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    chose = <span style="color: #483d8b;">'machin'</span>
    <span style="color: #808080; font-style: italic;"># ou chose += machin ou une variante</span></pre></div></div>

<p>La solution est simple: ne modifiez pas <code>chose</code>. Si vous avez besoin de modifier son contenu, utilisez une variable intermédiaire:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">chose = <span style="color: #483d8b;">'truc'</span>
<span style="color: #ff7700;font-weight:bold;">def</span> fonction<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    bidule = chose
    bidule += <span style="color: #483d8b;">'machin'</span> <span style="color: #808080; font-style: italic;"># je sais c'est bidon, c'est pour l'exemple</span></pre></div></div>

<p>En Python 3.0, vous pouvez utiliser le mot clé <code>nonlocal</code> pour y palier: vous modifierez alors la variable du scope du dessus.</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">chose = <span style="color: #483d8b;">'truc'</span>
<span style="color: #ff7700;font-weight:bold;">def</span> fonction<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    nonlocal chose
    chose += <span style="color: #483d8b;">'machin'</span> <span style="color: #808080; font-style: italic;"># je sais c'est bidon, c'est pour l'exemple</span></pre></div></div>

<p>Évitez d&#8217;utiliser <code>global</code>, qui a un fort potentiel d&#8217;effet de bord.</p>
<h2><code>ImportError: cannot import name bidule</code> et <code>ImportError: No module named truc</code></h2>
<p>Une fois que vous avez vérifié qu&#8217;un module existe bien avec ce nom (regardez de près, parfois c&#8217;est subtile), voici 3 possibilités:</p>
<h3>Pas de fichier __init__.py</h3>
<p>Un dossier n&#8217;est pas un module importable si il ne contient pas de fichier <code>__init__.py</code>. Vérifiez qu&#8217;il y en a un, et dans le cas contraire, créez en un vide.</p>
<p><H3>Erreur de Python Path</H3></p>
<p>Quand vous faites <code>import bidule</code>, <code>bidule</code> ne peut être importé que si le dossier qui le contient est dans le <strong>Python Path</strong>. Le Python Path est une variable qui contient une liste de dossiers dans lesquels chercher les modules à importer.</p>
<p>Le dossier courrant, le dossier contenant la bibliothèque standard de Python et le dossier où sont installés les bibliotèques Python de votre système d&#8217;exploitation sont automatiquement présents dans le Python Path.</p>
<p>Première chose: assurez-vous d&#8217;être à la racine du projet que vous lancez (erreur typique quand on utilise la commande <code>./manage.py</code> avec Django par exemple).</p>
<p>Deuxième chose: si vous utilisez une bibliothèque qui n&#8217;est pas dans le Python Path (ça arrive assez souvent avec les tests unitaires: on éxécute les tests depuis le dossier de test, et le projet est dans un dossier à côté, donc pas dans le Python Path), vous pouvez ajouter manuellement un chemin dans le Python Path.</p>
<p>Pour se faire, avant l&#8217;import qui va foirer:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">sys</span>
<span style="color: #dc143c;">sys</span>.<span style="color: black;">path</span>.<span style="color: black;">append</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'/chemin/vers/le/dossier/parent/du/module/a/importer'</span><span style="color: black;">&#41;</span></pre></div></div>

<p>On peut tout à fait spécifier un dossier relativement au dossier courant. Il n&#8217;est pas rare d&#8217;ajouter le dossier parent du dossier courrant au Python Path:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">sys</span>
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">os</span>
&nbsp;
DOSSIER_COURRANT = <span style="color: #dc143c;">os</span>.<span style="color: black;">path</span>.<span style="color: black;">dirname</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">os</span>.<span style="color: black;">path</span>.<span style="color: black;">abspath</span><span style="color: black;">&#40;</span>__file__<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
DOSSIER_PARENT = <span style="color: #dc143c;">os</span>.<span style="color: black;">path</span>.<span style="color: black;">dirname</span><span style="color: black;">&#40;</span>DOSSIER_COURRANT<span style="color: black;">&#41;</span>
<span style="color: #dc143c;">sys</span>.<span style="color: black;">path</span>.<span style="color: black;">append</span><span style="color: black;">&#40;</span>DOSSIER_PARENT<span style="color: black;">&#41;</span></pre></div></div>

<p>Par exemple, souvent dans le dossier d&#8217;un projet Django je fais un sous-dossier &#8216;apps&#8217;, puis je rajoute ceci au fichier <code>settings.py</code>:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">sys</span>
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">os</span>
&nbsp;
PROJECT_DIR = <span style="color: #dc143c;">os</span>.<span style="color: black;">path</span>.<span style="color: black;">dirname</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">os</span>.<span style="color: black;">path</span>.<span style="color: black;">abspath</span><span style="color: black;">&#40;</span>__file__<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #dc143c;">sys</span>.<span style="color: black;">path</span>.<span style="color: black;">append</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">os</span>.<span style="color: black;">path</span>.<span style="color: black;">join</span><span style="color: black;">&#40;</span>PROJECT_DIR, <span style="color: #483d8b;">'apps'</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span></pre></div></div>

<p>Il y a deux avantages à cela:</p>
<ul>
<li>Mes applications sont regroupées dans un dossier et pas en vrac à la racine du projet, mais je peux quand même les importer en faisant <code>import nom</code> et pas <code>import apps.nom</code>.</li>
<li> J&#8217;ai maintenant une variable <code>PROJECT_DIR</code> que je peux utiliser partout, notamment pour définir où sont certains dossiers comme le dossiers des fichiers statiques:</li>
</ul>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">STATIC = <span style="color: #dc143c;">os</span>.<span style="color: black;">path</span>.<span style="color: black;">join</span><span style="color: black;">&#40;</span>PROJECT_DIR, <span style="color: #483d8b;">'static'</span><span style="color: black;">&#41;</span></pre></div></div>

<h3>Imports circulaires</h3>
<p>Si vous importez <code>poisson.rouge</code> dans <code>force.py</code>, et <code>force.bleu</code> dans <code>poisson.py</code>, vous aurez aussi ce message d&#8217;erreur (qui n&#8217;aide pas beaucoup, on est d&#8217;accord).</p>
<p>Il n&#8217;y a pas vraiment de façon élégante de s&#8217;en sortir, c&#8217;est une des plus grosses couillasses en Python.</p>
<p>Solution 1: vous refactorez votre code pour avoir <code>bleu</code> et <code>rouge</code> dans un fichier <code>couleur.py</code>, lequel est importé dans <code>poisson.py</code> et <code>force.py</code>. C&#8217;est propre, mais parfois ça n&#8217;a aucun sens, et parfois ce n&#8217;est juste pas possible.<br />
Solution 2: vous mettez l&#8217;import dans une fonctions ou une méthode dans un des deux modules (n&#8217;importe lequel):</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> make_bouillabaisse<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">from</span> poisson <span style="color: #ff7700;font-weight:bold;">import</span> rouge</pre></div></div>

<p>C&#8217;est moche, mais c&#8217;est facile. Et je le répète, je n&#8217;ai jamais vu quelqu&#8217;un en 10 ans de Python proposer une solution élégante à ce problème. C&#8217;est un What The Fuck d&#8217;or.</p>
<h2><code>UnicodeDecodeError: 'ascii' codec can't decode byte 0xc3 in position 0: ordinal not in range(128)</code></h2>
<p>Arf. L&#8217;erreur à la con. Parce que généralement elle vient du fait que l&#8217;on ne comprend pas vraiment ce qu&#8217;on fait. Or difficile de résoudre un problème quand on ne comprend pas de quoi il est question. Ne vous sentez pas mal, on s&#8217;est tous retrouvé comme un demeuré devant un problème d&#8217;encodage.</p>
<p>A noter que ce n&#8217;est pas une erreur spécifique à Python, mais si vous venez d&#8217;un langage comme PHP qui passe silencieusement ce genre d&#8217;erreur et affiche en prod des texts illisibles, voire une grosse erreur à l&#8217;écran peut surprendre.</p>
<p>Voici des causes très fréquentes:</p>
<h3>Encodage du fichier.py</h3>
<p>Comme il peut y avoir 1 million de possibilités, forcez vous à:</p>
<p>- TOUJOURS avoir votre éditeur de texte réglé pour utiliser UTF-8. Surtout sur Windows. Si votre chef vous l&#8217;interdit parce que &#8220;ça pose des problèmes d&#8217;encodage&#8221; (sic), quittez votre job (meilleur choix) ou faites vous former pour comprendre comment marchent les encodages et travailler dans cet environnement hostile.<br />
- TOUJOURS avoir votre encodage (UTF-8 j&#8217;ai dis !) déclaré en haut du <code>fichier.py</code>: <code># -*- coding: utf-8 -*-</code></p>
<h3>Vérifiez que les textes en entrée sont dans l&#8217;encodage prévu</h3>
<p>Le contenu des bases de données ne sont parfois pas dans l&#8217;encodage déclaré de la table ou de la base. Le contenu d&#8217;une page HTML n&#8217;est parfois pas encodé dans l&#8217;encodage déclaré dans le HEAD. Le contenu d&#8217;un fichier n&#8217;est parfois pas encodé dans l&#8217;encodage par défaut de votre OS.</p>
<p>Il n&#8217;y a pas de secret. Pas de moyen infaillible de détection automatique. Il faut vérifier.</p>
<h3>Vous confondez encodage et décodage (Python 2.7 et moins)</h3>
<p>En Python, on DECODE pour passer d&#8217;un texte en encodé (UTF8, ISO-8859, CP1552, etc) et donc de type &#8216;str&#8217; c&#8217;est à dire un flux de bits, à un texte unicode, une représentation interne, un objet non imprimable. Il est recommandé de décoder tout texte venant d&#8217;une source extérieur à votre programme, pour tout uniformiser.</p>
<p>A l&#8217;inverse, on ENCODE pour passer du type &#8216;unicode&#8217; à un type &#8216;str&#8217;. Il <strong>obligatoire</strong> d&#8217;encoder un texte pour le communiquer au monde extérieur. Si vous ne le faites pas manuellement, Python le fera automatiquement, en essayant de deviner. Il n&#8217;est pas excellent à deviner.</p>
<p>En résumé:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">In <span style="color: black;">&#91;</span><span style="color: #ff4500;">7</span><span style="color: black;">&#93;</span>: texte = <span style="color: #008000;">open</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'/etc/fstab'</span><span style="color: black;">&#41;</span>.<span style="color: black;">read</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># ou un téléchargement, ou une requete SQL...</span>
In <span style="color: black;">&#91;</span><span style="color: #ff4500;">8</span><span style="color: black;">&#93;</span>: <span style="color: #008000;">type</span><span style="color: black;">&#40;</span>texte<span style="color: black;">&#41;</span>
Out<span style="color: black;">&#91;</span><span style="color: #ff4500;">8</span><span style="color: black;">&#93;</span>: <span style="color: #008000;">str</span>
In <span style="color: black;">&#91;</span><span style="color: #ff4500;">9</span><span style="color: black;">&#93;</span>: texte = texte.<span style="color: black;">decode</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'UTF8'</span><span style="color: black;">&#41;</span>
In <span style="color: black;">&#91;</span><span style="color: #ff4500;">10</span><span style="color: black;">&#93;</span>: <span style="color: #008000;">type</span><span style="color: black;">&#40;</span>texte<span style="color: black;">&#41;</span>
Out<span style="color: black;">&#91;</span><span style="color: #ff4500;">10</span><span style="color: black;">&#93;</span>: <span style="color: #008000;">unicode</span>
In <span style="color: black;">&#91;</span><span style="color: #ff4500;">11</span><span style="color: black;">&#93;</span>: <span style="color: #ff7700;font-weight:bold;">print</span> texte <span style="color: #808080; font-style: italic;"># encode automatiquement le texte car votre terminal ne comprend qu'un text encodé</span>
<span style="color: #808080; font-style: italic;"># /etc/fstab: static file system information.</span>
<span style="color: #808080; font-style: italic;">#</span>
<span style="color: black;">&#91;</span>.............<span style="color: black;">&#93;</span>
In <span style="color: black;">&#91;</span><span style="color: #ff4500;">12</span><span style="color: black;">&#93;</span>: <span style="color: #008000;">type</span><span style="color: black;">&#40;</span>texte.<span style="color: black;">encode</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'UTF8'</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># à faire avant de faire un write</span>
Out<span style="color: black;">&#91;</span><span style="color: #ff4500;">12</span><span style="color: black;">&#93;</span>: <span style="color: #008000;">str</span></pre></div></div>

<p>Si ça continue de foirer, prenez tous les fichiers de votre application un par un: changez toutes les strings en unicode (les précéder d&#8217;un &#8220;u&#8221;), assurez vous que tout ce qui entre est converti en unicode (unicode() après urllib, open, etc) et tout ce qui sort est converti dans un encodage adapté (souvent UTF8) (decode(&#8216;UTF-8&#8242;) avant send(), write() ou print).</p>
<p>Si ça ne marche toujours pas, embauchez un mec comme moi qui est payé cher pour se taper la tête contre les murs à la place des autres.</p>
<h2>TypeError: &#8216;int&#8217; object has no attribute &#8216;__getitem__&#8217; et autres erreurs sur les tuples</h2>
<h3>Tuples d&#8217;un seul élément</h3>
<p>CECI N&#8217;EST PAS UN TUPLE: (1)</p>
<p>Ceci est un tuple: (1,)</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">type</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&lt;</span>type <span style="color: #483d8b;">'int'</span><span style="color: #66cc66;">&gt;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">type</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>,<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&lt;</span>type <span style="color: #483d8b;">'tuple'</span><span style="color: #66cc66;">&gt;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> t = <span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>,<span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> t<span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#93;</span>
<span style="color: #ff4500;">1</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> t = <span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> t<span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#93;</span>
Traceback <span style="color: black;">&#40;</span>most recent call last<span style="color: black;">&#41;</span>:
  File <span style="color: #483d8b;">&quot;&lt;stdin&gt;&quot;</span>, line <span style="color: #ff4500;">1</span>, <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #66cc66;">&lt;</span>module<span style="color: #66cc66;">&gt;</span>
<span style="color: #008000;">TypeError</span>: <span style="color: #483d8b;">'int'</span> <span style="color: #008000;">object</span> has no attribute <span style="color: #483d8b;">'__getitem__'</span></pre></div></div>

<p>Et il y a plus vicieux:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> a = <span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;12345&quot;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> b = <span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;12345&quot;</span>,<span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> a<span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#93;</span>
<span style="color: #483d8b;">'1'</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> b<span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#93;</span>
<span style="color: #483d8b;">'12345'</span></pre></div></div>

<p>C&#8217;est très dur à débugguer car on dans les deux cas il n&#8217;y a pas d&#8217;erreur étant donné que c&#8217;est une opération tout à fait légitime.</p>
<h3>Concaténation automatique</h3>
<p>Python vient avec une fonctionnalité qui concatène automatiquement les descriptions littérales de chaînes de caractères:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #483d8b;">&quot;Ceci est un&quot;</span>                                  <span style="color: #483d8b;">&quot; test&quot;</span>
<span style="color: #483d8b;">'Ceci est un test'</span></pre></div></div>

<p>C&#8217;est très pratique pour les chaînes longues:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Ceci est une chaîne longue &quot;</span>
... <span style="color: #483d8b;">&quot;et je peux la diviser sur plusieurs lignes&quot;</span>
... <span style="color: #483d8b;">&quot; sans me fouler&quot;</span><span style="color: black;">&#41;</span>
<span style="color: #483d8b;">'Ceci est une chaîne longue et je peux la diviser sur plusieurs lignes sans me fouler'</span></pre></div></div>

<p>Mais si vous oubliez une virgule dans un tuple (par exemple dans <code>INSTALLED_APPS</code> dans le fichier de <code>settings.py</code> de Django):</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> REGLES = <span style="color: black;">&#40;</span>
...     <span style="color: #483d8b;">&quot;Ne jamais parler du fight club&quot;</span>,
...     <span style="color: #483d8b;">&quot;Ne jamais croiser les effluves&quot;</span>,
...     <span style="color: #483d8b;">&quot;Ne jamais appuyer sur le petit bouton rouge&quot;</span> <span style="color: #808080; font-style: italic;"># &lt;===== virgule oubliée !</span>
...     <span style="color: #483d8b;">&quot;Ne jamais goûter&quot;</span>
... <span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">print</span> REGLES<span style="color: black;">&#91;</span><span style="color: #ff4500;">3</span><span style="color: black;">&#93;</span>
Traceback <span style="color: black;">&#40;</span>most recent call last<span style="color: black;">&#41;</span>:
  File <span style="color: #483d8b;">&quot;&lt;stdin&gt;&quot;</span>, line <span style="color: #ff4500;">1</span>, <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #66cc66;">&lt;</span>module<span style="color: #66cc66;">&gt;</span>
<span style="color: #008000;">IndexError</span>: <span style="color: #008000;">tuple</span> index out of <span style="color: #008000;">range</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">print</span> REGLES<span style="color: black;">&#91;</span>-<span style="color: #ff4500;">1</span><span style="color: black;">&#93;</span>
Ne jamais appuyer sur le petit bouton rougeNe jamais goûter</pre></div></div>

<h2>Le fichier/la liste est vide</h2>
<p><a href="http://sametmax.com/python-love-les-listes-en-intention-partie-2/">On ne peut lire qu&#8217;une seule fois les générateurs en Python</a>.</p>
<p>Si vous faites:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">toto = <span style="color: black;">&#40;</span>blague.<span style="color: black;">title</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> blague <span style="color: #ff7700;font-weight:bold;">in</span> histoire<span style="color: black;">&#41;</span></pre></div></div>

<p>ou</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">toto = <span style="color: #008000;">open</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'histoire.txt'</span><span style="color: black;">&#41;</span></pre></div></div>

<p>Et ensuite:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">for</span> blague <span style="color: #ff7700;font-weight:bold;">in</span> toto:
    <span style="color: #ff7700;font-weight:bold;">print</span> toto
&nbsp;
<span style="color: #008000;">len</span><span style="color: black;">&#40;</span><span style="color: #008000;">list</span><span style="color: black;">&#40;</span>toto<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span></pre></div></div>

<p>La dernière ligne ne marchera pas. Toto aura été vidé par la première boucle for. Si vous souhaitez utiliser plusieurs fois le résultat de votre générateur, il faut le transformer en liste:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">toto = <span style="color: #008000;">list</span><span style="color: black;">&#40;</span>toto<span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">for</span> blague <span style="color: #ff7700;font-weight:bold;">in</span> toto:
    <span style="color: #ff7700;font-weight:bold;">print</span> toto
&nbsp;
<span style="color: #008000;">len</span><span style="color: black;">&#40;</span><span style="color: #008000;">list</span><span style="color: black;">&#40;</span>toto<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span></pre></div></div>

<p>Attention, car vous avez maintenant l&#8217;intégralité des données chargées en RAM.</p>
<h2>TypeError: ma_function() takes exactly x argument (y given)</h2>
<p>Cette erreur est très explicite, et la plupart du temps ne pose aucun problème: vérifiez que vous passez le bon nombre d&#8217;arguments à la fonction. Faites particulièrement attention si vous utilisez <a href="http://sametmax.com/operateur-splat-ou-etoile-en-python/">l&#8217;opérateur splat</a>.</p>
<p>Il existe néanmoins un cas particulier un peu taquin:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">class</span> Americaine<span style="color: black;">&#40;</span><span style="color: #008000;">object</span><span style="color: black;">&#41;</span>:
...     <span style="color: #ff7700;font-weight:bold;">def</span> dernier_mot<span style="color: black;">&#40;</span>mot<span style="color: black;">&#41;</span>:
...         <span style="color: #ff7700;font-weight:bold;">print</span> mot
... 
<span style="color: #66cc66;">&gt;&gt;&gt;</span> homme_le_plus_classe_du_monde = Americaine<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> homme_le_plus_classe_du_monde.<span style="color: black;">dernier_mot</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Monde de merde !&quot;</span><span style="color: black;">&#41;</span>
Traceback <span style="color: black;">&#40;</span>most recent call last<span style="color: black;">&#41;</span>:
  File <span style="color: #483d8b;">&quot;&lt;stdin&gt;&quot;</span>, line <span style="color: #ff4500;">1</span>, <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #66cc66;">&lt;</span>module<span style="color: #66cc66;">&gt;</span>
<span style="color: #008000;">TypeError</span>: dernier_mot<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> takes exactly <span style="color: #ff4500;">1</span> argument <span style="color: black;">&#40;</span><span style="color: #ff4500;">2</span> given<span style="color: black;">&#41;</span></pre></div></div>

<p>On définie une seul argument (<code>mot</code>) et on en passe un seul (<code>"Monde de merdes !"</code>), alors pourquoi Python n&#8217;est pas d&#8217;accord ?</p>
<p>C&#8217;est parce que l&#8217;on déclare une méthode sans <code>self</code> dans la signature. Or Python va passer automatiquement (et de manière invisible) la référence à l&#8217;objet courrant en premier argument, du coup la méthode reçoit deux arguments: la référence à <code>homme_le_plus_classe_du_monde</code> et <code>"Monde de merde !"</code>. Ca ne marche pas puisque la méthode est déclarée pour n&#8217;accepter qu&#8217;un seul argument.</p>
<p>Il y a deux solutions. La plus simple, ajoutez <code>self</code>:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">class</span> Americaine<span style="color: black;">&#40;</span><span style="color: #008000;">object</span><span style="color: black;">&#41;</span>:
...     <span style="color: #ff7700;font-weight:bold;">def</span> dernier_mot<span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, mot<span style="color: black;">&#41;</span>:
...         <span style="color: #ff7700;font-weight:bold;">print</span> mot
... 
<span style="color: #66cc66;">&gt;&gt;&gt;</span> homme_le_plus_classe_du_monde = Americaine<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> homme_le_plus_classe_du_monde.<span style="color: black;">dernier_mot</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Monde de merde !&quot;</span><span style="color: black;">&#41;</span>
Monde de merde <span style="color: #66cc66;">!</span></pre></div></div>

<p>Une seconde solution consiste à déclarer une méthode statique. Du coup on a plus besoin d&#8217;instance:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">class</span> Americaine<span style="color: black;">&#40;</span><span style="color: #008000;">object</span><span style="color: black;">&#41;</span>:
...     @<span style="color: #008000;">staticmethod</span>
...     <span style="color: #ff7700;font-weight:bold;">def</span> dernier_mot<span style="color: black;">&#40;</span>mot<span style="color: black;">&#41;</span>:
...         <span style="color: #ff7700;font-weight:bold;">print</span> mot
... 
<span style="color: #66cc66;">&gt;&gt;&gt;</span> Americaine.<span style="color: black;">dernier_mot</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Monde de merde !&quot;</span><span style="color: black;">&#41;</span>
Monde de merde <span style="color: #66cc66;">!</span></pre></div></div>

<h2>Ma structure de données par défaut n&#8217;est pas la bonne</h2>
<p>Piège classique en Python, qu&#8217;il est important de répéter encore et encore tant il est la source de frustration chez les personnes qui ne le connaissent pas.</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">random</span> <span style="color: #ff7700;font-weight:bold;">import</span> choice
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">def</span> bioman<span style="color: black;">&#40;</span>forces=<span style="color: black;">&#91;</span><span style="color: #483d8b;">'rouge'</span>, <span style="color: #483d8b;">'bleu'</span>, <span style="color: #483d8b;">'vert'</span>, <span style="color: #483d8b;">'rose'</span>, <span style="color: #483d8b;">'jaune devant, marron derriere'</span><span style="color: black;">&#93;</span>, invite=<span style="color: #008000;">None</span><span style="color: black;">&#41;</span>:
...     <span style="color: #ff7700;font-weight:bold;">if</span> invite <span style="color: #ff7700;font-weight:bold;">is</span> <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #008000;">None</span>:
...         <span style="color: black;">forces</span>.<span style="color: black;">append</span><span style="color: black;">&#40;</span>invite<span style="color: black;">&#41;</span>
...     <span style="color: #ff7700;font-weight:bold;">return</span> choice<span style="color: black;">&#40;</span>forces<span style="color: black;">&#41;</span>
... 
<span style="color: #66cc66;">&gt;&gt;&gt;</span> bioman<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #483d8b;">'rose'</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> bioman<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #483d8b;">'rouge'</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> bioman<span style="color: black;">&#40;</span>invite=<span style="color: #483d8b;">'magenta a pois gris'</span><span style="color: black;">&#41;</span>
<span style="color: #483d8b;">'vert'</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> bioman<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #483d8b;">'jaune devant, marron derriere'</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> bioman<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># WTF ??????????</span>
<span style="color: #483d8b;">'magenta a pois gris'</span></pre></div></div>

<p>Dans le dernier appel &#8216;magenta a pois gris&#8217; est tiré au sort alors qu&#8217;on ne l&#8217;a pas passé en paramètre. Comment cela est-il possible ?</p>
<p>Cela vient du fait que les paramètres par défaut sont initialisés <strong>une seule fois</strong> pour tout le programme: dès que le module est chargé.</p>
<p>Si vous utilisez un objet mutable (liste, set, dico) et que vous le modifiez (ici avec <code>append</code>), le prochain appel de la fonction utilisera toujours la référence de cet objet, et donc de sa versio modifiée.</p>
<p>La solution est soit de ne pas utiliser d&#8217;objet mutable (tuple, strings, int, etc), soit de ne pas modifier l&#8217;objet:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">def</span> bioman<span style="color: black;">&#40;</span>forces=<span style="color: black;">&#40;</span><span style="color: #483d8b;">'rouge'</span>, <span style="color: #483d8b;">'bleu'</span>, <span style="color: #483d8b;">'vert'</span>, <span style="color: #483d8b;">'rose'</span>, <span style="color: #483d8b;">'jaune devant, marron derriere'</span><span style="color: black;">&#41;</span>, invite=<span style="color: #008000;">None</span><span style="color: black;">&#41;</span>:
...     <span style="color: #ff7700;font-weight:bold;">if</span> invite <span style="color: #ff7700;font-weight:bold;">is</span> <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #008000;">None</span>:
...         <span style="color: black;">forces</span> += <span style="color: black;">&#40;</span>invite,<span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># ne modifie pas l'ancien objet</span>
...     <span style="color: #ff7700;font-weight:bold;">return</span> choice<span style="color: black;">&#40;</span>forces<span style="color: black;">&#41;</span></pre></div></div>

<p>Ou alors (et ceci est souvent utilisé même si c&#8217;est moche):</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">def</span> bioman<span style="color: black;">&#40;</span>forces=<span style="color: #008000;">None</span>, invite=<span style="color: #008000;">None</span><span style="color: black;">&#41;</span>:
...     <span style="color: #ff7700;font-weight:bold;">if</span> forces <span style="color: #ff7700;font-weight:bold;">is</span> <span style="color: #008000;">None</span>:
...        <span style="color: black;">forces</span> = <span style="color: black;">&#91;</span><span style="color: #483d8b;">'rouge'</span>, <span style="color: #483d8b;">'bleu'</span>, <span style="color: #483d8b;">'vert'</span>, <span style="color: #483d8b;">'rose'</span>, <span style="color: #483d8b;">'jaune devant, marron derriere'</span><span style="color: black;">&#93;</span>
...     <span style="color: #ff7700;font-weight:bold;">if</span> invite <span style="color: #ff7700;font-weight:bold;">is</span> <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #008000;">None</span>:
...         <span style="color: black;">forces</span>.<span style="color: black;">append</span><span style="color: black;">&#40;</span>invite<span style="color: black;">&#41;</span>
...     <span style="color: #ff7700;font-weight:bold;">return</span> choice<span style="color: black;">&#40;</span>forces<span style="color: black;">&#41;</span></pre></div></div>

<p>Toutes les parties qui sont éxécutées à l&#8217;inialisation du code (en opposition à celles qui le sont à l&#8217;appel du code) sont concernées par ce problème: les paramètres par défaut, les variables à la racine des modules, les attributs de classe déclarés <strong>en dehors</strong> d&#8217;une méthode, etc.</p>
<p><strong>ItZ naute a beuhgue, Itse fitiure</strong></p>
<p>Néanmoins cela a aussi son utilité. On peut en effet l&#8217;utiliser pour partager des états:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">class</span> Model<span style="color: black;">&#40;</span><span style="color: #008000;">object</span><span style="color: black;">&#41;</span>:
    _pool = <span style="color: black;">&#123;</span>
        <span style="color: #483d8b;">'mysql'</span>: MySQL<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>.<span style="color: black;">connect</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'test'</span><span style="color: black;">&#41;</span>,
        <span style="color: #483d8b;">'sqlite'</span>: Sqlite.<span style="color: #008000;">open</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'test.db'</span><span style="color: black;">&#41;</span>
    <span style="color: black;">&#125;</span>
    default_connection = <span style="color: #483d8b;">'mysql'</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> query<span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, connection=default_connection, <span style="color: #66cc66;">*</span>params<span style="color: black;">&#41;</span>:
        connection.<span style="color: black;">super_query</span><span style="color: black;">&#40;</span><span style="color: #66cc66;">*</span>params<span style="color: black;">&#41;</span></pre></div></div>

<p>Et vous avez maintenant une classe de modèle qui gère plusieurs connections. Si vous l&#8217;étendez, les enfants de la classe et toutes les instances partageront le même objet connection, mais tout le reste sera unique à chacun d&#8217;eux. Cela évite un effet de bord du singleton qui oblige à partager un état et une identité. Ici on ne partage que la partie de l&#8217;état que l&#8217;on souhaite, et pas l&#8217;identité.</p>
<p>On gagne sur les deux tableaux: si on update la connection MySQL (par exemple parcequ&#8217;on a détecté qu&#8217;elle était stale), toutes les instances ont accès à l&#8217;objet modifé. Mais si on veut overrider la connection pour une seule classe, on peut le faire sans affecter les autres simplement en remplaçant l&#8217;objet à la déclaration de la classe.</p>
<p>On peut aussi utiliser cette fonctionnalité pour créer un cache. On appelle ça &#8220;mémoiser&#8221;:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> fonction_lente<span style="color: black;">&#40;</span>param1, param2, _cache=<span style="color: black;">&#123;</span><span style="color: black;">&#125;</span><span style="color: black;">&#41;</span>:
    <span style="color: #808080; font-style: italic;"># les tuples peuvent être des clés de dico \o/</span>
    key = <span style="color: black;">&#40;</span>param1, param2<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">if</span> key <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> _cache:
        _cache<span style="color: black;">&#91;</span>key<span style="color: black;">&#93;</span> = process_lent<span style="color: black;">&#40;</span>param1, param2<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> _cache<span style="color: black;">&#91;</span>key<span style="color: black;">&#93;</span></pre></div></div>

<p>Tous les résultats sont alors stockés en mémoire vive.</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=995&amp;md5=2ca157636a79fa597be79f22cdde466b" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/quelques-erreurs-tordues-et-leurs-solutions-en-python/feed/</wfw:commentRss>
		<slash:comments>14</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fquelques-erreurs-tordues-et-leurs-solutions-en-python%2F&amp;language=en_GB&amp;category=text&amp;title=Quelques+erreurs+tordues+et+leurs+solutions+en+Python&amp;description=Quand+vous+d%C3%A9buggez%2C+rappelez-vous+que+pdb+est+votre+ami%2C+et+qu%26%238217%3Bil+est+souvent+bon+de+supprimer+tous+les+fichiers+.pyc+pour+%C3%A9viter+la+confusion.+Mais+parfois+l%26%238217%3Berreur+semble+n%26%238217%3Bavoir+aucun...&amp;tags=django%2Cencodage%2Cencoding%2Cerreur%2Cerror%2Cgenerator%2Cimport%2Citerable%2Cpython%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2012/06/Funny-Batman-Pictures-103.jpg" length="69437" type="image/jpg" />	</item>
	</channel>
</rss>
