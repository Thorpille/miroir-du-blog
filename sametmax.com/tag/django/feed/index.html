<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Sam &#38; Max: Python, Django, Git et du cul &#187; django</title>
	<atom:link href="http://sametmax.com/tag/django/feed/" rel="self" type="application/rss+xml" />
	<link>http://sametmax.com</link>
	<description>Deux développeurs en vadrouille qui se sortent les doigts du code</description>
	<lastBuildDate>Wed, 05 Feb 2014 14:20:37 +0000</lastBuildDate>
	<language>en</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>http://wordpress.org/?v=3.3.1</generator>
	<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2F&amp;language=en_US&amp;category=text&amp;title=Sam+%26amp%3B+Max%3A+Python%2C+Django%2C+Git+et+du+cul&amp;description=Deux+d%C3%A9veloppeurs+en+vadrouille+qui+se+sortent+les+doigts+du+code&amp;tags=blog" type="text/html" />
		<item>
		<title>Django, une app à la fois &#8211; faire une app de base</title>
		<link>http://sametmax.com/django-une-app-a-la-fois-faire-une-app-de-base/</link>
		<comments>http://sametmax.com/django-une-app-a-la-fois-faire-une-app-de-base/#comments</comments>
		<pubDate>Sat, 18 Jan 2014 15:22:24 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[template]]></category>
		<category><![CDATA[view]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=8789</guid>
		<description><![CDATA[Voici un nouveau morceau qui montre comment écrire une petite app de base avec un template et une vue réutilisable qui serviront donc dans les prochaines apps du projets.
]]></description>
			<content:encoded><![CDATA[<p>Ca faisait longtemps que je n&#8217;avais pas fait avancer le projet <a href="http://sametmax.com/django-une-app-a-la-fois/">django, an app at a time</a>.</p>
<p>Voici donc un nouveau morceau qui montre comment écrire une petite app de base avec un template et une vue réutilisables qui serviront donc dans les prochaines apps du projet.</p>
<p>Comme d&#8217;hab, vous pouvez récupérer le code sur <a href="https://github.com/sametmax/Django--an-app-at-a-time">la teub de Guy</a> et il y a une version française et anglaise.</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=8789&amp;md5=5af69319290f2c2a9532c4eebdaf3d40" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/django-une-app-a-la-fois-faire-une-app-de-base/feed/</wfw:commentRss>
		<slash:comments>2</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fdjango-une-app-a-la-fois-faire-une-app-de-base%2F&amp;language=en_GB&amp;category=text&amp;title=Django%2C+une+app+%C3%A0+la+fois+%26%238211%3B+faire+une+app+de+base&amp;description=Ca+faisait+longtemps+que+je+n%26%238217%3Bavais+pas+fait+avancer+le+projet+django%2C+an+app+at+a+time.+Voici+donc+un+nouveau+morceau+qui+montre+comment+%C3%A9crire+une+petite+app+de...&amp;tags=django%2Cpython%2Ctemplate%2Cview%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2014/01/vghvgMc.jpg" length="111945" type="image/jpg" />	</item>
		<item>
		<title>Afficher le queryset d&#8217;une requête dans les logs SQL sous Django</title>
		<link>http://sametmax.com/afficher-le-queryset-dune-requete-dans-les-logs-sql-sous-django/</link>
		<comments>http://sametmax.com/afficher-le-queryset-dune-requete-dans-les-logs-sql-sous-django/#comments</comments>
		<pubDate>Wed, 25 Dec 2013 11:38:12 +0000</pubDate>
		<dc:creator>Max</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[Web]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[mysql]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[trace]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=8447</guid>
		<description><![CDATA[L'ORM de django pour les bases de données est chouette, agréable à utiliser mais construit des requêtes SQL qu'on ne peut reconnaître lors de l'analyse des logs MYSQL du premier coup d'oeil à moins d'avoir des années de pratique. J'ai une app django pour vous permettre de faire des débug sql éclairs !]]></description>
			<content:encoded><![CDATA[<p>C&#8217;est Noël, 2 articles rien que pour vous dont un <a href="http://sametmax.com/est-ce-que-framework-x-supporte-la-charge/" title="Est-ce que “framework x” supporte la charge ?">très interressant de Sam</a>.</p>
<p>L&#8217;ORM de django pour les bases de données est chouette, agréable à utiliser mais construit des requêtes SQL qu&#8217;on ne peut reconnaître lors de l&#8217;analyse des logs MYSQL du premier coup d&#8217;oeil. Et quand on a des centaines de requêtes par secondes c&#8217;est carrément impossible de s&#8217;y retrouver.</p>
<p>Ce que je vous propose ici c&#8217;est d&#8217;afficher le queryset (sa ligne et le fichier qui le contient) qui a permit d&#8217;exêcuter la requête SQL que vous voyez défiler dans les logs SQL sous forme de <a href="http://dev.mysql.com/doc/refman/5.0/en/comments.html">commentaires SQL</a>.</p>
<p>L&#8217;application se nomme <a href="https://pypi.python.org/pypi/django-sql-stacktrace/">Django Sql StackTrace</a>. C&#8217;est facile à installer et ça peut sauver des heures de debug.</p>
<p><strong>Installation Django Sql StackTrace:</strong></p>
<p><strong>Une bonne PIP comme toujours pour bien commencer.</strong></p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;">pip <span style="color: #c20cb9; font-weight: bold;">install</span> django-sql-stacktrace</pre></div></div>

<p><strong>Dans votre fichier settings de django.</strong></p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;">INSTALLED_APPS = <span style="color: #7a0874; font-weight: bold;">&#40;</span>
    .........................
    <span style="color: #ff0000;">'sqlstacktrace'</span>,
    .........................
<span style="color: #7a0874; font-weight: bold;">&#41;</span>
&nbsp;
SQL_STACKTRACE = True</pre></div></div>

<p>La variable SQL_STACKTRACE sert à activer le debug.<br />
Pensez à le désactiver lorsque vous n&#8217;en avez pas besoin.</p>
<p><strong>Où se trouve mes super infos de debug ?</strong></p>
<p><a href="http://adw0rd.com/2012/8/23/django-sql-stacktrace/en/#.Urq_5mRdU98">D&#8217;après la doc</a> vous pouvez executer un <a href="http://pwet.fr/man/linux/commandes/watch">watch</a></p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">watch</span> <span style="color: #660033;">-n1</span> mysqladmin <span style="color: #660033;">-u</span> <span style="color: #c20cb9; font-weight: bold;">login</span> -pmot_de_passe processlist <span style="color: #660033;">--verbose</span></pre></div></div>

<p>Chez moi ça n&#8217;a rien donné. Mais du côté des logs MySQL la magie a opérée.<br />
Vérifiez tout d&#8217;abord que vos logs sont activés dans mysql.</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">vi</span> <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>my.cnf</pre></div></div>


<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #7a0874; font-weight: bold;">&#91;</span>mysqld<span style="color: #7a0874; font-weight: bold;">&#93;</span>
......
log = <span style="color: #000000; font-weight: bold;">/</span>var<span style="color: #000000; font-weight: bold;">/</span>logs<span style="color: #000000; font-weight: bold;">/</span>mysql.log
......</pre></div></div>

<p><strong>Comment on teste ça ?</strong></p>
<p>Redemarrez votre serveur web, surfez sur les pages de votre projet et observez les logs MySql. Vous deviez voir quelques chose de similaire:</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">tail</span> <span style="color: #660033;">-F</span> <span style="color: #000000; font-weight: bold;">/</span>var<span style="color: #000000; font-weight: bold;">/</span>logs<span style="color: #000000; font-weight: bold;">/</span>mysql.log</pre></div></div>


<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;">		  <span style="color: #000000;">644</span> Query	SELECT <span style="color: #000000; font-weight: bold;">`</span>auth_user<span style="color: #000000; font-weight: bold;">`</span>.<span style="color: #000000; font-weight: bold;">`</span><span style="color: #c20cb9; font-weight: bold;">id</span><span style="color: #000000; font-weight: bold;">`</span>, <span style="color: #000000; font-weight: bold;">`</span>auth_user<span style="color: #000000; font-weight: bold;">`</span>.<span style="color: #000000; font-weight: bold;">`</span>password<span style="color: #000000; font-weight: bold;">`</span>, <span style="color: #000000; font-weight: bold;">`</span>auth_user<span style="color: #000000; font-weight: bold;">`</span>.<span style="color: #000000; font-weight: bold;">`</span>last_login<span style="color: #000000; font-weight: bold;">`</span>, <span style="color: #000000; font-weight: bold;">`</span>auth_user<span style="color: #000000; font-weight: bold;">`</span>.<span style="color: #000000; font-weight: bold;">`</span>is_superuser<span style="color: #000000; font-weight: bold;">`</span>, <span style="color: #000000; font-weight: bold;">`</span>auth_user<span style="color: #000000; font-weight: bold;">`</span>.<span style="color: #000000; font-weight: bold;">`</span>username<span style="color: #000000; font-weight: bold;">`</span>, <span style="color: #000000; font-weight: bold;">`</span>auth_user<span style="color: #000000; font-weight: bold;">`</span>.<span style="color: #000000; font-weight: bold;">`</span>first_name<span style="color: #000000; font-weight: bold;">`</span>, <span style="color: #000000; font-weight: bold;">`</span>auth_user<span style="color: #000000; font-weight: bold;">`</span>.<span style="color: #000000; font-weight: bold;">`</span>last_name<span style="color: #000000; font-weight: bold;">`</span>, <span style="color: #000000; font-weight: bold;">`</span>auth_user<span style="color: #000000; font-weight: bold;">`</span>.<span style="color: #000000; font-weight: bold;">`</span>email<span style="color: #000000; font-weight: bold;">`</span>, <span style="color: #000000; font-weight: bold;">`</span>auth_user<span style="color: #000000; font-weight: bold;">`</span>.<span style="color: #000000; font-weight: bold;">`</span>is_staff<span style="color: #000000; font-weight: bold;">`</span>, <span style="color: #000000; font-weight: bold;">`</span>auth_user<span style="color: #000000; font-weight: bold;">`</span>.<span style="color: #000000; font-weight: bold;">`</span>is_active<span style="color: #000000; font-weight: bold;">`</span>, <span style="color: #000000; font-weight: bold;">`</span>auth_user<span style="color: #000000; font-weight: bold;">`</span>.<span style="color: #000000; font-weight: bold;">`</span>date_joined<span style="color: #000000; font-weight: bold;">`</span> FROM <span style="color: #000000; font-weight: bold;">`</span>auth_user<span style="color: #000000; font-weight: bold;">`</span> WHERE <span style="color: #000000; font-weight: bold;">`</span>auth_user<span style="color: #000000; font-weight: bold;">`</span>.<span style="color: #000000; font-weight: bold;">`</span><span style="color: #c20cb9; font-weight: bold;">id</span><span style="color: #000000; font-weight: bold;">`</span> = <span style="color: #000000;">65290</span>
<span style="color: #000000; font-weight: bold;">/*</span> File <span style="color: #ff0000;">&quot;/Users/max/work/mon_projet/apps/mon_apps/views/others.py&quot;</span>, line <span style="color: #000000;">146</span>, <span style="color: #000000; font-weight: bold;">in</span> user_public_page
	user = User.objects.get<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #007800;">pk</span>=user_id<span style="color: #7a0874; font-weight: bold;">&#41;</span>
<span style="color: #000000; font-weight: bold;">*/</span></pre></div></div>

<p>Observez cette merveille !<br />
Entre <strong>/* */</strong> sont les infos générées par django-sql-stacktrace. J&#8217;ai nettoyé quelques fichiers pour plus de lisibilité.<br />
Vous avez droit au chemin du fichier de la requête, à la ligne de la requête et à la requête django elle-même.</p>
<p><strong>Une alternative ? J&#8217;ai pas envie d&#8217;installer d&#8217;app.</strong></p>
<p>Pour les grosses feignasses ou si vous voulez juste tester occasionnellement quelques queries vous pouvez utiliser la méthode extra pour ajouter vos propres commentaires.</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;">videos = Video.objects.filter<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #007800;">status</span>=<span style="color: #ff0000;">'online'</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>.extra<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #007800;">where</span>=<span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #ff0000;">'1=1 /* ceci apparaitra dans les logs mysql ! */'</span><span style="color: #7a0874; font-weight: bold;">&#93;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span></pre></div></div>

<p>Cependant le WHERE 1=1 peut causer quelques baisses de performances, mais lorsqu&#8217;on est en debug en local ça peut servir !</p>
<p>PS: Je rappelle également le formidable outil <a href="https://github.com/django-debug-toolbar/django-debug-toolbar">django-debug-toolbar</a> qui devient vite indispensable.</p>
<p>Alors ? Elle est pas belle la vie ?</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=8447&amp;md5=0c39a616337564e02ef8f370811c5c82" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/afficher-le-queryset-dune-requete-dans-les-logs-sql-sous-django/feed/</wfw:commentRss>
		<slash:comments>2</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fafficher-le-queryset-dune-requete-dans-les-logs-sql-sous-django%2F&amp;language=en_GB&amp;category=text&amp;title=Afficher+le+queryset+d%26%238217%3Bune+requ%C3%AAte+dans+les+logs+SQL+sous+Django&amp;description=C%26%238217%3Best+No%C3%ABl%2C+2+articles+rien+que+pour+vous+dont+un+tr%C3%A8s+interressant+de+Sam.+L%26%238217%3BORM+de+django+pour+les+bases+de+donn%C3%A9es+est+chouette%2C+agr%C3%A9able+%C3%A0+utiliser+mais+construit+des...&amp;tags=django%2Cmysql%2Cpython%2Ctrace%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/12/fontaine_chocolat.jpg" length="26691" type="image/jpg" />	</item>
		<item>
		<title>Ignorer certains caractères spéciaux dans un template django</title>
		<link>http://sametmax.com/ignorer-certains-caracteres-speciaux-dans-un-template-django/</link>
		<comments>http://sametmax.com/ignorer-certains-caracteres-speciaux-dans-un-template-django/#comments</comments>
		<pubDate>Mon, 09 Dec 2013 07:04:51 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[javascript]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[tag]]></category>
		<category><![CDATA[template]]></category>
		<category><![CDATA[verbatime]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=8268</guid>
		<description><![CDATA[Hier Max me demandait comment mettre un template Javascript dans un template Django s'ils utilisent la même syntaxe.]]></description>
			<content:encoded><![CDATA[<p>Hier Max me demandait comment mettre un template Javascript dans un template Django s&#8217;ils utilisent la même syntaxe.</p>
<p>La réponse : utiliser le tag &#8220;verbatim&#8221; :</p>
<pre>{% verbatim %}
  Mettre ici le code que django doit afficher tel quel, sans interpréter.
{% endverbatim %}</pre>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=8268&amp;md5=8befa07ac1d855e17ce1f253e695bef8" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/ignorer-certains-caracteres-speciaux-dans-un-template-django/feed/</wfw:commentRss>
		<slash:comments>6</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fignorer-certains-caracteres-speciaux-dans-un-template-django%2F&amp;language=en_GB&amp;category=text&amp;title=Ignorer+certains+caract%C3%A8res+sp%C3%A9ciaux+dans+un+template+django&amp;description=Hier+Max+me+demandait+comment+mettre+un+template+Javascript+dans+un+template+Django+s%26%238217%3Bils+utilisent+la+m%C3%AAme+syntaxe.+La+r%C3%A9ponse+%3A+utiliser+le+tag+%26%238220%3Bverbatim%26%238221%3B+%3A+%7B%25+verbatim+%25%7D+Mettre...&amp;tags=django%2Cjavascript%2Cpython%2Ctag%2Ctemplate%2Cverbatime%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/12/rkMxVfI.jpg" length="43698" type="image/jpg" />	</item>
		<item>
		<title>Ecrire une commande Django</title>
		<link>http://sametmax.com/ecrire-une-commande-django/</link>
		<comments>http://sametmax.com/ecrire-une-commande-django/#comments</comments>
		<pubDate>Wed, 04 Dec 2013 07:01:44 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[commande]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[manage.py]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=7729</guid>
		<description><![CDATA[Quand vous avez à faire un script pour un projet Django, il est pratique de l'avoir sous forme de sous-commande de <code>manage.py</code> : c'est portable d'un projet à l'autre et ça permet d'utiliser l'ORM et les templates sans réglage puisqu'on a accès à tous les settings, automatiquement.]]></description>
			<content:encoded><![CDATA[<p>Quand vous avez à faire un script pour un projet Django, il est pratique de l&#8217;avoir sous forme de sous-commande de <code>manage.py</code> : c&#8217;est portable d&#8217;un projet à l&#8217;autre et ça permet d&#8217;utiliser l&#8217;ORM et les templates sans réglage puisqu&#8217;on a accès à tous les settings, automatiquement.</p>
<p>Malheureusement le wrapper de Django destiné à cela date un peu, il est plutôt lourd, pas très souple et utilise des pratiques qui ne sont plus au goût du jour depuis quelques années. Rien de rédhibitoire, mais tout de même.</p>
<p>D&#8217;abord, il faut placer sa commande dans un fichier portant le nom de la commande, et dans un package <code>management.commands</code> d&#8217;une de vos apps.</p>
<p>Par exemple, si vous voulez faire une commande &#8220;nettoyer_godmichets&#8221; dans l&#8217;application &#8220;sex_shop&#8221;, il faudra la mettre bien profondément dans le tréfonds de votre projet :</p>
<pre>racine
│   ├── sex_shop
│   │   ├── management
│   │   │   ├── commands
│   │   │   │   ├── nettoyer_godmichets.py
│   │   │   │   ├── __init__.py
│   │   │   │   └── __init__.pyc
│   │   │   ├── __init__.py</pre>
<p>Notez les fichiers <em>__init__.py</em>, indispendables sinon votre commande ne sera pas trouvée. Oh, et &#8216;sex_shop&#8217; doit être dans <code>INSTALLED_APPS</code>.</p>
<p>Ensuite, votre commande doit être une classe héritant de <code>BaseCommand</code>. Sa méthode <code>handle()</code> sera appelée automatiquement au lancement de la commande.</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">from</span> django.<span style="color: black;">core</span>.<span style="color: black;">management</span>.<span style="color: black;">base</span> <span style="color: #ff7700;font-weight:bold;">import</span> BaseCommand
<span style="color: #ff7700;font-weight:bold;">from</span> sex_shop.<span style="color: black;">models</span> <span style="color: #ff7700;font-weight:bold;">import</span> Godmichet
&nbsp;
<span style="color: #ff7700;font-weight:bold;">class</span> Command<span style="color: black;">&#40;</span>BaseCommand<span style="color: black;">&#41;</span>:
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> handle<span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, <span style="color: #66cc66;">*</span>args, <span style="color: #66cc66;">**</span>options<span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">for</span> god <span style="color: #ff7700;font-weight:bold;">in</span> Godmichet.<span style="color: black;">objects</span>.<span style="color: #008000;">all</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
            god.<span style="color: black;">clean</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre></div></div>

<p>Et vous pouvez lancer la commande :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">./manage.<span style="color: black;">py</span> nettoyer_godmichets</pre></div></div>

<p>Néanmoins généralement on voudra avoir un peu de décorum.</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">&nbsp;
<span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">optparse</span> <span style="color: #ff7700;font-weight:bold;">import</span> make_option
&nbsp;
<span style="color: #ff7700;font-weight:bold;">from</span> django.<span style="color: black;">core</span>.<span style="color: black;">management</span>.<span style="color: black;">base</span> <span style="color: #ff7700;font-weight:bold;">import</span> BaseCommand
<span style="color: #ff7700;font-weight:bold;">from</span> sex_shop.<span style="color: black;">models</span> <span style="color: #ff7700;font-weight:bold;">import</span> Godmichet, Marque
&nbsp;
&nbsp;
<span style="color: #ff7700;font-weight:bold;">class</span> Command<span style="color: black;">&#40;</span>BaseCommand<span style="color: black;">&#41;</span>:
&nbsp;
    <span style="color: #808080; font-style: italic;"># ici on peut mettre un message d'aide</span>
    <span style="color: #008000;">help</span> = <span style="color: #483d8b;">'Fait briller dard dard les dards'</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># optionellement une aide pour les arguments</span>
    args = <span style="color: #483d8b;">'marque1, [marque2], marque3'</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># On peut ajouter des options passables à la commande</span>
    option_list = BaseCommand.<span style="color: black;">option_list</span> + <span style="color: black;">&#40;</span>
        make_option<span style="color: black;">&#40;</span><span style="color: #483d8b;">'--dry-run'</span>,
            action=<span style="color: #483d8b;">'store_true'</span>,
            dest=<span style="color: #483d8b;">'dry_run'</span>,
            default=<span style="color: #008000;">False</span>,
            <span style="color: #008000;">help</span>=<span style="color: #483d8b;">'Affichage uniquement, aucune action réelle'</span><span style="color: black;">&#41;</span>,
        <span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> handle<span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, <span style="color: #66cc66;">*</span>args, <span style="color: #66cc66;">**</span>options<span style="color: black;">&#41;</span>:
&nbsp;
        <span style="color: #808080; font-style: italic;"># on retrouve dans args les arguments positionnels de la commande</span>
&nbsp;
        <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #ff7700;font-weight:bold;">not</span> args:
            <span style="color: #ff7700;font-weight:bold;">for</span> god <span style="color: #ff7700;font-weight:bold;">in</span> Godmichet.<span style="color: black;">objects</span>.<span style="color: #008000;">all</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
                <span style="color: #808080; font-style: italic;"># Plutôt que print(), on peut utiliser ce wrapper</span>
                <span style="color: #808080; font-style: italic;"># pour ecrire sur le terminal. Cela permet de bénéficier</span>
                <span style="color: #808080; font-style: italic;"># automatiquement de l'option --verbosity</span>
                <span style="color: #008000;">self</span>.<span style="color: black;">stdout</span>.<span style="color: black;">write</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'Processing %s'</span> <span style="color: #66cc66;">%</span> god.<span style="color: black;">name</span><span style="color: black;">&#41;</span>
&nbsp;
                <span style="color: #808080; font-style: italic;"># La valeur des options est passée via kwargs.</span>
                <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #ff7700;font-weight:bold;">not</span> options<span style="color: black;">&#91;</span><span style="color: #483d8b;">'dry_run'</span><span style="color: black;">&#93;</span>:
                    god.<span style="color: black;">clean</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">else</span>:
            <span style="color: #808080; font-style: italic;"># l'utilisateur a passé des marques ? On nettoie que les gods</span>
            <span style="color: #808080; font-style: italic;"># de ces marques...</span>
            <span style="color: #ff7700;font-weight:bold;">for</span> marque <span style="color: #ff7700;font-weight:bold;">in</span> args:
                <span style="color: #ff7700;font-weight:bold;">try</span>:
                    gods = Marque.<span style="color: black;">objects</span>.<span style="color: black;">get</span><span style="color: black;">&#40;</span>name=marque<span style="color: black;">&#41;</span>.<span style="color: black;">gods</span>.<span style="color: #008000;">all</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
                    <span style="color: #ff7700;font-weight:bold;">for</span> god <span style="color: #ff7700;font-weight:bold;">in</span> gods:
                        <span style="color: #008000;">self</span>.<span style="color: black;">stdout</span>.<span style="color: black;">write</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'Processing %s'</span> <span style="color: #66cc66;">%</span> god.<span style="color: black;">name</span><span style="color: black;">&#41;</span>
&nbsp;
                        <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #ff7700;font-weight:bold;">not</span> options<span style="color: black;">&#91;</span><span style="color: #483d8b;">'dry_run'</span><span style="color: black;">&#93;</span>:
                            god.<span style="color: black;">clean</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
                <span style="color: #ff7700;font-weight:bold;">except</span> Marque.<span style="color: black;">DoesNotExist</span>:
                    <span style="color: #808080; font-style: italic;"># si la marque n'existe pas, on fait une erreur</span>
                    <span style="color: #808080; font-style: italic;"># ceci arrête le script, retourne un code d'erreur 1</span>
                    <span style="color: #808080; font-style: italic;"># et met le texte en rouge</span>
                    <span style="color: #ff7700;font-weight:bold;">raise</span> CommandError<span style="color: black;">&#40;</span><span style="color: #483d8b;">'La marque %s n'</span>existe pas<span style="color: #483d8b;">' %s marque)</span></pre></div></div>

<p>Et voilà, votre commande accepte maintenant optionnellement qu&#8217;on lui passe une liste de marques et/ou une option <code>--dry-run</code>:</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;">.<span style="color: #000000; font-weight: bold;">/</span>manage.py nettoyer_godmichet devilmaycry choucroutebestfriend <span style="color: #660033;">--dry-run</span></pre></div></div>

<p>En plus de ça, la commande accepte automatiquement :</p>
<ul>
<li><code>--help</code></li>
<li><code>--verbosity</code></li>
<li><code>--settings</code></li>
<li><code>--pythonpath</code></li>
</ul>
<p>Qui ont le même effet que sur toutes les commandes django officielles.</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=7729&amp;md5=e5a09ee82a859a49b547ebb46111ce2a" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/ecrire-une-commande-django/feed/</wfw:commentRss>
		<slash:comments>4</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fecrire-une-commande-django%2F&amp;language=en_GB&amp;category=text&amp;title=Ecrire+une+commande+Django&amp;description=Quand+vous+avez+%C3%A0+faire+un+script+pour+un+projet+Django%2C+il+est+pratique+de+l%26%238217%3Bavoir+sous+forme+de+sous-commande+de+manage.py+%3A+c%26%238217%3Best+portable+d%26%238217%3Bun+projet+%C3%A0+l%26%238217%3Bautre+et...&amp;tags=commande%2Cdjango%2Cmanage.py%2Cpython%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/12/BZ7BYa_CYAAEiTA.jpglarge.jpeg" length="31412" type="image/jpg" />	</item>
		<item>
		<title>Changer le mot de passe du super utilisateur django en ligne de commande</title>
		<link>http://sametmax.com/changer-le-mot-de-passe-du-super-utilisateur-django-en-ligne-de-commande/</link>
		<comments>http://sametmax.com/changer-le-mot-de-passe-du-super-utilisateur-django-en-ligne-de-commande/#comments</comments>
		<pubDate>Sun, 01 Dec 2013 00:20:18 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[manage.py]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=8020</guid>
		<description><![CDATA[Vous avez oublié ce maudis mot de passe ? Impossible de se connecter à l'admin ?]]></description>
			<content:encoded><![CDATA[<p>Vous avez oublié ce maudit mot de passe ? Impossible de se connecter à l&#8217;admin ?</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;">.<span style="color: #000000; font-weight: bold;">/</span>manage.py changepassword username</pre></div></div>

<p>Pas besoin d&#8217;être root.</p>
<p>Souvenez-vous aussi que vous pouvez quasiment tout faire depuis un shell en faisant :</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;">.<span style="color: #000000; font-weight: bold;">/</span>manage.py shell</pre></div></div>

<p>Ce qui vous permet d&#8217;importer les modèles de vos apps et faire toutes les querys que vous voulez.</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=8020&amp;md5=30502664a6433d32c395442f20ec728d" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/changer-le-mot-de-passe-du-super-utilisateur-django-en-ligne-de-commande/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fchanger-le-mot-de-passe-du-super-utilisateur-django-en-ligne-de-commande%2F&amp;language=en_GB&amp;category=text&amp;title=Changer+le+mot+de+passe+du+super+utilisateur+django+en+ligne+de+commande&amp;description=Vous+avez+oubli%C3%A9+ce+maudit+mot+de+passe+%3F+Impossible+de+se+connecter+%C3%A0+l%26%238217%3Badmin+%3F+.%2Fmanage.py+changepassword+username+Pas+besoin+d%26%238217%3B%C3%AAtre+root.+Souvenez-vous+aussi+que+vous+pouvez+quasiment+tout...&amp;tags=django%2Cmanage.py%2Cpython%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/12/tumblr_mwz8n9837V1r539hzo1_500.jpg" length="47441" type="image/jpg" />	</item>
		<item>
		<title>Compter les doublons avec l&#8217;ORM Django</title>
		<link>http://sametmax.com/compter-les-doublons-avec-lorm-django/</link>
		<comments>http://sametmax.com/compter-les-doublons-avec-lorm-django/#comments</comments>
		<pubDate>Fri, 22 Nov 2013 08:28:48 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[group by]]></category>
		<category><![CDATA[orm]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=7761</guid>
		<description><![CDATA[<code>GROUP BY </code>et <code>HAVING</code> sont assez peu intuitifs en SQL, et encore moins avec l'ORM Django.]]></description>
			<content:encoded><![CDATA[<p><code>GROUP BY </code>et <code>HAVING</code> sont assez peu intuitifs en SQL, et encore moins avec l&#8217;ORM Django.</p>
<p>Voici donc la recette pour compter le nombre d’occurrences des valeurs d&#8217;un champ, pour par exemple trouver les doublons.</p>
<p>En supposant une table <code>Massage</code> avec une valeur <code>finish</code> :</p>
<pre>
ID         FINISH
1          manuel
2          oral
3          oral
4          oral
</pre>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> Massage.<span style="color: black;">objects</span>.<span style="color: black;">values</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'finish'</span><span style="color: black;">&#41;</span>.<span style="color: black;">annotate</span><span style="color: black;">&#40;</span>count=Count<span style="color: black;">&#40;</span><span style="color: #483d8b;">'id'</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: black;">&#123;</span><span style="color: #483d8b;">'manuel'</span>: <span style="color: #ff4500;">2</span>, <span style="color: #483d8b;">'oral'</span>: <span style="color: #483d8b;">'9'</span>: <span style="color: #483d8b;">'rectal'</span>: <span style="color: #ff4500;">1</span>, <span style="color: #483d8b;">'paradoxal'</span>: -<span style="color: #ff4500;">1</span><span style="color: black;">&#125;</span></pre></div></div>

<p>Pour obtenir uniquement les doublons, il suffit de filtrer pour avoir les valeurs qui ont un <code>count</code> plus grand que 1 :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">Massage.<span style="color: black;">objects</span>.<span style="color: black;">values</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'finish'</span><span style="color: black;">&#41;</span>.<span style="color: black;">annotate</span><span style="color: black;">&#40;</span>count=Count<span style="color: black;">&#40;</span><span style="color: #483d8b;">'id'</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>.<span style="color: #008000;">filter</span><span style="color: black;">&#40;</span>count__gt=<span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span></pre></div></div>

 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=7761&amp;md5=70ebd178c4abc22f9fe60ba0f38b5e38" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/compter-les-doublons-avec-lorm-django/feed/</wfw:commentRss>
		<slash:comments>11</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fcompter-les-doublons-avec-lorm-django%2F&amp;language=en_GB&amp;category=text&amp;title=Compter+les+doublons+avec+l%26%238217%3BORM+Django&amp;description=GROUP+BY+et+HAVING+sont+assez+peu+intuitifs+en+SQL%2C+et+encore+moins+avec+l%26%238217%3BORM+Django.+Voici+donc+la+recette+pour+compter+le+nombre+d%E2%80%99occurrences+des+valeurs+d%26%238217%3Bun+champ%2C+pour...&amp;tags=django%2Cgroup+by%2Corm%2Cpython%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/11/91390283.png" length="434902" type="image/jpg" />	</item>
		<item>
		<title>Créer un super utilisateur Django sans prompt</title>
		<link>http://sametmax.com/creer-un-super-utilisateur-django-sans-prompt/</link>
		<comments>http://sametmax.com/creer-un-super-utilisateur-django-sans-prompt/#comments</comments>
		<pubDate>Wed, 20 Nov 2013 09:23:12 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[manage.py]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[superuser]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=7981</guid>
		<description><![CDATA[Automatiser le déploiement d'un projet Django passe par un <code>syncdb</code> sans prompt, et donc pas de création de superutilisateur...]]></description>
			<content:encoded><![CDATA[<p>Automatiser le déploiement d&#8217;un projet Django passe par un <code>syncdb</code> sans prompt, et donc pas de création de superutilisateur :</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;">.<span style="color: #000000; font-weight: bold;">/</span>manage.py syncdb <span style="color: #660033;">--noinput</span></pre></div></div>

<p>Vous pouvez bien entendu toujours en créer un plus tard, avec :</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;">.<span style="color: #000000; font-weight: bold;">/</span>manage.py createsuperuser <span style="color: #660033;">--username</span>=vous <span style="color: #660033;">--email</span>=votre_mail</pre></div></div>

<p>Mais il va vous prompter pour saisir le mot de passe ou alors mettre un mot de passe inutilisable automatiquement, ça ne résout pas votre problème. Une astuce consiste à le créer avec un code Python et à piper ce code dans un shell :</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #7a0874; font-weight: bold;">echo</span> <span style="color: #ff0000;">&quot;from django.contrib.auth.models import User; User.objects.filter(username='vous').count() or User.objects.create_superuser('vous', votre_email', 'mot_de_passe')&quot;</span> <span style="color: #000000; font-weight: bold;">|</span> .<span style="color: #000000; font-weight: bold;">/</span>manage.py shell</pre></div></div>

<p>Personnellement je colle ça dans une tache <a href="http://sametmax.com/travailler-moins-pour-gagner-plus-en-15-minutes-avec-python-fabric/">fabric</a>. Parfois on peut même générer le mot de passe aléatoirement avec un <a href="http://sametmax.com/quest-ce-quun-uuid-et-a-quoi-ca-sert/">uuid</a> qui est printé localement.</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=7981&amp;md5=5968a2cf4dce21ecfb87305b3e6e8fbd" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/creer-un-super-utilisateur-django-sans-prompt/feed/</wfw:commentRss>
		<slash:comments>5</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fcreer-un-super-utilisateur-django-sans-prompt%2F&amp;language=en_GB&amp;category=text&amp;title=Cr%C3%A9er+un+super+utilisateur+Django+sans+prompt&amp;description=Automatiser+le+d%C3%A9ploiement+d%26%238217%3Bun+projet+Django+passe+par+un+syncdb+sans+prompt%2C+et+donc+pas+de+cr%C3%A9ation+de+superutilisateur+%3A+.%2Fmanage.py+syncdb+--noinput+Vous+pouvez+bien+entendu+toujours+en+cr%C3%A9er...&amp;tags=django%2Cmanage.py%2Cpython%2Csuperuser%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/11/tumblr_mtqsqnbEqM1r539hzo1_500.jpg" length="34248" type="image/jpg" />	</item>
		<item>
		<title>La stack techno qu&#8217;on utilise pour faire un site Web, et pourquoi</title>
		<link>http://sametmax.com/la-stack-techno-quon-utilise-pour-faire-un-site-web-et-pourquoi/</link>
		<comments>http://sametmax.com/la-stack-techno-quon-utilise-pour-faire-un-site-web-et-pourquoi/#comments</comments>
		<pubDate>Mon, 11 Nov 2013 06:40:38 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[celery]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[fabric]]></category>
		<category><![CDATA[mysql]]></category>
		<category><![CDATA[nginx]]></category>
		<category><![CDATA[nosql]]></category>
		<category><![CDATA[postgres]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[redis]]></category>
		<category><![CDATA[vm]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=7648</guid>
		<description><![CDATA[Une stack techno n'est pas une référence. Il n'y a pas de combo absolu qui rox absolument tout, c'est une question de contexte technique, financier, humain...

Mais c'est vrai que ça aide bien d'avoir sous les yeux les pratiques des autres.]]></description>
			<content:encoded><![CDATA[<p>Une stack techno n&#8217;est pas une référence. Il n&#8217;y a pas de combo absolu qui rox absolument tout, c&#8217;est une question de contexte technique, financier, humain&#8230;</p>
<p>Mais c&#8217;est vrai que ça aide bien d&#8217;avoir sous les yeux les pratiques des autres.</p>
<p>Je ne vais pas expliquer pourquoi Python, <a href="http://sametmax.com/10-raisons-pour-lesquelles-je-suis-toujours-marie-a-python/">je l&#8217;ai déjà fait</a>.</p>
<p>Commençons plutôt par la partie purement Web, pour laquelle on utilise Django, le framework Web Python.</p>
<p>Max et moi avons tout deux fait du PHP avant, j&#8217;ai tâté des frameworks internes, du Symfony et plus tard du Zope. J&#8217;ai regardé du côté de Pyramid et de ses prédécesseurs, et Django est celui qui me plaît le plus. J&#8217;ai juste un peu forcé la main à Max :-)</p>
<p>Car oui, le framework a été avant tout un choix de goût.</p>
<p>Ce n&#8217;est pas un choix de performances : le framework n&#8217;a aucun impact dessus. Aucun. Les architectures ont un impact. Le framework, non. Votre bottleneck sera sur les IO, pas sur le CPU. Le choix de technos asynchrones peut avoir un impact, mais ce n&#8217;est pas une question de framework. Tornado, Twisted ou NodeJS, on s&#8217;en fout. </p>
<p>Donc Django, essentiellement parce qu&#8217;il me plait. Et il me plaît pour ces raisons :</p>
<ul>
<li>Il y a un bon équilibre entre découplage et intégration. En général c&#8217;est soit très découplé et mal intégré, soit très bien intégré et très couplé.</li>
<li>C&#8217;est bien foutu et bien documenté. Et c&#8217;est stable. Vraiment très stable. Les core devs sont hyper sérieux.</li>
<li>C&#8217;est très versatile et ça peut faire plein de trucs out of the box, petits comme gros.</li>
<li>C&#8217;est assez facile à apprendre. Ça reste un framework, donc ce n&#8217;est pas la plus simple des démarches, mais dans le royaume des frameworks de cette taille, ça reste vraiment le plus simple.</li>
<li>La communauté est fantastique : il y a des centaines d&#8217;apps qui couvrent pratiquement tous les besoins.</li>
<li>Et bien entendu, c&#8217;est en Python.</li>
</ul>
<p>En terme de base de données, on a fait du MySQL pendant longtemps. Ça a plutôt bien marché. Maintenant je commence mes nouveaux projets avec PostGres, qui est plus solide. Parfois je fais juste du Sqlite, parce que ça suffit.</p>
<p>Pas de NoSQL. Après plusieurs expériences avec MongoDB et CouchDB, je n&#8217;ai pas été convaincu que les bénéfices dépassaient le coût. Il faudrait un article complet là dessus (qu&#8217;on m&#8217;a d&#8217;ailleurs demandé).</p>
<p>Question OS. c&#8217;est du CentOS avec Max (il a plus l&#8217;habitude) ou du Ubuntu Server pour mes autres projets. Je reste sur les LTS. Ce n&#8217;est pas un choix très réfléchi, c&#8217;est surtout par habitude.</p>
<p>Pas de machine virtuelle. On a essayé, sans y trouver un grand intérêt :</p>
<ul>
<li>Il faut quand même faire des scripts de migration, donc autant s&#8217;en servir pour le déploiement.</li>
<li>On perd en perfs.</li>
<li>Les erreurs liées au mal-fonctionnement d&#8217;une VM sont absolument indébuggable.</li>
<li>Si on ne fait pas la VM soit-même, il faut mettre ses couilles dans les mains d&#8217;un pestataire de service. J&#8217;ai horreur de ça.</li>
<li>Trouver des gens avec la compétence pour gérer une VM, c&#8217;est difficile. Un script de déploiement, c&#8217;est du code que tout dev saura déjà lire. Par extension ça veut dire que je m&#8217;y replonge facilement des semaines plus tard.</li>
</ul>
<p>Et donc pour le déploiement, j&#8217;utilise <a href="http://sametmax.com/travailler-moins-pour-gagner-plus-en-15-minutes-avec-python-fabric/">fabric</a>, avec <a href="https://github.com/ronnix/fabtools/">fabtools</a>.</p>
<p>Ce n&#8217;est pas la solution la plus efficace, d&#8217;autant que ça limite à Python 2.7, mais c&#8217;est la plus simple. C&#8217;est juste du code Python. N&#8217;importe qui peut comprendre le déploiement en 15 minutes. Ça se modifie vite, s&#8217;adapte facilement. </p>
<p>Il faut comprendre qu&#8217;on a jamais plus d&#8217;une dizaine de serveurs pour un projet, ces choix sont donc fait en fonction de cela. Il va sans dire que si vous gérez un parc de centaines de machines, ça ne sera pas du tout le même choix technique. Peut être que Chef ou des VM seront alors carrément plus interressant. Peut être que le NoSQL et sa capacité au scalling sera bien plus rentable.</p>
<p>Il ne s&#8217;agit pas de décrier les technos que nous n&#8217;utilisons pas. Il s&#8217;agit juste de dire, voilà les choix que nous avons fait, dans tel contexte, pour telles (bonnes ou mauvaises) raisons.</p>
<p>Durant les dernières années, on a ajouté <a href="http://redis.io/">Redis</a> à notre stack. C&#8217;est un outil fantastique qui sert à tout : de la base de données pour les trucs simples (il y a des fois ou un schéma est overkill) à la solution de caching. C&#8217;est ce qu&#8217;on a de plus proche du NoSQL.</p>
<p>L&#8217;outil est tellement simple à installer (vraiment le degré zero de la maintenance, c&#8217;est beau) et à utiliser que ça ne vaut juste pas le coup de s&#8217;en priver. </p>
<p>Du coup, plus de memcache. Toutes les grosses requêtes sont sauvegardées dans Redis, dès qu&#8217;on fait un script qui a besoin de persistance temporaire, Redis, pour communiquer entre plusieurs process, Redis, pour toutes les opérations qui ont besoin de grosses perfs comme les stats, Redis. Vive Redis.</p>
<p>D&#8217;ailleurs on utilise Redis aussi comme broker pour notre gestionnaire de queues et de taches : <a href="sametmax.com/files-de-taches-et-taches-recurrentes-avec-celery/">celery</a>. Si vous pythonez, je vous recommande chaudement celery pour toutes les tâches en background, les crawlers, les chaînes de process, etc.</p>
<p>On a aussi du moteur de recherche. Là on tappe dans du <a href="http://lucene.apache.org/solr/">Solr</a> (avec <a href="http://haystacksearch.org/">haystack</a>). C&#8217;est très puissant, en tout cas syntaxiquement car ça ne fait pas de sémantique. Ne vous attendez-donc pas à rattraper Google. Mais c&#8217;est aussi méga chiant à configurer et très lourd. Je pense qu&#8217;un jour on va migrer sur <a href="http://www.elasticsearch.org/">ElasticSearch</a>, mais c&#8217;est pas la priorité. Don&#8217;t fix what ain&#8217;t broken.</p>
<p>Devant tout ça on a <a href="http://nginx.org/">Nginx</a>. Comme beaucoup on a fait Apache => Cherokee => lighttp => nginx. Et franchement, je ne reviendrais jamais en arrière : plus léger, plus rapide, plus facile à installer et à configurer, plus versatile. Nginx fait tout, et mieux. </p>
<p>En proxy on a du <a href="http://gunicorn.org/">gunicorn</a>. Parce qu&#8217;on avait la flemme de configurer uwsgi et qu&#8217;on a pris l&#8217;habitude.</p>
<p>Après on utilise plein de libs, de petits outils, etc. Mais ça c&#8217;est le gros de notre archi.</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=7648&amp;md5=a3c473ad94a4298f30d5296cdd292afc" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/la-stack-techno-quon-utilise-pour-faire-un-site-web-et-pourquoi/feed/</wfw:commentRss>
		<slash:comments>25</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fla-stack-techno-quon-utilise-pour-faire-un-site-web-et-pourquoi%2F&amp;language=en_GB&amp;category=text&amp;title=La+stack+techno+qu%26%238217%3Bon+utilise+pour+faire+un+site+Web%2C+et+pourquoi&amp;description=Une+stack+techno+n%26%238217%3Best+pas+une+r%C3%A9f%C3%A9rence.+Il+n%26%238217%3By+a+pas+de+combo+absolu+qui+rox+absolument+tout%2C+c%26%238217%3Best+une+question+de+contexte+technique%2C+financier%2C+humain%26%238230%3B+Mais+c%26%238217%3Best+vrai+que...&amp;tags=celery%2Cdjango%2Cfabric%2Cmysql%2Cnginx%2Cnosql%2Cpostgres%2Cpython%2Credis%2Cvm%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/11/nZ9b9.jpg" length="67160" type="image/jpg" />	</item>
		<item>
		<title>Mise à jour de Django-quicky pour supporter django 1.6</title>
		<link>http://sametmax.com/mise-a-jour-de-django-quicky-pour-supporter-django-1-6/</link>
		<comments>http://sametmax.com/mise-a-jour-de-django-quicky-pour-supporter-django-1-6/#comments</comments>
		<pubDate>Sat, 09 Nov 2013 13:32:23 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[django-quicky]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[settings.py]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=7716</guid>
		<description><![CDATA[Avec Django 1.6 qui vient de sortir hier, j'ai pu m’apercevoir que <a href="http://sametmax.com/django-quicky-labolition-des-preliminaires-par-sam-et-max/">django-quicky</a> ne marchait plus sur cette nouvelle version.]]></description>
			<content:encoded><![CDATA[<p>Avec Django 1.6 qui vient de sortir hier, j&#8217;ai pu m’apercevoir que <a href="http://sametmax.com/django-quicky-labolition-des-preliminaires-par-sam-et-max/">django-quicky</a> ne marchait plus sur cette nouvelle version. Un sombre histoire de <code>setup_environ</code> qui est deprecated. Comme je l&#8217;utilise (ce qui est mieux avec les outils qu&#8217;on code ^^), j&#8217;ai fait un petit correctif vite-fait.</p>
<p>J&#8217;en ai profité aussi pour ajouter deux fichiers de requirements avec des apps Python que j&#8217;installe très très souvent pour mes projets.</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=7716&amp;md5=be71a871dc7dfb8dc4e81752048c781e" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/mise-a-jour-de-django-quicky-pour-supporter-django-1-6/feed/</wfw:commentRss>
		<slash:comments>2</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fmise-a-jour-de-django-quicky-pour-supporter-django-1-6%2F&amp;language=en_GB&amp;category=text&amp;title=Mise+%C3%A0+jour+de+Django-quicky+pour+supporter+django+1.6&amp;description=Avec+Django+1.6+qui+vient+de+sortir+hier%2C+j%26%238217%3Bai+pu+m%E2%80%99apercevoir+que+django-quicky+ne+marchait+plus+sur+cette+nouvelle+version.+Un+sombre+histoire+de+setup_environ+qui+est+deprecated.+Comme+je...&amp;tags=django%2Cdjango-quicky%2Cpython%2Csettings.py%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/11/USKO4MA.jpg" length="47847" type="image/jpg" />	</item>
		<item>
		<title>Afficher l&#8217;IP d&#8217;un visiteur &#8211; Django vs Nginx</title>
		<link>http://sametmax.com/afficher-la-vrai-ip-dun-visiteur-django-vs-nginx/</link>
		<comments>http://sametmax.com/afficher-la-vrai-ip-dun-visiteur-django-vs-nginx/#comments</comments>
		<pubDate>Fri, 25 Oct 2013 03:53:30 +0000</pubDate>
		<dc:creator>Max</dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[Programmation]]></category>
		<category><![CDATA[Web]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[nginx]]></category>
		<category><![CDATA[real ip]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=7525</guid>
		<description><![CDATA[dis moi quelle est ton IP et je te dirais rien.]]></description>
			<content:encoded><![CDATA[<p>Lorsque l&#8217;on veut connaitre son ip on fait souvent appel à des sites du genre: <a href="http://www.whatismyip.com/">whatismyip.com</a>, <a href="http://www.mon-ip.com/">mon-ip.com</a> ou on utilise un ifconfig en ssh.<br />
Des fois on a aussi besoin de connaître l&#8217;ip d&#8217;un visiteur sur son site, 2 petites méthodes pour le faire sous Django et Nginx.</p>
<p><strong>Sous Django:</strong> </p>
<p>Dans l&#8217;<a href="https://docs.djangoproject.com/en/dev/topics/http/urls/">Urlconf</a></p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">urlpatterns = patterns<span style="color: black;">&#40;</span><span style="color: #483d8b;">''</span>,
    <span style="color: #808080; font-style: italic;"># return client IP</span>
    url<span style="color: black;">&#40;</span>r<span style="color: #483d8b;">'^my_ip$'</span>, get_ip<span style="color: black;">&#41;</span>,
<span style="color: black;">&#41;</span></pre></div></div>

<p>Créez une <a href="https://docs.djangoproject.com/en/dev/topics/http/views/">vue</a> du nom de get_ip qui sera utilisée par l&#8217;urlconf</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">from</span> django <span style="color: #ff7700;font-weight:bold;">import</span> http
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> get_ip<span style="color: black;">&#40;</span>request<span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;
        Vue qui retourne l'IP du client
    &quot;&quot;&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">try</span>:
&nbsp;
    	<span style="color: #808080; font-style: italic;"># récupère l'ip du client</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> http.<span style="color: black;">HttpResponse</span><span style="color: black;">&#40;</span>request.<span style="color: black;">META</span><span style="color: black;">&#91;</span><span style="color: #483d8b;">&quot;REMOTE_ADDR&quot;</span><span style="color: black;">&#93;</span> <span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: #008000;">Exception</span>, e:
        <span style="color: #ff7700;font-weight:bold;">return</span> http.<span style="color: black;">HttpResponse</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'error %s'</span> <span style="color: #66cc66;">%</span> e<span style="color: black;">&#41;</span></pre></div></div>

<p>Le code ci-dessus peut retourner l&#8217;adresse locale (127.0.0.1) dans ce cas il faut tester l&#8217;existence de la variable <strong>HTTP_X_REAL_IP</strong>, certains serveurs web ont besoin d&#8217;être <a href="http://rtcamp.com/tutorials/nginx/forwarding-visitors-real-ip/">configuré</a>. </p>
<p><strong>Sous Nginx:</strong></p>
<p>Dans le fichier de configuration de nginx on écrit une nouvelle <a href="http://wiki.nginx.org/HttpCoreModule#location">location</a></p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #808080; font-style: italic;"># return client ip</span>
location /my_ip <span style="color: black;">&#123;</span>
    default_type <span style="color: #483d8b;">'text/plain'</span><span style="color: #66cc66;">;</span>
    content_by_lua <span style="color: #483d8b;">'ngx.print(ngx.var.remote_addr)'</span><span style="color: #66cc66;">;</span>
<span style="color: black;">&#125;</span></pre></div></div>

<p>il suffit de se rendre à l&#8217;url http://monsite.com/my_ip pour voir s&#8217;afficher son ip. Cependant il faut avoir nginx compilé avec le module <a href="http://wiki.nginx.org/HttpLuaModule">Lua</a> ce qui peut être délicat si l&#8217;on a jamais compilé d&#8217;application.</p>
<p><strong><br />
Conclusion:</strong></p>
<p>Si l&#8217;on s&#8217;en réfère aux deux exemples ci dessus on serait tenté d&#8217;utiliser Nginx car en une seule ligne tout le bazar est réglé.<br />
Le hic c&#8217;est qu&#8217;il faut que Nginx soit compilé avec le module Lua pour afficher l&#8217;ip (sauf si quelqu&#8217;un connaît une autre façon d&#8217;afficher un message de sortie).<br />
La version Django n&#8217;est pas fiable à 100% car suivant comment est configuré votre serveur web il se peut que vous vous retrouviez avec une ip du genre 127.0.0.1.<br />
Il y a aussi la possibilité de parser le résultat des sites web cités en tout début d&#8217;article, certains proposent des Api je crois mais vous dépendez d&#8217;un autre service (on faisait ça au début) qui peuvent vous lâcher à tout moment (ce qui nous est arrivé).<br />
Personnellement je compile toujours nginx avec Lua et quelques autres modules, ça permet de s&#8217;affranchir de plus en plus du backend.</p>
<p>PS: j&#8217;ai mis à jour le titre car il laissait sous-entendre autre chose (merci à Sébastien)</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=7525&amp;md5=5db442cb353a28e02057726c4e826969" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/afficher-la-vrai-ip-dun-visiteur-django-vs-nginx/feed/</wfw:commentRss>
		<slash:comments>11</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fafficher-la-vrai-ip-dun-visiteur-django-vs-nginx%2F&amp;language=en_GB&amp;category=text&amp;title=Afficher+l%26%238217%3BIP+d%26%238217%3Bun+visiteur+%26%238211%3B+Django+vs+Nginx&amp;description=Lorsque+l%26%238217%3Bon+veut+connaitre+son+ip+on+fait+souvent+appel+%C3%A0+des+sites+du+genre%3A+whatismyip.com%2C+mon-ip.com+ou+on+utilise+un+ifconfig+en+ssh.+Des+fois+on+a+aussi+besoin...&amp;tags=django%2Cnginx%2Creal+ip%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/10/identity.jpg" length="31647" type="image/jpg" />	</item>
	</channel>
</rss>
