<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Sam &#38; Max: Python, Django, Git et du cul &#187; log</title>
	<atom:link href="http://sametmax.com/tag/log/feed/" rel="self" type="application/rss+xml" />
	<link>http://sametmax.com</link>
	<description>Deux développeurs en vadrouille qui se sortent les doigts du code</description>
	<lastBuildDate>Wed, 05 Feb 2014 14:20:37 +0000</lastBuildDate>
	<language>en</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>http://wordpress.org/?v=3.3.1</generator>
	<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2F&amp;language=en_US&amp;category=text&amp;title=Sam+%26amp%3B+Max%3A+Python%2C+Django%2C+Git+et+du+cul&amp;description=Deux+d%C3%A9veloppeurs+en+vadrouille+qui+se+sortent+les+doigts+du+code&amp;tags=blog" type="text/html" />
		<item>
		<title>Décorateur de trace</title>
		<link>http://sametmax.com/decorateur-de-trace/</link>
		<comments>http://sametmax.com/decorateur-de-trace/#comments</comments>
		<pubDate>Mon, 15 Apr 2013 17:33:32 +0000</pubDate>
		<dc:creator>xonop</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[decorateur]]></category>
		<category><![CDATA[inspect]]></category>
		<category><![CDATA[introspection]]></category>
		<category><![CDATA[log]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=5670</guid>
		<description><![CDATA[Suite aux superbes articles sur les <a href="http://comprendre-les-decorateurs-python-pas-a-pas-partie-1">décorateurs</a> et sur l'écriture des <a href="http://ecrire-des-logs-en-python/">logs en python</a> j'ai voulu mettre en pratique dans mon projet.
C'est là que les ennuis ont commencé !]]></description>
			<content:encoded><![CDATA[<p><em>(Ceci est un post invité de <a href="http://sametmax.com/author/xonop/">xonop</a> sous licence creative common 3.0 unported.)</em></p>
<p>Suite aux superbes articles sur les <a href="http://sametmax.com/comprendre-les-decorateurs-python-pas-a-pas-partie-1">décorateurs</a> et sur l&#8217;écriture des <a href="http://sametmax.com/ecrire-des-logs-en-python/">logs en python</a> j&#8217;ai voulu mettre en pratique dans mon projet.<br />
C&#8217;est là que les ennuis ont commencé !<br />
<span id="more-5670"></span></p>
<p><strong>Objectif :</strong></p>
<p>Créer un décorateur qui me permette de tracer le passage dans certaines méthodes.<br />
Celui-ci doit :</p>
<ul>
<li>Être débrayable facilement.</li>
<li>Récupérer automatiquement le nom de la méthode, sa classe et son module.</li>
</ul>
<p><strong>Première étape : le logger</strong></p>
<p>Avant toute chose mettons en place l&#8217;environnement pour pouvoir tracer en utilisant le module logging.<br />
Pour simplifier les exemples, nous associons un seul <em>handler</em> de type <em>terminal</em>.<br />
La fonction <code>log_debug</code> permet de faire appel au logger pour tracer une information.</p>
<p><code>logger.py</code> :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> functools
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">logging</span>
&nbsp;
__DECO_ACTIVATED = <span style="color: #008000;">True</span>
__logger = <span style="color: #008000;">None</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> init_logger<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">global</span> __logger
    __logger = <span style="color: #dc143c;">logging</span>.<span style="color: black;">getLogger</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
    __logger.<span style="color: black;">setLevel</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">logging</span>.<span style="color: black;">DEBUG</span><span style="color: black;">&#41;</span>
    terminalHandler = <span style="color: #dc143c;">logging</span>.<span style="color: black;">StreamHandler</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
    terminalHandler.<span style="color: black;">setLevel</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">logging</span>.<span style="color: black;">DEBUG</span><span style="color: black;">&#41;</span>
    __logger.<span style="color: black;">addHandler</span><span style="color: black;">&#40;</span>terminalHandler<span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> log_debug<span style="color: black;">&#40;</span>text<span style="color: black;">&#41;</span>:
    __logger.<span style="color: black;">debug</span><span style="color: black;">&#40;</span>text<span style="color: black;">&#41;</span></pre></div></div>

<p><strong>Deuxième étape : le décorateur, version basique</strong></p>
<p>Pour commencer, le décorateur débrayable :</p>
<p><code>logger.py</code> :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> log_decorator<span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #ff7700;font-weight:bold;">not</span> __DECO_ACTIVATED:
        <span style="color: #ff7700;font-weight:bold;">return</span> func
&nbsp;
    @functools.<span style="color: black;">wraps</span><span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> wrapped<span style="color: black;">&#40;</span><span style="color: #66cc66;">*</span>args, <span style="color: #66cc66;">**</span>kwargs<span style="color: black;">&#41;</span>:
        __logger.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;BEGIN&quot;</span><span style="color: black;">&#41;</span>
        data = func<span style="color: black;">&#40;</span><span style="color: #66cc66;">*</span>args, <span style="color: #66cc66;">**</span>kwargs<span style="color: black;">&#41;</span>
        __logger.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;END&quot;</span><span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> data
    <span style="color: #ff7700;font-weight:bold;">return</span> wrapped</pre></div></div>

<p><strong>Remarques :</strong></p>
<ul>
<li>La fonction est décorée selon la valeur de la variable <code>__DECO_ACTIVATED</code>.</li>
<li>La fonction <a href="http://docs.python.org/3/library/functools.html#functools.wraps">wraps</a> du module <a href="http://docs.python.org/3/library/functools.html">functools</a> reporte les attributs de la fonction originale sur la version <em>wrappée</em> (dont les docstrings).</li>
</ul>
<p>Et maintenant un module pour tester ça :</p>
<p><code>main.py</code> :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> logger
&nbsp;
<span style="color: #ff7700;font-weight:bold;">class</span> Generic<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    @logger.<span style="color: black;">log_decorator</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> do_it<span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, arg1<span style="color: black;">&#41;</span>:
        logger.<span style="color: black;">log_debug</span><span style="color: black;">&#40;</span>arg1<span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">if</span> __name__ == <span style="color: #483d8b;">&quot;__main__&quot;</span>:
    logger.<span style="color: black;">init_logger</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
    generic = Generic<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
    generic.<span style="color: black;">do_it</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;NOW&quot;</span><span style="color: black;">&#41;</span></pre></div></div>

<p>Et voilà le résultat :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">BEGIN
NOW
END</pre></div></div>

<p><strong>Troisième étape : les noms de module et de fonction</strong></p>
<p>Ces informations se récupèrent facilement, voici la nouvelle version du décorateur :</p>
<p><code>logger.py</code> :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> log_decorator<span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #ff7700;font-weight:bold;">not</span> __DECO_ACTIVATED:
        <span style="color: #ff7700;font-weight:bold;">return</span> func
<span style="display:block;background-color: #ffc;">    module_name = func.__module__</span><span style="display:block;background-color: #ffc;">    func_name = func.__name__</span>&nbsp;
    @functools.<span style="color: black;">wraps</span><span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> wrapped<span style="color: black;">&#40;</span><span style="color: #66cc66;">*</span>args, <span style="color: #66cc66;">**</span>kwargs<span style="color: black;">&#41;</span>:
<span style="display:block;background-color: #ffc;">        msg = <span style="color: #483d8b;">&quot;Module={} Function={}&quot;</span>.<span style="color: black;">format</span><span style="color: black;">&#40;</span>module_name, func_name<span style="color: black;">&#41;</span></span>        __logger.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;BEGIN &quot;</span> + msg<span style="color: black;">&#41;</span>
        data = func<span style="color: black;">&#40;</span><span style="color: #66cc66;">*</span>args, <span style="color: #66cc66;">**</span>kwargs<span style="color: black;">&#41;</span>
        __logger.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;END &quot;</span> + msg<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> data
    <span style="color: #ff7700;font-weight:bold;">return</span> wrapped</pre></div></div>

<p>Et maintenant le résultat :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">BEGIN Module=<span style="color: #dc143c;">__main__</span> Function=do_it
NOW
END Module=<span style="color: #dc143c;">__main__</span> Function=do_it</pre></div></div>

<p>Jusqu&#8217;ici tout va bien.</p>
<p><strong>Quatrième étape : le nom de la classe</strong></p>
<p>Et c&#8217;est maintenant que les choses se corsent !<br />
Tout d&#8217;abord, l&#8217;objet <code>func</code> que nous manipulons est une fonction et non une méthode de classe :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&lt;</span>function Generic.<span style="color: black;">do_it</span> at 0x00C70348<span style="color: #66cc66;">&gt;</span></pre></div></div>

<p>En effet lors de l&#8217;exécution du décorateur, la classe en tant qu&#8217;objet n&#8217;existe pas encore.<br />
Il n&#8217;y a pas de lien direct entre la fonction et sa future classe.</p>
<p>Bon nombre de développeurs bien intentionnés nous conseillent d&#8217;utiliser <code>self</code> pour déterminer sa classe.</p>
<p><strong>Oui mais</strong> :</p>
<ul>
<li>Si la fonction n&#8217;est pas une méthode, pas de <code>self</code> !</li>
<li>La classe n&#8217;est pas obligatoirement celle de la méthode. Il peut s&#8217;agir d&#8217;une classe héritée.</li>
</ul>
<p>Pour s&#8217;en convaincre, voici le nouveau décorateur :</p>
<p><code>logger.py</code> :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> log_decorator<span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #ff7700;font-weight:bold;">not</span> __DECO_ACTIVATED:
        <span style="color: #ff7700;font-weight:bold;">return</span> func
    module_name = func.__module__
    func_name = func.__name__
&nbsp;
    @functools.<span style="color: black;">wraps</span><span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> wrapped<span style="color: black;">&#40;</span><span style="color: #66cc66;">*</span>args, <span style="color: #66cc66;">**</span>kwargs<span style="color: black;">&#41;</span>:
<span style="display:block;background-color: #ffc;">        <span style="color: #ff7700;font-weight:bold;">try</span>:</span><span style="display:block;background-color: #ffc;">            class_name = args<span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#93;</span>.__class__.__name__</span><span style="display:block;background-color: #ffc;">        <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: #008000;">IndexError</span>:</span><span style="display:block;background-color: #ffc;">            class_name = <span style="color: #483d8b;">&quot;&quot;</span></span><span style="display:block;background-color: #ffc;">        msg = <span style="color: #483d8b;">&quot;Module={} Class={} Function={}&quot;</span>.<span style="color: black;">format</span><span style="color: black;">&#40;</span></span><span style="display:block;background-color: #ffc;">            module_name, class_name, func_name<span style="color: black;">&#41;</span></span>        __logger.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;BEGIN &quot;</span> + msg<span style="color: black;">&#41;</span>
        data = func<span style="color: black;">&#40;</span><span style="color: #66cc66;">*</span>args, <span style="color: #66cc66;">**</span>kwargs<span style="color: black;">&#41;</span>
        __logger.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;END &quot;</span> + msg<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> data
    <span style="color: #ff7700;font-weight:bold;">return</span> wrapped</pre></div></div>

<p>Et maintenant le module de tests :</p>
<p><code>main.py</code> :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> logger
&nbsp;
<span style="color: #ff7700;font-weight:bold;">class</span> Generic<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    @logger.<span style="color: black;">log_decorator</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> do_it<span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, arg1<span style="color: black;">&#41;</span>:
        logger.<span style="color: black;">log_debug</span><span style="color: black;">&#40;</span>arg1<span style="color: black;">&#41;</span>
&nbsp;
<span style="display:block;background-color: #ffc;"><span style="color: #ff7700;font-weight:bold;">class</span> Specific<span style="color: black;">&#40;</span>Generic<span style="color: black;">&#41;</span>:</span><span style="display:block;background-color: #ffc;">    @logger.<span style="color: black;">log_decorator</span></span><span style="display:block;background-color: #ffc;">    <span style="color: #ff7700;font-weight:bold;">def</span> do_it<span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, arg1<span style="color: black;">&#41;</span>:</span><span style="display:block;background-color: #ffc;">        <span style="color: #008000;">super</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>.<span style="color: black;">do_it</span><span style="color: black;">&#40;</span>arg1<span style="color: black;">&#41;</span></span>&nbsp;
<span style="color: #ff7700;font-weight:bold;">if</span> __name__ == <span style="color: #483d8b;">&quot;__main__&quot;</span>:
    logger.<span style="color: black;">init_logger</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="display:block;background-color: #ffc;">    specific = Specific<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></span><span style="display:block;background-color: #ffc;">    specific.<span style="color: black;">do_it</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;NOW&quot;</span><span style="color: black;">&#41;</span></span></pre></div></div>

<p>Et le résultat tant attendu :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">BEGIN Module=<span style="color: #dc143c;">__main__</span> Class=Specific Function=do_it
BEGIN Module=<span style="color: #dc143c;">__main__</span> Class=Specific Function=do_it
NOW
END Module=<span style="color: #dc143c;">__main__</span> Class=Specific Function=do_it
END Module=<span style="color: #dc143c;">__main__</span> Class=Specific Function=do_it</pre></div></div>

<p>Et là c&#8217;est le drâme, on a perdu la classe <code>Generic</code> ! Mais analysons plutôt l&#8217;exécution :</p>
<ul>
<li>Appel de la méthode <code>Specific.do_it()</code> vu que l&#8217;objet <code>generic</code> est une instance de cette classe.</li>
<li>Appel de la méthode <code>Generic.do_it()</code> par le biais de l&#8217;instruction <code>super().do_it()</code></li>
</ul>
<p>Comme prévu, la classe de l&#8217;objet <code>self</code> ne change pas que l&#8217;on soit dans une méthode de la classe ou de l&#8217;une de ses super-classes.</p>
<p><strong>Quatrième étape : autre approche</strong></p>
<p>Ne pouvant déterminer directement la classe d&#8217;appartenance de la fonction, essayons de la chercher dans le module.<br />
Pour commencer il nous faut l&#8217;objet <code>module</code> alors que nous ne connaissons que son nom.<br />
Le module <a href="http://docs.python.org/3/library/inspect.html">inspect</a> propose justement ce service grâce à <a href="http://docs.python.org/3/library/inspect.html#inspect.getmodule">getmodule</a>.<br />
Voici le décorateur modifié :</p>
<p><code>logger.py</code> :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">inspect</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> log_decorator<span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #ff7700;font-weight:bold;">not</span> __DECO_ACTIVATED:
        <span style="color: #ff7700;font-weight:bold;">return</span> func
    module_name = func.__module__
<span style="display:block;background-color: #ffc;">    module_obj = <span style="color: #dc143c;">inspect</span>.<span style="color: black;">getmodule</span><span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span></span><span style="display:block;background-color: #ffc;">    class_name = <span style="color: #483d8b;">&quot;UNKNOWN&quot;</span></span><span style="display:block;background-color: #ffc;">    <span style="color: #ff7700;font-weight:bold;">for</span> key, obj <span style="color: #ff7700;font-weight:bold;">in</span> module_obj.<span style="color: #0000cd;">__dict__</span>.<span style="color: black;">items</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:</span><span style="display:block;background-color: #ffc;">        <span style="color: #ff7700;font-weight:bold;">try</span>:</span><span style="display:block;background-color: #ffc;">            members = obj.<span style="color: #0000cd;">__dict__</span></span><span style="display:block;background-color: #ffc;">            method = members<span style="color: black;">&#91;</span>func.__name__<span style="color: black;">&#93;</span></span><span style="display:block;background-color: #ffc;">            <span style="color: #ff7700;font-weight:bold;">if</span> method == func:</span><span style="display:block;background-color: #ffc;">                class_name = key</span><span style="display:block;background-color: #ffc;">                <span style="color: #ff7700;font-weight:bold;">break</span></span><span style="display:block;background-color: #ffc;">        <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: black;">&#40;</span><span style="color: #008000;">KeyError</span>, <span style="color: #008000;">AttributeError</span><span style="color: black;">&#41;</span>:</span><span style="display:block;background-color: #ffc;">            <span style="color: #ff7700;font-weight:bold;">pass</span></span>    func_name = func.__name__
&nbsp;
    @functools.<span style="color: black;">wraps</span><span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> wrapped<span style="color: black;">&#40;</span><span style="color: #66cc66;">*</span>args, <span style="color: #66cc66;">**</span>kwargs<span style="color: black;">&#41;</span>:
        msg = <span style="color: #483d8b;">&quot;Module={} Class={} Function={}&quot;</span>.<span style="color: black;">format</span><span style="color: black;">&#40;</span>
            module_name, class_name, func_name<span style="color: black;">&#41;</span>
        __logger.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;BEGIN &quot;</span> + msg<span style="color: black;">&#41;</span>
        data = func<span style="color: black;">&#40;</span><span style="color: #66cc66;">*</span>args, <span style="color: #66cc66;">**</span>kwargs<span style="color: black;">&#41;</span>
        __logger.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;END &quot;</span> + msg<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> data
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">return</span> wrapped</pre></div></div>

<p>Pour rechercher la fonction, le décorateur doit :</p>
<ul>
<li>Lister les objets du module.</li>
<li>Rechercher pour chaque objet le nom de la fonction dans les attributs de celui-ci. Si l&#8217;attribut correspond à notre fonction, c&#8217;est gagné !</li>
</ul>
<p>Nous obtenons alors :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">BEGIN Module=<span style="color: #dc143c;">__main__</span> Class=UNKNOWN Function=do_it
BEGIN Module=<span style="color: #dc143c;">__main__</span> Class=UNKNOWN Function=do_it
NOW
END Module=<span style="color: #dc143c;">__main__</span> Class=UNKNOWN Function=do_it
END Module=<span style="color: #dc143c;">__main__</span> Class=UNKNOWN Function=do_it</pre></div></div>

<p>Pas glop ça marche pas !<br />
Regardons le contenu du module avant la recherche :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>module_obj.<span style="color: #0000cd;">__dict__</span>.<span style="color: black;">keys</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
dict_keys<span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #483d8b;">'__builtins__'</span>, <span style="color: #483d8b;">'__name__'</span>, <span style="color: #483d8b;">'__file__'</span>, <span style="color: #483d8b;">'__doc__'</span>, <span style="color: #483d8b;">'__loader__'</span>,
           <span style="color: #483d8b;">'__cached__'</span>, <span style="color: #483d8b;">'logger'</span>, <span style="color: #483d8b;">'__package__'</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span></pre></div></div>

<p>Curieusement les classes n&#8217;apparaissent pas, mais c&#8217;est tout à fait normal.<br />
Comme vu précédemment, lors de l&#8217;exécution du décorateur la classe est en instance de création.<br />
Il faut donc faire cette recherche lors de l&#8217;exécution de la fonction <em>wrappée</em>.</p>
<p>Le décorateur devient donc :</p>
<p><code>logger.py</code> :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> log_decorator<span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #ff7700;font-weight:bold;">not</span> __DECO_ACTIVATED:
        <span style="color: #ff7700;font-weight:bold;">return</span> func
    module_name = func.__module__
    module_obj = <span style="color: #dc143c;">inspect</span>.<span style="color: black;">getmodule</span><span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span>
    func_name = func.__name__
&nbsp;
    @functools.<span style="color: black;">wraps</span><span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> wrapped<span style="color: black;">&#40;</span><span style="color: #66cc66;">*</span>args, <span style="color: #66cc66;">**</span>kwargs<span style="color: black;">&#41;</span>:
<span style="display:block;background-color: #ffc;">        class_name = <span style="color: #483d8b;">&quot;UNKNOWN&quot;</span></span><span style="display:block;background-color: #ffc;">        <span style="color: #ff7700;font-weight:bold;">for</span> key, obj <span style="color: #ff7700;font-weight:bold;">in</span> module_obj.<span style="color: #0000cd;">__dict__</span>.<span style="color: black;">items</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:</span><span style="display:block;background-color: #ffc;">            <span style="color: #ff7700;font-weight:bold;">try</span>:</span><span style="display:block;background-color: #ffc;">                members = obj.<span style="color: #0000cd;">__dict__</span></span><span style="display:block;background-color: #ffc;">                method = members<span style="color: black;">&#91;</span>func.__name__<span style="color: black;">&#93;</span></span><span style="display:block;background-color: #ffc;">                <span style="color: #ff7700;font-weight:bold;">if</span> method == func:</span><span style="display:block;background-color: #ffc;">                    class_name = key</span><span style="display:block;background-color: #ffc;">                    <span style="color: #ff7700;font-weight:bold;">break</span></span><span style="display:block;background-color: #ffc;">            <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: black;">&#40;</span><span style="color: #008000;">KeyError</span>, <span style="color: #008000;">AttributeError</span><span style="color: black;">&#41;</span>:</span><span style="display:block;background-color: #ffc;">                <span style="color: #ff7700;font-weight:bold;">pass</span></span><span style="display:block;background-color: #ffc;">        msg = <span style="color: #483d8b;">&quot;Module={} Class={} Function={}&quot;</span>.<span style="color: black;">format</span><span style="color: black;">&#40;</span></span><span style="display:block;background-color: #ffc;">            module_name, class_name, func_name<span style="color: black;">&#41;</span></span>        __logger.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;BEGIN &quot;</span> + msg<span style="color: black;">&#41;</span>
        data = func<span style="color: black;">&#40;</span><span style="color: #66cc66;">*</span>args, <span style="color: #66cc66;">**</span>kwargs<span style="color: black;">&#41;</span>
        __logger.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;END &quot;</span> + msg<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> data
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">return</span> wrapped</pre></div></div>

<p>Et le résultat :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">BEGIN Module=<span style="color: #dc143c;">__main__</span> Class=UNKNOWN Function=do_it
BEGIN Module=<span style="color: #dc143c;">__main__</span> Class=UNKNOWN Function=do_it
NOW
END Module=<span style="color: #dc143c;">__main__</span> Class=UNKNOWN Function=do_it
END Module=<span style="color: #dc143c;">__main__</span> Class=UNKNOWN Function=do_it</pre></div></div>

<p>Pas glop 2 le retour !<br />
Faisons appel au débogueur suprême : <code>print</code></p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">key    = Generic
method = <span style="color: #66cc66;">&lt;</span>function Generic.<span style="color: black;">do_it</span> at 0x00D07C90<span style="color: #66cc66;">&gt;</span>
func   = <span style="color: #66cc66;">&lt;</span>function Specific.<span style="color: black;">do_it</span> at 0x00D07CD8<span style="color: #66cc66;">&gt;</span>
&nbsp;
key    = Specific
method = <span style="color: #66cc66;">&lt;</span>function Specific.<span style="color: black;">do_it</span> at 0x00D07D20<span style="color: #66cc66;">&gt;</span>
func   = <span style="color: #66cc66;">&lt;</span>function Specific.<span style="color: black;">do_it</span> at 0x00D07CD8<span style="color: #66cc66;">&gt;</span></pre></div></div>

<p>Effectivement les références ne correspondent pas, et encore une fois, rien de plus normal.<br />
La fonction d&#8217;origine a été <em>wrappée</em> donc celle présente dans le module n&#8217;est plus celle d&#8217;origine.<br />
Qu&#8217;à cela ne tienne, recherchons-là !</p>
<p>Après la déclaration de la fonction <code>wrapped</code>, le décorateur la mémorise dans la variable <code>wrapped_function</code>.<br />
Elle sera utilisée à l&#8217;exécution de la fonction.</p>
<p><code>logger.py</code> :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> log_decorator<span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #ff7700;font-weight:bold;">not</span> __DECO_ACTIVATED:
        <span style="color: #ff7700;font-weight:bold;">return</span> func
    module_name = func.__module__
    module_obj = <span style="color: #dc143c;">inspect</span>.<span style="color: black;">getmodule</span><span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span>
    func_name = func.__name__
&nbsp;
    @functools.<span style="color: black;">wraps</span><span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> wrapped<span style="color: black;">&#40;</span><span style="color: #66cc66;">*</span>args, <span style="color: #66cc66;">**</span>kwargs<span style="color: black;">&#41;</span>:
        class_name = <span style="color: #483d8b;">&quot;UNKNOWN&quot;</span>
        <span style="color: #ff7700;font-weight:bold;">for</span> key, obj <span style="color: #ff7700;font-weight:bold;">in</span> module_obj.<span style="color: #0000cd;">__dict__</span>.<span style="color: black;">items</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
            <span style="color: #ff7700;font-weight:bold;">try</span>:
                members = obj.<span style="color: #0000cd;">__dict__</span>
                method = members<span style="color: black;">&#91;</span>func.__name__<span style="color: black;">&#93;</span>
<span style="display:block;background-color: #ffc;">                <span style="color: #ff7700;font-weight:bold;">if</span> method == wrapped_function:</span>                    class_name = key
                    <span style="color: #ff7700;font-weight:bold;">break</span>
            <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: black;">&#40;</span><span style="color: #008000;">KeyError</span>, <span style="color: #008000;">AttributeError</span><span style="color: black;">&#41;</span>:
                <span style="color: #ff7700;font-weight:bold;">pass</span>
        msg = <span style="color: #483d8b;">&quot;Module={} Class={} Function={}&quot;</span>.<span style="color: black;">format</span><span style="color: black;">&#40;</span>
            module_name, class_name, func_name<span style="color: black;">&#41;</span>
        __logger.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;BEGIN &quot;</span> + msg<span style="color: black;">&#41;</span>
        data = func<span style="color: black;">&#40;</span><span style="color: #66cc66;">*</span>args, <span style="color: #66cc66;">**</span>kwargs<span style="color: black;">&#41;</span>
        __logger.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;END &quot;</span> + msg<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> data
&nbsp;
<span style="display:block;background-color: #ffc;">    wrapped_function = wrapped</span>    <span style="color: #ff7700;font-weight:bold;">return</span> wrapped</pre></div></div>

<p>Et maintenant le résultat :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">BEGIN Module=<span style="color: #dc143c;">__main__</span> Class=Specific Function=do_it
BEGIN Module=<span style="color: #dc143c;">__main__</span> Class=Generic Function=do_it
NOW
END Module=<span style="color: #dc143c;">__main__</span> Class=Generic Function=do_it
END Module=<span style="color: #dc143c;">__main__</span> Class=Specific Function=do_it</pre></div></div>

<p>Ouf ! Ca marche !</p>
<p>Au menu du prochain épisode : logger la valeur de certains paramètres passés à la fonction décorée.</p>
<p><em>Xavier O. avec l&#8217;aide précieuse de Laurent B.</em></p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=5670&amp;md5=ed725fc730fad3935f341c888770c289" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/decorateur-de-trace/feed/</wfw:commentRss>
		<slash:comments>14</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fdecorateur-de-trace%2F&amp;language=en_GB&amp;category=text&amp;title=D%C3%A9corateur+de+trace&amp;description=%28Ceci+est+un+post+invit%C3%A9+de+xonop+sous+licence+creative+common+3.0+unported.%29+Suite+aux+superbes+articles+sur+les+d%C3%A9corateurs+et+sur+l%26%238217%3B%C3%A9criture+des+logs+en+python+j%26%238217%3Bai+voulu+mettre...&amp;tags=decorateur%2Cinspect%2Cintrospection%2Clog%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/04/4Y6lBye.jpg" length="47403" type="image/jpg" />	</item>
		<item>
		<title>Rechercher dans l&#8217;historique de Git</title>
		<link>http://sametmax.com/rechercher-dans-lhistorique-de-git/</link>
		<comments>http://sametmax.com/rechercher-dans-lhistorique-de-git/#comments</comments>
		<pubDate>Wed, 17 Oct 2012 13:47:53 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[git]]></category>
		<category><![CDATA[log]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=545</guid>
		<description><![CDATA[Parce qu'avoir un historique ça ne sert à rien si on ne peut pas chercher dedans]]></description>
			<content:encoded><![CDATA[<p>Si vous voulez trouver tous les commits dont les messages contiennent une chaîne de caractères:</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">git</span> log <span style="color: #660033;">--grep</span>=<span style="color: #ff0000;">&quot;le truc a chercher&quot;</span></pre></div></div>

<p>Comme grep, on peut y adjoindre <code>-i</code> pour le rendre insensible à la casse, et <code>-E</code> pour utiliser des regex PCRE.</p>
<p>Si vous voulez trouver tous les commits dans lequel une chaîne a été retirée ou introduite dans un des fichiers:</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">git</span> log <span style="color: #660033;">-S</span><span style="color: #ff0000;">&quot;le truc a chercher&quot;</span></pre></div></div>

<p>Et dans ce cas vous voudrez probablement passer aussi <code>-p --color=auto</code> qui va vous permettre d&#8217;avoir un diff coloré et mis en contexte pour savoir ce qui a été modifié.</p>
<p>On peut limiter sa recherche dans le temps en utilisant <code>--before</code> et <code>--after</code>. Par exemple, pour chercher dans tous les commits créés après le 1er juillet et jusqu&#8217;à il y a 2 semaines:</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">git</span> log <span style="color: #660033;">--before</span>=<span style="color: #ff0000;">&quot;2 weeks ago&quot;</span> <span style="color: #660033;">--after</span>=<span style="color: #ff0000;">&quot;2012-07-01&quot;</span></pre></div></div>

<p>Ou alors choisir deux commits et chercher entre ces deux commits:</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">git</span> log 710f0f..8a5cbc</pre></div></div>

<p>Ce qui va limiter la recherche à la branche en cours. En parlant de branche, on peut voir les commits qui sont sur une branche et pas l&#8217;autre:</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">git</span> log master..develop</pre></div></div>

<p>Ici on aura tout ce qui est sur <code>develop</code> qui n&#8217;est pas encore mergé dans <code>master</code>. L&#8217;inverse est bien sur possible.</p>
<p>Parfois on a besoin de savoir <a href="http://sametmax.com/quel-est-labruti-qui-a-fait-ca/">qui est le connard qui a fait ça</a>, et on peut lister les commits d&#8217;un utilisateur:</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">git</span> log <span style="color: #660033;">--author</span> sam</pre></div></div>

<p>Ou</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">git</span> log <span style="color: #660033;">--author</span> lesametlemax<span style="color: #000000; font-weight: bold;">@</span>notremail.com</pre></div></div>

<p>En fait ça marche même avec une partie du nom.</p>
<p>Les critères ci-dessus peuvent être utilisés en même temps, et les résultats obtenus seront ceux correspondant à au moins un des critères (OU). Mais si vous voulez les commits qui correspondent à tous ces critères (ET), utilisez <code>--all-match</code>.</p>
<p>Tout ça cherche dans l&#8217;historique entier, mais si vous êtes plutôt intéressé par certains fichiers en particulier, vous pouvez préciser des paths après <code>--</code>.</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">git</span> log <span style="color: #660033;">--author</span> max <span style="color: #660033;">--before</span>=<span style="color: #ff0000;">&quot;1 day ago&quot;</span> <span style="color: #660033;">--</span> project<span style="color: #000000; font-weight: bold;">/</span>settings.py project<span style="color: #000000; font-weight: bold;">/</span>settings_local.py</pre></div></div>

<p>Et oui, ça marche récursivement sur les dossiers.</p>
<p>La plupart du temps les commits juste après les merges ne vous intéresse pas. On peut les ignorer avec <code>–-no-merges</code>.</p>
<p>Enfin si vous avez merdé et que vous pensez avoir perdu quelque chose dans Git, vous pouvez chercher dans le reflog avec <code>--walk-reflogs</code>. Cela vous donnera accès à tous les commits qui ne sont pas sur des branches ou plus accessibles facilement pour une raison ou une autre.</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=545&amp;md5=ddadc2c3d5ade46310dec93b1c719c70" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/rechercher-dans-lhistorique-de-git/feed/</wfw:commentRss>
		<slash:comments>2</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Frechercher-dans-lhistorique-de-git%2F&amp;language=en_GB&amp;category=text&amp;title=Rechercher+dans+l%26%238217%3Bhistorique+de+Git&amp;description=Si+vous+voulez+trouver+tous+les+commits+dont+les+messages+contiennent+une+cha%C3%AEne+de+caract%C3%A8res%3A+git+log+--grep%3D%26quot%3Ble+truc+a+chercher%26quot%3B+Comme+grep%2C+on+peut+y+adjoindre+-i+pour+le...&amp;tags=git%2Clog%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2012/10/history-art-histoire.jpg" length="83703" type="image/jpg" />	</item>
		<item>
		<title>Se loguer automatiquement sur Facebook avec Selenium, automation de tâches.</title>
		<link>http://sametmax.com/se-loguer-automatiquement-sur-facebook-avec-selenium-automation-de-taches/</link>
		<comments>http://sametmax.com/se-loguer-automatiquement-sur-facebook-avec-selenium-automation-de-taches/#comments</comments>
		<pubDate>Fri, 04 May 2012 14:59:28 +0000</pubDate>
		<dc:creator>Max</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[facebook]]></category>
		<category><![CDATA[ide]]></category>
		<category><![CDATA[log]]></category>
		<category><![CDATA[logguer]]></category>
		<category><![CDATA[selenium]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=527</guid>
		<description><![CDATA[Vous aimez Facebook n'est-ce pas ? Vous aimeriez automatiser certaines tâches, comme se loguer, acceptez les demandes d'ajouts d'amis automatiquement, etc...
Et bien c'est possible avec Selenium et c'est ce que l'on va voir.]]></description>
			<content:encoded><![CDATA[<p>Facebook, la conciergerie du monde où vous pouvez savoir à tous moments ce que font vos (pseudos) amis. C&#8217;est bien joli mais vous avez peut être plusieurs profils (le pro, le public, le fashion, le privé, le déjanté, le mytho) et vous aimeriez vous y logguer automatiquement et exécuter certaines tâches&#8230; Alors voici comment faire.<br />
Avant d&#8217;aller plus loin sachez qu&#8217;il vous faudra des connaissances en javascript, <a href="http://www.w3schools.com/xpath/default.asp">Xpath</a> et savoir installer une extension XPI pour Firefox.</p>
<p>Tout d&#8217;abord il faut posséder <a href="http://www.mozilla.org/fr/firefox/new/">Firefox</a>. Ensuite téléchargez l&#8217;extension <a href="http://seleniumhq.org/download/">Selenium IDE</a> (attention de bien choisir la version IDE, l&#8217;autre version étant réservée à un usage orienté serveur).</p>
<p>Une fois tout ça installé ouvrez votre Selenium en allant dans Outils > Selenium IDE. Une boite va apparaitre vous laissant entrer des commandes. En fait Selenium est un automatiseur de tâche, il va simuler vos actions sur le navigateur. L&#8217;astuce va donc consister à simuler l&#8217;identification de votre profil sur Facebook et de valider.</p>
<p>J&#8217;ai fais une copie d&#8217;écran pour vous donnez un aperçu de à quoi devra ressembler votre script.</p>
<p> <a href="http://sametmax.com/wp-content/uploads/2012/05/facebook_login1.png"><img src="http://sametmax.com/wp-content/uploads/2012/05/facebook_login1.png" alt="" title="facebook_login" width="550" class="alignnone wp-image-536" /></a></p>
<p>Voyons ces lignes de plus près:</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;">&nbsp;
<span style="color: #666666; font-style: italic;"># open ouvre une url</span>
open <span style="color: #000000; font-weight: bold;">|</span> http:<span style="color: #000000; font-weight: bold;">//</span>www.facebook.com 
&nbsp;
<span style="color: #666666; font-style: italic;"># waitForVisible va attrendre que l'élément soit afficher avant de continuer</span>
<span style="color: #666666; font-style: italic;"># ici on attend que le bouton Connexion soit affiché avant de remplir le formulaire (on utilise Xpath)</span>
waitForVisible <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #000000; font-weight: bold;">//</span>input<span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #000000; font-weight: bold;">@</span><span style="color: #007800;">value</span>=<span style="color: #ff0000;">'Connexion'</span><span style="color: #7a0874; font-weight: bold;">&#93;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># type simule l'entrée au clavier dans un champs (input, textarea, etc)</span>
<span style="color: #666666; font-style: italic;"># ici on sélectionne l'élément qui a l'ID pass (le champs mot de passe) et on lui entre la valeur mon_mot_de_passe_facebook</span>
<span style="color: #7a0874; font-weight: bold;">type</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #007800;">id</span>=pass <span style="color: #000000; font-weight: bold;">|</span> mon_mot_de_passe_facebook
&nbsp;
<span style="color: #666666; font-style: italic;"># type simule l'entrée au clavier dans un champs (input, textarea, etc)</span>
<span style="color: #666666; font-style: italic;"># ici on sélectionne l'élément qui a l'ID email (le champs email) et on lui entre la valeur mon_email_facebook</span>
<span style="color: #7a0874; font-weight: bold;">type</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #007800;">id</span>=email <span style="color: #000000; font-weight: bold;">|</span> mon_email_facebook
&nbsp;
<span style="color: #666666; font-style: italic;"># submit simule la soumission d'un formulaire</span>
<span style="color: #666666; font-style: italic;"># ici on sélectionne l'élément qui a l'ID login_form (le formulaire dans lequel on rentre ses identifiants Facebook) et on soumet le tout.</span>
submit <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #007800;">id</span>=login_form
&nbsp;
<span style="color: #666666; font-style: italic;"># waitForVisible va attrendre que l'élément soit afficher avant de continuer</span>
<span style="color: #666666; font-style: italic;"># ici on attend l'élément qui a l'ID navHome (le bouton accueil) soit affiché, preuve qu'on est bien logué.</span>
waitForVisible <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #000000; font-weight: bold;">//</span>li<span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #000000; font-weight: bold;">@</span><span style="color: #007800;">id</span>=<span style="color: #ff0000;">'navHome'</span><span style="color: #7a0874; font-weight: bold;">&#93;</span><span style="color: #000000; font-weight: bold;">/</span>a</pre></div></div>

<p>Vous pouvez télécharger le cas de test ici et l&#8217;importer dans votre Selenium: <a href="http://sametmax.com/wp-content/uploads/2012/05/selenium_log_to_facebook.html">Se loguer sur Facebook avec Selenium</a></p>
<p>Je n&#8217;irais pas plus loin mais sachez que vous pouvez tout faire ou presque avec Selenium en terme d&#8217;automation. Pour la connexion à plusieurs comptes facebook vous faites une boucle qui va se connecter aux différents comptes (n&#8217;oubliez pas de vous déconnecter) et faire les tâches que vous aurez définis. vous pouvez cliquez sur des likes, ajouter un status, etc. Je vous laisse chercher mais tout est là dans ces quelques lignes, faites marcher vos méninges ;)</p>
<p>Liens utiles:</p>
<p>Attention: Pour faire des boucles vous aurez besoin d&#8217;ajouter cette extension à Selenium: <a href="https://github.com/darrenderidder/sideflow">https://github.com/darrenderidder/sideflow</a></p>
<p><a href="http://seleniumhq.org/docs/">La doc Selenium</a></p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=527&amp;md5=1bd7a2abe142bcc5c69153ffba7ecfcb" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/se-loguer-automatiquement-sur-facebook-avec-selenium-automation-de-taches/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fse-loguer-automatiquement-sur-facebook-avec-selenium-automation-de-taches%2F&amp;language=en_GB&amp;category=text&amp;title=Se+loguer+automatiquement+sur+Facebook+avec+Selenium%2C+automation+de+t%C3%A2ches.&amp;description=Facebook%2C+la+conciergerie+du+monde+o%C3%B9+vous+pouvez+savoir+%C3%A0+tous+moments+ce+que+font+vos+%28pseudos%29+amis.+C%26%238217%3Best+bien+joli+mais+vous+avez+peut+%C3%AAtre+plusieurs+profils+%28le+pro%2C...&amp;tags=facebook%2Cide%2Clog%2Clogguer%2Cselenium%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2012/05/facebook-log-in-with-name.jpg" length="23830" type="image/jpg" />	</item>
		<item>
		<title>Log des requêtes SQL faites par l&#8217;ORM Django en temps réel</title>
		<link>http://sametmax.com/log-des-requetes-sql-faites-par-lorm-django-en-temps-reel/</link>
		<comments>http://sametmax.com/log-des-requetes-sql-faites-par-lorm-django-en-temps-reel/#comments</comments>
		<pubDate>Fri, 16 Mar 2012 17:30:01 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[log]]></category>
		<category><![CDATA[orm]]></category>
		<category><![CDATA[sql]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=262</guid>
		<description><![CDATA[Il existe une solution plus simple que  la <code>django-debug-toolbar</code> ou <code>connection.queries</code> pour suivre les requêtes SQL de l'ORM Django.]]></description>
			<content:encoded><![CDATA[<p>Même en recherchant sur les sites spécialisés en anglais, je tombe toujours sur des solutions basées sur la <a href="https://github.com/django-debug-toolbar/django-debug-toolbar">django-debug-toolbar</a>, l&#8217;affichage de <a href="https://docs.djangoproject.com/en/dev/faq/models/#how-can-i-see-the-raw-sql-queries-django-is-running">connection.queries</a> ou l&#8217;usage de <a href="https://github.com/dcramer/django-devserver">devserver</a>. Ça a son utilité (surtout la fabuleuse <code>django-debug-toolbar</code>), mais c&#8217;est compliqué, long à mettre en oeuvre, et pas très pratique. </p>
<p>Il a beaucoup plus simple, et le plus beau, c&#8217;est que Django le propose en natif.</p>
<p>Par default, Django loggue toutes les requêtes SQL dans <em>django.db.backends</em> si <code>DEBUG = True</code>. Il suffit donc de configurer le logger, dans votre <em>settings.py</em>:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">os</span>
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">tempfile</span>
&nbsp;
LOGGING = <span style="color: black;">&#123;</span>
    <span style="color: #483d8b;">'version'</span>: <span style="color: #ff4500;">1</span>,
    <span style="color: #483d8b;">'disable_existing_loggers'</span>: <span style="color: #008000;">False</span>,
    <span style="color: #483d8b;">'formatters'</span>: <span style="color: black;">&#123;</span>
        <span style="color: #483d8b;">'verbose'</span>: <span style="color: black;">&#123;</span>
            <span style="color: #483d8b;">'format'</span>: <span style="color: #483d8b;">'%(levelname)s %(asctime)s %(module)s %(process)d %(thread)d %(message)s'</span>
        <span style="color: black;">&#125;</span>,
        <span style="color: #483d8b;">'simple'</span>: <span style="color: black;">&#123;</span>
            <span style="color: #483d8b;">'format'</span>: <span style="color: #483d8b;">'%(levelname)s %(message)s'</span>
        <span style="color: black;">&#125;</span>,
    <span style="color: black;">&#125;</span>,
    <span style="color: #483d8b;">'handlers'</span>: <span style="color: black;">&#123;</span>
        <span style="color: #483d8b;">'tempfile'</span>: <span style="color: black;">&#123;</span>
            <span style="color: #483d8b;">'level'</span>: <span style="color: #483d8b;">'DEBUG'</span>,
            <span style="color: #483d8b;">'class'</span>: <span style="color: #483d8b;">'logging.handlers.RotatingFileHandler'</span>,
            <span style="color: #483d8b;">'formatter'</span>: <span style="color: #483d8b;">'verbose'</span>,
            <span style="color: #483d8b;">'filename'</span>: <span style="color: #dc143c;">os</span>.<span style="color: black;">path</span>.<span style="color: black;">join</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">tempfile</span>.<span style="color: black;">gettempdir</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>, <span style="color: #483d8b;">'django-debug.log'</span><span style="color: black;">&#41;</span>,
        <span style="color: black;">&#125;</span>,
        <span style="color: #483d8b;">'console'</span>:<span style="color: black;">&#123;</span>
            <span style="color: #483d8b;">'level'</span>:<span style="color: #483d8b;">'DEBUG'</span>,
            <span style="color: #483d8b;">'class'</span>:<span style="color: #483d8b;">'logging.StreamHandler'</span>,
            <span style="color: #483d8b;">'formatter'</span>: <span style="color: #483d8b;">'simple'</span>
        <span style="color: black;">&#125;</span>,
    <span style="color: black;">&#125;</span>,
    <span style="color: #483d8b;">'loggers'</span>: <span style="color: black;">&#123;</span>
        <span style="color: #483d8b;">'django.db.backends'</span>: <span style="color: black;">&#123;</span>
            <span style="color: #483d8b;">'handlers'</span>: <span style="color: black;">&#91;</span><span style="color: #483d8b;">'console'</span>, <span style="color: #483d8b;">'tempfile'</span><span style="color: black;">&#93;</span>,
            <span style="color: #483d8b;">'level'</span>: <span style="color: #483d8b;">'DEBUG'</span>,
            <span style="color: #483d8b;">'propagate'</span>: <span style="color: #008000;">True</span>,
        <span style="color: black;">&#125;</span>,
    <span style="color: black;">&#125;</span>,
<span style="color: black;">&#125;</span></pre></div></div>

<p>Lancez <code>./manage.py shell</code>:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">In <span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span><span style="color: black;">&#93;</span>: m = Table.<span style="color: black;">objects</span>.<span style="color: #008000;">filter</span><span style="color: black;">&#40;</span>title__isnull=<span style="color: #008000;">False</span><span style="color: black;">&#41;</span>
&nbsp;
In <span style="color: black;">&#91;</span><span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span>: m
DEBUG <span style="color: black;">&#40;</span><span style="color: #ff4500;">0.018</span><span style="color: black;">&#41;</span> SELECT <span style="color: #483d8b;">&quot;table&quot;</span>.<span style="color: #483d8b;">&quot;id&quot;</span>, <span style="color: #483d8b;">&quot;table&quot;</span>.<span style="color: #483d8b;">&quot;title&quot;</span>, <span style="color: #483d8b;">&quot;table&quot;</span>.<span style="color: #483d8b;">&quot;original_title&quot;</span> FROM <span style="color: #483d8b;">&quot;table&quot;</span> WHERE <span style="color: #483d8b;">&quot;table&quot;</span>.<span style="color: #483d8b;">&quot;title&quot;</span> IS NOT NULL LIMIT <span style="color: #ff4500;">21</span><span style="color: #66cc66;">;</span> args=<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
Out<span style="color: black;">&#91;</span><span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span>: <span style="color: black;">&#91;</span><span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #483d8b;">'...(remaining elements truncated)...'</span><span style="color: black;">&#93;</span></pre></div></div>

<p>Une version plus verbeuse sera aussi logguée dans un fichier temporaire. Par exemple, sous linux il sera dans <code>/tmp/django-debug.log</code>.</p>
<p>Toutes les requêtes faites par le site Web seront également affichées dans le terminal sur lequel tourne le serveur, et dans le fichier temporaire. </p>
<p>Une fois que vous maitrisez le concept, je vous recommande plutot de mettre le logger <em>django.db.backends</em> dans votre <em>local_settings.py</em>, histoire d&#8217;éviter de l&#8217;avoir en prod:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">LOGGING<span style="color: black;">&#91;</span><span style="color: #483d8b;">'loggers'</span><span style="color: black;">&#93;</span>.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#123;</span>
        <span style="color: #483d8b;">'django.db.backends'</span>: <span style="color: black;">&#123;</span>
            <span style="color: #483d8b;">'handlers'</span>: <span style="color: black;">&#91;</span><span style="color: #483d8b;">'console'</span>, <span style="color: #483d8b;">'tempfile'</span><span style="color: black;">&#93;</span>,
            <span style="color: #483d8b;">'level'</span>: <span style="color: #483d8b;">'DEBUG'</span>,
            <span style="color: #483d8b;">'propagate'</span>: <span style="color: #008000;">True</span>,
        <span style="color: black;">&#125;</span>,
    <span style="color: black;">&#125;</span>
<span style="color: black;">&#41;</span></pre></div></div>

<p>Autre bénéfice, il suffit de commenter cette partie quand ne souhaite plus afficher autant d&#8217;information.</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=262&amp;md5=c35b72c694c7c068607463c4d98e647c" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/log-des-requetes-sql-faites-par-lorm-django-en-temps-reel/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Flog-des-requetes-sql-faites-par-lorm-django-en-temps-reel%2F&amp;language=en_GB&amp;category=text&amp;title=Log+des+requ%C3%AAtes+SQL+faites+par+l%26%238217%3BORM+Django+en+temps+r%C3%A9el&amp;description=M%C3%AAme+en+recherchant+sur+les+sites+sp%C3%A9cialis%C3%A9s+en+anglais%2C+je+tombe+toujours+sur+des+solutions+bas%C3%A9es+sur+la+django-debug-toolbar%2C+l%26%238217%3Baffichage+de%C2%A0connection.queries+ou+l%26%238217%3Busage+de+devserver.+%C3%87a+a+son+utilit%C3%A9+%28surtout%C2%A0la...&amp;tags=django%2Clog%2Corm%2Csql%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2012/03/lumber_from_log_lg.jpg" length="460459" type="image/jpg" />	</item>
	</channel>
</rss>
