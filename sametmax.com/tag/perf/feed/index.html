<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Sam &#38; Max: Python, Django, Git et du cul &#187; perf</title>
	<atom:link href="http://sametmax.com/tag/perf/feed/" rel="self" type="application/rss+xml" />
	<link>http://sametmax.com</link>
	<description>Deux développeurs en vadrouille qui se sortent les doigts du code</description>
	<lastBuildDate>Wed, 05 Feb 2014 14:20:37 +0000</lastBuildDate>
	<language>en</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>http://wordpress.org/?v=3.3.1</generator>
	<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2F&amp;language=en_US&amp;category=text&amp;title=Sam+%26amp%3B+Max%3A+Python%2C+Django%2C+Git+et+du+cul&amp;description=Deux+d%C3%A9veloppeurs+en+vadrouille+qui+se+sortent+les+doigts+du+code&amp;tags=blog" type="text/html" />
		<item>
		<title>Est-ce que &#8220;framework x&#8221; supporte la charge ?</title>
		<link>http://sametmax.com/est-ce-que-framework-x-supporte-la-charge/</link>
		<comments>http://sametmax.com/est-ce-que-framework-x-supporte-la-charge/#comments</comments>
		<pubDate>Tue, 24 Dec 2013 21:08:05 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[framework]]></category>
		<category><![CDATA[perf]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=7754</guid>
		<description><![CDATA[Wait for it...]]></description>
			<content:encoded><![CDATA[<p style="text-align:center;">Oui.</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=7754&amp;md5=949a226976eaf65888716789d2de8a17" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/est-ce-que-framework-x-supporte-la-charge/feed/</wfw:commentRss>
		<slash:comments>16</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fest-ce-que-framework-x-supporte-la-charge%2F&amp;language=en_GB&amp;category=text&amp;title=Est-ce+que+%26%238220%3Bframework+x%26%238221%3B+supporte+la+charge+%3F&amp;description=Oui.&amp;tags=framework%2Cperf%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/12/tumblr_myb66fg4XQ1r539hzo1_500.jpg" length="71544" type="image/jpg" />	</item>
		<item>
		<title>Ceci n&#8217;est pas un benchmark&#8230;</title>
		<link>http://sametmax.com/ceci-nest-pas-un-benchmark/</link>
		<comments>http://sametmax.com/ceci-nest-pas-un-benchmark/#comments</comments>
		<pubDate>Thu, 11 Jul 2013 06:08:02 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[perf]]></category>
		<category><![CDATA[pypy]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=6620</guid>
		<description><![CDATA[Et dire qu'au début pypy était très lent...]]></description>
			<content:encoded><![CDATA[<p>&#8230; mais quand même. Il va falloir sérieusement étudier le passage de nos sites à pypy.</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;">$ pypy <span style="color: #660033;">--version</span>
Python 2.7.2 <span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #000000;">1.8</span>+dfsg-<span style="color: #000000;">2</span>, Feb <span style="color: #000000;">19</span> <span style="color: #000000;">2012</span>, <span style="color: #000000;">19</span>:<span style="color: #000000;">18</span>:08<span style="color: #7a0874; font-weight: bold;">&#41;</span>
<span style="color: #7a0874; font-weight: bold;">&#91;</span>PyPy 1.8.0 with GCC 4.6.2<span style="color: #7a0874; font-weight: bold;">&#93;</span>
&nbsp;
$ <span style="color: #c20cb9; font-weight: bold;">date</span>; pypy <span style="color: #660033;">-c</span> <span style="color: #ff0000;">&quot;for x in xrange(1000000000): pass&quot;</span>; <span style="color: #c20cb9; font-weight: bold;">date</span>
mardi <span style="color: #000000;">9</span> juillet <span style="color: #000000;">2013</span>, <span style="color: #000000;">12</span>:<span style="color: #000000;">30</span>:<span style="color: #000000;">58</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>UTC+0200<span style="color: #7a0874; font-weight: bold;">&#41;</span>
mardi <span style="color: #000000;">9</span> juillet <span style="color: #000000;">2013</span>, <span style="color: #000000;">12</span>:<span style="color: #000000;">31</span>:09 <span style="color: #7a0874; font-weight: bold;">&#40;</span>UTC+0200<span style="color: #7a0874; font-weight: bold;">&#41;</span>
&nbsp;
$ python <span style="color: #660033;">--version</span>
Python 2.7.3
&nbsp;
$ <span style="color: #c20cb9; font-weight: bold;">date</span>; python <span style="color: #660033;">-c</span> <span style="color: #ff0000;">&quot;for x in xrange(1000000000): pass&quot;</span>; <span style="color: #c20cb9; font-weight: bold;">date</span>
mardi <span style="color: #000000;">9</span> juillet <span style="color: #000000;">2013</span>, <span style="color: #000000;">12</span>:<span style="color: #000000;">31</span>:<span style="color: #000000;">16</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>UTC+0200<span style="color: #7a0874; font-weight: bold;">&#41;</span>
mardi <span style="color: #000000;">9</span> juillet <span style="color: #000000;">2013</span>, <span style="color: #000000;">12</span>:<span style="color: #000000;">32</span>:<span style="color: #000000;">49</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>UTC+0200<span style="color: #7a0874; font-weight: bold;">&#41;</span></pre></div></div>

 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=6620&amp;md5=9dc36dfc08c48d62f56763aba82325eb" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/ceci-nest-pas-un-benchmark/feed/</wfw:commentRss>
		<slash:comments>9</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fceci-nest-pas-un-benchmark%2F&amp;language=en_GB&amp;category=text&amp;title=Ceci+n%26%238217%3Best+pas+un+benchmark%26%238230%3B&amp;description=%26%238230%3B+mais+quand+m%C3%AAme.+Il+va+falloir+s%C3%A9rieusement+%C3%A9tudier+le+passage+de+nos+sites+%C3%A0+pypy.+%24+pypy+--version+Python+2.7.2+%26%2340%3B1.8%2Bdfsg-2%2C+Feb+19+2012%2C+19%3A18%3A08%26%2341%3B+%26%2391%3BPyPy+1.8.0+with+GCC...&amp;tags=perf%2Cpypy%2Cpython%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/07/PyZlRmH.jpg" length="185408" type="image/jpg" />	</item>
		<item>
		<title>Mesurer les performances d&#8217;un snippet Python</title>
		<link>http://sametmax.com/mesurer-les-performances-dun-snippet-python/</link>
		<comments>http://sametmax.com/mesurer-les-performances-dun-snippet-python/#comments</comments>
		<pubDate>Sat, 08 Jun 2013 20:20:52 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[dict]]></category>
		<category><![CDATA[merge]]></category>
		<category><![CDATA[perf]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=6369</guid>
		<description><![CDATA[L'open source c'est fantastique. Github c'est merveilleux. On parle de <a href="http://sametmax.com/batbelt-la-lib-des-petits-outils-python-qui-vont-bien/">batbelt</a>, et paf, quelques jours plus tard on a notre <a href="https://github.com/sametmax/Bat-belt/pull/1">première contribution</a>.]]></description>
			<content:encoded><![CDATA[<p>Ca fait longtemps que j&#8217;avais pas musique.</p>

<!-- iframe plugin v:2.3 - wordpress.org/extend/plugins/iframe/ -->
<iframe width="420" height="315" src="http://www.youtube.com/embed/qeMFqkcPYcg" frameborder="0" scrolling="no" class="iframe-class"></iframe>
<p>L&#8217;open source c&#8217;est fantastique. Github c&#8217;est merveilleux. On parle de <a href="http://sametmax.com/batbelt-la-lib-des-petits-outils-python-qui-vont-bien/">batbelt</a>, et paf, quelques jours plus tard on a notre <a href="https://github.com/sametmax/Bat-belt/pull/1">première contribution</a>.</p>
<p>Ce qui est sympa avec cette lib, c&#8217;est que ce sont des fonctions simples et courtes, axées sur des tâches très précises. Le code est donc généralement <a href="https://github.com/sametmax/Bat-belt/blob/master/batbelt/structs.py">intéressant à lire</a>, mais pas trop compliqué, et on tombe souvent sur des cas d&#8217;école.</p>
<p>C&#8217;est le cas de cette modification de la fonction <code>dmerge()</code>. Originalement, <code>dmerge</code> permet de créer un dictionnaire à partir de la fusion de de 2 autres dicos, et ça marchait comme ça:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> dmerge<span style="color: black;">&#40;</span>d1, d2<span style="color: black;">&#41;</span>:
    d = <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span>
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d1<span style="color: black;">&#41;</span>
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d2<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> d</pre></div></div>

<p>Facile à comprendre, rapide, simple, et le comportement par défaut est intuitif : si une clé est en double, la clé du deuxième dico écrase la première.</p>
<p>Comme le <a href="http://sametmax.com/batbelt-la-lib-des-petits-outils-python-qui-vont-bien/#comment-9657">précisait Etienne,</a> ce comportement est néanmoins un parmi de nombreux possibles. On pourrait aussi vouloir:</p>
<ul>
<li>Lever une exception en cas de doublon.</li>
<li>Concaténer ou additionner les doublons.</li>
<li>Mettre les doublons dans une liste.</li>
<li>Garder la valeur originale en cas de doublon.</li>
<li>Prendre la valeur la plus grande / petite en cas de doublon.</li>
<li>Etc.</li>
</ul>
<p>Pour cela, notre contributeur a proposé qu&#8217;on puisse passer en paramètre une fonction qui choisit quelle valeur garder en cas de doublon. Le code devient donc :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> dmerge<span style="color: black;">&#40;</span>d1, d2, merge_func=<span style="color: #ff7700;font-weight:bold;">lambda</span> v1, v2: v2<span style="color: black;">&#41;</span>:
    d = <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span>
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#40;</span>k, v<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k, v <span style="color: #ff7700;font-weight:bold;">in</span> d1.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> d2<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#40;</span>k, v<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k, v <span style="color: #ff7700;font-weight:bold;">in</span> d2.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> d1<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#40;</span>k, merge_func<span style="color: black;">&#40;</span>v, d2<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k, v <span style="color: #ff7700;font-weight:bold;">in</span> d1.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">in</span> d2<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> d</pre></div></div>

<p>Avoir une valeur par défaut nous permet de garder le comportement initial. Pour cela on utilise une <a href="http://sametmax.com/fonctions-anonymes-en-python-ou-lambda/">lambda</a>. C&#8217;est ce qu&#8217;on appelle l&#8217;injection de dépendance.</p>
<p>Comme j&#8217;ai bien faire mumuse avec Python, je me suis demandé : &#8220;quelle est la stratégie de merge la plus rapide ?&#8221;. J&#8217;ai donc fait plusieurs tests de merge, avec plusieurs algos. Voici ce que ça donne:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"> <span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">itertools</span> <span style="color: #ff7700;font-weight:bold;">import</span> chain
&nbsp;
&nbsp;
 <span style="color: #ff7700;font-weight:bold;">def</span> dmerge1<span style="color: black;">&#40;</span>d1, d2, merge_func=<span style="color: #008000;">None</span><span style="color: black;">&#41;</span>:
     <span style="color: #483d8b;">&quot;&quot;&quot;
         Mon premier essai, en virant la lambda et en utilisant itertools.
     &quot;&quot;&quot;</span>
     d = <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">if</span> merge_func <span style="color: #ff7700;font-weight:bold;">is</span> <span style="color: #008000;">None</span>:
&nbsp;
         d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d1<span style="color: black;">&#41;</span>
         d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d2<span style="color: black;">&#41;</span>
         <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">for</span> k, v <span style="color: #ff7700;font-weight:bold;">in</span> chain<span style="color: black;">&#40;</span>d1.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>, d2.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>:
         <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">in</span> d1 <span style="color: #ff7700;font-weight:bold;">and</span> k <span style="color: #ff7700;font-weight:bold;">in</span> d2:
             d<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span> = merge_func<span style="color: black;">&#40;</span>d1<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span>, d2<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
         <span style="color: #ff7700;font-weight:bold;">else</span>:
             d<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span> = v
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
&nbsp;
&nbsp;
 <span style="color: #ff7700;font-weight:bold;">def</span> dmerge2<span style="color: black;">&#40;</span>d1, d2, merge_func=<span style="color: #ff7700;font-weight:bold;">lambda</span> v1, v2: v2<span style="color: black;">&#41;</span>:
     <span style="color: #483d8b;">&quot;&quot;&quot;
         Le code du PR original
     &quot;&quot;&quot;</span>
     d = <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span>
     d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#40;</span>k, v<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k, v <span style="color: #ff7700;font-weight:bold;">in</span> d1.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> d2<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
     d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#40;</span>k, v<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k, v <span style="color: #ff7700;font-weight:bold;">in</span> d2.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> d1<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
     d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#40;</span>k, merge_func<span style="color: black;">&#40;</span>v, d2<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k, v <span style="color: #ff7700;font-weight:bold;">in</span> d1.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">in</span> d2<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
&nbsp;
 <span style="color: #ff7700;font-weight:bold;">def</span> dmerge3<span style="color: black;">&#40;</span>d1, d2, merge_func=<span style="color: #008000;">None</span><span style="color: black;">&#41;</span>:
     <span style="color: #483d8b;">&quot;&quot;&quot;
        Un mélange du code original et de mon premier essai.
     &quot;&quot;&quot;</span>
     d = <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span>
&nbsp;
     d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d1<span style="color: black;">&#41;</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">if</span> merge_func <span style="color: #ff7700;font-weight:bold;">is</span> <span style="color: #008000;">None</span>:
         d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d2<span style="color: black;">&#41;</span>
         <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">for</span> k, v <span style="color: #ff7700;font-weight:bold;">in</span> d2.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
         <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">in</span> d:
             d<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span> = merge_func<span style="color: black;">&#40;</span>d<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span>, v<span style="color: black;">&#41;</span>
         <span style="color: #ff7700;font-weight:bold;">else</span>:
             d<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span> = v
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
&nbsp;
&nbsp;
 <span style="color: #ff7700;font-weight:bold;">def</span> dmerge4<span style="color: black;">&#40;</span>d1, d2, merge_func=<span style="color: #008000;">None</span><span style="color: black;">&#41;</span>:
     <span style="color: #483d8b;">&quot;&quot;&quot;
         Le code original, en virant la lambda
     &quot;&quot;&quot;</span>
     d = <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">if</span> merge_func <span style="color: #ff7700;font-weight:bold;">is</span> <span style="color: #008000;">None</span>:
         d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d1<span style="color: black;">&#41;</span>
         d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d2<span style="color: black;">&#41;</span>
         <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
     d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#40;</span>k, v<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k, v <span style="color: #ff7700;font-weight:bold;">in</span> d1.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> d2<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
     d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#40;</span>k, v<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k, v <span style="color: #ff7700;font-weight:bold;">in</span> d2.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> d1<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
     d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#40;</span>k, merge_func<span style="color: black;">&#40;</span>v, d2<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k, v <span style="color: #ff7700;font-weight:bold;">in</span> d1.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">in</span> d2<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
&nbsp;
 <span style="color: #ff7700;font-weight:bold;">if</span> __name__ == <span style="color: #483d8b;">&quot;__main__&quot;</span>:
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">random</span>
     <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">timeit</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'Generate test dicts'</span><span style="color: black;">&#41;</span>
&nbsp;
     <span style="color: #808080; font-style: italic;"># pour que le test soit juste, il faut créer plusieurs types de dicos:</span>
     <span style="color: #808080; font-style: italic;"># des longs, et des courts avec plein de collisions ou moins</span>
     d1 = <span style="color: black;">&#123;</span><span style="color: #dc143c;">random</span>.<span style="color: black;">randint</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">0</span>, <span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>: <span style="color: #483d8b;">'d1'</span> <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">xrange</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">10000</span><span style="color: black;">&#41;</span><span style="color: black;">&#125;</span>
     d2 = <span style="color: black;">&#123;</span><span style="color: #dc143c;">random</span>.<span style="color: black;">randint</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">0</span>, <span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>: <span style="color: #483d8b;">'d2'</span> <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">xrange</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">10000</span><span style="color: black;">&#41;</span><span style="color: black;">&#125;</span>
     d3 = <span style="color: black;">&#123;</span><span style="color: #dc143c;">random</span>.<span style="color: black;">randint</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">0</span>, <span style="color: #ff4500;">10000000</span><span style="color: black;">&#41;</span>: <span style="color: #483d8b;">'d1'</span> <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">xrange</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">1000000</span><span style="color: black;">&#41;</span><span style="color: black;">&#125;</span>
     d4 = <span style="color: black;">&#123;</span><span style="color: #dc143c;">random</span>.<span style="color: black;">randint</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">0</span>, <span style="color: #ff4500;">10000000</span><span style="color: black;">&#41;</span>: <span style="color: #483d8b;">'d2'</span> <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">xrange</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">1000000</span><span style="color: black;">&#41;</span><span style="color: black;">&#125;</span>
&nbsp;
     merge_to_list = <span style="color: #ff7700;font-weight:bold;">lambda</span> a, b: <span style="color: black;">&#91;</span>a, b<span style="color: black;">&#93;</span>
&nbsp;
     <span style="color: #808080; font-style: italic;"># ensuite il faut s'assurer que toutes ces fonctions retournent bien</span>
     <span style="color: #808080; font-style: italic;"># la même chose</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Testing returns value all match&quot;</span><span style="color: black;">&#41;</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">assert</span> <span style="color: black;">&#40;</span>dmerge1<span style="color: black;">&#40;</span>d1, d2<span style="color: black;">&#41;</span> == dmerge2<span style="color: black;">&#40;</span>d1, d2<span style="color: black;">&#41;</span>
             == dmerge3<span style="color: black;">&#40;</span>d1, d2<span style="color: black;">&#41;</span> == dmerge4<span style="color: black;">&#40;</span>d1, d2<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">assert</span> <span style="color: black;">&#40;</span>dmerge1<span style="color: black;">&#40;</span>d1, d2, merge_to_list<span style="color: black;">&#41;</span> == dmerge2<span style="color: black;">&#40;</span>d1, d2, merge_to_list<span style="color: black;">&#41;</span>
            == dmerge3<span style="color: black;">&#40;</span>d1, d2, merge_to_list<span style="color: black;">&#41;</span> == dmerge4<span style="color: black;">&#40;</span>d1, d2, merge_to_list<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">assert</span> <span style="color: black;">&#40;</span>dmerge1<span style="color: black;">&#40;</span>d3, d4<span style="color: black;">&#41;</span> == dmerge2<span style="color: black;">&#40;</span>d3, d4<span style="color: black;">&#41;</span>
             == dmerge3<span style="color: black;">&#40;</span>d3, d4<span style="color: black;">&#41;</span> == dmerge4<span style="color: black;">&#40;</span>d3, d4<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">assert</span> <span style="color: black;">&#40;</span>dmerge1<span style="color: black;">&#40;</span>d3, d4, merge_to_list<span style="color: black;">&#41;</span> == dmerge2<span style="color: black;">&#40;</span>d3, d4, merge_to_list<span style="color: black;">&#41;</span>
             == dmerge3<span style="color: black;">&#40;</span>d3, d4, merge_to_list<span style="color: black;">&#41;</span> == dmerge4<span style="color: black;">&#40;</span>d3, d4, merge_to_list<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">assert</span> <span style="color: black;">&#40;</span>dmerge1<span style="color: black;">&#40;</span>d1, d4<span style="color: black;">&#41;</span> == dmerge2<span style="color: black;">&#40;</span>d1, d4<span style="color: black;">&#41;</span>
             == dmerge3<span style="color: black;">&#40;</span>d1, d4<span style="color: black;">&#41;</span> == dmerge4<span style="color: black;">&#40;</span>d1, d4<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">assert</span> <span style="color: black;">&#40;</span>dmerge1<span style="color: black;">&#40;</span>d1, d4, merge_to_list<span style="color: black;">&#41;</span> == dmerge2<span style="color: black;">&#40;</span>d1, d4, merge_to_list<span style="color: black;">&#41;</span>
             == dmerge3<span style="color: black;">&#40;</span>d1, d4, merge_to_list<span style="color: black;">&#41;</span> == dmerge4<span style="color: black;">&#40;</span>d1, d4, merge_to_list<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
&nbsp;
     <span style="color: #808080; font-style: italic;"># enfin on lance l'évaluation du temps d'éxécution avec timeit()</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Start timing&quot;</span><span style="color: black;">&#41;</span>
&nbsp;
&nbsp;
     <span style="color: #808080; font-style: italic;"># ce code est exécuté une fois par appel de timeit</span>
     <span style="color: #808080; font-style: italic;"># notez l'astuce 'from __main__ import x' qui importe du code</span>
     <span style="color: #808080; font-style: italic;"># du fichier en cours, ce qui sert rarement</span>
     setup = <span style="color: #483d8b;">''</span><span style="color: #483d8b;">'from __main__ import (dmerge1, dmerge2, dmerge3, dmerge4,
                                      d1, d2, d3, d4, merge_to_list)'</span><span style="color: #483d8b;">''</span>
&nbsp;
&nbsp;
&nbsp;
     <span style="color: #808080; font-style: italic;"># ensuite on fait des appels à timeit : </span>
     <span style="color: #808080; font-style: italic;"># - le premier paramètre est le code à mesurer: il faut qu'il </span>
     <span style="color: #808080; font-style: italic;">#   soit le plus simple et court possible</span>
     <span style="color: #808080; font-style: italic;"># - le second et le code d'initialisation avant le test (hors mesure)</span>
     <span style="color: #808080; font-style: italic;"># - le 3e est le nombre de fois que le code va être appelé. </span>
&nbsp;
&nbsp;
     <span style="color: #808080; font-style: italic;"># on va tester chaque fonction pour chaque type de dico, une fois</span>
     <span style="color: #808080; font-style: italic;"># avec l'approche par défaut, et une fois avec une fonction de merge</span>
     <span style="color: #808080; font-style: italic;"># personnalisée</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Lots of collisions&quot;</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Default merge strategy&quot;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;1&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge1(d1, d2)&quot;</span>, setup=setup, number=<span style="color: #ff4500;">1000000</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;2&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge2(d1, d2)&quot;</span>, setup=setup, number=<span style="color: #ff4500;">1000000</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;3&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge3(d1, d2)&quot;</span>, setup=setup, number=<span style="color: #ff4500;">1000000</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;4&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge4(d1, d2)&quot;</span>, setup=setup, number=<span style="color: #ff4500;">1000000</span><span style="color: black;">&#41;</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Custom merge strategy&quot;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;1&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge1(d1, d2, merge_to_list)&quot;</span>,
                               setup=setup, number=<span style="color: #ff4500;">100000</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;2&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge2(d1, d2, merge_to_list)&quot;</span>,
                               setup=setup, number=<span style="color: #ff4500;">100000</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;3&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge3(d1, d2, merge_to_list)&quot;</span>,
                               setup=setup, number=<span style="color: #ff4500;">100000</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;4&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge4(d1, d2, merge_to_list)&quot;</span>,
                               setup=setup, number=<span style="color: #ff4500;">100000</span><span style="color: black;">&#41;</span>
&nbsp;
&nbsp;
    <span style="color: #808080; font-style: italic;"># le nombre de répétitions est bien plus faible ici car sinon le test</span>
    <span style="color: #808080; font-style: italic;"># est très très long</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Long dictionaries&quot;</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Default merge strategy&quot;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;1&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge1(d3, d4)&quot;</span>, setup=setup, number=<span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;2&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge2(d3, d4)&quot;</span>, setup=setup, number=<span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;3&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge3(d3, d4)&quot;</span>, setup=setup, number=<span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;4&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge4(d3, d4)&quot;</span>, setup=setup, number=<span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Custom merge strategy&quot;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;1&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge1(d3, d4, merge_to_list)&quot;</span>,
                               setup=setup, number=<span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;2&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge2(d3, d4, merge_to_list)&quot;</span>,
                               setup=setup, number=<span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;3&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge3(d3, d4, merge_to_list)&quot;</span>,
                               setup=setup, number=<span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;4&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge4(d3, d4, merge_to_list)&quot;</span>,
                               setup=setup, number=<span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Mixed dictionaries&quot;</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Default merge strategy&quot;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;1&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge1(d1, d4)&quot;</span>, setup=setup, number=<span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;2&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge2(d1, d4)&quot;</span>, setup=setup, number=<span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;3&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge3(d1, d4)&quot;</span>, setup=setup, number=<span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;4&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge4(d1, d4)&quot;</span>, setup=setup, number=<span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Custom merge strategy&quot;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;1&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge1(d1, d4, merge_to_list)&quot;</span>,
                              setup=setup, number=<span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;2&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge2(d1, d4, merge_to_list)&quot;</span>,
                              setup=setup, number=<span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;3&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge3(d1, d4, merge_to_list)&quot;</span>,
                              setup=setup, number=<span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;4&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge4(d1, d4, merge_to_list)&quot;</span>,
                              setup=setup, number=<span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
&nbsp;
&nbsp;
<span style="color: #808080; font-style: italic;"># Et voici le résultat que ça nous ressort. On voit clairement </span>
<span style="color: #808080; font-style: italic;"># que la 3eme fonction donne les meilleurs perfs, du coup</span>
<span style="color: #808080; font-style: italic;"># c'est celle qu'on a choisit</span>
&nbsp;
 <span style="color: #808080; font-style: italic;">## Generate test dicts</span>
 <span style="color: #808080; font-style: italic;">## Testing returns value all match</span>
 <span style="color: #808080; font-style: italic;">## Start timing</span>
 <span style="color: #808080; font-style: italic;">## Lots of collisions</span>
 <span style="color: #808080; font-style: italic;">## Default merge strategy</span>
 <span style="color: #808080; font-style: italic;">## 1 19.9299340248</span>
 <span style="color: #808080; font-style: italic;">## 2 148.185166121</span>
 <span style="color: #808080; font-style: italic;">## 3 21.2276539803</span>
 <span style="color: #808080; font-style: italic;">## 4 21.2074358463</span>
 <span style="color: #808080; font-style: italic;">## Custom merge strategy</span>
 <span style="color: #808080; font-style: italic;">## 1 30.646312952</span>
 <span style="color: #808080; font-style: italic;">## 2 18.522135973</span>
 <span style="color: #808080; font-style: italic;">## 3 14.0125968456</span>
 <span style="color: #808080; font-style: italic;">## 4 18.5139119625</span>
 <span style="color: #808080; font-style: italic;">## Long dictionaries</span>
 <span style="color: #808080; font-style: italic;">## Default merge strategy</span>
 <span style="color: #808080; font-style: italic;">## 1 84.4819910526</span>
 <span style="color: #808080; font-style: italic;">## 2 383.444111109</span>
 <span style="color: #808080; font-style: italic;">## 3 80.7273669243</span>
 <span style="color: #808080; font-style: italic;">## 4 86.0287930965</span>
 <span style="color: #808080; font-style: italic;">## Custom merge strategy</span>
 <span style="color: #808080; font-style: italic;">## 1 294.41114521</span>
 <span style="color: #808080; font-style: italic;">## 2 377.38009119</span>
 <span style="color: #808080; font-style: italic;">## 3 154.505481005</span>
 <span style="color: #808080; font-style: italic;">## 4 256.771039963</span>
 <span style="color: #808080; font-style: italic;">## Mixed dictionaries</span>
 <span style="color: #808080; font-style: italic;">## Default merge strategy</span>
 <span style="color: #808080; font-style: italic;">## 1 19.9574320316</span>
 <span style="color: #808080; font-style: italic;">## 2 87.1410660744</span>
 <span style="color: #808080; font-style: italic;">## 3 19.3570361137</span>
 <span style="color: #808080; font-style: italic;">## 4 19.524998188</span>
 <span style="color: #808080; font-style: italic;">## Custom merge strategy</span>
 <span style="color: #808080; font-style: italic;">## 1 60.6157000065</span>
 <span style="color: #808080; font-style: italic;">## 2 86.3876900673</span>
 <span style="color: #808080; font-style: italic;">## 3 59.0331327915</span>
 <span style="color: #808080; font-style: italic;">## 4 87.0504939556</span>
 <span style="color: #808080; font-style: italic;">## [Finished in 2494.7s]</span></pre></div></div>

<p> Le test complet a pris en tout 2494.7s, soit 41 minutes, pour tourner sur ma machine, et je l&#8217;ai lancé plusieurs fois avec différentes modifs au fil de la journée. Il faut vraiment est un geek pour aimer faire ce genre de connerie. Parce que soyons honnête, tout le monde s&#8217;en branle des perfs de cette fonction :-)</p>
<p> Il faut savoir aussi qu&#8217;après coup j&#8217;ai réalisé que son code utilisait des listes en intention, et non des <a href="http://sametmax.com/python-love-les-listes-en-intention-partie-2/">expressions génératrices</a>, ce qui fait qu&#8217;il faut attendre que toute la liste soit générée avec que <code>update()</code> fasse son travail.</p>
<p> Il y avait donc des cas supplémentaires à tester et j&#8217;avais mergé son code dans batbelt. Arf, l&#8217;optimisation n&#8217;a jamais de fin ^^</p>
<p> Bref, j&#8217;ai relancé un test avec avec des listes en intentions (et même avec des expressions ternaires ce qui donne des trucs capilotractés):</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> dmerge1<span style="color: black;">&#40;</span>d1, d2, merge_func=<span style="color: #008000;">None</span><span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;
        Une version de l'ancien dmerge3 qui utilise une expression génératrice.
    &quot;&quot;&quot;</span>
    d = <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span>
&nbsp;
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d1<span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">if</span> merge_func <span style="color: #ff7700;font-weight:bold;">is</span> <span style="color: #008000;">None</span>:
        d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d2<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>k, <span style="color: black;">&#40;</span>v <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> d <span style="color: #ff7700;font-weight:bold;">else</span> merge_func<span style="color: black;">&#40;</span>d<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span>, v<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k, v <span style="color: #ff7700;font-weight:bold;">in</span> d2.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
&nbsp;
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> dmerge2<span style="color: black;">&#40;</span>d1, d2, merge_func=<span style="color: #ff7700;font-weight:bold;">lambda</span> v1, v2: v2<span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;
        La version du proposée par notre gentil contributeur, mais
        avec des expressions génératrices à la place des listes en 
        intention.
    &quot;&quot;&quot;</span>
    d = <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span>
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>k, v<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k, v <span style="color: #ff7700;font-weight:bold;">in</span> d1.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> d2<span style="color: black;">&#41;</span>
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>k, v<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k, v <span style="color: #ff7700;font-weight:bold;">in</span> d2.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> d1<span style="color: black;">&#41;</span>
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>k, merge_func<span style="color: black;">&#40;</span>v, d2<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k, v <span style="color: #ff7700;font-weight:bold;">in</span> d1.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">in</span> d2<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
&nbsp;
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> dmerge3<span style="color: black;">&#40;</span>d1, d2, merge_func=<span style="color: #008000;">None</span><span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;
      La version la plus rapide du test précédent.
    &quot;&quot;&quot;</span>
    d = <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span>
&nbsp;
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d1<span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">if</span> merge_func <span style="color: #ff7700;font-weight:bold;">is</span> <span style="color: #008000;">None</span>:
        d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d2<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">for</span> k, v <span style="color: #ff7700;font-weight:bold;">in</span> d2.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">in</span> d:
            d<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span> = merge_func<span style="color: black;">&#40;</span>d<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span>, v<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">else</span>:
            d<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span> = v
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> dmerge4<span style="color: black;">&#40;</span>d1, d2, merge_func=<span style="color: #008000;">None</span><span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;
        La version proposée par notre contributeur, optimisée comme un connard.
    &quot;&quot;&quot;</span>
    d = <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">if</span> merge_func <span style="color: #ff7700;font-weight:bold;">is</span> <span style="color: #008000;">None</span>:
        d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d1<span style="color: black;">&#41;</span>
        d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d2<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>k, v<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k, v <span style="color: #ff7700;font-weight:bold;">in</span> d1.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> d2<span style="color: black;">&#41;</span>
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>k, v<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k, v <span style="color: #ff7700;font-weight:bold;">in</span> d2.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> d1<span style="color: black;">&#41;</span>
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>k, merge_func<span style="color: black;">&#40;</span>v, d2<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k, v <span style="color: #ff7700;font-weight:bold;">in</span> d1.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">in</span> d2<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
&nbsp;
<span style="color: #808080; font-style: italic;">## Generate test dicts</span>
<span style="color: #808080; font-style: italic;">## Testing returns value all match</span>
<span style="color: #808080; font-style: italic;">## Start timing</span>
<span style="color: #808080; font-style: italic;">## Lots of collisions</span>
<span style="color: #808080; font-style: italic;">## Default merge strategy</span>
<span style="color: #808080; font-style: italic;">## 1 12.2690660954</span>
<span style="color: #808080; font-style: italic;">## 2 97.121183157</span>
<span style="color: #808080; font-style: italic;">## 3 12.1084120274</span>
<span style="color: #808080; font-style: italic;">## 4 12.6807589531</span>
<span style="color: #808080; font-style: italic;">## Custom merge strategy</span>
<span style="color: #808080; font-style: italic;">## 1 8.73903894424</span>
<span style="color: #808080; font-style: italic;">## 2 12.0493769646</span>
<span style="color: #808080; font-style: italic;">## 3 8.00074601173</span>
<span style="color: #808080; font-style: italic;">## 4 11.4764301777</span>
<span style="color: #808080; font-style: italic;">## Long dictionaries</span>
<span style="color: #808080; font-style: italic;">## Default merge strategy</span>
<span style="color: #808080; font-style: italic;">## 1 54.5233860016</span>
<span style="color: #808080; font-style: italic;">## 2 218.695598841</span>
<span style="color: #808080; font-style: italic;">## 3 70.213809967</span>
<span style="color: #808080; font-style: italic;">## 4 61.8348701</span>
<span style="color: #808080; font-style: italic;">## Custom merge strategy</span>
<span style="color: #808080; font-style: italic;">## 1 103.258821964</span>
<span style="color: #808080; font-style: italic;">## 2 217.720175982</span>
<span style="color: #808080; font-style: italic;">## 3 96.5204670429</span>
<span style="color: #808080; font-style: italic;">## 4 214.480421066</span>
<span style="color: #808080; font-style: italic;">## Mixed dictionaries</span>
<span style="color: #808080; font-style: italic;">## Default merge strategy</span>
<span style="color: #808080; font-style: italic;">## 1 19.169850111</span>
<span style="color: #808080; font-style: italic;">## 2 66.9599928856</span>
<span style="color: #808080; font-style: italic;">## 3 19.4371211529</span>
<span style="color: #808080; font-style: italic;">## 4 19.5183057785</span>
<span style="color: #808080; font-style: italic;">## Custom merge strategy</span>
<span style="color: #808080; font-style: italic;">## 1 64.7940750122</span>
<span style="color: #808080; font-style: italic;">## 2 66.9712991714</span>
<span style="color: #808080; font-style: italic;">## 3 58.5918440819</span>
<span style="color: #808080; font-style: italic;">## 4 67.5281140804</span>
<span style="color: #808080; font-style: italic;">## [Finished in 1619.3s]</span></pre></div></div>

<p>La bonne nouvelle pour moi, c&#8217;est que l&#8217;algo 3 est toujours le plus rapide, j&#8217;ai pas à re pusher.</p>
<p>Mais il est intéressant de constater que globalement les 4 tests mettent 1619.3s à s’exécuter. Globalement utiliser des expressions génératrices boost bien les perfs.</p>
<hr />
<p><a href="https://github.com/sametmax/codes-des-articles/blob/master/2013/juin/perf.py">Télécharger le code de l&#8217;article.</a></p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=6369&amp;md5=2a38eaff3f2a26f2b60529ac3e370e94" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/mesurer-les-performances-dun-snippet-python/feed/</wfw:commentRss>
		<slash:comments>6</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fmesurer-les-performances-dun-snippet-python%2F&amp;language=en_GB&amp;category=text&amp;title=Mesurer+les+performances+d%26%238217%3Bun+snippet+Python&amp;description=Ca+fait+longtemps+que+j%26%238217%3Bavais+pas+musique.+L%26%238217%3Bopen+source+c%26%238217%3Best+fantastique.+Github+c%26%238217%3Best+merveilleux.+On+parle+de+batbelt%2C+et+paf%2C+quelques+jours+plus+tard+on+a+notre+premi%C3%A8re+contribution.+Ce...&amp;tags=dict%2Cmerge%2Cperf%2Cpython%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/06/rmhtBR7.jpg" length="92496" type="image/jpg" />	</item>
	</channel>
</rss>
