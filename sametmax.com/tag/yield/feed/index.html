<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Sam &#38; Max: Python, Django, Git et du cul &#187; yield</title>
	<atom:link href="http://sametmax.com/tag/yield/feed/" rel="self" type="application/rss+xml" />
	<link>http://sametmax.com</link>
	<description>Deux développeurs en vadrouille qui se sortent les doigts du code</description>
	<lastBuildDate>Wed, 05 Feb 2014 14:20:37 +0000</lastBuildDate>
	<language>en</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>http://wordpress.org/?v=3.3.1</generator>
	<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2F&amp;language=en_US&amp;category=text&amp;title=Sam+%26amp%3B+Max%3A+Python%2C+Django%2C+Git+et+du+cul&amp;description=Deux+d%C3%A9veloppeurs+en+vadrouille+qui+se+sortent+les+doigts+du+code&amp;tags=blog" type="text/html" />
		<item>
		<title>5 choses à apprendre en priorité en Python</title>
		<link>http://sametmax.com/5-choses-a-apprendre-en-priorite-en-python/</link>
		<comments>http://sametmax.com/5-choses-a-apprendre-en-priorite-en-python/#comments</comments>
		<pubDate>Sun, 22 Dec 2013 08:57:17 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[comprehension-lists]]></category>
		<category><![CDATA[pip]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[unpacking]]></category>
		<category><![CDATA[virtualenv]]></category>
		<category><![CDATA[yield]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=8376</guid>
		<description><![CDATA[Quand on apprend un nouveau langage de programmation, on apprend d'abord les bases. Et pour la plupart des langages, elles sont communes : déclarer une variable, faire des conditions et des boucles, faire des fonctions, importer un code d'un autre fichier, etc.

Ce qui va différencier le moment où vous savez programmer dans CE langage, ce sont des notions spécifiques à lui que vous commencez à maitriser.]]></description>
			<content:encoded><![CDATA[<p>Quand on apprend un nouveau langage de programmation, on apprend d&#8217;abord les bases. Et pour la plupart des langages, elles sont communes : déclarer une variable, faire des conditions et des boucles, faire des fonctions, importer un code d&#8217;un autre fichier, etc.</p>
<p>Ce qui va différencier le moment où vous savez programmer dans CE langage, ce sont des notions qui lui sont spécifiques et que vous commencez à maitriser.</p>
<p>Voici 5 notions spécifiques au langage qu&#8217;il faut apprendre en priorité si vous voulez pouvoir dire &#8220;je code en Python&#8221; :</p>
<h2>Pip</h2>
<p>Pip est la moyen le plus utilisé d&#8217;installer une bibliothèque externe dans l&#8217;environnement Python. Dès qu&#8217;on veut faire un projet sérieux, on en a besoin. Tellement qu&#8217;il va en fait être inclus par défaut dans Python 3.4.</p>
<p><a href="http://sametmax.com/votre-python-aime-les-pip/">Lire l&#8217;article sur pip.</a></p>
<h2>Virtualenv</h2>
<p>Virtualenv permet d&#8217;isoler plusieurs installations de Python. A partir du moment où l&#8217;on travaille sur plusieurs projets en même temps, il devient vite indispensable. Mais personnelement, je l&#8217;utilise même quand je n&#8217;ai qu&#8217;un projet installé sur une machine car il me permet de le séparer du setup Python du système et d&#8217;utiliser des hooks.</p>
<p>Un outil qui a été ajouté dans la lib standard en Python 3.3. J&#8217;apprécie que le pragmatisme de l&#8217;évolution de Python qui intègre petit à petit les projets qui se sont révélés les outils de facto dans la communauté.</p>
<p><a href="http://sametmax.com/les-environnement-virtuels-python-virtualenv-et-virtualenvwrapper/">Lire l&#8217;article sur virtualenv.</a></p>
<h2>Les listes en intention</h2>
<p>J&#8217;ai envie de dire l&#8217;itération en générale, mais c&#8217;est un très vaste sujet, et il est couvert en grande partie par les 3 derniers points.</p>
<p>La liste en intention, ou liste en compréhension, est une manière de boucler sur un itérable (souvent une liste), avec optionellement un filtre, afin de produire une nouvelle liste. En une ligne.</p>
<p>C&#8217;est stylistiquement la marque de fabrique de Python (même si c&#8217;est piqué à Haskell). C&#8217;est également ce qui le rend aussi expressif. On peut presque coder tout un programme en déclaratif avec des enchainements de listes en intention.</p>
<p>C&#8217;est beau, propre, efficace et court. IN-DIS-PEN-SA-BLE.</p>
<p><a href="http://sametmax.com/python-love-les-listes-en-intention-partie/">Lire l&#8217;article sur les listes en intention.</a></p>
<h2>L&#8217;unpacking</h2>
<p>L&#8217;unpacking est une autre fonctionalité typiquement pythonienne qui permet de prendre un itérable (souvent un tuple), et de mettre ses éléments dans des variables d&#8217;une traite.</p>
<p>Cela permet d&#8217;augmenter drastiquement la lisibilité des programmes.</p>
<p><a href="http://sametmax.com/tag/unpacking/">Lire les articles sur l&#8217;unpacking.</a></p>
<h2>Les générateurs</h2>
<p>Les générateurs permettent non seulement un énorme gain en performance, mais en plus ils autorisent le traitement itératif de flux de données dont on ne connait pas la taille en avance, voire de taille infinie. Si vous utilisez des expressions génératrices, vous pourrez le faire en déclaratif. Si vous utilisez <code>yield</code>, vous pourrez cacher un algorithme complet derrière une simple boucle <code>for</code>.</p>
<p><a href="http://sametmax.com/comment-utiliser-yield-et-les-generateurs-en-python/">Lire l&#8217;article sur yield.</a></p>
<h2>Le reste ?</h2>
<p>Tout le reste, c&#8217;est du détail. Les décorateurs, la POO, l&#8217;opérateur <code>with</code>, les métaclasses, les astuces magiques pour faire ceci ou cela. C&#8217;est bien, mais ça peut attendre. Ce sont ces 5 notions, qui, bien utilisées, feront d&#8217;un programmeur un dev Python.</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=8376&amp;md5=0c3f015bc4b353adc195e30c23ba6e29" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/5-choses-a-apprendre-en-priorite-en-python/feed/</wfw:commentRss>
		<slash:comments>8</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2F5-choses-a-apprendre-en-priorite-en-python%2F&amp;language=en_GB&amp;category=text&amp;title=5+choses+%C3%A0+apprendre+en+priorit%C3%A9+en+Python&amp;description=Quand+on+apprend+un+nouveau+langage+de+programmation%2C+on+apprend+d%26%238217%3Babord+les+bases.+Et+pour+la+plupart+des+langages%2C+elles+sont+communes+%3A+d%C3%A9clarer+une+variable%2C+faire+des+conditions+et...&amp;tags=comprehension-lists%2Cpip%2Cpython%2Cunpacking%2Cvirtualenv%2Cyield%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/12/Xk9nO.jpg" length="96900" type="image/jpg" />	</item>
		<item>
		<title>map(), filter() et reduce () ?</title>
		<link>http://sametmax.com/map-filter-et-reduce/</link>
		<comments>http://sametmax.com/map-filter-et-reduce/#comments</comments>
		<pubDate>Thu, 14 Nov 2013 09:44:58 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[comprehension-lists]]></category>
		<category><![CDATA[filter]]></category>
		<category><![CDATA[lambda]]></category>
		<category><![CDATA[map]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[reduce]]></category>
		<category><![CDATA[yield]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=7791</guid>
		<description><![CDATA[<code>map()</code>, <code>filter()</code> et <code>reduce()</code> sont des fonctions de traitement d'itérables typiques de la programmation fonctionnelle, qui <a href="http://www.artima.com/weblogs/viewpost.jsp?thread=98196">ont été marquées comme à retirer des builtins</a> pour Python 3. Finalement, seule <code>reduce()</code> sera déplacée dans le module <code>functools</code> pour Python 3.]]></description>
			<content:encoded><![CDATA[<p><code>map()</code>, <code>filter()</code> et <code>reduce()</code> sont des fonctions de traitement d&#8217;itérables typiques de la programmation fonctionnelle, qui <a href="http://www.artima.com/weblogs/viewpost.jsp?thread=98196">ont été marquées comme à retirer des builtins</a> pour Python 3. Finalement, seule <code>reduce()</code> sera déplacée dans le module <code>functools</code> pour Python 3.</p>
<p>Les opérations que font ces fonctions sont typiquement quelque chose que l&#8217;ont peut faire sans elles, et nous allons les passer en revue pour voir dans quels cas elles sont pertinentes, dans quel cas une alternative est meilleure. L&#8217;alternative étant, dans 90% des cas, une <a href="http://sametmax.com/python-love-les-listes-en-intention-partie/">liste en intention</a>.</p>
<h2>filter()</h2>
<p><code>filter()</code> prend une fonction en paramètre, souvent une <a href="http://sametmax.com/fonctions-anonymes-en-python-ou-lambda/">lambda</a>, comme ses deux soeurs puisqu&#8217;on est dans le paradigme fonctionnel. Elle doit renvoyer <code>True</code> si on garde un élément, et <code>False</code> sinon.</p>
<p>L&#8217;usage typique est celui-ci :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">ages = <span style="color: #008000;">range</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">30</span><span style="color: black;">&#41;</span>
majeurs = <span style="color: #008000;">filter</span><span style="color: black;">&#40;</span><span style="color: #ff7700;font-weight:bold;">lambda</span> x: x <span style="color: #66cc66;">&gt;</span> <span style="color: #ff4500;">18</span>, ages<span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>majeurs<span style="color: black;">&#41;</span>
<span style="color: #808080; font-style: italic;">## [19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29]</span></pre></div></div>

<p>Typiquement, ce code peut être remplacé par une liste en intention dans le pur style Python :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">majeurs = <span style="color: black;">&#91;</span>a <span style="color: #ff7700;font-weight:bold;">for</span> a <span style="color: #ff7700;font-weight:bold;">in</span> ages <span style="color: #ff7700;font-weight:bold;">if</span> a <span style="color: #66cc66;">&gt;</span> <span style="color: #ff4500;">18</span><span style="color: black;">&#93;</span></pre></div></div>

<p>Le code est plus court, et fait usage d&#8217;une des fonctionalités les plus importantes du langage. On peut en plus ajouter une transformation à <code>a</code> facilement si on le désire, au lieu de devoir coller un <code>map()</code> derrière.</p>
<p><code>filter()</code> est vraiment la moins utile des 3, et sera une question de style, surtout pour les nostalgiques de Lisp. Je répète souvent que quand on code avec un autre langage, on doit essayer de se tenir au style du nouveau et pas faire un mix avec ses anciennes habitudes. Quand je code en Java, je fais des getter et setter, même si j&#8217;ai horreur de ça.</p>
<p>Il existe quand même UNE astuce pour laquelle filter est utile : garder uniquement les éléments vrais d&#8217;une liste.</p>
<p>Typiquement :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">l = <span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">0</span>, <span style="color: #008000;">None</span>, <span style="color: black;">&#91;</span><span style="color: black;">&#93;</span>, <span style="color: #008000;">True</span><span style="color: black;">&#93;</span>
<span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #008000;">filter</span><span style="color: black;">&#40;</span><span style="color: #008000;">bool</span>, l<span style="color: black;">&#41;</span>
<span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #008000;">True</span><span style="color: black;">&#93;</span></pre></div></div>

<p>Ca marche si la fonction pre-existe et qu&#8217;on a pas à faire une lambda, mais c&#8217;est vraiment le seul usage potable. Un peu plus court qu&#8217;une liste en intention.</p>
<h2>map()</h2>
<p>Si <code>filter()</code> est l&#8217;équivalent de la partie de droite d&#8217;une liste en intention, <code>map()</code> est l&#8217;équivalent de la partie de gauche. La fonction passée retourne un résultat qui permet de transformer la liste.</p>
<p>Typiquement :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">memes = <span style="color: black;">&#91;</span><span style="color: #483d8b;">&quot;It's over 9000 !&quot;</span>, <span style="color: #483d8b;">&quot;All your base are belong to us.&quot;</span><span style="color: black;">&#93;</span>
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #008000;">map</span><span style="color: black;">&#40;</span><span style="color: #008000;">unicode</span>.<span style="color: black;">upper</span>, memes<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span></pre></div></div>

<p>Ce qui peut se traduire par :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>s.<span style="color: black;">upper</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> s <span style="color: #ff7700;font-weight:bold;">in</span> memes<span style="color: black;">&#41;</span></pre></div></div>

<p><code>map()</code> est un peu plus utile, dans le sens où sa syntaxe peut être plus concise dans certains cas, comme le casting de types. Par exemple si je reçois une heure sous forme de string :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">h, m, s = <span style="color: #008000;">map</span><span style="color: black;">&#40;</span><span style="color: #008000;">int</span>, <span style="color: #483d8b;">'8:19:22'</span>.<span style="color: black;">split</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">':'</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span></pre></div></div>

<p>sera plus court et plus concis, et plus clair que :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">h, m, s = <span style="color: black;">&#40;</span><span style="color: #008000;">int</span><span style="color: black;">&#40;</span>i<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> i <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #483d8b;">'8:19:22'</span>.<span style="color: black;">split</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">':'</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span></pre></div></div>

<p>Mais bon, la différence n&#8217;est pas non plus incroyable au point d&#8217;en faire une fonctionnalitéé clé. Je l&#8217;utilise de temps à autre par soucis de brièveté, mais vraiment c&#8217;est tout.</p>
<h2>reduce()</h2>
<p><code>reduce()</code> est plus tordu. La fonction doit prendre deux paramètres en entrée, et retourner une valeur. Au  premier appel, les deux premiers éléments de l&#8217;itérable sont passés en paramètres. Ensuite, le résultat de cet appel et l&#8217;élément suivant sont passés en paramètre, et ainsi de suite.</p>
<p>Vous n&#8217;avez rien pigé ? C&#8217;est normal. <code>reduce()</code> est parfaitement cryptique. Voici ce que ça donne en pratique :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> afficher<span style="color: black;">&#40;</span>a, b<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Entrée :&quot;</span>, a, b<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Sortie :&quot;</span>, a + b<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> a + b
&nbsp;
res = <span style="color: #008000;">reduce</span><span style="color: black;">&#40;</span>afficher, <span style="color: #008000;">range</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">10</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Résultat final&quot;</span>, res<span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;">## Entrée : 0 1</span>
<span style="color: #808080; font-style: italic;">## Sortie : 1</span>
<span style="color: #808080; font-style: italic;">## Entrée : 1 2</span>
<span style="color: #808080; font-style: italic;">## Sortie : 3</span>
<span style="color: #808080; font-style: italic;">## Entrée : 3 3</span>
<span style="color: #808080; font-style: italic;">## Sortie : 6</span>
<span style="color: #808080; font-style: italic;">## Entrée : 6 4</span>
<span style="color: #808080; font-style: italic;">## Sortie : 10</span>
<span style="color: #808080; font-style: italic;">## Entrée : 10 5</span>
<span style="color: #808080; font-style: italic;">## Sortie : 15</span>
<span style="color: #808080; font-style: italic;">## Entrée : 15 6</span>
<span style="color: #808080; font-style: italic;">## Sortie : 21</span>
<span style="color: #808080; font-style: italic;">## Entrée : 21 7</span>
<span style="color: #808080; font-style: italic;">## Sortie : 28</span>
<span style="color: #808080; font-style: italic;">## Entrée : 28 8</span>
<span style="color: #808080; font-style: italic;">## Sortie : 36</span>
<span style="color: #808080; font-style: italic;">## Entrée : 36 9</span>
<span style="color: #808080; font-style: italic;">## Sortie : 45</span>
<span style="color: #808080; font-style: italic;">## Résultat final 45</span></pre></div></div>

<p>Vous allez me dire, à quoi ça sert ? Et bien par exemple à appliquer des opérateurs commutatifs, ici nous l&#8217;avons fait avec <code>+</code>, nous avons fait la somme de tous les éléments retournés par <code>range(10)</code>. La preuve :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #008000;">sum</span><span style="color: black;">&#40;</span><span style="color: #008000;">range</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">10</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #808080; font-style: italic;">## 45</span></pre></div></div>

<p>Il n&#8217;y a pas, en Python, de fonction équivalent à <code>sum()</code> pour la multiplication. Donc on ferait :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #008000;">reduce</span><span style="color: black;">&#40;</span><span style="color: #ff7700;font-weight:bold;">lambda</span> a, b: a <span style="color: #66cc66;">*</span> b, <span style="color: #008000;">range</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">11</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #808080; font-style: italic;">## 3628800</span></pre></div></div>

<p>Ce qui multiplie tous les éléments entre eux. Comme l&#8217;ordre dans lequel les éléments sont multipliés n&#8217;a pas d&#8217;important (d&#8217;où le &#8216;commutatif&#8217;), ça fonctionne.</p>
<p><code>reduce()</code> peut prendre un troisième paramètre, <code>initial</code>, qui sera la valeur passée en premier au premier appel de la fonction. Cela permet de travailler sur des calculs en cascade qui ne fonctionneraient sinon pas. Revenons à notre exemple de temps :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">temps = <span style="color: #008000;">map</span><span style="color: black;">&#40;</span><span style="color: #008000;">int</span>, <span style="color: #483d8b;">'8:19:22'</span>.<span style="color: black;">split</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">':'</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #008000;">reduce</span><span style="color: black;">&#40;</span><span style="color: #ff7700;font-weight:bold;">lambda</span> a, b: a <span style="color: #66cc66;">*</span> <span style="color: #ff4500;">60</span> + b, temps, <span style="color: #ff4500;">0</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #808080; font-style: italic;">## 29962</span></pre></div></div>

<p>Ce qui peut se traduire par :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">h, m, s = <span style="color: #008000;">map</span><span style="color: black;">&#40;</span><span style="color: #008000;">int</span>, <span style="color: #483d8b;">'8:19:22'</span>.<span style="color: black;">split</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">':'</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>h <span style="color: #66cc66;">*</span> <span style="color: #ff4500;">3600</span> + m <span style="color: #66cc66;">*</span> <span style="color: #ff4500;">60</span> + s<span style="color: black;">&#41;</span>
<span style="color: #808080; font-style: italic;">## 29962</span></pre></div></div>

<p>Bien sûr, cette conversion ne fonctionnerait pas si le calcul était sur un itérable plus long. Mais une version itérative est facile à faire :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">res = <span style="color: #ff4500;">0</span>
<span style="color: #ff7700;font-weight:bold;">for</span> i <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">map</span><span style="color: black;">&#40;</span><span style="color: #008000;">int</span>, <span style="color: #483d8b;">'8:19:22'</span>.<span style="color: black;">split</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">':'</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>:
    res = res <span style="color: #66cc66;">*</span> <span style="color: #ff4500;">60</span> + i
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>res<span style="color: black;">&#41;</span>
<span style="color: #808080; font-style: italic;">## 29962</span></pre></div></div>

<p>Maintenant, autant les deux dernières versions sont faciles à comprendre, autant la première prend quelques secondes. Et c&#8217;est la raison pour laquelle <code>reduce()</code> a été retirée des builtins, pour encourager l&#8217;usage des alternatives. En effet, cette fonction donne toujours un résultat très peu lisible. Je cite et approuve Guido là dessus:</p>
<blockquote><p>C&#8217;est en fait celle que je déteste le plus, car, à part pour quelques exemples impliquant + ou *, presque chaque fois que je vois un appel à reduce() avec une fonction non-triviale passée en argument, j&#8217;ai besoin de prendre un crayon et un papier pour faire le diagramme de ce qui est effectivement entrée dans la fonction avant que je comprenne ce qu&#8217;est supposé faire reduce(). Donc à mes yeux, l&#8217;application de reduce() est plutôt limitée à des opérateurs associatifs, et <strong>dans d&#8217;autres cas il est mieux d&#8217;écrire une boucle d&#8217;accumulation explicitement.</strong>
</p></blockquote>
<p>Graissage maison.</p>
<p>Bref, <code>reduce()</code> est dur à lire, et une boucle ne l&#8217;est pas. Écrivez 3 lignes de plus, ça ne va pas vous tuer. Relire votre one-liner dans un mois par contre&#8230;</p>
<p>Cette fonction a été beaucoup utilisée avec les opérateurs <code>or</code> et <code>and</code> pour savoir si tous les éléments étaient vrais au moins un élément vrai dans une liste :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">tout_est_vrai = <span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">1</span><span style="color: black;">&#93;</span>
certains_sont_vrais = <span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">0</span>, <span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">0</span><span style="color: black;">&#93;</span>
tout_est_faux = <span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span>, <span style="color: #ff4500;">0</span>, <span style="color: #ff4500;">0</span>, <span style="color: #ff4500;">0</span><span style="color: black;">&#93;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># Retourne True si tout est vrai</span>
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #008000;">bool</span><span style="color: black;">&#40;</span><span style="color: #008000;">reduce</span><span style="color: black;">&#40;</span><span style="color: #ff7700;font-weight:bold;">lambda</span> a, b: a <span style="color: #ff7700;font-weight:bold;">and</span> b, tout_est_vrai<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #808080; font-style: italic;">## True</span>
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #008000;">bool</span><span style="color: black;">&#40;</span><span style="color: #008000;">reduce</span><span style="color: black;">&#40;</span><span style="color: #ff7700;font-weight:bold;">lambda</span> a, b: a <span style="color: #ff7700;font-weight:bold;">and</span> b, certains_sont_vrais<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #808080; font-style: italic;">## False</span>
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #008000;">bool</span><span style="color: black;">&#40;</span><span style="color: #008000;">reduce</span><span style="color: black;">&#40;</span><span style="color: #ff7700;font-weight:bold;">lambda</span> a, b: a <span style="color: #ff7700;font-weight:bold;">and</span> b, tout_est_faux<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #808080; font-style: italic;">## False</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># Retourne True si au moins un élément est vrai</span>
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #008000;">bool</span><span style="color: black;">&#40;</span><span style="color: #008000;">reduce</span><span style="color: black;">&#40;</span><span style="color: #ff7700;font-weight:bold;">lambda</span> a, b: a <span style="color: #ff7700;font-weight:bold;">or</span> b, tout_est_vrai<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #808080; font-style: italic;">## True</span>
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #008000;">bool</span><span style="color: black;">&#40;</span><span style="color: #008000;">reduce</span><span style="color: black;">&#40;</span><span style="color: #ff7700;font-weight:bold;">lambda</span> a, b: a <span style="color: #ff7700;font-weight:bold;">or</span> b, certains_sont_vrais<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #808080; font-style: italic;">## True</span>
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #008000;">bool</span><span style="color: black;">&#40;</span><span style="color: #008000;">reduce</span><span style="color: black;">&#40;</span><span style="color: #ff7700;font-weight:bold;">lambda</span> a, b: a <span style="color: #ff7700;font-weight:bold;">or</span> b, tout_est_faux<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #808080; font-style: italic;">## False</span></pre></div></div>

<p>Mais aujourd&#8217;hui, c&#8217;est parfaitement inutile puisque nous avons les fonctions built-in <strong>all()</strong> et <strong>any()</strong>, qui font ça en plus court et plus rapide :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #808080; font-style: italic;"># Retourne True si tout est vrai</span>
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #008000;">all</span><span style="color: black;">&#40;</span>tout_est_vrai<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #808080; font-style: italic;">## True</span>
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #008000;">all</span><span style="color: black;">&#40;</span>certains_sont_vrais<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #808080; font-style: italic;">## False</span>
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #008000;">all</span><span style="color: black;">&#40;</span>tout_est_faux<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #808080; font-style: italic;">## False</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># Retourne True si au moins un élément est vrai</span>
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #008000;">any</span><span style="color: black;">&#40;</span>tout_est_vrai<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #808080; font-style: italic;">## True</span>
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #008000;">any</span><span style="color: black;">&#40;</span>certains_sont_vrais<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #808080; font-style: italic;">## True</span>
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #008000;">any</span><span style="color: black;">&#40;</span>tout_est_faux<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #808080; font-style: italic;">## False</span></pre></div></div>

<h2>Petite astuce finale</h2>
<p>Souvenez-vous également que les fonctions Python peuvent être déclarées n&#8217;importe où à la volée, même dans une autre fonction, une classe, une méthode, un context manager, etc. Or une fonction peut retourner un générateur grâce à <a href="http://sametmax.com/comment-utiliser-yield-et-les-generateurs-en-python/">yield</a>, ce qui vous permet de déclarer des gros bouts de logique, et de les plugger dans votre process itérative a posteriori :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> traitement_complexe<span style="color: black;">&#40;</span>iterable<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> iterable:
        <span style="color: #ff7700;font-weight:bold;">if</span> x <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">3</span>, <span style="color: #ff4500;">7</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">and</span> x <span style="color: #66cc66;">%</span> <span style="color: #ff4500;">2</span> <span style="color: #66cc66;">!</span>= <span style="color: #ff4500;">0</span>:
            <span style="color: #ff7700;font-weight:bold;">if</span> x + x <span style="color: #66cc66;">&lt;</span> <span style="color: #ff4500;">13</span> :
                <span style="color: #ff7700;font-weight:bold;">yield</span> x
            <span style="color: #ff7700;font-weight:bold;">else</span>: 
                <span style="color: #ff7700;font-weight:bold;">yield</span> x - <span style="color: #ff4500;">2</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;-&quot;</span>.<span style="color: black;">join</span><span style="color: black;">&#40;</span><span style="color: #008000;">map</span><span style="color: black;">&#40;</span><span style="color: #008000;">str</span>, traitement_complexe<span style="color: black;">&#40;</span><span style="color: #008000;">range</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">20</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #808080; font-style: italic;">## 5-7-9-11-13-15-17</span></pre></div></div>

 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=7791&amp;md5=61c33ea6021ce5d5e2d0eb4d269ccc78" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/map-filter-et-reduce/feed/</wfw:commentRss>
		<slash:comments>1</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fmap-filter-et-reduce%2F&amp;language=en_GB&amp;category=text&amp;title=map%28%29%2C+filter%28%29+et+reduce+%28%29+%3F&amp;description=map%28%29%2C+filter%28%29+et+reduce%28%29+sont+des+fonctions+de+traitement+d%26%238217%3Bit%C3%A9rables+typiques+de+la+programmation+fonctionnelle%2C+qui+ont+%C3%A9t%C3%A9+marqu%C3%A9es+comme+%C3%A0+retirer+des+builtins+pour+Python+3.+Finalement%2C+seule+reduce%28%29...&amp;tags=comprehension-lists%2Cfilter%2Clambda%2Cmap%2Cpython%2Creduce%2Cyield%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/11/Bl18TZa.gif" length="66881" type="image/jpg" />	</item>
		<item>
		<title>S&#8217;affranchir des doublons d&#8217;un itérable en Python</title>
		<link>http://sametmax.com/saffranchir-des-doublons-dun-iterable-en-python/</link>
		<comments>http://sametmax.com/saffranchir-des-doublons-dun-iterable-en-python/#comments</comments>
		<pubDate>Tue, 20 Aug 2013 10:10:32 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[dublon]]></category>
		<category><![CDATA[generator]]></category>
		<category><![CDATA[iterable]]></category>
		<category><![CDATA[lambda]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[yield]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=7143</guid>
		<description><![CDATA[Supprimer ou ignorer les doublons d'un itérable tel qu'une liste ou un array est un challenge dans tous les langages.]]></description>
			<content:encoded><![CDATA[<p>Supprimer ou ignorer les doublons d&#8217;un itérable tel qu&#8217;une liste ou un array est un challenge dans tous les langages. Il faut se poser les questions suivantes :</p>
<ul>
<li>Qu&#8217;est-ce qu&#8217;un doublon ?</li>
<li>Quels types d&#8217;itérables traite-t-on ?</li>
<li>Quel est la taille de l&#8217;itérable ?</li>
<li>Et niveau perfs ?</li>
</ul>
<p>En Python, on a des structures de données qui suppriment automatiquement les doublons : les sets et les dictionnaires. Mais elles ne conservent pas l&#8217;ordre des élements.</p>
<p>Il y a aussi le fait qu&#8217;un itérable en Python peut avoir une taille inconnue, ou infinie.</p>
<p>Le post est long, donc&#8230;</p>

<!-- iframe plugin v:2.3 - wordpress.org/extend/plugins/iframe/ -->
<iframe width="420" height="315" src="//www.youtube.com/embed/HsX4M-by5OY" frameborder="0" scrolling="no" class="iframe-class"></iframe>
<h2>Solution 1 : générateur et hashing</h2>
<p>En utilisant conjointement les générateurs, les sets et une petite injection de dépendance, on peut trouver un compromis entre flexibilité et performances :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> skip_duplicates<span style="color: black;">&#40;</span>iterable, key=<span style="color: #ff7700;font-weight:bold;">lambda</span> x: x<span style="color: black;">&#41;</span>:
&nbsp;
    <span style="color: #808080; font-style: italic;"># on va mettre l’empreinte unique de chaque élément dans ce set</span>
    fingerprints = <span style="color: #008000;">set</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> iterable:
        <span style="color: #808080; font-style: italic;"># chaque élement voit son emprunte calculée. Par défaut l’empreinte</span>
        <span style="color: #808080; font-style: italic;"># est l'élément lui même, ce qui fait qu'il n'y a pas besoin de</span>
        <span style="color: #808080; font-style: italic;"># spécifier 'key' pour des primitives comme les ints ou les strings.</span>
        fingerprint = key<span style="color: black;">&#40;</span>x<span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># On vérifie que l'empreinte est dans la liste des empreintes  des</span>
        <span style="color: #808080; font-style: italic;"># éléments précédents. Si ce n'est pas le cas, on yield l'élément, et on</span>
        <span style="color: #808080; font-style: italic;"># rajoute sont empreinte ans la liste de ceux trouvés, donc il ne sera</span>
        <span style="color: #808080; font-style: italic;"># pas yieldé si on ne le yieldera pas une seconde fois si on le</span>
        <span style="color: #808080; font-style: italic;"># rencontre à nouveau</span>
        <span style="color: #ff7700;font-weight:bold;">if</span> fingerprint <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> fingerprints:
            <span style="color: #ff7700;font-weight:bold;">yield</span> x
            fingerprints.<span style="color: black;">add</span><span style="color: black;">&#40;</span>fingerprint<span style="color: black;">&#41;</span></pre></div></div>

<p>La fonction s&#8217;appelle <code>skip_duplicates</code> car c&#8217;est ce qu&#8217;elle fait. Elle ne retire pas vraiment les doublons, elle produit un flux de d&#8217;éléments qui ne comporte pas de doublons en ignorant tout doublons présent dans l&#8217;itérable initial.</p>
<p>Cette approche a plusieurs avantages :</p>
<ul>
<li>Les doublons sont bien retirés, et l&#8217;ordre est conservé.</li>
<li>La complexité est de 0(n).</li>
<li>L&#8217;utilisateur peut choisir ce qui fait qu&#8217;un élément est unique : un attribut, un sous-élément, l&#8217;affichage sous forme de string&#8230;</li>
<li>C&#8217;est un générateur, est cela fonctionne donc avec des itérables de toute taille, même inconnue ou infinie.</li>
</ul>
<p>Il faut néanmoins que l&#8217;ensemble des éléments uniques tiennent au moins une fois en mémoire en plus de l&#8217;itérable initial, et potentiellement d&#8217;un stockage à la sortie du générateur. On fait donc un trade-off sur la mémoire.</p>
<p>Comme la valeur de <code>key</code> par défaut est une valeur saine, ça fonctionne comme on s&#8217;y attend pour les cas simples :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">list</span><span style="color: black;">&#40;</span>skip_duplicates<span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span>, <span style="color: #ff4500;">3</span>, <span style="color: #ff4500;">4</span>, <span style="color: #ff4500;">4</span>, <span style="color: #ff4500;">2</span>, <span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">3</span> , <span style="color: #ff4500;">4</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span>, <span style="color: #ff4500;">3</span>, <span style="color: #ff4500;">4</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">list</span><span style="color: black;">&#40;</span>skip_duplicates<span style="color: black;">&#40;</span><span style="color: #483d8b;">'fjsqlkdmfjsklqmdfjdmsl'</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: black;">&#91;</span>u<span style="color: #483d8b;">'f'</span>, u<span style="color: #483d8b;">'j'</span>, u<span style="color: #483d8b;">'s'</span>, u<span style="color: #483d8b;">'q'</span>, u<span style="color: #483d8b;">'l'</span>, u<span style="color: #483d8b;">'k'</span>, u<span style="color: #483d8b;">'d'</span>, u<span style="color: #483d8b;">'m'</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">list</span><span style="color: black;">&#40;</span>skip_duplicates<span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span>, <span style="color: black;">&#40;</span><span style="color: #ff4500;">2</span>, <span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span>, <span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span>, <span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: black;">&#91;</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span>, <span style="color: black;">&#40;</span><span style="color: #ff4500;">2</span>, <span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span>, <span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span><span style="color: black;">&#93;</span></pre></div></div>

<p>Pourvoir spécifier &#8216;key&#8217; permet de faire des choix dans ce qu&#8217;est un doublon :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">list</span><span style="color: black;">&#40;</span>skip_duplicates<span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span>, <span style="color: #483d8b;">'1'</span>, <span style="color: #483d8b;">'1'</span>, <span style="color: #ff4500;">2</span>, <span style="color: #ff4500;">3</span>, <span style="color: #483d8b;">'3'</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span>, u<span style="color: #483d8b;">'1'</span>, <span style="color: #ff4500;">3</span>, u<span style="color: #483d8b;">'3'</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">list</span><span style="color: black;">&#40;</span>skip_duplicates<span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span>, <span style="color: #483d8b;">'1'</span>, <span style="color: #483d8b;">'1'</span>, <span style="color: #ff4500;">2</span>, <span style="color: #ff4500;">3</span>, <span style="color: #483d8b;">'3'</span><span style="color: black;">&#41;</span>, key=<span style="color: #ff7700;font-weight:bold;">lambda</span> x: <span style="color: #008000;">str</span><span style="color: black;">&#40;</span>x<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span>, <span style="color: #ff4500;">3</span><span style="color: black;">&#93;</span></pre></div></div>

<p>Et si on s&#8217;attaque à des cas plus complexes, le fonction vous force à préciser votre pensée :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">list</span><span style="color: black;">&#40;</span>skip_duplicates<span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#93;</span>, <span style="color: black;">&#91;</span><span style="color: black;">&#93;</span>, <span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>, <span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span>, <span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
... <span style="color: black;">&#41;</span>
Traceback <span style="color: black;">&#40;</span>most recent call last<span style="color: black;">&#41;</span>:
  File <span style="color: #483d8b;">&quot;&lt;ipython-input-20-ed44f170c634&gt;&quot;</span>, line <span style="color: #ff4500;">1</span>, <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #66cc66;">&lt;</span>module<span style="color: #66cc66;">&gt;</span>
    <span style="color: #008000;">list</span><span style="color: black;">&#40;</span>skip_duplicates<span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#93;</span>, <span style="color: black;">&#91;</span><span style="color: black;">&#93;</span>, <span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>, <span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span>, <span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
  File <span style="color: #483d8b;">&quot;&lt;ipython-input-18-42dbb94f03f8&gt;&quot;</span>, line <span style="color: #ff4500;">7</span>, <span style="color: #ff7700;font-weight:bold;">in</span> skip_duplicates
    <span style="color: #ff7700;font-weight:bold;">if</span> fingerprint <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> fingerprints:
<span style="color: #008000;">TypeError</span>: unhashable <span style="color: #008000;">type</span>: <span style="color: #483d8b;">'list'</span></pre></div></div>

<p>En effet les listes ne sont pas des types hashables en Python, on ne peut donc pas les stocker dans un <code>set</code>.</p>
<p>Mais on peut caster la liste, et faire ainsi le choix de savoir sur quel critère on base notre égalité. Par exemle, considère-t-on que deux itérables ayant le même contenu sont égaux, où alors doivent-ils avoir le même type ?</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">list</span><span style="color: black;">&#40;</span>skip_duplicates<span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#93;</span>, <span style="color: black;">&#91;</span><span style="color: black;">&#93;</span>, <span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>, <span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span>, <span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>, <span style="color: #ff7700;font-weight:bold;">lambda</span> x: <span style="color: #008000;">tuple</span><span style="color: black;">&#40;</span>x<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: black;">&#91;</span><span style="color: black;">&#91;</span><span style="color: black;">&#93;</span>, <span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">list</span><span style="color: black;">&#40;</span>skip_duplicates<span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#93;</span>, <span style="color: black;">&#91;</span><span style="color: black;">&#93;</span>, <span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>, <span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span>, <span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>, <span style="color: #ff7700;font-weight:bold;">lambda</span> x: <span style="color: black;">&#40;</span><span style="color: #008000;">type</span><span style="color: black;">&#40;</span>x<span style="color: black;">&#41;</span>, <span style="color: #008000;">tuple</span><span style="color: black;">&#40;</span>x<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: black;">&#91;</span><span style="color: black;">&#91;</span><span style="color: black;">&#93;</span>, <span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>, <span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span>, <span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span><span style="color: black;">&#93;</span></pre></div></div>

<p>Nous utilisons le fait que :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">tuple</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span> == <span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span>
<span style="color: #008000;">True</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: black;">&#40;</span><span style="color: #008000;">type</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>, <span style="color: #008000;">tuple</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> == <span style="color: black;">&#40;</span><span style="color: #008000;">type</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>, <span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #008000;">False</span></pre></div></div>

<p>Puisque :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: black;">&#40;</span><span style="color: #008000;">type</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>, <span style="color: #008000;">tuple</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: black;">&#40;</span><span style="color: #66cc66;">&lt;</span>type <span style="color: #483d8b;">'list'</span><span style="color: #66cc66;">&gt;</span>, <span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: black;">&#40;</span><span style="color: #008000;">type</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>, <span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: black;">&#40;</span><span style="color: #66cc66;">&lt;</span>type <span style="color: #483d8b;">'tuple'</span><span style="color: #66cc66;">&gt;</span>, <span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span></pre></div></div>

<p>Dans le cas où nous ne sommes pas capables de déterminer ce qu&#8217;est un doublon, la fonction ne retire simplement rien :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">class</span> Test<span style="color: black;">&#40;</span><span style="color: #008000;">object</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__init__</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, foo=<span style="color: #483d8b;">'bar'</span><span style="color: black;">&#41;</span>:
        <span style="color: #008000;">self</span>.<span style="color: black;">foo</span> = foo
    <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__repr__</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #483d8b;">&quot;Test('%s')&quot;</span> <span style="color: #66cc66;">%</span> <span style="color: #008000;">self</span>.<span style="color: black;">foo</span>
&nbsp;
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">list</span><span style="color: black;">&#40;</span>skip_duplicates<span style="color: black;">&#40;</span><span style="color: black;">&#91;</span>Test<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>, Test<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>, Test<span style="color: black;">&#40;</span><span style="color: #483d8b;">'other'</span><span style="color: black;">&#41;</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: black;">&#91;</span>Test<span style="color: black;">&#40;</span><span style="color: #483d8b;">'bar'</span><span style="color: black;">&#41;</span>, Test<span style="color: black;">&#40;</span><span style="color: #483d8b;">'bar'</span><span style="color: black;">&#41;</span>, Test<span style="color: black;">&#40;</span><span style="color: #483d8b;">'other'</span><span style="color: black;">&#41;</span><span style="color: black;">&#93;</span></pre></div></div>

<p>Mais permet encore une fois de faire le choix de quoi retirer :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">list</span><span style="color: black;">&#40;</span>skip_duplicates<span style="color: black;">&#40;</span><span style="color: black;">&#91;</span>Test<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>, Test<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>, Test<span style="color: black;">&#40;</span><span style="color: #483d8b;">'other'</span><span style="color: black;">&#41;</span><span style="color: black;">&#93;</span>, key=<span style="color: #ff7700;font-weight:bold;">lambda</span> x: x.<span style="color: black;">foo</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: black;">&#91;</span>Test<span style="color: black;">&#40;</span><span style="color: #483d8b;">'bar'</span><span style="color: black;">&#41;</span>, Test<span style="color: black;">&#40;</span><span style="color: #483d8b;">'other'</span><span style="color: black;">&#41;</span><span style="color: black;">&#93;</span></pre></div></div>

<p>Ce principe de la fonction <code>key</code>, on le retrouve dans <code>sorted()</code>, donc les habitués seront déjà à l&#8217;aise. Et j&#8217;aime beaucoup ce pattern, car il est très puissant. On peut avoir la fonction <code>key</code> qui renvoit des choses très simples :</p>
<ul>
<li>Un attribut.</li>
<li>Un element (<code>x[2]</code>, <code>x['cle']</code>&#8230;)</li>
<li>Une version castée avec <code>int()</code>, <code>str()</code>, <code>tuple()</code>, etc</li>
</ul>
<p>Mais on peut aussi faire des choses très complexes. En effet, rien ne nous oblige à utiliser une lambda, on peut mettre une fonction complète et lui faire retourner :</p>
<ul>
<li>Un hash md5.</li>
<li>Une entrée en base de données.</li>
<li>Un nouvel objet customisé.</li>
<li>Un tuple de tuples d&#8217;objets custos avec des dictionnaires en attributs&#8230;</li>
<li>Le contenu d&#8217;un fichier.</li>
</ul>
<p>Python sait naturellement comparer tout ça.</p>
<p>Notez que nous trichons un peu, puisque nous retirons les doublons en nous basant sur un <code>set</code> qui va calculer un hash de l&#8217;objet, et pas véritablement vérifier l&#8217;égalité. La fonction en fonctionnera donc pas si l&#8217;utilisateur définie <code>__eq__</code> et s&#8217;attend à ce que les doublons soient retirés. Ce qui nous amène à &#8230;</p>
<h2>Solution 2 : iterateur et comparaison</h2>
<p>Pour ce genre de chose, un autre algo, qui ne fontionerait que sur les itérables de taille finie, et qui serait bien plus lent (complexité n log(n)), peut être utilisé :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> strip_duplicates<span style="color: black;">&#40;</span>iterable, equals=<span style="color: #ff7700;font-weight:bold;">lambda</span> x, y: x == y<span style="color: black;">&#41;</span>:
&nbsp;
    <span style="color: #808080; font-style: italic;"># On transforme l'itérable en iterateur sur lui même, cela va nous</span>
    <span style="color: #808080; font-style: italic;"># permettre d'appeler next() dessus et récupérer le premier élément,</span>
    <span style="color: #808080; font-style: italic;"># même sur un objet non indexable (sur lequel on ne peut utiliser [0])</span>
    iterable = <span style="color: #008000;">iter</span><span style="color: black;">&#40;</span>iterable<span style="color: black;">&#41;</span>
&nbsp;
    res = <span style="color: black;">&#91;</span><span style="color: black;">&#93;</span>
    <span style="color: #808080; font-style: italic;"># Une petite boucle infinie est nécessaire car la boucle 'for' ne nous</span>
    <span style="color: #808080; font-style: italic;"># permet pas de récupérer le premier élément indépendamment des autres,</span>
    <span style="color: #808080; font-style: italic;"># et la boucle 'while' attend une condition de sortie, ce que nous n'avons</span>
    <span style="color: #808080; font-style: italic;"># pas forcément (il n'est pas possible de vérifier le nombre d'éléments</span>
    <span style="color: #808080; font-style: italic;"># restant dans un générateur).</span>
    <span style="color: #ff7700;font-weight:bold;">while</span> <span style="color: #008000;">True</span>:
&nbsp;
        <span style="color: #808080; font-style: italic;"># on récupère le premier élément de l'iterable restant, si il n'y en</span>
        <span style="color: #808080; font-style: italic;"># a plus, on sort de la boucle.</span>
        <span style="color: #ff7700;font-weight:bold;">try</span>:
            elem = next<span style="color: black;">&#40;</span>iterable<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: #008000;">StopIteration</span>:
            <span style="color: #ff7700;font-weight:bold;">break</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># Le premier élément est ajouté au résultat sans doublons. Maintenant</span>
        <span style="color: #808080; font-style: italic;"># on va recréer l'itérable, mais en retirant tout ce qui était égal</span>
        <span style="color: #808080; font-style: italic;"># au premier élément. Notez que 'être égal' est une condition modifiable</span>
        <span style="color: #808080; font-style: italic;"># en passant une fonction en paramètre, comme l'était 'key' précédemment.</span>
        res.<span style="color: black;">append</span><span style="color: black;">&#40;</span>elem<span style="color: black;">&#41;</span>
&nbsp;
        iterable = <span style="color: #008000;">iter</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span>x <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> iterable <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #ff7700;font-weight:bold;">not</span> equals<span style="color: black;">&#40;</span>elem, x<span style="color: black;">&#41;</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">return</span> res</pre></div></div>

<p>La fonction s&#8217;appelle <code>strip_duplicates</code> car elle produit une nouvelle liste, mais sans les éléments indésirables, comme le fait <code>strip()</code> sur une chaîne (produit une nouvelle chaîne, sans les éléments indésirables).</p>
<p>Ce type de fonction peut être utile dans plusieurs cas :</p>
<ul>
<li>On a pas envie de se poser la question de savoir si nos types à comparer sont hashable ou pas, et on est prêt à payer un peu de CPU pour cela.</li>
<li>On a besoin de retirer les doublons sur la base d&#8217;une égalité, par exemple sur l&#8217;existence de la méthode <code>__eq__</code>.</li>
<li>On a besoin de retirer les doublons sur la base d&#8217;une logique complexe qui dépend du contexte.</li>
</ul>
<p>A première vu cela fonctionne presque de la même manière que <code>skip_duplicates</code>, mais en retournant une liste plutôt qu&#8217;un générateur :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> strip_duplicates<span style="color: black;">&#40;</span><span style="color: #483d8b;">'fdjqkslfjdmkfdsqjkfmjqsdmlkfjqslkmfjsdklfl'</span><span style="color: black;">&#41;</span>
<span style="color: black;">&#91;</span><span style="color: #483d8b;">'f'</span>, <span style="color: #483d8b;">'d'</span>, <span style="color: #483d8b;">'j'</span>, <span style="color: #483d8b;">'q'</span>, <span style="color: #483d8b;">'k'</span>, <span style="color: #483d8b;">'s'</span>, <span style="color: #483d8b;">'l'</span>, <span style="color: #483d8b;">'m'</span><span style="color: black;">&#93;</span></pre></div></div>

<p>Mais déjà il n&#8217;y a pas à se soucier de savoir si une structure de données est hashable :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> strip_duplicates<span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#93;</span>, <span style="color: black;">&#91;</span><span style="color: black;">&#93;</span>, <span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>, <span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span>, <span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: black;">&#91;</span><span style="color: black;">&#91;</span><span style="color: black;">&#93;</span>, <span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>, <span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span>, <span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span><span style="color: black;">&#93;</span></pre></div></div>

<p>Même si on garde la même flexibilité, bien que la fonction à passer ait une signature légèrement différente :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> strip_duplicates<span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#93;</span>, <span style="color: black;">&#91;</span><span style="color: black;">&#93;</span>, <span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>, <span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span>, <span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>, <span style="color: #ff7700;font-weight:bold;">lambda</span> x, y: <span style="color: #008000;">tuple</span><span style="color: black;">&#40;</span>x<span style="color: black;">&#41;</span> == <span style="color: #008000;">tuple</span><span style="color: black;">&#40;</span>y<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: black;">&#91;</span><span style="color: black;">&#91;</span><span style="color: black;">&#93;</span>, <span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span><span style="color: black;">&#93;</span></pre></div></div>

<p>Le plus interessant reste que cela fonctionne sur l&#8217;égalité, et donc cela marche d&#8217;office avec les objets qui déclarent <code>__eq__</code> ce qui est le cas dans de nombreuses libs, comme les ORM :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">class</span> Test<span style="color: black;">&#40;</span><span style="color: #008000;">object</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__init__</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, foo=<span style="color: #483d8b;">'bar'</span><span style="color: black;">&#41;</span>:
        <span style="color: #008000;">self</span>.<span style="color: black;">foo</span> = foo
    <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__repr__</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #483d8b;">&quot;Test('%s')&quot;</span> <span style="color: #66cc66;">%</span> <span style="color: #008000;">self</span>.<span style="color: black;">foo</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__eq__</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, other<span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">self</span>.<span style="color: black;">foo</span> == other.<span style="color: black;">foo</span>
&nbsp;
<span style="color: #66cc66;">&gt;&gt;&gt;</span> strip_duplicates<span style="color: black;">&#40;</span><span style="color: black;">&#91;</span>Test<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>, Test<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>, Test<span style="color: black;">&#40;</span><span style="color: #483d8b;">'other'</span><span style="color: black;">&#41;</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
<span style="color: black;">&#91;</span>Test<span style="color: black;">&#40;</span><span style="color: #483d8b;">'bar'</span><span style="color: black;">&#41;</span>, Test<span style="color: black;">&#40;</span><span style="color: #483d8b;">'other'</span><span style="color: black;">&#41;</span><span style="color: black;">&#93;</span></pre></div></div>

<p>Dans certains cas, notamment dans le cas où le point de comparaison est un object non hashable de très grosse taille (par exemple un dico très long), on peut espérer aussi pas mal économiser en mémoire. Mais on est qu&#8217;en est-il des besoins en mémoire et en CPU ?</p>
<h2>Solution 3 : retirer les doublons, in place</h2>
<p>Enfin, pour ceux qui ont de grosses contraintes de mémoire et qui veulent un algo rapide au prix de la flexibilité du code, voici une solution qui oblige à travailler sur des listes et à modifier la liste sur place :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> remove_duplicates<span style="color: black;">&#40;</span>lst, equals=<span style="color: #ff7700;font-weight:bold;">lambda</span> x, y: x == y<span style="color: black;">&#41;</span>:
&nbsp;
    <span style="color: #808080; font-style: italic;"># Normalement en Python on adore le duck typing, mais là cet algo suppose</span>
    <span style="color: #808080; font-style: italic;"># l'usage d'une liste, donc on met un gardefou.</span>
    <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #008000;">isinstance</span><span style="color: black;">&#40;</span>lst, <span style="color: #008000;">list</span><span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">raise</span> <span style="color: #008000;">TypeError</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'This function works only with lists.'</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># là on est sur quelque chose qui ressemble vachement plus à du code C ^^</span>
    i1 = <span style="color: #ff4500;">0</span>
    l = <span style="color: black;">&#40;</span><span style="color: #008000;">len</span><span style="color: black;">&#40;</span>lst<span style="color: black;">&#41;</span> - <span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># on itère mécaniquement sur la liste, à l'ancienne, avec nos petites</span>
    <span style="color: #808080; font-style: italic;"># mains potelées.</span>
    <span style="color: #ff7700;font-weight:bold;">while</span> i1 <span style="color: #66cc66;">&lt;</span> l:
&nbsp;
        <span style="color: #808080; font-style: italic;"># on récupère chaque élément de la liste, sauf le dernier</span>
        elem = lst<span style="color: black;">&#91;</span>i1<span style="color: black;">&#93;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># on le compare à l'élément suivant, et chaque élément après</span>
        <span style="color: #808080; font-style: italic;"># l'élément suivant</span>
        i2 = i1 + <span style="color: #ff4500;">1</span>
        <span style="color: #ff7700;font-weight:bold;">while</span> i2 <span style="color: #66cc66;">&lt;</span>= l:
            <span style="color: #808080; font-style: italic;"># en cas d'égalité, on retire l'élément de la liste, et on</span>
            <span style="color: #808080; font-style: italic;"># décrément la longueur de la liste ainsi amputée</span>
            <span style="color: #ff7700;font-weight:bold;">if</span> equals<span style="color: black;">&#40;</span>elem, lst<span style="color: black;">&#91;</span>i2<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>:
                <span style="color: #ff7700;font-weight:bold;">del</span> lst<span style="color: black;">&#91;</span>i2<span style="color: black;">&#93;</span>
                l -= <span style="color: #ff4500;">1</span>
            i2 += <span style="color: #ff4500;">1</span>
&nbsp;
        i1 += <span style="color: #ff4500;">1</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">return</span> lst</pre></div></div>

<p>Et là on est bien dans de la modification sur place :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> lst = <span style="color: #008000;">list</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'fjdsklmqfjskdfjmld'</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> lst
<span style="color: black;">&#91;</span>u<span style="color: #483d8b;">'f'</span>, u<span style="color: #483d8b;">'j'</span>, u<span style="color: #483d8b;">'d'</span>, u<span style="color: #483d8b;">'s'</span>, u<span style="color: #483d8b;">'k'</span>, u<span style="color: #483d8b;">'l'</span>, u<span style="color: #483d8b;">'m'</span>, u<span style="color: #483d8b;">'q'</span>, u<span style="color: #483d8b;">'f'</span>, u<span style="color: #483d8b;">'j'</span>, u<span style="color: #483d8b;">'s'</span>, u<span style="color: #483d8b;">'k'</span>, u<span style="color: #483d8b;">'d'</span>, u<span style="color: #483d8b;">'f'</span>, u<span style="color: #483d8b;">'j'</span>, u<span style="color: #483d8b;">'m'</span>, u<span style="color: #483d8b;">'l'</span>, u<span style="color: #483d8b;">'d'</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> remove_duplicates<span style="color: black;">&#40;</span>lst<span style="color: black;">&#41;</span>
<span style="color: black;">&#91;</span>u<span style="color: #483d8b;">'f'</span>, u<span style="color: #483d8b;">'j'</span>, u<span style="color: #483d8b;">'d'</span>, u<span style="color: #483d8b;">'s'</span>, u<span style="color: #483d8b;">'k'</span>, u<span style="color: #483d8b;">'l'</span>, u<span style="color: #483d8b;">'m'</span>, u<span style="color: #483d8b;">'q'</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> lst
<span style="color: black;">&#91;</span>u<span style="color: #483d8b;">'f'</span>, u<span style="color: #483d8b;">'j'</span>, u<span style="color: #483d8b;">'d'</span>, u<span style="color: #483d8b;">'s'</span>, u<span style="color: #483d8b;">'k'</span>, u<span style="color: #483d8b;">'l'</span>, u<span style="color: #483d8b;">'m'</span>, u<span style="color: #483d8b;">'q'</span><span style="color: black;">&#93;</span></pre></div></div>

<p>La fonction s&#8217;appelle cette fois bien <code>remove_duplicates</code> puisque c&#8217;est ce qu&#8217;elle fait : retirer les doublons de la liste originale.</p>
<h2>Et maintenant, c&#8217;est l&#8217;heure du benchmark à deux balles !</h2>
<p>skip_duplicates :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">setup = <span style="color: #483d8b;">&quot;&quot;&quot;
def skip_duplicates(iterable, key=lambda x: x):
        fingerprints = set()
        for x in iterable:
                fingerprint = key(x)
                if fingerprint not in fingerprints:
                        yield x
                        fingerprints.add(fingerprint)
import string
lst = list(string.ascii_letters * 100)&quot;&quot;&quot;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'list(skip_duplicates(lst))'</span>, setup=setup, number=<span style="color: #ff4500;">1000</span><span style="color: black;">&#41;</span>
<span style="color: #ff4500;">0.9810519218444824</span></pre></div></div>

<p>strip_duplicates :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> setup = <span style="color: #483d8b;">&quot;&quot;&quot;
def strip_duplicates(iterable, equals=lambda x, y: x == y):
    iterable = iter(iterable)
    res = []
    while True:
        try:
            elem = next(iterable)
        except StopIteration:
            break
        res.append(elem)
&nbsp;
        iterable = iter([x for x in iterable if not equals(elem, x)])
&nbsp;
    return res
&nbsp;
import string
lst = list(string.ascii_letters * 100)&quot;&quot;&quot;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'list(strip_duplicates(lst))'</span>, setup=setup, number=<span style="color: #ff4500;">1000</span><span style="color: black;">&#41;</span>
<span style="color: #ff4500;">41.462974071502686</span></pre></div></div>

<p>remove_duplicates :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">setup = <span style="color: #483d8b;">&quot;&quot;&quot;
def remove_duplicates(lst, equals=lambda x, y: x == y):
    if not isinstance(lst, list):
        raise TypeError('This function works only with lists.')
    i1 = 0
    l = (len(lst) - 1)
    while i1 &lt; l:
        elem = lst[i1]
        i2 = i1 + 1
        while i2 &lt;= l:
            if equals(elem, lst[i2]):
                del lst[i2]
                l -= 1
            i2 += 1
        i1 += 1
    return lst
&nbsp;
import string
lst = list(string.ascii_letters * 100)&quot;&quot;&quot;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'list(remove_duplicates(lst))'</span>, setup=setup, number=<span style="color: #ff4500;">1000</span><span style="color: black;">&#41;</span>
<span style="color: #ff4500;">0.37493896484375</span></pre></div></div>

<p>Sans surprise, la version inplace est la plus rapide puisque la plus restrictive. En second vient notre strip_duplicates, beaucoup fois plus lente. Et en dernier, 50 fois plus lente, le compromis entre les deux : souple, consomme moins de mémoire que skip, mais plus que remove.</p>
<p>Mais ce n&#8217;est pas très juste pour strip, puisque que skip n&#8217;a pas à faire un gros travail de conversion. Essayons avec des clés plus grosses :</p>
<p>skip_duplicates :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">setup = <span style="color: #483d8b;">&quot;&quot;&quot;
def skip_duplicates(iterable, key=lambda x: x):
        fingerprints = set()
        for x in iterable:
                fingerprint = key(x)
                if fingerprint not in fingerprints:
                        yield x
                        fingerprints.add(fingerprint)
import string, random
lst = [list(string.ascii_letters * 100) for x in xrange(100)]
for x in lst:
    x.pop(random.randint(0, len(x) - 1))&quot;&quot;&quot;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'list(skip_duplicates(lst, lambda x: tuple(x)))'</span>, setup=setup, number=<span style="color: #ff4500;">1000</span><span style="color: black;">&#41;</span>
<span style="color: #ff4500;">15.516181945800781</span></pre></div></div>

<p>strip_duplicates :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> setup = <span style="color: #483d8b;">&quot;&quot;&quot;
def strip_duplicates(iterable, equals=lambda x, y: x == y):
    iterable = iter(iterable)
    res = []
    while True:
        try:
            elem = next(iterable)
        except StopIteration:
            break
        res.append(elem)
&nbsp;
        iterable = iter([x for x in iterable if not equals(elem, x)])
&nbsp;
    return res
&nbsp;
import string, random
lst = [list(string.ascii_letters * 100) for x in xrange(100)]
for x in lst:
    x.pop(random.randint(0, len(x) - 1))&quot;&quot;&quot;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'list(strip_duplicates(lst))'</span>, setup=setup, number=<span style="color: #ff4500;">1000</span><span style="color: black;">&#41;</span>
<span style="color: #ff4500;">22.047110080718994</span></pre></div></div>

<p>remove_duplicates :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">setup = <span style="color: #483d8b;">&quot;&quot;&quot;
def remove_duplicates(lst, equals=lambda x, y: x == y):
    if not isinstance(lst, list):
        raise TypeError('This function works only with lists.')
    i1 = 0
    l = (len(lst) - 1)
    while i1 &lt; l:
        elem = lst[i1]
        i2 = i1 + 1
        while i2 &lt;= l:
            if equals(elem, lst[i2]):
                del lst[i2]
                l -= 1
            i2 += 1
        i1 += 1
    return lst
&nbsp;
import string, random
lst = [list(string.ascii_letters * 100) for x in xrange(100)]
for x in lst:
    x.pop(random.randint(0, len(x) - 1))&quot;&quot;&quot;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'list(remove_duplicates(lst))'</span>, setup=setup, number=<span style="color: #ff4500;">1000</span><span style="color: black;">&#41;</span>
<span style="color: #ff4500;">14.763166904449463</span></pre></div></div>

<p>Comme souvent les résultats sont contre untuitifs, car bien que remove garde son avance, elle s&#8217;est largement réduite. A l&#8217;inverse, skip n&#8217;est pas tant à la ramasse que ça, et strip reste le plus lent.</p>
<p>Il faudrait aussi mesurer la consommation mémoire, je suis certain que ce serait interessant.</p>
<p>Bon, il est temps de mettre tout ça dans <a href="http://sametmax.com/batbelt-la-lib-des-petits-outils-python-qui-vont-bien/">batbelt</a>.</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=7143&amp;md5=3d2ef2768ecef0765e05660abbbcf20f" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/saffranchir-des-doublons-dun-iterable-en-python/feed/</wfw:commentRss>
		<slash:comments>7</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fsaffranchir-des-doublons-dun-iterable-en-python%2F&amp;language=en_GB&amp;category=text&amp;title=S%26%238217%3Baffranchir+des+doublons+d%26%238217%3Bun+it%C3%A9rable+en+Python&amp;description=Supprimer+ou+ignorer+les+doublons+d%26%238217%3Bun+it%C3%A9rable+tel+qu%26%238217%3Bune+liste+ou+un+array+est+un+challenge+dans+tous+les+langages.+Il+faut+se+poser+les+questions+suivantes+%3A+Qu%26%238217%3Best-ce+qu%26%238217%3Bun...&amp;tags=dublon%2Cgenerator%2Citerable%2Clambda%2Cpython%2Cyield%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/08/NFDSpXq.gif" length="464024" type="image/jpg" />	</item>
		<item>
		<title>Implémenter une fenêtre glissante en Python avec un deque</title>
		<link>http://sametmax.com/implementer-une-fenetre-glissante-en-python-avec-un-deque/</link>
		<comments>http://sametmax.com/implementer-une-fenetre-glissante-en-python-avec-un-deque/#comments</comments>
		<pubDate>Thu, 20 Dec 2012 19:02:43 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[deque]]></category>
		<category><![CDATA[iterable]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[yield]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=3562</guid>
		<description><![CDATA[
On a déjà vu comment implémenter <a href="http://sametmax.com/parcourir-un-iterable-par-morceaux-en-python/">l'itération par morceaux </a>sur un itérable de n'importe quelle taille. Grâce au deque, on peut aussi facilement créer une fenêtre glissante.]]></description>
			<content:encoded><![CDATA[<p>Quand j&#8217;entends deque, je pense plus à un deck de Magic de Gathering qu&#8217;à un module Python, mais aujourd&#8217;hui j&#8217;utilise beaucoup plus le dernier que le précédent.</p>
<p>On a déjà vu comment implémenter <a href="http://sametmax.com/parcourir-un-iterable-par-morceaux-en-python/">l&#8217;itération par morceaux </a>sur un itérable de n&#8217;importe quelle taille. Grâce au deque, on peut aussi facilement créer une fenêtre glissante.</p>
<h2>Qu&#8217;est-ce qu&#8217;une fenêtre glissante ?</h2>
<p>Il s&#8217;agit de parcourir un itérable par tranches de &#8220;n&#8221; élements, en faisant en sorte que l&#8217;insertion d&#8217;un nouvel élément dans la tranche implique la supression du premier entré. Mouai, dit comme ça c&#8217;est pas clair. Un p&#8217;tit exemple ?</p>
<p>Fenêtre glissante de 3 éléments sur une liste de 10 éléments, à la mano:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> l = <span style="color: #008000;">range</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">10</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> l
<span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span>, <span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span>, <span style="color: #ff4500;">3</span>, <span style="color: #ff4500;">4</span>, <span style="color: #ff4500;">5</span>, <span style="color: #ff4500;">6</span>, <span style="color: #ff4500;">7</span>, <span style="color: #ff4500;">8</span>, <span style="color: #ff4500;">9</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> l<span style="color: black;">&#91;</span>:<span style="color: #ff4500;">3</span><span style="color: black;">&#93;</span>
<span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span>, <span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> l<span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>:<span style="color: #ff4500;">4</span><span style="color: black;">&#93;</span>
<span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span>, <span style="color: #ff4500;">3</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> l<span style="color: black;">&#91;</span><span style="color: #ff4500;">2</span>:<span style="color: #ff4500;">5</span><span style="color: black;">&#93;</span>
<span style="color: black;">&#91;</span><span style="color: #ff4500;">2</span>, <span style="color: #ff4500;">3</span>, <span style="color: #ff4500;">4</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> l<span style="color: black;">&#91;</span><span style="color: #ff4500;">3</span>:<span style="color: #ff4500;">6</span><span style="color: black;">&#93;</span>
<span style="color: black;">&#91;</span><span style="color: #ff4500;">3</span>, <span style="color: #ff4500;">4</span>, <span style="color: #ff4500;">5</span><span style="color: black;">&#93;</span>
...</pre></div></div>

<p>A ne pas confondre avec le parcours par morceaux, qu&#8217;on déjà traité, et qui donne ça:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span>, <span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span>, <span style="color: #ff4500;">3</span>, <span style="color: #ff4500;">4</span>, <span style="color: #ff4500;">5</span>, <span style="color: #ff4500;">6</span>, <span style="color: #ff4500;">7</span>, <span style="color: #ff4500;">8</span>, <span style="color: #ff4500;">9</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> l<span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span>:<span style="color: #ff4500;">3</span><span style="color: black;">&#93;</span>
<span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span>, <span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> l<span style="color: black;">&#91;</span><span style="color: #ff4500;">3</span>:<span style="color: #ff4500;">6</span><span style="color: black;">&#93;</span>
<span style="color: black;">&#91;</span><span style="color: #ff4500;">3</span>, <span style="color: #ff4500;">4</span>, <span style="color: #ff4500;">5</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> l<span style="color: black;">&#91;</span><span style="color: #ff4500;">6</span>:<span style="color: #ff4500;">9</span><span style="color: black;">&#93;</span>
<span style="color: black;">&#91;</span><span style="color: #ff4500;">6</span>, <span style="color: #ff4500;">7</span>, <span style="color: #ff4500;">8</span><span style="color: black;">&#93;</span>
...</pre></div></div>

<p>Et bien sûr, comme d&#8217;hab, vous allez dire &#8220;Cher Sam, malgré ton génie qui n&#8217;a d&#8217;égal que ta beauté et l&#8217;incohérence de cette remarque, je ne vois pas vraiment à quoi ça sert.&#8221;</p>
<p>Et bien essentiellement dans les situations où un élément est dépendant des précédents, par exemple pour répondre à des questions existentielles comme &#8220;quel est le premier élément qui est la somme des 5 le précédant dans cette liste ?&#8221;. Ça n&#8217;arrive certes pas tous les jours, mais fuck, j&#8217;avais pas de meilleur exemple en tête, là, tout de suite.</p>
<h2>Qu&#8217;est-ce qu&#8217;un deque ?</h2>
<p>Un <a href="http://docs.python.org/2.7/library/collections.html">deque</a> est une structure de données qui permet d&#8217;implémenter des comportements de types piles, files, FIFO, LIFO, et autres pipos avec efficacité. Traduit en langage de tous les jours, c&#8217;est comme une liste, mais:</p>
<ul>
<li>ajouter un élément à la fin ou au début est une opération super rapide;</li>
<li>les retirer aussi;</li>
<li>on peut itérer dessus à la même vitesse que la liste;</li>
<li>mais accéder à un élement qui n&#8217;est pas au début ou à la fin juste par son index est très lent;</li>
<li>on peut limiter le nombre d&#8217;éléments que ça contient automatiquement.</li>
</ul>
<p>On va donc l&#8217;utiliser comme acumulateur ou pour faire des files d&#8217;attentes.</p>
<p>Démonstration:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">collections</span> <span style="color: #ff7700;font-weight:bold;">import</span> deque
<span style="color: #66cc66;">&gt;&gt;&gt;</span> ze_deck = deque<span style="color: black;">&#40;</span>maxlen=<span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># on limite le deque à 3 éléments</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> ze_deck.<span style="color: black;">append</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> ze_deck
deque<span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span><span style="color: black;">&#93;</span>, maxlen=<span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> ze_deck.<span style="color: black;">append</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> ze_deck
deque<span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span>, maxlen=<span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> ze_deck.<span style="color: black;">append</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> ze_deck
deque<span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span>, <span style="color: #ff4500;">3</span><span style="color: black;">&#93;</span>, maxlen=<span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> ze_deck.<span style="color: black;">append</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">4</span><span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># ... et MAGIQUEMENT !</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> ze_deck
deque<span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">2</span>, <span style="color: #ff4500;">3</span>, <span style="color: #ff4500;">4</span><span style="color: black;">&#93;</span>, maxlen=<span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> ze_deck:
...     <span style="color: #ff7700;font-weight:bold;">print</span> x
...     
<span style="color: #ff4500;">2</span>
<span style="color: #ff4500;">3</span>
<span style="color: #ff4500;">4</span></pre></div></div>

<p>Bam le dernier élément est squizzé, et tout ça rapidement et efficacement. Vous voyez où je veux subtilement en venir ?</p>
<h2>Et finalement: comment on utilise l&#8217;un pour faire l&#8217;autre ?</h2>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">collections</span> <span style="color: #ff7700;font-weight:bold;">import</span> deque
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">itertools</span> <span style="color: #ff7700;font-weight:bold;">import</span> islice
<span style="color: #66cc66;">&gt;&gt;&gt;</span> 
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">def</span> window<span style="color: black;">&#40;</span>iterable, size=<span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span>:
...         <span style="color: black;">iterable</span> = <span style="color: #008000;">iter</span><span style="color: black;">&#40;</span>iterable<span style="color: black;">&#41;</span>
...         <span style="color: black;">d</span> = deque<span style="color: black;">&#40;</span>islice<span style="color: black;">&#40;</span>iterable, size<span style="color: black;">&#41;</span>, size<span style="color: black;">&#41;</span>
...         <span style="color: #ff7700;font-weight:bold;">yield</span> d
...         <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> iterable:
...                 <span style="color: black;">d</span>.<span style="color: black;">append</span><span style="color: black;">&#40;</span>x<span style="color: black;">&#41;</span>
...                 <span style="color: #ff7700;font-weight:bold;">yield</span> d
...         
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> window<span style="color: black;">&#40;</span><span style="color: #483d8b;">'azertyuiop'</span><span style="color: black;">&#41;</span>:
...         <span style="color: #ff7700;font-weight:bold;">print</span> x
...     
<span style="color: black;">deque</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #483d8b;">'a'</span>, <span style="color: #483d8b;">'z'</span><span style="color: black;">&#93;</span>, maxlen=<span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span>
deque<span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #483d8b;">'z'</span>, <span style="color: #483d8b;">'e'</span><span style="color: black;">&#93;</span>, maxlen=<span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span>
deque<span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #483d8b;">'e'</span>, <span style="color: #483d8b;">'r'</span><span style="color: black;">&#93;</span>, maxlen=<span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span>
deque<span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #483d8b;">'r'</span>, <span style="color: #483d8b;">'t'</span><span style="color: black;">&#93;</span>, maxlen=<span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span>
deque<span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #483d8b;">'t'</span>, <span style="color: #483d8b;">'y'</span><span style="color: black;">&#93;</span>, maxlen=<span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span>
deque<span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #483d8b;">'y'</span>, <span style="color: #483d8b;">'u'</span><span style="color: black;">&#93;</span>, maxlen=<span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span>
deque<span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #483d8b;">'u'</span>, <span style="color: #483d8b;">'i'</span><span style="color: black;">&#93;</span>, maxlen=<span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span>
deque<span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #483d8b;">'i'</span>, <span style="color: #483d8b;">'o'</span><span style="color: black;">&#93;</span>, maxlen=<span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span>
deque<span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #483d8b;">'o'</span>, <span style="color: #483d8b;">'p'</span><span style="color: black;">&#93;</span>, maxlen=<span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span></pre></div></div>

<p>Vous noterez au passage que nous faisons ici un usage malin des <a href="http://sametmax.com/comment-utiliser-yield-et-les-generateurs-en-python/">générateurs</a>, ce qui nous permet de retourner un itérable sans tout charger en mémoire et de slider sur notre window avec classe.</p>
<p>Ainsi on peut se la peter en faisant des trucs compliqués en une ligne comme:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: black;">&#123;</span><span style="color: #008000;">tuple</span><span style="color: black;">&#40;</span>d<span style="color: black;">&#41;</span>: i <span style="color: #ff7700;font-weight:bold;">for</span> i, d <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">enumerate</span><span style="color: black;">&#40;</span>window<span style="color: black;">&#40;</span><span style="color: #008000;">xrange</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">10</span><span style="color: black;">&#41;</span>, <span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: black;">&#125;</span>
<span style="color: black;">&#123;</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">5</span>, <span style="color: #ff4500;">6</span>, <span style="color: #ff4500;">7</span><span style="color: black;">&#41;</span>: <span style="color: #ff4500;">5</span>, <span style="color: black;">&#40;</span><span style="color: #ff4500;">0</span>, <span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span>: <span style="color: #ff4500;">0</span>, <span style="color: black;">&#40;</span><span style="color: #ff4500;">7</span>, <span style="color: #ff4500;">8</span>, <span style="color: #ff4500;">9</span><span style="color: black;">&#41;</span>: <span style="color: #ff4500;">7</span>, <span style="color: black;">&#40;</span><span style="color: #ff4500;">6</span>, <span style="color: #ff4500;">7</span>, <span style="color: #ff4500;">8</span><span style="color: black;">&#41;</span>: <span style="color: #ff4500;">6</span>, <span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span>, <span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span>: <span style="color: #ff4500;">1</span>, <span style="color: black;">&#40;</span><span style="color: #ff4500;">3</span>, <span style="color: #ff4500;">4</span>, <span style="color: #ff4500;">5</span><span style="color: black;">&#41;</span>: <span style="color: #ff4500;">3</span>, <span style="color: black;">&#40;</span><span style="color: #ff4500;">2</span>, <span style="color: #ff4500;">3</span>, <span style="color: #ff4500;">4</span><span style="color: black;">&#41;</span>: <span style="color: #ff4500;">2</span>, <span style="color: black;">&#40;</span><span style="color: #ff4500;">4</span>, <span style="color: #ff4500;">5</span>, <span style="color: #ff4500;">6</span><span style="color: black;">&#41;</span>: <span style="color: #ff4500;">4</span><span style="color: black;">&#125;</span></pre></div></div>

<p>Ce qui n&#8217;a absolument aucun intérêt, mais si vous comprenez ce que ça fait, alors vous avec bien masterisé Python.</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=3562&amp;md5=4c6fea5a598147047a770ca977fd1ee9" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/implementer-une-fenetre-glissante-en-python-avec-un-deque/feed/</wfw:commentRss>
		<slash:comments>5</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fimplementer-une-fenetre-glissante-en-python-avec-un-deque%2F&amp;language=en_GB&amp;category=text&amp;title=Impl%C3%A9menter+une+fen%C3%AAtre+glissante+en+Python+avec+un+deque&amp;description=Quand+j%26%238217%3Bentends+deque%2C+je+pense+plus+%C3%A0+un+deck+de+Magic+de+Gathering+qu%26%238217%3B%C3%A0+un+module+Python%2C+mais+aujourd%26%238217%3Bhui+j%26%238217%3Butilise+beaucoup+plus+le+dernier+que+le+pr%C3%A9c%C3%A9dent.+On+a+d%C3%A9j%C3%A0...&amp;tags=deque%2Citerable%2Cpython%2Cyield%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2012/12/gos-sliding-time-window.gif" length="7018" type="image/jpg" />	</item>
		<item>
		<title>Comment utiliser yield et les générateurs en Python ?</title>
		<link>http://sametmax.com/comment-utiliser-yield-et-les-generateurs-en-python/</link>
		<comments>http://sametmax.com/comment-utiliser-yield-et-les-generateurs-en-python/#comments</comments>
		<pubDate>Tue, 02 Oct 2012 12:09:42 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[generator]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[yield]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=2416</guid>
		<description><![CDATA[Les générateurs sont une fonctionalité fabuleuse de Python, et une étape indispensable dans la maîtrise du langage. Une fois compris, vous ne pourrez plus vous en passer.]]></description>
			<content:encoded><![CDATA[<p>Les générateurs sont une fonctionalité fabuleuse de Python, et une étape indispensable dans la maîtrise du langage. Une fois compris, <a href="http://sametmax.com/parcourir-un-iterable-par-morceaux-en-python/">vous ne pourrez plus vous en passer</a>.</p>
<h2>Rappel sur les itérables</h2>
<p>Quand vous lisez des éléments un par un d&#8217;une liste, on appelle cela l&#8217;itération:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">lst = <span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span>, <span style="color: #ff4500;">3</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">for</span> i <span style="color: #ff7700;font-weight:bold;">in</span> lst :
...     <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>i<span style="color: black;">&#41;</span>
<span style="color: #ff4500;">1</span>
<span style="color: #ff4500;">2</span>
<span style="color: #ff4500;">3</span></pre></div></div>

<p>Et quand on utilise une liste en intention, on créé une liste, donc un itérable. Encore une fois, avec une boucle <code>for</code>, on prend ses éléments un par un, donc on <em>itère</em> dessus:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">lst = <span style="color: black;">&#91;</span>x<span style="color: #66cc66;">*</span>x <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">range</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">for</span> i <span style="color: #ff7700;font-weight:bold;">in</span> lst :
...     <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>i<span style="color: black;">&#41;</span>
<span style="color: #ff4500;">0</span>
<span style="color: #ff4500;">1</span>
<span style="color: #ff4500;">4</span></pre></div></div>

<p>À chaque fois qu&#8217;on peut utiliser &#8220;<code>for</code>… <code>in</code>…&#8221; sur quelque chose, c&#8217;est un itérable : lists, strings, files…</p>
<p>Ces itérables sont pratiques car on peut les lire autant qu&#8217;on veut, mais ce n&#8217;est pas toujours idéal car on doit stocker tous les éléments en mémoire. </p>
<h2>Les générateurs</h2>
<p>Si vous vous souvenez de l&#8217;article sur <a href="http://sametmax.com/python-love-les-listes-en-intention-partie/">les comprehension lists</a>, on peut également créer des expressions génératrices:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">generateur = <span style="color: black;">&#40;</span>x<span style="color: #66cc66;">*</span>x <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">range</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">for</span> i <span style="color: #ff7700;font-weight:bold;">in</span> generateur :
...     <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>i<span style="color: black;">&#41;</span>
<span style="color: #ff4500;">0</span>
<span style="color: #ff4500;">1</span>
<span style="color: #ff4500;">4</span></pre></div></div>

<p>La seule différence avec précédemment, c&#8217;est qu&#8217;on utilise <code>()</code> au lieu de <code>[]</code>. Mais on ne peut pas lire <code>generateur</code> une seconde fois car le principe des générateurs, c&#8217;est justement qu&#8217;ils génèrent tout à la volée: ici il calcule <code>0</code>, puis l&#8217;oublie, puis calcule <code>1</code>, et l&#8217;oublie, et calcule <code>4</code>. Tout ça un par un.</p>
<h2>Le mot clé yield</h2>
<p><code>yield</code> est un mot clé utilisé en lieu et place de <code>return</code>, à la différence prêt qu&#8217;on va récupérer un générateur.</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">def</span> creerGenerateur<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> :
...     <span style="color: black;">mylist</span> = <span style="color: #008000;">range</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span>
...     <span style="color: #ff7700;font-weight:bold;">for</span> i <span style="color: #ff7700;font-weight:bold;">in</span> mylist:
...         <span style="color: #ff7700;font-weight:bold;">yield</span> i<span style="color: #66cc66;">*</span>i
...
<span style="color: #66cc66;">&gt;&gt;&gt;</span> generateur = creerGenerateur<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># crée un générateur</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>generateur<span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># generateur est un objet !</span>
<span style="color: #66cc66;">&lt;</span> generator <span style="color: #008000;">object</span> creerGenerateur at 0x2b484b9addc0<span style="color: #66cc66;">&gt;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">for</span> i <span style="color: #ff7700;font-weight:bold;">in</span> generateur:
...     <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>i<span style="color: black;">&#41;</span>
<span style="color: #ff4500;">0</span>
<span style="color: #ff4500;">1</span>
<span style="color: #ff4500;">4</span></pre></div></div>

<p>Ici c&#8217;est un exemple inutile, mais dans la vraie vie vivante, c&#8217;est pratique quand on sait que la fonction va retourner de nombreuses valeurs qu&#8217;on ne souhaite lire qu&#8217;une seule fois.</p>
<p>Le secret des maîtres Zen qui ont acquis la compréhension transcendantale de <code>yield</code>, c&#8217;est de savoir que <strong>quand on appelle la fonction, le code de la fonction n&#8217;est pas exécute</strong>. A la place, la fonction va retourner un objet générateur.</p>
<p>C&#8217;est pas évident à comprendre, alors relisez plusieurs fois cette partie.</p>
<p><code>creerGenerateur()</code> n’exécute pas le code de <code>creerGenerateur</code>. </p>
<p><code>creerGenerateur()</code> retourne un objet générateur.</p>
<p>En fait, <strong>tant qu&#8217;on ne touche pas au générateur, il ne se passe rien</strong>. Puis, <strong>dès qu&#8217;on commence à itérer sur le générateur, le code de la fonction s’exécute</strong>.</p>
<p>La première fois que le code s&#8217;éxécute, il va partir du début de la fonction, arriver jusqu&#8217;à <code>yield</code>, et retourner la première valeur. Ensuite, à chaque nouveau tour de boucle, le code va reprendre de la où il s&#8217;est arrêté (oui, Python sauvegarde l&#8217;état du code du générateur entre chaque appel), et exécuter le code à nouveau jusqu&#8217;à ce qu&#8217;il rencontre <code>yield</code>. Donc dans notre cas, il va faire un tour de boucle. </p>
<p>Il va continuer comme ça jusqu&#8217;à ce que le code ne rencontre plus <code>yield</code>, et donc qu&#8217;il n&#8217;y a plus de valeur à retourner. Le générateur est alors considéré comme définitivement vide. Il ne peut pas être &#8220;rembobiné&#8221;, il faut en créer un autre.</p>
<p>La raison pour laquelle le code ne rencontre plus yield est celle de votre choix: condition <code>if</code>/<code>else</code>, boucle, recursion&#8230; Vous pouvez même yielder à l&#8217;infini.</p>
<h2>Un exemple concret et un café, plz</h2>
<p><code>yield</code> permet non seulement d&#8217;économiser de la mémoire, mais surtout de masquer la complexité d&#8217;un algo derrière une API classique d&#8217;itération.</p>
<p>Supposez que vous ayez une fonction qui &#8211; tada ! &#8211; extrait les mots de plus de 3 caractères de tous les fichiers d&#8217;un dossier.</p>
<p>Elle pourrait ressembler à ça:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">os</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> extraire_mots<span style="color: black;">&#40;</span>dossier<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">for</span> fichier <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #dc143c;">os</span>.<span style="color: black;">listdir</span><span style="color: black;">&#40;</span>dossier<span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">with</span> <span style="color: #008000;">open</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">os</span>.<span style="color: black;">path</span>.<span style="color: black;">join</span><span style="color: black;">&#40;</span>dossier, fichier<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">as</span> f:
            <span style="color: #ff7700;font-weight:bold;">for</span> ligne <span style="color: #ff7700;font-weight:bold;">in</span> f:
                <span style="color: #ff7700;font-weight:bold;">for</span> mot <span style="color: #ff7700;font-weight:bold;">in</span> ligne.<span style="color: black;">split</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
                    <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #008000;">len</span><span style="color: black;">&#40;</span>mot<span style="color: black;">&#41;</span> <span style="color: #66cc66;">&gt;</span> <span style="color: #ff4500;">3</span>:
                        <span style="color: #ff7700;font-weight:bold;">yield</span> mot</pre></div></div>

<p>Vous avez là un algo dont on masque complètement la complexité, car du point de vue de l&#8217;utilisateur, il fait juste ça:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">for</span> mot <span style="color: #ff7700;font-weight:bold;">in</span> extraire_mots<span style="color: black;">&#40;</span>dossier<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">print</span> mot</pre></div></div>

<p>Et pour lui c&#8217;est transparent. En plus, il peut utiliser tous les outils qu&#8217;on utilise sur les itérables d&#8217;habitude. Toutes les fonctions qui acceptent les itérables acceptent donc le résultat de la fonction en paramètre grâce à la magie du duck typing. On créé ainsi une merveilleuse toolbox.</p>
<h2>Controller yield</h2>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">class</span> DistributeurDeCapote<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    stock = <span style="color: #008000;">True</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> allumer<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">while</span> <span style="color: #008000;">self</span>.<span style="color: black;">stock</span>:
            <span style="color: #ff7700;font-weight:bold;">yield</span> <span style="color: #483d8b;">&quot;capote&quot;</span>
...</pre></div></div>

<p>Tant qu&#8217;il y a du stock, on peut récupérer autant de capotes que l&#8217;on veut.</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> distributeur_en_bas_de_la_rue = DistributeurDeCapote<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> distribuer = distributeur_en_bas_de_la_rue.<span style="color: black;">allumer</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">print</span> distribuer.<span style="color: black;">next</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
capote
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">print</span> distribuer.<span style="color: black;">next</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
capote
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span>distribuer.<span style="color: black;">next</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> c <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">range</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">4</span><span style="color: black;">&#41;</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
<span style="color: black;">&#91;</span><span style="color: #483d8b;">'capote'</span>, <span style="color: #483d8b;">'capote'</span>, <span style="color: #483d8b;">'capote'</span>, <span style="color: #483d8b;">'capote'</span><span style="color: black;">&#93;</span></pre></div></div>

<p>Dès qu&#8217;il n&#8217;y a plus de stock&#8230;</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> distributeur_en_bas_de_la_rue.<span style="color: black;">stock</span> = <span style="color: #008000;">False</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> distribuer.<span style="color: black;">next</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
Traceback <span style="color: black;">&#40;</span>most recent call last<span style="color: black;">&#41;</span>:
  File <span style="color: #483d8b;">&quot;&lt;ipython-input-22-389e61418395&gt;&quot;</span>, line <span style="color: #ff4500;">1</span>, <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #66cc66;">&lt;</span>module<span style="color: #66cc66;">&gt;</span>
    distribuer.<span style="color: black;">next</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #008000;">StopIteration</span>
<span style="color: #66cc66;">&lt;</span> <span style="color: #008000;">type</span> <span style="color: #483d8b;">'exceptions.StopIteration'</span><span style="color: #66cc66;">&gt;</span></pre></div></div>

<p>Et c&#8217;est vrai pour tout nouveau générateur:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> distribuer = distributeur_en_bas_de_la_rue.<span style="color: black;">allumer</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> distribuer.<span style="color: black;">next</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
Traceback <span style="color: black;">&#40;</span>most recent call last<span style="color: black;">&#41;</span>:
  File <span style="color: #483d8b;">&quot;&lt;ipython-input-24-389e61418395&gt;&quot;</span>, line <span style="color: #ff4500;">1</span>, <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #66cc66;">&lt;</span>module<span style="color: #66cc66;">&gt;</span>
    distribuer.<span style="color: black;">next</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #008000;">StopIteration</span></pre></div></div>

<p>Allumer une machine vide n&#8217;a jamais permis de remplir le stock ;-) Mais il suffit de remplir le stock pour repartir comme en 40:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> distributeur_en_bas_de_la_rue.<span style="color: black;">stock</span> = <span style="color: #008000;">True</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> distribuer = distributeur_en_bas_de_la_rue.<span style="color: black;">allumer</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">for</span> c <span style="color: #ff7700;font-weight:bold;">in</span> distribuer :
...     <span style="color: #ff7700;font-weight:bold;">print</span> c
capote
capote
capote
capote
capote
capote
capote
capote
capote
capote
capote
capote
...</pre></div></div>

<h2><code>itertools</code>: votre nouveau module favori</h2>
<p>Le truc avec les générateurs, c&#8217;est qu&#8217;il faut les manipuler en prenant en compte leur nature: on ne peut les lire qu&#8217;une fois, et on ne peut pas déterminer leur longeur à l&#8217;avance. <code>itertools</code> est un module spécialisé la dedans: <code>map</code>, <code>zip</code>, <code>slice</code>&#8230; Il contient des fonctions qui marchent sur tous les itérables, y compris les générateurs.</p>
<p>Et rappelez-vous, les strings, les listes, les sets et même les fichiers sont itérables.</p>
<p>Chaîner deux itérables, et prendre les 10 premiers caractères ? Piece of cake !</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">itertools</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> d = DistributeurDeCapote<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>.<span style="color: black;">allumer</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> generateur = <span style="color: #dc143c;">itertools</span>.<span style="color: black;">chain</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;12345&quot;</span>, d<span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> generateur = <span style="color: #dc143c;">itertools</span>.<span style="color: black;">islice</span><span style="color: black;">&#40;</span>generateur, <span style="color: #ff4500;">0</span>, <span style="color: #ff4500;">10</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> generateur:
...     <span style="color: #ff7700;font-weight:bold;">print</span> x
...     
<span style="color: #ff4500;">1</span>
<span style="color: #ff4500;">2</span>
<span style="color: #ff4500;">3</span>
<span style="color: #ff4500;">4</span>
<span style="color: #ff4500;">5</span>
capote
capote
capote
capote
capote</pre></div></div>

<h2>Les dessous de l&#8217;itération</h2>
<p>Sous le capôt, tous les itérables utilisent un générateur appelé &#8220;itérateur&#8221;. On peut récupérer l&#8217;itérateur en utiliser la fonction <code>iter()</code> sur un itérable:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">iter</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span>, <span style="color: #ff4500;">3</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&lt;</span> listiterator <span style="color: #008000;">object</span> at 0x7f58b9735dd0<span style="color: #66cc66;">&gt;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">iter</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span>, <span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&lt;</span> tupleiterator <span style="color: #008000;">object</span> at 0x7f58b9735e10<span style="color: #66cc66;">&gt;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">iter</span><span style="color: black;">&#40;</span>x<span style="color: #66cc66;">*</span>x <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span>, <span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&lt;</span> generator <span style="color: #008000;">object</span>  at 0x7f58b9723820<span style="color: #66cc66;">&gt;</span></pre></div></div>

<p>Les itérateurs ont une méthode next() qui retourne une valeur pour chaque appel de la méthode. Quand il n&#8217;y a plus de valeur, ils lèvent l&#8217;exception <code>StopIteration</code>:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> gen = <span style="color: #008000;">iter</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span>, <span style="color: #ff4500;">3</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> gen.<span style="color: black;">next</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #ff4500;">1</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> gen.<span style="color: black;">next</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #ff4500;">2</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> gen.<span style="color: black;">next</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #ff4500;">3</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> gen.<span style="color: black;">next</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
Traceback <span style="color: black;">&#40;</span>most recent call last<span style="color: black;">&#41;</span>:
  File <span style="color: #483d8b;">&quot;&lt; stdin&gt;&quot;</span>, line <span style="color: #ff4500;">1</span>, <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #66cc66;">&lt;</span> module<span style="color: #66cc66;">&gt;</span>
<span style="color: #008000;">StopIteration</span></pre></div></div>

<p>Message à tous ceux qui pensent que je fabule quand je dis qu&#8217;en Python on utilise les exceptions pour contrôler le flux d&#8217;un programme (sacrilège !): ceci est le mécanisme des boucles interne en Python. Les boucles <code>for</code> utilisent <strong>iter()</strong> pour créer un générateur, puis attrappent une exception pour s&#8217;arrêter. <strong>À chaque boucle <code>for</code>, vous levez une exception sans le savoir</strong>.</p>
<p>Pour la petite histoire, l&#8217;implémentation actuelle est que <strong>iter()</strong> appelle la méthode <strong>__iter__()</strong> sur l&#8217;objet passé en paramètre. Donc ça veut dire que vous pouvez créer vos propres itérables:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">class</span> MonIterableRienQuaMoi<span style="color: black;">&#40;</span><span style="color: #008000;">object</span><span style="color: black;">&#41;</span>:
...     <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__iter__</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
...         <span style="color: #ff7700;font-weight:bold;">yield</span> <span style="color: #483d8b;">'Python'</span>
...         <span style="color: #ff7700;font-weight:bold;">yield</span> <span style="color: #483d8b;">&quot;ça&quot;</span>
...         <span style="color: #ff7700;font-weight:bold;">yield</span> <span style="color: #483d8b;">'déchire'</span>
...
<span style="color: #66cc66;">&gt;&gt;&gt;</span> gen = <span style="color: #008000;">iter</span><span style="color: black;">&#40;</span>MonIterableRienQuaMoi<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> gen.<span style="color: black;">next</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #483d8b;">'Python'</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> gen.<span style="color: black;">next</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #483d8b;">'ça'</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> gen.<span style="color: black;">next</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #483d8b;">'déchire'</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> gen.<span style="color: black;">next</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
Traceback <span style="color: black;">&#40;</span>most recent call last<span style="color: black;">&#41;</span>:
  File <span style="color: #483d8b;">&quot;&lt; stdin&gt;&quot;</span>, line <span style="color: #ff4500;">1</span>, <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #66cc66;">&lt;</span> module<span style="color: #66cc66;">&gt;</span>
<span style="color: #008000;">StopIteration</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> MonIterableRienQuaMoi<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
...     <span style="color: #ff7700;font-weight:bold;">print</span> x
...
<span style="color: black;">Python</span>
ça
déchire</pre></div></div>

 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=2416&amp;md5=a3c74c9b3dd5999cc7b64195ba1e3e63" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/comment-utiliser-yield-et-les-generateurs-en-python/feed/</wfw:commentRss>
		<slash:comments>8</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fcomment-utiliser-yield-et-les-generateurs-en-python%2F&amp;language=en_GB&amp;category=text&amp;title=Comment+utiliser+yield+et+les+g%C3%A9n%C3%A9rateurs+en+Python+%3F&amp;description=Les+g%C3%A9n%C3%A9rateurs+sont+une+fonctionalit%C3%A9+fabuleuse+de+Python%2C+et+une+%C3%A9tape+indispensable+dans+la+ma%C3%AEtrise+du+langage.+Une+fois+compris%2C+vous+ne+pourrez+plus+vous+en+passer.+Rappel+sur+les...&amp;tags=generator%2Cpython%2Cyield%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2012/10/200808301718_zoom.jpg" length="37594" type="image/jpg" />	</item>
		<item>
		<title>Les context managers et le mot clé with en Python</title>
		<link>http://sametmax.com/les-context-managers-et-le-mot-cle-with-en-python/</link>
		<comments>http://sametmax.com/les-context-managers-et-le-mot-cle-with-en-python/#comments</comments>
		<pubDate>Mon, 03 Sep 2012 17:56:43 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[contextmanager]]></category>
		<category><![CDATA[decorator]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[with]]></category>
		<category><![CDATA[yield]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=1987</guid>
		<description><![CDATA[Le mot clé with est utilisé comme dans aucun autre langage en Python. Au premier abord mystérieux, il agit en fait comme les décorateurs en permettant d&#8217;exécuter du code automatiquement avant et après un autre code. Mais à l&#8217;image des décorateurs, tout ce qu&#8217;il fait pourrait être écrit à la main sans utiliser le mot [...]]]></description>
			<content:encoded><![CDATA[<p>Le mot clé <code>with</code> est utilisé comme dans aucun autre langage en Python. Au premier abord mystérieux, il agit en fait comme les <a href="http://sametmax.com/comprendre-les-decorateurs-python-pas-a-pas-partie-1/">décorateurs</a> en permettant d&#8217;exécuter du code automatiquement avant et après un autre code. Mais à l&#8217;image des décorateurs, tout ce qu&#8217;il fait pourrait être écrit à la main sans utiliser le mot clé <code>with</code>. Utiliser <code>with</code> est <a href="http://sametmax.com/jadore-les-context-managers-python/">une question de style</a>.</p>
<p>Supposons que vous vouliez afficher quelque chose avant un bout de code, et après un bout de code, même si celui-ci rate. Vous feriez quelque chose comme ça:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> truc<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;machin&quot;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Avant&quot;</span>
<span style="color: #ff7700;font-weight:bold;">try</span>:
    truc<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">finally</span>:
    <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Après&quot;</span></pre></div></div>

<p>Et ça va afficher:</p>
<pre>Avant
machin
Après</pre>
<p>Et avec:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> truc<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;machin&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">raise</span> <span style="color: #008000;">Exception</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'Fail !'</span><span style="color: black;">&#41;</span></pre></div></div>

<p>&#8216;Après&#8217; sera quand même affiché. Ça plantera, mais la dernière action sera toujours faite.</p>
<p>Si vous le faites souvent, vous voudrez factoriser du code. Un des moyens de le faire est d&#8217;utiliser les context managers.</p>
<h2>Créer son propre context manager</h2>
<p>Un context manager est une classe <strong>ordinaire</strong> en Python. Sa seule spécificité est de déclarer une méthode <code>__enter__()</code> et une méthode <code>__exit__()</code>. Ces méthodes sont des méthodes <strong>ordinaires</strong>, leur nom spécial est juste là par convention, et en les nommant ainsi on s&#8217;assure qu&#8217;elles seront détectées et utilisées automatiquement.</p>
<p>Notre code là haut peut donc se réécrire ainsi:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">class</span> MonSuperContextManager<span style="color: black;">&#40;</span><span style="color: #008000;">object</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">def</span> __enter__<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Avant&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> __exit__<span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, <span style="color: #008000;">type</span>, value, <span style="color: #dc143c;">traceback</span><span style="color: black;">&#41;</span>:
        <span style="color: #808080; font-style: italic;"># faites pas attention aux paramètres, ce sont toutes les infos</span>
        <span style="color: #808080; font-style: italic;"># automatiquement passées à __exit__ et qui servent pour inspecter</span>
        <span style="color: #808080; font-style: italic;"># une éventuelle exception</span>
        <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Après&quot;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">with</span> MonSuperContextManager<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    truc<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre></div></div>

<p>L&#8217;avantage de with est multiple:</p>
<ul>
<li>Il permet de visualiser très précisément où on entre dans l&#8217;action et où on en sort (c&#8217;est un seul block)</li>
<li>Il permet de réutiliser les actions faite à l&#8217;entrée et à la sortie de l&#8217;action.</li>
<li>Même si une exception est levée, l&#8217;action de sortie sera exécutée juste avant le plantage. <code>__exit__</code> est en effet garantie d&#8217;être appelée quoiqu&#8217;il arrive. Bon, évidement, si il y a une coupure de courant&#8230;</li>
</ul>
<p>En gros, créer un context manager, c&#8217;est faire un raccourci lisible pour <code>try</code>/<code>finally</code>. Point.</p>
<h2>Un exemple utile de context manager</h2>
<p>Supposons que vous ayez beaucoup de travail à faire dans plein de dossiers. Vous voulez vous assurer que vous allez dans le dossier de travail, puis que vous retournez au dossier initial à chaque fois.</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">os</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">class</span> Cd<span style="color: black;">&#40;</span>objet<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__init__</span><span style="color: black;">&#40;</span>dirname<span style="color: black;">&#41;</span>:
        <span style="color: #008000;">self</span>.<span style="color: black;">dirname</span> = dirname
    <span style="color: #ff7700;font-weight:bold;">def</span> __enter__<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #008000;">self</span>.<span style="color: black;">curdir</span> = <span style="color: #dc143c;">os</span>.<span style="color: black;">getcwd</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
        <span style="color: #dc143c;">os</span>.<span style="color: black;">chdir</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">dirname</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> __exit__<span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, <span style="color: #008000;">type</span>, value, <span style="color: #dc143c;">traceback</span><span style="color: black;">&#41;</span>:
        <span style="color: #dc143c;">os</span>.<span style="color: black;">chdir</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">curdir</span><span style="color: black;">&#41;</span></pre></div></div>

<p>On l&#8217;utilise comme ça:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #808080; font-style: italic;"># ici on est dans /home/moi</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">with</span> Cd<span style="color: black;">&#40;</span><span style="color: #483d8b;">'/'</span><span style="color: black;">&#41;</span>:
&nbsp;
    <span style="color: #808080; font-style: italic;"># faire un truc dans /</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">with</span> Cd<span style="color: black;">&#40;</span><span style="color: #483d8b;">'/opt'</span><span style="color: black;">&#41;</span>:
&nbsp;
        <span style="color: #808080; font-style: italic;"># faire un truc dans /opt</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># ici on est dans /</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># ici on est dans /home/moi</span></pre></div></div>

<p>C&#8217;est d&#8217;ailleurs ce que fait <a href="http://sametmax.com/travailler-moins-pour-gagner-plus-en-15-minutes-avec-python-fabric/">fabric</a>.</p>
<h2>Le mot clé <code>as</code></h2>
<p>Tout ce qu&#8217;on retourne dans <code>__enter__</code> peut être récupéré grâce au mot clé <code>as</code>. Imaginons un context manager qui permette d&#8217;ouvrir un fichier et de le fermer automatiquement:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">class</span> OpenFile<span style="color: black;">&#40;</span>objet<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__init__</span><span style="color: black;">&#40;</span>filename, mode=<span style="color: #483d8b;">'r'</span><span style="color: black;">&#41;</span>:
        <span style="color: #008000;">self</span>.<span style="color: black;">filename</span> = filename
        <span style="color: #008000;">self</span>.<span style="color: black;">mode</span> = mode
    <span style="color: #ff7700;font-weight:bold;">def</span> __enter__<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #008000;">self</span>.<span style="color: #008000;">file</span> = <span style="color: #008000;">open</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">filename</span>, <span style="color: #008000;">self</span>.<span style="color: black;">mode</span><span style="color: black;">&#41;</span>
        <span style="color: #808080; font-style: italic;"># ici on retourne l'objet fichier, il sera accessible avec &quot;as&quot;</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">self</span>.<span style="color: #008000;">file</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> __exit__<span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, <span style="color: #008000;">type</span>, value, <span style="color: #dc143c;">traceback</span><span style="color: black;">&#41;</span>:
        <span style="color: #008000;">self</span>.<span style="color: #008000;">file</span>.<span style="color: black;">close</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre></div></div>

<p>On l&#8217;utilise comme ceci:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">with</span> OpenFile<span style="color: black;">&#40;</span><span style="color: #483d8b;">'/etc/fstab'</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">as</span> f:
    <span style="color: #ff7700;font-weight:bold;">for</span> line <span style="color: #ff7700;font-weight:bold;">in</span> f:
        <span style="color: #ff7700;font-weight:bold;">print</span> f</pre></div></div>

<p><code>f</code> va contenir ici l&#8217;objet fichier, car nous l&#8217;avons retourné dans <code>__enter__</code>. A la fin du bloc <code>with</code>, le fichier sera fermé automatiquement.</p>
<p>Et devinez quoi, Python possède déjà un context manager qui fait ça:.</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">with</span> <span style="color: #008000;">open</span><span style="color: black;">&#40;</span>vot_fichier_msieu_dames<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">as</span> f:
   <span style="color: #808080; font-style: italic;"># faire un truc</span></pre></div></div>

<h2>Context managers sous forme de fonctions</h2>
<p>Faire les choses sous forme de classes, c&#8217;est pratique quand on a beaucoup de logique à encapsuler. Mais la plupart des context managers sont très simples. Pour cette raison, Python vient avec plein d&#8217;outils pour se simplifier la vie avec <code>with</code> dans un module judicieusement nommé <code>contextlib</code>.</p>
<p>Pour l&#8217;utiliser, il faut avoir des notions sur les décorateurs, et le mot clé <a href="http://sametmax.com/comment-utiliser-yield-et-les-generateurs-en-python/">yield</a>. Si ce n&#8217;est pas votre cas, restez sur la version sous forme de classe :-)</p>
<p>Supposons que l&#8217;on veuille recréer le context manager <code>open</code>:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">from</span> contextlib <span style="color: #ff7700;font-weight:bold;">import</span> contextmanager
&nbsp;
@contextmanager
<span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #008000;">open</span><span style="color: black;">&#40;</span>filename, mode<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">try</span>:
        f = <span style="color: #008000;">open</span><span style="color: black;">&#40;</span>filename, mode<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">yield</span> f
    <span style="color: #ff7700;font-weight:bold;">finally</span>:
        f.<span style="color: black;">close</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre></div></div>

<p>Bon, c&#8217;est simplifié, hein, le vrai est plus robuste que ça.</p>
<p>Comment ça marche ?</p>
<p>D&#8217;abord, on utilise le décorateur <code>@contextmanager</code> pour dire à Python que la fonction sera un context manager.</p>
<p>Ensuite, on fait un <code>try</code>/<code>finally</code> (il est pas automatique comme avec <code>__enter__</code> et <code>__exit__</code>).</p>
<p><code>yield</code> sépare le code en deux: tout ce qui est avant est l&#8217;équivalent de <code>__enter__</code>, tout ce qui est après est l&#8217;équivalent de <code>__exit__</code>. Ce qui est &#8220;yieldé&#8221; est ce que l&#8217;on récupère avec le mot clé <code>as</code>.</p>
<h2>Context manager et décorateur, le shampoing deux en un</h2>
<p>Ces deux fonctionnalités se ressemblent beaucoup: elles permettent toutes les deux de lancer du code automatiquement avant et après un code tiers. La seule différence est que le context manager le fait à la demande, alors que le décorateur s&#8217;applique à la définition d&#8217;une fonction.</p>
<p>Quand on sait comment ils marchent, il est facile de faire un context manager utilisable également en tant que décorateur.</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">from</span> functools <span style="color: #ff7700;font-weight:bold;">import</span> wraps
&nbsp;
<span style="color: #ff7700;font-weight:bold;">class</span> ContextDecorator<span style="color: black;">&#40;</span><span style="color: #008000;">object</span><span style="color: black;">&#41;</span>:
    <span style="color: #808080; font-style: italic;"># __call__ est une méthode magique appelée quand on utilise () sur un objet</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__call__</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, f<span style="color: black;">&#41;</span>:
        <span style="color: #808080; font-style: italic;"># bon, cette partie là suppose que vous savez comment marche un</span>
        <span style="color: #808080; font-style: italic;"># décorateur, si c'est pas le cas, retournez lire l'article sur S&amp;amp;M</span>
        <span style="color: #808080; font-style: italic;"># linké dans le premier paragraphe</span>
        @wraps<span style="color: black;">&#40;</span>f<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">def</span> decorated<span style="color: black;">&#40;</span><span style="color: #66cc66;">*</span>args, <span style="color: #66cc66;">**</span>kwds<span style="color: black;">&#41;</span>:
            <span style="color: #808080; font-style: italic;"># notez le with appelé sur soi-même, c'est y pas mignon !</span>
            <span style="color: #ff7700;font-weight:bold;">with</span> <span style="color: #008000;">self</span>:
                <span style="color: #ff7700;font-weight:bold;">return</span> f<span style="color: black;">&#40;</span><span style="color: #66cc66;">*</span>args, <span style="color: #66cc66;">**</span>kwds<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> decorated</pre></div></div>

<p>Et voilà, il suffit d&#8217;hériter de ça, et on a un décorateur + context manager. Par exemple, si on veut timer un truc:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">datetime</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">class</span> TimeIt<span style="color: black;">&#40;</span>ContextDecorator<span style="color: black;">&#41;</span>:
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> __enter__<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #008000;">self</span>.<span style="color: black;">start</span> = <span style="color: #dc143c;">datetime</span>.<span style="color: black;">dateime</span>.<span style="color: black;">now</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #008000;">self</span>.<span style="color: black;">start</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> __exit__<span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, <span style="color: #008000;">type</span>, value, <span style="color: #dc143c;">traceback</span><span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: black;">&#40;</span><span style="color: #dc143c;">datetime</span>.<span style="color: #dc143c;">datetime</span>.<span style="color: black;">now</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> -<span style="color: #008000;">self</span>.<span style="color: black;">start</span><span style="color: black;">&#41;</span>.<span style="color: black;">total_seconds</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre></div></div>

<p>Timer juste un appel:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> foo<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    <span style="color: #808080; font-style: italic;"># faire un truc</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">with</span> TimeIt<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    foo<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre></div></div>

<p>Timer tous les appels:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">@TimeIt
<span style="color: #ff7700;font-weight:bold;">def</span> foo<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
   <span style="color: #808080; font-style: italic;"># faire un truc</span></pre></div></div>

<p>Notez que <a href="http://docs.python.org/py3k/library/contextlib.html#contextlib.ContextDecorator">ContextDecorator</a> est présent par défaut dans le module <code>contextlib</code> sous Python 3.2.</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=1987&amp;md5=93ddc73ad56deb6342f729382b753f07" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/les-context-managers-et-le-mot-cle-with-en-python/feed/</wfw:commentRss>
		<slash:comments>9</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fles-context-managers-et-le-mot-cle-with-en-python%2F&amp;language=en_GB&amp;category=text&amp;title=Les+context+managers+et+le+mot+cl%C3%A9+with+en+Python&amp;description=Le+mot+cl%C3%A9+with+est+utilis%C3%A9+comme+dans+aucun+autre+langage+en+Python.+Au+premier+abord+myst%C3%A9rieux%2C+il+agit+en+fait+comme+les+d%C3%A9corateurs+en+permettant+d%26%238217%3Bex%C3%A9cuter+du+code+automatiquement...&amp;tags=contextmanager%2Cdecorator%2Cpython%2Cwith%2Cyield%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2012/09/shampooing-demelant-chien-demavic-laboratoire-2-1-z-345-34502.jpg" length="25075" type="image/jpg" />	</item>
		<item>
		<title>Astuces Python en vrac</title>
		<link>http://sametmax.com/astuces-python-en-vrac/</link>
		<comments>http://sametmax.com/astuces-python-en-vrac/#comments</comments>
		<pubDate>Fri, 03 Aug 2012 13:15:35 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[import]]></category>
		<category><![CDATA[iterable]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[slice]]></category>
		<category><![CDATA[yield]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=1463</guid>
		<description><![CDATA[Je n'arrive pas à trouver un lien entre tous ces trucs, alors un bon vrac fera l'affaire.]]></description>
			<content:encoded><![CDATA[<p>Je n&#8217;arrive pas à trouver un lien entre tous ces trucs, alors un bon vrac fera l&#8217;affaire.</p>
<h2>Float accepte de parser l&#8217;infini<br />
</h2>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> infini = <span style="color: #008000;">float</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'inf'</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> infini
inf
<span style="color: #66cc66;">&gt;&gt;&gt;</span> infini + <span style="color: #ff4500;">1</span>
inf
<span style="color: #66cc66;">&gt;&gt;&gt;</span> infini - <span style="color: #ff4500;">1</span>
inf
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">float</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'-inf'</span><span style="color: black;">&#41;</span>
-inf
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">float</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'-inf'</span><span style="color: black;">&#41;</span> + <span style="color: #ff4500;">1</span>
-inf
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">float</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'inf'</span><span style="color: black;">&#41;</span> + <span style="color: #008000;">float</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'-inf'</span><span style="color: black;">&#41;</span>
nan</pre></div></div>

<p>Attention, il est très probable que ce soit dépendant de l&#8217;implémentation CPython.</p>
<h2><code>Iter()</code> peut prendre un callable en argument</h2>
<p><code>iter()</code>, c&#8217;est la fonction qui créé un générateur à partir d&#8217;un itérable:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> generateur = <span style="color: #008000;">iter</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span>, <span style="color: #ff4500;">3</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> generateur.<span style="color: black;">next</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #ff4500;">1</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> generateur.<span style="color: black;">next</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #ff4500;">2</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> generateur.<span style="color: black;">next</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #ff4500;">3</span></pre></div></div>

<p>Il se trouve qu&#8217;il a aussi une autre forme: <code>iter(callable, sentinel)</code>.</p>
<p>Sous cette forme, il va créer une générateur qui appelle <code>callable</code> jusqu&#8217;à ce que la valeur <code>sentinel</code> apparaisse.</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">datetime</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #dc143c;">datetime</span>.<span style="color: #dc143c;">datetime</span>.<span style="color: black;">now</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>.<span style="color: black;">strftime</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;%S&quot;</span><span style="color: black;">&#41;</span>
<span style="color: #483d8b;">'45'</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> generateur = <span style="color: #008000;">iter</span><span style="color: black;">&#40;</span><span style="color: #ff7700;font-weight:bold;">lambda</span>: <span style="color: #dc143c;">datetime</span>.<span style="color: #dc143c;">datetime</span>.<span style="color: black;">now</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>.<span style="color: black;">strftime</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;%S&quot;</span><span style="color: black;">&#41;</span>, <span style="color: #483d8b;">&quot;59&quot;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> generateur.<span style="color: black;">next</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #483d8b;">'56'</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> generateur.<span style="color: black;">next</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #483d8b;">'57'</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> generateur.<span style="color: black;">next</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #483d8b;">'58'</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> generateur.<span style="color: black;">next</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
Traceback <span style="color: black;">&#40;</span>most recent call last<span style="color: black;">&#41;</span>:
  File <span style="color: #483d8b;">&quot;&lt;ipython-input-45-6c9f9efdd35c&gt;&quot;</span>, line <span style="color: #ff4500;">1</span>, <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #66cc66;">&lt;</span>module<span style="color: #66cc66;">&gt;</span>
    generateur.<span style="color: black;">next</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #008000;">StopIteration</span></pre></div></div>

<h2>Chainer les comparateurs</h2>
<p>Histoire de diminuer le nombre de <code>if</code>:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> a, b, c, d = <span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span>, <span style="color: #ff4500;">3</span>, <span style="color: #ff4500;">4</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> a <span style="color: #66cc66;">&lt;</span> b <span style="color: #66cc66;">&lt;</span> c <span style="color: #66cc66;">&lt;</span> d
<span style="color: #008000;">True</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> a == <span style="color: #ff4500;">1</span> <span style="color: #66cc66;">&gt;</span> b -<span style="color: #ff4500;">2</span>
<span style="color: #008000;">True</span></pre></div></div>

<h2>Le mot clé <code>else</code>, en dehors de <code>if</code></h2>
<p><code>Else</code> ne s&#8217;applique pas qu&#8217;aux conditions, mais aussi aux exceptions et aux boucles.</p>
<p>Dans une boucle for, la clause <code>else</code> est exécutée à la fin de l&#8217;itération si il n&#8217;y a pas eu de <code>break</code>.</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">random</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> lst = <span style="color: black;">&#91;</span><span style="color: #dc143c;">random</span>.<span style="color: black;">randint</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">5</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">xrange</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">5</span><span style="color: black;">&#41;</span><span style="color: black;">&#93;</span>
... <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> lst:
...     <span style="color: #ff7700;font-weight:bold;">if</span> x == <span style="color: #ff4500;">5</span>:
...         <span style="color: #ff7700;font-weight:bold;">break</span>
... <span style="color: #ff7700;font-weight:bold;">else</span>:
...     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;5 n'a jamais été trouvé&quot;</span></pre></div></div>

<p>Dans la gestion des exceptions, <code>else</code> est éxécuté si <code>catch</code> n&#8217;est jamais appelé:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">try</span>:
    <span style="color: #008000;">open</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'fichier'</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: #008000;">IOError</span>:
    <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Une IO Error est arrivée&quot;</span>
<span style="color: #ff7700;font-weight:bold;">else</span>:
    <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Tout s'est bien passé&quot;</span>
<span style="color: #ff7700;font-weight:bold;">finally</span>:
    <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Toujours éxécuté&quot;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Exécuté si on est rentré dans except ou else&quot;</span></pre></div></div>

<h2>Continuation de lignes avec les parenthèses</h2>
<p><code>\</code> sur les longues lignes, ça va 5 minutes.</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">from</span> force <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: black;">&#40;</span>rouge, bleu, jaune, vert, noir, blanc, rose, fushia,
                   vermeille, vers_a_pois_jaune, call<span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># ici le multi line édit de sublime text m'a vachement aidé</span>
<span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: black;">&#40;</span>rouge.<span style="color: black;">transformation</span> <span style="color: #ff7700;font-weight:bold;">and</span> bleu.<span style="color: black;">transformation</span> <span style="color: #ff7700;font-weight:bold;">and</span> jaune.<span style="color: black;">transformation</span>
        <span style="color: #ff7700;font-weight:bold;">and</span> vert.<span style="color: black;">transformation</span> <span style="color: #ff7700;font-weight:bold;">and</span> noir.<span style="color: black;">transformation</span> <span style="color: #ff7700;font-weight:bold;">and</span> blanc.<span style="color: black;">transformation</span>
        <span style="color: #ff7700;font-weight:bold;">and</span> rose.<span style="color: black;">transformation</span> <span style="color: #ff7700;font-weight:bold;">and</span> fushia.<span style="color: black;">transformation</span>
        <span style="color: #ff7700;font-weight:bold;">and</span>  vermeille.<span style="color: black;">transformation</span> <span style="color: #ff7700;font-weight:bold;">and</span> vers_a_pois_jaune.<span style="color: black;">transformation</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;C'est bon là je crois qu'on a tout le monde sauf erreur de ma part&quot;</span>
           <span style="color: #483d8b;">&quot; dans le comptage... Ah non merde il manque jaune devant marron &quot;</span>
           <span style="color: #483d8b;">&quot;derrière&quot;</span><span style="color: black;">&#41;</span>
    call<span style="color: black;">&#40;</span>force=<span style="color: #483d8b;">'jaune_devant_marron_derriere'</span>, message=<span style="color: #483d8b;">&quot;Ramène ton cul tout&quot;</span>
                                                       <span style="color: #483d8b;">&quot;de suite !&quot;</span><span style="color: black;">&#41;</span></pre></div></div>

<h2>Les extensions <code>.pyw</code>, <code>.pyo</code> et <code>.pth</code></h2>
<p>Vous croyiez qu&#8217;il n&#8217;y avait que <code>.py</code> et <code>.pyc</code> dans la vie ? Ah, jeunes padawans&#8230;</p>
<p><code>.pyw</code> est juste un renommage, il permet, sous Windows, de ne pas ouvrir de terminal quand on lance le script (ce qui est préférable quand on a déjà une UI)</p>
<p><code>.pyo</code> est l&#8217;extension générée quand on lance la commande <code>python</code> avec l&#8217;option <code>-o</code> (optimize). Pour le moment il retire juste les <code>assert</code>.</p>
<p><code>.pth</code> est l&#8217;extension qu&#8217;on donne à un simple fichier texte qui contient une liste de chemins de dossiers. Posé à la racine d&#8217;un site directory, il dit à Python de rajouter automatiquement ces dossiers au Python Path, ce qui évite de manipuler <code>sys.path</code>.</p>
<h2>Lever une exception à nouveau</h2>
<p>Il suffit d&#8217;utiliser <code>raise</code> sans paramètre. Pratique quand on ne veut pas interrompre la remontée d&#8217;exception, et insérer un traitement juste avant que l&#8217;exception se déclenche (en opposition à <code>finally</code> qui garanti le traitement, pas le moment de celui-ci.)</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">try</span>:
    <span style="color: #008000;">open</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'fichier'</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: #008000;">IOError</span>:
    <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;pouet&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">raise</span></pre></div></div>

<h2>Passer une valeur à un générateur</h2>
<p>Vous aimez <a href="http://sametmax.com/comment-utiliser-yield-et-les-generateurs-en-python/">yield</a> ? Vous en abusez ? Sachez qu&#8217;on peut faire plus vicieux encore:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> je_te_yield_tu_me_yield<span style="color: black;">&#40;</span>lst<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> lst:
        nouvelle_liste = <span style="color: #ff7700;font-weight:bold;">yield</span> x
        <span style="color: #ff7700;font-weight:bold;">if</span> nouvelle_liste <span style="color: #ff7700;font-weight:bold;">is</span> <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #008000;">None</span>:
            <span style="color: #ff7700;font-weight:bold;">for</span> z <span style="color: #ff7700;font-weight:bold;">in</span> nouvelle_liste:
                <span style="color: #ff7700;font-weight:bold;">print</span> z</pre></div></div>

<p>Le truc tordu est qu&#8217;ici <code>yield</code> est dans un assignement. Non seulement il retourne une valeur, mais en plus il en récupère une. <code>send()</code> permet de passer une valeur à <code>yield</code> à son prochain retour (sinon la valeur reçue est toujours <code>None</code>):</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> generateur = je_te_yield_tu_me_yield<span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span>, <span style="color: #ff4500;">3</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> generateur.<span style="color: black;">next</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #ff4500;">1</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> generateur.<span style="color: black;">next</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #ff4500;">2</span>    
<span style="color: #66cc66;">&gt;&gt;&gt;</span> generateur.<span style="color: black;">send</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'a'</span>, <span style="color: #483d8b;">'b'</span>, <span style="color: #483d8b;">'c'</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
a
b
c
<span style="color: #ff4500;">3</span></pre></div></div>

<h2>On peut inverser les booléens avec 1/0 et vice-versa</h2>
<p>Les booléens ne sont qu&#8217;une surcouche des entiers, et même si:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">type</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span> 
<span style="color: #66cc66;">&lt;</span>type <span style="color: #483d8b;">'int'</span><span style="color: #66cc66;">&gt;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">type</span><span style="color: black;">&#40;</span><span style="color: #008000;">bool</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&lt;</span>type <span style="color: #483d8b;">'type'</span><span style="color: #66cc66;">&gt;</span></pre></div></div>

<p>Dans la pratique:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff4500;">1</span> == <span style="color: #008000;">True</span>
<span style="color: #008000;">True</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff4500;">0</span> == <span style="color: #008000;">False</span>
<span style="color: #008000;">True</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff4500;">2</span> == <span style="color: #008000;">True</span>
<span style="color: #008000;">False</span></pre></div></div>

<p>On peut donc les interchanger:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">True</span> + <span style="color: #ff4500;">1</span> <span style="color: #808080; font-style: italic;"># pas sur que ce soit utile</span>
<span style="color: #ff4500;">2</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> lst = <span style="color: black;">&#91;</span><span style="color: #483d8b;">'a'</span>, <span style="color: #483d8b;">'b'</span><span style="color: black;">&#93;</span> <span style="color: #808080; font-style: italic;"># par contre ça c'est cool pour les binary trees</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> lst<span style="color: black;">&#91;</span><span style="color: #008000;">False</span><span style="color: black;">&#93;</span>
<span style="color: #483d8b;">'a'</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> lst<span style="color: black;">&#91;</span><span style="color: #008000;">True</span><span style="color: black;">&#93;</span>
<span style="color: #483d8b;">'b'</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> fin_de_phrase = <span style="color: #008000;">True</span> <span style="color: #808080; font-style: italic;"># et ça c'est TRES pratique pour le formating</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;... d'une longue histoire&quot;</span> + <span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;.&quot;</span> <span style="color: #66cc66;">*</span> fin_de_phrase<span style="color: black;">&#41;</span>
... <span style="color: black;">d</span><span style="color: #483d8b;">'une longue histoire.
&gt;&gt;&gt; fin_de_phrase = False
&gt;&gt;&gt; print &quot;... d'</span>une longue histoire<span style="color: #483d8b;">&quot; + (&quot;</span>.<span style="color: #483d8b;">&quot; * fin_de_phrase)
... d'une longue histoire</span></pre></div></div>

<h2><code>_</code> contient la dernière sortie sur le shell</h2>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> _
<span style="color: #483d8b;">'b'</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff4500;">1</span> + <span style="color: #ff4500;">1</span>
<span style="color: #ff4500;">2</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> _
<span style="color: #ff4500;">2</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> _ + <span style="color: #ff4500;">1</span>
<span style="color: #ff4500;">3</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> a = <span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span>, <span style="color: #ff4500;">3</span><span style="color: black;">&#93;</span>
<span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span>, <span style="color: #ff4500;">3</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> _.<span style="color: black;">append</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">4</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> a
<span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span>, <span style="color: #ff4500;">3</span>, <span style="color: #ff4500;">4</span><span style="color: black;">&#93;</span></pre></div></div>

<p>Ca ne marche que dans le shell, et uniquement sur ce qui est affiché à l&#8217;écran. Si vous n&#8217;affichez pas la valeur, <code>_</code> ne change pas. Attention à ne pas trop compter sur <code>_</code> car il est très volatile.</p>
<h2><code>Enumerate()</code> accepte un index de départ</h2>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">for</span> i, elem <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">enumerate</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'azerty'</span><span style="color: black;">&#41;</span>:
...     <span style="color: #ff7700;font-weight:bold;">print</span> i, elem
...     
<span style="color: #ff4500;">0</span> a
<span style="color: #ff4500;">1</span> z
<span style="color: #ff4500;">2</span> e
<span style="color: #ff4500;">3</span> r
<span style="color: #ff4500;">4</span> t
<span style="color: #ff4500;">5</span> y
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">for</span> i, elem <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">enumerate</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'azerty'</span>, <span style="color: #ff4500;">10</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">print</span> i, elem
...     
<span style="color: #ff4500;">10</span> a
<span style="color: #ff4500;">11</span> z
<span style="color: #ff4500;">12</span> e
<span style="color: #ff4500;">13</span> r
<span style="color: #ff4500;">14</span> t
<span style="color: #ff4500;">15</span> y</pre></div></div>

<h2>On peut assigner et supprimer des slices</h2>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> a = <span style="color: #008000;">range</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">10</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> a
<span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span>, <span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span>, <span style="color: #ff4500;">3</span>, <span style="color: #ff4500;">4</span>, <span style="color: #ff4500;">5</span>, <span style="color: #ff4500;">6</span>, <span style="color: #ff4500;">7</span>, <span style="color: #ff4500;">8</span>, <span style="color: #ff4500;">9</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> a<span style="color: black;">&#91;</span>:<span style="color: #ff4500;">5</span><span style="color: black;">&#93;</span> = <span style="color: black;">&#91;</span><span style="color: #ff4500;">42</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> a
<span style="color: black;">&#91;</span><span style="color: #ff4500;">42</span>, <span style="color: #ff4500;">5</span>, <span style="color: #ff4500;">6</span>, <span style="color: #ff4500;">7</span>, <span style="color: #ff4500;">8</span>, <span style="color: #ff4500;">9</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> a<span style="color: black;">&#91;</span>:<span style="color: #ff4500;">1</span><span style="color: black;">&#93;</span> = <span style="color: #008000;">range</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">5</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> a
<span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span>, <span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span>, <span style="color: #ff4500;">3</span>, <span style="color: #ff4500;">4</span>, <span style="color: #ff4500;">5</span>, <span style="color: #ff4500;">6</span>, <span style="color: #ff4500;">7</span>, <span style="color: #ff4500;">8</span>, <span style="color: #ff4500;">9</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">del</span> a<span style="color: black;">&#91;</span>::<span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> a
<span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">3</span>, <span style="color: #ff4500;">5</span>, <span style="color: #ff4500;">7</span>, <span style="color: #ff4500;">9</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> a<span style="color: black;">&#91;</span>::<span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span> = a<span style="color: black;">&#91;</span>::-<span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> a
<span style="color: black;">&#91;</span><span style="color: #ff4500;">9</span>, <span style="color: #ff4500;">3</span>, <span style="color: #ff4500;">5</span>, <span style="color: #ff4500;">7</span>, <span style="color: #ff4500;">1</span><span style="color: black;">&#93;</span></pre></div></div>

<h2><code>import braces</code></h2>
<p>Si vous n&#8217;aimez pas les espaces pour l&#8217;indentation, vous pouvez faire:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">__future__</span> <span style="color: #ff7700;font-weight:bold;">import</span> braces</pre></div></div>

 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=1463&amp;md5=59b2ec224fa2b7064ecfa1d14b4f6729" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/astuces-python-en-vrac/feed/</wfw:commentRss>
		<slash:comments>8</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fastuces-python-en-vrac%2F&amp;language=en_GB&amp;category=text&amp;title=Astuces+Python+en+vrac&amp;description=Je+n%26%238217%3Barrive+pas+%C3%A0+trouver+un+lien+entre+tous+ces+trucs%2C+alors+un+bon+vrac+fera+l%26%238217%3Baffaire.+Float+accepte+de+parser+l%26%238217%3Binfini+%26gt%3B%26gt%3B%26gt%3B+infini+%3D+float%26%2340%3B%27inf%27%26%2341%3B+%26gt%3B%26gt%3B%26gt%3B+infini+inf+%26gt%3B%26gt%3B%26gt%3B...&amp;tags=import%2Citerable%2Cpython%2Cslice%2Cyield%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2012/08/48672-bureau-dependance-bordel-foutoir-desordre-rangemen.jpg" length="36541" type="image/jpg" />	</item>
		<item>
		<title>Concurrence sans threads en python</title>
		<link>http://sametmax.com/concurrence-sans-threads-en-python/</link>
		<comments>http://sametmax.com/concurrence-sans-threads-en-python/#comments</comments>
		<pubDate>Sat, 28 Jul 2012 00:51:37 +0000</pubDate>
		<dc:creator>poulpe</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[thread]]></category>
		<category><![CDATA[yield]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=1373</guid>
		<description><![CDATA[Je parie que là, maintenant, vous êtes en train de ne pas vous demander "Comment pourrais-je exécuter des actions concurrente sans utiliser de threads en python ?". Et c'est bien dommage pour vous car la seule chose que j'ai à vous écrire c'est un début de réponse à cette question.]]></description>
			<content:encoded><![CDATA[<p style="text-align: center;"><em><small>Ceci est un post invité de <a href="http://sametmax.com/author/poulpe/">poulpe</a> posté sous licence <a href="http://creativecommons.org/licenses/by/3.0/">creative common 3.0 unported</a>.</small></em></p>
<p>Je parie que là, maintenant, vous êtes en train de ne pas vous demander &#8220;Comment pourrais-je exécuter des actions concurrente sans utiliser de threads en python ?&#8221;. Et c&#8217;est bien dommage pour vous car la seule chose que j&#8217;ai à vous écrire c&#8217;est un début de réponse à cette question.</p>
<h2>Pourquoi faire ?</h2>
<p>Ouep, les threads c&#8217;est pas toujours la joie. Au rayon des inconvénients, on retrouve souvent complexité de conception et de debuggage, librairies externes pas toujours thread safe, dégradation des perfs, aucun contrôle sur la granularité de l&#8217;exécution, risques liés aux locks pour toute la partie &#8220;Atomicité&#8221; etc.<br />
Bon tout n&#8217;est quand même pas noir, et dans la majorité des cas, un petit coup de threads sera le plus pratique pour faire ce que vous voulez. Mais si votre besoin est vraiment particulier (ou que vous vous ennuyez beaucoup pendant les vacances) voici une solution assez élégante, qui vous laisse le contrôle absolu (MOUHAHAHA) et qui nécessite souvent peu de modifications de votre code existant.</p>
<h2>Comment faire ?</h2>
<p>Pour faire ça, on va utiliser les générateurs <a href="http://sametmax.com/parcourir-un-iterable-par-morceaux-en-python/">que vous connaissez bien</a>.<br />
Quoi de mieux qu&#8217;un petit exemple pour commencer :</p>
<ul>
<li>Paul veut afficher de façon régulière le mot &#8220;Loutre&#8221;.</li>
<li>Jacques, lui, voudrait afficher de la même façon le mot &#8220;Tarentule&#8221;.</li>
<li>Un mec bizarre que personne ne connait désire écrire &#8220;Musaraigne&#8221;.</li>
</ul>
<p>Comme ils sont tous les trois très cons et qu&#8217;ils sont incapables de se mettre d&#8217;accord pour savoir qui commence, ils décident de faire ça tous en même temps. Problème, ils veulent tous afficher leur mot <strong>selon une temporisation bien précise</strong> sans se gêner les uns les autres.</p>
<p>Voici donc la fonction que chacun de nos trois zoophiles veut utiliser. Vous remarquerez que le seul truc qu&#8217;elle possède de spécial, c&#8217;est le petit yield à la fin de chaque itération. C&#8217;est moi qui ai décidé de le rajouter arbitrairement à cet endroit (parce que c&#8217;est moi le chef). C&#8217;est en effet la seule modification à apporter à la fonction pour la rendre &#8220;éclatable&#8221;.</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> afficher_un_truc_regulierement<span style="color: black;">&#40;</span>truc, delai, nombre<span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;Affiche un &quot;truc&quot; tous les &quot;delais&quot; un certain &quot;nombre&quot; de fois&quot;&quot;&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">time</span>
    derniere_occur = <span style="color: #dc143c;">time</span>.<span style="color: #dc143c;">time</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
    num = <span style="color: #ff4500;">0</span>
    <span style="color: #ff7700;font-weight:bold;">while</span> num <span style="color: #66cc66;">&amp;</span>lt<span style="color: #66cc66;">;</span> nombre:
        maintenant = <span style="color: #dc143c;">time</span>.<span style="color: #dc143c;">time</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">if</span> maintenant - derniere_occur <span style="color: #66cc66;">&gt;</span> delai:
            derniere_occur = maintenant
            <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #008000;">str</span><span style="color: black;">&#40;</span>num<span style="color: black;">&#41;</span> + <span style="color: #483d8b;">&quot; : &quot;</span> + truc
            num += <span style="color: #ff4500;">1</span>
        <span style="color: #ff7700;font-weight:bold;">yield</span>     <span style="color: #808080; font-style: italic;"># Je rajoute mon(mes) yield(s) où je veux.</span></pre></div></div>

<p>Le placement du yield est important, tous les traitements entre deux yields seront exécutés de façon atomique. Dans le reste de ce tuto, j’appellerai ce groupe de traitements atomique une granule (j&#8217;aime bien le mot).<br />
Dès l&#8217;ajout du mot-clé yield dans le corps, notre fonction retourne un générateur au lieu de s&#8217;exécuter normalement.</p>
<p>On crée ensuite une liste d&#8217;actions à effectuer de façon concurrente. Chaque action est un générateur retourné par l&#8217;appel à la fonction.</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">liste_des_actions = <span style="color: black;">&#91;</span><span style="color: black;">&#93;</span>
<span style="color: #808080; font-style: italic;">#Paul :</span>
liste_des_actions.<span style="color: black;">append</span><span style="color: black;">&#40;</span>afficher_un_truc_regulierement<span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Loutre&quot;</span>, <span style="color: #ff4500;">4</span>, <span style="color: #ff4500;">4</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #808080; font-style: italic;">#Jacques :</span>
liste_des_actions.<span style="color: black;">append</span><span style="color: black;">&#40;</span>afficher_un_truc_regulierement<span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Tarentule&quot;</span>, <span style="color: #ff4500;">5</span>, <span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #808080; font-style: italic;">#Le mec bizarre</span>
liste_des_actions.<span style="color: black;">append</span><span style="color: black;">&#40;</span>afficher_un_truc_regulierement<span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Musaraigne&quot;</span>, <span style="color: #ff4500;">3</span>, <span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span></pre></div></div>

<p>Voici enfin le mécanisme qui permet d&#8217;exécuter tout ce beau bordel. Il est assez générique et le code parle de lui même :)</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">while</span> <span style="color: #008000;">True</span>:     <span style="color: #808080; font-style: italic;"># Boucle infinie</span>
    <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #008000;">len</span><span style="color: black;">&#40;</span>liste_des_actions<span style="color: black;">&#41;</span>:     <span style="color: #808080; font-style: italic;"># Si il reste des actions</span>
        <span style="color: #808080; font-style: italic;">#On itère sur une copie de la liste (avec [:])</span>
        <span style="color: #808080; font-style: italic;">#pour pouvoir modifier la liste pendant la boucle</span>
        <span style="color: #ff7700;font-weight:bold;">for</span> action <span style="color: #ff7700;font-weight:bold;">in</span> liste_des_actions<span style="color: black;">&#91;</span>:<span style="color: black;">&#93;</span>:
            <span style="color: #ff7700;font-weight:bold;">try</span>:
                action.<span style="color: black;">next</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>     <span style="color: #808080; font-style: italic;"># On execute une granule</span>
            <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: #008000;">StopIteration</span>:
                <span style="color: #808080; font-style: italic;">#Il n'y a plus de granule dans cette action</span>
                <span style="color: #808080; font-style: italic;">#On enlève donc l'action de la liste</span>
                liste_des_actions.<span style="color: black;">remove</span><span style="color: black;">&#40;</span>action<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">else</span>:
        <span style="color: #808080; font-style: italic;">#Plus aucune action, on finit la boucle infinie</span>
        <span style="color: #ff7700;font-weight:bold;">break</span>
<span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Tout est bien qui finit bien.&quot;</span></pre></div></div>

<p>Ici, l&#8217;exemple est simpliste mais on peut l&#8217;adapter à des fonctions beaucoup plus complexes et nombreuses, qui ne se présentent pas forcement sous forme de boucle.</p>
<h2>Comment faire mieux ?</h2>
<p>Je vous laisse avec une piste d&#8217;évolution possible qui est assez amusante à implémenter (on rigole avec ce qu&#8217;on peut, hein). On peut facilement imaginer un système de priorité dynamique entre les actions. En effet, ici, on ne yield aucune valeur, mais on peut décider d&#8217;utiliser le nombre X yieldé (et donc retourné par action.next()) pour sauter les X prochains appels à cette action, ce qui aura pour effet de réduire la priorité de celle-çi par rapport aux autres.</p>
<p>Voilou, j&#8217;espère que vous n&#8217;utiliserez jamais ça dans du code collaboratif (ou alors si vous n&#8217;aimez pas vos collaborateurs à la limite) mais que le jour où vous aurez ce besoin particulier, vous saurez quoi faire.</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=1373&amp;md5=c8ed94ac9116499ded2fd108724a75a1" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/concurrence-sans-threads-en-python/feed/</wfw:commentRss>
		<slash:comments>8</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fconcurrence-sans-threads-en-python%2F&amp;language=en_GB&amp;category=text&amp;title=Concurrence+sans+threads+en+python&amp;description=Ceci+est+un+post+invit%C3%A9+de+poulpe+post%C3%A9+sous+licence+creative+common+3.0+unported.+Je+parie+que+l%C3%A0%2C+maintenant%2C+vous+%C3%AAtes+en+train+de+ne+pas+vous+demander+%26%238220%3BComment+pourrais-je...&amp;tags=python%2Cthread%2Cyield%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2012/07/calvin_surp.gif" length="1807" type="image/jpg" />	</item>
	</channel>
</rss>
