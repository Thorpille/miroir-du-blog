<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Sam &#38; Max: Python, Django, Git et du cul &#187; callback</title>
	<atom:link href="http://sametmax.com/tag/callback/feed/" rel="self" type="application/rss+xml" />
	<link>http://sametmax.com</link>
	<description>Deux développeurs en vadrouille qui se sortent les doigts du code</description>
	<lastBuildDate>Wed, 05 Feb 2014 14:20:37 +0000</lastBuildDate>
	<language>en</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>http://wordpress.org/?v=3.3.1</generator>
	<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2F&amp;language=en_US&amp;category=text&amp;title=Sam+%26amp%3B+Max%3A+Python%2C+Django%2C+Git+et+du+cul&amp;description=Deux+d%C3%A9veloppeurs+en+vadrouille+qui+se+sortent+les+doigts+du+code&amp;tags=blog" type="text/html" />
		<item>
		<title>Un décorateur pour accepter les callbacks en Python</title>
		<link>http://sametmax.com/un-decorateur-pour-accepter-les-callbacks-en-python/</link>
		<comments>http://sametmax.com/un-decorateur-pour-accepter-les-callbacks-en-python/#comments</comments>
		<pubDate>Mon, 12 Aug 2013 10:03:44 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[callback]]></category>
		<category><![CDATA[decorator]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=7081</guid>
		<description><![CDATA[Un des événements auxquels on veut réagir le plus souvent, c'est l'appel d'une fonction, donc en gros être capable de fournir un callback quand on fonction est appelée. On peut bien entendu coder la logique du callback dans chaque fonction et méthode que l'on met en œuvre, mais avec un peu d'astuce, on peu trouver une solution générique qui va couvrir Pareto des besoins.]]></description>
			<content:encoded><![CDATA[<p>Si vous lisez assidûment ce blog, et je n&#8217;en doute pas car il est génial, vous savez ce qu&#8217;est un <a href="http://sametmax.com/comprendre-les-decorateurs-python-pas-a-pas-partie-1/">décorateur</a> et un <a href="http://sametmax.com/quest-ce-quun-callback/">callback</a>. On a même vu comment<a href="http://sametmax.com/le-pattern-observer-en-utilisant-des-decorateurs/"> créer un système de gestion d&#8217;événements</a> en utilisant ces deux concepts.</p>
<p>Un des événements auxquels on veut réagir le plus souvent, c&#8217;est l&#8217;appel d&#8217;une fonction, donc en gros être capable de fournir un callback quand une fonction est appelée. On peut bien entendu coder la logique du callback dans chaque fonction et méthode que l&#8217;on met en œuvre, mais avec un peu d&#8217;astuce, on peut trouver une solution générique qui va couvrir Pareto des besoins.</p>
<p>L&#8217;idée, c&#8217;est donc de coder un décorateur :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> accept_callbacks<span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span>:
&nbsp;
    <span style="color: #808080; font-style: italic;"># on va stocker tous les callbacks là dedans</span>
    callbacks = <span style="color: black;">&#91;</span><span style="color: black;">&#93;</span>
&nbsp;
    @wraps<span style="color: black;">&#40;</span>func<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> wrapper<span style="color: black;">&#40;</span><span style="color: #66cc66;">*</span>args, <span style="color: #66cc66;">**</span>kwargs<span style="color: black;">&#41;</span>:
&nbsp;
        <span style="color: #808080; font-style: italic;"># on appelle la fonction originale</span>
        result = func<span style="color: black;">&#40;</span><span style="color: #66cc66;">*</span>args, <span style="color: #66cc66;">**</span>kwargs<span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># on appelle ensuite chaque callback en lui passant le resultat </span>
        <span style="color: #808080; font-style: italic;"># de la fonction ainsi que les paramètres qui avaient été passés</span>
        <span style="color: #ff7700;font-weight:bold;">for</span> callback <span style="color: #ff7700;font-weight:bold;">in</span> callbacks:
            callback<span style="color: black;">&#40;</span>result, <span style="color: #66cc66;">*</span>args, <span style="color: #66cc66;">**</span>kwargs<span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># et on retourne le résultat</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> result
&nbsp;
    <span style="color: #808080; font-style: italic;"># on attache la liste des callbacks au wrapper pour y avoir accès depuis</span>
    <span style="color: #808080; font-style: italic;"># l'extérieur</span>
    wrapper.<span style="color: black;">callbacks</span> = callbacks
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">return</span> wrapper</pre></div></div>

<p>Du coup, pour accepter des callbacks sur une fonction, il suffit de décorer la fonction :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">@accept_callbacks
<span style="color: #ff7700;font-weight:bold;">def</span> add<span style="color: black;">&#40;</span>a, b<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">return</span> a + b</pre></div></div>

<p>Ensuite on écrit son callback avec la signature qui va bien :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> mon_callback<span style="color: black;">&#40;</span>result, a, b<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Ma fonction a été appelée avec a=%s et b=%s !&quot;</span> <span style="color: #66cc66;">%</span> <span style="color: black;">&#40;</span>a, b<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Elle a retourné le résultat '%s'&quot;</span> <span style="color: #66cc66;">%</span> result<span style="color: black;">&#41;</span></pre></div></div>

<p>Et pour ajouter un callback, c&#8217;est juste une insertion dans la liste :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">add.<span style="color: black;">callbacks</span>.<span style="color: black;">append</span><span style="color: black;">&#40;</span>mon_callback<span style="color: black;">&#41;</span></pre></div></div>

<p>Derrière, chaque appel de la fonction va appeler également tous les callbacks :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>add<span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #808080; font-style: italic;">## Ma fonction a été appelée avec a=1 et b=1 !</span>
<span style="color: #808080; font-style: italic;">## Elle a retourné le résultat '2'</span>
<span style="color: #808080; font-style: italic;">## 2</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>add<span style="color: black;">&#40;</span><span style="color: #ff4500;">42</span>, <span style="color: #ff4500;">69</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #808080; font-style: italic;">## Ma fonction a été appelée avec a=42 et b=69 !</span>
<span style="color: #808080; font-style: italic;">## Elle a retourné le résultat '111'</span>
<span style="color: #808080; font-style: italic;">## 111</span>
&nbsp;
add.<span style="color: black;">callbacks</span>.<span style="color: black;">remove</span><span style="color: black;">&#40;</span>mon_callback<span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>add<span style="color: black;">&#40;</span><span style="color: #ff4500;">0</span>, <span style="color: #ff4500;">0</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #808080; font-style: italic;"># 0</span></pre></div></div>

<p>Et le plus fun, c&#8217;est que ça marche aussi sans rien modifier avec les méthodes :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> autre_callback<span style="color: black;">&#40;</span>result, <span style="color: #008000;">self</span>, truc_important<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Ma fonction a été appelée avec truc_important=%s !&quot;</span> <span style="color: #66cc66;">%</span> truc_important<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Elle a retourné '%s'&quot;</span> <span style="color: #66cc66;">%</span> result<span style="color: black;">&#41;</span>
&nbsp;
&nbsp;
<span style="color: #ff7700;font-weight:bold;">class</span> CaMarcheAussiAvecUneClass<span style="color: black;">&#40;</span><span style="color: #008000;">object</span><span style="color: black;">&#41;</span>:
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__init__</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, repeat=<span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span>:
        <span style="color: #008000;">self</span>.<span style="color: black;">repeat</span> = repeat
&nbsp;
    @accept_callbacks
    <span style="color: #ff7700;font-weight:bold;">def</span> puisque_une_classe_a_des_methodes<span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, truc_important<span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">return</span> truc_important.<span style="color: black;">upper</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #66cc66;">*</span> <span style="color: #008000;">self</span>.<span style="color: black;">repeat</span>
&nbsp;
&nbsp;
CaMarcheAussiAvecUneClass.<span style="color: black;">puisque_une_classe_a_des_methodes</span>.<span style="color: black;">callbacks</span>.<span style="color: black;">append</span><span style="color: black;">&#40;</span>autre_callback<span style="color: black;">&#41;</span>
&nbsp;
instance1 = CaMarcheAussiAvecUneClass<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
instance2 = CaMarcheAussiAvecUneClass<span style="color: black;">&#40;</span><span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>instance1.<span style="color: black;">puisque_une_classe_a_des_methodes</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Le fromage de chèvre&quot;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #808080; font-style: italic;">## Ma fonction a été appelée avec truc_important=Le fromage de chèvre !</span>
<span style="color: #808080; font-style: italic;">## Elle a retourné 'LE FROMAGE DE CHÈVRE'</span>
<span style="color: #808080; font-style: italic;">## LE FROMAGE DE CHÈVRE</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>instance2.<span style="color: black;">puisque_une_classe_a_des_methodes</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Les perforeuses&quot;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #808080; font-style: italic;">## Ma fonction a été appelée avec truc_important=Les perforeuses !</span>
<span style="color: #808080; font-style: italic;">## Elle a retourné 'LES PERFOREUSESLES PERFOREUSES'</span>
<span style="color: #808080; font-style: italic;">## LES PERFOREUSESLES PERFOREUSES</span></pre></div></div>

<p>Par contre, si on veut qu&#8217;un callback ne s&#8217;active que pour une instance donnée, alors il faut ruser un peu :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #808080; font-style: italic;"># le retrait d'un callback, c'est un simple retrait de la liste</span>
CaMarcheAussiAvecUneClass.<span style="color: black;">puisque_une_classe_a_des_methodes</span>.<span style="color: black;">callbacks</span>.<span style="color: black;">remove</span><span style="color: black;">&#40;</span>autre_callback<span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> callback_pour_une_instance<span style="color: black;">&#40;</span>result, <span style="color: #008000;">self</span>, truc_important<span style="color: black;">&#41;</span>:
    <span style="color: #808080; font-style: italic;"># on check que l'instance est celle que l'on veut</span>
    <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #008000;">self</span> <span style="color: #ff7700;font-weight:bold;">is</span> instance1:
        <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Ma fonction a été appelée avec truc_important=%s !&quot;</span> <span style="color: #66cc66;">%</span> truc_important<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Elle a retourné '%s'&quot;</span> <span style="color: #66cc66;">%</span> result<span style="color: black;">&#41;</span>
&nbsp;
CaMarcheAussiAvecUneClass.<span style="color: black;">puisque_une_classe_a_des_methodes</span>.<span style="color: black;">callbacks</span>.<span style="color: black;">append</span><span style="color: black;">&#40;</span>callback_pour_une_instance<span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>instance1.<span style="color: black;">puisque_une_classe_a_des_methodes</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Les points noirs des coccinelles&quot;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #808080; font-style: italic;">## Ma fonction a été appelée avec truc_important=Les points noirs des coccinelles !</span>
<span style="color: #808080; font-style: italic;">## Elle a retourné 'LES POINTS NOIRS DES COCCINELLES'</span>
<span style="color: #808080; font-style: italic;">## LES POINTS NOIRS DES COCCINELLES</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>instance2.<span style="color: black;">puisque_une_classe_a_des_methodes</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Les panneaux sens uniques&quot;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #808080; font-style: italic;">## LES PANNEAUX SENS UNIQUESLES PANNEAUX SENS UNIQUES</span></pre></div></div>

<p>Niveau perf, ce n&#8217;est pas optimal, et bien sûr, l&#8217;appel des callbacks est synchrone et blocant. Ce n&#8217;est pas un souci dans 90 % des cas, pour les autres cas, vous devrez faire le truc à la main. En même temps, dès qu&#8217;on a des problèmes de perf, les codes génériques fonctionnent rarement.</p>
<p>Je vais peut être rajouter ça dans <a href="sametmax.com/batbelt-la-lib-des-petits-outils-python-qui-vont-bien/">batbelt</a> moi&#8230;</p>
<hr />
<p><a href="https://github.com/sametmax/codes-des-articles/blob/master/2013/aout/accept_callbacks.py">Télécharger le code de l&#8217;article</a></p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=7081&amp;md5=f0a11fb27c97ee69bcf6c900cff73371" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/un-decorateur-pour-accepter-les-callbacks-en-python/feed/</wfw:commentRss>
		<slash:comments>1</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fun-decorateur-pour-accepter-les-callbacks-en-python%2F&amp;language=en_GB&amp;category=text&amp;title=Un+d%C3%A9corateur+pour+accepter+les+callbacks+en+Python&amp;description=Si+vous+lisez+assid%C3%BBment+ce+blog%2C+et+je+n%26%238217%3Ben+doute+pas+car+il+est+g%C3%A9nial%2C+vous+savez+ce+qu%26%238217%3Best+un+d%C3%A9corateur+et+un+callback.+On+a+m%C3%AAme+vu+comment+cr%C3%A9er...&amp;tags=callback%2Cdecorator%2Cpython%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/08/xYfIFmB.jpg" length="250944" type="image/jpg" />	</item>
		<item>
		<title>Envoi d&#8217;un email par logging en cas de plantage d&#8217;un script python (ou: comment faire bouffer u&#8221;\xe9&#8243; à SMTPHandler)</title>
		<link>http://sametmax.com/envoi-dun-email-par-logging-en-cas-de-plantage-dun-script-python-ou-comment-faire-bouffer-uxe9-a-smtphandler/</link>
		<comments>http://sametmax.com/envoi-dun-email-par-logging-en-cas-de-plantage-dun-script-python-ou-comment-faire-bouffer-uxe9-a-smtphandler/#comments</comments>
		<pubDate>Tue, 12 Mar 2013 08:48:23 +0000</pubDate>
		<dc:creator>etienne</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[callback]]></category>
		<category><![CDATA[email]]></category>
		<category><![CDATA[exception]]></category>
		<category><![CDATA[logguer]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=5313</guid>
		<description><![CDATA[(Ceci est un post invité d&#8217;un débutant pour les débutants&#8230; sous licence creative common 3.0 unported.) Il y a peu, je me suis mis à utiliser logging pour debugger mes scripts de débutant. Si comme moi vous avez l&#8217;habitude de mettre des print partout pour trouver l&#8217;origine d&#8217;un problème, et qu&#8217;ensuite vous avez passé de [...]]]></description>
			<content:encoded><![CDATA[<p><em>(Ceci est un post invité d&#8217;un débutant pour les débutants&#8230; sous licence <a href="http://creativecommons.org/licenses/by/3.0/">creative common 3.0 unported</a>.)</em></p>
<p>Il y a peu, je me suis mis à utiliser <code>logging</code> pour debugger mes scripts de débutant.</p>
<p>Si comme moi vous avez l&#8217;habitude de mettre des <code>print</code> partout pour trouver l&#8217;origine d&#8217;un problème, et qu&#8217;ensuite vous avez passé de longues longues longues minutes/heures à traquer ces foutus <code>print</code> pour dépolluer la sortie console, jetez un oeil à <a href="http://sametmax.com/ecrire-des-logs-en-python/">écrire des logs en python</a>.</p>
<p>Après quelques (minutes/heures/jours) de prise en main (vite, quoi&#8230;), on se demande comment on a fait pour s&#8217;en passer si longtemps. C&#8217;est simple, je n&#8217;utilise plus les touches &#8220;p&#8221;, &#8220;r&#8221;, &#8220;i&#8221;, &#8220;n&#8221; et &#8220;t&#8221; de mon clavier. Elles sont toutes propres.</p>
<p>En plus, <code>logging</code> m&#8217;a ouvert de nouvelles perspectives, parmi lesquelles la possibilité d&#8217;envoyer les logs par mail. Pas besoin de tout recevoir par mail, mais si ce foutu script de m%@rde pouvait m&#8217;envoyer un email quand il plante avec la source détaillé du problème, ce serait super.</p>
<h2>Log post mortem par email</h2>
<p>Admettons que vous vouliez vérifier que les pensées qui vous traversent l&#8217;esprit sont safe for work. Vous écrivez un script génial qui fait le boulot.</p>
<p>Comme vous commencez à savoir y faire en python, vous avez même écrit votre propre exception à vous tout seul&#8230;</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">class</span> NotSafeForWorkError<span style="color: black;">&#40;</span><span style="color: #008000;">Exception</span><span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;
    Exception soulevée si une pensée est NSFW
    &quot;&quot;&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__init__</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, msg<span style="color: black;">&#41;</span>:
        <span style="color: #008000;">self</span>.<span style="color: black;">msg</span> = u<span style="color: #483d8b;">&quot;Danger! %s est NSFW.&quot;</span> <span style="color: #66cc66;">%</span> msg
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__str__</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">self</span>.<span style="color: black;">msg</span>.<span style="color: black;">encode</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;utf-8&quot;</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># liste des pensées proscrites</span>
<span style="color: #808080; font-style: italic;"># (échantillon, elle est beaucoup plus longue que ça en réalité)</span>
NSFW = <span style="color: black;">&#91;</span><span style="color: #483d8b;">&quot;cul&quot;</span>, <span style="color: #483d8b;">&quot;seins&quot;</span>, <span style="color: #483d8b;">&quot;sametmax&quot;</span><span style="color: black;">&#93;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># boucle de censure qui soulève une exception si une pensée déconne</span>
<span style="color: #ff7700;font-weight:bold;">for</span> pensee <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: black;">&#91;</span><span style="color: #483d8b;">&quot;pause&quot;</span>, <span style="color: #483d8b;">&quot;pipi&quot;</span>, <span style="color: #483d8b;">&quot;sametmax&quot;</span><span style="color: black;">&#93;</span>:
    <span style="color: #ff7700;font-weight:bold;">if</span> pensee <span style="color: #ff7700;font-weight:bold;">in</span> NSFW:
        <span style="color: #ff7700;font-weight:bold;">raise</span> NotSafeForWorkError<span style="color: black;">&#40;</span>pensee<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">print</span> u<span style="color: #483d8b;">&quot;%s est SFW&quot;</span> <span style="color: #66cc66;">%</span> pensee
&nbsp;
<span style="color: #808080; font-style: italic;">#sortie:</span>
<span style="color: #808080; font-style: italic;">## pause est SFW</span>
<span style="color: #808080; font-style: italic;">## pipi est SFW</span>
<span style="color: #808080; font-style: italic;">## Traceback (most recent call last):</span>
<span style="color: #808080; font-style: italic;">##   File &quot;censure_setm3.py&quot;, line 30, in</span>
<span style="color: #808080; font-style: italic;">##     raise NotSafeForWorkError(pensee)</span>
<span style="color: #808080; font-style: italic;">## __main__.NotSafeForWorkError: Danger! sametmax est NSFW.</span></pre></div></div>

<p>Ça marche du tonnerre! C&#8217;est là que vous vous dites que ce serait bien si le script envoyait le traceback par email à votre psy pour le prévenir que vous avez déconné.</p>
<p>A la maison, vous avez lu l&#8217;article de Sam sur les <a href="http://sametmax.com/log-post-mortem-avec-python/">logs post mortem</a>. Ça a l&#8217;air facile à faire.</p>
<p>Vous créez d&#8217;abord un logger qui enverra les logs de niveau critique par mail:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">logging</span>
<span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">logging</span>.<span style="color: black;">handlers</span> <span style="color: #ff7700;font-weight:bold;">import</span> SMTPHandler
&nbsp;
nom_loggeur = <span style="color: #483d8b;">&quot;test_nsfw&quot;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># On crée un logger et on met le niveau à critique:</span>
<span style="color: #808080; font-style: italic;">#  il ne tiendra compte que des logs de ce niveau</span>
logger = <span style="color: #dc143c;">logging</span>.<span style="color: black;">getLogger</span><span style="color: black;">&#40;</span>nom_loggeur<span style="color: black;">&#41;</span>
logger.<span style="color: black;">setLevel</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">logging</span>.<span style="color: black;">CRITICAL</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># On crée le handler en lui passant les paramètres</span>
<span style="color: #808080; font-style: italic;">#  nécessaires à l'envoi d'un email</span>
mail_handler = SMTPHandler<span style="color: black;">&#40;</span>
    <span style="color: #808080; font-style: italic;"># Host et port</span>
    <span style="color: black;">&#40;</span><span style="color: #483d8b;">'SMTP.GMAIL.COM'</span>, <span style="color: #ff4500;">587</span><span style="color: black;">&#41;</span>,
    <span style="color: #808080; font-style: italic;"># From</span>
    <span style="color: #483d8b;">&quot;MOI@GMAIL.COM&quot;</span>,
    <span style="color: #808080; font-style: italic;"># To (liste)</span>
    <span style="color: black;">&#91;</span><span style="color: #483d8b;">&quot;QUELQU.UN@QUELQUE.PART&quot;</span><span style="color: black;">&#93;</span>,
    <span style="color: #808080; font-style: italic;"># Sujet du message</span>
    <span style="color: #483d8b;">&quot;Erreur critique dans %s&quot;</span> <span style="color: #66cc66;">%</span> nom_loggeur,
    <span style="color: #808080; font-style: italic;"># pour l'authentification</span>
    credentials = <span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;MONEMAIL@GMAIL.COM&quot;</span>, <span style="color: #483d8b;">&quot;MONSUPERPASSWORD&quot;</span><span style="color: black;">&#41;</span>,
    secure = <span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># On met le handler à &quot;critique&quot;.</span>
<span style="color: #808080; font-style: italic;"># Il enverra donc par mail les messages de ce niveau</span>
mail_handler.<span style="color: black;">setLevel</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">logging</span>.<span style="color: black;">CRITICAL</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># On définit un formatter: date, nom du logger, niveau, message</span>
<span style="color: #dc143c;">formatter</span> = <span style="color: #dc143c;">logging</span>.<span style="color: black;">Formatter</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># On associe le formatter au handler:</span>
<span style="color: #808080; font-style: italic;">#  c'est lui qui formatera les logs de ce handler</span>
mail_handler.<span style="color: black;">setFormatter</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">formatter</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># ... et on associe le handler au logger:</span>
<span style="color: #808080; font-style: italic;">#  il utilisera ce handler, qui émettra les logs critiques</span>
logger.<span style="color: black;">addHandler</span><span style="color: black;">&#40;</span>mail_handler<span style="color: black;">&#41;</span></pre></div></div>

<p>Ensuite vous redéfinissez sys.excepthook de manière à ce que l&#8217;exception soit logguée. La fonction convertit le traceback en string, la loggue au niveau critique et laisse l&#8217;exception continuer son chemin.</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">sys</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># la fonction qui remplacera sys.excepthook</span>
<span style="color: #ff7700;font-weight:bold;">def</span> en_cas_de_plantage<span style="color: black;">&#40;</span>type_except, value, tb<span style="color: black;">&#41;</span>:
&nbsp;
    <span style="color: #808080; font-style: italic;"># Traceback permettra de formater l'exception.</span>
    <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">traceback</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># Mise en forme de l'exception. Retourne la trace</span>
    <span style="color: #808080; font-style: italic;">#  sous forme de str avec numéros de lignes et tout</span>
    trace = <span style="color: #483d8b;">&quot;&quot;</span>.<span style="color: black;">join</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">traceback</span>.<span style="color: black;">format_exception</span><span style="color: black;">&#40;</span>type_except, value, tb<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># On loggue l'exception au niveau &quot;critique&quot;,</span>
    <span style="color: #808080; font-style: italic;">#  elle sera donc envoyée par email</span>
    logger.<span style="color: black;">critical</span><span style="color: black;">&#40;</span>u<span style="color: #483d8b;">&quot;Erreur inattendue:<span style="color: #000099; font-weight: bold;">\n</span>%s&quot;</span>, trace<span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># ... et on laisse le script se planter...</span>
    <span style="color: #dc143c;">sys</span>.__excepthook__<span style="color: black;">&#40;</span>type_except, value, tb<span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># on remplace sys.excepthook, et le tour est joué</span>
    <span style="color: #dc143c;">sys</span>.<span style="color: black;">excepthook</span> = en_cas_de_plantage</pre></div></div>

<p>Et voilà. Vous lancez le script, il se casse la gueule dès qu&#8217;il rencontre &#8220;sametmax&#8221;, votre psy reçoit un email avec le traceback, c&#8217;est cool.</p>
<p>Sauf que&#8230;</p>
<h2>SMTPHandler ne gère pas unicode</h2>
<p>Si au moment de la création de mail_handler, vous passez comme sujet à SMTPHandler:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">u<span style="color: #483d8b;">&quot;%s s'est planté&quot;</span> <span style="color: #66cc66;">%</span> nom_loggeur</pre></div></div>

<p>ou que dans votre fonction &#8220;en_cas_de_plantage&#8221; vous mettez:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">logger.<span style="color: black;">critical</span><span style="color: black;">&#40;</span>u<span style="color: #483d8b;">&quot;Bébé a encore glissé dans son caca:<span style="color: #000099; font-weight: bold;">\n</span>%s&quot;</span>, trace<span style="color: black;">&#41;</span></pre></div></div>

<p>&#8230; autrement dit si vous avez une chaîne unicode qui ne peut pas être encodée en ascii, ça va pas marcher:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">Traceback <span style="color: black;">&#40;</span>most recent call last<span style="color: black;">&#41;</span>:
  File <span style="color: #483d8b;">&quot;envoie_mail_on_crash.py&quot;</span>, line <span style="color: #ff4500;">84</span>, <span style="color: #ff7700;font-weight:bold;">in</span> emit
    smtp.<span style="color: black;">sendmail</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">fromaddr</span>, <span style="color: #008000;">self</span>.<span style="color: black;">toaddrs</span>, msg<span style="color: black;">&#41;</span>
  File <span style="color: #483d8b;">&quot;/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/smtplib.py&quot;</span>, line <span style="color: #ff4500;">734</span>, <span style="color: #ff7700;font-weight:bold;">in</span> sendmail
    <span style="color: black;">&#40;</span><span style="color: #dc143c;">code</span>, resp<span style="color: black;">&#41;</span> = <span style="color: #008000;">self</span>.<span style="color: black;">data</span><span style="color: black;">&#40;</span>msg<span style="color: black;">&#41;</span>
  File <span style="color: #483d8b;">&quot;/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/smtplib.py&quot;</span>, line <span style="color: #ff4500;">501</span>, <span style="color: #ff7700;font-weight:bold;">in</span> data
    <span style="color: #008000;">self</span>.<span style="color: black;">send</span><span style="color: black;">&#40;</span>q<span style="color: black;">&#41;</span>
  File <span style="color: #483d8b;">&quot;/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/smtplib.py&quot;</span>, line <span style="color: #ff4500;">321</span>, <span style="color: #ff7700;font-weight:bold;">in</span> send
    <span style="color: #008000;">self</span>.<span style="color: black;">sock</span>.<span style="color: black;">sendall</span><span style="color: black;">&#40;</span><span style="color: #008000;">str</span><span style="color: black;">&#41;</span>
  File <span style="color: #483d8b;">&quot;/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/ssl.py&quot;</span>, line <span style="color: #ff4500;">229</span>, <span style="color: #ff7700;font-weight:bold;">in</span> sendall
    v = <span style="color: #008000;">self</span>.<span style="color: black;">send</span><span style="color: black;">&#40;</span>data<span style="color: black;">&#91;</span>count:<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
  File <span style="color: #483d8b;">&quot;/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/ssl.py&quot;</span>, line <span style="color: #ff4500;">198</span>, <span style="color: #ff7700;font-weight:bold;">in</span> send
    v = <span style="color: #008000;">self</span>._sslobj.<span style="color: black;">write</span><span style="color: black;">&#40;</span>data<span style="color: black;">&#41;</span>
<span style="color: #008000;">UnicodeEncodeError</span>: <span style="color: #483d8b;">'ascii'</span> codec can<span style="color: #483d8b;">'t encode character u'</span>\xe9<span style="color: #483d8b;">' in position 62: ordinal not in range(128)
Logged from file envoie_mail_on_crash.py, line 163</span></pre></div></div>

<p>D&#8217;où l&#8217;on déduit qu&#8217;il y a une tentative foirée d&#8217;encodage d&#8217;une chaîne unicode en ascii par la méthode &#8220;write&#8221; de ce mystérieux _sslobj, et que c&#8217;est une méthode &#8220;emit&#8221; quelque part dans handlers.py qui lui a passé la chaîne.</p>
<p>Fuck! Investiguons. Et essayons de régler ça par le haut de la pile.</p>
<h2>Toi, là au fond! Oui, toi!</h2>
<p>C&#8217;est la methode <code>emit</code> de SMTPHandler qui est responsable. Elle fait quoi cette méthode? Elle formate le &#8220;record&#8221;, crée un message et l&#8217;envoie à l&#8217;adresse mail spécifiée. Voilà le code:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> emit<span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, record<span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;
    Emit a record.
&nbsp;
    Format the record and send it to the specified addressees.
    &quot;&quot;&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">try</span>:
        <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">smtplib</span>
        <span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">email</span>.<span style="color: black;">utils</span> <span style="color: #ff7700;font-weight:bold;">import</span> formatdate
        port = <span style="color: #008000;">self</span>.<span style="color: black;">mailport</span>
        <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #ff7700;font-weight:bold;">not</span> port:
            port = <span style="color: #dc143c;">smtplib</span>.<span style="color: black;">SMTP_PORT</span>
        smtp = <span style="color: #dc143c;">smtplib</span>.<span style="color: black;">SMTP</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">mailhost</span>, port<span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># C'est ici l'objet &quot;record&quot; est formatté</span>
        msg = <span style="color: #008000;">self</span>.<span style="color: black;">format</span><span style="color: black;">&#40;</span>record<span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># Le message est construit ici. Il sera ensuite envoyé par smtp.sendmail</span>
        <span style="color: #808080; font-style: italic;"># C'est là que le bât blesse</span>
        msg = <span style="color: #483d8b;">&quot;From: %s<span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span>To: %s<span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span>Subject: %s<span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span>Date: %s<span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span><span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span>%s&quot;</span> <span style="color: #66cc66;">%</span> <span style="color: black;">&#40;</span>
                        <span style="color: #008000;">self</span>.<span style="color: black;">fromaddr</span>,
                        <span style="color: #483d8b;">&quot;,&quot;</span>.<span style="color: black;">join</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">toaddrs</span><span style="color: black;">&#41;</span>,
                        <span style="color: #808080; font-style: italic;"># Notons ce getSubject(record). La méthode renvoie</span>
                        <span style="color: #808080; font-style: italic;">#  le sujet du message, passé à la création</span>
                        <span style="color: #808080; font-style: italic;">#  de mail_handler</span>
                        <span style="color: #008000;">self</span>.<span style="color: black;">getSubject</span><span style="color: black;">&#40;</span>record<span style="color: black;">&#41;</span>,
                        formatdate<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>,
                        <span style="color: #808080; font-style: italic;"># le record formaté</span>
                        msg<span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #008000;">self</span>.<span style="color: black;">username</span>:
            <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #008000;">self</span>.<span style="color: black;">secure</span> <span style="color: #ff7700;font-weight:bold;">is</span> <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #008000;">None</span>:
                smtp.<span style="color: black;">ehlo</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
                smtp.<span style="color: black;">starttls</span><span style="color: black;">&#40;</span><span style="color: #66cc66;">*</span><span style="color: #008000;">self</span>.<span style="color: black;">secure</span><span style="color: black;">&#41;</span>
                smtp.<span style="color: black;">ehlo</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
            smtp.<span style="color: black;">login</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">username</span>, <span style="color: #008000;">self</span>.<span style="color: black;">password</span><span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># Le mail et envoyé</span>
        smtp.<span style="color: black;">sendmail</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">fromaddr</span>, <span style="color: #008000;">self</span>.<span style="color: black;">toaddrs</span>, msg<span style="color: black;">&#41;</span>
&nbsp;
        smtp.<span style="color: black;">quit</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: black;">&#40;</span><span style="color: #008000;">KeyboardInterrupt</span>, <span style="color: #008000;">SystemExit</span><span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">raise</span>
    <span style="color: #ff7700;font-weight:bold;">except</span>:
        <span style="color: #008000;">self</span>.<span style="color: black;">handleError</span><span style="color: black;">&#40;</span>record<span style="color: black;">&#41;</span></pre></div></div>

<p>Qu&#8217;est-ce qu&#8217;il se passe?</p>
<p>Après quelques tests genre:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">    msg = <span style="color: #008000;">self</span>.<span style="color: black;">format</span><span style="color: black;">&#40;</span>record<span style="color: black;">&#41;</span>
    <span style="color: #808080; font-style: italic;"># C'est pratique parfois un petit print</span>
    <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #008000;">type</span><span style="color: black;">&#40;</span>msg<span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;">##</span></pre></div></div>

<p>&#8230; on voit que la méthode <code>format</code> (qui structure votre log selon la forme passée à logging.Formatter) retourne un objet de type unicode si le message que vous avez loggué (<code>logger.critical(u"% foiré!", trace)</code>) contient de l&#8217;unicode.</p>
<p>Idem pour <code>getSubject(record)</code> qui, en l&#8217;état, ne fait que retourner le sujet du email tel que vous l&#8217;avez passé à l&#8217;instanciation de SMTPHandler.</p>
<p>Donc, quand msg est formaté, si le log ou le message sont en unicode, msg sera en unicode.</p>
<h2>WTF!?</h2>
<p>J&#8217;ai été surpris quand j&#8217;ai fini par piger comment ça fonctionne. Même pour un débutant comme moi ça a l&#8217;air bête.</p>
<p>J&#8217;y connais rien en email, mais il ne m&#8217;a pas fallu longtemps pour comprendre que, dans sa forme basique, un email c&#8217;est du ascii, point. Et que si on veut envoyer autre chose que du ascii, qui soit décodable de l&#8217;autre côté, il faut qu&#8217;il y ait les headers appropriés, que le contenu soit encodé, que sais-je encore&#8230;</p>
<p>Peut-être un truc programmé par des gars qui ne manipulent jamais autre chose que de l&#8217;anglais? Ils auraient essayé d&#8217;envoyer un mail en russes ou en suédois, ça se serait planté au premier test. Oui, oui, Sam, la lingua franca, tout ça&#8230;</p>
<p>Ou alors c&#8217;est pour des questions de compatibilité avec des versions antérieures de python qui ne contiendraient pas les ressources nécessaires pour formater correctement un mail? Aucune idée&#8230;</p>
<p>Comment régler ça?</p>
<h2>Il mangea u&#8221;\xe9&#8243; et il en redemanda</h2>
<p>Le module <a href="http://docs.python.org/2/library/email.html"> email </a> de la lib standard permet de créer des emails. On trouve dans <code>email.mime</code> une classe MIMEText qui nous conviendra parfaitement. On va donc subclasser SMTPHandler et réécrire la méthode <code>emit</code> pour qu&#8217;elle construise un message &#8220;RFC-compliant&#8221;, comme ils disent dans la doc.</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">class</span> SMTPHandler_unicode<span style="color: black;">&#40;</span>SMTPHandler<span style="color: black;">&#41;</span>:
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> emit<span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, record<span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">try</span>:
            <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">smtplib</span>
            <span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">email</span>.<span style="color: black;">utils</span> <span style="color: #ff7700;font-weight:bold;">import</span> formatdate
&nbsp;
            <span style="color: #808080; font-style: italic;"># On importe MIMEText</span>
            <span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">email</span>.<span style="color: black;">mime</span>.<span style="color: black;">text</span> <span style="color: #ff7700;font-weight:bold;">import</span> MIMEText
&nbsp;
            port = <span style="color: #008000;">self</span>.<span style="color: black;">mailport</span>
            <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #ff7700;font-weight:bold;">not</span> port:
                port = <span style="color: #dc143c;">smtplib</span>.<span style="color: black;">SMTP_PORT</span> <span style="color: #808080; font-style: italic;"># 25</span>
            smtp = <span style="color: #dc143c;">smtplib</span>.<span style="color: black;">SMTP</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">mailhost</span>, port<span style="color: black;">&#41;</span>
&nbsp;
            msg = <span style="color: #008000;">self</span>.<span style="color: black;">format</span><span style="color: black;">&#40;</span>record<span style="color: black;">&#41;</span>
&nbsp;
            <span style="color: #808080; font-style: italic;"># Au moment de la création de l'objet par MIMEText,</span>
            <span style="color: #808080; font-style: italic;">#  si msg est de type unicode, il sera encodé</span>
            <span style="color: #808080; font-style: italic;">#  selon _charset, sinon il sera laissé tel quel</span>
            message = MIMEText<span style="color: black;">&#40;</span>msg, _charset = <span style="color: #483d8b;">&quot;utf-8&quot;</span><span style="color: black;">&#41;</span>
&nbsp;
            <span style="color: #808080; font-style: italic;"># On ajoute les headers nécessaires. S'il sont de type unicode,</span>
            <span style="color: #808080; font-style: italic;">#  ils seront encodés selon _charset</span>
            message.<span style="color: black;">add_header</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Subject&quot;</span>, <span style="color: #008000;">self</span>.<span style="color: black;">getSubject</span><span style="color: black;">&#40;</span>record<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
            message.<span style="color: black;">add_header</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;From&quot;</span>, <span style="color: #008000;">self</span>.<span style="color: black;">fromaddr</span><span style="color: black;">&#41;</span>
            message.<span style="color: black;">add_header</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;To&quot;</span>, <span style="color: #483d8b;">&quot;,&quot;</span>.<span style="color: black;">join</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">toaddrs</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
            message.<span style="color: black;">add_header</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Date&quot;</span>, formatdate<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
            <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #008000;">self</span>.<span style="color: black;">username</span>:
                <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #008000;">self</span>.<span style="color: black;">secure</span> <span style="color: #ff7700;font-weight:bold;">is</span> <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #008000;">None</span>:
                    smtp.<span style="color: black;">ehlo</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
                    smtp.<span style="color: black;">starttls</span><span style="color: black;">&#40;</span><span style="color: #66cc66;">*</span><span style="color: #008000;">self</span>.<span style="color: black;">secure</span><span style="color: black;">&#41;</span>
                    smtp.<span style="color: black;">ehlo</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
                smtp.<span style="color: black;">login</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">username</span>, <span style="color: #008000;">self</span>.<span style="color: black;">password</span><span style="color: black;">&#41;</span>
&nbsp;
            <span style="color: #808080; font-style: italic;"># Envoi du message proprement encodé</span>
            smtp.<span style="color: black;">sendmail</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">fromaddr</span>, <span style="color: #008000;">self</span>.<span style="color: black;">toaddrs</span>, message.<span style="color: black;">as_string</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
            smtp.<span style="color: black;">quit</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: black;">&#40;</span><span style="color: #008000;">KeyboardInterrupt</span>, <span style="color: #008000;">SystemExit</span><span style="color: black;">&#41;</span>:
            <span style="color: #ff7700;font-weight:bold;">raise</span>
        <span style="color: #ff7700;font-weight:bold;">except</span>:
            <span style="color: #008000;">self</span>.<span style="color: black;">handleError</span><span style="color: black;">&#40;</span>record<span style="color: black;">&#41;</span></pre></div></div>

<p>Ce qui est intéressant avec MIMEText c&#8217;est que si vous déclarez un encodage (<code>_charset = "utf-8"</code>), et que vous passez une chaîne unicode a l&#8217;instanciation, il l&#8217;encodera selon <code>_charset</code>.</p>
<p>Idem si vous ajoutez un header en appelant <code>add_header</code>, ce qui permet dans notre cas de traiter correctement le sujet du mail.</p>
<p>L&#8217;appel à la méthode <code>to_string</code> retournera le message proprement encodé (en base64) pour le transfert, et les headers appropriés seront inclus.</p>
<p>Voilà, il ne reste plus qu&#8217;à utiliser cette classe pour créer mail_handler, et le tour est joué.</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">mail_handler = SMTPHandler_unicode<span style="color: black;">&#40;</span>
    <span style="color: #808080; font-style: italic;"># host et port</span>
    <span style="color: black;">&#40;</span><span style="color: #483d8b;">'SMTP.GMAIL.COM'</span>, <span style="color: #ff4500;">587</span><span style="color: black;">&#41;</span>,
    <span style="color: #808080; font-style: italic;"># From</span>
    <span style="color: #483d8b;">&quot;MOI@GMAIL.COM&quot;</span>,
    <span style="color: #808080; font-style: italic;"># To (liste)s</span>
    <span style="color: black;">&#91;</span><span style="color: #483d8b;">&quot;QUELQU.UN@QUELQUE.PART&quot;</span><span style="color: black;">&#93;</span>,
    <span style="color: #808080; font-style: italic;"># sujet du message</span>
    u<span style="color: #483d8b;">&quot;Bonjour Mr Freud. %s a encore repéré des pensées génantes&quot;</span> <span style="color: #66cc66;">%</span> nom_loggeur,
    <span style="color: #808080; font-style: italic;"># pour l'authentification</span>
    credentials = <span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;MONEMAIL@GMAIL.COM&quot;</span>, <span style="color: #483d8b;">&quot;MONSUPERPASSWORD&quot;</span><span style="color: black;">&#41;</span>,
    secure = <span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: black;">&#41;</span></pre></div></div>

<p>Bilan de l&#8217;histoire: c&#8217;est en débutant qu&#8217;on devient débutant&#8230;</p>
<hr />
<a href="https://github.com/sametmax/codes-des-articles/blob/master/2013/mars/envoi_mail_on_crash.py">Télécharger le code de l&#8217;article.</a></p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=5313&amp;md5=2a70d8c9d9e3c74fb78760edd63af5f9" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/envoi-dun-email-par-logging-en-cas-de-plantage-dun-script-python-ou-comment-faire-bouffer-uxe9-a-smtphandler/feed/</wfw:commentRss>
		<slash:comments>9</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fenvoi-dun-email-par-logging-en-cas-de-plantage-dun-script-python-ou-comment-faire-bouffer-uxe9-a-smtphandler%2F&amp;language=en_GB&amp;category=text&amp;title=Envoi+d%26%238217%3Bun+email+par+logging+en+cas+de+plantage+d%26%238217%3Bun+script+python+%28ou%3A+comment+faire+bouffer+u%26%238221%3B%5Cxe9%26%238243%3B+%C3%A0+SMTPHandler%29&amp;description=%28Ceci+est+un+post+invit%C3%A9+d%26%238217%3Bun+d%C3%A9butant+pour+les+d%C3%A9butants%26%238230%3B+sous+licence+creative+common+3.0+unported.%29+Il+y+a+peu%2C+je+me+suis+mis+%C3%A0+utiliser+logging+pour+debugger+mes...&amp;tags=callback%2Cemail%2Cexception%2Clogguer%2Cpython%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/03/tu_va_me_le_bouffer_oui.jpg" length="45654" type="image/jpg" />	</item>
		<item>
		<title>Log post mortem avec Python</title>
		<link>http://sametmax.com/log-post-mortem-avec-python/</link>
		<comments>http://sametmax.com/log-post-mortem-avec-python/#comments</comments>
		<pubDate>Thu, 07 Mar 2013 11:25:58 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[callback]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[exceptions]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=5260</guid>
		<description><![CDATA[Recette de callback sur un crash de la VM suite à la levée d'une exception.]]></description>
			<content:encoded><![CDATA[<p>Il y a des mois de ça, j&#8217;avais écris <a href="http://sametmax.com/lancer-une-fonction-automatiquement-a-larret-de-python/">un article sur atexit</a>, un module qui permet de lancer une fonction à la fermeture de la VM Python.</p>
<p>Ces fonctions sont appelées même si la VM s&#8217;arrête brutalement, mais on a aucune information sur la raison de l&#8217;arrêt de la machine virtuelle Python. Et elles sont exécutées même si tout s&#8217;est bien passé.</p>
<p>Si vous voulez réagir au plantage de votre programme, et seulement au plantage, tout en ayant en plus des informations sur la nature du foinage :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">sys</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> on_crash<span style="color: black;">&#40;</span><span style="color: #008000;">type</span>, value, tb<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #008000;">type</span>
    <span style="color: #ff7700;font-weight:bold;">print</span> value
    <span style="color: #ff7700;font-weight:bold;">print</span> tb
&nbsp;
<span style="color: #dc143c;">sys</span>.<span style="color: black;">excepthook</span> = on_crash
&nbsp;
declencher_erreur = <span style="color: #ff4500;">1</span> + <span style="color: #483d8b;">&quot;1&quot;</span>
&nbsp;
<span style="color: #808080; font-style: italic;">## &lt;type 'exceptions.TypeError'&gt;</span>
<span style="color: #808080; font-style: italic;">## unsupported operand type(s) for +: 'int' and 'str'</span>
<span style="color: #808080; font-style: italic;">## &lt;traceback object at 0x00543AF8&gt;</span></pre></div></div>

<p>Ca peut être très intéressant pour débugger un processus détaché comme par exemple votre serveur WSGI qui fait tourner Django qui décide de se petit-suicider : demandez à <code>sys.excepthook</code> de faire un dump de l&#8217;exception dans un fichier log , et vous pourrez voir ce qui a propoqué la crise.</p>
<p>Si vous êtes du genre poli, vous voudrez quand même garder l&#8217;ancien comportement de <code>sys.excepthook</code>, qui est toujours disponible depuis <code>sys.__excepthook__</code> :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> on_crash<span style="color: black;">&#40;</span><span style="color: #008000;">type</span>, value, tb<span style="color: black;">&#41;</span>:
    <span style="color: #808080; font-style: italic;"># faire ce que vous voulez ici puis...</span>
    <span style="color: #dc143c;">sys</span>.__excepthook__<span style="color: black;">&#40;</span><span style="color: #008000;">type</span>, value, tb<span style="color: black;">&#41;</span></pre></div></div>

<p>Et dire que vous commenciez à croire que vous saviez presque tout sur Python. Mouarf.</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=5260&amp;md5=49b3bf3df1505a609545c25b33674881" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/log-post-mortem-avec-python/feed/</wfw:commentRss>
		<slash:comments>8</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Flog-post-mortem-avec-python%2F&amp;language=en_GB&amp;category=text&amp;title=Log+post+mortem+avec+Python&amp;description=Il+y+a+des+mois+de+%C3%A7a%2C+j%26%238217%3Bavais+%C3%A9cris+un+article+sur+atexit%2C+un+module+qui+permet+de+lancer+une+fonction+%C3%A0+la+fermeture+de+la+VM+Python.+Ces+fonctions...&amp;tags=callback%2Cdjango%2Cexceptions%2Cpython%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/03/the-walking-dead-3-the-walking-dead-24037474-500-333.jpg" length="54725" type="image/jpg" />	</item>
		<item>
		<title>Explication de code : callback à la mise à jour d&#8217;un array Numpy</title>
		<link>http://sametmax.com/explication-de-code-callback-a-la-mise-a-jour-dun-array-numpy/</link>
		<comments>http://sametmax.com/explication-de-code-callback-a-la-mise-a-jour-dun-array-numpy/#comments</comments>
		<pubDate>Thu, 30 Aug 2012 14:32:13 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[callback]]></category>
		<category><![CDATA[numpy]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=1939</guid>
		<description><![CDATA[Toujours dans l'esprit de <a href="http://sametmax.com/envoyez-nous-les-scripts-que-vous-ne-pigez-pas/">l'explication de code</a>, voici <a href="http://www.0bin.net/paste/ac4b9c44e0cbb390f77fc6682a7d2012e537ee98#floRq8jO45iZ1aYK9DtGRJnF5gooG00pO45zHB/fkl4=">un petit bout de numpyries</a> envoyé par un lecteur.]]></description>
			<content:encoded><![CDATA[<p>Toujours dans l&#8217;esprit de <a href="http://sametmax.com/envoyez-nous-les-scripts-que-vous-ne-pigez-pas/">l&#8217;explication de code</a>, voici <a href="http://www.0bin.net/paste/ac4b9c44e0cbb390f77fc6682a7d2012e537ee98#floRq8jO45iZ1aYK9DtGRJnF5gooG00pO45zHB/fkl4=">un petit bout de numpyries</a> envoyé par un lecteur.</p>
<p>Lisez l&#8217;article sur les <a href="http://sametmax.com/quest-ce-quun-callback/">callbacks</a> si vous n&#8217;êtes pas familiers avec le principe, et en avant:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #808080; font-style: italic;"># on importe numpy, une bibliothèque spécialisée dans le calculs impliquant de grands</span>
<span style="color: #808080; font-style: italic;"># jeux de nombres et très utilisée par les scientifiques</span>
<span style="color: #ff7700;font-weight:bold;">import</span> numpy <span style="color: #ff7700;font-weight:bold;">as</span> np
&nbsp;
<span style="color: #808080; font-style: italic;"># On créé une classe qui hérite du type np.ndarray qui est un type d'array</span>
<span style="color: #808080; font-style: italic;"># de taille fixe, et dont tous les objets doivent être du même type,</span>
<span style="color: #808080; font-style: italic;"># mais qui peut avoir plusieurs dimensions et qui est très rapide à manipuler</span>
<span style="color: #808080; font-style: italic;"># Notez que par convention NumPy n'utilise pas de majuscule pour le nom de </span>
<span style="color: #808080; font-style: italic;"># ces types pour matcher str, int, unicode, etc. Pour rester congruent,</span>
<span style="color: #808080; font-style: italic;"># la classe enfant ne le fait pas non plus. Ne prenez pas cette habitude, </span>
<span style="color: #808080; font-style: italic;"># c'est un cas particulier.</span>
<span style="color: #ff7700;font-weight:bold;">class</span> cbarray<span style="color: black;">&#40;</span>np.<span style="color: black;">ndarray</span><span style="color: black;">&#41;</span>:
&nbsp;
&nbsp;
    <span style="color: #808080; font-style: italic;"># __new__ est la seule méthode de classe par défaut, sans déclaration de @classmethode, </span>
    <span style="color: #808080; font-style: italic;"># donc le premier argument sera la classe en court. Normalement la convention</span>
    <span style="color: #808080; font-style: italic;"># est d'appeler cet argument cls, mais ici l'auteur fait à sa sauce...</span>
    <span style="color: #808080; font-style: italic;">#</span>
    <span style="color: #808080; font-style: italic;"># Le reste des arguments sont les mêmes que pour __init__: ce sont ceux</span>
    <span style="color: #808080; font-style: italic;"># attendus à l'instanciation de la classe cbarray:</span>
    <span style="color: #808080; font-style: italic;">#   * data sont les données qu'on veut mettre dans l'array</span>
    <span style="color: #808080; font-style: italic;">#   * cb est un callback qu'on appelera à chaque mise à jour de l'array</span>
    <span style="color: #808080; font-style: italic;">#   * dtype est le type des données à mettre dans l'array (si on veut bypasser l'autodétection)</span>
    <span style="color: #808080; font-style: italic;">#   * copy pour présicer si on veut copier les données, ou juste liér les données existantes</span>
    <span style="color: #808080; font-style: italic;"># </span>
    <span style="color: #808080; font-style: italic;"># __new__ est appelée avant __init__: elle prend les paramètres qu'attend __init__, </span>
    <span style="color: #808080; font-style: italic;"># fabrique une instance, la retournepuis __init__ est appelée avec l'instance. </span>
    <span style="color: #808080; font-style: italic;"># On a rarement besoin d'overrider __new__, en générale __init__ est un meilleur choix</span>
    <span style="color: #808080; font-style: italic;"># car c'est plus simple. Mais certains types NumPy ne permettent pas de faire </span>
    <span style="color: #808080; font-style: italic;"># autrement.</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__new__</span><span style="color: black;">&#40;</span>subtype, data, cb=<span style="color: #008000;">None</span>, dtype=<span style="color: #008000;">None</span>, <span style="color: #dc143c;">copy</span>=<span style="color: #008000;">False</span><span style="color: black;">&#41;</span>:
&nbsp;
        <span style="color: #808080; font-style: italic;"># On attache le callback à la CLASSE, et non à l'instance.</span>
        <span style="color: #808080; font-style: italic;"># Ca peut paraitre étrange, mais on verra plus bas pour</span>
        subtype.__defaultcb = cb
&nbsp;
        <span style="color: #808080; font-style: italic;"># Selon que l'on souhaite copier les données, ou juste les lier</span>
        <span style="color: #808080; font-style: italic;"># on créé une instance d'un type différent.</span>
        <span style="color: #808080; font-style: italic;"># Notez que l'absence d'espace atour de &quot;,&quot; et &quot;=&quot; n'est pas recommandé</span>
        <span style="color: #808080; font-style: italic;"># pas le PEP8</span>
        <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #dc143c;">copy</span>:
            data = np.<span style="color: #dc143c;">array</span><span style="color: black;">&#40;</span>data,dtype=dtype<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">else</span>:
            data = np.<span style="color: black;">asarray</span><span style="color: black;">&#40;</span>data,dtype=dtype<span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># Cette astuce permet d'utiliser un des deux types du dessus</span>
        <span style="color: #808080; font-style: italic;"># mais au travers de l'API du type &quot;subtype&quot;, c'est à dire notre </span>
        <span style="color: #808080; font-style: italic;"># classe.</span>
        data = data.<span style="color: black;">view</span><span style="color: black;">&#40;</span>subtype<span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># On retourne l'instance ainsi créé.</span>
        <span style="color: #808080; font-style: italic;"># Quand l'utilisateur fera cbarray(....), c'est cette instance</span>
        <span style="color: #808080; font-style: italic;"># qu'il recevra</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> data
&nbsp;
    <span style="color: #808080; font-style: italic;"># Juste une méthode qui appelle le callback si il existe</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> _notify<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #008000;">self</span>.<span style="color: black;">cb</span> <span style="color: #ff7700;font-weight:bold;">is</span> <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #008000;">None</span>:
            <span style="color: #008000;">self</span>.<span style="color: black;">cb</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># Une propriété qui retourne un attribut de l'objet</span>
    <span style="color: #808080; font-style: italic;"># en s'assurant qu'on utilise celui du parent.</span>
    <span style="color: #808080; font-style: italic;"># C'est une supposition mais je pense que shape est une propriété du</span>
    <span style="color: #808080; font-style: italic;"># parent, qu'elle n'est pas dispo sur le type array ou asarray, et </span>
    <span style="color: #808080; font-style: italic;"># que l'astuce data.view ne suffit pas à faire un proxy de celle-ci.</span>
    <span style="color: #808080; font-style: italic;"># Donc je pense que ça sert à donner accès à cette donnée.</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> _get_shape<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">super</span><span style="color: black;">&#40;</span>cbarray, <span style="color: #008000;">self</span><span style="color: black;">&#41;</span>.<span style="color: black;">shape</span>
    shape = <span style="color: #008000;">property</span><span style="color: black;">&#40;</span>_get_shape<span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># __setitem__ est une méthode &quot;magique&quot;, appelée automatiquement qu'on</span>
    <span style="color: #808080; font-style: italic;"># fait array[item] = val</span>
    <span style="color: #808080; font-style: italic;"># Ici on l'utilise pour appeler _notify() à chaque mise à jour de l'array</span>
    <span style="color: #808080; font-style: italic;"># et donc d'appeler le callback à chaque mise à jour.</span>
    <span style="color: #808080; font-style: italic;"># Il est dommage de ne pas passer de paramètre à la méthode, comme </span>
    <span style="color: #808080; font-style: italic;"># l'ancienne valeur, l'item et la nouvelle valeur. Le callback va être</span>
    <span style="color: #808080; font-style: italic;"># du coup assez limité. Mais ça suffira si par exemple tout ce qu'on</span>
    <span style="color: #808080; font-style: italic;"># veut faire c'est écrire dans un fichier à chaque modification.</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__setitem__</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, item, val<span style="color: black;">&#41;</span>:
        np.<span style="color: black;">ndarray</span>.<span style="color: #0000cd;">__setitem__</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, item, val<span style="color: black;">&#41;</span>
        <span style="color: #008000;">self</span>._notify<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># NumPy permet de créer des sous types à partir du type de base, c'est</span>
    <span style="color: #808080; font-style: italic;"># d'ailleurs une manière très courrante de créer des nouveaux conteneurs</span>
    <span style="color: #808080; font-style: italic;"># de données. Mais ce faisant, NumPy bypass le mécanisme d'instanciation,</span>
    <span style="color: #808080; font-style: italic;"># et __new__ et __init__ ne sont donc pas appelées. Pour y pallier, NumPy</span>
    <span style="color: #808080; font-style: italic;"># ajoute la méthode __array_finalize__ qui est toujours appelée quand</span>
    <span style="color: #808080; font-style: italic;"># un array est prêt à être utilisé. Elle peut être utilisée pour effectuer</span>
    <span style="color: #808080; font-style: italic;"># un traitement pour chaque array créé, quelque soit sa provenance.</span>
    <span style="color: #808080; font-style: italic;"># Ici, on l'utilise pour attacher le callback à &quot;l'instance&quot;.</span>
    <span style="color: #808080; font-style: italic;"># Souvenez-vous, plus haut on avait attaché le callback à la CLASSE.</span>
    <span style="color: #808080; font-style: italic;"># Cette classe peut derrière être la source de nombreux arrays même si</span>
    <span style="color: #808080; font-style: italic;"># __init__ n'est pas appelé pour eux :-(</span>
    <span style="color: #808080; font-style: italic;"># La solution de l'auteur est donc de passer le callback à __new__, de </span>
    <span style="color: #808080; font-style: italic;"># l'attacher à la classe, et à travers __array_finalize__, de l'attacher</span>
    <span style="color: #808080; font-style: italic;"># à &quot;l'instance&quot;. Il faut garder en tête que tout nouvel appel à __new__</span>
    <span style="color: #808080; font-style: italic;"># écrasera le callback pour toutes les instances suivantes. Mis à part</span>
    <span style="color: #808080; font-style: italic;"># cela, ceci garanti que tout array aura le callback, et donc que </span>
    <span style="color: #808080; font-style: italic;"># _notify aura accès au callback, et donc que __setitem__ déclenchera le </span>
    <span style="color: #808080; font-style: italic;"># callback, et donc que la fonction sera bien appelée à chaque mise à jour</span>
    <span style="color: #808080; font-style: italic;"># de l'array</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> __array_finalize__<span style="color: black;">&#40;</span><span style="color: #008000;">self</span>,obj<span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #008000;">hasattr</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, <span style="color: #483d8b;">&quot;cb&quot;</span><span style="color: black;">&#41;</span>:
            <span style="color: #808080; font-style: italic;"># The object does not yet have a `.cb` attribute</span>
            <span style="color: #008000;">self</span>.<span style="color: black;">cb</span> = <span style="color: #008000;">getattr</span><span style="color: black;">&#40;</span>obj,<span style="color: #483d8b;">'cb'</span>,<span style="color: #008000;">self</span>.__defaultcb<span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># Encore une méthode &quot;magique&quot; ajoutée par NumPy. Elle est appelée</span>
    <span style="color: #808080; font-style: italic;"># quand on sérialise l'array et retourne des informations sur l'état</span>
    <span style="color: #808080; font-style: italic;"># de l'array</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> __reduce__<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        object_state = <span style="color: #008000;">list</span><span style="color: black;">&#40;</span>np.<span style="color: black;">ndarray</span>.__reduce__<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
        subclass_state = <span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">cb</span>,<span style="color: black;">&#41;</span>
        object_state<span style="color: black;">&#91;</span><span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span> = <span style="color: black;">&#40;</span>object_state<span style="color: black;">&#91;</span><span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span>,subclass_state<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">tuple</span><span style="color: black;">&#40;</span>object_state<span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># inverse de __reduce__</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> __setstate__<span style="color: black;">&#40;</span><span style="color: #008000;">self</span>,state<span style="color: black;">&#41;</span>:
        nd_state, own_state = state
        np.<span style="color: black;">ndarray</span>.__setstate__<span style="color: black;">&#40;</span><span style="color: #008000;">self</span>,nd_state<span style="color: black;">&#41;</span>
&nbsp;
        cb, = own_state
        <span style="color: #008000;">self</span>.<span style="color: black;">cb</span> = cb
&nbsp;
<span style="color: #808080; font-style: italic;"># Le callback qui doit être appelé à chaque mise à jour de l'array</span>
<span style="color: #808080; font-style: italic;"># Je ne pense pas que ça puisse marcher, car il attend un argument,</span>
<span style="color: #808080; font-style: italic;"># ce que _notify() ne lui passe pas.</span>
<span style="color: #ff7700;font-weight:bold;">def</span> callback<span style="color: black;">&#40;</span>arg<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">'array changed to'</span>,arg
&nbsp;
&nbsp;
<span style="color: #808080; font-style: italic;"># une petit démo du code si on run le script au lieu de l'importer</span>
<span style="color: #ff7700;font-weight:bold;">if</span> __name__ == <span style="color: #483d8b;">'__main__'</span>:
    x = cbarray<span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>,<span style="color: #ff4500;">2</span>,<span style="color: #ff4500;">3</span><span style="color: black;">&#93;</span>, cb=callback<span style="color: black;">&#41;</span>
    x<span style="color: black;">&#91;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span>,<span style="color: #ff4500;">1</span><span style="color: black;">&#93;</span><span style="color: black;">&#93;</span> = <span style="color: #ff4500;">1.0</span></pre></div></div>

 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=1939&amp;md5=29e2cc6d96f81cda73c3467acc935bd7" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/explication-de-code-callback-a-la-mise-a-jour-dun-array-numpy/feed/</wfw:commentRss>
		<slash:comments>2</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fexplication-de-code-callback-a-la-mise-a-jour-dun-array-numpy%2F&amp;language=en_GB&amp;category=text&amp;title=Explication+de+code+%3A+callback+%C3%A0+la+mise+%C3%A0+jour+d%26%238217%3Bun+array+Numpy&amp;description=Toujours+dans+l%26%238217%3Besprit+de+l%26%238217%3Bexplication+de+code%2C+voici+un+petit+bout+de+numpyries+envoy%C3%A9+par+un+lecteur.+Lisez+l%26%238217%3Barticle+sur+les+callbacks+si+vous+n%26%238217%3B%C3%AAtes+pas+familiers+avec+le+principe%2C...&amp;tags=callback%2Cnumpy%2Cpython%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2012/08/7-Days-Pill-Box-H19-.jpg" length="51439" type="image/jpg" />	</item>
		<item>
		<title>Qu&#8217;est-ce qu&#8217;un callback ?</title>
		<link>http://sametmax.com/quest-ce-quun-callback/</link>
		<comments>http://sametmax.com/quest-ce-quun-callback/#comments</comments>
		<pubDate>Wed, 22 Aug 2012 17:19:07 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[callback]]></category>
		<category><![CDATA[lambda]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=1831</guid>
		<description><![CDATA[Un jour vous vous baladez avec vos premiers succès en prog, vous vous chauffer à utiliser une library externe (ce qui fait toujours peur au début) et il y a un truc que vous ne savez pas faire. Vous posez la question sur un forum, et on vous répond: "<q>mais c'est simple, il suffit de passer un callback</q>".]]></description>
			<content:encoded><![CDATA[<p>mettreOn nous a parfois reproché de ne pas faire assez de tutos pour débutant. C&#8217;est pas faux, d&#8217;autant que quand j&#8217;ai commencé j&#8217;étais bien content que le <a href="http://www.siteduzero.com/">site du zéro</a> ait choisi de se spécialiser là dedans. Les tutos pour débutant sont vraiment la pierre angulaire de l&#8217;attractivité d&#8217;une techno.</p>
<p>Donc, un jour vous vous baladez avec vos premiers succès en prog, vous vous chauffer à utiliser une library externe (ce qui fait toujours peur au début) et il y a un truc que vous ne savez pas faire. Vous posez la question sur un forum, et on vous répond: &#8220;<q>mais c&#8217;est simple, il suffit de passer un callback</q>&#8220;.</p>
<p>Doh.</p>
<h2>
Rappel: on peut passer des fonctions en argument</h2>
<p>Une fonction, ce n&#8217;est pas juste un bout de code auquel on donne un nom. C&#8217;est une unité de programmation à elle toute seule, en tout cas dans les langages modernes, et on dit dans ce cas qu&#8217;elles sont des &#8220;first class citizen&#8221; (citoyen de première catégorie, quoi, du vrai, du dur, du pur).</p>
<p>En pratique, ça veut dire qu&#8217;on peut manipuler la fonction sans l&#8217;éxécuter. En python ça donne ça:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">def</span> dis_bonjour<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
...     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;bonjour&quot;</span>
...
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">print</span> dis_bonjour <span style="color: #808080; font-style: italic;"># afficher l'objet fonction</span>
<span style="color: #66cc66;">&lt;</span>function dis_bonjour at 0x7f8cc6fce578<span style="color: #66cc66;">&gt;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> dis_bonjour.<span style="color: black;">func_name</span> <span style="color: #808080; font-style: italic;"># afficher le nom de la fonction</span>
<span style="color: #483d8b;">'dis_bonjour'</span></pre></div></div>

<p>Ca veut dire aussi qu&#8217;on peut passer une fonction comme argument:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">def</span> fonction_qui_appelle_une_fonction<span style="color: black;">&#40;</span>fonction_a_appeler<span style="color: black;">&#41;</span>:
...     <span style="color: black;">fonction_a_appeler</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
...
<span style="color: #66cc66;">&gt;&gt;&gt;</span> fonction_qui_appelle_une_fonction<span style="color: black;">&#40;</span>dis_bonjour<span style="color: black;">&#41;</span>
bonjour</pre></div></div>

<h2>Mais Za Koi ça sert ?</h2>
<p>Et bien à dire qu&#8217;on va exécuter du code, même si on ne sait pas encore à l&#8217;avance quel est ce code. C&#8217;est très utile quand on code soit-même une bibliothèque pour permettre aux utilisateurs de celle-ci d’exécuter du code durant le fonctionnement de notre algo, sans avoir à mettre la main dedans.</p>
<p>C&#8217;est exactement ce que font les callback (ou appel en retour, traduit grossièrement).</p>
<p>Un callback, c&#8217;est une fonction passée en paramètre, qui va être appelée à une condition. La condition est la plus souvent &#8220;quand ceci arrive&#8221; et &#8220;ceci&#8221; est le plus souvent &#8220;quand le traitement est terminé&#8221;. Donc la grande majorité des callbacks sont des fonctions qu&#8217;on passe à d&#8217;autres fonctions pour qu&#8217;elles soient exécutées quand le traitement est terminé.</p>
<h2>Des exemples, des exemples !</h2>
<p>Si vous faites une interface graphique, vous voulez qu&#8217;un clic sur un bouton déclenche une action. Cette action est souvent passée comme un callback.</p>
<p>Exemple avec ce petit programme Tkinter (la lib d&#8217;UI installée par défaut avec Python):</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">Tkinter</span> <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #66cc66;">*</span> <span style="color: #808080; font-style: italic;"># import de tout TK</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> root = Tk<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># création de la fenêtre</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">def</span> crie_ta_joie<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>: <span style="color: #808080; font-style: italic;"># notre callback</span>
...     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Yo !&quot;</span>
...
<span style="color: #66cc66;">&gt;&gt;&gt;</span> b = Button<span style="color: black;">&#40;</span>root, text=<span style="color: #483d8b;">&quot;Go&quot;</span>, command=crie_ta_joie<span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># création d'un bouton</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> b.<span style="color: black;">pack</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># placement du bouton</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> root.<span style="color: black;">mainloop</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># mise en route de l'UI</span></pre></div></div>

<p><code>crie_ta_joie</code> est passée à la classe <code>Button</code> via le paramètre <code>command</code>. Quand on cliquera sur le bouton &#8216;Go&#8217;, le callback <code>crie_ta_joie</code> sera donc appelé. &#8216;Yo !&#8217; sera affiché dans le terminal.</p>
<p>C&#8217;est ce qu&#8217;on appelle la programmation événementielle: on écrit des fonctions qui sont appelées quand des événements arrivent, ici le clic sur un bouton.</p>
<h2>Et en javascript&#8230;</h2>
<p>Si vous utilisez jQuery, vous utilisez déjà des callbacks partout.</p>
<p>Ainsi, si vous faites:</p>

<div class="wp_syntax"><div class="code"><pre class="javascript" style="font-family:monospace;">$.<span style="color: #660066;">get</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'/arretez/ou/ma/mere/va/tirer'</span><span style="color: #339933;">,</span> <span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
    <span style="color: #000066;">alert</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'Bang !'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre></div></div>

<p>jQuery va faire une requête ajax sur l&#8217;url, et le programme va continuer de fonctionner car les appels réseaux sont non bloquant. Mais quand la réponse arrivera, le callabck sera appelé, et fera <code>alert(Bang !)</code>.</p>
<p>Les callbacks sont donc très utilisés pour la programmation asynchrone, c&#8217;est à dire quand on ne connaît pas le temps que vont mettre des opérations à s&#8217;effectuer mais qu&#8217;on veut réagir une fois qu&#8217;elle sont terminées.</p>
<h2>L&#8217;injection de dépendances</h2>
<p>Les callbacks sont aussi très utilisés pour une technique de programmation appelée &#8220;injection de dépendances&#8221; qui consiste à permettre à ceux qui utilisent votre code de choisir ce que feront certains bouts de code.</p>
<p>Imaginez une fonction (ici assez simplifiée) de téléchargement qui permet d&#8217;afficher la progression de celui-ci:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">urllib2</span>, <span style="color: #dc143c;">sys</span>
<span style="color: #ff7700;font-weight:bold;">def</span> download<span style="color: black;">&#40;</span>truc_a_telecharger, fichier_de_destination<span style="color: black;">&#41;</span>:
&nbsp;
    <span style="color: #808080; font-style: italic;"># on ouvre la connection</span>
    u = <span style="color: #dc143c;">urllib2</span>.<span style="color: black;">urlopen</span><span style="color: black;">&#40;</span>truc_a_telecharger<span style="color: black;">&#41;</span>
&nbsp;
    taille_des_bouts = <span style="color: #ff4500;">8192</span>
    total_telecharge = <span style="color: #ff4500;">0</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># on ouvre le fichier pour écrire ce qu'on télécharge</span>
    <span style="color: #ff7700;font-weight:bold;">with</span> <span style="color: #008000;">open</span><span style="color: black;">&#40;</span>fichier_de_destination, <span style="color: #483d8b;">'w'</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">as</span> f:
&nbsp;
        <span style="color: #808080; font-style: italic;"># while True / if : break est un palliatif Python</span>
        <span style="color: #808080; font-style: italic;"># pour l'absence d'instruction &quot;until&quot;</span>
        <span style="color: #ff7700;font-weight:bold;">while</span> <span style="color: #008000;">True</span>:
&nbsp;
            <span style="color: #808080; font-style: italic;"># on télécharge un petit bout du fichier</span>
            bout = u.<span style="color: black;">read</span><span style="color: black;">&#40;</span>taille_des_bouts<span style="color: black;">&#41;</span>
            total_telecharge += taille_des_bouts
&nbsp;
            <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #ff7700;font-weight:bold;">not</span> bout: <span style="color: #808080; font-style: italic;"># plus rien à télécharge: on sort</span>
                <span style="color: #ff7700;font-weight:bold;">break</span>
&nbsp;
            <span style="color: #808080; font-style: italic;"># on écrit le bout de fichier téléchargé</span>
            f.<span style="color: black;">write</span><span style="color: black;">&#40;</span>bout<span style="color: black;">&#41;</span>
&nbsp;
            <span style="color: #808080; font-style: italic;"># on écrit un point sur le terminal pour noter qu'un bout a été</span>
            <span style="color: #808080; font-style: italic;"># téléchargé</span>
            <span style="color: #dc143c;">sys</span>.<span style="color: black;">stdout</span>.<span style="color: black;">write</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'.'</span><span style="color: black;">&#41;</span></pre></div></div>

<p>Qui s&#8217;utilise comme ça:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">download<span style="color: black;">&#40;</span><span style="color: #483d8b;">'http://download.ted.com/talks/SirKenRobinson_2006.mp4'</span>, <span style="color: #483d8b;">'ted_talk_education.mp4'</span><span style="color: black;">&#41;</span></pre></div></div>

<p>On pourrait faire beaucoup mieux que juste afficher un point pour chaque bout de fichier téléchargé.  On pourrait par exemple afficher un pourcentage d&#8217;avancement. Ou écrire dans un log. Ou ne rien faire, et supprimer tout affichage.</p>
<p>Mais on veut garder le comportement par défaut car on pense que la plupart des gens l&#8217;utiliseront ainsi, et qu&#8217;il n&#8217;y a pas de raison qu&#8217;ils le recodent.</p>
<p>En modifiant la fonction, et en permettant de passer un callback, on permet cette flexibilité:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> download<span style="color: black;">&#40;</span>truc_a_telecharger, fichier_de_destination,
             <span style="color: #808080; font-style: italic;"># on attend un callback en paramètre</span>
             <span style="color: #808080; font-style: italic;"># mais on en passe un par défaut</span>
             afficher_le_progres=<span style="color: #ff7700;font-weight:bold;">lambda</span> <span style="color: #66cc66;">*</span>x, <span style="color: #66cc66;">**</span>y: <span style="color: #dc143c;">sys</span>.<span style="color: black;">stdout</span>.<span style="color: black;">write</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'.'</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>:
&nbsp;
    u = <span style="color: #dc143c;">urllib2</span>.<span style="color: black;">urlopen</span><span style="color: black;">&#40;</span>truc_a_telecharger<span style="color: black;">&#41;</span>
    <span style="color: #808080; font-style: italic;"># on chope la taille du fichier, ça permettra plus de choses</span>
    taille_du_fichier = <span style="color: #008000;">int</span><span style="color: black;">&#40;</span>u.<span style="color: black;">info</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>.<span style="color: black;">getheaders</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Content-Length&quot;</span><span style="color: black;">&#41;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
    taille_de_bloc = <span style="color: #ff4500;">8192</span>
    total_telecharge = <span style="color: #ff4500;">0</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">with</span> <span style="color: #008000;">open</span><span style="color: black;">&#40;</span>fichier_de_destination, <span style="color: #483d8b;">'w'</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">as</span> f:
&nbsp;
        <span style="color: #ff7700;font-weight:bold;">while</span> <span style="color: #008000;">True</span>:
&nbsp;
            <span style="color: #808080; font-style: italic;"># ici on appelle le callback en lui passant un maximum de paramètres</span>
            <span style="color: #808080; font-style: italic;"># pour qu'il puisse faire le plus de chose possible</span>
            afficher_le_progres<span style="color: black;">&#40;</span>truc_a_telecharger, fichier_de_destination,
                                taille_du_fichier, total_telecharge<span style="color: black;">&#41;</span>
&nbsp;
            bout = u.<span style="color: black;">read</span><span style="color: black;">&#40;</span>taille_de_bloc<span style="color: black;">&#41;</span>
            total_telecharge += taille_de_bloc
&nbsp;
            <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #ff7700;font-weight:bold;">not</span> bout:
                <span style="color: #ff7700;font-weight:bold;">break</span>
&nbsp;
            f.<span style="color: black;">write</span><span style="color: black;">&#40;</span>bout<span style="color: black;">&#41;</span></pre></div></div>

<p>Et on l&#8217;utilise comme avant:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">download<span style="color: black;">&#40;</span><span style="color: #483d8b;">'http://download.ted.com/talks/SirKenRobinson_2006.mp4'</span>, <span style="color: #483d8b;">'ted_talk_education.mp4'</span><span style="color: black;">&#41;</span></pre></div></div>

<p>Ou avec plus de puissance:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> log<span style="color: black;">&#40;</span>truc_a_telecharger, fichier_de_destination,
       taille_du_fichier, total_telecharge<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">with</span> <span style="color: #008000;">open</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'progress.log'</span>, <span style="color: #483d8b;">'w'</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">as</span> f:
        pourcentage = <span style="color: #008000;">str</span><span style="color: black;">&#40;</span>total_telecharge <span style="color: #66cc66;">*</span> <span style="color: #ff4500;">100</span> / taille_du_fichier<span style="color: black;">&#41;</span>
        f.<span style="color: black;">write</span><span style="color: black;">&#40;</span>pourcentage<span style="color: black;">&#41;</span>
&nbsp;
download<span style="color: black;">&#40;</span><span style="color: #483d8b;">'http://download.ted.com/talks/SirKenRobinson_2006.mp4'</span>, <span style="color: #483d8b;">'ted_talk_education.mp4'</span>, log<span style="color: black;">&#41;</span></pre></div></div>

<p>Et si on veut supprimer tout affichage, on peut passe une fonction qui ne fait rien:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">download<span style="color: black;">&#40;</span><span style="color: #483d8b;">'http://download.ted.com/talks/SirKenRobinson_2006.mp4'</span>, <span style="color: #483d8b;">'ted_talk_education.mp4'</span>, <span style="color: #ff7700;font-weight:bold;">lambda</span> <span style="color: #66cc66;">*</span>x: <span style="color: #008000;">None</span><span style="color: black;">&#41;</span></pre></div></div>

<p>Il y a plusieurs choses importantes ici:</p>
<ul>
<li>on accepte un callback en paramètre</li>
<li>le paramètre possède une valeur par défaut. Hé oui, on peut mettre une fonction en valeur par défaut !</li>
<li>la fonction est une fonction anonyme. Ce n&#8217;est pas obligatoire, mais c&#8217;est pratique.</li>
<li>la fonction par défaut utilise l&#8217;<a href="http://sametmax.com/operateur-splat-ou-etoile-en-python/">opérateur splat</a> pour accepter un nombre illimité de paramètres, même si elle ne va pas les utiliser.</li>
<li>on délègue le comportement de l&#8217;algo lors de l&#8217;affichage du progrès à la fonction passée en paramètre.</li>
<li>on passe un max de paramètres à cette fonction pour lui donner le plus de libertés possible. C&#8217;est aussi pour ça que notre fonction accepte par défaut un nombre illimité de paramètres: sinon ça ferait une erreur</li>
</ul>
<p>Ce système est l&#8217;injection de dépendance: on délègue une partie du travail à du code injecté depuis l&#8217;extérieur. Cela permet une extensibilité de notre fonction, sans sacrifier sa simplicité puisqu&#8217;on a une valeur par défaut.</p>
<p>On peut pousser l&#8217;injection très loin: en passant carrément des listes de fonctions, et toutes les appeler, ou des objets, et appeler plusieurs méthodes de l&#8217;objet (ce dernier point est une extension de l&#8217;injection de dépendance appelé le <a href="https://fr.wikipedia.org/wiki/Strat%C3%A9gie_%28patron_de_conception%29">pattern strategy</a>).</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=1831&amp;md5=224523d80fbb1859b26f63157d1cc846" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/quest-ce-quun-callback/feed/</wfw:commentRss>
		<slash:comments>16</slash:comments>
<enclosure url="http://download.ted.com/talks/SirKenRobinson_2006.mp4" length="0" type="video/mp4" />
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fquest-ce-quun-callback%2F&amp;language=en_GB&amp;category=text&amp;title=Qu%26%238217%3Best-ce+qu%26%238217%3Bun+callback+%3F&amp;description=mettreOn+nous+a+parfois+reproch%C3%A9+de+ne+pas+faire+assez+de+tutos+pour+d%C3%A9butant.+C%26%238217%3Best+pas+faux%2C+d%26%238217%3Bautant+que+quand+j%26%238217%3Bai+commenc%C3%A9+j%26%238217%3B%C3%A9tais+bien+content+que+le+site+du+z%C3%A9ro...&amp;tags=callback%2Clambda%2Cpython%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2012/08/th1.jpeg" length="7984" type="image/jpg" />	</item>
	</channel>
</rss>
