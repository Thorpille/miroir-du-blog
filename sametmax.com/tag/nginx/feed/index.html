<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Sam &#38; Max: Python, Django, Git et du cul &#187; nginx</title>
	<atom:link href="http://sametmax.com/tag/nginx/feed/" rel="self" type="application/rss+xml" />
	<link>http://sametmax.com</link>
	<description>Deux développeurs en vadrouille qui se sortent les doigts du code</description>
	<lastBuildDate>Mon, 02 Dec 2013 10:02:45 +0000</lastBuildDate>
	<language>en</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>http://wordpress.org/?v=3.3.1</generator>
	<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2F&amp;language=en_US&amp;category=text&amp;title=Sam+%26amp%3B+Max%3A+Python%2C+Django%2C+Git+et+du+cul&amp;description=Deux+d%C3%A9veloppeurs+en+vadrouille+qui+se+sortent+les+doigts+du+code&amp;tags=blog" type="text/html" />
		<item>
		<title>La stack techno qu&#8217;on utilise pour faire un site Web, et pourquoi</title>
		<link>http://sametmax.com/la-stack-techno-quon-utilise-pour-faire-un-site-web-et-pourquoi/</link>
		<comments>http://sametmax.com/la-stack-techno-quon-utilise-pour-faire-un-site-web-et-pourquoi/#comments</comments>
		<pubDate>Mon, 11 Nov 2013 06:40:38 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[celery]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[fabric]]></category>
		<category><![CDATA[mysql]]></category>
		<category><![CDATA[nginx]]></category>
		<category><![CDATA[nosql]]></category>
		<category><![CDATA[postgres]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[redis]]></category>
		<category><![CDATA[vm]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=7648</guid>
		<description><![CDATA[Une stack techno n'est pas une référence. Il n'y a pas de combo absolu qui rox absolument tout, c'est une question de contexte technique, financier, humain...

Mais c'est vrai que ça aide bien d'avoir sous les yeux les pratiques des autres.]]></description>
			<content:encoded><![CDATA[<p>Une stack techno n&#8217;est pas une référence. Il n&#8217;y a pas de combo absolu qui rox absolument tout, c&#8217;est une question de contexte technique, financier, humain&#8230;</p>
<p>Mais c&#8217;est vrai que ça aide bien d&#8217;avoir sous les yeux les pratiques des autres.</p>
<p>Je ne vais pas expliquer pourquoi Python, <a href="http://sametmax.com/10-raisons-pour-lesquelles-je-suis-toujours-marie-a-python/">je l&#8217;ai déjà fait</a>.</p>
<p>Commençons plutôt par la partie purement Web, pour laquelle on utilise Django, le framework Web Python.</p>
<p>Max et moi avons tout deux fait du PHP avant, j&#8217;ai tâté des frameworks internes, du Symfony et plus tard du Zope. J&#8217;ai regardé du côté de Pyramid et de ses prédécesseurs, et Django est celui qui me plaît le plus. J&#8217;ai juste un peu forcé la main à Max :-)</p>
<p>Car oui, le framework a été avant tout un choix de goût.</p>
<p>Ce n&#8217;est pas un choix de performances : le framework n&#8217;a aucun impact dessus. Aucun. Les architectures ont un impact. Le framework, non. Votre bottleneck sera sur les IO, pas sur le CPU. Le choix de technos asynchrones peut avoir un impact, mais ce n&#8217;est pas une question de framework. Tornado, Twisted ou NodeJS, on s&#8217;en fout. </p>
<p>Donc Django, essentiellement parce qu&#8217;il me plait. Et il me plaît pour ces raisons :</p>
<ul>
<li>Il y a un bon équilibre entre découplage et intégration. En général c&#8217;est soit très découplé et mal intégré, soit très bien intégré et très couplé.</li>
<li>C&#8217;est bien foutu et bien documenté. Et c&#8217;est stable. Vraiment très stable. Les core devs sont hyper sérieux.</li>
<li>C&#8217;est très versatile et ça peut faire plein de trucs out of the box, petits comme gros.</li>
<li>C&#8217;est assez facile à apprendre. Ça reste un framework, donc ce n&#8217;est pas la plus simple des démarches, mais dans le royaume des frameworks de cette taille, ça reste vraiment le plus simple.</li>
<li>La communauté est fantastique : il y a des centaines d&#8217;apps qui couvrent pratiquement tous les besoins.</li>
<li>Et bien entendu, c&#8217;est en Python.</li>
</ul>
<p>En terme de base de données, on a fait du MySQL pendant longtemps. Ça a plutôt bien marché. Maintenant je commence mes nouveaux projets avec PostGres, qui est plus solide. Parfois je fais juste du Sqlite, parce que ça suffit.</p>
<p>Pas de NoSQL. Après plusieurs expériences avec MongoDB et CouchDB, je n&#8217;ai pas été convaincu que les bénéfices dépassaient le coût. Il faudrait un article complet là dessus (qu&#8217;on m&#8217;a d&#8217;ailleurs demandé).</p>
<p>Question OS. c&#8217;est du CentOS avec Max (il a plus l&#8217;habitude) ou du Ubuntu Server pour mes autres projets. Je reste sur les LTS. Ce n&#8217;est pas un choix très réfléchi, c&#8217;est surtout par habitude.</p>
<p>Pas de machine virtuelle. On a essayé, sans y trouver un grand intérêt :</p>
<ul>
<li>Il faut quand même faire des scripts de migration, donc autant s&#8217;en servir pour le déploiement.</li>
<li>On perd en perfs.</li>
<li>Les erreurs liées au mal-fonctionnement d&#8217;une VM sont absolument indébuggable.</li>
<li>Si on ne fait pas la VM soit-même, il faut mettre ses couilles dans les mains d&#8217;un pestataire de service. J&#8217;ai horreur de ça.</li>
<li>Trouver des gens avec la compétence pour gérer une VM, c&#8217;est difficile. Un script de déploiement, c&#8217;est du code que tout dev saura déjà lire. Par extension ça veut dire que je m&#8217;y replonge facilement des semaines plus tard.</li>
</ul>
<p>Et donc pour le déploiement, j&#8217;utilise <a href="http://sametmax.com/travailler-moins-pour-gagner-plus-en-15-minutes-avec-python-fabric/">fabric</a>, avec <a href="https://github.com/ronnix/fabtools/">fabtools</a>.</p>
<p>Ce n&#8217;est pas la solution la plus efficace, d&#8217;autant que ça limite à Python 2.7, mais c&#8217;est la plus simple. C&#8217;est juste du code Python. N&#8217;importe qui peut comprendre le déploiement en 15 minutes. Ça se modifie vite, s&#8217;adapte facilement. </p>
<p>Il faut comprendre qu&#8217;on a jamais plus d&#8217;une dizaine de serveurs pour un projet, ces choix sont donc fait en fonction de cela. Il va sans dire que si vous gérez un parc de centaines de machines, ça ne sera pas du tout le même choix technique. Peut être que Chef ou des VM seront alors carrément plus interressant. Peut être que le NoSQL et sa capacité au scalling sera bien plus rentable.</p>
<p>Il ne s&#8217;agit pas de décrier les technos que nous n&#8217;utilisons pas. Il s&#8217;agit juste de dire, voilà les choix que nous avons fait, dans tel contexte, pour telles (bonnes ou mauvaises) raisons.</p>
<p>Durant les dernières années, on a ajouté <a href="http://redis.io/">Redis</a> à notre stack. C&#8217;est un outil fantastique qui sert à tout : de la base de données pour les trucs simples (il y a des fois ou un schéma est overkill) à la solution de caching. C&#8217;est ce qu&#8217;on a de plus proche du NoSQL.</p>
<p>L&#8217;outil est tellement simple à installer (vraiment le degré zero de la maintenance, c&#8217;est beau) et à utiliser que ça ne vaut juste pas le coup de s&#8217;en priver. </p>
<p>Du coup, plus de memcache. Toutes les grosses requêtes sont sauvegardées dans Redis, dès qu&#8217;on fait un script qui a besoin de persistance temporaire, Redis, pour communiquer entre plusieurs process, Redis, pour toutes les opérations qui ont besoin de grosses perfs comme les stats, Redis. Vive Redis.</p>
<p>D&#8217;ailleurs on utilise Redis aussi comme broker pour notre gestionnaire de queues et de taches : <a href="sametmax.com/files-de-taches-et-taches-recurrentes-avec-celery/">celery</a>. Si vous pythonez, je vous recommande chaudement celery pour toutes les tâches en background, les crawlers, les chaînes de process, etc.</p>
<p>On a aussi du moteur de recherche. Là on tappe dans du <a href="http://lucene.apache.org/solr/">Solr</a> (avec <a href="http://haystacksearch.org/">haystack</a>). C&#8217;est très puissant, en tout cas syntaxiquement car ça ne fait pas de sémantique. Ne vous attendez-donc pas à rattraper Google. Mais c&#8217;est aussi méga chiant à configurer et très lourd. Je pense qu&#8217;un jour on va migrer sur <a href="http://www.elasticsearch.org/">ElasticSearch</a>, mais c&#8217;est pas la priorité. Don&#8217;t fix what ain&#8217;t broken.</p>
<p>Devant tout ça on a <a href="http://nginx.org/">Nginx</a>. Comme beaucoup on a fait Apache => Cherokee => lighttp => nginx. Et franchement, je ne reviendrais jamais en arrière : plus léger, plus rapide, plus facile à installer et à configurer, plus versatile. Nginx fait tout, et mieux. </p>
<p>En proxy on a du <a href="http://gunicorn.org/">gunicorn</a>. Parce qu&#8217;on avait la flemme de configurer uwsgi et qu&#8217;on a pris l&#8217;habitude.</p>
<p>Après on utilise plein de libs, de petits outils, etc. Mais ça c&#8217;est le gros de notre archi.</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=7648&amp;md5=a3c473ad94a4298f30d5296cdd292afc" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/la-stack-techno-quon-utilise-pour-faire-un-site-web-et-pourquoi/feed/</wfw:commentRss>
		<slash:comments>25</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fla-stack-techno-quon-utilise-pour-faire-un-site-web-et-pourquoi%2F&amp;language=en_GB&amp;category=text&amp;title=La+stack+techno+qu%26%238217%3Bon+utilise+pour+faire+un+site+Web%2C+et+pourquoi&amp;description=Une+stack+techno+n%26%238217%3Best+pas+une+r%C3%A9f%C3%A9rence.+Il+n%26%238217%3By+a+pas+de+combo+absolu+qui+rox+absolument+tout%2C+c%26%238217%3Best+une+question+de+contexte+technique%2C+financier%2C+humain%26%238230%3B+Mais+c%26%238217%3Best+vrai+que...&amp;tags=celery%2Cdjango%2Cfabric%2Cmysql%2Cnginx%2Cnosql%2Cpostgres%2Cpython%2Credis%2Cvm%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/11/nZ9b9.jpg" length="67160" type="image/jpg" />	</item>
		<item>
		<title>Afficher l&#8217;IP d&#8217;un visiteur &#8211; Django vs Nginx</title>
		<link>http://sametmax.com/afficher-la-vrai-ip-dun-visiteur-django-vs-nginx/</link>
		<comments>http://sametmax.com/afficher-la-vrai-ip-dun-visiteur-django-vs-nginx/#comments</comments>
		<pubDate>Fri, 25 Oct 2013 03:53:30 +0000</pubDate>
		<dc:creator>Max</dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[Programmation]]></category>
		<category><![CDATA[Web]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[nginx]]></category>
		<category><![CDATA[real ip]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=7525</guid>
		<description><![CDATA[dis moi quelle est ton IP et je te dirais rien.]]></description>
			<content:encoded><![CDATA[<p>Lorsque l&#8217;on veut connaitre son ip on fait souvent appel à des sites du genre: <a href="http://www.whatismyip.com/">whatismyip.com</a>, <a href="http://www.mon-ip.com/">mon-ip.com</a> ou on utilise un ifconfig en ssh.<br />
Des fois on a aussi besoin de connaître l&#8217;ip d&#8217;un visiteur sur son site, 2 petites méthodes pour le faire sous Django et Nginx.</p>
<p><strong>Sous Django:</strong> </p>
<p>Dans l&#8217;<a href="https://docs.djangoproject.com/en/dev/topics/http/urls/">Urlconf</a></p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">urlpatterns = patterns<span style="color: black;">&#40;</span><span style="color: #483d8b;">''</span>,
    <span style="color: #808080; font-style: italic;"># return client IP</span>
    url<span style="color: black;">&#40;</span>r<span style="color: #483d8b;">'^my_ip$'</span>, get_ip<span style="color: black;">&#41;</span>,
<span style="color: black;">&#41;</span></pre></div></div>

<p>Créez une <a href="https://docs.djangoproject.com/en/dev/topics/http/views/">vue</a> du nom de get_ip qui sera utilisée par l&#8217;urlconf</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">from</span> django <span style="color: #ff7700;font-weight:bold;">import</span> http
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> get_ip<span style="color: black;">&#40;</span>request<span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;
        Vue qui retourne l'IP du client
    &quot;&quot;&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">try</span>:
&nbsp;
    	<span style="color: #808080; font-style: italic;"># récupère l'ip du client</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> http.<span style="color: black;">HttpResponse</span><span style="color: black;">&#40;</span>request.<span style="color: black;">META</span><span style="color: black;">&#91;</span><span style="color: #483d8b;">&quot;REMOTE_ADDR&quot;</span><span style="color: black;">&#93;</span> <span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: #008000;">Exception</span>, e:
        <span style="color: #ff7700;font-weight:bold;">return</span> http.<span style="color: black;">HttpResponse</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'error %s'</span> <span style="color: #66cc66;">%</span> e<span style="color: black;">&#41;</span></pre></div></div>

<p>Le code ci-dessus peut retourner l&#8217;adresse locale (127.0.0.1) dans ce cas il faut tester l&#8217;existence de la variable <strong>HTTP_X_REAL_IP</strong>, certains serveurs web ont besoin d&#8217;être <a href="http://rtcamp.com/tutorials/nginx/forwarding-visitors-real-ip/">configuré</a>. </p>
<p><strong>Sous Nginx:</strong></p>
<p>Dans le fichier de configuration de nginx on écrit une nouvelle <a href="http://wiki.nginx.org/HttpCoreModule#location">location</a></p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #808080; font-style: italic;"># return client ip</span>
location /my_ip <span style="color: black;">&#123;</span>
    default_type <span style="color: #483d8b;">'text/plain'</span><span style="color: #66cc66;">;</span>
    content_by_lua <span style="color: #483d8b;">'ngx.print(ngx.var.remote_addr)'</span><span style="color: #66cc66;">;</span>
<span style="color: black;">&#125;</span></pre></div></div>

<p>il suffit de se rendre à l&#8217;url http://monsite.com/my_ip pour voir s&#8217;afficher son ip. Cependant il faut avoir nginx compilé avec le module <a href="http://wiki.nginx.org/HttpLuaModule">Lua</a> ce qui peut être délicat si l&#8217;on a jamais compilé d&#8217;application.</p>
<p><strong><br />
Conclusion:</strong></p>
<p>Si l&#8217;on s&#8217;en réfère aux deux exemples ci dessus on serait tenté d&#8217;utiliser Nginx car en une seule ligne tout le bazar est réglé.<br />
Le hic c&#8217;est qu&#8217;il faut que Nginx soit compilé avec le module Lua pour afficher l&#8217;ip (sauf si quelqu&#8217;un connaît une autre façon d&#8217;afficher un message de sortie).<br />
La version Django n&#8217;est pas fiable à 100% car suivant comment est configuré votre serveur web il se peut que vous vous retrouviez avec une ip du genre 127.0.0.1.<br />
Il y a aussi la possibilité de parser le résultat des sites web cités en tout début d&#8217;article, certains proposent des Api je crois mais vous dépendez d&#8217;un autre service (on faisait ça au début) qui peuvent vous lâcher à tout moment (ce qui nous est arrivé).<br />
Personnellement je compile toujours nginx avec Lua et quelques autres modules, ça permet de s&#8217;affranchir de plus en plus du backend.</p>
<p>PS: j&#8217;ai mis à jour le titre car il laissait sous-entendre autre chose (merci à Sébastien)</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=7525&amp;md5=5db442cb353a28e02057726c4e826969" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/afficher-la-vrai-ip-dun-visiteur-django-vs-nginx/feed/</wfw:commentRss>
		<slash:comments>11</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fafficher-la-vrai-ip-dun-visiteur-django-vs-nginx%2F&amp;language=en_GB&amp;category=text&amp;title=Afficher+l%26%238217%3BIP+d%26%238217%3Bun+visiteur+%26%238211%3B+Django+vs+Nginx&amp;description=Lorsque+l%26%238217%3Bon+veut+connaitre+son+ip+on+fait+souvent+appel+%C3%A0+des+sites+du+genre%3A+whatismyip.com%2C+mon-ip.com+ou+on+utilise+un+ifconfig+en+ssh.+Des+fois+on+a+aussi+besoin...&amp;tags=django%2Cnginx%2Creal+ip%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/10/identity.jpg" length="31647" type="image/jpg" />	</item>
		<item>
		<title>Qu&#8217;est-ce que WSGI et à quoi ça sert ?</title>
		<link>http://sametmax.com/quest-ce-que-wsgi-et-a-quoi-ca-sert/</link>
		<comments>http://sametmax.com/quest-ce-que-wsgi-et-a-quoi-ca-sert/#comments</comments>
		<pubDate>Wed, 03 Jul 2013 10:36:16 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[bottle]]></category>
		<category><![CDATA[cherrypy]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[nginx]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[server]]></category>
		<category><![CDATA[wsgi]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=6544</guid>
		<description><![CDATA[On va dire que je me répète, mais <a href="https://en.wikipedia.org/wiki/Wsgi">WSGI</a> est typiquement le cas d'une notion simple et super mal expliquée sur le Web.]]></description>
			<content:encoded><![CDATA[<p>On va dire que je me répète, mais <a href="https://en.wikipedia.org/wiki/Wsgi">WSGI</a> est typiquement le cas d&#8217;une notion simple et super mal expliquée sur le Web.</p>
<p>C&#8217;est terrible ça, une vrai maladie. Ça me donne envie de faire des vidéos comme le joueur du Grenier pour râler à voix haute.</p>
<p>Bref.</p>
<p>Donc WSGI a le même but que FastCGI, SCGI, or AJP : c&#8217;est une norme qui sert à définir comment un serveur Python et son application peuvent discuter. Ça été pondu pour que tous les serveurs et toutes les applications Python qui respectent la norme soient garantis de pouvoir s&#8217;interfacer.</p>
<p>Ça, c&#8217;est la définition que vous voyez partout. Super, mais concrètement ça veut dire quoi ?</p>
<h2>WSGI, c&#8217;est juste une convention de discussion</h2>
<p>Un bon dessin vaut mieux&#8230;</p>
<div id="attachment_6545" class="wp-caption aligncenter" style="width: 465px"><a href="http://sametmax.com/wp-content/uploads/2013/07/wsgi.png"><img class=" wp-image-6545  " title="C'est compliqué de faire un schéma comme ça sérieux ? Ah ça pond une norme de 30 pages mais ça peut pas faire 3 ronds dans paint." src="http://sametmax.com/wp-content/uploads/2013/07/wsgi.png" alt="Schéma du fonctionnement de WSGI" width="455" height="644" /></a><p class="wp-caption-text">C&#39;est compliqué de faire un schéma comme ça sérieux ? Ah ça pond une norme de 30 pages mais ça peut pas faire 3 ronds dans paint.</p></div>
<p>D&#8217;un côté vous avez des serveurs comme ceux de cherrypy, de paste, de werkzeug ou comme la commande runserver de Django, ou tels que les serveurs gunicorn, Apache (avec mod_wsgi). Ces logiciels ont pour boulot d’accueillir une requête HTTP et de renvoyer la réponse. Ils ont des problématiques comme : gérer les sockets, gérer plusieurs processus en parallèle, éviter qu&#8217;un pirate se balade sur votre serveur, etc.</p>
<p>De l&#8217;autre côté vous avez votre application. 9 fois sur 10, votre site Web, donc votre code. Sa problématique c&#8217;est de recevoir une requête, la comprendre, et générer une réponse en tapant dans la base de données, et en faisant sa popotte HTML.</p>
<p>Il faut donc que votre serveur dialogue avec votre app, qu&#8217;il lui passe la requête, que votre app la gère, retourne la réponse, et file la réponse au serveur. Alors le serveur envoie la réponse au navigateur.</p>
<p>C&#8217;est la chose la plus mal expliquée : il y a deux parties à WSGI. Une pour le serveur, et une pour l&#8217;application.</p>
<p>Un serveur est dit &#8220;compatible WSGI&#8221; quand il est capable de transmettre une requête HTTP normale à votre application via le protocole WSGI, et qu&#8217;il est capable de récupérer une réponse HTTP depuis votre application via le protocole WSGI pour en faire une requête HTTP normale.</p>
<p>Une application est dite &#8220;compatible WSGI&#8221; quand elle est capable de recevoir une requête HTTP <strong>transformée en un objet Python</strong> selon la norme WSGI, et qu&#8217;elle retourne une réponse HTTP <strong>sous la forme d&#8217;un objet Python</strong> selon la norme WSGI.</p>
<h2>J&#8217;avais demandé concrètement, show me the fucking code !</h2>
<p>Côté serveur WSGI, on doit lui passer le point d&#8217;entrée de votre app.</p>
<p>Le point d&#8217;entrée est un module Python qui contient une variable nommé <code>application</code>.</p>
<p>C&#8217;est tout.</p>
<p>La variable application doit contenir votre application compatible WSGI.</p>
<p>Une application compatible WSGI a un certain nombre de méthodes pour accepter en paramètres un objet requête HTTP, et retourner un objet réponse HTTP, mais la bonne nouvelle, c&#8217;est que <strong>vous n&#8217;avez absolument pas besoin de savoir comment ça marche</strong>.</p>
<p>En effet, tous les frameworks compatibles WSGI (bottle, django, cherrypy, etc) ont une fonction qui retourne cette application toute faite.</p>
<p>Par exemple, avec bottle, mon fichier wsgi va contenir :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">site</span> <span style="color: #ff7700;font-weight:bold;">import</span> app
&nbsp;
application = app</pre></div></div>

<p>C&#8217;est tout. <code>app</code>, le décorateur qui permet de faire <code>@app.route('/')</code> dans le code du site bottle, est déjà une application WSGI.</p>
<p>Pour Django, ça va donner un truc comme :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">os</span>
<span style="color: #808080; font-style: italic;"># ont dit quel est le module de settings Django</span>
<span style="color: #dc143c;">os</span>.<span style="color: black;">environ</span><span style="color: black;">&#91;</span><span style="color: #483d8b;">&quot;DJANGO_SETTINGS_MODULE&quot;</span><span style="color: black;">&#93;</span> = <span style="color: #483d8b;">&quot;project.settings&quot;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># et on fabrique l'application WSGI avec une fonction</span>
<span style="color: #808080; font-style: italic;"># que Django nous donne</span>
<span style="color: #ff7700;font-weight:bold;">from</span> django.<span style="color: black;">core</span>.<span style="color: black;">wsgi</span> <span style="color: #ff7700;font-weight:bold;">import</span> get_wsgi_application
&nbsp;
application = get_wsgi_application<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre></div></div>

<p>Le simple fait qu&#8217;il y ait une variable nommée <code>application</code> fait que le serveur va se débrouiller. Tout ce qu&#8217;il y a à faire, c&#8217;est passer en paramètre ce module au serveur, et comment le faire dépend du serveur.</p>
<p>Par exemple pour gunicorn, c&#8217;est le premier paramètre de la commande qu&#8217;on utilise pour lancer le serveur :</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;">gunicorn nom_du_module</pre></div></div>

<p>Il faut que le module soit importable (on peut passer l&#8217;option <code>--pythonpath</code> pour s&#8217;en assurer.)</p>
<p>Pour Apache et mod_wsgi, ça se fait dans le fichier de config <em>apache.conf</em>:</p>

<div class="wp_syntax"><div class="code"><pre class="xml" style="font-family:monospace;">WSGIScriptAlias / /chemin/version/module.wsgi</pre></div></div>

<p>Bref, faire dialoguer un serveur et une application WSGI, c&#8217;est con comme la lune :</p>
<ol>
<li>Faire un module qui contient une variable nommée <code>application</code> contenant l&#8217;app WSGI.</li>
<li>Dire au serveur où se trouve le fichier</li>
</ol>
<h2>Avantages et inconvénients de WSGI</h2>
<p>Parmi les avantages, on retrouve :</p>
<ul>
<li>Pas de parsing de la requête au niveau de l&#8217;application.</li>
<li>Entrée de toutes les apps WSGI normalisées.</li>
<li>Tous les logiciels WSGI sont compatibles entre eux.</li>
<li>Le module WSGI reste chargé en mémoire une bonne fois pour toute, pas besoin de le recréer à chaque requête.</li>
<li>WSGI se suffit à lui même pour écrire une application. Dans la théorie, on n&#8217;a même pas besoin de framework.</li>
</ul>
<p>Quant aux inconvénients :</p>
<ul>
<li>En pratique il y a très peu de code partagé entre les applications WSGI. La communication sur WSGI s&#8217;est très mal passée et cela reste quelque chose de mystérieux pour la plupart des développeurs.</li>
<li>WSGI ne gère pas les websockets, et la norme est en train d&#8217;être mise à jour pour cela. Mais cela prend du temps et les websockets sont déjà là, du coup les gens se tournent vers des solutions non WSGI (tornado, twisted, etc).</li>
<li>Certains serveurs ne gèrent pas WSGI (comme nginx ou lighttpd), du coup on ne peut pas communiquer directement entre l&#8217;app et eux. Il faut un intermédiaire. C&#8217;est pour cela qu&#8217;on voit très souvent des setups comme nginx <=> gunicorn <=> django, avec un serveur WSGI qui sert d&#8217;intermédiaire. Il y a tout de même le bénéfice de pouvoir gérer parfaitement indépendamment le processus WSGI du serveur HTTP, ce qui est très pratique pour le debug, l&#8217;administration système, le déploiement, etc.</li>
<li>WSGI, c&#8217;est du Python. Qui dit Python, dit import, qui dit import, dit PYTHON PATH. 90% des erreurs de mise en prod sont des erreurs d&#8217;import, et pour cette raison <code>sys.path</code> est presque toujours manipulé dans un fichier qui contient une application WSGI.</li>
</ul>
<h2>Pour la culture</h2>
<p>Voici à quoi ressemble un hello world en WSGI :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> application<span style="color: black;">&#40;</span>environ, start_response<span style="color: black;">&#41;</span>:
    start_response<span style="color: black;">&#40;</span><span style="color: #483d8b;">'200 OK'</span>, <span style="color: black;">&#91;</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'Content-Type'</span>, <span style="color: #483d8b;">'text/plain'</span><span style="color: black;">&#41;</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">yield</span> <span style="color: #483d8b;">'Hello World<span style="color: #000099; font-weight: bold;">\n</span>'</span></pre></div></div>

<p>Et oui, c&#8217;est très simple, et il n&#8217;y a rien à importer. La norme WSGI est une convention : il doit y avoir une variable nommée <code>application</code> (ici la variable c&#8217;est le nom de la fonction), et cette variable doit contenir une application WSGI.</p>
<p>Mais une application WSGI, c&#8217;est juste un callable (ici une fonction) qui accepte en paramètres <code>environ</code> (la requête), <code>start_response</code> (une fonction qui écrit l&#8217;en-tête de la réponse) et qui retourne un générateur de string. C&#8217;est tout.</p>
<p>Il n&#8217;y a rien de magique. C&#8217;est une simple interface sur laquelle tout le monde s&#8217;est mis d&#8217;accord.</p>
<p>Quand on fait en Django:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">application = get_wsgi_application<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre></div></div>

<p>En fait Django ne fait que fabriquer une fonction comme on vient de voir, qui derrière appelle votre application Django.</p>
<p>En revanche, comme on utilise souvent Django derrière nginx, le setup ressemble très souvent à ça :</p>
<div id="attachment_6546" class="wp-caption aligncenter" style="width: 465px"><a href="http://sametmax.com/wp-content/uploads/2013/07/wsgi_with_nginx.png"><img class="size-full wp-image-6546" title="Quand on voit &quot;socket&quot;, ça fait peur, mais c'est juste une ligne de config qui point généralement vers localhost:8000." src="http://sametmax.com/wp-content/uploads/2013/07/wsgi_with_nginx.png" alt="Schém d'utilistation de WSGI avec Nginx" width="455" height="644" /></a><p class="wp-caption-text">Quand on voit &quot;socket&quot;, ça fait peur, mais c&#39;est juste une ligne de config qui point généralement vers localhost:8000.</p></div>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=6544&amp;md5=7b0bfe72a1ba28286d021e7e0529f0f3" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/quest-ce-que-wsgi-et-a-quoi-ca-sert/feed/</wfw:commentRss>
		<slash:comments>23</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fquest-ce-que-wsgi-et-a-quoi-ca-sert%2F&amp;language=en_GB&amp;category=text&amp;title=Qu%26%238217%3Best-ce+que+WSGI+et+%C3%A0+quoi+%C3%A7a+sert+%3F&amp;description=On+va+dire+que+je+me+r%C3%A9p%C3%A8te%2C+mais+WSGI+est+typiquement+le+cas+d%26%238217%3Bune+notion+simple+et+super+mal+expliqu%C3%A9e+sur+le+Web.+C%26%238217%3Best+terrible+%C3%A7a%2C+une+vrai+maladie.+%C3%87a...&amp;tags=bottle%2Ccherrypy%2Cdjango%2Cnginx%2Cpython%2Cserver%2Cwsgi%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/07/v2TyF.jpg" length="31544" type="image/jpg" />	</item>
		<item>
		<title>Initiation à Varnish &#8211; Accélerer un blog WordPress</title>
		<link>http://sametmax.com/initiation-a-varnish-accelerer-un-blog-wordpress/</link>
		<comments>http://sametmax.com/initiation-a-varnish-accelerer-un-blog-wordpress/#comments</comments>
		<pubDate>Sun, 31 Mar 2013 08:54:54 +0000</pubDate>
		<dc:creator>Max</dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[Web]]></category>
		<category><![CDATA[nginx]]></category>
		<category><![CDATA[varnish]]></category>
		<category><![CDATA[wordpress]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=4416</guid>
		<description><![CDATA[Wordpress est devenu une usine à gaz avec le temps. Naviguer sur un blog sous Wordpress peut devenir pénible lorsque ce dernier a beaucoup de contenu ou de visiteurs. Des plugins censés mettre en cache les pages existent comme WP Cache, il y a aussi une façon d'attaquer le problème autrement avec Varnish.]]></description>
			<content:encoded><![CDATA[<p><a href="https://www.varnish-cache.org/">Varnish</a> est un service qui permet de mettre en cache (sur disque ou en mémoire) certains contenus de votre site. Beaucoup de gros sites l&#8217;utilise pour sa puissance et ses options de configuration.<br />
Il est plutôt facile à installer mais ça se corse lorsqu&#8217;il faut le configurer car il peut ne rien cacher du tout, surtout avec la config par défaut.</p>
<p>Nous allons voir ici une configuration pour un site sous WordPress avec un serveur Nginx, Varnish étant placé en Front c&#8217;est à dire devant Nginx (il y a aussi le mode sandwich Nginx / Varnish / Backend).</p>
<p><img class="aligncenter size-full wp-image-4417" title="Varnish en Front" src="http://sametmax.com/wp-content/uploads/2013/02/varnish.png" alt="" width="580" height="272" /></p>
<p><strong>Installation de Varnish sous ubuntu:<br />
</strong></p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">sudo</span> <span style="color: #c20cb9; font-weight: bold;">apt-get</span> <span style="color: #c20cb9; font-weight: bold;">install</span> varnish</pre></div></div>

<p>Il y a 2 fichiers qu&#8217;il faut retenir pour Varnish, le fichier avec les règles et le fichier de config du service.<br />
<strong><br />
Configurer le service, On va faire en sorte que Varnish écoute sur le port 80:</strong></p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">vi</span> <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>default<span style="color: #000000; font-weight: bold;">/</span>varnish</pre></div></div>


<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #007800;">DAEMON_OPTS</span>=<span style="color: #ff0000;">&quot;-a :80 <span style="color: #000099; font-weight: bold;">\
</span>             -T localhost:6082 <span style="color: #000099; font-weight: bold;">\
</span>             -f /etc/varnish/default.vcl <span style="color: #000099; font-weight: bold;">\
</span>             -S /etc/varnish/secret <span style="color: #000099; font-weight: bold;">\
</span>             -s malloc,256m&quot;</span></pre></div></div>

<p>Trouvez cette ligne dans le fichier de conf et mettez 80 pour l&#8217;option -a.<br />
<em>malloc</em> va sauver le cache en mémoire à hauteur de 256 MB, on peut sauvegarder sur disque si on a un SSD (ex: -s file,/var/lib/varnish/varnish_storage.bin,1G&#8221;).</p>
<p><strong>Configurer les règles de cache:</strong></p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">vi</span> <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>varnish<span style="color: #000000; font-weight: bold;">/</span>default.vcl</pre></div></div>


<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #666666; font-style: italic;">#</span>
<span style="color: #666666; font-style: italic;"># Varnish 3 configuration for Wordpress</span>
<span style="color: #666666; font-style: italic;">#</span>
<span style="color: #666666; font-style: italic;"># On Debian OS:  /etc/varnish/default.vcl</span>
<span style="color: #666666; font-style: italic;">#</span>
<span style="color: #666666; font-style: italic;"># Nicolas Hennion (aka) Nicolargo</span>
<span style="color: #666666; font-style: italic;">#</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># Set the default backend (Nginx server for me)</span>
backend default <span style="color: #7a0874; font-weight: bold;">&#123;</span>
	<span style="color: #666666; font-style: italic;"># My Nginx server listen on IP address 127.0.0.1 and TCP port 8080</span>
	.host = <span style="color: #ff0000;">&quot;127.0.0.1&quot;</span>;
	.port = <span style="color: #ff0000;">&quot;8080&quot;</span>;
	<span style="color: #666666; font-style: italic;"># Increase guru timeout</span>
	<span style="color: #666666; font-style: italic;"># http://vincentfretin.ecreall.com/articles/varnish-guru-meditation-on-timeout</span>
	.first_byte_timeout = 300s;
<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># This function is used when a request is send by a HTTP client (Browser) </span>
sub vcl_recv <span style="color: #7a0874; font-weight: bold;">&#123;</span>
	<span style="color: #666666; font-style: italic;"># Block the forbidden IP addresse</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>client.ip ~ forbidden<span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
        	error <span style="color: #000000;">403</span> <span style="color: #ff0000;">&quot;Forbidden&quot;</span>;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># Only cache the following sites</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.host ~ <span style="color: #ff0000;">&quot;(sametmax.com)&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span> 
		<span style="color: #000000; font-weight: bold;">set</span> req.backend = default; 
	<span style="color: #7a0874; font-weight: bold;">&#125;</span> <span style="color: #000000; font-weight: bold;">else</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span> 
		<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>pass<span style="color: #7a0874; font-weight: bold;">&#41;</span>; 
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># Normalize the header, remove the port (in case you're testing this on various TCP ports)</span>
	<span style="color: #000000; font-weight: bold;">set</span> req.http.Host = regsub<span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Host, <span style="color: #ff0000;">&quot;:[0-9]+&quot;</span>, <span style="color: #ff0000;">&quot;&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>;
&nbsp;
	<span style="color: #666666; font-style: italic;"># Post requests will not be cached</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Authorization <span style="color: #000000; font-weight: bold;">||</span> req.request == <span style="color: #ff0000;">&quot;POST&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>pass<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># --- Wordpress specific configuration</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># Did not cache the RSS feed</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.url ~ <span style="color: #ff0000;">&quot;/feed&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>pass<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># Blitz hack</span>
        <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.url ~ <span style="color: #ff0000;">&quot;/mu-.*&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
                <span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>pass<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
        <span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
&nbsp;
	<span style="color: #666666; font-style: italic;"># Did not cache the admin and login pages</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.url ~ <span style="color: #ff0000;">&quot;/wp-(login|admin)&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>pass<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># Remove the &quot;has_js&quot; cookie</span>
	<span style="color: #000000; font-weight: bold;">set</span> req.http.Cookie = regsuball<span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Cookie, <span style="color: #ff0000;">&quot;has_js=[^;]+(; )?&quot;</span>, <span style="color: #ff0000;">&quot;&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>;
&nbsp;
	<span style="color: #666666; font-style: italic;"># Remove any Google Analytics based cookies</span>
	<span style="color: #000000; font-weight: bold;">set</span> req.http.Cookie = regsuball<span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Cookie, <span style="color: #ff0000;">&quot;__utm.=[^;]+(; )?&quot;</span>, <span style="color: #ff0000;">&quot;&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>;
&nbsp;
	<span style="color: #666666; font-style: italic;"># Remove the Quant Capital cookies (added by some plugin, all __qca)</span>
	<span style="color: #000000; font-weight: bold;">set</span> req.http.Cookie = regsuball<span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Cookie, <span style="color: #ff0000;">&quot;__qc.=[^;]+(; )?&quot;</span>, <span style="color: #ff0000;">&quot;&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>;
&nbsp;
	<span style="color: #666666; font-style: italic;"># Remove the wp-settings-1 cookie</span>
	<span style="color: #000000; font-weight: bold;">set</span> req.http.Cookie = regsuball<span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Cookie, <span style="color: #ff0000;">&quot;wp-settings-1=[^;]+(; )?&quot;</span>, <span style="color: #ff0000;">&quot;&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>;
&nbsp;
	<span style="color: #666666; font-style: italic;"># Remove the wp-settings-time-1 cookie</span>
	<span style="color: #000000; font-weight: bold;">set</span> req.http.Cookie = regsuball<span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Cookie, <span style="color: #ff0000;">&quot;wp-settings-time-1=[^;]+(; )?&quot;</span>, <span style="color: #ff0000;">&quot;&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>;
&nbsp;
	<span style="color: #666666; font-style: italic;"># Remove the wp test cookie</span>
	<span style="color: #000000; font-weight: bold;">set</span> req.http.Cookie = regsuball<span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Cookie, <span style="color: #ff0000;">&quot;wordpress_test_cookie=[^;]+(; )?&quot;</span>, <span style="color: #ff0000;">&quot;&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>;
&nbsp;
	<span style="color: #666666; font-style: italic;"># Are there cookies left with only spaces or that are empty?</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.cookie ~ <span style="color: #ff0000;">&quot;^ *$&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		    <span style="color: #7a0874; font-weight: bold;">unset</span> req.http.cookie;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># Cache the following files extensions </span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.url ~ <span style="color: #ff0000;">&quot;\.(css|js|png|gif|jp(e)?g|swf|ico)&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		<span style="color: #7a0874; font-weight: bold;">unset</span> req.http.cookie;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># Normalize Accept-Encoding header and compression</span>
	<span style="color: #666666; font-style: italic;"># https://www.varnish-cache.org/docs/3.0/tutorial/vary.html</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Accept-Encoding<span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		<span style="color: #666666; font-style: italic;"># Do no compress compressed files...</span>
		<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.url ~ <span style="color: #ff0000;">&quot;\.(jpg|png|gif|gz|tgz|bz2|tbz|mp3|ogg)$&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
			   	remove req.http.Accept-Encoding;
		<span style="color: #7a0874; font-weight: bold;">&#125;</span> elsif <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Accept-Encoding ~ <span style="color: #ff0000;">&quot;gzip&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		    	<span style="color: #000000; font-weight: bold;">set</span> req.http.Accept-Encoding = <span style="color: #ff0000;">&quot;gzip&quot;</span>;
		<span style="color: #7a0874; font-weight: bold;">&#125;</span> elsif <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Accept-Encoding ~ <span style="color: #ff0000;">&quot;deflate&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		    	<span style="color: #000000; font-weight: bold;">set</span> req.http.Accept-Encoding = <span style="color: #ff0000;">&quot;deflate&quot;</span>;
		<span style="color: #7a0874; font-weight: bold;">&#125;</span> <span style="color: #000000; font-weight: bold;">else</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
			remove req.http.Accept-Encoding;
		<span style="color: #7a0874; font-weight: bold;">&#125;</span>
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># Check the cookies for wordpress-specific items</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Cookie ~ <span style="color: #ff0000;">&quot;wordpress_&quot;</span> <span style="color: #000000; font-weight: bold;">||</span> req.http.Cookie ~ <span style="color: #ff0000;">&quot;comment_&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>pass<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #000000; font-weight: bold;">!</span>req.http.cookie<span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		<span style="color: #7a0874; font-weight: bold;">unset</span> req.http.cookie;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># --- End of Wordpress specific configuration</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># Did not cache HTTP authentication and HTTP Cookie</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Authorization <span style="color: #000000; font-weight: bold;">||</span> req.http.Cookie<span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		<span style="color: #666666; font-style: italic;"># Not cacheable by default</span>
		<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>pass<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># Define the default grace period to serve cached content</span>
	<span style="color: #000000; font-weight: bold;">set</span> req.grace = 30s;
&nbsp;
	<span style="color: #666666; font-style: italic;"># Cache all others requests</span>
	<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>lookup<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
sub vcl_pipe <span style="color: #7a0874; font-weight: bold;">&#123;</span>
	<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>pipe<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
sub vcl_pass <span style="color: #7a0874; font-weight: bold;">&#123;</span>
	<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>pass<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># The data on which the hashing will take place</span>
sub vcl_hash <span style="color: #7a0874; font-weight: bold;">&#123;</span>
 	hash_data<span style="color: #7a0874; font-weight: bold;">&#40;</span>req.url<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
 	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.host<span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
     	hash_data<span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.host<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
 	<span style="color: #7a0874; font-weight: bold;">&#125;</span> <span style="color: #000000; font-weight: bold;">else</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
     	hash_data<span style="color: #7a0874; font-weight: bold;">&#40;</span>server.ip<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
 	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># If the client supports compression, keep that in a different cache</span>
    	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Accept-Encoding<span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
        	hash_data<span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Accept-Encoding<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #7a0874; font-weight: bold;">hash</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>;
<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># This function is used when a request is sent by our backend (Nginx server)</span>
sub vcl_fetch <span style="color: #7a0874; font-weight: bold;">&#123;</span>
	<span style="color: #666666; font-style: italic;"># Remove some headers we never want to see</span>
	<span style="color: #7a0874; font-weight: bold;">unset</span> beresp.http.Server;
	<span style="color: #7a0874; font-weight: bold;">unset</span> beresp.http.X-Powered-By;
&nbsp;
	<span style="color: #666666; font-style: italic;"># For static content strip all backend cookies</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.url ~ <span style="color: #ff0000;">&quot;\.(css|js|png|gif|jp(e?)g)|swf|ico&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		<span style="color: #7a0874; font-weight: bold;">unset</span> beresp.http.cookie;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># Only allow cookies to be set if we're in admin area</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>beresp.http.Set-Cookie <span style="color: #000000; font-weight: bold;">&amp;&amp;</span> req.url <span style="color: #000000; font-weight: bold;">!</span>~ <span style="color: #ff0000;">&quot;^/wp-(login|admin)&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
        	<span style="color: #7a0874; font-weight: bold;">unset</span> beresp.http.Set-Cookie;
    	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># don't cache response to posted requests or those with basic auth</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span> req.request == <span style="color: #ff0000;">&quot;POST&quot;</span> <span style="color: #000000; font-weight: bold;">||</span> req.http.Authorization <span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
        	<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>hit_for_pass<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
    	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
    	<span style="color: #666666; font-style: italic;"># don't cache search results</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span> req.url ~ <span style="color: #ff0000;">&quot;\?s=&quot;</span> <span style="color: #7a0874; font-weight: bold;">&#41;</span><span style="color: #7a0874; font-weight: bold;">&#123;</span>
		<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>hit_for_pass<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># only cache status ok</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span> beresp.status <span style="color: #000000; font-weight: bold;">!</span>= <span style="color: #000000;">200</span> <span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>hit_for_pass<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># A TTL of 24h</span>
	<span style="color: #000000; font-weight: bold;">set</span> beresp.ttl = 24h;
&nbsp;
	<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>deliver<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># The routine when we deliver the HTTP request to the user</span>
<span style="color: #666666; font-style: italic;"># Last chance to modify headers that are sent to the client</span>
sub vcl_deliver <span style="color: #7a0874; font-weight: bold;">&#123;</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>obj.hits <span style="color: #000000; font-weight: bold;">&gt;</span> <span style="color: #000000;">0</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span> 
		<span style="color: #000000; font-weight: bold;">set</span> resp.http.X-Cache = <span style="color: #ff0000;">&quot;cached&quot;</span>;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span> <span style="color: #000000; font-weight: bold;">else</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		<span style="color: #000000; font-weight: bold;">set</span> resp.http.x-Cache = <span style="color: #ff0000;">&quot;uncached&quot;</span>;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># Remove some headers: PHP version</span>
	<span style="color: #7a0874; font-weight: bold;">unset</span> resp.http.X-Powered-By;
&nbsp;
	<span style="color: #666666; font-style: italic;"># Remove some headers: Apache version &amp; OS</span>
	<span style="color: #7a0874; font-weight: bold;">unset</span> resp.http.Server;
&nbsp;
	<span style="color: #666666; font-style: italic;"># Remove some heanders: Varnish</span>
	<span style="color: #7a0874; font-weight: bold;">unset</span> resp.http.Via;
	<span style="color: #7a0874; font-weight: bold;">unset</span> resp.http.X-Varnish;
&nbsp;
	<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>deliver<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
sub vcl_init <span style="color: #7a0874; font-weight: bold;">&#123;</span>
 	<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>ok<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
sub vcl_fini <span style="color: #7a0874; font-weight: bold;">&#123;</span>
 	<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>ok<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
<span style="color: #7a0874; font-weight: bold;">&#125;</span></pre></div></div>

<p>Avant toute chose voici la doc :) : <a href="https://www.varnish-cache.org/docs/3.0/">https://www.varnish-cache.org/docs/3.0/</a><br />
Ce qu&#8217;il faut retenir de ce fichier de règle c&#8217;est les parties normalisation, enlever les cookies inutiles (car si cookie alors pas de cache) et ne pas mettre en cache l&#8217;admin. Cette config tourne actuellement sur S&#038;M.</p>
<p>Un point interressant c&#8217;est le debug, vous pouvez mettre un <em>set resp.http.X-Cache = &#8220;cached&#8221;;</em> et vérifier les header de votre serveur dans le debug de votre navigateur pour savoir si oui ou non la page servit est en cache.</p>
<p><strong>L&#8217;admin varnish en ligne de commande:</strong><br />
Varnish possède une admin en ligne de commande où l&#8217;on peut par exemple purger le cache d&#8217;une ou plusieurs pages.<br />
Tapez <em>varnishadm</em> dans le shell:</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;">varnishadm
<span style="color: #000000;">200</span>        
<span style="color: #660033;">-----------------------------</span>
Varnish Cache CLI <span style="color: #000000;">1.0</span>
<span style="color: #660033;">-----------------------------</span>
Linux,3.2.0-<span style="color: #000000;">25</span>-virtual,x86_64,-smalloc,-smalloc,-hcritbit
&nbsp;
Type <span style="color: #ff0000;">'help'</span> <span style="color: #000000; font-weight: bold;">for</span> <span style="color: #7a0874; font-weight: bold;">command</span> list.
Type <span style="color: #ff0000;">'quit'</span> to close CLI session.
&nbsp;
varnish<span style="color: #000000; font-weight: bold;">&gt;</span> ban.url <span style="color: #000000; font-weight: bold;">/</span>toto<span style="color: #000000; font-weight: bold;">/</span>ma-page.php</pre></div></div>

<p>Pour purger une page on va utiliser la commande ban.url et y ajouter une partie de l&#8217;url à purger. On peut utiliser un ban en appelant également une url de purge avec Curl ou Wget pour les automations, il y a un excellent article <a href="http://binbash.fr/2011/11/15/purger-le-cache-de-varnish-3/">sur la purge ici.</a></p>
<p><strong>Configurer Nginx:</strong><br />
Une fois varnish installé, on va modifier un peu nginx pour que la liaison puisse se faire. Ci-dessous l&#8217;exemple de notre conf nginx.</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;">&nbsp;
server <span style="color: #7a0874; font-weight: bold;">&#123;</span>
    listen      <span style="color: #000000;">8080</span>;
    server_name  sametmax.com  ;
    root         <span style="color: #000000; font-weight: bold;">/</span>unrep<span style="color: #000000; font-weight: bold;">/</span>sametmax<span style="color: #000000; font-weight: bold;">/</span>;  <span style="color: #666666; font-style: italic;"># absolute path to your WordPress installation</span>
    index index.php index.html;
    set_real_ip_from        127.0.0.1;
    real_ip_header          X-Forwarded-For;
&nbsp;
    location ~ \.php$ <span style="color: #7a0874; font-weight: bold;">&#123;</span>
        include        <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>nginx<span style="color: #000000; font-weight: bold;">/</span>fastcgi_params;
        fastcgi_pass   127.0.0.1:<span style="color: #000000;">53217</span>;
        fastcgi_index index.php;
        fastcgi_buffers <span style="color: #000000;">8</span> 16k;
        fastcgi_buffer_size 32k;
        fastcgi_param  SCRIPT_FILENAME  <span style="color: #007800;">$document_root</span><span style="color: #007800;">$fastcgi_script_name</span>;
    <span style="color: #7a0874; font-weight: bold;">&#125;</span></pre></div></div>

<p>Pour PHP on utilise spawn-fcgi que l&#8217;on gère avec <a href="http://supervisord.org/">supervisor</a> dont voici la conf dans /etc/supervisord.conf</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #7a0874; font-weight: bold;">&#91;</span>program:php5-cgi<span style="color: #7a0874; font-weight: bold;">&#93;</span>
<span style="color: #007800;">command</span>=<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>spawn-fcgi <span style="color: #660033;">-u</span> adolf <span style="color: #660033;">-n</span> <span style="color: #660033;">-a</span> 127.0.0.1 <span style="color: #660033;">-p</span> <span style="color: #000000;">53217</span> <span style="color: #660033;">-P</span> <span style="color: #000000; font-weight: bold;">/</span>tmp<span style="color: #000000; font-weight: bold;">/</span>fastcgi-php.pid <span style="color: #660033;">-F</span> <span style="color: #000000;">4</span> <span style="color: #660033;">--</span> <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>php-cgi
<span style="color: #007800;">redirect_stderr</span>=<span style="color: #c20cb9; font-weight: bold;">true</span>          ; redirect proc stderr to stdout <span style="color: #7a0874; font-weight: bold;">&#40;</span>default <span style="color: #c20cb9; font-weight: bold;">false</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>
<span style="color: #007800;">user</span>=sametmax
<span style="color: #007800;">autostart</span>=<span style="color: #c20cb9; font-weight: bold;">true</span>
<span style="color: #007800;">autorestart</span>=<span style="color: #c20cb9; font-weight: bold;">true</span>
<span style="color: #007800;">startsecs</span>=<span style="color: #000000;">10</span>
<span style="color: #007800;">startretries</span>=<span style="color: #000000;">9999999999999</span>
<span style="color: #007800;">stdout_logfile</span>=<span style="color: #000000; font-weight: bold;">/</span>var<span style="color: #000000; font-weight: bold;">/</span>log<span style="color: #000000; font-weight: bold;">/</span>php5-cgi<span style="color: #000000; font-weight: bold;">/</span>php5-cgi.log
<span style="color: #007800;">stdout_logfile_maxbytes</span>=10MB   ; max <span style="color: #666666; font-style: italic;"># logfile bytes b4 rotation (default 50MB)</span></pre></div></div>

<p><strong>Pour résumer:</strong></p>
<p>Dans cette configuration Varnish est en front end et va décider quand servir une page prise dans le cache (disque dur ou RAM) et quand intéroger le backend pour servir une nouvelle page.<br />
Sur d&#8217;autres sites à fort trafic on a mis Nginx en front end car il encaisse beaucoup plus les hits et qu&#8217;il fait très bien le boulot pour servir des pages statiques.</p>
<p><strong>Attention!</strong><br />
Même si Varnish n&#8217;est pas compliqué à installer il peut être un vrai casse tête quand il s&#8217;agit de cacher des pages. Pensez donc bien à normaliser vos headers (user-agent, gzip, etc), utilisez le debug.<br />
Bien configuré Varnish vous booste un serveur avec une réélle efficacité, il nous a sauvé 2 sites jusqu&#8217;à présent, ça sera d&#8217;ailleurs un standard sur nos prochains sites.</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=4416&amp;md5=f22290422327559763efcf827e1a219f" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/initiation-a-varnish-accelerer-un-blog-wordpress/feed/</wfw:commentRss>
		<slash:comments>6</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Finitiation-a-varnish-accelerer-un-blog-wordpress%2F&amp;language=en_GB&amp;category=text&amp;title=Initiation+%C3%A0+Varnish+%26%238211%3B+Acc%C3%A9lerer+un+blog+WordPress&amp;description=Varnish+est+un+service+qui+permet+de+mettre+en+cache+%28sur+disque+ou+en+m%C3%A9moire%29+certains+contenus+de+votre+site.+Beaucoup+de+gros+sites+l%26%238217%3Butilise+pour+sa+puissance+et+ses...&amp;tags=nginx%2Cvarnish%2Cwordpress%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/03/back_to_the_future.jpg" length="23411" type="image/jpg" />	</item>
		<item>
		<title>nginx: [emerg] &#8220;worker_processes&#8221; directive is not allowed here in /usr/local/nginx/conf/nginx.conf:3</title>
		<link>http://sametmax.com/nginx-emerg-worker_processes-directive-is-not-allowed-here-in-usrlocalnginxconfnginx-conf3/</link>
		<comments>http://sametmax.com/nginx-emerg-worker_processes-directive-is-not-allowed-here-in-usrlocalnginxconfnginx-conf3/#comments</comments>
		<pubDate>Wed, 13 Feb 2013 10:05:56 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[error]]></category>
		<category><![CDATA[nginx]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=4452</guid>
		<description><![CDATA[Cette erreur arrive quand la directive "worker_processes" est incluse une deuxième fois. Typiquement cela arrive quand on a <code>include *.conf</code> dans son nginx.conf et que cela inclu nginx.conf lui même. ]]></description>
			<content:encoded><![CDATA[<p>Cette erreur arrive quand la directive &#8220;worker_processes&#8221; est incluse une deuxième fois. Typiquement cela arrive quand on a <code>include *.conf</code> dans son <em>nginx.conf</em> et que cela inclut <em>nginx.conf</em> lui même. </p>
<p>Il faut donc être spécifique sur les fichiers à inclure <code>include site.conf</code> ou déplacer <em>nginx.conf</em> dans un autre dossier que celui des sous fichiers de configuration.</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=4452&amp;md5=5d3c98eeb2873b16e81bd8bfb5f0d65a" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/nginx-emerg-worker_processes-directive-is-not-allowed-here-in-usrlocalnginxconfnginx-conf3/feed/</wfw:commentRss>
		<slash:comments>2</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fnginx-emerg-worker_processes-directive-is-not-allowed-here-in-usrlocalnginxconfnginx-conf3%2F&amp;language=en_GB&amp;category=text&amp;title=nginx%3A+%5Bemerg%5D+%26%238220%3Bworker_processes%26%238221%3B+directive+is+not+allowed+here+in+%2Fusr%2Flocal%2Fnginx%2Fconf%2Fnginx.conf%3A3&amp;description=Cette+erreur+arrive+quand+la+directive+%26%238220%3Bworker_processes%26%238221%3B+est+incluse+une+deuxi%C3%A8me+fois.+Typiquement+cela+arrive+quand+on+a+include+%2A.conf+dans+son+nginx.conf+et+que+cela+inclut+nginx.conf+lui+m%C3%AAme....&amp;tags=error%2Cnginx%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/02/Tomei-Evo-X-engine.jpg" length="268187" type="image/jpg" />	</item>
		<item>
		<title>Nginx en reverse proxy + Gunicorn pour vos apps Django</title>
		<link>http://sametmax.com/nginx-en-reverse-proxy-gunicorn-pour-vos-apps-django/</link>
		<comments>http://sametmax.com/nginx-en-reverse-proxy-gunicorn-pour-vos-apps-django/#comments</comments>
		<pubDate>Mon, 03 Dec 2012 19:48:22 +0000</pubDate>
		<dc:creator>Max</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[gunicorn]]></category>
		<category><![CDATA[nginx]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[reverse proxy]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=3431</guid>
		<description><![CDATA[Petit exemple de configuration de Nginx en reverse proxy avec Gunicorn.]]></description>
			<content:encoded><![CDATA[<p>Nginx est bien connu depuis quelques années. Puissant serveur HTTP, il peut être utilisé en tant que reverse proxy (mandataire inverse en Français) afin d&#8217;améliorer les performances.<br />
Je vous copie/colle les avantages depuis <a href="http://fr.wikipedia.org/wiki/Mandataire_inverse">Wikipédia</a> parce que je suis une feignasse:</p>
<p><strong>cache :</strong> le mandataire inverse ou (reverse proxy) peut décharger les serveurs Web de la charge de pages/objets statiques (pages HTML, images) par la gestion d&#8217;un cache local. La charge des serveurs Web est ainsi généralement diminuée, on parle alors d&#8217;« accélérateur web » ou d&#8217;« accélérateur HTTP ».<br />
<strong>Intermédiaire de sécurité :</strong> le mandataire inverse protège un serveur Web des attaques provenant de l&#8217;extérieur. En effet, la couche supplémentaire apportée par les mandataires inverses peut apporter une sécurité supplémentaire. La ré-écriture programmable des URL permet de masquer et de contrôler, par exemple, l&#8217;architecture d&#8217;un site web interne. Mais cette architecture permet surtout le filtrage en un point unique des accès aux ressources Web.<br />
<strong>Chiffrement SSL :</strong> le mandataire inverse peut être utilisé en tant que « terminateur SSL », par exemple par le biais de matériel dédié,<br />
<strong>Répartition de charge :</strong> le mandataire inverse peut distribuer la charge d&#8217;un site unique sur plusieurs serveurs Web applicatifs. Selon sa configuration, un travail de ré-écriture d&#8217;URL sera donc nécessaire,<br />
<strong>Compression :</strong> le mandataire inverse peut optimiser la compression du contenu des sites.</p>
<p><strong>Pour résumé:</strong></p>
<p><strong>Visiteur &gt; Web &gt; Votre Serveur &gt; Nginx &gt; Gunicorn &gt; Django<br />
</strong></p>
<p>Dans la configuration suivante Nginx va servir les fichiers statiques (images, js, etc) et envoyer le reste des requêtes sur <a href="http://gunicorn.org/#quickstart">Gunicorn</a>. Gunicorn est une interface WSGI entre le serveur HTTP (nginx) et Python, je n&#8217;ai pas trouvé de bonne explication sur WSGI à part le <a href="http://wsgi.readthedocs.org/en/latest/index.html">site officiel </a>fait par des autistes.</p>
<p><strong>Soit la configuration de Gunicorn suivante (on peut le lancer avec <a href="https://0bin.readthedocs.org/en/latest/fr/using_supervisor.html">supervisor</a>):</strong></p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">gunicorn_django  myapp.<span style="color: black;">py</span> --bind 127.0.0.1:<span style="color: #ff4500;">8080</span> --log-<span style="color: #008000;">file</span> /var/log/myapp.<span style="color: black;">gunicorn</span>.<span style="color: black;">log</span> --log-level info --workers <span style="color: #ff4500;">2</span> --pid /tmp/myapp.<span style="color: black;">pid</span>  --worker-<span style="color: #ff7700;font-weight:bold;">class</span> gevent</pre></div></div>

<p>Gunicorn va &#8220;écouter&#8221; en local sur le port 8080, il va logger des infos dans le fichier /var/log/myapp.gunicorn.log (pratique pour le debug si besoin).<br />
Pour les workers et worker-class regardez <a href="http://docs.gunicorn.org/en/latest/configure.html">la doc</a>.</p>
<p><strong>Configurer Nginx: </strong><br />
Dans la conf Nginx on va avoir.</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">server <span style="color: black;">&#123;</span>
        listen       <span style="color: #ff4500;">80</span><span style="color: #66cc66;">;</span>
        server_name mysite.<span style="color: black;">com</span> www.<span style="color: black;">mysite</span>.<span style="color: black;">com</span><span style="color: #66cc66;">;</span>
&nbsp;
        location /static/ <span style="color: black;">&#123;</span>
            root  /home/myapp/prod<span style="color: #66cc66;">;</span>
            <span style="color: #dc143c;">gzip</span>  on<span style="color: #66cc66;">;</span>
        <span style="color: black;">&#125;</span>
&nbsp;
        location / <span style="color: black;">&#123;</span>
            proxy_pass http://127.0.0.1:<span style="color: #ff4500;">8080</span><span style="color: #66cc66;">;</span> <span style="color: #808080; font-style: italic;"># Pass to Gunicorn</span>
            proxy_set_header X-Real-IP $remote_addr<span style="color: #66cc66;">;</span> <span style="color: #808080; font-style: italic;"># get real Client IP</span>
        <span style="color: black;">&#125;</span>
<span style="color: black;">&#125;</span></pre></div></div>

<p><a href="http://wiki.nginx.org/HttpCoreModule#location">location</a> va indiquer à Nginx ce qu&#8217;il faut faire lorsqu&#8217;il rencontre certaines URL.</p>
<p>Dans notre cas le <strong>location /static/</strong> va dire à Nginx de servir directement tous les fichiers du répertoire /home/myapp/prod/static pour les URL http://mysite.com/static/&#8230; En général les images, javascript, etc.</p>
<p>Pour le reste <strong>location /</strong> va renvoyer les requêtes sur votre serveur Gunicorn qui va les traiter.</p>
<p>proxy_set_header sert à passer à Gunicorn certaines infos comme l&#8217;<a title="Récupérer l’IP client avec Nginx en proxy sous CherryPy/Django/Bottle – proxy_set_header" href="http://sametmax.com/recuperer-lip-client-avec-nginx-en-proxy-sous-cherrypy-proxy_set_header/">IP réelle du client </a>(sinon Gunicorn verrait celle de NGinx 127.0.0.1).</p>
<p>De cette manière on ne surcharge pas Gunicorn pour servir nos fichiers statiques, on ajoute une protection (Nginx).<br />
On peut éventuellement <a href="http://wiki.nginx.org/HttpProxyModule#proxy_cache">mettre en cache</a> certaines pages mais je n&#8217;ai jamais utilisé cette option.<br />
Nginx peut également distribuer la charge sur plusieurs serveurs et se charger de la <a href="https://developers.google.com/speed/articles/gzip">compression des pages</a> (gzip).</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=3431&amp;md5=934128f02ddca1a9b8dd8993393017d5" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/nginx-en-reverse-proxy-gunicorn-pour-vos-apps-django/feed/</wfw:commentRss>
		<slash:comments>3</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fnginx-en-reverse-proxy-gunicorn-pour-vos-apps-django%2F&amp;language=en_GB&amp;category=text&amp;title=Nginx+en+reverse+proxy+%2B+Gunicorn+pour+vos+apps+Django&amp;description=Nginx+est+bien+connu+depuis+quelques+ann%C3%A9es.+Puissant+serveur+HTTP%2C+il+peut+%C3%AAtre+utilis%C3%A9+en+tant+que+reverse+proxy+%28mandataire+inverse+en+Fran%C3%A7ais%29+afin+d%26%238217%3Bam%C3%A9liorer+les+performances.+Je+vous+copie%2Fcolle...&amp;tags=django%2Cgunicorn%2Cnginx%2Cpython%2Creverse+proxy%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2012/12/330px-Reverse_proxy_h2g2bob.png" length="16681" type="image/jpg" />	</item>
		<item>
		<title>Servir un fichier protégé avec Django et Nginx</title>
		<link>http://sametmax.com/servir-un-fichier-protege-avec-django-et-nginx/</link>
		<comments>http://sametmax.com/servir-un-fichier-protege-avec-django-et-nginx/#comments</comments>
		<pubDate>Fri, 21 Sep 2012 13:53:38 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[nginx]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=2204</guid>
		<description><![CDATA[Certains fichiers sont réservés à des personnes ayant payé, avec un compte, ou encore protégés par un mot de passe. Problème: django gère l'authentification mais ne doit pas gérer l'upload car c'est le taff du serveur en front end.]]></description>
			<content:encoded><![CDATA[<p>Certains fichiers sont réservés à des personnes ayant payé, avec un compte, ou encore protégés par un mot de passe. Problème: django gère l&#8217;authentification mais ne doit pas gérer l&#8217;upload car c&#8217;est le taff du serveur en front end.</p>
<h2>Etape 1: configurer Nginx</h2>
<p>Je suppose ici que vous avez une config Django classique avec Nginx qui fait un proxy passe vers un serveur WSGI type cherrypy, gunircorn, uwsgi, etc.</p>
<p>Dans votre fichier de config Nginx, rajoutez ceci:</p>
<pre>server {
   ...
   location /secure_upload/{
       internal;
       alias /chemin/absolu/vers/dossier/du/projet/media;
   }
}</pre>
<p>La directive <code>internal</code> s&#8217;assure qu&#8217;une requête extérieur ne peut pas demander d&#8217;accéder à cette adresse.</p>
<h2>Etape 2: authentifier et rediriger avec une vue Django</h2>
<p>Dans cet exemple, on sert uniquement le fichier aux utilisateurs authentifiés. Mais on pourrait très bien le faire sur la saisie d&#8217;un code unique, vérifier les droits d&#8217;accès, etc. J&#8217;ai juste choisi le cas le plus simple.</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">from</span> django.<span style="color: black;">contrib</span>.<span style="color: black;">auth</span>.<span style="color: black;">decorators</span> <span style="color: #ff7700;font-weight:bold;">import</span> login_required
<span style="color: #ff7700;font-weight:bold;">from</span> django.<span style="color: black;">http</span> <span style="color: #ff7700;font-weight:bold;">import</span> HttpResponse
<span style="color: #ff7700;font-weight:bold;">from</span> django.<span style="color: black;">views</span> <span style="color: #ff7700;font-weight:bold;">import</span> static
<span style="color: #ff7700;font-weight:bold;">from</span> django.<span style="color: black;">conf</span> <span style="color: #ff7700;font-weight:bold;">import</span> settings
&nbsp;
@login_required<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># on accepte uniquement les requête authentifiées</span>
<span style="color: #ff7700;font-weight:bold;">def</span> serve_secure_static<span style="color: black;">&#40;</span>request, path<span style="color: black;">&#41;</span>:
&nbsp;
    <span style="color: #808080; font-style: italic;"># en mode debug, on demande à Django de servir le fichier histoire de pas</span>
    <span style="color: #808080; font-style: italic;"># être forcé de setuper nginx sur sa machine de dev</span>
    <span style="color: #ff7700;font-weight:bold;">if</span> settings.<span style="color: black;">DEBUG</span>:
        <span style="color: #ff7700;font-weight:bold;">return</span> static.<span style="color: black;">serve</span><span style="color: black;">&#40;</span>request, path, settings.<span style="color: black;">SECURE_MEDIA_ROOT</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># Sinon on retourne une réponse VIDE avec en header le chemin de l'url</span>
    <span style="color: #808080; font-style: italic;"># de l'upload interne</span>
    <span style="color: #808080; font-style: italic;"># Nginx va l'intercepter, réaliser qu'il faut qu'il upload ce qu'il y</span>
    <span style="color: #808080; font-style: italic;"># a à cette URL et faire le reste du boulot</span>
    response = HttpResponse<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
    response<span style="color: black;">&#91;</span><span style="color: #483d8b;">'X-Accel-Redirect'</span><span style="color: black;">&#93;</span> = <span style="color: #483d8b;">'/secure_upload/%s'</span> <span style="color: #66cc66;">%</span> path
    <span style="color: #ff7700;font-weight:bold;">return</span> response</pre></div></div>

<h2>Etape 3 : configurer Django</h2>
<p>Evidément il vous faut dans le <em>settings.py</em>:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">MEDIA_ROOT = <span style="color: #483d8b;">&quot;/chemin/absolu/vers/dossier/du/projet/media&quot;</span>
SECURE_MEDIA_ROOT = <span style="color: #dc143c;">os</span>.<span style="color: black;">path</span>.<span style="color: black;">join</span><span style="color: black;">&#40;</span>MEDIA_ROOT, <span style="color: #483d8b;">'secure'</span><span style="color: black;">&#41;</span></pre></div></div>

<p>Les dossiers doivent être créés à la mano.</p>
<p>Et dans <em>urls.py</em>:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">url<span style="color: black;">&#40;</span>r<span style="color: #483d8b;">'^download/(?P
.*)$'</span>, server_secure_static<span style="color: black;">&#41;</span></pre></div></div>

 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=2204&amp;md5=68348aef300924406a8881359a881ff4" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/servir-un-fichier-protege-avec-django-et-nginx/feed/</wfw:commentRss>
		<slash:comments>2</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fservir-un-fichier-protege-avec-django-et-nginx%2F&amp;language=en_GB&amp;category=text&amp;title=Servir+un+fichier+prot%C3%A9g%C3%A9+avec+Django+et+Nginx&amp;description=Certains+fichiers+sont+r%C3%A9serv%C3%A9s+%C3%A0+des+personnes+ayant+pay%C3%A9%2C+avec+un+compte%2C+ou+encore+prot%C3%A9g%C3%A9s+par+un+mot+de+passe.+Probl%C3%A8me%3A+django+g%C3%A8re+l%26%238217%3Bauthentification+mais+ne+doit+pas+g%C3%A9rer+l%26%238217%3Bupload...&amp;tags=django%2Cnginx%2Cpython%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2012/09/Door-Multi-locks1-300x285.jpg" length="23596" type="image/jpg" />	</item>
		<item>
		<title>Connaître sa version de Nginx</title>
		<link>http://sametmax.com/connaitre-sa-version-de-nginx/</link>
		<comments>http://sametmax.com/connaitre-sa-version-de-nginx/#comments</comments>
		<pubDate>Mon, 17 Sep 2012 13:52:12 +0000</pubDate>
		<dc:creator>Max</dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[nginx]]></category>
		<category><![CDATA[version]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=2176</guid>
		<description><![CDATA[Connaître facilement sa version du serveur web Nginx]]></description>
			<content:encoded><![CDATA[<p><a href="http://nginx.org/">Nginx</a>, le super serveur web qui n&#8217;est plus à présenter profite de mises à jours régulières. Sa communauté est très active pour le bien de tous. A l&#8217;heure actuelle <a href="http://w3techs.com/technologies/cross/web_server/ranking">Nginx est présent sur plus de 27% des serveurs dont les sites sont dans le top 1000 Alexa </a></p>
<p>Pour savoir si votre version n&#8217;est pas désuète vous pouvez en ligne de commande obtenir la version de Nginx que vous possedez ainsi que les paramètres de compilation.</p>
<p><strong>Connaître sa version de Nginx grace à l&#8217;option -V:</strong></p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;">user<span style="color: #000000; font-weight: bold;">@</span>mon_serveur:~<span style="color: #666666; font-style: italic;"># /usr/local/nginx/sbin/nginx -V</span>
nginx version: nginx<span style="color: #000000; font-weight: bold;">/</span>1.3.5
built by <span style="color: #c20cb9; font-weight: bold;">gcc</span> 4.6.3 <span style="color: #7a0874; font-weight: bold;">&#40;</span>Ubuntu<span style="color: #000000; font-weight: bold;">/</span>Linaro 4.6.3-1ubuntu5<span style="color: #7a0874; font-weight: bold;">&#41;</span> 
configure arguments: <span style="color: #660033;">--prefix</span>=<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>nginx --with-http_flv_module --with-http_mp4_module --with-http_secure_link_module</pre></div></div>

 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=2176&amp;md5=766e6c45a54abb1aed15bee2b97ba88b" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/connaitre-sa-version-de-nginx/feed/</wfw:commentRss>
		<slash:comments>2</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fconnaitre-sa-version-de-nginx%2F&amp;language=en_GB&amp;category=text&amp;title=Conna%C3%AEtre+sa+version+de+Nginx&amp;description=Nginx%2C+le+super+serveur+web+qui+n%26%238217%3Best+plus+%C3%A0+pr%C3%A9senter+profite+de+mises+%C3%A0+jours+r%C3%A9guli%C3%A8res.+Sa+communaut%C3%A9+est+tr%C3%A8s+active+pour+le+bien+de+tous.+A+l%26%238217%3Bheure+actuelle+Nginx...&amp;tags=nginx%2Cversion%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2012/09/nginx_logo.gif" length="11716" type="image/jpg" />	</item>
		<item>
		<title>Récupérer l&#8217;IP client avec Nginx en proxy sous CherryPy/Django/Bottle &#8211; proxy_set_header</title>
		<link>http://sametmax.com/recuperer-lip-client-avec-nginx-en-proxy-sous-cherrypy-proxy_set_header/</link>
		<comments>http://sametmax.com/recuperer-lip-client-avec-nginx-en-proxy-sous-cherrypy-proxy_set_header/#comments</comments>
		<pubDate>Thu, 06 Sep 2012 02:11:26 +0000</pubDate>
		<dc:creator>Max</dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[bottle]]></category>
		<category><![CDATA[cherrypy]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[ip]]></category>
		<category><![CDATA[nginx]]></category>
		<category><![CDATA[proxy]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=2041</guid>
		<description><![CDATA[Si vous utilisez Nginx en proxy, vous allez vous heurter à son IP lorsque votre script tentera de récupérer l'IP du client soit 127.0.0.1. Voici comment récupérer la bonne IP.]]></description>
			<content:encoded><![CDATA[<p>Si vous utilisez Nginx en proxy, vous allez vous heurter à son IP lorsque votre script tentera de récupérer l&#8217;IP du client soit 127.0.0.1.</p>
<p>En rajoutant ces quelques lignes à votre config <a href="http://wiki.nginx.org/HttpProxyModule#proxy_set_header">Nginx</a>:</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;">location <span style="color: #000000; font-weight: bold;">/</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span> 
 <span style="color: #666666; font-style: italic;"># ici un proxy pass quelconque</span>
 proxy_pass http:<span style="color: #000000; font-weight: bold;">//</span>cherrypy;
&nbsp;
 <span style="color: #666666; font-style: italic;"># et ici la magie opère</span>
 proxy_set_header Host <span style="color: #007800;">$host</span>;
 proxy_set_header X-Real-IP <span style="color: #007800;">$remote_addr</span>;
 proxy_set_header X-Forwarded-For <span style="color: #007800;">$proxy_add_x_forwarded_for</span>;
<span style="color: #7a0874; font-weight: bold;">&#125;</span></pre></div></div>

<p><strong>Dans votre script python (ici Bottle), vous pouvez du coup la récupérer:<br />
</strong></p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #666666; font-style: italic;">#get user IP</span>
user_ip = request.remote_addr</pre></div></div>

 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=2041&amp;md5=15883c3d0c851553154ccaa72d80d8fc" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/recuperer-lip-client-avec-nginx-en-proxy-sous-cherrypy-proxy_set_header/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Frecuperer-lip-client-avec-nginx-en-proxy-sous-cherrypy-proxy_set_header%2F&amp;language=en_GB&amp;category=text&amp;title=R%C3%A9cup%C3%A9rer+l%26%238217%3BIP+client+avec+Nginx+en+proxy+sous+CherryPy%2FDjango%2FBottle+%26%238211%3B+proxy_set_header&amp;description=Si+vous+utilisez+Nginx+en+proxy%2C+vous+allez+vous+heurter+%C3%A0+son+IP+lorsque+votre+script+tentera+de+r%C3%A9cup%C3%A9rer+l%26%238217%3BIP+du+client+soit+127.0.0.1.+En+rajoutant+ces+quelques+lignes+%C3%A0...&amp;tags=bottle%2Ccherrypy%2Cdjango%2Cip%2Cnginx%2Cproxy%2Cpython%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2012/09/Proxy-Sheen-Cloud.jpeg" length="15043" type="image/jpg" />	</item>
		<item>
		<title>nginx et limitation de connexion par IP avec limit_conn_zone</title>
		<link>http://sametmax.com/nginx-et-limitation-de-connexion-par-ip-avec-limit_conn_zone/</link>
		<comments>http://sametmax.com/nginx-et-limitation-de-connexion-par-ip-avec-limit_conn_zone/#comments</comments>
		<pubDate>Fri, 06 Jul 2012 13:54:20 +0000</pubDate>
		<dc:creator>Max</dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[connexion]]></category>
		<category><![CDATA[ip]]></category>
		<category><![CDATA[limitation]]></category>
		<category><![CDATA[limit_conn]]></category>
		<category><![CDATA[limit_conn_zone]]></category>
		<category><![CDATA[nginx]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=921</guid>
		<description><![CDATA[Limiter une IP à une ou plusieurs connexion avec nginx, pratique si vous voulez proposer par exemple un seul téléchargement de fichier à la fois par IP sur votre serveur.]]></description>
			<content:encoded><![CDATA[<p>Limiter une IP à une ou plusieurs connexion avec <a href="http://wiki.nginx.org/Main">nginx</a> peut s&#8217;averer utile si vous voulez proposer par exemple un seul téléchargement de fichier à la fois par IP sur votre serveur (économie de bande passante, éviter de se faire aspirer tout le site d&#8217;un coup, etc.)</p>
<p>Nginx rappelons le est actuellement l&#8217;un des serveurs web les plus performant, gratuit qui plus est.</p>
<p>L&#8217;exemple ci-dessous va limiter une IP à 5 connexions sur l&#8217;ensemble des images servies par votre serveur. On peut bien sur modifier la regex Location pour limiter aux videos, pdf, etc&#8230;</p>
<p><strong><br />
dans le fichier de config de nginx:</strong><br />
<strong><br />
Dans http:</strong></p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;">http <span style="color: #7a0874; font-weight: bold;">&#123;</span>
limit_conn_zone <span style="color: #007800;">$binary_remote_addr</span> <span style="color: #007800;">zone</span>=limit:10m; 
<span style="color: #7a0874; font-weight: bold;">&#125;</span></pre></div></div>

<p>10m veut dire qu&#8217;il va logguer les IPs connectées dans 10 MB de mémoire après il efface et recommence, ça permet de stocker les IPs connectées récement.</p>
<p><strong><br />
Dans server:</strong></p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;">server <span style="color: #7a0874; font-weight: bold;">&#123;</span>
    location ~ \.<span style="color: #7a0874; font-weight: bold;">&#40;</span>jpg<span style="color: #000000; font-weight: bold;">|</span>jpeg<span style="color: #000000; font-weight: bold;">|</span>gif<span style="color: #000000; font-weight: bold;">|</span>png<span style="color: #7a0874; font-weight: bold;">&#41;</span>$ <span style="color: #7a0874; font-weight: bold;">&#123;</span>
      limit_conn limit <span style="color: #000000;">5</span>; <span style="color: #666666; font-style: italic;"># limit to 5 cnx by IP</span>
    <span style="color: #7a0874; font-weight: bold;">&#125;</span> 
<span style="color: #7a0874; font-weight: bold;">&#125;</span></pre></div></div>

<p>PS: limit est le nom de zone que vous donnez à votre règle, ça peut prendre la forme que ça veut comme dirait Egon dans Ghostbusters&#8230;</p>
<p>Pour en savoir plus : <a href="http://wiki.nginx.org/HttpLimitZoneModule">Doc nginx HttpLimitZoneModule</a></p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=921&amp;md5=ec8b911383ae8e96e15df8b4e1261289" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/nginx-et-limitation-de-connexion-par-ip-avec-limit_conn_zone/feed/</wfw:commentRss>
		<slash:comments>2</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fnginx-et-limitation-de-connexion-par-ip-avec-limit_conn_zone%2F&amp;language=en_GB&amp;category=text&amp;title=nginx+et+limitation+de+connexion+par+IP+avec+limit_conn_zone&amp;description=Limiter+une+IP+%C3%A0+une+ou+plusieurs+connexion+avec+nginx+peut+s%26%238217%3Baverer+utile+si+vous+voulez+proposer+par+exemple+un+seul+t%C3%A9l%C3%A9chargement+de+fichier+%C3%A0+la+fois+par+IP+sur...&amp;tags=connexion%2Cip%2Climitation%2Climit_conn%2Climit_conn_zone%2Cnginx%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2012/06/feu-rouge.jpeg" length="37223" type="image/jpg" />	</item>
	</channel>
</rss>
