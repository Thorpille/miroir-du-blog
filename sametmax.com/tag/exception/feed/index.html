<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Sam &#38; Max: Python, Django, Git et du cul &#187; exception</title>
	<atom:link href="http://sametmax.com/tag/exception/feed/" rel="self" type="application/rss+xml" />
	<link>http://sametmax.com</link>
	<description>Deux développeurs en vadrouille qui se sortent les doigts du code</description>
	<lastBuildDate>Wed, 05 Feb 2014 14:20:37 +0000</lastBuildDate>
	<language>en</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>http://wordpress.org/?v=3.3.1</generator>
	<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2F&amp;language=en_US&amp;category=text&amp;title=Sam+%26amp%3B+Max%3A+Python%2C+Django%2C+Git+et+du+cul&amp;description=Deux+d%C3%A9veloppeurs+en+vadrouille+qui+se+sortent+les+doigts+du+code&amp;tags=blog" type="text/html" />
		<item>
		<title>Envoi d&#8217;un email par logging en cas de plantage d&#8217;un script python (ou: comment faire bouffer u&#8221;\xe9&#8243; à SMTPHandler)</title>
		<link>http://sametmax.com/envoi-dun-email-par-logging-en-cas-de-plantage-dun-script-python-ou-comment-faire-bouffer-uxe9-a-smtphandler/</link>
		<comments>http://sametmax.com/envoi-dun-email-par-logging-en-cas-de-plantage-dun-script-python-ou-comment-faire-bouffer-uxe9-a-smtphandler/#comments</comments>
		<pubDate>Tue, 12 Mar 2013 08:48:23 +0000</pubDate>
		<dc:creator>etienne</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[callback]]></category>
		<category><![CDATA[email]]></category>
		<category><![CDATA[exception]]></category>
		<category><![CDATA[logguer]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=5313</guid>
		<description><![CDATA[(Ceci est un post invité d&#8217;un débutant pour les débutants&#8230; sous licence creative common 3.0 unported.) Il y a peu, je me suis mis à utiliser logging pour debugger mes scripts de débutant. Si comme moi vous avez l&#8217;habitude de mettre des print partout pour trouver l&#8217;origine d&#8217;un problème, et qu&#8217;ensuite vous avez passé de [...]]]></description>
			<content:encoded><![CDATA[<p><em>(Ceci est un post invité d&#8217;un débutant pour les débutants&#8230; sous licence <a href="http://creativecommons.org/licenses/by/3.0/">creative common 3.0 unported</a>.)</em></p>
<p>Il y a peu, je me suis mis à utiliser <code>logging</code> pour debugger mes scripts de débutant.</p>
<p>Si comme moi vous avez l&#8217;habitude de mettre des <code>print</code> partout pour trouver l&#8217;origine d&#8217;un problème, et qu&#8217;ensuite vous avez passé de longues longues longues minutes/heures à traquer ces foutus <code>print</code> pour dépolluer la sortie console, jetez un oeil à <a href="http://sametmax.com/ecrire-des-logs-en-python/">écrire des logs en python</a>.</p>
<p>Après quelques (minutes/heures/jours) de prise en main (vite, quoi&#8230;), on se demande comment on a fait pour s&#8217;en passer si longtemps. C&#8217;est simple, je n&#8217;utilise plus les touches &#8220;p&#8221;, &#8220;r&#8221;, &#8220;i&#8221;, &#8220;n&#8221; et &#8220;t&#8221; de mon clavier. Elles sont toutes propres.</p>
<p>En plus, <code>logging</code> m&#8217;a ouvert de nouvelles perspectives, parmi lesquelles la possibilité d&#8217;envoyer les logs par mail. Pas besoin de tout recevoir par mail, mais si ce foutu script de m%@rde pouvait m&#8217;envoyer un email quand il plante avec la source détaillé du problème, ce serait super.</p>
<h2>Log post mortem par email</h2>
<p>Admettons que vous vouliez vérifier que les pensées qui vous traversent l&#8217;esprit sont safe for work. Vous écrivez un script génial qui fait le boulot.</p>
<p>Comme vous commencez à savoir y faire en python, vous avez même écrit votre propre exception à vous tout seul&#8230;</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">class</span> NotSafeForWorkError<span style="color: black;">&#40;</span><span style="color: #008000;">Exception</span><span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;
    Exception soulevée si une pensée est NSFW
    &quot;&quot;&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__init__</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, msg<span style="color: black;">&#41;</span>:
        <span style="color: #008000;">self</span>.<span style="color: black;">msg</span> = u<span style="color: #483d8b;">&quot;Danger! %s est NSFW.&quot;</span> <span style="color: #66cc66;">%</span> msg
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__str__</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">self</span>.<span style="color: black;">msg</span>.<span style="color: black;">encode</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;utf-8&quot;</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># liste des pensées proscrites</span>
<span style="color: #808080; font-style: italic;"># (échantillon, elle est beaucoup plus longue que ça en réalité)</span>
NSFW = <span style="color: black;">&#91;</span><span style="color: #483d8b;">&quot;cul&quot;</span>, <span style="color: #483d8b;">&quot;seins&quot;</span>, <span style="color: #483d8b;">&quot;sametmax&quot;</span><span style="color: black;">&#93;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># boucle de censure qui soulève une exception si une pensée déconne</span>
<span style="color: #ff7700;font-weight:bold;">for</span> pensee <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: black;">&#91;</span><span style="color: #483d8b;">&quot;pause&quot;</span>, <span style="color: #483d8b;">&quot;pipi&quot;</span>, <span style="color: #483d8b;">&quot;sametmax&quot;</span><span style="color: black;">&#93;</span>:
    <span style="color: #ff7700;font-weight:bold;">if</span> pensee <span style="color: #ff7700;font-weight:bold;">in</span> NSFW:
        <span style="color: #ff7700;font-weight:bold;">raise</span> NotSafeForWorkError<span style="color: black;">&#40;</span>pensee<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">print</span> u<span style="color: #483d8b;">&quot;%s est SFW&quot;</span> <span style="color: #66cc66;">%</span> pensee
&nbsp;
<span style="color: #808080; font-style: italic;">#sortie:</span>
<span style="color: #808080; font-style: italic;">## pause est SFW</span>
<span style="color: #808080; font-style: italic;">## pipi est SFW</span>
<span style="color: #808080; font-style: italic;">## Traceback (most recent call last):</span>
<span style="color: #808080; font-style: italic;">##   File &quot;censure_setm3.py&quot;, line 30, in</span>
<span style="color: #808080; font-style: italic;">##     raise NotSafeForWorkError(pensee)</span>
<span style="color: #808080; font-style: italic;">## __main__.NotSafeForWorkError: Danger! sametmax est NSFW.</span></pre></div></div>

<p>Ça marche du tonnerre! C&#8217;est là que vous vous dites que ce serait bien si le script envoyait le traceback par email à votre psy pour le prévenir que vous avez déconné.</p>
<p>A la maison, vous avez lu l&#8217;article de Sam sur les <a href="http://sametmax.com/log-post-mortem-avec-python/">logs post mortem</a>. Ça a l&#8217;air facile à faire.</p>
<p>Vous créez d&#8217;abord un logger qui enverra les logs de niveau critique par mail:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">logging</span>
<span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">logging</span>.<span style="color: black;">handlers</span> <span style="color: #ff7700;font-weight:bold;">import</span> SMTPHandler
&nbsp;
nom_loggeur = <span style="color: #483d8b;">&quot;test_nsfw&quot;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># On crée un logger et on met le niveau à critique:</span>
<span style="color: #808080; font-style: italic;">#  il ne tiendra compte que des logs de ce niveau</span>
logger = <span style="color: #dc143c;">logging</span>.<span style="color: black;">getLogger</span><span style="color: black;">&#40;</span>nom_loggeur<span style="color: black;">&#41;</span>
logger.<span style="color: black;">setLevel</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">logging</span>.<span style="color: black;">CRITICAL</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># On crée le handler en lui passant les paramètres</span>
<span style="color: #808080; font-style: italic;">#  nécessaires à l'envoi d'un email</span>
mail_handler = SMTPHandler<span style="color: black;">&#40;</span>
    <span style="color: #808080; font-style: italic;"># Host et port</span>
    <span style="color: black;">&#40;</span><span style="color: #483d8b;">'SMTP.GMAIL.COM'</span>, <span style="color: #ff4500;">587</span><span style="color: black;">&#41;</span>,
    <span style="color: #808080; font-style: italic;"># From</span>
    <span style="color: #483d8b;">&quot;MOI@GMAIL.COM&quot;</span>,
    <span style="color: #808080; font-style: italic;"># To (liste)</span>
    <span style="color: black;">&#91;</span><span style="color: #483d8b;">&quot;QUELQU.UN@QUELQUE.PART&quot;</span><span style="color: black;">&#93;</span>,
    <span style="color: #808080; font-style: italic;"># Sujet du message</span>
    <span style="color: #483d8b;">&quot;Erreur critique dans %s&quot;</span> <span style="color: #66cc66;">%</span> nom_loggeur,
    <span style="color: #808080; font-style: italic;"># pour l'authentification</span>
    credentials = <span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;MONEMAIL@GMAIL.COM&quot;</span>, <span style="color: #483d8b;">&quot;MONSUPERPASSWORD&quot;</span><span style="color: black;">&#41;</span>,
    secure = <span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># On met le handler à &quot;critique&quot;.</span>
<span style="color: #808080; font-style: italic;"># Il enverra donc par mail les messages de ce niveau</span>
mail_handler.<span style="color: black;">setLevel</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">logging</span>.<span style="color: black;">CRITICAL</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># On définit un formatter: date, nom du logger, niveau, message</span>
<span style="color: #dc143c;">formatter</span> = <span style="color: #dc143c;">logging</span>.<span style="color: black;">Formatter</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># On associe le formatter au handler:</span>
<span style="color: #808080; font-style: italic;">#  c'est lui qui formatera les logs de ce handler</span>
mail_handler.<span style="color: black;">setFormatter</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">formatter</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># ... et on associe le handler au logger:</span>
<span style="color: #808080; font-style: italic;">#  il utilisera ce handler, qui émettra les logs critiques</span>
logger.<span style="color: black;">addHandler</span><span style="color: black;">&#40;</span>mail_handler<span style="color: black;">&#41;</span></pre></div></div>

<p>Ensuite vous redéfinissez sys.excepthook de manière à ce que l&#8217;exception soit logguée. La fonction convertit le traceback en string, la loggue au niveau critique et laisse l&#8217;exception continuer son chemin.</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">sys</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># la fonction qui remplacera sys.excepthook</span>
<span style="color: #ff7700;font-weight:bold;">def</span> en_cas_de_plantage<span style="color: black;">&#40;</span>type_except, value, tb<span style="color: black;">&#41;</span>:
&nbsp;
    <span style="color: #808080; font-style: italic;"># Traceback permettra de formater l'exception.</span>
    <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">traceback</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># Mise en forme de l'exception. Retourne la trace</span>
    <span style="color: #808080; font-style: italic;">#  sous forme de str avec numéros de lignes et tout</span>
    trace = <span style="color: #483d8b;">&quot;&quot;</span>.<span style="color: black;">join</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">traceback</span>.<span style="color: black;">format_exception</span><span style="color: black;">&#40;</span>type_except, value, tb<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># On loggue l'exception au niveau &quot;critique&quot;,</span>
    <span style="color: #808080; font-style: italic;">#  elle sera donc envoyée par email</span>
    logger.<span style="color: black;">critical</span><span style="color: black;">&#40;</span>u<span style="color: #483d8b;">&quot;Erreur inattendue:<span style="color: #000099; font-weight: bold;">\n</span>%s&quot;</span>, trace<span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># ... et on laisse le script se planter...</span>
    <span style="color: #dc143c;">sys</span>.__excepthook__<span style="color: black;">&#40;</span>type_except, value, tb<span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># on remplace sys.excepthook, et le tour est joué</span>
    <span style="color: #dc143c;">sys</span>.<span style="color: black;">excepthook</span> = en_cas_de_plantage</pre></div></div>

<p>Et voilà. Vous lancez le script, il se casse la gueule dès qu&#8217;il rencontre &#8220;sametmax&#8221;, votre psy reçoit un email avec le traceback, c&#8217;est cool.</p>
<p>Sauf que&#8230;</p>
<h2>SMTPHandler ne gère pas unicode</h2>
<p>Si au moment de la création de mail_handler, vous passez comme sujet à SMTPHandler:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">u<span style="color: #483d8b;">&quot;%s s'est planté&quot;</span> <span style="color: #66cc66;">%</span> nom_loggeur</pre></div></div>

<p>ou que dans votre fonction &#8220;en_cas_de_plantage&#8221; vous mettez:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">logger.<span style="color: black;">critical</span><span style="color: black;">&#40;</span>u<span style="color: #483d8b;">&quot;Bébé a encore glissé dans son caca:<span style="color: #000099; font-weight: bold;">\n</span>%s&quot;</span>, trace<span style="color: black;">&#41;</span></pre></div></div>

<p>&#8230; autrement dit si vous avez une chaîne unicode qui ne peut pas être encodée en ascii, ça va pas marcher:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">Traceback <span style="color: black;">&#40;</span>most recent call last<span style="color: black;">&#41;</span>:
  File <span style="color: #483d8b;">&quot;envoie_mail_on_crash.py&quot;</span>, line <span style="color: #ff4500;">84</span>, <span style="color: #ff7700;font-weight:bold;">in</span> emit
    smtp.<span style="color: black;">sendmail</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">fromaddr</span>, <span style="color: #008000;">self</span>.<span style="color: black;">toaddrs</span>, msg<span style="color: black;">&#41;</span>
  File <span style="color: #483d8b;">&quot;/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/smtplib.py&quot;</span>, line <span style="color: #ff4500;">734</span>, <span style="color: #ff7700;font-weight:bold;">in</span> sendmail
    <span style="color: black;">&#40;</span><span style="color: #dc143c;">code</span>, resp<span style="color: black;">&#41;</span> = <span style="color: #008000;">self</span>.<span style="color: black;">data</span><span style="color: black;">&#40;</span>msg<span style="color: black;">&#41;</span>
  File <span style="color: #483d8b;">&quot;/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/smtplib.py&quot;</span>, line <span style="color: #ff4500;">501</span>, <span style="color: #ff7700;font-weight:bold;">in</span> data
    <span style="color: #008000;">self</span>.<span style="color: black;">send</span><span style="color: black;">&#40;</span>q<span style="color: black;">&#41;</span>
  File <span style="color: #483d8b;">&quot;/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/smtplib.py&quot;</span>, line <span style="color: #ff4500;">321</span>, <span style="color: #ff7700;font-weight:bold;">in</span> send
    <span style="color: #008000;">self</span>.<span style="color: black;">sock</span>.<span style="color: black;">sendall</span><span style="color: black;">&#40;</span><span style="color: #008000;">str</span><span style="color: black;">&#41;</span>
  File <span style="color: #483d8b;">&quot;/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/ssl.py&quot;</span>, line <span style="color: #ff4500;">229</span>, <span style="color: #ff7700;font-weight:bold;">in</span> sendall
    v = <span style="color: #008000;">self</span>.<span style="color: black;">send</span><span style="color: black;">&#40;</span>data<span style="color: black;">&#91;</span>count:<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
  File <span style="color: #483d8b;">&quot;/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/ssl.py&quot;</span>, line <span style="color: #ff4500;">198</span>, <span style="color: #ff7700;font-weight:bold;">in</span> send
    v = <span style="color: #008000;">self</span>._sslobj.<span style="color: black;">write</span><span style="color: black;">&#40;</span>data<span style="color: black;">&#41;</span>
<span style="color: #008000;">UnicodeEncodeError</span>: <span style="color: #483d8b;">'ascii'</span> codec can<span style="color: #483d8b;">'t encode character u'</span>\xe9<span style="color: #483d8b;">' in position 62: ordinal not in range(128)
Logged from file envoie_mail_on_crash.py, line 163</span></pre></div></div>

<p>D&#8217;où l&#8217;on déduit qu&#8217;il y a une tentative foirée d&#8217;encodage d&#8217;une chaîne unicode en ascii par la méthode &#8220;write&#8221; de ce mystérieux _sslobj, et que c&#8217;est une méthode &#8220;emit&#8221; quelque part dans handlers.py qui lui a passé la chaîne.</p>
<p>Fuck! Investiguons. Et essayons de régler ça par le haut de la pile.</p>
<h2>Toi, là au fond! Oui, toi!</h2>
<p>C&#8217;est la methode <code>emit</code> de SMTPHandler qui est responsable. Elle fait quoi cette méthode? Elle formate le &#8220;record&#8221;, crée un message et l&#8217;envoie à l&#8217;adresse mail spécifiée. Voilà le code:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> emit<span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, record<span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;
    Emit a record.
&nbsp;
    Format the record and send it to the specified addressees.
    &quot;&quot;&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">try</span>:
        <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">smtplib</span>
        <span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">email</span>.<span style="color: black;">utils</span> <span style="color: #ff7700;font-weight:bold;">import</span> formatdate
        port = <span style="color: #008000;">self</span>.<span style="color: black;">mailport</span>
        <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #ff7700;font-weight:bold;">not</span> port:
            port = <span style="color: #dc143c;">smtplib</span>.<span style="color: black;">SMTP_PORT</span>
        smtp = <span style="color: #dc143c;">smtplib</span>.<span style="color: black;">SMTP</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">mailhost</span>, port<span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># C'est ici l'objet &quot;record&quot; est formatté</span>
        msg = <span style="color: #008000;">self</span>.<span style="color: black;">format</span><span style="color: black;">&#40;</span>record<span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># Le message est construit ici. Il sera ensuite envoyé par smtp.sendmail</span>
        <span style="color: #808080; font-style: italic;"># C'est là que le bât blesse</span>
        msg = <span style="color: #483d8b;">&quot;From: %s<span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span>To: %s<span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span>Subject: %s<span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span>Date: %s<span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span><span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span>%s&quot;</span> <span style="color: #66cc66;">%</span> <span style="color: black;">&#40;</span>
                        <span style="color: #008000;">self</span>.<span style="color: black;">fromaddr</span>,
                        <span style="color: #483d8b;">&quot;,&quot;</span>.<span style="color: black;">join</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">toaddrs</span><span style="color: black;">&#41;</span>,
                        <span style="color: #808080; font-style: italic;"># Notons ce getSubject(record). La méthode renvoie</span>
                        <span style="color: #808080; font-style: italic;">#  le sujet du message, passé à la création</span>
                        <span style="color: #808080; font-style: italic;">#  de mail_handler</span>
                        <span style="color: #008000;">self</span>.<span style="color: black;">getSubject</span><span style="color: black;">&#40;</span>record<span style="color: black;">&#41;</span>,
                        formatdate<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>,
                        <span style="color: #808080; font-style: italic;"># le record formaté</span>
                        msg<span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #008000;">self</span>.<span style="color: black;">username</span>:
            <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #008000;">self</span>.<span style="color: black;">secure</span> <span style="color: #ff7700;font-weight:bold;">is</span> <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #008000;">None</span>:
                smtp.<span style="color: black;">ehlo</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
                smtp.<span style="color: black;">starttls</span><span style="color: black;">&#40;</span><span style="color: #66cc66;">*</span><span style="color: #008000;">self</span>.<span style="color: black;">secure</span><span style="color: black;">&#41;</span>
                smtp.<span style="color: black;">ehlo</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
            smtp.<span style="color: black;">login</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">username</span>, <span style="color: #008000;">self</span>.<span style="color: black;">password</span><span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># Le mail et envoyé</span>
        smtp.<span style="color: black;">sendmail</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">fromaddr</span>, <span style="color: #008000;">self</span>.<span style="color: black;">toaddrs</span>, msg<span style="color: black;">&#41;</span>
&nbsp;
        smtp.<span style="color: black;">quit</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: black;">&#40;</span><span style="color: #008000;">KeyboardInterrupt</span>, <span style="color: #008000;">SystemExit</span><span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">raise</span>
    <span style="color: #ff7700;font-weight:bold;">except</span>:
        <span style="color: #008000;">self</span>.<span style="color: black;">handleError</span><span style="color: black;">&#40;</span>record<span style="color: black;">&#41;</span></pre></div></div>

<p>Qu&#8217;est-ce qu&#8217;il se passe?</p>
<p>Après quelques tests genre:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">    msg = <span style="color: #008000;">self</span>.<span style="color: black;">format</span><span style="color: black;">&#40;</span>record<span style="color: black;">&#41;</span>
    <span style="color: #808080; font-style: italic;"># C'est pratique parfois un petit print</span>
    <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #008000;">type</span><span style="color: black;">&#40;</span>msg<span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;">##</span></pre></div></div>

<p>&#8230; on voit que la méthode <code>format</code> (qui structure votre log selon la forme passée à logging.Formatter) retourne un objet de type unicode si le message que vous avez loggué (<code>logger.critical(u"% foiré!", trace)</code>) contient de l&#8217;unicode.</p>
<p>Idem pour <code>getSubject(record)</code> qui, en l&#8217;état, ne fait que retourner le sujet du email tel que vous l&#8217;avez passé à l&#8217;instanciation de SMTPHandler.</p>
<p>Donc, quand msg est formaté, si le log ou le message sont en unicode, msg sera en unicode.</p>
<h2>WTF!?</h2>
<p>J&#8217;ai été surpris quand j&#8217;ai fini par piger comment ça fonctionne. Même pour un débutant comme moi ça a l&#8217;air bête.</p>
<p>J&#8217;y connais rien en email, mais il ne m&#8217;a pas fallu longtemps pour comprendre que, dans sa forme basique, un email c&#8217;est du ascii, point. Et que si on veut envoyer autre chose que du ascii, qui soit décodable de l&#8217;autre côté, il faut qu&#8217;il y ait les headers appropriés, que le contenu soit encodé, que sais-je encore&#8230;</p>
<p>Peut-être un truc programmé par des gars qui ne manipulent jamais autre chose que de l&#8217;anglais? Ils auraient essayé d&#8217;envoyer un mail en russes ou en suédois, ça se serait planté au premier test. Oui, oui, Sam, la lingua franca, tout ça&#8230;</p>
<p>Ou alors c&#8217;est pour des questions de compatibilité avec des versions antérieures de python qui ne contiendraient pas les ressources nécessaires pour formater correctement un mail? Aucune idée&#8230;</p>
<p>Comment régler ça?</p>
<h2>Il mangea u&#8221;\xe9&#8243; et il en redemanda</h2>
<p>Le module <a href="http://docs.python.org/2/library/email.html"> email </a> de la lib standard permet de créer des emails. On trouve dans <code>email.mime</code> une classe MIMEText qui nous conviendra parfaitement. On va donc subclasser SMTPHandler et réécrire la méthode <code>emit</code> pour qu&#8217;elle construise un message &#8220;RFC-compliant&#8221;, comme ils disent dans la doc.</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">class</span> SMTPHandler_unicode<span style="color: black;">&#40;</span>SMTPHandler<span style="color: black;">&#41;</span>:
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> emit<span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, record<span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">try</span>:
            <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">smtplib</span>
            <span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">email</span>.<span style="color: black;">utils</span> <span style="color: #ff7700;font-weight:bold;">import</span> formatdate
&nbsp;
            <span style="color: #808080; font-style: italic;"># On importe MIMEText</span>
            <span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">email</span>.<span style="color: black;">mime</span>.<span style="color: black;">text</span> <span style="color: #ff7700;font-weight:bold;">import</span> MIMEText
&nbsp;
            port = <span style="color: #008000;">self</span>.<span style="color: black;">mailport</span>
            <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #ff7700;font-weight:bold;">not</span> port:
                port = <span style="color: #dc143c;">smtplib</span>.<span style="color: black;">SMTP_PORT</span> <span style="color: #808080; font-style: italic;"># 25</span>
            smtp = <span style="color: #dc143c;">smtplib</span>.<span style="color: black;">SMTP</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">mailhost</span>, port<span style="color: black;">&#41;</span>
&nbsp;
            msg = <span style="color: #008000;">self</span>.<span style="color: black;">format</span><span style="color: black;">&#40;</span>record<span style="color: black;">&#41;</span>
&nbsp;
            <span style="color: #808080; font-style: italic;"># Au moment de la création de l'objet par MIMEText,</span>
            <span style="color: #808080; font-style: italic;">#  si msg est de type unicode, il sera encodé</span>
            <span style="color: #808080; font-style: italic;">#  selon _charset, sinon il sera laissé tel quel</span>
            message = MIMEText<span style="color: black;">&#40;</span>msg, _charset = <span style="color: #483d8b;">&quot;utf-8&quot;</span><span style="color: black;">&#41;</span>
&nbsp;
            <span style="color: #808080; font-style: italic;"># On ajoute les headers nécessaires. S'il sont de type unicode,</span>
            <span style="color: #808080; font-style: italic;">#  ils seront encodés selon _charset</span>
            message.<span style="color: black;">add_header</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Subject&quot;</span>, <span style="color: #008000;">self</span>.<span style="color: black;">getSubject</span><span style="color: black;">&#40;</span>record<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
            message.<span style="color: black;">add_header</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;From&quot;</span>, <span style="color: #008000;">self</span>.<span style="color: black;">fromaddr</span><span style="color: black;">&#41;</span>
            message.<span style="color: black;">add_header</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;To&quot;</span>, <span style="color: #483d8b;">&quot;,&quot;</span>.<span style="color: black;">join</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">toaddrs</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
            message.<span style="color: black;">add_header</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Date&quot;</span>, formatdate<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
            <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #008000;">self</span>.<span style="color: black;">username</span>:
                <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #008000;">self</span>.<span style="color: black;">secure</span> <span style="color: #ff7700;font-weight:bold;">is</span> <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #008000;">None</span>:
                    smtp.<span style="color: black;">ehlo</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
                    smtp.<span style="color: black;">starttls</span><span style="color: black;">&#40;</span><span style="color: #66cc66;">*</span><span style="color: #008000;">self</span>.<span style="color: black;">secure</span><span style="color: black;">&#41;</span>
                    smtp.<span style="color: black;">ehlo</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
                smtp.<span style="color: black;">login</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">username</span>, <span style="color: #008000;">self</span>.<span style="color: black;">password</span><span style="color: black;">&#41;</span>
&nbsp;
            <span style="color: #808080; font-style: italic;"># Envoi du message proprement encodé</span>
            smtp.<span style="color: black;">sendmail</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">fromaddr</span>, <span style="color: #008000;">self</span>.<span style="color: black;">toaddrs</span>, message.<span style="color: black;">as_string</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
            smtp.<span style="color: black;">quit</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: black;">&#40;</span><span style="color: #008000;">KeyboardInterrupt</span>, <span style="color: #008000;">SystemExit</span><span style="color: black;">&#41;</span>:
            <span style="color: #ff7700;font-weight:bold;">raise</span>
        <span style="color: #ff7700;font-weight:bold;">except</span>:
            <span style="color: #008000;">self</span>.<span style="color: black;">handleError</span><span style="color: black;">&#40;</span>record<span style="color: black;">&#41;</span></pre></div></div>

<p>Ce qui est intéressant avec MIMEText c&#8217;est que si vous déclarez un encodage (<code>_charset = "utf-8"</code>), et que vous passez une chaîne unicode a l&#8217;instanciation, il l&#8217;encodera selon <code>_charset</code>.</p>
<p>Idem si vous ajoutez un header en appelant <code>add_header</code>, ce qui permet dans notre cas de traiter correctement le sujet du mail.</p>
<p>L&#8217;appel à la méthode <code>to_string</code> retournera le message proprement encodé (en base64) pour le transfert, et les headers appropriés seront inclus.</p>
<p>Voilà, il ne reste plus qu&#8217;à utiliser cette classe pour créer mail_handler, et le tour est joué.</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">mail_handler = SMTPHandler_unicode<span style="color: black;">&#40;</span>
    <span style="color: #808080; font-style: italic;"># host et port</span>
    <span style="color: black;">&#40;</span><span style="color: #483d8b;">'SMTP.GMAIL.COM'</span>, <span style="color: #ff4500;">587</span><span style="color: black;">&#41;</span>,
    <span style="color: #808080; font-style: italic;"># From</span>
    <span style="color: #483d8b;">&quot;MOI@GMAIL.COM&quot;</span>,
    <span style="color: #808080; font-style: italic;"># To (liste)s</span>
    <span style="color: black;">&#91;</span><span style="color: #483d8b;">&quot;QUELQU.UN@QUELQUE.PART&quot;</span><span style="color: black;">&#93;</span>,
    <span style="color: #808080; font-style: italic;"># sujet du message</span>
    u<span style="color: #483d8b;">&quot;Bonjour Mr Freud. %s a encore repéré des pensées génantes&quot;</span> <span style="color: #66cc66;">%</span> nom_loggeur,
    <span style="color: #808080; font-style: italic;"># pour l'authentification</span>
    credentials = <span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;MONEMAIL@GMAIL.COM&quot;</span>, <span style="color: #483d8b;">&quot;MONSUPERPASSWORD&quot;</span><span style="color: black;">&#41;</span>,
    secure = <span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: black;">&#41;</span></pre></div></div>

<p>Bilan de l&#8217;histoire: c&#8217;est en débutant qu&#8217;on devient débutant&#8230;</p>
<hr />
<a href="https://github.com/sametmax/codes-des-articles/blob/master/2013/mars/envoi_mail_on_crash.py">Télécharger le code de l&#8217;article.</a></p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=5313&amp;md5=2a70d8c9d9e3c74fb78760edd63af5f9" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/envoi-dun-email-par-logging-en-cas-de-plantage-dun-script-python-ou-comment-faire-bouffer-uxe9-a-smtphandler/feed/</wfw:commentRss>
		<slash:comments>9</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fenvoi-dun-email-par-logging-en-cas-de-plantage-dun-script-python-ou-comment-faire-bouffer-uxe9-a-smtphandler%2F&amp;language=en_GB&amp;category=text&amp;title=Envoi+d%26%238217%3Bun+email+par+logging+en+cas+de+plantage+d%26%238217%3Bun+script+python+%28ou%3A+comment+faire+bouffer+u%26%238221%3B%5Cxe9%26%238243%3B+%C3%A0+SMTPHandler%29&amp;description=%28Ceci+est+un+post+invit%C3%A9+d%26%238217%3Bun+d%C3%A9butant+pour+les+d%C3%A9butants%26%238230%3B+sous+licence+creative+common+3.0+unported.%29+Il+y+a+peu%2C+je+me+suis+mis+%C3%A0+utiliser+logging+pour+debugger+mes...&amp;tags=callback%2Cemail%2Cexception%2Clogguer%2Cpython%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/03/tu_va_me_le_bouffer_oui.jpg" length="45654" type="image/jpg" />	</item>
		<item>
		<title>TypeError: Error when calling the metaclass bases function() argument 1 must be code, not str</title>
		<link>http://sametmax.com/typeerror-error-when-calling-the-metaclass-bases-function-argument-1-must-be-code-not-str/</link>
		<comments>http://sametmax.com/typeerror-error-when-calling-the-metaclass-bases-function-argument-1-must-be-code-not-str/#comments</comments>
		<pubDate>Wed, 16 Jan 2013 12:16:23 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[error]]></category>
		<category><![CDATA[exception]]></category>
		<category><![CDATA[heritage]]></category>
		<category><![CDATA[pep8]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=4150</guid>
		<description><![CDATA[Cette erreur est souvent déclenchée quand on essaye d'hériter d'une fonction au lieu d'une classe. Cela peut arriver par erreur avec des fonctions qui sont nommées en CamelCase, en dépit du PEP8.]]></description>
			<content:encoded><![CDATA[<p>Cette erreur est souvent déclenchée quand on essaye d&#8217;hériter d&#8217;une fonction au lieu d&#8217;une classe. Cela peut arriver par erreur avec des fonctions qui sont nommées en CamelCase, en dépit du PEP8.</p>
<p>Par exemple:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">class</span> Truc<span style="color: black;">&#40;</span><span style="color: #dc143c;">threading</span>.<span style="color: black;">Condition</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">pass</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">class</span> Machine<span style="color: black;">&#40;</span><span style="color: #dc143c;">tempfile</span>.<span style="color: black;">NamedTemporaryFile</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">pass</span></pre></div></div>

<p>Lèveront l&#8217;exception :</p>
<pre>TypeError: Error when calling the metaclass bases
    function() argument 1 must be code, not str</pre>
<p>Car:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">threading</span>, <span style="color: #dc143c;">tempfile</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">type</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">threading</span>.<span style="color: black;">Condition</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&lt;</span>type <span style="color: #483d8b;">'function'</span><span style="color: #66cc66;">&gt;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">type</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">tempfile</span>.<span style="color: black;">NamedTemporaryFile</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&lt;</span>type <span style="color: #483d8b;">'function'</span><span style="color: #66cc66;">&gt;</span></pre></div></div>

<p>Malgré leurs noms en majuscule.</p>
<p>Le message d&#8217;erreur est lui-même complètement obscure. Bref, le genre de truc qui est 100% lié à des erreurs d&#8217;autres personnes que vous aller payer par une après-midi de debug si on ne vous donne pas la solution. </p>
<p>Mais bon, la queue de celui qui n&#8217;a jamais pourri l&#8217;après-midi d&#8217;un autre codeur avec son travail merdique jette le premier parpaing.</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=4150&amp;md5=8f1d003b28606f0f8e8c65212ba69ab1" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/typeerror-error-when-calling-the-metaclass-bases-function-argument-1-must-be-code-not-str/feed/</wfw:commentRss>
		<slash:comments>6</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Ftypeerror-error-when-calling-the-metaclass-bases-function-argument-1-must-be-code-not-str%2F&amp;language=en_GB&amp;category=text&amp;title=TypeError%3A+Error+when+calling+the+metaclass+bases+function%28%29+argument+1+must+be+code%2C+not+str&amp;description=Cette+erreur+est+souvent+d%C3%A9clench%C3%A9e+quand+on+essaye+d%26%238217%3Bh%C3%A9riter+d%26%238217%3Bune+fonction+au+lieu+d%26%238217%3Bune+classe.+Cela+peut+arriver+par+erreur+avec+des+fonctions+qui+sont+nomm%C3%A9es+en+CamelCase%2C+en+d%C3%A9pit...&amp;tags=error%2Cexception%2Cheritage%2Cpep8%2Cpython%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/01/errormessagesrk3.png" length="424492" type="image/jpg" />	</item>
	</channel>
</rss>
