<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Sam &#38; Max: Python, Django, Git et du cul &#187; context manager</title>
	<atom:link href="http://sametmax.com/tag/context-manager/feed/" rel="self" type="application/rss+xml" />
	<link>http://sametmax.com</link>
	<description>Deux développeurs en vadrouille qui se sortent les doigts du code</description>
	<lastBuildDate>Wed, 05 Feb 2014 14:20:37 +0000</lastBuildDate>
	<language>en</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>http://wordpress.org/?v=3.3.1</generator>
	<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2F&amp;language=en_US&amp;category=text&amp;title=Sam+%26amp%3B+Max%3A+Python%2C+Django%2C+Git+et+du+cul&amp;description=Deux+d%C3%A9veloppeurs+en+vadrouille+qui+se+sortent+les+doigts+du+code&amp;tags=blog" type="text/html" />
		<item>
		<title>Ecrire un code pour les autres en Python</title>
		<link>http://sametmax.com/ecrire-un-code-pour-les-autres-en-python/</link>
		<comments>http://sametmax.com/ecrire-un-code-pour-les-autres-en-python/#comments</comments>
		<pubDate>Sat, 17 Aug 2013 13:15:07 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[context manager]]></category>
		<category><![CDATA[poo]]></category>
		<category><![CDATA[property]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=7122</guid>
		<description><![CDATA[Cet article s'adresse à des développeurs qui commencent à être bien dans leurs chaussettes en Python et qui se sentent de relever le défi d'écrire du code pour d'autres personnes.
]]></description>
			<content:encoded><![CDATA[<p>Cet article s&#8217;adresse à des développeurs qui commencent à être bien dans leurs chaussettes en Python et qui se sentent de relever le défi d&#8217;écrire du code pour d&#8217;autres personnes.</p>
<p>Car quand vous allez publier du code, un script, une lib voire, Dieu ait pitié de vous, un framework, les gens qui vont les utiliser vont avoir des besoins auxquels vous n&#8217;aviez pas pensé. Or, ils ne voudront pas modifier votre code. L&#8217;interêt d&#8217;utiliser le code d&#8217;un autre, c&#8217;est justement de s&#8217;éviter la maintenance. Ils voudront aussi prendre en main rapidement votre outil pour faire des choses simples sans avoir à tout comprendre.</p>
<p>Ainsi, il va vous falloir intégrer divers moyens d&#8217;étendre les fonctionnalités de votre code, afin que les autres dev puissent l&#8217;utiliser dans le cadre de leurs besoins.</p>
<p>Nous allons donc construire un projet bidon : une barre de progression en ASCII dont la sortie va ressembler à ceci :</p>
<p>Starting [=========================================     ] 93%</p>
<p>L&#8217;idée est de pouvoir l&#8217;utiliser ainsi :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">    <span style="color: #ff7700;font-weight:bold;">with</span> ProgressBar<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">as</span> pb:
        <span style="color: #ff7700;font-weight:bold;">for</span> progres <span style="color: #ff7700;font-weight:bold;">in</span> faire_un_truc<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
            pb.<span style="color: black;">progress</span> = progres</pre></div></div>

<p>Nous allons le proposer ce projet sous forme de classe importable, et nous allons voir plusieurs manières de rendre ce code facile à prendre en main, configurable et extensible :</p>
<ul>
<li>Paramètres, avec un ordre intelligent et des valeurs par défaut saines.</li>
<li>Templating de l&#8217;ouput.</li>
<li>Methodes pouvant être écrasée par héritage.</li>
<li>Getter and setter (ici via des propriétés)</li>
<li>Exposition intelligente des attributs de la classe.</li>
<li>Callbacks et passage réfléchi de paramètres à ceux-ci.</li>
</ul>
<p>J&#8217;aurais pu ajouter l&#8217;injection de dépendance, mais j&#8217;ai déjà traité ce sujet dans un autre article, et je ne voulais pas charger celui-ci. Il est déjà bien gras.</p>
<p>J&#8217;ai aussi volontairement omis la docstring et les comments. Écrire une bonne doc est un article à part entière.</p>
<p>Pré-requis : être parfaitement à l&#8217;aise avec le <a href="http://sametmax.com/le-guide-ultime-et-definitif-sur-la-programmation-orientee-objet-en-python-a-lusage-des-debutants-qui-sont-rassures-par-les-textes-detailles-qui-prennent-le-temps-de-tout-expliquer-partie-1/">POO</a> et les références, comprendre le principe des context managers, avoir pigé les <a href="http://sametmax.com/quest-ce-quun-callback/">callbacks</a>.</p>
<p>Et roulez jeunesse !</p>

<!-- iframe plugin v:2.3 - wordpress.org/extend/plugins/iframe/ -->
<iframe width="560" height="315" src="//www.youtube.com/embed/zoF7qxapnSA" frameborder="0" scrolling="no" class="iframe-class"></iframe>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #808080; font-style: italic;"># -*- coding: utf-8 -*-</span>
&nbsp;
&nbsp;
&nbsp;
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">sys</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">from</span> io <span style="color: #ff7700;font-weight:bold;">import</span> IOBase
&nbsp;
&nbsp;
<span style="color: #808080; font-style: italic;"># On hérite d'IOBase pour permettre le détournement de stdout. Voir plus bas.</span>
<span style="color: #ff7700;font-weight:bold;">class</span> ProgressBar<span style="color: black;">&#40;</span>IOBase<span style="color: black;">&#41;</span>:
&nbsp;
&nbsp;
    <span style="color: #808080; font-style: italic;"># On met les paramètres par ordre de fréquence d'utilisation. Il est</span>
    <span style="color: #808080; font-style: italic;"># plus probable que les programmeurs changent le total que la sortie</span>
    <span style="color: #808080; font-style: italic;"># du programme.</span>
    <span style="color: #808080; font-style: italic;"># Mettre des valeurs par défaut saines permet à l'utilisateur de faire</span>
    <span style="color: #808080; font-style: italic;"># des essais sans trop regarder la doc. Par ailleurs, des valeurs par</span>
    <span style="color: #808080; font-style: italic;"># défaut servent de documentation en soit, et apparaitront si help()</span>
    <span style="color: #808080; font-style: italic;"># est appelé.</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__init__</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, total=<span style="color: #ff4500;">100</span>,  percent_per_sign=<span style="color: #ff4500;">1</span>,
                 progress_sign=<span style="color: #483d8b;">'='</span>, callbacks=<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>,
                 template=<span style="color: #483d8b;">'Starting [{bar}] {progress}%'</span>,
                 output=<span style="color: #dc143c;">sys</span>.<span style="color: black;">stdout</span>, intercept_stdout=<span style="color: #008000;">True</span><span style="color: black;">&#41;</span>:
&nbsp;
        <span style="color: #808080; font-style: italic;"># Par défaut le total est 100, afin que l'utilisateur passe un</span>
        <span style="color: #808080; font-style: italic;"># pourcentage, ce qui est le plus naturel. Néanmoins, si il souhaite</span>
        <span style="color: #808080; font-style: italic;"># s'affranchir de calculs, on lui permet de passer une autre valeur</span>
        <span style="color: #808080; font-style: italic;"># qui sera ramenée à un pourcentage automatiquement à l'affichage</span>
        <span style="color: #808080; font-style: italic;"># de toute façon.</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">total</span> = total
&nbsp;
        <span style="color: #808080; font-style: italic;"># Customisation de base : changer le symbole de progrès. Par défaut</span>
        <span style="color: #808080; font-style: italic;"># un égal, mais certains aiment les ., les - ou autre.</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">progress_sign</span> = progress_sign
&nbsp;
        <span style="color: #808080; font-style: italic;"># Idem, si la personne veut une barre plus ou moins longue.</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">percent_per_sign</span> = percent_per_sign
&nbsp;
        <span style="color: #808080; font-style: italic;"># la longueur de la barre de progression</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">bar_len</span> = <span style="color: #ff4500;">100</span> / percent_per_sign <span style="color: #66cc66;">*</span> <span style="color: #008000;">len</span><span style="color: black;">&#40;</span>progress_sign<span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># Le formatage de la progress bar se fait à l'aide d'une chaîne</span>
        <span style="color: #808080; font-style: italic;"># ordinaire qui sert de template (avec le langage de formatage de Python)</span>
        <span style="color: #808080; font-style: italic;"># et peut facilement être changée pour obtenir plus de contrôle</span>
        <span style="color: #808080; font-style: italic;"># sur l'aspect de la bar.</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">template</span> = template
&nbsp;
        <span style="color: #808080; font-style: italic;"># On peut aussi passer un tuple de fonctions qui permettent de réagir</span>
        <span style="color: #808080; font-style: italic;"># à chaque fois que le progrès change. On utilise nous-même notre</span>
        <span style="color: #808080; font-style: italic;"># système de callback pour que la methode print_progress() soit</span>
        <span style="color: #808080; font-style: italic;"># appelée à chaque fois, mettant à jour l'affichage de la bar.</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">callbacks</span> = callbacks + <span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">print_progress</span>,<span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># Initialisation de 3 variables à vide. 'buffer' va contenir</span>
        <span style="color: #808080; font-style: italic;"># tout ce qui va être écrit avec write() pour éviter de perturber</span>
        <span style="color: #808080; font-style: italic;"># l'affichage de la bar, et '_progress' va contenir le progrès, mais</span>
        <span style="color: #808080; font-style: italic;"># le '_' signale que c'est une variable à usage interne. Nous allons</span>
        <span style="color: #808080; font-style: italic;"># en effet l'enrober dans une propriété. Enfin cursor_shift est</span>
        <span style="color: #808080; font-style: italic;"># le nombre de caractères à effacer pour redessiner la bar à chaque</span>
        <span style="color: #808080; font-style: italic;"># mise à jour.</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">buffer</span> = <span style="color: #483d8b;">''</span>
        <span style="color: #008000;">self</span>._progress = <span style="color: #ff4500;">0</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">cursor_shift</span> = <span style="color: #ff4500;">0</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># Par défaut, on s'attend à ce que l'utilisateur affiche cette</span>
        <span style="color: #808080; font-style: italic;"># bar directement dans le terminal, sur la sortie standard. Mais</span>
        <span style="color: #808080; font-style: italic;"># il peut vouloir déporter l'affichage ailleurs (par exemple stderr).</span>
        <span style="color: #808080; font-style: italic;"># Pour cette raison, on permet de passer le stream sur lequel</span>
        <span style="color: #808080; font-style: italic;"># l'utilisateur va écrire, même si par défaut on prend sys.stdout,</span>
        <span style="color: #808080; font-style: italic;"># donc la sortie standard.</span>
        <span style="color: #808080; font-style: italic;"># Si l'utilisateur ne souhaite rien de tout cela, il peut également</span>
        <span style="color: #808080; font-style: italic;"># retirer 'self.print_progress' de la liste des callbacks puisque</span>
        <span style="color: #808080; font-style: italic;"># l'attribut est public.</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">out</span> = output
&nbsp;
        <span style="color: #808080; font-style: italic;"># Comme on utilise la sortie standard par défaut, la barre peut</span>
        <span style="color: #808080; font-style: italic;"># facilement être cassée par un autre code écrivant aussi sur la sortie</span>
        <span style="color: #808080; font-style: italic;"># standard. Puisqu'un débutant ne comprendra pas rour se suite ce qui se</span>
        <span style="color: #808080; font-style: italic;"># passe, par défaut on va intercepter stdout et mettre tout ce qui est</span>
        <span style="color: #808080; font-style: italic;"># écrit dessus dans un buffer. Si jamais il y a des prints fait durant</span>
        <span style="color: #808080; font-style: italic;"># l'affichage, il seront cachés, et stockés. Ce comportement n'est pas</span>
        <span style="color: #808080; font-style: italic;"># forcément désirable, et peut donc être désactivé par un paramètre pour</span>
        <span style="color: #808080; font-style: italic;"># l'utilisateur qui sait ce qu'il fait notamment dans le cadre</span>
        <span style="color: #808080; font-style: italic;"># d'utilisation des threads.</span>
        <span style="color: #008000;">self</span>._intercept_stdout = intercept_stdout <span style="color: #ff7700;font-weight:bold;">and</span> <span style="color: #008000;">self</span>.<span style="color: black;">out</span> == <span style="color: #dc143c;">sys</span>.<span style="color: black;">stdout</span>
        <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #008000;">self</span>._intercept_stdout:
            <span style="color: #808080; font-style: italic;"># L'interception de la sortie standard se fait en remplaçant</span>
            <span style="color: #808080; font-style: italic;"># sys.stdout par soi-même. C'est pour cette raison que ProgressBar</span>
            <span style="color: #808080; font-style: italic;"># hérite de IOBase. En effet, de cette manière, on possède</span>
            <span style="color: #808080; font-style: italic;"># l'interface d'un objet stream et tout écriture sur 'self' semblera</span>
            <span style="color: #808080; font-style: italic;"># fonctionner comme sur sys.stdout. Cela permet de faire des prints</span>
            <span style="color: #808080; font-style: italic;"># ou de lancer un shell et d'utiliser la barre, bien que</span>
            <span style="color: #808080; font-style: italic;"># dans un shell cela monopolisera le prompt.</span>
            <span style="color: #dc143c;">sys</span>.<span style="color: black;">stdout</span> = <span style="color: #008000;">self</span>
&nbsp;
&nbsp;
    <span style="color: #808080; font-style: italic;"># Afficher la barre à la création de l'objet retire de la flexibilité à</span>
    <span style="color: #808080; font-style: italic;"># l'utilisateur qui peut vouloir le créer d'un côté, le stocker, et</span>
    <span style="color: #808080; font-style: italic;"># démarrer l'affichage plus tard. L'affichage est donc conditionné</span>
    <span style="color: #808080; font-style: italic;"># par cette méthode.</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> show<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        bar = <span style="color: #008000;">self</span>.<span style="color: black;">format</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">out</span>.<span style="color: black;">write</span><span style="color: black;">&#40;</span>bar<span style="color: black;">&#41;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">cursor_shift</span> = <span style="color: #008000;">len</span><span style="color: black;">&#40;</span>bar<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">self</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># Comme le plus souvent on voudra tout de même afficher la barre juste après</span>
    <span style="color: #808080; font-style: italic;"># la création, on transforme cette classe en context manager. Pour cela on</span>
    <span style="color: #808080; font-style: italic;"># créer un alias de la method show() qu'on appelle __enter__, puisque tout</span>
    <span style="color: #808080; font-style: italic;"># objet qui a une méthode nommée __enter__ peut être utilisé comme context</span>
    <span style="color: #808080; font-style: italic;"># manager. Si vous ne vous souvenez pas de ce que c'est, il y a un article</span>
    <span style="color: #808080; font-style: italic;"># sur le blog à ce sujet. Mais en résumé, ce sont les objets utilisables</span>
    <span style="color: #808080; font-style: italic;"># avec &quot;with&quot;.</span>
    <span style="color: #808080; font-style: italic;"># Notez qu'on ne fait pas __enter__ = show, ce qui serait un moyen plus</span>
    <span style="color: #808080; font-style: italic;"># court d'aliaser, car il empêcherait __enter__ d'appeler le bon show()</span>
    <span style="color: #808080; font-style: italic;"># en cas d'héritage, si show() est écrasé.</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> __enter__<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">self</span>.<span style="color: black;">show</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
&nbsp;
    <span style="color: #808080; font-style: italic;"># Une petit méthode de nettoyage, qui ici va simplement remettre sys.stdout</span>
    <span style="color: #808080; font-style: italic;"># à sa place.</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> stop<span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, <span style="color: #66cc66;">*</span>args, <span style="color: #66cc66;">**</span>kwargs<span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #008000;">self</span>._intercept_stdout:
            <span style="color: #dc143c;">sys</span>.<span style="color: black;">stdout</span> = <span style="color: #008000;">self</span>.<span style="color: black;">out</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># Même topo, on alias stop en __exit__ pour avoir la sortie du context</span>
    <span style="color: #808080; font-style: italic;"># manager. On a pas appelé directement ces méthodes __enter__ et __exit__</span>
    <span style="color: #808080; font-style: italic;"># car l'utilisateur peut vouloir les appeler manuellement.</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> __exit__<span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, <span style="color: #66cc66;">*</span>args, <span style="color: #66cc66;">**</span>kwargs<span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">self</span>.<span style="color: black;">stop</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
&nbsp;
    <span style="color: #808080; font-style: italic;"># Une simple propriété qui donne accès au progres en lecture...</span>
    @<span style="color: #008000;">property</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> progress<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">self</span>._progress
&nbsp;
&nbsp;
    <span style="color: #808080; font-style: italic;"># ... et en écriture. La différence étant qu'à l'écriture, on vérifie</span>
    <span style="color: #808080; font-style: italic;"># que la valeur est bien comprise entre 0 et le total. On appelle aussi</span>
    <span style="color: #808080; font-style: italic;"># les callbacks, et donc l'affichage se mettra à jour.</span>
    @progress.<span style="color: black;">setter</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> progress<span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, value<span style="color: black;">&#41;</span>:
&nbsp;
        <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff4500;">0</span> <span style="color: #66cc66;">&lt;</span>= value <span style="color: #66cc66;">&lt;</span>= <span style="color: #008000;">self</span>.<span style="color: black;">total</span>:
            <span style="color: #ff7700;font-weight:bold;">raise</span> <span style="color: #008000;">ValueError</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;'value' is %s and should be set between 0 &quot;</span>
                             <span style="color: #483d8b;">&quot;and 'total' (%s)&quot;</span> <span style="color: #66cc66;">%</span> <span style="color: black;">&#40;</span>value, <span style="color: #008000;">self</span>.<span style="color: black;">total</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># On le fait avant car les callbacks doivent être appelés</span>
        <span style="color: #808080; font-style: italic;"># avec un état propre.</span>
        previous_progress = <span style="color: #008000;">self</span>._progress
        <span style="color: #008000;">self</span>._progress = value
&nbsp;
        <span style="color: #808080; font-style: italic;"># Ce que l'on va passer en paramètres aux callbacks est un choix</span>
        <span style="color: #808080; font-style: italic;"># important. Déjà en premier paramètre, on passe self. Ainsi le callback</span>
        <span style="color: #808080; font-style: italic;"># aura accès à presque tout, et on est certain qu'il ne se trouvera</span>
        <span style="color: #808080; font-style: italic;"># pas dépourvu d'informations. Ensuite on passe le progrès. Normalement</span>
        <span style="color: #808080; font-style: italic;"># il peut le récupérer à travers self.progress, mais comme on sait</span>
        <span style="color: #808080; font-style: italic;"># que c'est une information très utilisée, on la passe par politesse,</span>
        <span style="color: #808080; font-style: italic;"># pour faciliter la vie de l'utilisateur. Enfin, une information qu'il</span>
        <span style="color: #808080; font-style: italic;"># ne pourrait pas avoir autrement est le progrès précédent. Bien que</span>
        <span style="color: #808080; font-style: italic;"># nous ne l'utilisons pas dans notre callback, on peut imaginer que</span>
        <span style="color: #808080; font-style: italic;"># c'est le genre d'info qui peut être utile, et qui ne peut être trouvée</span>
        <span style="color: #808080; font-style: italic;"># dans self.</span>
        <span style="color: #ff7700;font-weight:bold;">for</span> callback <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">self</span>.<span style="color: black;">callbacks</span>:
            callback<span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, <span style="color: #008000;">self</span>._progress, previous_progress<span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># Si on arrive au bout, on appelle stop() automatiquement. Stop()</span>
        <span style="color: #808080; font-style: italic;"># étant idempotente, ce n'est pas grave si elle est appelée plusieurs</span>
        <span style="color: #808080; font-style: italic;"># fois.</span>
        <span style="color: #ff7700;font-weight:bold;">if</span> value == <span style="color: #008000;">self</span>.<span style="color: black;">total</span>:
            <span style="color: #008000;">self</span>.<span style="color: black;">stop</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># Un cas intéressant : pourquoi on ne fait pas self.template directement au</span>
    <span style="color: #808080; font-style: italic;"># lieu de créer une property à vide ? Tout simplement parce qu'un template</span>
    <span style="color: #808080; font-style: italic;"># est typiquement quelque chose que quelqu'un peut vouloir créer</span>
    <span style="color: #808080; font-style: italic;"># dynamiquement (par exemple pour y ajouter une notion de temps qui passe).</span>
    <span style="color: #808080; font-style: italic;"># Donc, on propose de passer le template en paramètre  dans __init__ car la</span>
    <span style="color: #808080; font-style: italic;"># plupart du temps, c'est juste ce qu'on voudra faire : un simple changement</span>
    <span style="color: #808080; font-style: italic;"># cosmétique statique. Mais afin de permettre plus d'extensibilité, on en</span>
    <span style="color: #808080; font-style: italic;"># fait une propriété, qui, comme toute méthode, peut être écrasée avec de</span>
    <span style="color: #808080; font-style: italic;"># l'héritage et permettrait à l'utilisateur de vraiment personnaliser son</span>
    <span style="color: #808080; font-style: italic;"># affichage de manière poussée.</span>
    @<span style="color: #008000;">property</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> template<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">self</span>._template
&nbsp;
    @template.<span style="color: black;">setter</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> template<span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, value<span style="color: black;">&#41;</span>:
        <span style="color: #008000;">self</span>._template = value
&nbsp;
    <span style="color: #808080; font-style: italic;"># C'est cette méthode qui est appelée si on a détourné sys.stdout quand</span>
    <span style="color: #808080; font-style: italic;"># l'utilisateur va faire un print. Elle doit s'appeler write(), car c'est</span>
    <span style="color: #808080; font-style: italic;"># l'interface connue des objets stream. Grosso modo, on va juste</span>
    <span style="color: #808080; font-style: italic;"># tout stocker dans une variable plutôt que d'afficher quoique ce soit</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> write<span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, value<span style="color: black;">&#41;</span>:
        <span style="color: #008000;">self</span>.<span style="color: black;">buffer</span> += value
&nbsp;
    <span style="color: #808080; font-style: italic;"># Pour une progrès donné, retourne la barre de progrès sous forme de</span>
    <span style="color: #808080; font-style: italic;"># string ASCII. Elle est mise à part car elle peut ainsi être facilement</span>
    <span style="color: #808080; font-style: italic;"># utilisée dans un callback.</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> format<span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, progress=<span style="color: #ff4500;">0</span><span style="color: black;">&#41;</span>:
        progress = progress <span style="color: #66cc66;">*</span> <span style="color: #ff4500;">100</span> / <span style="color: #008000;">self</span>.<span style="color: black;">total</span>
        bar = progress / <span style="color: #008000;">self</span>.<span style="color: black;">percent_per_sign</span> <span style="color: #66cc66;">*</span> <span style="color: #008000;">self</span>.<span style="color: black;">progress_sign</span>
        bar += <span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">bar_len</span> - <span style="color: #008000;">len</span><span style="color: black;">&#40;</span>bar<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: #66cc66;">*</span> <span style="color: #483d8b;">' '</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">self</span>.<span style="color: black;">template</span>.<span style="color: black;">format</span><span style="color: black;">&#40;</span>bar=bar, progress=progress<span style="color: black;">&#41;</span>
&nbsp;
&nbsp;
    <span style="color: #808080; font-style: italic;"># Notre callback que l'on utilise pour afficher la barre. C'est une méthode</span>
    <span style="color: #808080; font-style: italic;"># statique car cela nous permet de nous mettre dans les conditions exacte</span>
    <span style="color: #808080; font-style: italic;"># d'un callback d'un utilisateur, qui ne sera qu'une fonction, sans self.</span>
    @<span style="color: #008000;">staticmethod</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> print_progress<span style="color: black;">&#40;</span>progress_bar, progress, previous_progress<span style="color: black;">&#41;</span>:
        <span style="color: #808080; font-style: italic;"># '\b' permet de reculer le curseur dans le terminal, ce qui va</span>
        <span style="color: #808080; font-style: italic;"># nous permettre de réécrire par dessus l'ancienne bar, et la mettre</span>
        <span style="color: #808080; font-style: italic;"># à jour. Si vous tenez à faire un display multi ligne, sachez que '\b'</span>
        <span style="color: #808080; font-style: italic;"># ne permet pas de reculer sur un saut de ligne, pour ça il faut</span>
        <span style="color: #808080; font-style: italic;"># utiliser '\033[1A'</span>
        progress_bar.<span style="color: black;">out</span>.<span style="color: black;">write</span><span style="color: black;">&#40;</span>progress_bar.<span style="color: black;">cursor_shift</span> <span style="color: #66cc66;">*</span> <span style="color: #483d8b;">'<span style="color: #000099; font-weight: bold;">\b</span>'</span><span style="color: black;">&#41;</span>
        bar = progress_bar.<span style="color: black;">format</span><span style="color: black;">&#40;</span>progress<span style="color: black;">&#41;</span>
        progress_bar.<span style="color: black;">out</span>.<span style="color: black;">write</span><span style="color: black;">&#40;</span>bar<span style="color: black;">&#41;</span>
        <span style="color: #808080; font-style: italic;"># flush est nécessaire pour vider le buffer et obtenir un affichage</span>
        <span style="color: #808080; font-style: italic;"># immédiat quand on écrit en direct sur un stream.</span>
        progress_bar.<span style="color: black;">out</span>.<span style="color: black;">flush</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
        <span style="color: #808080; font-style: italic;"># on met à jour l'avancement du curseur, qui nous permettra de reculer</span>
        <span style="color: #808080; font-style: italic;"># d'autant au prochain print_progress()</span>
        progress_bar.<span style="color: black;">cursor_shift</span> = <span style="color: #008000;">len</span><span style="color: black;">&#40;</span>bar<span style="color: black;">&#41;</span>
&nbsp;
&nbsp;
&nbsp;
<span style="color: #ff7700;font-weight:bold;">if</span> __name__ == <span style="color: #483d8b;">&quot;__main__&quot;</span>:
&nbsp;
    <span style="color: #808080; font-style: italic;"># voici une utilisation standard de la barre :</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">time</span>
&nbsp;
    total = <span style="color: #ff4500;">1000</span>
    <span style="color: #808080; font-style: italic;"># L'utilisation du context manager permet de ne pas se soucier d'appeler</span>
    <span style="color: #808080; font-style: italic;"># show() ou stop() et autre détails d'implémentation.</span>
    <span style="color: #808080; font-style: italic;"># On note aussi qu'avoir des valeurs par défaut pour l'initialisation de la</span>
    <span style="color: #808080; font-style: italic;"># barre la rend très facile à utiliser sans trop se prendre la tête, et</span>
    <span style="color: #808080; font-style: italic;"># ce malgré un code derrière assez complexe. On aurait même pu se passer</span>
    <span style="color: #808080; font-style: italic;"># de &quot;total&quot;.</span>
    <span style="color: #ff7700;font-weight:bold;">with</span> ProgressBar<span style="color: black;">&#40;</span>total<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">as</span> pb:
&nbsp;
        <span style="color: #ff7700;font-weight:bold;">for</span> i <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">range</span><span style="color: black;">&#40;</span>total<span style="color: black;">&#41;</span>:
            <span style="color: #dc143c;">time</span>.<span style="color: black;">sleep</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">0.001</span><span style="color: black;">&#41;</span>
            <span style="color: #808080; font-style: italic;"># on voir l'interêt d'utiliser une property ici, ça rend la mise</span>
            <span style="color: #808080; font-style: italic;"># à jour du progrès très simple</span>
            pb.<span style="color: black;">progress</span> = i
            <span style="color: #ff7700;font-weight:bold;">if</span> i == total / <span style="color: #ff4500;">2</span>:
                <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;<span style="color: #000099; font-weight: bold;">\n</span>Half the work already !&quot;</span><span style="color: black;">&#41;</span>
                half = <span style="color: #008000;">True</span>
            <span style="color: #ff7700;font-weight:bold;">if</span> i == total <span style="color: #66cc66;">*</span> <span style="color: #ff4500;">0.7</span>:
                <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Almost done&quot;</span><span style="color: black;">&#41;</span>
                almost = <span style="color: #008000;">True</span>
&nbsp;
        pb.<span style="color: black;">progress</span> = total
&nbsp;
    <span style="color: #808080; font-style: italic;"># On peut afficher tout ce qui a été printé durant la progression de la</span>
    <span style="color: #808080; font-style: italic;"># barre si besoin.</span>
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>pb.<span style="color: black;">buffer</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">datetime</span> <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">datetime</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># Et une utilisation custo où on compte les secondes depuis le départ</span>
    <span style="color: #808080; font-style: italic;"># et on les affiches dans le template</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">class</span> MaProgressBar<span style="color: black;">&#40;</span>ProgressBar<span style="color: black;">&#41;</span>:
&nbsp;
        <span style="color: #ff7700;font-weight:bold;">def</span> show<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
            <span style="color: #008000;">self</span>.<span style="color: black;">start</span> = <span style="color: #dc143c;">datetime</span>.<span style="color: black;">now</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
            <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">super</span><span style="color: black;">&#40;</span>MaProgressBar, <span style="color: #008000;">self</span><span style="color: black;">&#41;</span>.<span style="color: black;">show</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># Comme on a template en tant que méthode, on peut l'overrider et</span>
        <span style="color: #808080; font-style: italic;"># obtenir un comportement</span>
        @<span style="color: #008000;">property</span>
        <span style="color: #ff7700;font-weight:bold;">def</span> template<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
            seconds = <span style="color: black;">&#40;</span><span style="color: #dc143c;">datetime</span>.<span style="color: black;">now</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> - <span style="color: #008000;">self</span>.<span style="color: black;">start</span><span style="color: black;">&#41;</span>.<span style="color: black;">seconds</span>
            <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #483d8b;">'{bar} (running for %s seconds)'</span> <span style="color: #66cc66;">%</span> seconds
&nbsp;
        @template.<span style="color: black;">setter</span>
        <span style="color: #ff7700;font-weight:bold;">def</span> template<span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, value<span style="color: black;">&#41;</span>:
            <span style="color: #ff7700;font-weight:bold;">pass</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># Notre système de callback va se trouver utile :</span>
    <span style="color: #808080; font-style: italic;"># on met un callback de plus qui va écrire dans un fichier (mais</span>
    <span style="color: #808080; font-style: italic;"># il pourrait faire n'importe quoi, envoyer un post sur un site Web,</span>
    <span style="color: #808080; font-style: italic;"># un mail, formatter le disque...)</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> update_progress<span style="color: black;">&#40;</span>progress_bar, progress, previous_progress<span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">with</span> <span style="color: #008000;">open</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'/tmp/progress.log'</span>, <span style="color: #483d8b;">'w'</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">as</span> log:
            log.<span style="color: black;">write</span><span style="color: black;">&#40;</span><span style="color: #008000;">str</span><span style="color: black;">&#40;</span>progress<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># On change aussi le signe de progrès pour quelque chose de plus pro</span>
    pb = MaProgressBar<span style="color: black;">&#40;</span>progress_sign=<span style="color: #483d8b;">':-) '</span>, percent_per_sign=<span style="color: #ff4500;">10</span>,
                       callbacks=<span style="color: black;">&#40;</span>update_progress,<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># Au besoin, on peut passer à l'affichage en manuel.</span>
    pb.<span style="color: black;">show</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">for</span> i <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">range</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>:
        <span style="color: #dc143c;">time</span>.<span style="color: black;">sleep</span><span style="color: black;">&#40;</span>.1<span style="color: black;">&#41;</span>
        pb.<span style="color: black;">progress</span> = i
&nbsp;
    pb.<span style="color: black;">progress</span> = <span style="color: #ff4500;">100</span>
&nbsp;
    pb.<span style="color: black;">stop</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre></div></div>

<hr />
<p><a href="https://github.com/sametmax/codes-des-articles/blob/master/2013/aout/progress_bar.py">Télécharger le code de l&#8217;article</a></p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=7122&amp;md5=4b21a908ab2fd1d97205099c6faa2b64" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/ecrire-un-code-pour-les-autres-en-python/feed/</wfw:commentRss>
		<slash:comments>10</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fecrire-un-code-pour-les-autres-en-python%2F&amp;language=en_GB&amp;category=text&amp;title=Ecrire+un+code+pour+les+autres+en+Python&amp;description=Cet+article+s%26%238217%3Badresse+%C3%A0+des+d%C3%A9veloppeurs+qui+commencent+%C3%A0+%C3%AAtre+bien+dans+leurs+chaussettes+en+Python+et+qui+se+sentent+de+relever+le+d%C3%A9fi+d%26%238217%3B%C3%A9crire+du+code+pour+d%26%238217%3Bautres+personnes....&amp;tags=context+manager%2Cpoo%2Cproperty%2Cpython%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/08/PagndOb.gif" length="32768" type="image/jpg" />	</item>
		<item>
		<title>Sortir de plusieurs boucles for imbriquées en Python</title>
		<link>http://sametmax.com/sortir-de-plusieurs-boucles-for-imbriquees-en-python/</link>
		<comments>http://sametmax.com/sortir-de-plusieurs-boucles-for-imbriquees-en-python/#comments</comments>
		<pubDate>Tue, 01 Jan 2013 19:27:41 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[context manager]]></category>
		<category><![CDATA[for]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=3962</guid>
		<description><![CDATA[Le mot clé <code>break</code> permet de sortir d'une boucle <code>for</code> abruptement. Mais une seule. Parfois on a 3, 4 boucles imbriquées, et on aimerait tellement sortir de toutes d'un coup.

Ce que je vais vous montrer est mal. Mais c'est tellement bon.]]></description>
			<content:encoded><![CDATA[<p>Le mot clé <code>break</code> permet de sortir d&#8217;une boucle <code>for</code> abruptement. Mais une seule. Parfois on a 3, 4 boucles imbriquées, et on aimerait tellement sortir de toutes d&#8217;un coup.</p>
<p>Ce que je vais vous montrer est mal. Mais c&#8217;est tellement bon.</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #808080; font-style: italic;"># on fait une exception qui hérite de StopIteration car c'est ce qui est utilisé</span>
<span style="color: #808080; font-style: italic;"># de toute façon pour arrêter une boucle</span>
<span style="color: #ff7700;font-weight:bold;">class</span> MultiStopIteration<span style="color: black;">&#40;</span><span style="color: #008000;">StopIteration</span><span style="color: black;">&#41;</span>:
    <span style="color: #808080; font-style: italic;"># la classe est capable de se lever elle même comme exception</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> throw<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">raise</span> <span style="color: #008000;">self</span>
&nbsp;
&nbsp;
@contextmanager
<span style="color: #ff7700;font-weight:bold;">def</span> multibreak<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    <span style="color: #808080; font-style: italic;"># le seul boulot de notre context manager c'est de donne le moyen de lever</span>
    <span style="color: #808080; font-style: italic;"># l'exception tout en l'attrapant</span>
    <span style="color: #ff7700;font-weight:bold;">try</span>:
        <span style="color: #ff7700;font-weight:bold;">yield</span> MultiStopIteration<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>.<span style="color: black;">throw</span>
    <span style="color: #ff7700;font-weight:bold;">except</span> MultiStopIteration:
        <span style="color: #ff7700;font-weight:bold;">pass</span></pre></div></div>

<p>En gros on se créé un petit <a href="http://sametmax.com/les-context-managers-et-le-mot-cle-with-en-python/">context manager</a>, dont le seul but est de créer une exception qui va remonter en pêtant toutes les boucles. Je vous avais dit que c&#8217;était mal</p>
<p>Ca s&#8217;utilise comme ça:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">with</span> multibreak<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">as</span> stop:
...     <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">range</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">4</span><span style="color: black;">&#41;</span>:
...         <span style="color: #ff7700;font-weight:bold;">for</span> z <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">range</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">4</span><span style="color: black;">&#41;</span>:
...             <span style="color: #ff7700;font-weight:bold;">for</span> w <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">range</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">4</span><span style="color: black;">&#41;</span>:
...                 <span style="color: #ff7700;font-weight:bold;">print</span> w
...                 <span style="color: #ff7700;font-weight:bold;">if</span> x <span style="color: #66cc66;">*</span> z <span style="color: #66cc66;">*</span> w == <span style="color: #ff4500;">2</span> <span style="color: #66cc66;">*</span> <span style="color: #ff4500;">2</span> <span style="color: #66cc66;">*</span> <span style="color: #ff4500;">2</span>:
...                     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">'stop'</span>
...                     <span style="color: black;">stop</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># appel MultiStopIteration().throw()</span>
...
<span style="color: #ff4500;">1</span>
<span style="color: #ff4500;">2</span>
<span style="color: #ff4500;">3</span>
<span style="color: #ff4500;">1</span>
<span style="color: #ff4500;">2</span>
<span style="color: #ff4500;">3</span>
<span style="color: #ff4500;">1</span>
<span style="color: #ff4500;">2</span>
<span style="color: #ff4500;">3</span>
<span style="color: #ff4500;">1</span>
<span style="color: #ff4500;">2</span>
<span style="color: #ff4500;">3</span>
<span style="color: #ff4500;">1</span>
<span style="color: #ff4500;">2</span>
stop</pre></div></div>

<p>Je vous avais dit que ça serait bon.</p>
<p>A part le fait que ce n&#8217;est pas très rapide au moment du bubbling de l&#8217;exception sur 3 blocks, il n&#8217;y a aucun danger ou side-effect. On triche en fait à peine, car <a href="http://sametmax.com/dis-papa-dis-papa-dis-moi-dis-moi-comment-cest-fait-dans-une-boucle-for/">le mécanisme interne des boucles en Python utilise de toute façon déjà une exception</a> (StopIteration) pour dire à une boucle quand s&#8217;arrêter.</p>
<p>Bref, encore une victoire de connard.</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=3962&amp;md5=4be9a4b87b184344f1a94a581462e128" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/sortir-de-plusieurs-boucles-for-imbriquees-en-python/feed/</wfw:commentRss>
		<slash:comments>9</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fsortir-de-plusieurs-boucles-for-imbriquees-en-python%2F&amp;language=en_GB&amp;category=text&amp;title=Sortir+de+plusieurs+boucles+for+imbriqu%C3%A9es+en+Python&amp;description=Le+mot+cl%C3%A9+break+permet+de+sortir+d%26%238217%3Bune+boucle+for+abruptement.+Mais+une+seule.+Parfois+on+a+3%2C+4+boucles+imbriqu%C3%A9es%2C+et+on+aimerait+tellement+sortir+de+toutes+d%26%238217%3Bun+coup....&amp;tags=context+manager%2Cfor%2Cpython%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2012/12/2320485189_1.jpg" length="68692" type="image/jpg" />	</item>
		<item>
		<title>Quelques innovation de Python 3 backportées en Python 2.7</title>
		<link>http://sametmax.com/quelques-innovation-de-python-3-backportees-en-python-2-7/</link>
		<comments>http://sametmax.com/quelques-innovation-de-python-3-backportees-en-python-2-7/#comments</comments>
		<pubDate>Mon, 05 Nov 2012 11:36:42 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[context manager]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[sets]]></category>
		<category><![CDATA[strings]]></category>
		<category><![CDATA[unit tests]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=2863</guid>
		<description><![CDATA[Comme nous l'avons vu avec les vues ou les collections, Python 2.7 vient avec pas mal de bonus issus directement de la branche 3. En voici quelques autres. Tout ceci n'est bien sûr ni nouveau ni exhaustif, mais je m’aperçois que peu de personnes le savent.]]></description>
			<content:encoded><![CDATA[<p>Comme nous l&#8217;avons vu avec les <a href="http://sametmax.com/les-vues-sur-des-collections-en-python/">vues</a> ou les <a href="http://sametmax.com/ce-que-vous-ne-saviez-pas-sur-les-collections-en-python/">collections</a>, Python 2.7 vient avec pas mal de bonus issus directement de la branche 3. En voici quelques autres. Tout ceci n&#8217;est bien sûr ni nouveau ni exhaustif, mais je m’aperçois que peu de personnes le savent.</p>
<p>Une notation littérale pour les sets:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: black;">&#123;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span><span style="color: black;">&#125;</span> == <span style="color: #008000;">set</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #008000;">True</span></pre></div></div>

<p>Une syntaxe pour les dictionnaires en intention:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> d = <span style="color: black;">&#123;</span><span style="color: #008000;">chr</span><span style="color: black;">&#40;</span>x<span style="color: black;">&#41;</span>: x <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">range</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">65</span>, <span style="color: #ff4500;">91</span><span style="color: black;">&#41;</span><span style="color: black;">&#125;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> d
<span style="color: black;">&#123;</span><span style="color: #483d8b;">'A'</span>: <span style="color: #ff4500;">65</span>, <span style="color: #483d8b;">'C'</span>: <span style="color: #ff4500;">67</span>, <span style="color: #483d8b;">'B'</span>: <span style="color: #ff4500;">66</span>, <span style="color: #483d8b;">'E'</span>: <span style="color: #ff4500;">69</span>, <span style="color: #483d8b;">'D'</span>: <span style="color: #ff4500;">68</span>, <span style="color: #483d8b;">'G'</span>: <span style="color: #ff4500;">71</span>, <span style="color: #483d8b;">'F'</span>: <span style="color: #ff4500;">70</span>, <span style="color: #483d8b;">'I'</span>: <span style="color: #ff4500;">73</span>, <span style="color: #483d8b;">'H'</span>: <span style="color: #ff4500;">72</span>, <span style="color: #483d8b;">'K'</span>: <span style="color: #ff4500;">75</span>, <span style="color: #483d8b;">'J'</span>: <span style="color: #ff4500;">74</span>, <span style="color: #483d8b;">'M'</span>: <span style="color: #ff4500;">77</span>, <span style="color: #483d8b;">'L'</span>: <span style="color: #ff4500;">76</span>, <span style="color: #483d8b;">'O'</span>: <span style="color: #ff4500;">79</span>, <span style="color: #483d8b;">'N'</span>: <span style="color: #ff4500;">78</span>, <span style="color: #483d8b;">'Q'</span>: <span style="color: #ff4500;">81</span>, <span style="color: #483d8b;">'P'</span>: <span style="color: #ff4500;">80</span>, <span style="color: #483d8b;">'S'</span>: <span style="color: #ff4500;">83</span>, <span style="color: #483d8b;">'R'</span>: <span style="color: #ff4500;">82</span>, <span style="color: #483d8b;">'U'</span>: <span style="color: #ff4500;">85</span>, <span style="color: #483d8b;">'T'</span>: <span style="color: #ff4500;">84</span>, <span style="color: #483d8b;">'W'</span>: <span style="color: #ff4500;">87</span>, <span style="color: #483d8b;">'V'</span>: <span style="color: #ff4500;">86</span>, <span style="color: #483d8b;">'Y'</span>: <span style="color: #ff4500;">89</span>, <span style="color: #483d8b;">'X'</span>: <span style="color: #ff4500;">88</span>, <span style="color: #483d8b;">'Z'</span>: <span style="color: #ff4500;">90</span><span style="color: black;">&#125;</span></pre></div></div>

<p>Imbriquer <code>with</code>:</p>
<p>Avant il fallait utiliser <a href="http://docs.python.org/2/library/contextlib.html#contextlib.nested">nested()</a> ou imbriquer à la main</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">with</span> <span style="color: #008000;">open</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'fichiera'</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">as</span> a:
    <span style="color: #ff7700;font-weight:bold;">with</span> <span style="color: #008000;">open</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'fichiera'</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">as</span> b:
        <span style="color: #808080; font-style: italic;"># faire un truc</span></pre></div></div>

<p>Maintenant on peut faire:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">with</span> <span style="color: #008000;">open</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'fichiera'</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">as</span> a, <span style="color: #008000;">open</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'fichiera'</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">as</span> b:
    <span style="color: #808080; font-style: italic;"># faire un truc</span></pre></div></div>

<p>Rien à voir, mais toujours sympa. <code>timedelta</code> a maintenant une méthode <code>total_seconds()</code> qui retourne la valeur de la durée en seconde. En effet, l&#8217;attribut <code>seconds</code> ne retourne que ce qui reste en seconde une fois qu&#8217;on a retiré les jours:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">datetime</span> <span style="color: #ff7700;font-weight:bold;">import</span> timedelta
<span style="color: #66cc66;">&gt;&gt;&gt;</span> delta = timedelta<span style="color: black;">&#40;</span>days=<span style="color: #ff4500;">1</span>, seconds=<span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> delta.<span style="color: black;">seconds</span>
<span style="color: #ff4500;">1</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> delta.<span style="color: black;">total_seconds</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #ff4500;">86401.0</span></pre></div></div>

<p>Notez qu&#8217;il n&#8217;y a toujours ni attribut minutes, ni heures.</p>
<p>Le module <code>unittest</code> gagne une pléthore d&#8217;améliorations, et notamment:</p>
<p>L&#8217;utilisation de <code>assertRaises</code> comme context manager:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">with</span> <span style="color: #008000;">self</span>.<span style="color: black;">assertRaises</span><span style="color: black;">&#40;</span><span style="color: #008000;">KeyError</span><span style="color: black;">&#41;</span>:
    <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span><span style="color: black;">&#91;</span><span style="color: #483d8b;">'foo'</span><span style="color: black;">&#93;</span></pre></div></div>

<p>Et un bon gros nombres de méthodes:</p>
<p><code>assertIsNone()</code> / <code>assertIsNotNone()</code>, <code>assertIs()</code> / <code>assertIsNot()</code>, <code>assertIsInstance()</code> / <code>assertNotIsInstance()</code>, <code>assertGreater()</code> / <code>assertGreaterEqual()</code> / <code>assertLess()</code> / <code>assertLessEqual()</code>, <code>assertRegexpMatches()</code> / <code>assertNotRegexpMatches()</code>, <code>assertRaisesRegexp()</code>,<br />
<code>assertIn()</code> / <code>assertNotIn()</code>, <code>assertDictContainsSubset()</code>, <code>assertAlmostEqual()</code> / <code>assertNotAlmostEqual()</code>.</p>
<p>Enfin <code>format()</code> commence à devenir une alternative valable à <code>%</code> car il propose maintenant des marqueurs sans noter d’index:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #483d8b;">&quot;{}, puis {} et finalement {}&quot;</span>.<span style="color: black;">format</span><span style="color: black;">&#40;</span><span style="color: #66cc66;">*</span><span style="color: #008000;">range</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: #483d8b;">'0, puis 1 et finalement 2'</span></pre></div></div>

<p>Et il ajoute le séparateur des milliers au mini-langage de formatage, mais pour la virgule uniquement. Par exemple, si avoir un nombre de 15 caractères minimum formater en tant que float, avec deux chiffres après la virgules, et donc les milliers sont groupés à l&#8217;américaine:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #483d8b;">'{:15,.2f}'</span>.<span style="color: black;">format</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">54321</span><span style="color: black;">&#41;</span>
<span style="color: #483d8b;">'      54,321.00'</span></pre></div></div>

 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=2863&amp;md5=b9a5b349b7a2b23d40ef8cb66307cc73" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/quelques-innovation-de-python-3-backportees-en-python-2-7/feed/</wfw:commentRss>
		<slash:comments>4</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fquelques-innovation-de-python-3-backportees-en-python-2-7%2F&amp;language=en_GB&amp;category=text&amp;title=Quelques+innovation+de+Python+3+backport%C3%A9es+en+Python+2.7&amp;description=Comme+nous+l%26%238217%3Bavons+vu+avec+les+vues+ou+les+collections%2C+Python+2.7+vient+avec+pas+mal+de+bonus+issus+directement+de+la+branche+3.+En+voici+quelques+autres.+Tout+ceci...&amp;tags=context+manager%2Cpython%2Csets%2Cstrings%2Cunit+tests%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2012/11/Pimp-My-Ride-43797.jpg" length="291183" type="image/jpg" />	</item>
		<item>
		<title>Capturer l&#8217;affichage des prints d&#8217;un code Python</title>
		<link>http://sametmax.com/capturer-laffichage-des-prints-dun-code-python/</link>
		<comments>http://sametmax.com/capturer-laffichage-des-prints-dun-code-python/#comments</comments>
		<pubDate>Sat, 29 Sep 2012 14:03:36 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[context manager]]></category>
		<category><![CDATA[hack]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[with]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=2343</guid>
		<description><![CDATA[Hier j’ai eu rencontré le travail d’une de ces fameuses personnes qui pensent que la réutilisabilité c’est pour les pédés, et qui font des scripts dont la moitié des infos renvoyées sont printées au milieu de blocs de code de 50 lignes, sans possibilité de les récupérer.]]></description>
			<content:encoded><![CDATA[<p>Hier j&#8217;ai eu rencontré le travail d&#8217;une de ces fameuses personnes qui pensent que la ré-utilisabilité c&#8217;est pour les pédés, et qui font des scripts dont la moitié des infos renvoyées sont printées au milieu de blocs de code de 50 lignes, sans possibilité de les récupérer.</p>
<p>Heureusement, avec un petit hack, on peut capturer ce qu&#8217;affiche un autre code, et sauver le bébé, l&#8217;eau du bain, et même le canard en plastique.</p>
<h2>Le code pour les gens pressés</h2>
<p>J&#8217;ai enrobé l&#8217;astuce dans un <a href="http://sametmax.com/les-context-managers-et-le-mot-cle-with-en-python/">context manager</a>, ça rend l&#8217;utilisation plus simple.</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">sys</span>
<span style="color: #ff7700;font-weight:bold;">from</span> io <span style="color: #ff7700;font-weight:bold;">import</span> BytesIO
<span style="color: #ff7700;font-weight:bold;">from</span> contextlib <span style="color: #ff7700;font-weight:bold;">import</span> contextmanager
&nbsp;
@contextmanager
<span style="color: #ff7700;font-weight:bold;">def</span> capture_ouput<span style="color: black;">&#40;</span>stdout_to=<span style="color: #008000;">None</span>, stderr_to=<span style="color: #008000;">None</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">try</span>:
&nbsp;
        stdout, stderr = <span style="color: #dc143c;">sys</span>.<span style="color: black;">stdout</span>, <span style="color: #dc143c;">sys</span>.<span style="color: black;">stderr</span>
        <span style="color: #dc143c;">sys</span>.<span style="color: black;">stdout</span> = c1 = stdout_to <span style="color: #ff7700;font-weight:bold;">or</span> BytesIO<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
        <span style="color: #dc143c;">sys</span>.<span style="color: black;">stderr</span> = c2 = stderr_to <span style="color: #ff7700;font-weight:bold;">or</span> BytesIO<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">yield</span> c1, c2
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">finally</span>:
&nbsp;
        <span style="color: #dc143c;">sys</span>.<span style="color: black;">stdout</span> = stdout
        <span style="color: #dc143c;">sys</span>.<span style="color: black;">stderr</span> = stderr
&nbsp;
        <span style="color: #ff7700;font-weight:bold;">try</span>:
            c1.<span style="color: black;">flush</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
            c1.<span style="color: black;">seek</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: black;">&#40;</span><span style="color: #008000;">ValueError</span>, <span style="color: #008000;">IOError</span><span style="color: black;">&#41;</span>:
            <span style="color: #ff7700;font-weight:bold;">pass</span>
&nbsp;
        <span style="color: #ff7700;font-weight:bold;">try</span>:
            c2.<span style="color: black;">flush</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
            c2.<span style="color: black;">seek</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: black;">&#40;</span><span style="color: #008000;">ValueError</span>, <span style="color: #008000;">IOError</span><span style="color: black;">&#41;</span>:
            <span style="color: #ff7700;font-weight:bold;">pass</span></pre></div></div>

<p>Notez l&#8217;usage de <a href="http://sametmax.com/comment-utiliser-yield-et-les-generateurs-en-python/">yield</a>.</p>
<p>Et ça s&#8217;utilise comme ça:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">with</span> capture_output<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">as</span> stdout, stderr:
    fonction_qui_fait_que_printer_la_biatch<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">print</span> stdout.<span style="color: black;">read</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># on récupère le contenu des prints</span></pre></div></div>

<p>Attention, le code n&#8217;est pas thread safe, c&#8217;est fait pour hacker un code crade, pas pour devenir une institution. Mais c&#8217;est fort pratique dans notre cas précis.</p>
<h2>Comment ça marche ?</h2>
<p><code>stdin</code> (entrée standard), <code>stdout</code> (sortie standard) et <code>stderr</code> (sortie des erreurs) sont des file like objects, c&#8217;est à dire qu&#8217;ils implémentent l&#8217;interface d&#8217;un objet fichier: on peut les ouvrir, les lire, y écrire et les fermer avec des méthodes portant le même nom et acceptant les mêmes paramètres.</p>
<p>L&#8217;avantage d&#8217;avoir une interface commune, c&#8217;est qu&#8217;on peut du coup échanger un file like objet par un autre.</p>
<p>Par exemple on peut faire ceci:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">sys</span>
log = <span style="color: #008000;">open</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'/tmp/log'</span>, <span style="color: #483d8b;">'w'</span><span style="color: black;">&#41;</span>
<span style="color: #dc143c;">sys</span>.<span style="color: black;">stdout</span> = log <span style="color: #808080; font-style: italic;"># hop, on hijack la sortie standard</span>
<span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Hello&quot;</span>
log.<span style="color: black;">close</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre></div></div>

<p>Comme <code>print</code> écrit dans <code>stdout</code>, en remplaçant <code>stdout</code> par un fichier, <code>print</code> va du coup écrire dans le fichier.</p>
<p>Mais ce code est fort dangereux, car il remplace <code>stdout</code> de manière définitive. Du coup, si du code <code>print</code> après, il va écrire dans le fichier, même les libs externes, car <code>stdout</code> est le même pour tout le monde dans le process Python courant.</p>
<p>Du coup, il est de bon ton de s&#8217;assurer la restauration de <code>stdout</code> à son état d&#8217;origine:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">sys</span>
log = <span style="color: #008000;">open</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'/tmp/log'</span>, <span style="color: #483d8b;">'w'</span><span style="color: black;">&#41;</span>
bak = <span style="color: #dc143c;">sys</span>.<span style="color: black;">stdout</span> <span style="color: #808080; font-style: italic;"># on sauvegarde l'ancien stdout</span>
<span style="color: #dc143c;">sys</span>.<span style="color: black;">stdout</span> = log
<span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Hello&quot;</span>
log.<span style="color: black;">close</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #dc143c;">sys</span>.<span style="color: black;">stdout</span> = bak <span style="color: #808080; font-style: italic;"># on restore stdout</span></pre></div></div>

<p>Comme je le disais plus haut, ceci n&#8217;est évidement pas thread safe, puisqu&#8217;entre la hijacking et la restoration de <code>stdout</code>, un autre thread peut faire un <code>print</code>.</p>
<p>Dans notre context manager, on utilise <code>BytesIO()</code> et non un fichier. <code>BytesIO</code> est un file like objet qui permet de récupérer un flux de bits en mémoire. Donc on fait écrire <code>print</code> dedans, ainsi on a tout ce qu&#8217;on affiche qui se sauvegarde en mémoire.</p>
<p>Bien entendu, vous pouvez créé vos propres file like objects, par exemple un objet qui affiche à l&#8217;écran ET capture la sortie. Par exemple, pour mitiger le problème de l&#8217;absence de thread safe: 99% des libs n&#8217;ont pas besoin du vrai <code>stdout</code>, juste d&#8217;un truc qui <code>print</code>.</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">sys</span>
<span style="color: #ff7700;font-weight:bold;">from</span> io <span style="color: #ff7700;font-weight:bold;">import</span> BytesIO
&nbsp;
<span style="color: #ff7700;font-weight:bold;">class</span> PersistentStdout<span style="color: black;">&#40;</span><span style="color: #008000;">object</span><span style="color: black;">&#41;</span>:
&nbsp;
    old_stdout = <span style="color: #dc143c;">sys</span>.<span style="color: black;">stdout</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__init__</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #008000;">self</span>.<span style="color: black;">memory</span> = BytesIO<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> write<span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, s<span style="color: black;">&#41;</span>:
        <span style="color: #008000;">self</span>.<span style="color: black;">memory</span>.<span style="color: black;">write</span><span style="color: black;">&#40;</span>s<span style="color: black;">&#41;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">old_stdout</span>.<span style="color: black;">write</span><span style="color: black;">&#40;</span>s<span style="color: black;">&#41;</span>
&nbsp;
&nbsp;
old_stdout = <span style="color: #dc143c;">sys</span>.<span style="color: black;">stdout</span>
<span style="color: #dc143c;">sys</span>.<span style="color: black;">stdout</span> = PersistentStdout<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;test&quot;</span> <span style="color: #808080; font-style: italic;"># ceci est capturé et affiché</span>
&nbsp;
<span style="color: #dc143c;">sys</span>.<span style="color: black;">stdout</span>.<span style="color: black;">memory</span>.<span style="color: black;">seek</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#41;</span>
res = <span style="color: #dc143c;">sys</span>.<span style="color: black;">stdout</span>.<span style="color: black;">memory</span>.<span style="color: black;">read</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #dc143c;">sys</span>.<span style="color: black;">stdout</span> = PersistentStdout.<span style="color: black;">old_stdout</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">print</span> res <span style="color: #808080; font-style: italic;"># résultat de la capture</span></pre></div></div>

<p>Pour cette raison le code du context manager permet de passer le file like objet à utiliser en argument. On notera aussi que si on souhaite rediriger <code>stdout</code> mais pas <code>stderr</code> et <a href="https://www.youtube.com/watch?v=WousdWP-5vY">vice-versa</a>, il suffit de passer <code>sys.stdout</code> et <code>sys.stderr</code> en argument :-)</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=2343&amp;md5=57cb269baed6a97d4ab5718a26f246c6" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/capturer-laffichage-des-prints-dun-code-python/feed/</wfw:commentRss>
		<slash:comments>8</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fcapturer-laffichage-des-prints-dun-code-python%2F&amp;language=en_GB&amp;category=text&amp;title=Capturer+l%26%238217%3Baffichage+des+prints+d%26%238217%3Bun+code+Python&amp;description=Hier+j%26%238217%3Bai+eu+rencontr%C3%A9+le+travail+d%26%238217%3Bune+de+ces+fameuses+personnes+qui+pensent+que+la+r%C3%A9-utilisabilit%C3%A9+c%26%238217%3Best+pour+les+p%C3%A9d%C3%A9s%2C+et+qui+font+des+scripts+dont+la+moiti%C3%A9+des+infos...&amp;tags=context+manager%2Chack%2Cpython%2Cwith%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2012/09/belkin-f8v234eawht-apl.jpg" length="12571" type="image/jpg" />	</item>
	</channel>
</rss>
