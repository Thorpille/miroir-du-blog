<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Sam &#38; Max: Python, Django, Git et du cul &#187; wordpress</title>
	<atom:link href="http://sametmax.com/tag/wordpress/feed/" rel="self" type="application/rss+xml" />
	<link>http://sametmax.com</link>
	<description>Deux développeurs en vadrouille qui se sortent les doigts du code</description>
	<lastBuildDate>Wed, 05 Feb 2014 14:20:37 +0000</lastBuildDate>
	<language>en</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>http://wordpress.org/?v=3.3.1</generator>
	<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2F&amp;language=en_US&amp;category=text&amp;title=Sam+%26amp%3B+Max%3A+Python%2C+Django%2C+Git+et+du+cul&amp;description=Deux+d%C3%A9veloppeurs+en+vadrouille+qui+se+sortent+les+doigts+du+code&amp;tags=blog" type="text/html" />
		<item>
		<title>Initiation à Varnish &#8211; Accélerer un blog WordPress</title>
		<link>http://sametmax.com/initiation-a-varnish-accelerer-un-blog-wordpress/</link>
		<comments>http://sametmax.com/initiation-a-varnish-accelerer-un-blog-wordpress/#comments</comments>
		<pubDate>Sun, 31 Mar 2013 08:54:54 +0000</pubDate>
		<dc:creator>Max</dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[Web]]></category>
		<category><![CDATA[nginx]]></category>
		<category><![CDATA[varnish]]></category>
		<category><![CDATA[wordpress]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=4416</guid>
		<description><![CDATA[Wordpress est devenu une usine à gaz avec le temps. Naviguer sur un blog sous Wordpress peut devenir pénible lorsque ce dernier a beaucoup de contenu ou de visiteurs. Des plugins censés mettre en cache les pages existent comme WP Cache, il y a aussi une façon d'attaquer le problème autrement avec Varnish.]]></description>
			<content:encoded><![CDATA[<p><a href="https://www.varnish-cache.org/">Varnish</a> est un service qui permet de mettre en cache (sur disque ou en mémoire) certains contenus de votre site. Beaucoup de gros sites l&#8217;utilise pour sa puissance et ses options de configuration.<br />
Il est plutôt facile à installer mais ça se corse lorsqu&#8217;il faut le configurer car il peut ne rien cacher du tout, surtout avec la config par défaut.</p>
<p>Nous allons voir ici une configuration pour un site sous WordPress avec un serveur Nginx, Varnish étant placé en Front c&#8217;est à dire devant Nginx (il y a aussi le mode sandwich Nginx / Varnish / Backend).</p>
<p><img class="aligncenter size-full wp-image-4417" title="Varnish en Front" src="http://sametmax.com/wp-content/uploads/2013/02/varnish.png" alt="" width="580" height="272" /></p>
<p><strong>Installation de Varnish sous ubuntu:<br />
</strong></p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">sudo</span> <span style="color: #c20cb9; font-weight: bold;">apt-get</span> <span style="color: #c20cb9; font-weight: bold;">install</span> varnish</pre></div></div>

<p>Il y a 2 fichiers qu&#8217;il faut retenir pour Varnish, le fichier avec les règles et le fichier de config du service.<br />
<strong><br />
Configurer le service, On va faire en sorte que Varnish écoute sur le port 80:</strong></p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">vi</span> <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>default<span style="color: #000000; font-weight: bold;">/</span>varnish</pre></div></div>


<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #007800;">DAEMON_OPTS</span>=<span style="color: #ff0000;">&quot;-a :80 <span style="color: #000099; font-weight: bold;">\
</span>             -T localhost:6082 <span style="color: #000099; font-weight: bold;">\
</span>             -f /etc/varnish/default.vcl <span style="color: #000099; font-weight: bold;">\
</span>             -S /etc/varnish/secret <span style="color: #000099; font-weight: bold;">\
</span>             -s malloc,256m&quot;</span></pre></div></div>

<p>Trouvez cette ligne dans le fichier de conf et mettez 80 pour l&#8217;option -a.<br />
<em>malloc</em> va sauver le cache en mémoire à hauteur de 256 MB, on peut sauvegarder sur disque si on a un SSD (ex: -s file,/var/lib/varnish/varnish_storage.bin,1G&#8221;).</p>
<p><strong>Configurer les règles de cache:</strong></p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">vi</span> <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>varnish<span style="color: #000000; font-weight: bold;">/</span>default.vcl</pre></div></div>


<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #666666; font-style: italic;">#</span>
<span style="color: #666666; font-style: italic;"># Varnish 3 configuration for Wordpress</span>
<span style="color: #666666; font-style: italic;">#</span>
<span style="color: #666666; font-style: italic;"># On Debian OS:  /etc/varnish/default.vcl</span>
<span style="color: #666666; font-style: italic;">#</span>
<span style="color: #666666; font-style: italic;"># Nicolas Hennion (aka) Nicolargo</span>
<span style="color: #666666; font-style: italic;">#</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># Set the default backend (Nginx server for me)</span>
backend default <span style="color: #7a0874; font-weight: bold;">&#123;</span>
	<span style="color: #666666; font-style: italic;"># My Nginx server listen on IP address 127.0.0.1 and TCP port 8080</span>
	.host = <span style="color: #ff0000;">&quot;127.0.0.1&quot;</span>;
	.port = <span style="color: #ff0000;">&quot;8080&quot;</span>;
	<span style="color: #666666; font-style: italic;"># Increase guru timeout</span>
	<span style="color: #666666; font-style: italic;"># http://vincentfretin.ecreall.com/articles/varnish-guru-meditation-on-timeout</span>
	.first_byte_timeout = 300s;
<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># This function is used when a request is send by a HTTP client (Browser) </span>
sub vcl_recv <span style="color: #7a0874; font-weight: bold;">&#123;</span>
	<span style="color: #666666; font-style: italic;"># Block the forbidden IP addresse</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>client.ip ~ forbidden<span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
        	error <span style="color: #000000;">403</span> <span style="color: #ff0000;">&quot;Forbidden&quot;</span>;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># Only cache the following sites</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.host ~ <span style="color: #ff0000;">&quot;(sametmax.com)&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span> 
		<span style="color: #000000; font-weight: bold;">set</span> req.backend = default; 
	<span style="color: #7a0874; font-weight: bold;">&#125;</span> <span style="color: #000000; font-weight: bold;">else</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span> 
		<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>pass<span style="color: #7a0874; font-weight: bold;">&#41;</span>; 
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># Normalize the header, remove the port (in case you're testing this on various TCP ports)</span>
	<span style="color: #000000; font-weight: bold;">set</span> req.http.Host = regsub<span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Host, <span style="color: #ff0000;">&quot;:[0-9]+&quot;</span>, <span style="color: #ff0000;">&quot;&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>;
&nbsp;
	<span style="color: #666666; font-style: italic;"># Post requests will not be cached</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Authorization <span style="color: #000000; font-weight: bold;">||</span> req.request == <span style="color: #ff0000;">&quot;POST&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>pass<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># --- Wordpress specific configuration</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># Did not cache the RSS feed</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.url ~ <span style="color: #ff0000;">&quot;/feed&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>pass<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># Blitz hack</span>
        <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.url ~ <span style="color: #ff0000;">&quot;/mu-.*&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
                <span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>pass<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
        <span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
&nbsp;
	<span style="color: #666666; font-style: italic;"># Did not cache the admin and login pages</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.url ~ <span style="color: #ff0000;">&quot;/wp-(login|admin)&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>pass<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># Remove the &quot;has_js&quot; cookie</span>
	<span style="color: #000000; font-weight: bold;">set</span> req.http.Cookie = regsuball<span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Cookie, <span style="color: #ff0000;">&quot;has_js=[^;]+(; )?&quot;</span>, <span style="color: #ff0000;">&quot;&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>;
&nbsp;
	<span style="color: #666666; font-style: italic;"># Remove any Google Analytics based cookies</span>
	<span style="color: #000000; font-weight: bold;">set</span> req.http.Cookie = regsuball<span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Cookie, <span style="color: #ff0000;">&quot;__utm.=[^;]+(; )?&quot;</span>, <span style="color: #ff0000;">&quot;&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>;
&nbsp;
	<span style="color: #666666; font-style: italic;"># Remove the Quant Capital cookies (added by some plugin, all __qca)</span>
	<span style="color: #000000; font-weight: bold;">set</span> req.http.Cookie = regsuball<span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Cookie, <span style="color: #ff0000;">&quot;__qc.=[^;]+(; )?&quot;</span>, <span style="color: #ff0000;">&quot;&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>;
&nbsp;
	<span style="color: #666666; font-style: italic;"># Remove the wp-settings-1 cookie</span>
	<span style="color: #000000; font-weight: bold;">set</span> req.http.Cookie = regsuball<span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Cookie, <span style="color: #ff0000;">&quot;wp-settings-1=[^;]+(; )?&quot;</span>, <span style="color: #ff0000;">&quot;&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>;
&nbsp;
	<span style="color: #666666; font-style: italic;"># Remove the wp-settings-time-1 cookie</span>
	<span style="color: #000000; font-weight: bold;">set</span> req.http.Cookie = regsuball<span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Cookie, <span style="color: #ff0000;">&quot;wp-settings-time-1=[^;]+(; )?&quot;</span>, <span style="color: #ff0000;">&quot;&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>;
&nbsp;
	<span style="color: #666666; font-style: italic;"># Remove the wp test cookie</span>
	<span style="color: #000000; font-weight: bold;">set</span> req.http.Cookie = regsuball<span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Cookie, <span style="color: #ff0000;">&quot;wordpress_test_cookie=[^;]+(; )?&quot;</span>, <span style="color: #ff0000;">&quot;&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>;
&nbsp;
	<span style="color: #666666; font-style: italic;"># Are there cookies left with only spaces or that are empty?</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.cookie ~ <span style="color: #ff0000;">&quot;^ *$&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		    <span style="color: #7a0874; font-weight: bold;">unset</span> req.http.cookie;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># Cache the following files extensions </span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.url ~ <span style="color: #ff0000;">&quot;\.(css|js|png|gif|jp(e)?g|swf|ico)&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		<span style="color: #7a0874; font-weight: bold;">unset</span> req.http.cookie;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># Normalize Accept-Encoding header and compression</span>
	<span style="color: #666666; font-style: italic;"># https://www.varnish-cache.org/docs/3.0/tutorial/vary.html</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Accept-Encoding<span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		<span style="color: #666666; font-style: italic;"># Do no compress compressed files...</span>
		<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.url ~ <span style="color: #ff0000;">&quot;\.(jpg|png|gif|gz|tgz|bz2|tbz|mp3|ogg)$&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
			   	remove req.http.Accept-Encoding;
		<span style="color: #7a0874; font-weight: bold;">&#125;</span> elsif <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Accept-Encoding ~ <span style="color: #ff0000;">&quot;gzip&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		    	<span style="color: #000000; font-weight: bold;">set</span> req.http.Accept-Encoding = <span style="color: #ff0000;">&quot;gzip&quot;</span>;
		<span style="color: #7a0874; font-weight: bold;">&#125;</span> elsif <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Accept-Encoding ~ <span style="color: #ff0000;">&quot;deflate&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		    	<span style="color: #000000; font-weight: bold;">set</span> req.http.Accept-Encoding = <span style="color: #ff0000;">&quot;deflate&quot;</span>;
		<span style="color: #7a0874; font-weight: bold;">&#125;</span> <span style="color: #000000; font-weight: bold;">else</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
			remove req.http.Accept-Encoding;
		<span style="color: #7a0874; font-weight: bold;">&#125;</span>
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># Check the cookies for wordpress-specific items</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Cookie ~ <span style="color: #ff0000;">&quot;wordpress_&quot;</span> <span style="color: #000000; font-weight: bold;">||</span> req.http.Cookie ~ <span style="color: #ff0000;">&quot;comment_&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>pass<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #000000; font-weight: bold;">!</span>req.http.cookie<span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		<span style="color: #7a0874; font-weight: bold;">unset</span> req.http.cookie;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># --- End of Wordpress specific configuration</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># Did not cache HTTP authentication and HTTP Cookie</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Authorization <span style="color: #000000; font-weight: bold;">||</span> req.http.Cookie<span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		<span style="color: #666666; font-style: italic;"># Not cacheable by default</span>
		<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>pass<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># Define the default grace period to serve cached content</span>
	<span style="color: #000000; font-weight: bold;">set</span> req.grace = 30s;
&nbsp;
	<span style="color: #666666; font-style: italic;"># Cache all others requests</span>
	<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>lookup<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
sub vcl_pipe <span style="color: #7a0874; font-weight: bold;">&#123;</span>
	<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>pipe<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
sub vcl_pass <span style="color: #7a0874; font-weight: bold;">&#123;</span>
	<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>pass<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># The data on which the hashing will take place</span>
sub vcl_hash <span style="color: #7a0874; font-weight: bold;">&#123;</span>
 	hash_data<span style="color: #7a0874; font-weight: bold;">&#40;</span>req.url<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
 	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.host<span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
     	hash_data<span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.host<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
 	<span style="color: #7a0874; font-weight: bold;">&#125;</span> <span style="color: #000000; font-weight: bold;">else</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
     	hash_data<span style="color: #7a0874; font-weight: bold;">&#40;</span>server.ip<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
 	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># If the client supports compression, keep that in a different cache</span>
    	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Accept-Encoding<span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
        	hash_data<span style="color: #7a0874; font-weight: bold;">&#40;</span>req.http.Accept-Encoding<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #7a0874; font-weight: bold;">hash</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>;
<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># This function is used when a request is sent by our backend (Nginx server)</span>
sub vcl_fetch <span style="color: #7a0874; font-weight: bold;">&#123;</span>
	<span style="color: #666666; font-style: italic;"># Remove some headers we never want to see</span>
	<span style="color: #7a0874; font-weight: bold;">unset</span> beresp.http.Server;
	<span style="color: #7a0874; font-weight: bold;">unset</span> beresp.http.X-Powered-By;
&nbsp;
	<span style="color: #666666; font-style: italic;"># For static content strip all backend cookies</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>req.url ~ <span style="color: #ff0000;">&quot;\.(css|js|png|gif|jp(e?)g)|swf|ico&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		<span style="color: #7a0874; font-weight: bold;">unset</span> beresp.http.cookie;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># Only allow cookies to be set if we're in admin area</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>beresp.http.Set-Cookie <span style="color: #000000; font-weight: bold;">&amp;&amp;</span> req.url <span style="color: #000000; font-weight: bold;">!</span>~ <span style="color: #ff0000;">&quot;^/wp-(login|admin)&quot;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
        	<span style="color: #7a0874; font-weight: bold;">unset</span> beresp.http.Set-Cookie;
    	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># don't cache response to posted requests or those with basic auth</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span> req.request == <span style="color: #ff0000;">&quot;POST&quot;</span> <span style="color: #000000; font-weight: bold;">||</span> req.http.Authorization <span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
        	<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>hit_for_pass<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
    	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
    	<span style="color: #666666; font-style: italic;"># don't cache search results</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span> req.url ~ <span style="color: #ff0000;">&quot;\?s=&quot;</span> <span style="color: #7a0874; font-weight: bold;">&#41;</span><span style="color: #7a0874; font-weight: bold;">&#123;</span>
		<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>hit_for_pass<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># only cache status ok</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span> beresp.status <span style="color: #000000; font-weight: bold;">!</span>= <span style="color: #000000;">200</span> <span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>hit_for_pass<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># A TTL of 24h</span>
	<span style="color: #000000; font-weight: bold;">set</span> beresp.ttl = 24h;
&nbsp;
	<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>deliver<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># The routine when we deliver the HTTP request to the user</span>
<span style="color: #666666; font-style: italic;"># Last chance to modify headers that are sent to the client</span>
sub vcl_deliver <span style="color: #7a0874; font-weight: bold;">&#123;</span>
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>obj.hits <span style="color: #000000; font-weight: bold;">&gt;</span> <span style="color: #000000;">0</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span> 
		<span style="color: #000000; font-weight: bold;">set</span> resp.http.X-Cache = <span style="color: #ff0000;">&quot;cached&quot;</span>;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span> <span style="color: #000000; font-weight: bold;">else</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
		<span style="color: #000000; font-weight: bold;">set</span> resp.http.x-Cache = <span style="color: #ff0000;">&quot;uncached&quot;</span>;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;"># Remove some headers: PHP version</span>
	<span style="color: #7a0874; font-weight: bold;">unset</span> resp.http.X-Powered-By;
&nbsp;
	<span style="color: #666666; font-style: italic;"># Remove some headers: Apache version &amp; OS</span>
	<span style="color: #7a0874; font-weight: bold;">unset</span> resp.http.Server;
&nbsp;
	<span style="color: #666666; font-style: italic;"># Remove some heanders: Varnish</span>
	<span style="color: #7a0874; font-weight: bold;">unset</span> resp.http.Via;
	<span style="color: #7a0874; font-weight: bold;">unset</span> resp.http.X-Varnish;
&nbsp;
	<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>deliver<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
sub vcl_init <span style="color: #7a0874; font-weight: bold;">&#123;</span>
 	<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>ok<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
sub vcl_fini <span style="color: #7a0874; font-weight: bold;">&#123;</span>
 	<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>ok<span style="color: #7a0874; font-weight: bold;">&#41;</span>;
<span style="color: #7a0874; font-weight: bold;">&#125;</span></pre></div></div>

<p>Avant toute chose voici la doc :) : <a href="https://www.varnish-cache.org/docs/3.0/">https://www.varnish-cache.org/docs/3.0/</a><br />
Ce qu&#8217;il faut retenir de ce fichier de règle c&#8217;est les parties normalisation, enlever les cookies inutiles (car si cookie alors pas de cache) et ne pas mettre en cache l&#8217;admin. Cette config tourne actuellement sur S&#038;M.</p>
<p>Un point interressant c&#8217;est le debug, vous pouvez mettre un <em>set resp.http.X-Cache = &#8220;cached&#8221;;</em> et vérifier les header de votre serveur dans le debug de votre navigateur pour savoir si oui ou non la page servit est en cache.</p>
<p><strong>L&#8217;admin varnish en ligne de commande:</strong><br />
Varnish possède une admin en ligne de commande où l&#8217;on peut par exemple purger le cache d&#8217;une ou plusieurs pages.<br />
Tapez <em>varnishadm</em> dans le shell:</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;">varnishadm
<span style="color: #000000;">200</span>        
<span style="color: #660033;">-----------------------------</span>
Varnish Cache CLI <span style="color: #000000;">1.0</span>
<span style="color: #660033;">-----------------------------</span>
Linux,3.2.0-<span style="color: #000000;">25</span>-virtual,x86_64,-smalloc,-smalloc,-hcritbit
&nbsp;
Type <span style="color: #ff0000;">'help'</span> <span style="color: #000000; font-weight: bold;">for</span> <span style="color: #7a0874; font-weight: bold;">command</span> list.
Type <span style="color: #ff0000;">'quit'</span> to close CLI session.
&nbsp;
varnish<span style="color: #000000; font-weight: bold;">&gt;</span> ban.url <span style="color: #000000; font-weight: bold;">/</span>toto<span style="color: #000000; font-weight: bold;">/</span>ma-page.php</pre></div></div>

<p>Pour purger une page on va utiliser la commande ban.url et y ajouter une partie de l&#8217;url à purger. On peut utiliser un ban en appelant également une url de purge avec Curl ou Wget pour les automations, il y a un excellent article <a href="http://binbash.fr/2011/11/15/purger-le-cache-de-varnish-3/">sur la purge ici.</a></p>
<p><strong>Configurer Nginx:</strong><br />
Une fois varnish installé, on va modifier un peu nginx pour que la liaison puisse se faire. Ci-dessous l&#8217;exemple de notre conf nginx.</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;">&nbsp;
server <span style="color: #7a0874; font-weight: bold;">&#123;</span>
    listen      <span style="color: #000000;">8080</span>;
    server_name  sametmax.com  ;
    root         <span style="color: #000000; font-weight: bold;">/</span>unrep<span style="color: #000000; font-weight: bold;">/</span>sametmax<span style="color: #000000; font-weight: bold;">/</span>;  <span style="color: #666666; font-style: italic;"># absolute path to your WordPress installation</span>
    index index.php index.html;
    set_real_ip_from        127.0.0.1;
    real_ip_header          X-Forwarded-For;
&nbsp;
    location ~ \.php$ <span style="color: #7a0874; font-weight: bold;">&#123;</span>
        include        <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>nginx<span style="color: #000000; font-weight: bold;">/</span>fastcgi_params;
        fastcgi_pass   127.0.0.1:<span style="color: #000000;">53217</span>;
        fastcgi_index index.php;
        fastcgi_buffers <span style="color: #000000;">8</span> 16k;
        fastcgi_buffer_size 32k;
        fastcgi_param  SCRIPT_FILENAME  <span style="color: #007800;">$document_root</span><span style="color: #007800;">$fastcgi_script_name</span>;
    <span style="color: #7a0874; font-weight: bold;">&#125;</span></pre></div></div>

<p>Pour PHP on utilise spawn-fcgi que l&#8217;on gère avec <a href="http://supervisord.org/">supervisor</a> dont voici la conf dans /etc/supervisord.conf</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #7a0874; font-weight: bold;">&#91;</span>program:php5-cgi<span style="color: #7a0874; font-weight: bold;">&#93;</span>
<span style="color: #007800;">command</span>=<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>spawn-fcgi <span style="color: #660033;">-u</span> adolf <span style="color: #660033;">-n</span> <span style="color: #660033;">-a</span> 127.0.0.1 <span style="color: #660033;">-p</span> <span style="color: #000000;">53217</span> <span style="color: #660033;">-P</span> <span style="color: #000000; font-weight: bold;">/</span>tmp<span style="color: #000000; font-weight: bold;">/</span>fastcgi-php.pid <span style="color: #660033;">-F</span> <span style="color: #000000;">4</span> <span style="color: #660033;">--</span> <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>php-cgi
<span style="color: #007800;">redirect_stderr</span>=<span style="color: #c20cb9; font-weight: bold;">true</span>          ; redirect proc stderr to stdout <span style="color: #7a0874; font-weight: bold;">&#40;</span>default <span style="color: #c20cb9; font-weight: bold;">false</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>
<span style="color: #007800;">user</span>=sametmax
<span style="color: #007800;">autostart</span>=<span style="color: #c20cb9; font-weight: bold;">true</span>
<span style="color: #007800;">autorestart</span>=<span style="color: #c20cb9; font-weight: bold;">true</span>
<span style="color: #007800;">startsecs</span>=<span style="color: #000000;">10</span>
<span style="color: #007800;">startretries</span>=<span style="color: #000000;">9999999999999</span>
<span style="color: #007800;">stdout_logfile</span>=<span style="color: #000000; font-weight: bold;">/</span>var<span style="color: #000000; font-weight: bold;">/</span>log<span style="color: #000000; font-weight: bold;">/</span>php5-cgi<span style="color: #000000; font-weight: bold;">/</span>php5-cgi.log
<span style="color: #007800;">stdout_logfile_maxbytes</span>=10MB   ; max <span style="color: #666666; font-style: italic;"># logfile bytes b4 rotation (default 50MB)</span></pre></div></div>

<p><strong>Pour résumer:</strong></p>
<p>Dans cette configuration Varnish est en front end et va décider quand servir une page prise dans le cache (disque dur ou RAM) et quand intéroger le backend pour servir une nouvelle page.<br />
Sur d&#8217;autres sites à fort trafic on a mis Nginx en front end car il encaisse beaucoup plus les hits et qu&#8217;il fait très bien le boulot pour servir des pages statiques.</p>
<p><strong>Attention!</strong><br />
Même si Varnish n&#8217;est pas compliqué à installer il peut être un vrai casse tête quand il s&#8217;agit de cacher des pages. Pensez donc bien à normaliser vos headers (user-agent, gzip, etc), utilisez le debug.<br />
Bien configuré Varnish vous booste un serveur avec une réélle efficacité, il nous a sauvé 2 sites jusqu&#8217;à présent, ça sera d&#8217;ailleurs un standard sur nos prochains sites.</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=4416&amp;md5=f22290422327559763efcf827e1a219f" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/initiation-a-varnish-accelerer-un-blog-wordpress/feed/</wfw:commentRss>
		<slash:comments>6</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Finitiation-a-varnish-accelerer-un-blog-wordpress%2F&amp;language=en_GB&amp;category=text&amp;title=Initiation+%C3%A0+Varnish+%26%238211%3B+Acc%C3%A9lerer+un+blog+WordPress&amp;description=Varnish+est+un+service+qui+permet+de+mettre+en+cache+%28sur+disque+ou+en+m%C3%A9moire%29+certains+contenus+de+votre+site.+Beaucoup+de+gros+sites+l%26%238217%3Butilise+pour+sa+puissance+et+ses...&amp;tags=nginx%2Cvarnish%2Cwordpress%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/03/back_to_the_future.jpg" length="23411" type="image/jpg" />	</item>
		<item>
		<title>Migrer wordpress d&#8217;un serveur à un autre &#8211; Pense-bête</title>
		<link>http://sametmax.com/migrer-wordpress-dun-serveur-a-un-autre-pense-bete/</link>
		<comments>http://sametmax.com/migrer-wordpress-dun-serveur-a-un-autre-pense-bete/#comments</comments>
		<pubDate>Wed, 09 Jan 2013 08:59:03 +0000</pubDate>
		<dc:creator>Max</dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[migration]]></category>
		<category><![CDATA[ubuntu]]></category>
		<category><![CDATA[wordpress]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=4050</guid>
		<description><![CDATA[Quand on migre wordpress d'un serveur à autre sans vouloir se taper la réinstall il y a deux trois trucs à pas oublier...]]></description>
			<content:encoded><![CDATA[<p>Si on veut changer de serveur sans se taper la réinstall de wordpress ça peut devenir casse-tête si on oublie deux trois trucs&#8230;</p>
<p>Voici un petit pense-bête avec pour exemple une config Nginx / WordPress / php5-cgi  sur Ubuntu.</p>
<p>serveura.com = serveur sur lequel se trouve l&#8217;ancien WordPress à migrer<br />
serveurb.com = nouveau serveur qui va accueillir WordPress</p>
<p><strong>1. on sauve la db et on l&#8217;upload sur le nouveau serveur (on peut le faire à la fin si le blog a pas mal d&#8217;activité)</strong><br />
Sur le serveur A:</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;">mysqldump <span style="color: #660033;">-u</span> user_toto -ppass_toto base_a_toto <span style="color: #000000; font-weight: bold;">&gt;</span> <span style="color: #000000; font-weight: bold;">/</span>tmp<span style="color: #000000; font-weight: bold;">/</span>base_a_toto.sql
rsync <span style="color: #660033;">-P</span> <span style="color: #660033;">-azc</span> <span style="color: #000000; font-weight: bold;">/</span>tmp<span style="color: #000000; font-weight: bold;">/</span>base_a_toto.sql user<span style="color: #000000; font-weight: bold;">@</span>serveurb.com:<span style="color: #000000; font-weight: bold;">/</span>tmp<span style="color: #000000; font-weight: bold;">/</span>base_a_toto.sql</pre></div></div>

<p><strong>2. On copie wordpress sur le nouveau serveur</strong><br />
Sur le serveur A:</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;">rsync <span style="color: #660033;">-P</span> <span style="color: #660033;">-azc</span> <span style="color: #000000; font-weight: bold;">/</span>home<span style="color: #000000; font-weight: bold;">/</span>monsite<span style="color: #000000; font-weight: bold;">/</span>wordpress<span style="color: #000000; font-weight: bold;">/</span> user<span style="color: #000000; font-weight: bold;">@</span>serveurb.com:<span style="color: #000000; font-weight: bold;">/</span>home<span style="color: #000000; font-weight: bold;">/</span>monsite<span style="color: #000000; font-weight: bold;">/</span></pre></div></div>

<p><strong>3. Setup et configuration du nouveau serveur</strong><br />
Sur le serveur B:<br />
Installer les packets necessaires:</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">apt-get</span> <span style="color: #c20cb9; font-weight: bold;">install</span> php5-cgi php5-mysql mysql-server nginx spawn-fcgi <span style="color: #c20cb9; font-weight: bold;">sendmail</span></pre></div></div>

<p>Il faut lancer les services nginx et spawn-cgi (pour ce dernier on peut utiliser <a href="http://supervisord.org/">supervisord</a>)</p>
<p>Nginx:<br />
Editer le fichier /etc/nginx/conf.d/monsite.conf . Attention à bien indiquer le chemin absolu vers votre site pour <em>root</em></p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;">server <span style="color: #7a0874; font-weight: bold;">&#123;</span>
    listen      <span style="color: #000000;">80</span>;
    server_name  monsite.com www.monsite.com;                   <span style="color: #666666; font-style: italic;"># your domain name</span>
    root         <span style="color: #000000; font-weight: bold;">/</span>home<span style="color: #000000; font-weight: bold;">/</span>monsite<span style="color: #000000; font-weight: bold;">/</span>wordpress;  <span style="color: #666666; font-style: italic;"># absolute path to your WordPress installation</span>
    index index.php index.html;
&nbsp;
    error_log <span style="color: #ff0000;">&quot;/var/log/nginx_error.log&quot;</span>;
    access_log  <span style="color: #ff0000;">&quot;/var/log/nginx_access.log&quot;</span>;
&nbsp;
    try_files <span style="color: #007800;">$uri</span> <span style="color: #007800;">$uri</span><span style="color: #000000; font-weight: bold;">/</span> <span style="color: #000000; font-weight: bold;">/</span>index.php;
&nbsp;
    location ~ \.php$ <span style="color: #7a0874; font-weight: bold;">&#123;</span>
        include        <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>nginx<span style="color: #000000; font-weight: bold;">/</span>fastcgi_params;
        fastcgi_pass   127.0.0.1:<span style="color: #000000;">53217</span>;
        fastcgi_index index.php;
        fastcgi_buffers <span style="color: #000000;">8</span> 16k;
        fastcgi_buffer_size 32k;
        fastcgi_param  SCRIPT_FILENAME  <span style="color: #007800;">$document_root</span><span style="color: #007800;">$fastcgi_script_name</span>;
    <span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
location = <span style="color: #000000; font-weight: bold;">/</span>robots.txt <span style="color: #7a0874; font-weight: bold;">&#123;</span>
        allow all;
        log_not_found off;
        access_log off;
<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># Deny all attempts to access hidden files such as .htaccess, .htpasswd, .DS_Store (Mac).</span>
location ~ <span style="color: #000000; font-weight: bold;">/</span>\. <span style="color: #7a0874; font-weight: bold;">&#123;</span>
        deny all;
        access_log off;
        log_not_found off;
<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># Deny access to any files with a .php extension in the uploads directory</span>
location ~<span style="color: #000000; font-weight: bold;">*</span> ^<span style="color: #000000; font-weight: bold;">/</span>wp-content<span style="color: #000000; font-weight: bold;">/</span>uploads<span style="color: #000000; font-weight: bold;">/</span>.<span style="color: #000000; font-weight: bold;">*</span>.php$ <span style="color: #7a0874; font-weight: bold;">&#123;</span>
        deny all;
        access_log off;
        log_not_found off;
<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># Deny access to any files with a .php extension in the uploads directory for multisite</span>
location ~<span style="color: #000000; font-weight: bold;">*</span> <span style="color: #000000; font-weight: bold;">/</span>files<span style="color: #000000; font-weight: bold;">/</span><span style="color: #7a0874; font-weight: bold;">&#40;</span>.<span style="color: #000000; font-weight: bold;">*</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>.php$ <span style="color: #7a0874; font-weight: bold;">&#123;</span>
        deny all;
        access_log off;
        log_not_found off;
<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
<span style="color: #7a0874; font-weight: bold;">&#125;</span></pre></div></div>

<p><a href="http://serverfault.com/questions/6733/php-what-are-the-advantages-of-fastcgi-over-mod-php">Spawn-Fcgi</a>: C&#8217;est lui qui va lancer php5-cgi pour faire la liaison entre php et nginx. on va le lancer avec supervisor comme si c&#8217;était un service mais mieux.</p>
<p>Installation de Supervisor:</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">apt-get</span> <span style="color: #c20cb9; font-weight: bold;">install</span> python-setuptools
easy_install supervisor
echo_supervisord_conf <span style="color: #000000; font-weight: bold;">&gt;</span> <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>supervisord.conf</pre></div></div>

<p>Editez le fichier /etc/supervisord.conf pour y rajouter spawn-fcgi, c&#8217;est mieux de lancer php5-cgi avec un user autre que root (www-data ou autre) :</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #7a0874; font-weight: bold;">&#91;</span>program:php5-cgi<span style="color: #7a0874; font-weight: bold;">&#93;</span>
<span style="color: #007800;">command</span>=<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>spawn-fcgi <span style="color: #660033;">-n</span> <span style="color: #660033;">-a</span> 127.0.0.1 <span style="color: #660033;">-p</span> <span style="color: #000000;">53217</span> <span style="color: #660033;">-u</span> www-data <span style="color: #660033;">-f</span> <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>php5-cgi
<span style="color: #007800;">redirect_stderr</span>=<span style="color: #c20cb9; font-weight: bold;">true</span> 
<span style="color: #007800;">stdout_logfile</span>=<span style="color: #000000; font-weight: bold;">/</span>var<span style="color: #000000; font-weight: bold;">/</span>log<span style="color: #000000; font-weight: bold;">/</span>php5-cgi.log
<span style="color: #007800;">stdout_logfile_maxbytes</span>=10MB</pre></div></div>

<p>Pour lancer Spawn-fcgi:</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;">supervisorctl restart php5-cgi</pre></div></div>

<p>Mysql: on ajoute mysql au demarrage et on le lance</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;">chkconfig mysql on
service mysql start</pre></div></div>

<p>Dump de la DB: il faut créer un user et une base sur la nouvelle install, si possible le même que sur l&#8217;ancien serveur pour faciliter la transition.<br />
Sur le serveur B:</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;">mysql <span style="color: #660033;">-u</span> root <span style="color: #660033;">-prootpass</span>
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection <span style="color: #c20cb9; font-weight: bold;">id</span> is <span style="color: #000000;">42</span>
Server version: 5.5.28-0ubuntu0.12.04.3 <span style="color: #7a0874; font-weight: bold;">&#40;</span>Ubuntu<span style="color: #7a0874; font-weight: bold;">&#41;</span>
&nbsp;
Copyright <span style="color: #7a0874; font-weight: bold;">&#40;</span>c<span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #000000;">2000</span>, <span style="color: #000000;">2012</span>, Oracle and<span style="color: #000000; font-weight: bold;">/</span>or its affiliates. All rights reserved.
&nbsp;
Oracle is a registered trademark of Oracle Corporation and<span style="color: #000000; font-weight: bold;">/</span>or its
affiliates. Other names may be trademarks of their respective
owners.
&nbsp;
Type <span style="color: #ff0000;">'help;'</span> or <span style="color: #ff0000;">'\h'</span> <span style="color: #000000; font-weight: bold;">for</span> help. Type <span style="color: #ff0000;">'\c'</span> to <span style="color: #c20cb9; font-weight: bold;">clear</span> the current input statement.
&nbsp;
mysql<span style="color: #000000; font-weight: bold;">&gt;</span> create database base_a_toto;
Query OK, <span style="color: #000000;">1</span> row affected <span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #000000;">0.00</span> sec<span style="color: #7a0874; font-weight: bold;">&#41;</span>
&nbsp;
mysql<span style="color: #000000; font-weight: bold;">&gt;</span> GRANT ALL PRIVILEGES ON base_a_toto.<span style="color: #000000; font-weight: bold;">*</span> TO <span style="color: #ff0000;">&quot;user_toto&quot;</span><span style="color: #000000; font-weight: bold;">@</span><span style="color: #ff0000;">&quot;localhost&quot;</span> identified by <span style="color: #ff0000;">&quot;pass_toto&quot;</span>;
&nbsp;
Query OK, <span style="color: #000000;">0</span> rows affected <span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #000000;">16.16</span> sec<span style="color: #7a0874; font-weight: bold;">&#41;</span>
&nbsp;
mysql<span style="color: #000000; font-weight: bold;">&gt;</span> FLUSH PRIVILEGES;
Query OK, <span style="color: #000000;">0</span> rows affected <span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #000000;">0.00</span> sec<span style="color: #7a0874; font-weight: bold;">&#41;</span></pre></div></div>

<p>Et on importe la base de données de serveura.com:</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;">mysql <span style="color: #660033;">-u</span> user_toto -ppass_toto base_a_toto <span style="color: #000000; font-weight: bold;">&lt;</span> <span style="color: #000000; font-weight: bold;">/</span>tmp<span style="color: #000000; font-weight: bold;">/</span>base_a_toto.sql</pre></div></div>

<p><strong>4. Changer les dns</strong><br />
des fois on oublie :) alors changez les dns et attendez un peu, normallement ça devrait crystalliser&#8230;</p>
<p>Ca prend pas 5 minutes, même avec les paquets tous prêts. on peut avoir de mauvaises surprises en route. Moi par exemple erreur 500 , pour m&#8217;aperçevoir au bout de 2 heures que j&#8217;avais pas installé php5-mysql d&#8217;où ce tuto ;)</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=4050&amp;md5=7bec150ad71bcbb5a9a5204da34ca11f" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/migrer-wordpress-dun-serveur-a-un-autre-pense-bete/feed/</wfw:commentRss>
		<slash:comments>14</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fmigrer-wordpress-dun-serveur-a-un-autre-pense-bete%2F&amp;language=en_GB&amp;category=text&amp;title=Migrer+wordpress+d%26%238217%3Bun+serveur+%C3%A0+un+autre+%26%238211%3B+Pense-b%C3%AAte&amp;description=Si+on+veut+changer+de+serveur+sans+se+taper+la+r%C3%A9install+de+wordpress+%C3%A7a+peut+devenir+casse-t%C3%AAte+si+on+oublie+deux+trois+trucs%26%238230%3B+Voici+un+petit+pense-b%C3%AAte+avec+pour+exemple...&amp;tags=migration%2Cubuntu%2Cwordpress%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/01/migration1.jpg" length="79816" type="image/jpg" />	</item>
		<item>
		<title>WordPress, je te hais</title>
		<link>http://sametmax.com/wordpress-je-te-hais/</link>
		<comments>http://sametmax.com/wordpress-je-te-hais/#comments</comments>
		<pubDate>Wed, 18 Jul 2012 16:29:31 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[php]]></category>
		<category><![CDATA[wordpress]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=1203</guid>
		<description><![CDATA[Cherchant à rendre le formulaire commentaires de Sam et Max plus ergonomique, j'ai jeté un coup d'oeil sur le template lié.]]></description>
			<content:encoded><![CDATA[<p>Cherchant à rendre le formulaire commentaires de Sam et Max plus ergonomique, j&#8217;ai jeté un coup d&#8217;oeil sur le template lié.</p>
<p>L&#8217;intégralité du code qui génère le formulaire pourri que vous voyez sous l&#8217;article est ici:</p>

<div class="wp_syntax"><div class="code"><pre class="php" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'open'</span> <span style="color: #339933;">==</span> <span style="color: #000088;">$post</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">comment_status</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">:</span> <span style="color: #000000; font-weight: bold;">?&gt;</span>
        <span style="color: #000000; font-weight: bold;">&lt;?php</span> comment_form<span style="color: #009900;">&#40;</span> <span style="color: #990000;">array</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'label_submit'</span> <span style="color: #339933;">=&gt;</span> esc_attr__<span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">'Submit Comment'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'Minimal'</span> <span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'title_reply'</span> <span style="color: #339933;">=&gt;</span> <span style="color: #0000ff;">'&lt;span&gt;'</span> <span style="color: #339933;">.</span> esc_attr__<span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">'Leave a Reply'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'Minimal'</span> <span style="color: #009900;">&#41;</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">'&lt;/span&gt;'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'title_reply_to'</span> <span style="color: #339933;">=&gt;</span> esc_attr__<span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">'Leave a Reply to %s'</span> <span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #000000; font-weight: bold;">?&gt;</span>
<span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #b1b100;">else</span><span style="color: #339933;">:</span> <span style="color: #000000; font-weight: bold;">?&gt;</span>
&nbsp;
<span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #b1b100;">endif</span><span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">// if you delete this the sky will fall on your head ?&gt;</span>
<span style="color: #339933;">&lt;/</span>div<span style="color: #339933;">&gt;</span> <span style="color: #339933;">&lt;!--</span> <span style="color: #990000;">end</span> comment<span style="color: #339933;">-</span>section <span style="color: #339933;">--&gt;</span></pre></div></div>

<p>Je vous passe le commentaire amical qui stipule &#8220;<q>si vous supprimez ceci le ciel vous tombera sur la tête</q>&#8221; et toute remarque désobligeante sur le formatage absolument bordélique de l&#8217;intégralité du fichier.</p>
<p>Non, je reste optimise, je vois un <code>comment_form</code> qui encapsule la génération du formulaire. Peut être une API propre ? J&#8217;ai bon espoir (mais le fait que ce soit une fonction et non une classe aurait du me mettre la puce à l&#8217;oreille).</p>
<p>Je trouve un <a href="http://www.1stwebdesigner.com/wordpress/comment-form-customization/">très bon article</a> qui explique où on trouve ce merveilleux <code>comment_form</code> (ben oui parceque les includes et autoloads en PHP c&#8217;est pas vraiment le truc le plus top pour retrouver la chaîne de dépendances). Et là, je n&#8217;ai rien supprimé, mais le ciel m&#8217;est quand même tombé sur la gueule. Et toute la couche d&#8217;ozone avec.</p>
<p>La valeur par défaut d&#8217;UN des paramètres de la fonction qui génère le formulaire, c&#8217;est ça :</p>

<div class="wp_syntax"><div class="code"><pre class="php" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #000088;">$defaults</span> <span style="color: #339933;">=</span> <span style="color: #990000;">array</span><span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">'fields'</span> <span style="color: #339933;">=&gt;</span> apply_filters<span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">'comment_form_default_fields'</span><span style="color: #339933;">,</span> <span style="color: #990000;">array</span><span style="color: #009900;">&#40;</span>
    <span style="color: #0000ff;">'author'</span> <span style="color: #339933;">=&gt;</span> <span style="color: #0000ff;">'&lt;p class=&quot;comment-form-author&quot;&gt;'</span> <span style="color: #339933;">.</span>
                <span style="color: #0000ff;">'&lt;label for=&quot;author&quot;&gt;'</span> <span style="color: #339933;">.</span> __<span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">'Name'</span> <span style="color: #009900;">&#41;</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">'&lt;/label&gt; '</span> <span style="color: #339933;">.</span>
                <span style="color: #009900;">&#40;</span> <span style="color: #000088;">$req</span> ? <span style="color: #0000ff;">'&lt;span class=&quot;required&quot;&gt;*&lt;/span&gt;'</span> <span style="color: #339933;">:</span> <span style="color: #0000ff;">''</span> <span style="color: #009900;">&#41;</span> <span style="color: #339933;">.</span>
                <span style="color: #0000ff;">'&lt;input id=&quot;author&quot; name=&quot;author&quot; type=&quot;text&quot; value=&quot;'</span> <span style="color: #339933;">.</span>
                esc_attr<span style="color: #009900;">&#40;</span> <span style="color: #000088;">$commenter</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'comment_author'</span><span style="color: #009900;">&#93;</span> <span style="color: #009900;">&#41;</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">'&quot; size=&quot;30&quot; tabindex=&quot;1&quot;'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$aria_req</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">' /&gt;'</span> <span style="color: #339933;">.</span>
                <span style="color: #0000ff;">'&lt;/p&gt;&lt;!-- #form-section-author .form-section --&gt;'</span><span style="color: #339933;">,</span>
    <span style="color: #0000ff;">'email'</span>  <span style="color: #339933;">=&gt;</span> <span style="color: #0000ff;">'&lt;p class=&quot;comment-form-email&quot;&gt;'</span> <span style="color: #339933;">.</span>
                <span style="color: #0000ff;">'&lt;label for=&quot;email&quot;&gt;'</span> <span style="color: #339933;">.</span> __<span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">'Email'</span> <span style="color: #009900;">&#41;</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">'&lt;/label&gt; '</span> <span style="color: #339933;">.</span>
                <span style="color: #009900;">&#40;</span> <span style="color: #000088;">$req</span> ? <span style="color: #0000ff;">'&lt;span class=&quot;required&quot;&gt;*&lt;/span&gt;'</span> <span style="color: #339933;">:</span> <span style="color: #0000ff;">''</span> <span style="color: #009900;">&#41;</span> <span style="color: #339933;">.</span>
                <span style="color: #0000ff;">'&lt;input id=&quot;email&quot; name=&quot;email&quot; type=&quot;text&quot; value=&quot;'</span> <span style="color: #339933;">.</span> esc_attr<span style="color: #009900;">&#40;</span>  <span style="color: #000088;">$commenter</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'comment_author_email'</span><span style="color: #009900;">&#93;</span> <span style="color: #009900;">&#41;</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">'&quot; size=&quot;30&quot; tabindex=&quot;2&quot;'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$aria_req</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">' /&gt;'</span> <span style="color: #339933;">.</span>
                <span style="color: #0000ff;">'&lt;/p&gt;&lt;!-- #form-section-email .form-section --&gt;'</span><span style="color: #339933;">,</span>
    <span style="color: #0000ff;">'url'</span>    <span style="color: #339933;">=&gt;</span> <span style="color: #0000ff;">'
&lt;p class=&quot;comment-form-url&quot;&gt;'</span> <span style="color: #339933;">.&lt;/</span>p<span style="color: #339933;">&gt;</span>
&nbsp;
                <span style="color: #0000ff;">'&lt;label for=&quot;url&quot;&gt;'</span> <span style="color: #339933;">.</span> __<span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">'Website'</span> <span style="color: #009900;">&#41;</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">'&lt;/label&gt;'</span> <span style="color: #339933;">.</span>
                <span style="color: #0000ff;">'&lt;input id=&quot;url&quot; name=&quot;url&quot; type=&quot;text&quot; value=&quot;'</span> <span style="color: #339933;">.</span> esc_attr<span style="color: #009900;">&#40;</span> <span style="color: #000088;">$commenter</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'comment_author_url'</span><span style="color: #009900;">&#93;</span> <span style="color: #009900;">&#41;</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">'&quot; size=&quot;30&quot; tabindex=&quot;3&quot; /&gt;'</span> <span style="color: #339933;">.</span>
                <span style="color: #0000ff;">'
&nbsp;
&lt;!-- #&lt;span class=&quot;hiddenSpellError&quot; pre=&quot;&quot;&gt;form-section-url&lt;/span&gt; .form-section --&gt;'</span> <span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span>
    <span style="color: #0000ff;">'comment_field'</span> <span style="color: #339933;">=&gt;</span> <span style="color: #0000ff;">'&lt;p class=&quot;comment-form-comment&quot;&gt;'</span> <span style="color: #339933;">.</span>
                <span style="color: #0000ff;">'&lt;label for=&quot;comment&quot;&gt;'</span> <span style="color: #339933;">.</span> __<span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">'Comment'</span> <span style="color: #009900;">&#41;</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">'&lt;/label&gt;'</span> <span style="color: #339933;">.</span>
                <span style="color: #0000ff;">'&lt;textarea id=&quot;comment&quot; name=&quot;comment&quot; cols=&quot;45&quot; rows=&quot;8&quot; tabindex=&quot;4&quot; aria-required=&quot;true&quot;&gt;&lt;/textarea&gt;'</span> <span style="color: #339933;">.</span>
                <span style="color: #0000ff;">'&lt;/p&gt;&lt;!-- #form-section-comment .form-section --&gt;'</span><span style="color: #339933;">,</span>
    <span style="color: #0000ff;">'must_log_in'</span> <span style="color: #339933;">=&gt;</span> <span style="color: #0000ff;">'
&lt;p class=&quot;must-log-in&quot;&gt;'</span> <span style="color: #339933;">.</span>  <span style="color: #990000;">sprintf</span><span style="color: #009900;">&#40;</span> __<span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">'You must be &lt;a href=&quot;%s&quot;&gt;logged in&lt;/a&gt; to post a comment.'</span> <span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> wp_login_url<span style="color: #009900;">&#40;</span> apply_filters<span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">'the_permalink'</span><span style="color: #339933;">,</span> get_permalink<span style="color: #009900;">&#40;</span> <span style="color: #000088;">$post_id</span> <span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#41;</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">'&lt;/p&gt;
&nbsp;
'</span><span style="color: #339933;">,</span>
    <span style="color: #0000ff;">'logged_in_as'</span> <span style="color: #339933;">=&gt;</span> <span style="color: #0000ff;">'
&lt;p class=&quot;logged-in-as&quot;&gt;'</span> <span style="color: #339933;">.</span> <span style="color: #990000;">sprintf</span><span style="color: #009900;">&#40;</span> __<span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">'Logged in as &lt;a href=&quot;%s&quot;&gt;%s&lt;/a&gt;. &lt;a title=&quot;Log out of this account&quot; href=&quot;%s&quot;&gt;Log out?&lt;/a&gt;&lt;/p&gt;
&nbsp;
'</span> <span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> admin_url<span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">'profile.php'</span> <span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> <span style="color: #000088;">$user_identity</span><span style="color: #339933;">,</span> wp_logout_url<span style="color: #009900;">&#40;</span> apply_filters<span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">'the_permalink'</span><span style="color: #339933;">,</span> get_permalink<span style="color: #009900;">&#40;</span> <span style="color: #000088;">$post_id</span> <span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span>
    <span style="color: #0000ff;">'comment_notes_before'</span> <span style="color: #339933;">=&gt;</span> <span style="color: #0000ff;">'&lt;p class=&quot;comment-notes&quot;&gt;'</span> <span style="color: #339933;">.</span> __<span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">'Your email is &lt;em&gt;never&lt;/em&gt; published nor shared.'</span> <span style="color: #009900;">&#41;</span> <span style="color: #339933;">.</span> <span style="color: #009900;">&#40;</span> <span style="color: #000088;">$req</span> ? __<span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">' Required fields are marked &lt;span class=&quot;required&quot;&gt;*&lt;/span&gt;'</span> <span style="color: #009900;">&#41;</span> <span style="color: #339933;">:</span> <span style="color: #0000ff;">''</span> <span style="color: #009900;">&#41;</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">'&lt;/p&gt;'</span><span style="color: #339933;">,</span>
    <span style="color: #0000ff;">'comment_notes_after'</span> <span style="color: #339933;">=&gt;</span> <span style="color: #0000ff;">'&lt;dl class=&quot;form-allowed-tags&quot;&gt;&lt;dt&gt;'</span> <span style="color: #339933;">.</span> __<span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">'You may use these &lt;abbr title=&quot;HyperText Markup Language&quot;&gt;HTML&lt;/abbr&gt; tags and attributes:'</span> <span style="color: #009900;">&#41;</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">'&lt;/dt&gt; &lt;dd&gt;&lt;code&gt;'</span> <span style="color: #339933;">.</span> allowed_tags<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">'&lt;/code&gt;&lt;/dd&gt;'</span><span style="color: #339933;">,</span>
    <span style="color: #0000ff;">'id_form'</span> <span style="color: #339933;">=&gt;</span> <span style="color: #0000ff;">'commentform'</span><span style="color: #339933;">,</span>
    <span style="color: #0000ff;">'id_submit'</span> <span style="color: #339933;">=&gt;</span> <span style="color: #0000ff;">'submit'</span><span style="color: #339933;">,</span>
    <span style="color: #0000ff;">'title_reply'</span> <span style="color: #339933;">=&gt;</span> __<span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">'Leave a Reply'</span> <span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span>
    <span style="color: #0000ff;">'title_reply_to'</span> <span style="color: #339933;">=&gt;</span> __<span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">'Leave a Reply to %s'</span> <span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span>
    <span style="color: #0000ff;">'cancel_reply_link'</span> <span style="color: #339933;">=&gt;</span> __<span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">'Cancel reply'</span> <span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span>
    <span style="color: #0000ff;">'label_submit'</span> <span style="color: #339933;">=&gt;</span> __<span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">'Post Comment'</span> <span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span>
<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #000000; font-weight: bold;">?&gt;</span></pre></div></div>

<p>Je ne sais pas ce qui me rend le plus malade.</p>
<p>L&#8217;absence totale de la notion de template ?</p>
<p>Le fait qu&#8217;on passe l&#8217;intégralité du code HTML en PARAMETRE à une fonction qui est censée générer le formulaire ?</p>
<p>Le fait que le code est absolument inmodifiable car c&#8217;est un mélange de concaténations, d&#8217;arrays et d&#8217;appels à gettext ?</p>
<p>Je voulais juste modifier le HTML du formulaire de comments bordel !</p>
<p>BANG !</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=1203&amp;md5=dc70a27af09f4d9b090c106ea3794bc1" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/wordpress-je-te-hais/feed/</wfw:commentRss>
		<slash:comments>4</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fwordpress-je-te-hais%2F&amp;language=en_GB&amp;category=text&amp;title=WordPress%2C+je+te+hais&amp;description=Cherchant+%C3%A0+rendre+le+formulaire+commentaires+de+Sam+et+Max+plus+ergonomique%2C+j%26%238217%3Bai+jet%C3%A9+un+coup+d%26%238217%3Boeil+sur+le+template+li%C3%A9.+L%26%238217%3Bint%C3%A9gralit%C3%A9+du+code+qui+g%C3%A9n%C3%A8re+le+formulaire+pourri+que...&amp;tags=php%2Cwordpress%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2012/07/suicide.jpg" length="122350" type="image/jpg" />	</item>
		<item>
		<title>Le backup wordpress du pauvre</title>
		<link>http://sametmax.com/le-backup-wordpress-du-pauvre/</link>
		<comments>http://sametmax.com/le-backup-wordpress-du-pauvre/#comments</comments>
		<pubDate>Wed, 18 Jul 2012 15:36:09 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[backup]]></category>
		<category><![CDATA[cron]]></category>
		<category><![CDATA[git]]></category>
		<category><![CDATA[mysql]]></category>
		<category><![CDATA[wordpress]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=1198</guid>
		<description><![CDATA[Quand c'est le blog que vous faites pour le fun, vous n'avez pas envie de mettre en place un système compliqué pour faire un backup facile à restaurer.]]></description>
			<content:encoded><![CDATA[<blockquote><p>Backup&#8217;s, can&#8217;t live with them, can&#8217;t live without them.</p></blockquote>
<p>Mais quand c&#8217;est le blog que vous faites pour le fun, vous n&#8217;avez pas envie de mettre en place un système compliqué pour faire un backup facile à restaurer.</p>
<p>Typiquement, SamEtMax est là pour le lulz, pas pour la corvée. Ce n&#8217;est pas grâve si il se fait pirater, defaced ou whatever. Pas besoin d&#8217;un truc hyper secure. Juste de quoi le remettre sur les rails rapidement, avec le minimum d&#8217;effort.</p>
<p>La solution inspirée par <a href="http://www.la-rache.com/">la méthode Rache</a>:</p>
<ul>
<li>Dans le cron: <code>28 22 * * 1 mysqldump -u user -ppassword database &gt; /chemin/vers/site/backup.sql</code></li>
<li>Un petit <code>git init</code>, <code>git add .</code>, <code>git commit -m "OSEF"</code>;</li>
<li>Un petit <code>git pull</code> sur son laptop (histoire d&#8217;avoir le code sous la main offline)</li>
</ul>
<p>Avec les thêmes le premier fetch fait quand même 250 Mo, le coquin.</p>
<p>Ensuite, un cron sur un autre server qui bouffe pas de BP (genre un server d&#8217;encoding) avec le <code>git pull</code> dedans, et voilà. Sauvegarde complète, automatique et facile à restaurer.</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=1198&amp;md5=3916441cd23362a826e7669ee39502cb" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/le-backup-wordpress-du-pauvre/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fle-backup-wordpress-du-pauvre%2F&amp;language=en_GB&amp;category=text&amp;title=Le+backup+wordpress+du+pauvre&amp;description=Backup%26%238217%3Bs%2C+can%26%238217%3Bt+live+with+them%2C+can%26%238217%3Bt+live+without+them.+Mais+quand+c%26%238217%3Best+le+blog+que+vous+faites+pour+le+fun%2C+vous+n%26%238217%3Bavez+pas+envie+de+mettre+en+place+un+syst%C3%A8me...&amp;tags=backup%2Ccron%2Cgit%2Cmysql%2Cwordpress%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2012/07/Clay-Enos-African-child.jpg" length="111681" type="image/jpg" />	</item>
	</channel>
</rss>
