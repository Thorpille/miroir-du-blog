<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Sam &#38; Max: Python, Django, Git et du cul &#187; process</title>
	<atom:link href="http://sametmax.com/tag/process/feed/" rel="self" type="application/rss+xml" />
	<link>http://sametmax.com</link>
	<description>Deux développeurs en vadrouille qui se sortent les doigts du code</description>
	<lastBuildDate>Mon, 02 Dec 2013 10:02:45 +0000</lastBuildDate>
	<language>en</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>http://wordpress.org/?v=3.3.1</generator>
	<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2F&amp;language=en_US&amp;category=text&amp;title=Sam+%26amp%3B+Max%3A+Python%2C+Django%2C+Git+et+du+cul&amp;description=Deux+d%C3%A9veloppeurs+en+vadrouille+qui+se+sortent+les+doigts+du+code&amp;tags=blog" type="text/html" />
		<item>
		<title>Remplacer les threads avec le module multiprocessing en Python</title>
		<link>http://sametmax.com/remplacer-les-threads-avec-le-module-multiprocessing-en-python/</link>
		<comments>http://sametmax.com/remplacer-les-threads-avec-le-module-multiprocessing-en-python/#comments</comments>
		<pubDate>Tue, 31 Jul 2012 12:24:03 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[concurrency]]></category>
		<category><![CDATA[process]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[thread]]></category>
		<category><![CDATA[worker]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=1430</guid>
		<description><![CDATA[Prenons une application qui poll des flux RSS comme <a href="http://liferea.sourceforge.net/">Liferea</a>. Liferea a pendant bien longtemps freezé l'intégralité de l'UI pendant la mise à jour de la liste d'articles (ben oui le temps de charger une page Web, la main loop attend). On peut éviter cela en utilisant des threads ou, dans notre, cas, de multiples processus.]]></description>
			<content:encoded><![CDATA[<p>Les threads Python sont <a href="http://jessenoller.com/2009/02/01/python-threads-and-the-global-interpreter-lock/">limités par le Global Interpreter Lock</a>, et si ils permettent de s&#8217;affranchir des problèmes de concurrence d&#8217;accès IO, ils sont inefficaces pour profiter de nos merveilleux processeurs multi-coeurs. Les <a href="http://sametmax.com/concurrence-sans-threads-en-python/">coroutines</a>, une alternative élégante aux threads, ont la même limitation.</p>
<p>Heureusement Python vient avec le module <a href="http://docs.python.org/library/multiprocessing.html">multiprocessing</a>, qui permet justement de créer plusieurs processus séparés, et les orchestrer pour qu&#8217;ils travaillent ensemble, et ainsi saturer la consommation de ressource de nos serveurs modernes si chers et si puissants.</p>
<p>Prenons un employé de banque <a href="http://michel.buze.perso.neuf.fr/lavache/pierre_desproges_basse_fosse.htm">que nous appellerons A</a>, et un épagneul Breton, que nous appellerons Catherine.</p>
<p>Euh non&#8230;</p>
<p>Prenons plutôt une application qui poll des flux RSS comme <a href="http://liferea.sourceforge.net/">Liferea</a>. Liferea a pendant bien longtemps freezé l&#8217;intégralité de l&#8217;UI pendant la mise à jour de la liste d&#8217;articles (ben oui le temps de charger une page Web, la main loop attend). On peut éviter cela en utilisant des threads ou, dans notre, cas, de multiples processus.</p>
<p>Bon, il y a peu de chance que Lifera soit CPU bound, donc c&#8217;est vrai que dans ce cas les threads feraient aussi bien, mais c&#8217;est pour l&#8217;exemple, bande de tatillons.</p>
<p>Pour notre cas de figure, nous avons besoin:</p>
<ul>
<li>d&#8217;un process qui demande aux autres de vérifier les derniers flux RSS (pour simuler une interaction utilisateur);</li>
<li>d&#8217;un process qui va faire la vérification des flux RSS sans bloquer les autres process;</li>
<li>de <code>feedparser</code>, une lib Python qui parse les flux RSS;</li>
<li>d&#8217;un process qui va lancer tout ça, récupérer le résultat et l&#8217;afficher.</li>
</ul>
<p>Pour feedparser avec <a href="http://sametmax.com/votre-python-aime-les-pip/">pip</a>:</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;">    pip <span style="color: #c20cb9; font-weight: bold;">install</span> feedparser</pre></div></div>

<p>Ça c&#8217;est fait.</p>
<p>Pour le reste, on se fait un petit fichier <em>rssmania.py</em>:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #808080; font-style: italic;"># -*- coding: utf-8 -*-</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">time</span>
<span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">time</span> <span style="color: #ff7700;font-weight:bold;">import</span> mktime
<span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">datetime</span> <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">datetime</span>
<span style="color: #ff7700;font-weight:bold;">from</span> multiprocessing <span style="color: #ff7700;font-weight:bold;">import</span> Process, <span style="color: #dc143c;">Queue</span>, TimeoutError
&nbsp;
<span style="color: #ff7700;font-weight:bold;">import</span> feedparser
&nbsp;
<span style="color: #808080; font-style: italic;"># cette fonction va être utilisée comme worker</span>
<span style="color: #808080; font-style: italic;"># elle va lancer un process qui tourne en boucle et vérifie de manière</span>
<span style="color: #808080; font-style: italic;"># régulière si il y a des flux à mettre à jour</span>
<span style="color: #ff7700;font-weight:bold;">def</span> mettre_a_jour_les_flux<span style="color: black;">&#40;</span>queue_flux_a_mettre_a_jour, queue_de_mises_a_jour_des_flux<span style="color: black;">&#41;</span>:
&nbsp;
    last_update = <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">while</span> <span style="color: #008000;">True</span>: <span style="color: #808080; font-style: italic;"># une bonne boucle infinie pour la main loop</span>
        <span style="color: #ff7700;font-weight:bold;">try</span>:
            <span style="color: #808080; font-style: italic;"># on vérifie si il y a un message dans la queue pendant 0.1 secondes</span>
            <span style="color: #808080; font-style: italic;"># si oui, on parse le flux (sinon, ça raise une TimeoutError)</span>
            flux = queue_flux_a_mettre_a_jour.<span style="color: black;">get</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">0.1</span><span style="color: black;">&#41;</span>
&nbsp;
            feed = feedparser.<span style="color: black;">parse</span><span style="color: black;">&#40;</span>flux<span style="color: black;">&#41;</span>
            nouveaux_articles = <span style="color: black;">&#91;</span><span style="color: black;">&#93;</span>
            <span style="color: #808080; font-style: italic;"># pour chaque article, on vérifie si la date de parution est</span>
            <span style="color: #808080; font-style: italic;"># antérieur au dernier check, et si oui, on le déclare</span>
            <span style="color: #808080; font-style: italic;"># &quot;nouvel article&quot;</span>
            <span style="color: #ff7700;font-weight:bold;">for</span> article <span style="color: #ff7700;font-weight:bold;">in</span> feed.<span style="color: black;">entries</span>:
                <span style="color: #ff7700;font-weight:bold;">try</span>:
                    dt = <span style="color: #dc143c;">datetime</span>.<span style="color: black;">fromtimestamp</span><span style="color: black;">&#40;</span>mktime<span style="color: black;">&#40;</span>article.<span style="color: black;">updated_parsed</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
                    <span style="color: #ff7700;font-weight:bold;">if</span> dt <span style="color: #66cc66;">&gt;</span> last_update<span style="color: black;">&#91;</span>flux<span style="color: black;">&#93;</span>:
                        nouveaux_articles.<span style="color: black;">append</span><span style="color: black;">&#40;</span>article.<span style="color: black;">link</span><span style="color: black;">&#41;</span>
                <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: #008000;">KeyError</span>:
                    nouveaux_articles.<span style="color: black;">append</span><span style="color: black;">&#40;</span>article.<span style="color: black;">link</span><span style="color: black;">&#41;</span>
&nbsp;
            <span style="color: #808080; font-style: italic;"># on balance tous les nouveaux articles dans la queue</span>
            <span style="color: #ff7700;font-weight:bold;">if</span> nouveaux_articles:
                queue_de_mises_a_jour_des_flux.<span style="color: black;">put</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>feed.<span style="color: black;">feed</span>.<span style="color: black;">title</span>, nouveaux_articles<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
            last_update<span style="color: black;">&#91;</span>flux<span style="color: black;">&#93;</span> = <span style="color: #dc143c;">datetime</span>.<span style="color: black;">now</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># en cas de time out on repart sur un tour de boucle</span>
        <span style="color: #808080; font-style: italic;"># si l'utilisateur fait CTRL+C sur le worker principal, il sera</span>
        <span style="color: #808080; font-style: italic;"># broadcasté ici, donc on le catch et on exit proprement</span>
        <span style="color: #ff7700;font-weight:bold;">except</span> TimeoutError:
            <span style="color: #ff7700;font-weight:bold;">pass</span>
        <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: #008000;">KeyboardInterrupt</span>:
            <span style="color: #dc143c;">sys</span>.<span style="color: black;">exit</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#41;</span>
&nbsp;
&nbsp;
<span style="color: #808080; font-style: italic;"># worker très basique qui demande la mise à jour de tous les flux</span>
<span style="color: #808080; font-style: italic;"># c'est bourrin, mais c'est pour l'exemple on vous dit !</span>
<span style="color: #ff7700;font-weight:bold;">def</span> demander_la_mise_a_jour_des_flux<span style="color: black;">&#40;</span>queue_de_flux_a_mettre_a_jour, flux_rss<span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;
        Demande la mise à jour des flux toutes les 5 minutes
    &quot;&quot;&quot;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># pareil, petite boucle infinie, temporisation et gestion du CTRL + C</span>
    <span style="color: #808080; font-style: italic;"># en gros on ne fait que remplir la queue toutes les 5 minutes</span>
    <span style="color: #808080; font-style: italic;"># avec des urls</span>
    <span style="color: #ff7700;font-weight:bold;">while</span> <span style="color: #008000;">True</span>:
&nbsp;
        <span style="color: #ff7700;font-weight:bold;">try</span>:
            <span style="color: #ff7700;font-weight:bold;">for</span> flux <span style="color: #ff7700;font-weight:bold;">in</span> flux_rss:
                queue_de_flux_a_mettre_a_jour.<span style="color: black;">put</span><span style="color: black;">&#40;</span>flux<span style="color: black;">&#41;</span>
&nbsp;
            <span style="color: #dc143c;">time</span>.<span style="color: black;">sleep</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">300</span><span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: #008000;">KeyboardInterrupt</span>:
            <span style="color: #dc143c;">sys</span>.<span style="color: black;">exit</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#41;</span>
&nbsp;
&nbsp;
<span style="color: #808080; font-style: italic;"># très important ce if, sinon sous windows le module sera importé plusieurs</span>
<span style="color: #808080; font-style: italic;"># fois et lancera ce bloc plusieurs fois</span>
<span style="color: #ff7700;font-weight:bold;">if</span> __name__ == <span style="color: #483d8b;">'__main__'</span>:
&nbsp;
    <span style="color: #808080; font-style: italic;"># les flux à mettre à jour, RAS</span>
    flux_rss = <span style="color: black;">&#40;</span>
        <span style="color: #483d8b;">'http://sametmax.com/feed/'</span>,
        <span style="color: #483d8b;">&quot;http://sebsauvage.net/links/index.php?do=rss&quot;</span>,
        <span style="color: #483d8b;">&quot;http://charlesleifer.com/blog/rss/&quot;</span>,
        <span style="color: #483d8b;">&quot;http://xkcd.com/rss.xml&quot;</span>
    <span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># les queues. Ces objets sont comme des listes partageables entre</span>
    <span style="color: #808080; font-style: italic;"># les workers, sur lesquelles on pourrait faire uniquement insert(0, elem)</span>
    <span style="color: #808080; font-style: italic;"># (ici put(elem)) et pop() (ici get()). Des FIFO thread safe quoi.</span>
    queue_de_flux_a_mettre_a_jour = <span style="color: #dc143c;">Queue</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
    queue_de_mises_a_jour_des_flux = <span style="color: #dc143c;">Queue</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># ici on créé nos workers: on dit quelle fonction lancer avec quels</span>
    <span style="color: #808080; font-style: italic;"># arguments. Nos arguments ici sont essentiellement les queues,</span>
    <span style="color: #808080; font-style: italic;"># puisque c'est ce qui va nous permettre de partager les infos</span>
    <span style="color: #808080; font-style: italic;"># entre les process (qui sont sinon isolés les uns des autres)</span>
    worker_qui_met_a_jour_les_flux = Process<span style="color: black;">&#40;</span>target=mettre_a_jour_les_flux,
                                             args=<span style="color: black;">&#40;</span>queue_de_flux_a_mettre_a_jour,
                                                   queue_de_mises_a_jour_des_flux<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
    worker_qui_demande_la_mise_a_jour = Process<span style="color: black;">&#40;</span>target=demander_la_mise_a_jour_des_flux,
                                                args=<span style="color: black;">&#40;</span>queue_de_flux_a_mettre_a_jour,
                                                      flux_rss<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># On démarre les workers, et à partir de là, 2 processus sont créés</span>
    <span style="color: #808080; font-style: italic;"># et lançant chacun une fonction, les boucles infinies tournent joyeusement</span>
    <span style="color: #808080; font-style: italic;"># et une personne est agressée toutes les 7 secondes à New York aussi,</span>
    <span style="color: #808080; font-style: italic;"># mais on s'en fout dans notre cas présent.</span>
    <span style="color: #808080; font-style: italic;"># Bien faire gaffe que les fonctions soient capables de tourner à vide :-)</span>
    worker_qui_met_a_jour_les_flux.<span style="color: black;">start</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
    worker_qui_demande_la_mise_a_jour.<span style="color: black;">start</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># et voici notre worker principal, qui pop les nouveaux flux tout</span>
    frais, et les affiche à l<span style="color: #483d8b;">'écran
    try:
        while True:
            try:
                feed, articles = queue_de_mises_a_jour_des_flux.get(0.2)
                print &quot;Voici les derniers articles de %s :&quot; % feed
                for article in articles:
                    print &quot;- %s&quot; % article
            except TimeoutError:
                pass
&nbsp;
    except KeyboardInterrupt:
        pass
    finally:
        # si la boucle while s'</span>arrête d<span style="color: #483d8b;">'une manière ou d'</span>une autre
        <span style="color: #808080; font-style: italic;"># on attend que les autres processus s'arrêtent avant de quitter</span>
        <span style="color: #808080; font-style: italic;"># En vrai on mettrait beaucoup plus de code que ça, une file</span>
        <span style="color: #808080; font-style: italic;"># de controle, peut être un handler de SIGTERM, etc</span>
        <span style="color: #808080; font-style: italic;"># là on va à l'essentiel</span>
        worker_qui_met_a_jour_les_flux.<span style="color: black;">join</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
        worker_qui_demande_la_mise_a_jour.<span style="color: black;">join</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Fin des haricots&quot;</span></pre></div></div>

<p>On lance le bouzin:</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;">    python rssmania.py</pre></div></div>

<p>Python se charge automatiquement de créer 2 subprocess, un qui lance la fonction <code>mettre_a_jour_les_flux()</code> et un pour <code>demander_la_mise_a_jour_des_flux()</code> puis il va faire tourner notre bouclinette principale avec amour.</p>
<p>Normalement, au premier lancement ça donne un truc comme ça:</p>
<pre>Voici les derniers articles de Sam &#038; Max: Python, Django, Git et du cul :
- http://sametmax.com/rassurez-vous-vous-netes-pas-bizarres/
- http://sametmax.com/fonctions-anonymes-en-python-ou-lambda/
- http://sametmax.com/deterer-le-cadavre-dun-troll-non-php-nest-pas-simple/
- http://sametmax.com/concurrence-sans-threads-en-python/
- http://sametmax.com/humour-reflexion-et-cul-la-formule-ne-date-pas-dhier/
- http://sametmax.com/state-machine-en-python-en-labsence-dalgos-recursifs-beneficiant-de-tail-call-optimisation/
- http://sametmax.com/appel-a-contributeurs-impertinents/
- http://sametmax.com/synchroniser-les-freeplugs-les-adaptateurs-reseaux-cpl-de-free/
- http://sametmax.com/incendie-en-espagne-un-megot-peut-se-tranformer-en-arme-mortelle/
- http://sametmax.com/jadore-les-context-managers-python/
Voici les derniers articles de Liens en vrac de sebsauvage :
- http://imgur.com/37R4c
- http://www.clubic.com/navigateur-internet-mobile/opera-mini/actualite-503834-opera-mini-depasse-200-utilisateurs.html
- http://www.lesnumeriques.com/jeux-video/impire-p14041/impire-creez-vos-donjons-comme-a-bonne-epoque-annees-bullfrog-n25461.html
- http://sebsauvage.net/links/index.php?Jr5VKg
- http://sebsauvage.net/links/index.php?PQUdwA
- http://imgur.com/A4xkr
</pre>
<p>Et 5 minutes plus tard (dans le cas improbable où un article a été publié entre temps), ça affiche les nouveaux articles.</p>
<p>Si vous appuyez sur <kbd>CTRL + C</kbd>, <code>SIGINT</code> va être envoyé à tous les workers, et ils vont tous s&#8217;arrêter gentiment. Normalement. En théorie. Souvent ça marche. Sur ma machine.</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=1430&amp;md5=8fed0cacb89273a70361df4dd9b35dc1" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/remplacer-les-threads-avec-le-module-multiprocessing-en-python/feed/</wfw:commentRss>
		<slash:comments>8</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fremplacer-les-threads-avec-le-module-multiprocessing-en-python%2F&amp;language=en_GB&amp;category=text&amp;title=Remplacer+les+threads+avec+le+module+multiprocessing+en+Python&amp;description=Les+threads+Python+sont+limit%C3%A9s+par+le+Global+Interpreter+Lock%2C+et+si+ils+permettent+de+s%26%238217%3Baffranchir+des+probl%C3%A8mes+de+concurrence+d%26%238217%3Bacc%C3%A8s+IO%2C+ils+sont+inefficaces+pour+profiter+de+nos+merveilleux...&amp;tags=concurrency%2Cprocess%2Cpython%2Cthread%2Cworker%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2012/07/10053844.jpg" length="30622" type="image/jpg" />	</item>
		<item>
		<title>Diminuer la charge cpu d&#8217;un process avec renice</title>
		<link>http://sametmax.com/diminuer-la-charge-cpu-dun-process-avec-renice/</link>
		<comments>http://sametmax.com/diminuer-la-charge-cpu-dun-process-avec-renice/#comments</comments>
		<pubDate>Tue, 29 May 2012 08:44:10 +0000</pubDate>
		<dc:creator>Max</dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[cpu]]></category>
		<category><![CDATA[load average]]></category>
		<category><![CDATA[nice]]></category>
		<category><![CDATA[process]]></category>
		<category><![CDATA[renice]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=780</guid>
		<description><![CDATA[Si vous avez un process qui consomme pas mal de cpu vous pouvez changer sa priorite à l'aide la commande renice.
]]></description>
			<content:encoded><![CDATA[<p>Il arrive que l&#8217;on ai a executer certains scripts sur un serveur de prod deja pas mal encombré, je prends comme exemple mon cas ou j&#8217;ai du reencoder des vidéos, le load average est monté à 6, les perfs en sont du coup devenues execrables.<br />
Sous linux on a heureusement plein d&#8217;outils sympas, <strong>renice</strong> en fait partie.</p>
<p>La commande <strong>renice</strong> permet d&#8217;assigner une priorite a un process en cours qui va de -20 (tres elevee) à 20 (tres bas), 0 etant la valeur par défaut. La commande est &#8220;renice priorite id_process&#8221;, dans mon cas:</p>
<p><strong>Note: On peut connaitre l&#8217;id du process avec un top ou <a href="http://sametmax.com/htop-un-visualiseur-interactif-de-process/" title="htop – un visualiseur interactif de process">htop</a></strong></p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;">PID USER        PR  NI  VIRT  RES  SHR S <span style="color: #000000; font-weight: bold;">%</span>CPU <span style="color: #000000; font-weight: bold;">%</span>MEM    TIME+  COMMAND          
<span style="color: #000000;">14378</span> max 	<span style="color: #000000;">35</span>  <span style="color: #000000;">15</span>  129m  12m <span style="color: #000000;">4632</span> R <span style="color: #000000;">99.4</span>  <span style="color: #000000;">0.2</span>   <span style="color: #000000;">0</span>:<span style="color: #000000;">03.22</span> <span style="color: #c20cb9; font-weight: bold;">ffmpeg</span>       
<span style="color: #000000;">22959</span> max       <span style="color: #000000;">20</span>  <span style="color: #000000;">15</span>  101m  79m  <span style="color: #000000;">924</span> S  <span style="color: #000000;">1.7</span>  <span style="color: #000000;">1.3</span>   <span style="color: #000000;">8</span>:<span style="color: #000000;">51.85</span> python encode.py                
<span style="color: #000000;">22958</span> nginx     <span style="color: #000000;">20</span>   <span style="color: #000000;">0</span>  105m  83m  <span style="color: #000000;">924</span> S  <span style="color: #000000;">1.0</span>  <span style="color: #000000;">1.4</span>   <span style="color: #000000;">8</span>:<span style="color: #000000;">51.44</span> nginx</pre></div></div>

<p>Ici ffmpeg à un nice (NI) de 15 qu&#8217;il a herité de mon script Python <em>encode.py</em> a qui j&#8217;ai fais un renice de 15 avec la commande &#8220;renice 15 22959&#8243;. Les process heritent automatiquement du nice des parents qui les ont lancés.</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=780&amp;md5=4f9d36741f2de47afdc147b78c1f68df" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/diminuer-la-charge-cpu-dun-process-avec-renice/feed/</wfw:commentRss>
		<slash:comments>2</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fdiminuer-la-charge-cpu-dun-process-avec-renice%2F&amp;language=en_GB&amp;category=text&amp;title=Diminuer+la+charge+cpu+d%26%238217%3Bun+process+avec+renice&amp;description=Il+arrive+que+l%26%238217%3Bon+ai+a+executer+certains+scripts+sur+un+serveur+de+prod+deja+pas+mal+encombr%C3%A9%2C+je+prends+comme+exemple+mon+cas+ou+j%26%238217%3Bai+du+reencoder+des+vid%C3%A9os%2C...&amp;tags=cpu%2Cload+average%2Cnice%2Cprocess%2Crenice%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2012/05/traffic-jam.jpg" length="63310" type="image/jpg" />	</item>
		<item>
		<title>Checker ses process et les relancer en cas de plantage</title>
		<link>http://sametmax.com/checker-ses-process-et-les-relancer-en-cas-de-plantage/</link>
		<comments>http://sametmax.com/checker-ses-process-et-les-relancer-en-cas-de-plantage/#comments</comments>
		<pubDate>Tue, 22 May 2012 16:55:40 +0000</pubDate>
		<dc:creator>Max</dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[check]]></category>
		<category><![CDATA[monitoring]]></category>
		<category><![CDATA[process]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=672</guid>
		<description><![CDATA[Il arrive que l'on ait des scripts un peu bancales qui peuvent planter parfois, comment les monitorer facilement ? Comment les relancer sans avoir à se demander si ça tourne ou pas ?]]></description>
			<content:encoded><![CDATA[<p>J&#8217;ai quelques scripts qui se mettent à planter des fois, je sais que c&#8217;est parceque je les ai codé comme un gros porc mais ça m&#8217;emmerde de les refaires parceque après tout ils font ce que je leur dit de faire, c&#8217;est juste qu&#8217;ils plantent des fois.<br />
Ceci dit j&#8217;ai aussi des applications qui ne sont pas mienne qui plantent (privoxy, tor, des fois même lighttpd) et là on est bien content que quelqu&#8217;un puisse le relancer pendant qu&#8217;on est en train de se cuiter au bar du coin.</p>
<p>Voici un petit script tout simple en python que je lance avec un crontab à intervalles réguliers.</p>
<p><strong>Exemple pour nginx, on va rechercher le process à partir du mot clef &#8220;nginx&#8221;:</strong></p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">ps</span> aux <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">grep</span> nginx
root     <span style="color: #000000;">29231</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">22144</span>   <span style="color: #000000;">948</span> ?        Ss   <span style="color: #000000;">13</span>:05   <span style="color: #000000;">0</span>:00 nginx: master process <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>sbin<span style="color: #000000; font-weight: bold;">/</span>nginx <span style="color: #660033;">-c</span> <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>nginx<span style="color: #000000; font-weight: bold;">/</span>conf<span style="color: #000000; font-weight: bold;">/</span>nginx.conf</pre></div></div>

<p><strong>Dans le script ça donne:</strong></p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">#!/usr/bin/env python</span>
<span style="color: #808080; font-style: italic;"># -*- coding: utf-8 -*-</span>
<span style="color: #808080; font-style: italic;"># vim: ai ts=4 sts=4 et sw=4</span>
&nbsp;
<span style="color: #483d8b;">&quot;&quot;&quot;
    check if script is running else relaunch
&quot;&quot;&quot;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">sys</span>
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">os</span>
<span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">subprocess</span> <span style="color: #ff7700;font-weight:bold;">import</span> Popen, call, PIPE
&nbsp;
&nbsp;
SUCCESS_EXIT_CODE=<span style="color: #ff4500;">0</span>
ERR_PS_SCRIPT_RUNNING=<span style="color: #ff4500;">3</span>
ERR_PID_SCRIPT_RUNNING=<span style="color: #ff4500;">4</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> check_ps_cmd<span style="color: black;">&#40;</span>script_name<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">try</span>:
        p1 = Popen<span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #483d8b;">&quot;ps&quot;</span>, <span style="color: #483d8b;">&quot;aux&quot;</span><span style="color: black;">&#93;</span>, stdout=PIPE<span style="color: black;">&#41;</span>
        p2 = Popen<span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #483d8b;">&quot;grep&quot;</span>, script_name<span style="color: black;">&#93;</span>, stdin=p1.<span style="color: black;">stdout</span>, stdout=PIPE<span style="color: black;">&#41;</span>
        p3 = Popen<span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #483d8b;">&quot;grep&quot;</span>, <span style="color: #483d8b;">&quot;-v&quot;</span>, <span style="color: #483d8b;">&quot;grep&quot;</span><span style="color: black;">&#93;</span>, stdin=p2.<span style="color: black;">stdout</span>, stdout=PIPE<span style="color: black;">&#41;</span>
        output = p3.<span style="color: black;">communicate</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#93;</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> output
    <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: #008000;">Exception</span>, e:
        <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #66cc66;">&gt;&gt;</span>sys.<span style="color: black;">stderr</span>, <span style="color: #483d8b;">&quot;Execution failed:&quot;</span>, e
        <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">None</span>
&nbsp;
&nbsp;
<span style="color: #808080; font-style: italic;"># process to check</span>
<span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #ff7700;font-weight:bold;">not</span> check_ps_cmd<span style="color: black;">&#40;</span><span style="color: #483d8b;">'nginx'</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Nginx dead, relaunch...&quot;</span>
    retcode = call<span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;service nginx restart&quot;</span>, shell=<span style="color: #008000;">True</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># add here new processes to check...</span></pre></div></div>

<p>On peut imaginer mettre un <a href="http://docs.python.org/library/email-examples.html">sendmail</a> pour se voir notifier lors de la mort d&#8217;un process et ainsi briller en soirées mondaines lorsque votre téléphone vous bippe sous le nom de Jarvis vous avertissant de la mort prématurée de lighttpd suite à votre toute dernière super config que vous avez pris soins de mettre en prod un vendredi soir sans vous soucier de la tester et ce juste avant de partir du bureau dont la clef est dans la poche du boss qui vient de se tirer en long weekend avec sa secrétaire&#8230;</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=672&amp;md5=bb7996b38d3bd82da1a252b4257c32c8" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/checker-ses-process-et-les-relancer-en-cas-de-plantage/feed/</wfw:commentRss>
		<slash:comments>6</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fchecker-ses-process-et-les-relancer-en-cas-de-plantage%2F&amp;language=en_GB&amp;category=text&amp;title=Checker+ses+process+et+les+relancer+en+cas+de+plantage&amp;description=J%26%238217%3Bai+quelques+scripts+qui+se+mettent+%C3%A0+planter+des+fois%2C+je+sais+que+c%26%238217%3Best+parceque+je+les+ai+cod%C3%A9+comme+un+gros+porc+mais+%C3%A7a+m%26%238217%3Bemmerde+de+les+refaires+parceque...&amp;tags=check%2Cmonitoring%2Cprocess%2Cpython%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2012/05/fail-owned-windows-fail.jpeg" length="31383" type="image/jpg" />	</item>
		<item>
		<title>Vérifier la RAM que consomme un process sous Linux avec pmap</title>
		<link>http://sametmax.com/verifier-la-ram-que-consome-un-process-sous-linux-avec-pmap/</link>
		<comments>http://sametmax.com/verifier-la-ram-que-consome-un-process-sous-linux-avec-pmap/#comments</comments>
		<pubDate>Thu, 10 May 2012 00:30:09 +0000</pubDate>
		<dc:creator>Max</dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[pmap]]></category>
		<category><![CDATA[process]]></category>
		<category><![CDATA[ramp]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=583</guid>
		<description><![CDATA[Comment savoir la quantité de RAM utilisée par vos process ? Avec pmap bien sûr !
Traquer les process les plus gourmants et optimisez la consommation de vos ressources serveur.]]></description>
			<content:encoded><![CDATA[<p>Des fois on a son serveur qui swap à mort, tout ralentie, votre site vaut plus rien, vous êtes désespéré, c&#8217;est la faute à tout le monde sauf vous, etc&#8230; Sauf que vous avez fait un script qui check rien du tout, qui lance des process externes qui buguent 2 fois sur 3, votre script tout pourri a alors bouffé toute la RAM, ne laissant rien aux autres process, le système swap à mort, c&#8217;est le drame&#8230;</p>
<p>Avec pmap vous pouvez connaitre la mémoire utilisée par un process, très pratique pour dénicher qui consomme et remonter à la source.</p>
<p>Un petit ps aux pour connaitre l&#8217;id de votre process à espionner ou à défaut un <a title="htop – un visualiseur interactif de process" href="http://sametmax.com/htop-un-visualiseur-interactif-de-process/">htop</a>:</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">ps</span> aux <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">grep</span> redis
redis    <span style="color: #000000;">23777</span>  <span style="color: #000000;">0.1</span>  <span style="color: #000000;">6.8</span>  <span style="color: #000000;">72480</span> <span style="color: #000000;">70708</span> ?        Ss   01:<span style="color: #000000;">15</span>   <span style="color: #000000;">0</span>:03 <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>sbin<span style="color: #000000; font-weight: bold;">/</span>redis-server <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>redis.conf</pre></div></div>

<p>Ensuite on passe l&#8217;ID à pmap:</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;">pmap <span style="color: #000000;">23777</span>
<span style="color: #000000;">23777</span>:   <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>sbin<span style="color: #000000; font-weight: bold;">/</span>redis-server <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>redis.conf
0089a000    108K r-x--  <span style="color: #000000; font-weight: bold;">/</span>lib<span style="color: #000000; font-weight: bold;">/</span>ld-<span style="color: #000000;">2.5</span>.so
...
bf9d5000     84K rw---    <span style="color: #7a0874; font-weight: bold;">&#91;</span> stack <span style="color: #7a0874; font-weight: bold;">&#93;</span>
 total    72476K</pre></div></div>

<p>Redis occupe 72Mo de RAM. Dans mon cas c&#8217;est normal, celà correspond à mes valeurs de config.</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=583&amp;md5=443d2e09b049c62ce0f33a5717ea6369" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/verifier-la-ram-que-consome-un-process-sous-linux-avec-pmap/feed/</wfw:commentRss>
		<slash:comments>1</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fverifier-la-ram-que-consome-un-process-sous-linux-avec-pmap%2F&amp;language=en_GB&amp;category=text&amp;title=V%C3%A9rifier+la+RAM+que+consomme+un+process+sous+Linux+avec+pmap&amp;description=Des+fois+on+a+son+serveur+qui+swap+%C3%A0+mort%2C+tout+ralentie%2C+votre+site+vaut+plus+rien%2C+vous+%C3%AAtes+d%C3%A9sesp%C3%A9r%C3%A9%2C+c%26%238217%3Best+la+faute+%C3%A0+tout+le+monde+sauf+vous%2C+etc%26%238230%3B...&amp;tags=pmap%2Cprocess%2Cramp%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2012/05/mug.png" length="19027" type="image/jpg" />	</item>
		<item>
		<title>htop &#8211; un visualiseur interactif de process</title>
		<link>http://sametmax.com/htop-un-visualiseur-interactif-de-process/</link>
		<comments>http://sametmax.com/htop-un-visualiseur-interactif-de-process/#comments</comments>
		<pubDate>Wed, 18 Apr 2012 08:36:26 +0000</pubDate>
		<dc:creator>Max</dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[console]]></category>
		<category><![CDATA[htop]]></category>
		<category><![CDATA[process]]></category>
		<category><![CDATA[viewer]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=422</guid>
		<description><![CDATA[Htop est une sorte de top super vitaminé, très pratique pour visualiser en temps réél les process qui bouffent le plus de RAM ou de CPU, permet aussi de savoir où en est l'état de sa RAM et bien d'autres choses.]]></description>
			<content:encoded><![CDATA[<p>Htop est une sorte de top super vitaminé, très pratique pour visualiser en temps réél les process qui bouffent le plus de RAM ou de CPU, permet aussi de savoir où en est l&#8217;état de sa RAM et bien d&#8217;autres choses.</p>
<p>Pour l&#8217;install vous pouvez essayer un &#8220;yum install htop&#8221; ou aller sur le site et compiler la version proposée: <a href="http://htop.sourceforge.net/">http://htop.sourceforge.net/</a></p>
<p>Si vous voulez le compiler:<br />
Téléchargez la source ici : <a href="http://sourceforge.net/projects/htop/">http://sourceforge.net/projects/htop/</a></p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">tar</span> xvf htop-1.0.1.tar.gz
<span style="color: #7a0874; font-weight: bold;">cd</span> htop-1.0.1
.<span style="color: #000000; font-weight: bold;">/</span>configure
<span style="color: #c20cb9; font-weight: bold;">make</span> <span style="color: #000000; font-weight: bold;">&amp;&amp;</span> <span style="color: #c20cb9; font-weight: bold;">make</span> <span style="color: #c20cb9; font-weight: bold;">install</span></pre></div></div>

<p><a href="http://sametmax.com/wp-content/uploads/2012/04/htop-0.5.png"><img src="http://sametmax.com/wp-content/uploads/2012/04/htop-0.5.png" alt="" title="htop-0.5" width="597" height="338" class="alignnone size-full wp-image-423" /></a></p>
<p>Quelques options interressantes:</p>
<ul>
<li>Trier par charge CPU: SHIFT + P</li>
<li>Killer un process: Sélectionner le process à tuer avec ESPACE, ensuite CMD + F9 et sélectionner le mode SIGKILL à gauche</li>
<li>Afficher l&#8217;arboresence des process: F5</li>
<li>Trier par RAM utilisée: SHIFT + M</li>
<li>Afficher l&#8217;aide: H</li>
<li>Rechercher un process: CMD + F3</li>
</ul>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=422&amp;md5=642f8ddfef35681989e7b80458cc445e" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/htop-un-visualiseur-interactif-de-process/feed/</wfw:commentRss>
		<slash:comments>5</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fhtop-un-visualiseur-interactif-de-process%2F&amp;language=en_GB&amp;category=text&amp;title=htop+%26%238211%3B+un+visualiseur+interactif+de+process&amp;description=Htop+est+une+sorte+de+top+super+vitamin%C3%A9%2C+tr%C3%A8s+pratique+pour+visualiser+en+temps+r%C3%A9%C3%A9l+les+process+qui+bouffent+le+plus+de+RAM+ou+de+CPU%2C+permet+aussi+de+savoir...&amp;tags=console%2Chtop%2Cprocess%2Cviewer%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2012/04/htop-0.5.png" length="200153" type="image/jpg" />	</item>
	</channel>
</rss>
