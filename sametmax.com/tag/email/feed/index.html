<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Sam &#38; Max: Python, Django, Git et du cul &#187; email</title>
	<atom:link href="http://sametmax.com/tag/email/feed/" rel="self" type="application/rss+xml" />
	<link>http://sametmax.com</link>
	<description>Deux développeurs en vadrouille qui se sortent les doigts du code</description>
	<lastBuildDate>Wed, 05 Feb 2014 14:20:37 +0000</lastBuildDate>
	<language>en</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>http://wordpress.org/?v=3.3.1</generator>
	<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2F&amp;language=en_US&amp;category=text&amp;title=Sam+%26amp%3B+Max%3A+Python%2C+Django%2C+Git+et+du+cul&amp;description=Deux+d%C3%A9veloppeurs+en+vadrouille+qui+se+sortent+les+doigts+du+code&amp;tags=blog" type="text/html" />
		<item>
		<title>Pardon aux familles, tout ça</title>
		<link>http://sametmax.com/pardon-aux-familles-tout-ca/</link>
		<comments>http://sametmax.com/pardon-aux-familles-tout-ca/#comments</comments>
		<pubDate>Tue, 12 Mar 2013 10:08:57 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Philo et culture]]></category>
		<category><![CDATA[email]]></category>
		<category><![CDATA[meta]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=5387</guid>
		<description><![CDATA[Voulant faire de la place pour la blockchain de Bitcoin qui prend 6Go (la salope), j'ai fais du tri dans les emails.]]></description>
			<content:encoded><![CDATA[<p>Voulant faire de la place pour la blockchain de Bitcoin qui prend 6Go (la salope), j&#8217;ai fais du tri dans les emails.</p>
<p>Par tri j&#8217;entends que j&#8217;ai accidentellement effacé tous les mails de la boîte aux lettre de Sam Et Max. L&#8217;IMAP est taquin.</p>
<p>Donc, à tous ceux qui nous ont écrit dernièrement, renvoyez-les nous, car on ne peut pas vous répondre.</p>
<p>Désolé. C&#8217;est not&#8217; fot&#8217;. Nan. C&#8217;est MA faute.</p>
<p>Je pense particulièrement aux mails de questions et le très gentil mail disant qu&#8217;on était trop cool mais que le tableau des niveaux de log était pas dans le bon ordre.</p>
<p>Ce que je n&#8217;ai pas compris d&#8217;ailleurs car :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #dc143c;">logging</span>.<span style="color: black;">DEBUG</span>
<span style="color: #ff4500;">10</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #dc143c;">logging</span>.<span style="color: black;">INFO</span>
<span style="color: #ff4500;">20</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #dc143c;">logging</span>.<span style="color: black;">WARNING</span>
<span style="color: #ff4500;">30</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #dc143c;">logging</span>.<span style="color: black;">ERROR</span>
<span style="color: #ff4500;">40</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #dc143c;">logging</span>.<span style="color: black;">CRITICAL</span>
<span style="color: #ff4500;">50</span></pre></div></div>

<p>Bref, tout ça pour dire que ce n&#8217;est pas qu&#8217;on veut pas vous répondre, c&#8217;est qu&#8217;on peut pas. Renvoyez tout !</p>
<div id="attachment_5389" class="wp-caption aligncenter" style="width: 330px"><a href="http://sametmax.com/wp-content/uploads/2013/03/x1gzuBb.gif"><img class="size-full wp-image-5389" title="Et il fonce vers un disque dur avec plus de place et un monde moins de souci. Il s'approche. Il sauuuuuuuuuuuuuuuuute !" src="http://sametmax.com/wp-content/uploads/2013/03/x1gzuBb.gif" alt="Gif animé d'un enfant qui saute dans une piscine et la rate" width="320" height="240" /></a><p class="wp-caption-text">Et il fonce vers un disque dur avec plus de place et un monde moins de souci. Il s&#39;approche. Il sauuuuuuuuuuuuuuuuute !</p></div>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=5387&amp;md5=79974e11820d7aa44a35560816b02c25" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/pardon-aux-familles-tout-ca/feed/</wfw:commentRss>
		<slash:comments>8</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fpardon-aux-familles-tout-ca%2F&amp;language=en_GB&amp;category=text&amp;title=Pardon+aux+familles%2C+tout+%C3%A7a&amp;description=Voulant+faire+de+la+place+pour+la+blockchain+de+Bitcoin+qui+prend+6Go+%28la+salope%29%2C+j%26%238217%3Bai+fais+du+tri+dans+les+emails.+Par+tri+j%26%238217%3Bentends+que+j%26%238217%3Bai+accidentellement+effac%C3%A9+tous...&amp;tags=email%2Cmeta%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/03/tumblr_miw88ffOaH1r539hzo1_1280.jpg" length="81312" type="image/jpg" />	</item>
		<item>
		<title>Envoi d&#8217;un email par logging en cas de plantage d&#8217;un script python (ou: comment faire bouffer u&#8221;\xe9&#8243; à SMTPHandler)</title>
		<link>http://sametmax.com/envoi-dun-email-par-logging-en-cas-de-plantage-dun-script-python-ou-comment-faire-bouffer-uxe9-a-smtphandler/</link>
		<comments>http://sametmax.com/envoi-dun-email-par-logging-en-cas-de-plantage-dun-script-python-ou-comment-faire-bouffer-uxe9-a-smtphandler/#comments</comments>
		<pubDate>Tue, 12 Mar 2013 08:48:23 +0000</pubDate>
		<dc:creator>etienne</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[callback]]></category>
		<category><![CDATA[email]]></category>
		<category><![CDATA[exception]]></category>
		<category><![CDATA[logguer]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=5313</guid>
		<description><![CDATA[(Ceci est un post invité d&#8217;un débutant pour les débutants&#8230; sous licence creative common 3.0 unported.) Il y a peu, je me suis mis à utiliser logging pour debugger mes scripts de débutant. Si comme moi vous avez l&#8217;habitude de mettre des print partout pour trouver l&#8217;origine d&#8217;un problème, et qu&#8217;ensuite vous avez passé de [...]]]></description>
			<content:encoded><![CDATA[<p><em>(Ceci est un post invité d&#8217;un débutant pour les débutants&#8230; sous licence <a href="http://creativecommons.org/licenses/by/3.0/">creative common 3.0 unported</a>.)</em></p>
<p>Il y a peu, je me suis mis à utiliser <code>logging</code> pour debugger mes scripts de débutant.</p>
<p>Si comme moi vous avez l&#8217;habitude de mettre des <code>print</code> partout pour trouver l&#8217;origine d&#8217;un problème, et qu&#8217;ensuite vous avez passé de longues longues longues minutes/heures à traquer ces foutus <code>print</code> pour dépolluer la sortie console, jetez un oeil à <a href="http://sametmax.com/ecrire-des-logs-en-python/">écrire des logs en python</a>.</p>
<p>Après quelques (minutes/heures/jours) de prise en main (vite, quoi&#8230;), on se demande comment on a fait pour s&#8217;en passer si longtemps. C&#8217;est simple, je n&#8217;utilise plus les touches &#8220;p&#8221;, &#8220;r&#8221;, &#8220;i&#8221;, &#8220;n&#8221; et &#8220;t&#8221; de mon clavier. Elles sont toutes propres.</p>
<p>En plus, <code>logging</code> m&#8217;a ouvert de nouvelles perspectives, parmi lesquelles la possibilité d&#8217;envoyer les logs par mail. Pas besoin de tout recevoir par mail, mais si ce foutu script de m%@rde pouvait m&#8217;envoyer un email quand il plante avec la source détaillé du problème, ce serait super.</p>
<h2>Log post mortem par email</h2>
<p>Admettons que vous vouliez vérifier que les pensées qui vous traversent l&#8217;esprit sont safe for work. Vous écrivez un script génial qui fait le boulot.</p>
<p>Comme vous commencez à savoir y faire en python, vous avez même écrit votre propre exception à vous tout seul&#8230;</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">class</span> NotSafeForWorkError<span style="color: black;">&#40;</span><span style="color: #008000;">Exception</span><span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;
    Exception soulevée si une pensée est NSFW
    &quot;&quot;&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__init__</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, msg<span style="color: black;">&#41;</span>:
        <span style="color: #008000;">self</span>.<span style="color: black;">msg</span> = u<span style="color: #483d8b;">&quot;Danger! %s est NSFW.&quot;</span> <span style="color: #66cc66;">%</span> msg
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__str__</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">self</span>.<span style="color: black;">msg</span>.<span style="color: black;">encode</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;utf-8&quot;</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># liste des pensées proscrites</span>
<span style="color: #808080; font-style: italic;"># (échantillon, elle est beaucoup plus longue que ça en réalité)</span>
NSFW = <span style="color: black;">&#91;</span><span style="color: #483d8b;">&quot;cul&quot;</span>, <span style="color: #483d8b;">&quot;seins&quot;</span>, <span style="color: #483d8b;">&quot;sametmax&quot;</span><span style="color: black;">&#93;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># boucle de censure qui soulève une exception si une pensée déconne</span>
<span style="color: #ff7700;font-weight:bold;">for</span> pensee <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: black;">&#91;</span><span style="color: #483d8b;">&quot;pause&quot;</span>, <span style="color: #483d8b;">&quot;pipi&quot;</span>, <span style="color: #483d8b;">&quot;sametmax&quot;</span><span style="color: black;">&#93;</span>:
    <span style="color: #ff7700;font-weight:bold;">if</span> pensee <span style="color: #ff7700;font-weight:bold;">in</span> NSFW:
        <span style="color: #ff7700;font-weight:bold;">raise</span> NotSafeForWorkError<span style="color: black;">&#40;</span>pensee<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">print</span> u<span style="color: #483d8b;">&quot;%s est SFW&quot;</span> <span style="color: #66cc66;">%</span> pensee
&nbsp;
<span style="color: #808080; font-style: italic;">#sortie:</span>
<span style="color: #808080; font-style: italic;">## pause est SFW</span>
<span style="color: #808080; font-style: italic;">## pipi est SFW</span>
<span style="color: #808080; font-style: italic;">## Traceback (most recent call last):</span>
<span style="color: #808080; font-style: italic;">##   File &quot;censure_setm3.py&quot;, line 30, in</span>
<span style="color: #808080; font-style: italic;">##     raise NotSafeForWorkError(pensee)</span>
<span style="color: #808080; font-style: italic;">## __main__.NotSafeForWorkError: Danger! sametmax est NSFW.</span></pre></div></div>

<p>Ça marche du tonnerre! C&#8217;est là que vous vous dites que ce serait bien si le script envoyait le traceback par email à votre psy pour le prévenir que vous avez déconné.</p>
<p>A la maison, vous avez lu l&#8217;article de Sam sur les <a href="http://sametmax.com/log-post-mortem-avec-python/">logs post mortem</a>. Ça a l&#8217;air facile à faire.</p>
<p>Vous créez d&#8217;abord un logger qui enverra les logs de niveau critique par mail:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">logging</span>
<span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">logging</span>.<span style="color: black;">handlers</span> <span style="color: #ff7700;font-weight:bold;">import</span> SMTPHandler
&nbsp;
nom_loggeur = <span style="color: #483d8b;">&quot;test_nsfw&quot;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># On crée un logger et on met le niveau à critique:</span>
<span style="color: #808080; font-style: italic;">#  il ne tiendra compte que des logs de ce niveau</span>
logger = <span style="color: #dc143c;">logging</span>.<span style="color: black;">getLogger</span><span style="color: black;">&#40;</span>nom_loggeur<span style="color: black;">&#41;</span>
logger.<span style="color: black;">setLevel</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">logging</span>.<span style="color: black;">CRITICAL</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># On crée le handler en lui passant les paramètres</span>
<span style="color: #808080; font-style: italic;">#  nécessaires à l'envoi d'un email</span>
mail_handler = SMTPHandler<span style="color: black;">&#40;</span>
    <span style="color: #808080; font-style: italic;"># Host et port</span>
    <span style="color: black;">&#40;</span><span style="color: #483d8b;">'SMTP.GMAIL.COM'</span>, <span style="color: #ff4500;">587</span><span style="color: black;">&#41;</span>,
    <span style="color: #808080; font-style: italic;"># From</span>
    <span style="color: #483d8b;">&quot;MOI@GMAIL.COM&quot;</span>,
    <span style="color: #808080; font-style: italic;"># To (liste)</span>
    <span style="color: black;">&#91;</span><span style="color: #483d8b;">&quot;QUELQU.UN@QUELQUE.PART&quot;</span><span style="color: black;">&#93;</span>,
    <span style="color: #808080; font-style: italic;"># Sujet du message</span>
    <span style="color: #483d8b;">&quot;Erreur critique dans %s&quot;</span> <span style="color: #66cc66;">%</span> nom_loggeur,
    <span style="color: #808080; font-style: italic;"># pour l'authentification</span>
    credentials = <span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;MONEMAIL@GMAIL.COM&quot;</span>, <span style="color: #483d8b;">&quot;MONSUPERPASSWORD&quot;</span><span style="color: black;">&#41;</span>,
    secure = <span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># On met le handler à &quot;critique&quot;.</span>
<span style="color: #808080; font-style: italic;"># Il enverra donc par mail les messages de ce niveau</span>
mail_handler.<span style="color: black;">setLevel</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">logging</span>.<span style="color: black;">CRITICAL</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># On définit un formatter: date, nom du logger, niveau, message</span>
<span style="color: #dc143c;">formatter</span> = <span style="color: #dc143c;">logging</span>.<span style="color: black;">Formatter</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># On associe le formatter au handler:</span>
<span style="color: #808080; font-style: italic;">#  c'est lui qui formatera les logs de ce handler</span>
mail_handler.<span style="color: black;">setFormatter</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">formatter</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># ... et on associe le handler au logger:</span>
<span style="color: #808080; font-style: italic;">#  il utilisera ce handler, qui émettra les logs critiques</span>
logger.<span style="color: black;">addHandler</span><span style="color: black;">&#40;</span>mail_handler<span style="color: black;">&#41;</span></pre></div></div>

<p>Ensuite vous redéfinissez sys.excepthook de manière à ce que l&#8217;exception soit logguée. La fonction convertit le traceback en string, la loggue au niveau critique et laisse l&#8217;exception continuer son chemin.</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">sys</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># la fonction qui remplacera sys.excepthook</span>
<span style="color: #ff7700;font-weight:bold;">def</span> en_cas_de_plantage<span style="color: black;">&#40;</span>type_except, value, tb<span style="color: black;">&#41;</span>:
&nbsp;
    <span style="color: #808080; font-style: italic;"># Traceback permettra de formater l'exception.</span>
    <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">traceback</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># Mise en forme de l'exception. Retourne la trace</span>
    <span style="color: #808080; font-style: italic;">#  sous forme de str avec numéros de lignes et tout</span>
    trace = <span style="color: #483d8b;">&quot;&quot;</span>.<span style="color: black;">join</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">traceback</span>.<span style="color: black;">format_exception</span><span style="color: black;">&#40;</span>type_except, value, tb<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># On loggue l'exception au niveau &quot;critique&quot;,</span>
    <span style="color: #808080; font-style: italic;">#  elle sera donc envoyée par email</span>
    logger.<span style="color: black;">critical</span><span style="color: black;">&#40;</span>u<span style="color: #483d8b;">&quot;Erreur inattendue:<span style="color: #000099; font-weight: bold;">\n</span>%s&quot;</span>, trace<span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># ... et on laisse le script se planter...</span>
    <span style="color: #dc143c;">sys</span>.__excepthook__<span style="color: black;">&#40;</span>type_except, value, tb<span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># on remplace sys.excepthook, et le tour est joué</span>
    <span style="color: #dc143c;">sys</span>.<span style="color: black;">excepthook</span> = en_cas_de_plantage</pre></div></div>

<p>Et voilà. Vous lancez le script, il se casse la gueule dès qu&#8217;il rencontre &#8220;sametmax&#8221;, votre psy reçoit un email avec le traceback, c&#8217;est cool.</p>
<p>Sauf que&#8230;</p>
<h2>SMTPHandler ne gère pas unicode</h2>
<p>Si au moment de la création de mail_handler, vous passez comme sujet à SMTPHandler:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">u<span style="color: #483d8b;">&quot;%s s'est planté&quot;</span> <span style="color: #66cc66;">%</span> nom_loggeur</pre></div></div>

<p>ou que dans votre fonction &#8220;en_cas_de_plantage&#8221; vous mettez:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">logger.<span style="color: black;">critical</span><span style="color: black;">&#40;</span>u<span style="color: #483d8b;">&quot;Bébé a encore glissé dans son caca:<span style="color: #000099; font-weight: bold;">\n</span>%s&quot;</span>, trace<span style="color: black;">&#41;</span></pre></div></div>

<p>&#8230; autrement dit si vous avez une chaîne unicode qui ne peut pas être encodée en ascii, ça va pas marcher:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">Traceback <span style="color: black;">&#40;</span>most recent call last<span style="color: black;">&#41;</span>:
  File <span style="color: #483d8b;">&quot;envoie_mail_on_crash.py&quot;</span>, line <span style="color: #ff4500;">84</span>, <span style="color: #ff7700;font-weight:bold;">in</span> emit
    smtp.<span style="color: black;">sendmail</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">fromaddr</span>, <span style="color: #008000;">self</span>.<span style="color: black;">toaddrs</span>, msg<span style="color: black;">&#41;</span>
  File <span style="color: #483d8b;">&quot;/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/smtplib.py&quot;</span>, line <span style="color: #ff4500;">734</span>, <span style="color: #ff7700;font-weight:bold;">in</span> sendmail
    <span style="color: black;">&#40;</span><span style="color: #dc143c;">code</span>, resp<span style="color: black;">&#41;</span> = <span style="color: #008000;">self</span>.<span style="color: black;">data</span><span style="color: black;">&#40;</span>msg<span style="color: black;">&#41;</span>
  File <span style="color: #483d8b;">&quot;/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/smtplib.py&quot;</span>, line <span style="color: #ff4500;">501</span>, <span style="color: #ff7700;font-weight:bold;">in</span> data
    <span style="color: #008000;">self</span>.<span style="color: black;">send</span><span style="color: black;">&#40;</span>q<span style="color: black;">&#41;</span>
  File <span style="color: #483d8b;">&quot;/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/smtplib.py&quot;</span>, line <span style="color: #ff4500;">321</span>, <span style="color: #ff7700;font-weight:bold;">in</span> send
    <span style="color: #008000;">self</span>.<span style="color: black;">sock</span>.<span style="color: black;">sendall</span><span style="color: black;">&#40;</span><span style="color: #008000;">str</span><span style="color: black;">&#41;</span>
  File <span style="color: #483d8b;">&quot;/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/ssl.py&quot;</span>, line <span style="color: #ff4500;">229</span>, <span style="color: #ff7700;font-weight:bold;">in</span> sendall
    v = <span style="color: #008000;">self</span>.<span style="color: black;">send</span><span style="color: black;">&#40;</span>data<span style="color: black;">&#91;</span>count:<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
  File <span style="color: #483d8b;">&quot;/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/ssl.py&quot;</span>, line <span style="color: #ff4500;">198</span>, <span style="color: #ff7700;font-weight:bold;">in</span> send
    v = <span style="color: #008000;">self</span>._sslobj.<span style="color: black;">write</span><span style="color: black;">&#40;</span>data<span style="color: black;">&#41;</span>
<span style="color: #008000;">UnicodeEncodeError</span>: <span style="color: #483d8b;">'ascii'</span> codec can<span style="color: #483d8b;">'t encode character u'</span>\xe9<span style="color: #483d8b;">' in position 62: ordinal not in range(128)
Logged from file envoie_mail_on_crash.py, line 163</span></pre></div></div>

<p>D&#8217;où l&#8217;on déduit qu&#8217;il y a une tentative foirée d&#8217;encodage d&#8217;une chaîne unicode en ascii par la méthode &#8220;write&#8221; de ce mystérieux _sslobj, et que c&#8217;est une méthode &#8220;emit&#8221; quelque part dans handlers.py qui lui a passé la chaîne.</p>
<p>Fuck! Investiguons. Et essayons de régler ça par le haut de la pile.</p>
<h2>Toi, là au fond! Oui, toi!</h2>
<p>C&#8217;est la methode <code>emit</code> de SMTPHandler qui est responsable. Elle fait quoi cette méthode? Elle formate le &#8220;record&#8221;, crée un message et l&#8217;envoie à l&#8217;adresse mail spécifiée. Voilà le code:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> emit<span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, record<span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;
    Emit a record.
&nbsp;
    Format the record and send it to the specified addressees.
    &quot;&quot;&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">try</span>:
        <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">smtplib</span>
        <span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">email</span>.<span style="color: black;">utils</span> <span style="color: #ff7700;font-weight:bold;">import</span> formatdate
        port = <span style="color: #008000;">self</span>.<span style="color: black;">mailport</span>
        <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #ff7700;font-weight:bold;">not</span> port:
            port = <span style="color: #dc143c;">smtplib</span>.<span style="color: black;">SMTP_PORT</span>
        smtp = <span style="color: #dc143c;">smtplib</span>.<span style="color: black;">SMTP</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">mailhost</span>, port<span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># C'est ici l'objet &quot;record&quot; est formatté</span>
        msg = <span style="color: #008000;">self</span>.<span style="color: black;">format</span><span style="color: black;">&#40;</span>record<span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># Le message est construit ici. Il sera ensuite envoyé par smtp.sendmail</span>
        <span style="color: #808080; font-style: italic;"># C'est là que le bât blesse</span>
        msg = <span style="color: #483d8b;">&quot;From: %s<span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span>To: %s<span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span>Subject: %s<span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span>Date: %s<span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span><span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span>%s&quot;</span> <span style="color: #66cc66;">%</span> <span style="color: black;">&#40;</span>
                        <span style="color: #008000;">self</span>.<span style="color: black;">fromaddr</span>,
                        <span style="color: #483d8b;">&quot;,&quot;</span>.<span style="color: black;">join</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">toaddrs</span><span style="color: black;">&#41;</span>,
                        <span style="color: #808080; font-style: italic;"># Notons ce getSubject(record). La méthode renvoie</span>
                        <span style="color: #808080; font-style: italic;">#  le sujet du message, passé à la création</span>
                        <span style="color: #808080; font-style: italic;">#  de mail_handler</span>
                        <span style="color: #008000;">self</span>.<span style="color: black;">getSubject</span><span style="color: black;">&#40;</span>record<span style="color: black;">&#41;</span>,
                        formatdate<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>,
                        <span style="color: #808080; font-style: italic;"># le record formaté</span>
                        msg<span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #008000;">self</span>.<span style="color: black;">username</span>:
            <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #008000;">self</span>.<span style="color: black;">secure</span> <span style="color: #ff7700;font-weight:bold;">is</span> <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #008000;">None</span>:
                smtp.<span style="color: black;">ehlo</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
                smtp.<span style="color: black;">starttls</span><span style="color: black;">&#40;</span><span style="color: #66cc66;">*</span><span style="color: #008000;">self</span>.<span style="color: black;">secure</span><span style="color: black;">&#41;</span>
                smtp.<span style="color: black;">ehlo</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
            smtp.<span style="color: black;">login</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">username</span>, <span style="color: #008000;">self</span>.<span style="color: black;">password</span><span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># Le mail et envoyé</span>
        smtp.<span style="color: black;">sendmail</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">fromaddr</span>, <span style="color: #008000;">self</span>.<span style="color: black;">toaddrs</span>, msg<span style="color: black;">&#41;</span>
&nbsp;
        smtp.<span style="color: black;">quit</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: black;">&#40;</span><span style="color: #008000;">KeyboardInterrupt</span>, <span style="color: #008000;">SystemExit</span><span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">raise</span>
    <span style="color: #ff7700;font-weight:bold;">except</span>:
        <span style="color: #008000;">self</span>.<span style="color: black;">handleError</span><span style="color: black;">&#40;</span>record<span style="color: black;">&#41;</span></pre></div></div>

<p>Qu&#8217;est-ce qu&#8217;il se passe?</p>
<p>Après quelques tests genre:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">    msg = <span style="color: #008000;">self</span>.<span style="color: black;">format</span><span style="color: black;">&#40;</span>record<span style="color: black;">&#41;</span>
    <span style="color: #808080; font-style: italic;"># C'est pratique parfois un petit print</span>
    <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #008000;">type</span><span style="color: black;">&#40;</span>msg<span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;">##</span></pre></div></div>

<p>&#8230; on voit que la méthode <code>format</code> (qui structure votre log selon la forme passée à logging.Formatter) retourne un objet de type unicode si le message que vous avez loggué (<code>logger.critical(u"% foiré!", trace)</code>) contient de l&#8217;unicode.</p>
<p>Idem pour <code>getSubject(record)</code> qui, en l&#8217;état, ne fait que retourner le sujet du email tel que vous l&#8217;avez passé à l&#8217;instanciation de SMTPHandler.</p>
<p>Donc, quand msg est formaté, si le log ou le message sont en unicode, msg sera en unicode.</p>
<h2>WTF!?</h2>
<p>J&#8217;ai été surpris quand j&#8217;ai fini par piger comment ça fonctionne. Même pour un débutant comme moi ça a l&#8217;air bête.</p>
<p>J&#8217;y connais rien en email, mais il ne m&#8217;a pas fallu longtemps pour comprendre que, dans sa forme basique, un email c&#8217;est du ascii, point. Et que si on veut envoyer autre chose que du ascii, qui soit décodable de l&#8217;autre côté, il faut qu&#8217;il y ait les headers appropriés, que le contenu soit encodé, que sais-je encore&#8230;</p>
<p>Peut-être un truc programmé par des gars qui ne manipulent jamais autre chose que de l&#8217;anglais? Ils auraient essayé d&#8217;envoyer un mail en russes ou en suédois, ça se serait planté au premier test. Oui, oui, Sam, la lingua franca, tout ça&#8230;</p>
<p>Ou alors c&#8217;est pour des questions de compatibilité avec des versions antérieures de python qui ne contiendraient pas les ressources nécessaires pour formater correctement un mail? Aucune idée&#8230;</p>
<p>Comment régler ça?</p>
<h2>Il mangea u&#8221;\xe9&#8243; et il en redemanda</h2>
<p>Le module <a href="http://docs.python.org/2/library/email.html"> email </a> de la lib standard permet de créer des emails. On trouve dans <code>email.mime</code> une classe MIMEText qui nous conviendra parfaitement. On va donc subclasser SMTPHandler et réécrire la méthode <code>emit</code> pour qu&#8217;elle construise un message &#8220;RFC-compliant&#8221;, comme ils disent dans la doc.</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">class</span> SMTPHandler_unicode<span style="color: black;">&#40;</span>SMTPHandler<span style="color: black;">&#41;</span>:
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> emit<span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, record<span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">try</span>:
            <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">smtplib</span>
            <span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">email</span>.<span style="color: black;">utils</span> <span style="color: #ff7700;font-weight:bold;">import</span> formatdate
&nbsp;
            <span style="color: #808080; font-style: italic;"># On importe MIMEText</span>
            <span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">email</span>.<span style="color: black;">mime</span>.<span style="color: black;">text</span> <span style="color: #ff7700;font-weight:bold;">import</span> MIMEText
&nbsp;
            port = <span style="color: #008000;">self</span>.<span style="color: black;">mailport</span>
            <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #ff7700;font-weight:bold;">not</span> port:
                port = <span style="color: #dc143c;">smtplib</span>.<span style="color: black;">SMTP_PORT</span> <span style="color: #808080; font-style: italic;"># 25</span>
            smtp = <span style="color: #dc143c;">smtplib</span>.<span style="color: black;">SMTP</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">mailhost</span>, port<span style="color: black;">&#41;</span>
&nbsp;
            msg = <span style="color: #008000;">self</span>.<span style="color: black;">format</span><span style="color: black;">&#40;</span>record<span style="color: black;">&#41;</span>
&nbsp;
            <span style="color: #808080; font-style: italic;"># Au moment de la création de l'objet par MIMEText,</span>
            <span style="color: #808080; font-style: italic;">#  si msg est de type unicode, il sera encodé</span>
            <span style="color: #808080; font-style: italic;">#  selon _charset, sinon il sera laissé tel quel</span>
            message = MIMEText<span style="color: black;">&#40;</span>msg, _charset = <span style="color: #483d8b;">&quot;utf-8&quot;</span><span style="color: black;">&#41;</span>
&nbsp;
            <span style="color: #808080; font-style: italic;"># On ajoute les headers nécessaires. S'il sont de type unicode,</span>
            <span style="color: #808080; font-style: italic;">#  ils seront encodés selon _charset</span>
            message.<span style="color: black;">add_header</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Subject&quot;</span>, <span style="color: #008000;">self</span>.<span style="color: black;">getSubject</span><span style="color: black;">&#40;</span>record<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
            message.<span style="color: black;">add_header</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;From&quot;</span>, <span style="color: #008000;">self</span>.<span style="color: black;">fromaddr</span><span style="color: black;">&#41;</span>
            message.<span style="color: black;">add_header</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;To&quot;</span>, <span style="color: #483d8b;">&quot;,&quot;</span>.<span style="color: black;">join</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">toaddrs</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
            message.<span style="color: black;">add_header</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Date&quot;</span>, formatdate<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
            <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #008000;">self</span>.<span style="color: black;">username</span>:
                <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #008000;">self</span>.<span style="color: black;">secure</span> <span style="color: #ff7700;font-weight:bold;">is</span> <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #008000;">None</span>:
                    smtp.<span style="color: black;">ehlo</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
                    smtp.<span style="color: black;">starttls</span><span style="color: black;">&#40;</span><span style="color: #66cc66;">*</span><span style="color: #008000;">self</span>.<span style="color: black;">secure</span><span style="color: black;">&#41;</span>
                    smtp.<span style="color: black;">ehlo</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
                smtp.<span style="color: black;">login</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">username</span>, <span style="color: #008000;">self</span>.<span style="color: black;">password</span><span style="color: black;">&#41;</span>
&nbsp;
            <span style="color: #808080; font-style: italic;"># Envoi du message proprement encodé</span>
            smtp.<span style="color: black;">sendmail</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">fromaddr</span>, <span style="color: #008000;">self</span>.<span style="color: black;">toaddrs</span>, message.<span style="color: black;">as_string</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
            smtp.<span style="color: black;">quit</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: black;">&#40;</span><span style="color: #008000;">KeyboardInterrupt</span>, <span style="color: #008000;">SystemExit</span><span style="color: black;">&#41;</span>:
            <span style="color: #ff7700;font-weight:bold;">raise</span>
        <span style="color: #ff7700;font-weight:bold;">except</span>:
            <span style="color: #008000;">self</span>.<span style="color: black;">handleError</span><span style="color: black;">&#40;</span>record<span style="color: black;">&#41;</span></pre></div></div>

<p>Ce qui est intéressant avec MIMEText c&#8217;est que si vous déclarez un encodage (<code>_charset = "utf-8"</code>), et que vous passez une chaîne unicode a l&#8217;instanciation, il l&#8217;encodera selon <code>_charset</code>.</p>
<p>Idem si vous ajoutez un header en appelant <code>add_header</code>, ce qui permet dans notre cas de traiter correctement le sujet du mail.</p>
<p>L&#8217;appel à la méthode <code>to_string</code> retournera le message proprement encodé (en base64) pour le transfert, et les headers appropriés seront inclus.</p>
<p>Voilà, il ne reste plus qu&#8217;à utiliser cette classe pour créer mail_handler, et le tour est joué.</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">mail_handler = SMTPHandler_unicode<span style="color: black;">&#40;</span>
    <span style="color: #808080; font-style: italic;"># host et port</span>
    <span style="color: black;">&#40;</span><span style="color: #483d8b;">'SMTP.GMAIL.COM'</span>, <span style="color: #ff4500;">587</span><span style="color: black;">&#41;</span>,
    <span style="color: #808080; font-style: italic;"># From</span>
    <span style="color: #483d8b;">&quot;MOI@GMAIL.COM&quot;</span>,
    <span style="color: #808080; font-style: italic;"># To (liste)s</span>
    <span style="color: black;">&#91;</span><span style="color: #483d8b;">&quot;QUELQU.UN@QUELQUE.PART&quot;</span><span style="color: black;">&#93;</span>,
    <span style="color: #808080; font-style: italic;"># sujet du message</span>
    u<span style="color: #483d8b;">&quot;Bonjour Mr Freud. %s a encore repéré des pensées génantes&quot;</span> <span style="color: #66cc66;">%</span> nom_loggeur,
    <span style="color: #808080; font-style: italic;"># pour l'authentification</span>
    credentials = <span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;MONEMAIL@GMAIL.COM&quot;</span>, <span style="color: #483d8b;">&quot;MONSUPERPASSWORD&quot;</span><span style="color: black;">&#41;</span>,
    secure = <span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: black;">&#41;</span></pre></div></div>

<p>Bilan de l&#8217;histoire: c&#8217;est en débutant qu&#8217;on devient débutant&#8230;</p>
<hr />
<a href="https://github.com/sametmax/codes-des-articles/blob/master/2013/mars/envoi_mail_on_crash.py">Télécharger le code de l&#8217;article.</a></p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=5313&amp;md5=2a70d8c9d9e3c74fb78760edd63af5f9" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/envoi-dun-email-par-logging-en-cas-de-plantage-dun-script-python-ou-comment-faire-bouffer-uxe9-a-smtphandler/feed/</wfw:commentRss>
		<slash:comments>9</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fenvoi-dun-email-par-logging-en-cas-de-plantage-dun-script-python-ou-comment-faire-bouffer-uxe9-a-smtphandler%2F&amp;language=en_GB&amp;category=text&amp;title=Envoi+d%26%238217%3Bun+email+par+logging+en+cas+de+plantage+d%26%238217%3Bun+script+python+%28ou%3A+comment+faire+bouffer+u%26%238221%3B%5Cxe9%26%238243%3B+%C3%A0+SMTPHandler%29&amp;description=%28Ceci+est+un+post+invit%C3%A9+d%26%238217%3Bun+d%C3%A9butant+pour+les+d%C3%A9butants%26%238230%3B+sous+licence+creative+common+3.0+unported.%29+Il+y+a+peu%2C+je+me+suis+mis+%C3%A0+utiliser+logging+pour+debugger+mes...&amp;tags=callback%2Cemail%2Cexception%2Clogguer%2Cpython%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/03/tu_va_me_le_bouffer_oui.jpg" length="45654" type="image/jpg" />	</item>
		<item>
		<title>Spamgourmet, mon amour</title>
		<link>http://sametmax.com/spamgourmet-mon-amour/</link>
		<comments>http://sametmax.com/spamgourmet-mon-amour/#comments</comments>
		<pubDate>Fri, 01 Mar 2013 09:55:34 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Philo et culture]]></category>
		<category><![CDATA[alias]]></category>
		<category><![CDATA[email]]></category>
		<category><![CDATA[spam]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=2640</guid>
		<description><![CDATA[Spamgourmet, que j'ai découvert grace à Sebsauvage, est un service d'alias d'emails. Vous donnez votre email à ce service, et vous pouvez ensuite distribuer des alias de cet email aux autres sites.]]></description>
			<content:encoded><![CDATA[<p><a href="http://www.spamgourmet.com">Spamgourmet</a>, que j&#8217;ai découvert grace à Sebsauvage, est un service gratuit et fiable d&#8217;alias d&#8217;emails. Vous donnez votre email à ce service, et vous pouvez ensuite distribuer des alias de cet email aux autres sites.</p>
<p>Exemple:</p>
<p>Je m&#8217;inscris sur Spamgourmet avec l&#8217;adresse <strong>contact@sametmax.com</strong> et le nom d&#8217;utilisateur <strong>sam</strong>.</p>
<p>Si un autre site me demande une adresse, au lieu de lui donner mon email, je lui un alias comme ça:</p>
<p><code>mot.un_numero.nom_utilisateur@spamgourmet.com</code></p>
<p>En alias je met souvent le nom du site, donc ça donne un truc comme ça:</p>
<p><code>sncf.5.sam@spamgourmet.com</code></p>
<p><strong>Vous n&#8217;avez rien besoin de faire pour créer cet alias.</strong> Il suffit de l&#8217;imaginer dans votre tête, et qu&#8217;il respecte la structure &#8220;mot.un_numero.nom_utilisateur@spamgourmet&#8221;.</p>
<p>Bref, vous donnez cet email imaginaire à tous les sites qui vous en demande un.</p>
<p>Quand spamgourmet va recevoir un email, il va envoyer une copie de cet email à votre adresse, la vraie, qu&#8217;il a retrouvé grâce au nom d&#8217;utilisateur (sncf.5.<strong>sam</strong>@spamgourmet.com).</p>
<p>Mais il va faire un truc en plus : il va regarder le numéro dans l&#8217;email (sncf.<strong>5</strong>.sam@spamgourmet.com). Si vous avez reçu plus de mails que le numéro, donc ici plus de 5 mails, sur cette adresse, spamgourmet ne vous enverra plus la copie.</p>
<p>C&#8217;est une version plus puissante des alias avec &#8220;+&#8221;.</p>
<p>Attention, le nombre max qu&#8217;on peut donner est 20. Mais si vous en voulez plus, alors c&#8217;est qu&#8217;il est temps de mettre votre véritable adresse email. Généralement je vais dans le formulaire de profile du site en question et change mon adresse pour la bonne à ce moment là, ou avec un alias en &#8220;+&#8221;.</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=2640&amp;md5=59e3418b5b87b1f7de09167ae2f55917" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/spamgourmet-mon-amour/feed/</wfw:commentRss>
		<slash:comments>10</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fspamgourmet-mon-amour%2F&amp;language=en_GB&amp;category=text&amp;title=Spamgourmet%2C+mon+amour&amp;description=Spamgourmet%2C+que+j%26%238217%3Bai+d%C3%A9couvert+grace+%C3%A0+Sebsauvage%2C+est+un+service+gratuit+et+fiable+d%26%238217%3Balias+d%26%238217%3Bemails.+Vous+donnez+votre+email+%C3%A0+ce+service%2C+et+vous+pouvez+ensuite+distribuer+des+alias+de...&amp;tags=alias%2Cemail%2Cspam%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/03/PFSZ1Sw.gif" length="289729" type="image/jpg" />	</item>
		<item>
		<title>Quelqu&#8217;un peut-il m&#8217;expliquer cet étrange phénomène mailistique ?</title>
		<link>http://sametmax.com/quelquun-peut-il-mexpliquer-cet-etrange-phenomene-mailistique/</link>
		<comments>http://sametmax.com/quelquun-peut-il-mexpliquer-cet-etrange-phenomene-mailistique/#comments</comments>
		<pubDate>Fri, 15 Feb 2013 10:08:52 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Philo et culture]]></category>
		<category><![CDATA[email]]></category>
		<category><![CDATA[meta]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=4556</guid>
		<description><![CDATA[Qu'est-ce donc cette diablerie ?]]></description>
			<content:encoded><![CDATA[<p>J&#8217;ai une adresse email en nomprenom@gmail.com (hé oui, <a href="http://sametmax.com/quitter-google-recherche-email-et-chat/">il m&#8217;en reste quelques unes</a>&#8230; Il faut dire que j&#8217;ai 7 emails, sans compter les alias, les antispam et les comptes bidons).</p>
<p>Par erreur, je m&#8217;inscris sur un service avec nom<span style="color: #ff0000;"><strong>.</strong></span>prenom@gmail.com. Notez le point, que mon adresse n&#8217;a PAS. Qu&#8217;elle n&#8217;a jamais eu. Je reçois régulièrement des mails à cette adresse SANS le point.</p>
<p>Malgré cela, je reçois le mail de confirmation d&#8217;inscription à nomprenom@gmail.com (la bonne, sans le point).</p>
<p>Dans le message, il y a clairement :</p>
<blockquote><p>has received a request to create a user account using your email address (nom<strong>.</strong>prenom@gmail.com).</p></blockquote>
<p>Je check les sources:</p>
<pre>Delivered-To: nom.prenom@gmail.com
Received: by IP_ADDRESS with SMTP id u10csp168283wja;
        Thu, 14 Feb 2013 05:48:57 -0800 (PST)
X-Received: by IP_ADDRESS with SMTP id xl7mr4158572pbc.167.1360849736470;
        Thu, 14 Feb 2013 05:48:56 -0800 (PST)
Return-Path: &lt;register@service.org&gt;
Received: from subdomaine.service.org (vbox17.service.org. [IP_ADDRESS])
        by mx.google.com with ESMTP id k8si8969185pax.IP_ADDRESS.05.48.55;
        Thu, 14 Feb 2013 05:48:56 -0800 (PST)
Received-SPF: pass (google.com: domain of register@service.org designates IP_ADDRESS as permitted sender) client-ip=IP_ADDRESS;
Authentication-Results: mx.google.com;
       spf=pass (google.com: domain of register@service.org designates IP_ADDRESS as permitted sender) smtp.mail=register@service.org
Received: from localhost (localhost.localdomain [IP_ADDRESS])
    by subdomaine.service.org (Postfix) with ESMTP id 94EBC769B5
    for &lt;nom.prenom@gmail.com&gt;; Thu, 14 Feb 2013 13:48:55 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at service.org
Received: from subdomaine.service.org ([IP_ADDRESS])
    by localhost (subdomaine.service.org [IP_ADDRESS]) (amavisd-new, port 10024)
    with ESMTP id FybIuo+abpEQ for &lt;nom.prenom@gmail.com&gt;;
    Thu, 14 Feb 2013 13:48:55 +0000 (UTC)
Received: from register-web.service.org (register-web-back [IP_ADDRESS])
    by subdomaine.service.org (Postfix) with ESMTP id 7A92976993
    for &lt;nom.prenom@gmail.com&gt;; Thu, 14 Feb 2013 13:48:55 +0000 (UTC)
Received: by register-web.service.org (Postfix, from userid 502)
    id 7695FEE8F3; Thu, 14 Feb 2013 13:48:54 +0000 (UTC)
From: register@service.org
To: nom.prenom@gmail.com</pre>
<p>Donc l&#8217;email a bien été envoyé à l&#8217;adresse AVEC le point.</p>
<p>WTF ?</p>
<p>&nbsp;</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=4556&amp;md5=5106b6114e2cf355a0343cbe73ea46aa" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/quelquun-peut-il-mexpliquer-cet-etrange-phenomene-mailistique/feed/</wfw:commentRss>
		<slash:comments>35</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fquelquun-peut-il-mexpliquer-cet-etrange-phenomene-mailistique%2F&amp;language=en_GB&amp;category=text&amp;title=Quelqu%26%238217%3Bun+peut-il+m%26%238217%3Bexpliquer+cet+%C3%A9trange+ph%C3%A9nom%C3%A8ne+mailistique+%3F&amp;description=J%26%238217%3Bai+une+adresse+email+en+nomprenom%40gmail.com+%28h%C3%A9+oui%2C+il+m%26%238217%3Ben+reste+quelques+unes%26%238230%3B+Il+faut+dire+que+j%26%238217%3Bai+7+emails%2C+sans+compter+les+alias%2C+les+antispam+et+les+comptes+bidons%29....&amp;tags=email%2Cmeta%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/02/postproblem02ts.jpg" length="19257" type="image/jpg" />	</item>
		<item>
		<title>Arf, on avait laissé l&#8217;ancien formulaire de contact</title>
		<link>http://sametmax.com/arf-on-avait-laisse-lancien-formulaire-de-contact/</link>
		<comments>http://sametmax.com/arf-on-avait-laisse-lancien-formulaire-de-contact/#comments</comments>
		<pubDate>Thu, 11 Oct 2012 15:53:48 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[email]]></category>
		<category><![CDATA[meta]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[virtualenv]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=2553</guid>
		<description><![CDATA[Le lien vers l'ancien formulaire de contact était toujours accessible, et du coup on a reçu un mail depuis celui-ci, alors qu'on ne peut pas y répondre.

C'est bon, on l'a viré.

En attendant, voici la mail, et la réponse.]]></description>
			<content:encoded><![CDATA[<p>Le lien vers l&#8217;ancien formulaire de contact était toujours accessible, et du coup on a reçu un mail depuis celui-ci, alors qu&#8217;<a href="http://sametmax.com/qui-nont-pas-eu-de-reponse-via-le-formulaire-de-contact-desole/">on ne peut pas y répondre</a>.</p>
<p>C&#8217;est bon, on l&#8217;a viré.</p>
<p>En attendant, voici le mail, et la réponse (je strip l&#8217;intro et la conclusion.):</p>
<blockquote><p>Je viens de lire le post sur virtualenv+django et je me disais qu&#8217;il existe un moyen différent, oserais-je dire plus propre (pas sur la tête pitié &#8230;),  de faire quasiment la même chose.</p>
<p>Je m&#8217;explique : je vois dans le script l&#8217;utilisation de workon, je ne me rappelle plus trop mais je crois que cette commande est amenée par virtualenvwrapper. Dans ce cas là, je voulais vous faire partager le contenu de quelques fichiers contenu dans mon dossier .virtualenvs.</p>
<p>Tout d&#8217;abord le fichier postactivate (hook fourni par virtualenvwrapper s&#8217;insérant après l&#8217;initialisation de l&#8217;environnement) :</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #007800;">PROJECT_PATH</span>=<span style="color: #ff0000;">&quot;<span style="color: #007800;">$PROJECT_HOME</span>&quot;</span><span style="color: #000000; font-weight: bold;">/</span><span style="color: #ff0000;">&quot;<span style="color: #007800;">$env_name</span>&quot;</span>
&nbsp;
<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#91;</span> <span style="color: #660033;">-a</span> <span style="color: #ff0000;">&quot;<span style="color: #007800;">$PROJECT_PATH</span>&quot;</span> <span style="color: #7a0874; font-weight: bold;">&#93;</span> ;<span style="color: #000000; font-weight: bold;">then</span>
    <span style="color: #7a0874; font-weight: bold;">cd</span> <span style="color: #ff0000;">&quot;<span style="color: #007800;">$PROJECT_PATH</span>&quot;</span>
<span style="color: #000000; font-weight: bold;">fi</span></pre></div></div>

<p>ce petit script permet de faire ce que tu décris dans le post, si jamais ton dossier contenant le projet ne se trouve pas à l&#8217;endroit défini par la variable d&#8217;environnement <code>$PROJECT_HOME</code>, il est possible d&#8217;overrider son comportement en modifiant <code>PROJECT_PATH</code> par le chemin que tu souhaite dans le fichier <em>.virtualenvs/nom_de_l&#8217;environnement/bin/postactivate</em></p>
<p>Voili voilou et sinon pour encore me faire mousser (mais pas trop hein), je voulais juste vous faire partager un autre script que je place dans postmkproject :</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #7a0874; font-weight: bold;">echo</span> <span style="color: #ff0000;">&quot;Create a django project y/n ?&quot;</span>
<span style="color: #000000; font-weight: bold;">while</span> <span style="color: #c20cb9; font-weight: bold;">true</span>
<span style="color: #000000; font-weight: bold;">do</span>
    <span style="color: #c20cb9; font-weight: bold;">read</span> INPUT
    <span style="color: #000000; font-weight: bold;">case</span> <span style="color: #ff0000;">&quot;<span style="color: #007800;">$INPUT</span>&quot;</span> <span style="color: #000000; font-weight: bold;">in</span>
        <span style="color: #ff0000;">&quot;y&quot;</span> <span style="color: #7a0874; font-weight: bold;">&#41;</span>
            <span style="color: #7a0874; font-weight: bold;">cd</span> <span style="color: #ff0000;">&quot;<span style="color: #007800;">$PROJECT_HOME</span>&quot;</span>
            <span style="color: #c20cb9; font-weight: bold;">rm</span> <span style="color: #660033;">-r</span> <span style="color: #ff0000;">&quot;<span style="color: #007800;">$envname</span>&quot;</span>
            pip <span style="color: #c20cb9; font-weight: bold;">install</span> django
            django-admin.py startproject <span style="color: #ff0000;">&quot;<span style="color: #007800;">$envname</span>&quot;</span>
            <span style="color: #7a0874; font-weight: bold;">cd</span> <span style="color: #ff0000;">&quot;<span style="color: #007800;">$envname</span>&quot;</span>
            <span style="color: #7a0874; font-weight: bold;">break</span>
            <span style="color: #000000; font-weight: bold;">;;</span>
        <span style="color: #ff0000;">&quot;n&quot;</span> <span style="color: #7a0874; font-weight: bold;">&#41;</span>
            <span style="color: #7a0874; font-weight: bold;">break</span>
            <span style="color: #000000; font-weight: bold;">;;</span>
    <span style="color: #000000; font-weight: bold;">esac</span>
<span style="color: #000000; font-weight: bold;">done</span></pre></div></div>

<p>En clair, ça demande à l&#8217;utilisateur si son projet sera un projet django, ça télécharge le framework via pip et cela créé directement le projet dans notre dossier <code>PROJECT_HOME</code>, en évitant d&#8217;avoir à créer un autre sous-dossier rien que pour notre application django.</p>
</blockquote>
<p>Bonjour l&#8217;ami,</p>
<p>Merci de l&#8217;info. Comme tu vois, on l&#8217;a fait passer. Quand tu as un truc comme ça à mettre, utilise les commentaires, ça en fait profiter tout le monde !</p>
<p>@+</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=2553&amp;md5=276e7f34e8bddc71832523d0ccf0ba63" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/arf-on-avait-laisse-lancien-formulaire-de-contact/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Farf-on-avait-laisse-lancien-formulaire-de-contact%2F&amp;language=en_GB&amp;category=text&amp;title=Arf%2C+on+avait+laiss%C3%A9+l%26%238217%3Bancien+formulaire+de+contact&amp;description=Le+lien+vers+l%26%238217%3Bancien+formulaire+de+contact+%C3%A9tait+toujours+accessible%2C+et+du+coup+on+a+re%C3%A7u+un+mail+depuis+celui-ci%2C+alors+qu%26%238217%3Bon+ne+peut+pas+y+r%C3%A9pondre.+C%26%238217%3Best+bon%2C+on...&amp;tags=email%2Cmeta%2Cpython%2Cvirtualenv%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2012/10/redneck_mailbox.jpg" length="55252" type="image/jpg" />	</item>
		<item>
		<title>Valider une adresse email avec une regex en Python</title>
		<link>http://sametmax.com/valider-une-adresse-email-avec-une-regex-en-python/</link>
		<comments>http://sametmax.com/valider-une-adresse-email-avec-une-regex-en-python/#comments</comments>
		<pubDate>Tue, 06 Mar 2012 23:55:21 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[email]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[regex]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=253</guid>
		<description><![CDATA[Problème de tous les jours, et on a tous essayé de concocter notre solution maison. Mais il se trouve que <a href="https://www.ietf.org/rfc/rfc5322.txt">la norme</a> qui définit le format des adresses emails est vraiment tordue.]]></description>
			<content:encoded><![CDATA[<p>Problème de tous les jours, et on a tous essayé de concocter notre solution maison. Mais il se trouve que <a href="https://www.ietf.org/rfc/rfc5322.txt">la norme</a> qui définit le format des adresses emails est vraiment tordue.</p>
<p>Si on est trop rigide, on interdit les cas contre-intuitifs comme le signe &#8216;+&#8217; dans le destinataire, le domaine &#8220;.museum&#8221;, l&#8217;adresse IP dans l&#8217;email ou le sous domaine comportant un seul caractère.</p>
<p>Si on est trop flexible, l&#8217;utilisateur va rentrer <code>truc@chose</code> et ne pas s’apercevoir de sa faute de frappe. Il oubliera alors votre site, sans email pour le contacter.</p>
<p>Il existe une version bullet proof de regex qui valide une adresse email, mais <a href="http://ex-parrot.com/~pdw/Mail-RFC822-Address.html">c&#8217;est un truc de malade</a>.</p>
<p>Au final, on veut juste attraper 99% des cas les plus courrants, un compromis en solidité et praticité. Le code source de Django nous fournit justement une solution équilibrée dans le fichier <em>core/validators.py</em>:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> email_re = <span style="color: #dc143c;">re</span>.<span style="color: #008000;">compile</span><span style="color: black;">&#40;</span>
r<span style="color: #483d8b;">&quot;(^[-!#$%&amp;'*+/=?^_`{}|~0-9A-Z]+(<span style="color: #000099; font-weight: bold;">\.</span>[-!#$%&amp;'*+/=?^_`{}|~0-9A-Z]+)*&quot;</span>  <span style="color: #808080; font-style: italic;"># dot-atom</span>
r<span style="color: #483d8b;">'|^&quot;([<span style="color: #000099; font-weight: bold;">\0</span>01-<span style="color: #000099; font-weight: bold;">\0</span>10<span style="color: #000099; font-weight: bold;">\0</span>13<span style="color: #000099; font-weight: bold;">\0</span>14<span style="color: #000099; font-weight: bold;">\0</span>16-<span style="color: #000099; font-weight: bold;">\0</span>37!#-<span style="color: #000099; font-weight: bold;">\[</span><span style="color: #000099; font-weight: bold;">\]</span>-<span style="color: #000099; font-weight: bold;">\1</span>77]|<span style="color: #000099; font-weight: bold;">\\</span>[<span style="color: #000099; font-weight: bold;">\0</span>01-011<span style="color: #000099; font-weight: bold;">\0</span>13<span style="color: #000099; font-weight: bold;">\0</span>14<span style="color: #000099; font-weight: bold;">\0</span>16-<span style="color: #000099; font-weight: bold;">\1</span>77])*&quot;'</span> <span style="color: #808080; font-style: italic;"># quoted-string</span>
r<span style="color: #483d8b;">')@(?:[A-Z0-9](?:[A-Z0-9-]{0,61}[A-Z0-9])?<span style="color: #000099; font-weight: bold;">\.</span>)+[A-Z]{2,6}<span style="color: #000099; font-weight: bold;">\.</span>?$'</span>, <span style="color: #dc143c;">re</span>.<span style="color: black;">IGNORECASE</span><span style="color: black;">&#41;</span>  <span style="color: #808080; font-style: italic;"># domain</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> email_re.<span style="color: black;">search</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'test+12@moi.n.museum'</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&lt;</span>_sre.<span style="color: black;">SRE_Match</span> <span style="color: #008000;">object</span> at 0x1205160<span style="color: #66cc66;">&gt;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> email_re.<span style="color: black;">search</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'test@moi'</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span></pre></div></div>

<p>Par contre ça ne gère pas l&#8217;adresse IP en tant que nom de domaine, mais c&#8217;est le plus souvent suffisant.</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=253&amp;md5=9ad22cf90791b196d1c0ef4ae900ec77" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/valider-une-adresse-email-avec-une-regex-en-python/feed/</wfw:commentRss>
		<slash:comments>2</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fvalider-une-adresse-email-avec-une-regex-en-python%2F&amp;language=en_GB&amp;category=text&amp;title=Valider+une+adresse+email+avec+une+regex+en+Python&amp;description=Probl%C3%A8me+de+tous+les+jours%2C+et+on+a+tous+essay%C3%A9+de+concocter+notre+solution+maison.+Mais+il+se+trouve+que+la+norme+qui+d%C3%A9finit+le+format+des+adresses+emails+est...&amp;tags=django%2Cemail%2Cpython%2Cregex%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2012/03/What-your-email-address-says-about-your-computer-skills-The-Oatmeal.png" length="646149" type="image/jpg" />	</item>
	</channel>
</rss>
