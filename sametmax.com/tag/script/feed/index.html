<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Sam &#38; Max: Python, Django, Git et du cul &#187; script</title>
	<atom:link href="http://sametmax.com/tag/script/feed/" rel="self" type="application/rss+xml" />
	<link>http://sametmax.com</link>
	<description>Deux développeurs en vadrouille qui se sortent les doigts du code</description>
	<lastBuildDate>Wed, 05 Feb 2014 14:20:37 +0000</lastBuildDate>
	<language>en</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>http://wordpress.org/?v=3.3.1</generator>
	<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2F&amp;language=en_US&amp;category=text&amp;title=Sam+%26amp%3B+Max%3A+Python%2C+Django%2C+Git+et+du+cul&amp;description=Deux+d%C3%A9veloppeurs+en+vadrouille+qui+se+sortent+les+doigts+du+code&amp;tags=blog" type="text/html" />
		<item>
		<title>Notre programme &#8220;Envoyez nous les scripts que vous ne pigez pas&#8221; est toujours d&#8217;actu</title>
		<link>http://sametmax.com/notre-programme-envoyez-nous-les-scripts-que-vous-ne-pigez-pas-est-toujours-dactu/</link>
		<comments>http://sametmax.com/notre-programme-envoyez-nous-les-scripts-que-vous-ne-pigez-pas-est-toujours-dactu/#comments</comments>
		<pubDate>Mon, 01 Jul 2013 22:09:36 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[gis]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[script]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=6518</guid>
		<description><![CDATA[Cher journal, aujourd'hui j'ai voulu faire une bonne action en aidant quelqu'un sur le net, mais j'ai fini par en mettre une autre mal à l'aise. Je crois que c'est une parti inhérente du protocole d'échange de données inter-humains sur Internet.]]></description>
			<content:encoded><![CDATA[<p>Bon, je me traîne comme une limace hémiplégique pour les pondre mais comme on dit, &#8220;qui vol un cheval donné qu&#8217;à la fin l&#8217;étincelle se casse&#8221;.</p>
<blockquote><p>Salut,</p>
<p>je viens de lire votre article &#8220;Envoyez nous les scripts que vous ne pigez pas&#8221;.<br />
L&#8217;article date un peu, ptêt j&#8217;arrive trop tard.<br />
Dans le cas contraire.. read on..</p>
<p>Voilà: je me ronge le cerveau sur un script python depuis un moment déjà, mais il reste aujourd&#8217;hui une lamentable énigme.</p>
<p>La situation:</p>
<p>On m&#8217;offre l&#8217;intégrale (26Go!) des cartes IGN, tombées du cyber-camion, accompagné de quelques lignes de python permettant de soit-disant trouver la carte qui nous intéresse par ses coordonnées GPS et de, une fois qu&#8217;on a une carte, trouver celles qui viennent se placer au Nord/Sud/Est/Ouest.</p>
<p>D&#8217;la balle, que j&#8217;me dis. J&#8217;y connais rien au python, mais le code est lisible, commenté, easy quoi.<br />
Après quelques heures de lecture, le monde sera à moi.. C&#8217;était il y a deux mois.<br />
Échec total de communication entre mes synapses et le serpent.<br />
Jamais plus je ne toucherai à du Python me suis-dis alors.<br />
Jusqu&#8217;à ce que l&#8217;espoir renaisse à lecture de votre billet qui-fut-pour-moi-comme-un-arc-en-ciel (et hop, léchage de cul qui fera, à n&#8217;en point douter, toute la différence).</p>
<p>Je m&#8217;en remets donc à vous, nobles aventuriers, et vous remets votre carte au trésor ci-dessous:</p>
<p>* find_map_by_coordinate.py</p>
<p>http://0bin.net/paste/8a658d3a8f3149ee3af36b7f9abb0e291d00d3f1#OYNAOG9Bhuk/cdC6SgsgVxoW+s5eADhCwjUGACNI4wk=</p>
<p>* find_close_maps.py</p>
<p>http://0bin.net/paste/5a1a9236cddfbea5abbc4c21459856acfd21fd17#MncBXtbHcQFaKW8l3aEVmyNc+0gqe4/iTU6aIatAK4w=</p>
<p>* ign25.py</p>
<p>http://0bin.net/paste/f50e61ad54b9e53d6dd99a655d9cf564eb7a5ad7#QWa6Fz9GejLNK5+niZNqc6/fTm0Pwvl2fBjtPGL8I5Y=</p>
<p>Et pour répondre à votre question, oui, je peux vous envoyer les précieuses cartes.<br />
Reste simplement à trouver un moyen de vous faire passer 26Go de données..</p>
<p>Bon décodage!</p>
<p>Bien à vous,</p>
<p>(pour partouze c&#8217;est toujours OK ?)</p></blockquote>
<p>Bon, d&#8217;accord, j&#8217;ai rajouté la dernière ligne.</p>
<p>Donc, j&#8217;ai lu les scripts, et je les ai commenté au fil de l&#8217;eau. Vous allez voir, ça se sent, c&#8217;est assez organique et on sent bien se développer mes réactions au fur et à mesure face à ce script.</p>
<p>Spoiler : cher ami lecteur, tes synapses ne sont pas en cause, l&#8217;auteur du script n&#8217;est pas un Dieu de la prog, et en fait je ne suis même pas sûr que son code marche. Même un petit peu. Auteur anonyme si tu nous lis, toutes mes condoléances.</p>
<p>Comme ça va être long, et conforme à la tradition :</p>

<!-- iframe plugin v:2.3 - wordpress.org/extend/plugins/iframe/ -->
<iframe width="420" height="315" src="//www.youtube.com/embed/g6ICYbiLIsg" frameborder="0" scrolling="no" class="iframe-class"></iframe>
<h1>find_map_by_coordinate.py</h1>
<p>Là je découvre, c&#8217;est l&#8217;aventure, on sent l&#8217;enthousiasme.</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">#!/usr/bin/python</span>
&nbsp;
&nbsp;
<span style="color: #808080; font-style: italic;"># Ceci est un script de recherche de coordonnées, il trouve une carte qui</span>
<span style="color: #808080; font-style: italic;"># contient ces coordonnées dans la base de données des cartes. Le but est donc</span>
<span style="color: #808080; font-style: italic;"># de prendre en entrée des coordonnées sous forme de latitudes et longitudes</span>
<span style="color: #808080; font-style: italic;"># saisies par l'utilisateur et d'afficher le nom des cartes sur son terminal.</span>
<span style="color: #808080; font-style: italic;">#</span>
<span style="color: #808080; font-style: italic;"># Ex:</span>
<span style="color: #808080; font-style: italic;">#</span>
<span style="color: #808080; font-style: italic;"># $ python ./find_map_by_coordinate.py (5, 32) (3, 44)</span>
<span style="color: #808080; font-style: italic;"># Trying to open database...</span>
<span style="color: #808080; font-style: italic;"># ...OK</span>
<span style="color: #808080; font-style: italic;"># Searching for (104, 32),  (201, 44)...</span>
<span style="color: #808080; font-style: italic;"># ...found.</span>
<span style="color: #808080; font-style: italic;"># ['/chemin/vers/carte1', '/chemin/vers/carte2']</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># Comme d'habitude on a les imports en premier, ici l'auteur a choisi</span>
<span style="color: #808080; font-style: italic;"># de mettre les imports de ses propres modules avant ceux de la lib</span>
<span style="color: #808080; font-style: italic;"># standard, je recommande l'inverse.</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">from</span> ign25 <span style="color: #ff7700;font-weight:bold;">import</span> load_db, find
&nbsp;
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">os</span>
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">sys</span>
<span style="color: #ff7700;font-weight:bold;">import</span> ast
&nbsp;
<span style="color: #808080; font-style: italic;"># Plutôt que de uniquement des prints, l'auteur choisit d'utiliser</span>
<span style="color: #808080; font-style: italic;"># le module de logging, mais l'utilise au final pour faire des prints.</span>
<span style="color: #808080; font-style: italic;"># Du coup je ne suis pas certains de l'interêt de la chose, peut être</span>
<span style="color: #808080; font-style: italic;"># que l'intention est de le faire plus plus tard.</span>
<span style="color: #808080; font-style: italic;"># Dans tous les cas il met le niveau de logging sur DEBUG, ce qui fait</span>
<span style="color: #808080; font-style: italic;"># que tous les messages seront affichés.</span>
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">logging</span>
<span style="color: #dc143c;">logging</span>.<span style="color: black;">basicConfig</span><span style="color: black;">&#40;</span>level=<span style="color: #dc143c;">logging</span>.<span style="color: black;">DEBUG</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># On a ici l'idiome connu qui permet de n'exécuter le bloc que si</span>
<span style="color: #808080; font-style: italic;"># le script et lancé directement (et pas importé). Dans ce cas c'est inutile,</span>
<span style="color: #808080; font-style: italic;"># en effet il n'y a rien dans ce script qu'on puisse vouloir importer, c'est</span>
<span style="color: #808080; font-style: italic;"># donc un script qui est TOUJOURS destiné à être lancé. Encore une fois</span>
<span style="color: #808080; font-style: italic;"># c'est peut être un indice d'une intention future de l'auteur.</span>
<span style="color: #ff7700;font-weight:bold;">if</span> __name__ == <span style="color: #483d8b;">&quot;__main__&quot;</span>:
&nbsp;
    <span style="color: #808080; font-style: italic;"># Le parsing des arguments est fait à la main. Pour un petit script</span>
    <span style="color: #808080; font-style: italic;"># comme ça ça a du sens (on a pas toujours envie de sortir l'artillerie</span>
    <span style="color: #808080; font-style: italic;"># lourde avec argparse)</span>
    <span style="color: #808080; font-style: italic;"># En gros, si il y a les deux arguments nécessaires (sys.argv contient</span>
    <span style="color: #808080; font-style: italic;"># le nom du script et chaque argument passé au script), on les traite,</span>
    <span style="color: #808080; font-style: italic;"># sinon on affiche un message indiquant comment utiliser le script.</span>
    <span style="color: #808080; font-style: italic;"># Le traitement des arguments est une évaluation du code comme si c'était</span>
    <span style="color: #808080; font-style: italic;"># du Python. Encore une fois je ne recommande pas cela, demander les</span>
    <span style="color: #808080; font-style: italic;"># degrés et les minutes sous la forme naturelle (34°27') et le parser</span>
    <span style="color: #808080; font-style: italic;"># avec des regex est plus propre ou de passer des longitudes et latitudes</span>
    <span style="color: #808080; font-style: italic;"># via 4 paramètres au lieu de deux ici.</span>
    <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #008000;">len</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">sys</span>.<span style="color: black;">argv</span><span style="color: black;">&#41;</span> <span style="color: #66cc66;">&gt;</span>= <span style="color: #ff4500;">3</span>:
        x = ast.<span style="color: black;">literal_eval</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">sys</span>.<span style="color: black;">argv</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
        y = ast.<span style="color: black;">literal_eval</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">sys</span>.<span style="color: black;">argv</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">else</span>:
        <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;find map for given coordiantes&quot;</span><span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;&quot;</span><span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;usage: %s [lat] [lon]&quot;</span> <span style="color: #66cc66;">%</span> <span style="color: #dc143c;">sys</span>.<span style="color: black;">argv</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;       with [lat,lon] in degrees or in (degrees, minutes)&quot;</span><span style="color: black;">&#41;</span>
        <span style="color: #dc143c;">sys</span>.<span style="color: black;">exit</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># Ici on fait appel à la fonction load_db() qui se connecte à la</span>
    <span style="color: #808080; font-style: italic;"># base de données</span>
    db = load_db<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># On lance la recherche dans la base de données avec la fonction find()</span>
    <span style="color: #808080; font-style: italic;"># qui est aussi issue du module ign25, et on affiche les résultats.</span>
    <span style="color: #dc143c;">logging</span>.<span style="color: black;">info</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Searching for %s, %s...&quot;</span> <span style="color: #66cc66;">%</span> <span style="color: black;">&#40;</span>x, y<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
    r = find<span style="color: black;">&#40;</span>db, x, y<span style="color: black;">&#41;</span>
    <span style="color: #dc143c;">logging</span>.<span style="color: black;">info</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;...found.&quot;</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>r<span style="color: black;">&#41;</span></pre></div></div>

<h2>find_close_maps.py</h2>
<p>Je tique un peu. Il y a des trucs bizarres. Mais bon, c&#8217;est peut être moi.</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">#!/usr/bin/python</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># Même principe, mais pour les cartes proche d'une autre carte. Je ne vais</span>
<span style="color: #808080; font-style: italic;"># donc que commenter les différences.</span>
<span style="color: #808080; font-style: italic;"># Il attend un fichier .map en paramètre et va lister toutes les cartes de</span>
<span style="color: #808080; font-style: italic;"># la base de données qui sont à 10km de la carte dont le fichier a été passé</span>
<span style="color: #808080; font-style: italic;"># en paramètres.</span>
&nbsp;
&nbsp;
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">os</span>
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">os</span>.<span style="color: black;">path</span>
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">sys</span>
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">math</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">logging</span>
<span style="color: #dc143c;">logging</span>.<span style="color: black;">basicConfig</span><span style="color: black;">&#40;</span>level=<span style="color: #dc143c;">logging</span>.<span style="color: black;">DEBUG</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">from</span> ign25 <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #66cc66;">*</span>
&nbsp;
&nbsp;
<span style="color: #ff7700;font-weight:bold;">if</span> __name__ == <span style="color: #483d8b;">&quot;__main__&quot;</span>:
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #008000;">len</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">sys</span>.<span style="color: black;">argv</span><span style="color: black;">&#41;</span> <span style="color: #66cc66;">&lt;</span> <span style="color: #ff4500;">2</span>:
        <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;find maps around a given map&quot;</span>
        <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;&quot;</span>
        <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;usage: %s [reference map]&quot;</span> <span style="color: #66cc66;">%</span> <span style="color: #dc143c;">sys</span>.<span style="color: black;">argv</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#93;</span>
        <span style="color: #dc143c;">sys</span>.<span style="color: black;">exit</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#41;</span>
&nbsp;
    db = load_db<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># On ouvre le fichier de carte, et on récupère les coordonnées des 4</span>
    <span style="color: #808080; font-style: italic;"># extrémités du carré que forme la carte sous le forme d'un objet de type</span>
    <span style="color: #808080; font-style: italic;"># MapInfo qui contiendra les attributs nw, ne, se, sw (Nord-Ouest, Nord-Est,</span>
    <span style="color: #808080; font-style: italic;"># Sud-Est, Sud-Est)</span>
    <span style="color: #ff7700;font-weight:bold;">try</span>:
        reference = get_info<span style="color: black;">&#40;</span><span style="color: #008000;">open</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">sys</span>.<span style="color: black;">argv</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span><span style="color: black;">&#93;</span> + <span style="color: #483d8b;">&quot;.map&quot;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">except</span>:
        <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;map %s not found&quot;</span> <span style="color: #66cc66;">%</span> <span style="color: #dc143c;">sys</span>.<span style="color: black;">argv</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span><span style="color: black;">&#93;</span>
    maxDistance = <span style="color: #ff4500;">10</span> <span style="color: #808080; font-style: italic;">#in km</span>
    <span style="color: #808080; font-style: italic;"># la distance maximale est écrite en dure, on pourrait la passer en paramètre</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># Ensuite la recherche se fait avec encore une fois une fonction de</span>
    <span style="color: #808080; font-style: italic;"># ign25, donc la logique de ce script est assez simple puisque la</span>
    <span style="color: #808080; font-style: italic;"># complexité est dans ign25.py. On récupère une liste de carte.</span>
    closemaps = gen_closemaps<span style="color: black;">&#40;</span>db, reference, maxDistance<span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># La liste est affichée mais on remplace la carte par une image de la carte</span>
    <span style="color: #808080; font-style: italic;"># au format PNG (qui je suppose est fournie avec la carte ?)</span>
    <span style="color: #ff7700;font-weight:bold;">for</span> i <span style="color: #ff7700;font-weight:bold;">in</span> closemaps:
        <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #dc143c;">os</span>.<span style="color: black;">path</span>.<span style="color: black;">abspath</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;../png/&quot;</span> + i.<span style="color: black;">filename</span> + <span style="color: #483d8b;">&quot;.png&quot;</span><span style="color: black;">&#41;</span></pre></div></div>

<h2>ign25.py</h2>
<div id="attachment_6519" class="wp-caption aligncenter" style="width: 476px"><a href="http://sametmax.com/wp-content/uploads/2013/07/86399470.jpg"><img class="size-full wp-image-6519" title="... yet so far" src="http://sametmax.com/wp-content/uploads/2013/07/86399470.jpg" alt="Photo d'un arbre planté à côté de son pot" width="466" height="600" /></a><p class="wp-caption-text">... yet so far</p></div>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">#!/usr/bin/python</span>
&nbsp;
<span style="color: #483d8b;">&quot;&quot;&quot;Module to work with my set of IGN TOP25 maps
&nbsp;
&quot;&quot;&quot;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># Toute la logique des scripts précédents est définie ici.</span>
<span style="color: #808080; font-style: italic;"># Encore une fois la docstring est un peu légère et des commentaires</span>
<span style="color: #808080; font-style: italic;"># en plus ne serait pas de refus car du coup pour comprendre ce que fais</span>
<span style="color: #808080; font-style: italic;"># le script juste en les recevant par email, c'est moins facile, forcément ^^</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># Encore une fois, je vous invite à ne pas faire plein d'imports sur une ligne</span>
<span style="color: #808080; font-style: italic;"># si ils ne sont pas du même module. D'autant qu'ici les modules shutils et</span>
<span style="color: #808080; font-style: italic;"># math ne sont pas utilisé dans le script, et os.path est importé deux fois.</span>
<span style="color: #808080; font-style: italic;"># Cher auteur de script, loin de moi l'idée d'insulter ton travail, j'ai</span>
<span style="color: #808080; font-style: italic;"># conscience que tu es sans aucun doute un géographe et non un développeur,</span>
<span style="color: #808080; font-style: italic;"># ne m'en veut donc pas, je ne fais que commenter le script à des fins</span>
<span style="color: #808080; font-style: italic;"># pédagogiques et pas du tout pour te descendre. </span>
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">os</span>, <span style="color: #dc143c;">re</span>, <span style="color: #dc143c;">math</span>, <span style="color: #dc143c;">shutil</span>, <span style="color: #dc143c;">os</span>.<span style="color: black;">path</span>, <span style="color: #dc143c;">sys</span>
<span style="color: #ff7700;font-weight:bold;">import</span> ast
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">logging</span>
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">os</span>.<span style="color: black;">path</span>
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">math</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># Déclaration de constantes. Mettez les constantes en majuscules car la notion</span>
<span style="color: #808080; font-style: italic;"># de constante n'existe pas en Python et seule cette convention permet</span>
<span style="color: #808080; font-style: italic;"># de savoir qu'il ne faut pas y toucher.</span>
&nbsp;
easting2km = <span style="color: #ff4500;">0.73847</span>
northing2km = <span style="color: #ff4500;">0.53848</span>
northAdjust = easting2km / northing2km
&nbsp;
<span style="color: #808080; font-style: italic;"># Une classe vide qui va servir de conteneur. Je comprends que si l'on vient</span>
<span style="color: #808080; font-style: italic;"># d'un langage avec des structs, c'est une tendance naturelle. Néanmoins,</span>
<span style="color: #808080; font-style: italic;"># si il n'y a aucune logique associée à vos données, préférez un dictionnaire</span>
<span style="color: #808080; font-style: italic;"># ou un namedtuple.</span>
<span style="color: #ff7700;font-weight:bold;">class</span> MapInfo:
    <span style="color: #483d8b;">&quot;&quot;&quot;Store map information&quot;&quot;&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">pass</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># Ah, un peu de doc, ça fait plaisir :-)</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># Routines to read .map files</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> get_coordinates<span style="color: black;">&#40;</span>line<span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;Read the coordiantes of a point
&nbsp;
    line:       line describing the point
    returns:    a tuple of tuples ((xdeg, xmin), (ydeg, ymin))&quot;&quot;&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">try</span>:
        <span style="color: #808080; font-style: italic;"># La fonction analyse une ligne de texte formattée ainsi:</span>
        <span style="color: #808080; font-style: italic;"># champ1,    champ2    , champ3    ,    champ4...</span>
        <span style="color: #808080; font-style: italic;"># et en extrait les degrés et les minutes avec un split sur</span>
        <span style="color: #808080; font-style: italic;"># le caractère virgule entouré par un nombre indéterminé de caractères</span>
        <span style="color: #808080; font-style: italic;"># non imprimables (espaces, tabulations...)</span>
        fields = <span style="color: #dc143c;">re</span>.<span style="color: black;">split</span><span style="color: black;">&#40;</span> <span style="color: #483d8b;">&quot;<span style="color: #000099; font-weight: bold;">\s</span>*,<span style="color: #000099; font-weight: bold;">\s</span>*&quot;</span>, line <span style="color: black;">&#41;</span>
        <span style="color: #808080; font-style: italic;"># adjust for East, West. We are always in the northern hemisphere.</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># Detecte si on est dans l'hémisphèse Nord (je suppose que le onzième</span>
        <span style="color: #808080; font-style: italic;"># champ est égale à &quot;W&quot; dans ce cas, et &quot;E&quot; dans l'autre cas mais</span>
        <span style="color: #808080; font-style: italic;"># je n'ai pas le format sous les yeux pour le vérifier).</span>
        <span style="color: #808080; font-style: italic;"># Bref, si on est dans l'hémisphère Nord, on donne aux champs une valeur</span>
        <span style="color: #808080; font-style: italic;"># négative. Je suppose que ça parle aux amateurs de GIS, comme je</span>
        <span style="color: #808080; font-style: italic;"># suis incompétent dans le domaine, je ne vais pas faire mon malin</span>
        <span style="color: #808080; font-style: italic;"># et tenter d'expliquer pourquoi.</span>
        <span style="color: #ff7700;font-weight:bold;">if</span> fields<span style="color: black;">&#91;</span><span style="color: #ff4500;">11</span><span style="color: black;">&#93;</span> == <span style="color: #483d8b;">&quot;W&quot;</span>:
            fields<span style="color: black;">&#91;</span><span style="color: #ff4500;">9</span><span style="color: black;">&#93;</span> = <span style="color: #483d8b;">&quot;-&quot;</span> + fields<span style="color: black;">&#91;</span><span style="color: #ff4500;">9</span><span style="color: black;">&#93;</span>
            fields<span style="color: black;">&#91;</span><span style="color: #ff4500;">10</span><span style="color: black;">&#93;</span> = <span style="color: #483d8b;">&quot;-&quot;</span> + fields<span style="color: black;">&#91;</span><span style="color: #ff4500;">10</span><span style="color: black;">&#93;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># La fonction retourne ensuite un tuple de deux tuples avec les valeurs</span>
        <span style="color: #808080; font-style: italic;"># ou None si il a eu une erreur.</span>
        <span style="color: #808080; font-style: italic;"># Je ne sais pas où il peu y avoir une ValueError là dedans, donc</span>
        <span style="color: #808080; font-style: italic;"># difficile de dire quelle erreur l'auteur cherche à gérer.</span>
&nbsp;
        <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #008000;">int</span><span style="color: black;">&#40;</span>fields<span style="color: black;">&#91;</span><span style="color: #ff4500;">6</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>, <span style="color: #008000;">float</span><span style="color: black;">&#40;</span>fields<span style="color: black;">&#91;</span><span style="color: #ff4500;">7</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>, <span style="color: black;">&#40;</span><span style="color: #008000;">int</span><span style="color: black;">&#40;</span>fields<span style="color: black;">&#91;</span><span style="color: #ff4500;">9</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>, <span style="color: #008000;">float</span><span style="color: black;">&#40;</span>fields<span style="color: black;">&#91;</span><span style="color: #ff4500;">10</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: #008000;">ValueError</span>:
        <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">None</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># La fonction utilisée dans find_close_maps.py, qui lit un fichier carte</span>
<span style="color: #808080; font-style: italic;"># (attend un file like object en paramètre) et retourne un objet MapInfo().</span>
<span style="color: #808080; font-style: italic;"># Comme je vous l'ai dis dans ce cas il vaudrait mieux retourner un dictionnaire</span>
<span style="color: #808080; font-style: italic;"># ou un namedtuple.</span>
<span style="color: #ff7700;font-weight:bold;">def</span> get_info<span style="color: black;">&#40;</span><span style="color: #008000;">file</span><span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;Read map information in `file`
&nbsp;
    file:       file object to read
    returns:    MapInfo&quot;&quot;&quot;</span>
    i = MapInfo<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
    <span style="color: #808080; font-style: italic;"># Je pense que le but recherche est d'extraire le nom du fichier sans</span>
    <span style="color: #808080; font-style: italic;"># extention. os.path.splitext(file.name)[0] aurait été préférable</span>
    i.<span style="color: black;">filename</span> = <span style="color: #008000;">file</span>.<span style="color: black;">name</span><span style="color: black;">&#91;</span>:-<span style="color: #ff4500;">4</span><span style="color: black;">&#93;</span>
    <span style="color: #808080; font-style: italic;"># Pour chaque ligne du fichier carte, on va vérifier si la ligne</span>
    <span style="color: #808080; font-style: italic;"># contient la chaîne Point0x, extraire les coordonnées de la ligne</span>
    <span style="color: #808080; font-style: italic;"># et les stocker dans un attribut représentant un des coins de la carte</span>
    <span style="color: #808080; font-style: italic;"># de l'objet MapInfo().</span>
    <span style="color: #808080; font-style: italic;">#</span>
    <span style="color: #808080; font-style: italic;"># Pour les améliorations possibles :</span>
    <span style="color: #808080; font-style: italic;"># - mettre le return dans la boucle for</span>
    <span style="color: #808080; font-style: italic;"># - re.match(r'regex', line) suffit</span>
    <span style="color: #808080; font-style: italic;"># - retourner None plutôt que False</span>
    <span style="color: #ff7700;font-weight:bold;">for</span> line <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">file</span>:
        <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #dc143c;">re</span>.<span style="color: #008000;">compile</span><span style="color: black;">&#40;</span>r<span style="color: #483d8b;">'Point03'</span><span style="color: black;">&#41;</span>.<span style="color: black;">match</span><span style="color: black;">&#40;</span>line<span style="color: black;">&#41;</span>:
            i.<span style="color: black;">nw</span> = get_coordinates<span style="color: black;">&#40;</span>line<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">elif</span> <span style="color: #dc143c;">re</span>.<span style="color: #008000;">compile</span><span style="color: black;">&#40;</span>r<span style="color: #483d8b;">'Point02'</span><span style="color: black;">&#41;</span>.<span style="color: black;">match</span><span style="color: black;">&#40;</span>line<span style="color: black;">&#41;</span>:
            i.<span style="color: black;">ne</span> = get_coordinates<span style="color: black;">&#40;</span>line<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">elif</span> <span style="color: #dc143c;">re</span>.<span style="color: #008000;">compile</span><span style="color: black;">&#40;</span>r<span style="color: #483d8b;">'Point04'</span><span style="color: black;">&#41;</span>.<span style="color: black;">match</span><span style="color: black;">&#40;</span>line<span style="color: black;">&#41;</span>:
            i.<span style="color: black;">sw</span> = get_coordinates<span style="color: black;">&#40;</span>line<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">elif</span> <span style="color: #dc143c;">re</span>.<span style="color: #008000;">compile</span><span style="color: black;">&#40;</span>r<span style="color: #483d8b;">'Point01'</span><span style="color: black;">&#41;</span>.<span style="color: black;">match</span><span style="color: black;">&#40;</span>line<span style="color: black;">&#41;</span>:
            i.<span style="color: black;">se</span> = get_coordinates<span style="color: black;">&#40;</span>line<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #008000;">hasattr</span><span style="color: black;">&#40;</span>i, <span style="color: #483d8b;">'nw'</span><span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">return</span> i
    <span style="color: #ff7700;font-weight:bold;">else</span>:
        <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">False</span>
<span style="color: #808080; font-style: italic;"># Une manière concise d'écrire la même fonction aurait pu être:</span>
<span style="color: #808080; font-style: italic;"># data = {'type': os.path.splitext(file.name)[0]}</span>
<span style="color: #808080; font-style: italic;"># for line in file:</span>
<span style="color: #808080; font-style: italic;">#     res = re.search('Point0(?P&lt;se&gt;1)?(?P&lt;ne&gt;2)?(?P&lt;nw&gt;3)?(?P&lt;sw&gt;3)?', line)</span>
<span style="color: #808080; font-style: italic;">#     if res:</span>
<span style="color: #808080; font-style: italic;">#         res = (name for name, val in res.groupdict().items() if val).next()</span>
<span style="color: #808080; font-style: italic;">#         data[name] = get_coordinates(line)</span>
<span style="color: #808080; font-style: italic;">#         if len(data) == 4</span>
<span style="color: #808080; font-style: italic;">#             return data</span>
<span style="color: #808080; font-style: italic;"># return None</span>
<span style="color: #808080; font-style: italic;"># Mais bon, la c'est de l'enculage de mouche, l'important c'est que ça marche.</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># Cette fonction n'est pas appelée dans les autres scripts.</span>
<span style="color: #808080; font-style: italic;"># Elle retourne un générateur qui retourne, pour chaque fichier passé</span>
<span style="color: #808080; font-style: italic;"># dans l'itérable en paramètre (par exemple une liste de chemins de fichier)</span>
<span style="color: #808080; font-style: italic;"># un générateur donc chaque élément est un objet MapInfo contenant les</span>
<span style="color: #808080; font-style: italic;"># infos de la carte correspondant à chaque nom de fichier</span>
<span style="color: #ff7700;font-weight:bold;">def</span> gen_info<span style="color: black;">&#40;</span>filenames<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">for</span> filename <span style="color: #ff7700;font-weight:bold;">in</span> filenames:
        <span style="color: #ff7700;font-weight:bold;">try</span>:
            <span style="color: #dc143c;">logging</span>.<span style="color: black;">info</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Reading %s&quot;</span> <span style="color: #66cc66;">%</span> filename<span style="color: black;">&#41;</span>
            f = <span style="color: #008000;">open</span><span style="color: black;">&#40;</span>filename<span style="color: black;">&#41;</span>
            info = get_info<span style="color: black;">&#40;</span>f<span style="color: black;">&#41;</span>
            <span style="color: #ff7700;font-weight:bold;">if</span> info:
                <span style="color: #ff7700;font-weight:bold;">yield</span> info
        <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: #008000;">IOError</span>:
            <span style="color: #ff7700;font-weight:bold;">pass</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># Pareil, pas utilisé. Ca fabrique une liste en listant les fichiers d'un</span>
<span style="color: #808080; font-style: italic;"># dossier nomme &quot;map&quot; (on va supposé qu'il est déjà là ?), on passant</span>
<span style="color: #808080; font-style: italic;"># cette liste à gen_info() qu'on vient de voir plus haut, et en transformant</span>
<span style="color: #808080; font-style: italic;"># le générateur obtenu en liste.</span>
<span style="color: #ff7700;font-weight:bold;">def</span> generate_database<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #dc143c;">os</span>.<span style="color: black;">path</span>.<span style="color: black;">isdir</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'map'</span><span style="color: black;">&#41;</span>:
        mapdir = <span style="color: #483d8b;">'map'</span>
    <span style="color: #ff7700;font-weight:bold;">else</span>:
        mapdir = <span style="color: #483d8b;">'.'</span>
    fnames = <span style="color: #dc143c;">os</span>.<span style="color: black;">listdir</span> <span style="color: black;">&#40;</span>mapdir<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">list</span><span style="color: black;">&#40;</span>gen_info<span style="color: black;">&#40;</span>fnames<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># Routine to print db</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># Idem, pas utilisé. On passe une base de données en paramètres</span>
<span style="color: #808080; font-style: italic;"># Et on print un listing de tous les fichiers de cartes de la BDD et</span>
<span style="color: #808080; font-style: italic;"># leurs coordonnées.</span>
<span style="color: #ff7700;font-weight:bold;">def</span> print_database<span style="color: black;">&#40;</span>db<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">'filename,'</span>, <span style="color: #483d8b;">'nw,'</span>, <span style="color: #483d8b;">'ne,'</span>, <span style="color: #483d8b;">'sw,'</span>, <span style="color: #483d8b;">'se,'</span>
    <span style="color: #ff7700;font-weight:bold;">for</span> i <span style="color: #ff7700;font-weight:bold;">in</span> db:
        <span style="color: #808080; font-style: italic;"># La seule partie compliquée : on définie une fonction</span>
        <span style="color: #808080; font-style: italic;"># dans le corps de la boucle for et on l'utilise cash pistache.</span>
        <span style="color: #808080; font-style: italic;"># Une manière plus propre aurait été :</span>
        <span style="color: #808080; font-style: italic;"># vals = (i.filename, i.nw, i.ne, i.sw, i.se)</span>
        <span style="color: #808080; font-style: italic;"># print ' '.join(str(x).replace(' ','') for x in vals)</span>
        <span style="color: #808080; font-style: italic;"># Si on avait un namedtuple plutôt qu'un objet, une ligne aurait suffit</span>
        <span style="color: #ff7700;font-weight:bold;">def</span> rms<span style="color: black;">&#40;</span>s<span style="color: black;">&#41;</span>:
            <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">str</span><span style="color: black;">&#40;</span>s<span style="color: black;">&#41;</span>.<span style="color: black;">replace</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">' '</span>,<span style="color: #483d8b;">''</span><span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">print</span> i.<span style="color: black;">filename</span>, rms<span style="color: black;">&#40;</span>i.<span style="color: black;">nw</span><span style="color: black;">&#41;</span>, rms<span style="color: black;">&#40;</span>i.<span style="color: black;">ne</span><span style="color: black;">&#41;</span>, rms<span style="color: black;">&#40;</span>i.<span style="color: black;">sw</span><span style="color: black;">&#41;</span>, rms<span style="color: black;">&#40;</span>i.<span style="color: black;">se</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># Itou, pas utilisé. On prend chaque carte dd'un dossier, et on écrit</span>
<span style="color: #808080; font-style: italic;"># toutes les infos obtenues avec les fonctions précédentes dans un fichier.</span>
<span style="color: #808080; font-style: italic;"># Encore une fois notez que si on avait utilisé un namedtupple, l'opération</span>
<span style="color: #808080; font-style: italic;"># aurait pris 4 lignes.</span>
<span style="color: #808080; font-style: italic;"># Il y a néanmoins 3 choses qui m'interpellent dans ce code :</span>
<span style="color: #808080; font-style: italic;"># - pourquoi appeler ça une base de données ? C'est juste un listing texte</span>
<span style="color: #808080; font-style: italic;"># - pourquoi ne pas avoir choisit le format CSV (il y a un module pour ça)</span>
<span style="color: #808080; font-style: italic;"># - pourquoi writelineS() et pas writeline() ? Est-ce un bug ?</span>
<span style="color: #ff7700;font-weight:bold;">def</span> save_database<span style="color: black;">&#40;</span>db, path<span style="color: black;">&#41;</span>:
    f = <span style="color: #008000;">open</span><span style="color: black;">&#40;</span>path, <span style="color: #483d8b;">'w'</span><span style="color: black;">&#41;</span>
    f.<span style="color: black;">writelines</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'filename '</span>, <span style="color: #483d8b;">'nw '</span>, <span style="color: #483d8b;">'ne '</span>, <span style="color: #483d8b;">'sw '</span>, <span style="color: #483d8b;">'se '</span>, <span style="color: #483d8b;">'<span style="color: #000099; font-weight: bold;">\n</span>'</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">for</span> i <span style="color: #ff7700;font-weight:bold;">in</span> db:
        <span style="color: #ff7700;font-weight:bold;">def</span> rms<span style="color: black;">&#40;</span>s<span style="color: black;">&#41;</span>:
            <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">str</span><span style="color: black;">&#40;</span>s<span style="color: black;">&#41;</span>.<span style="color: black;">replace</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">' '</span>,<span style="color: #483d8b;">''</span><span style="color: black;">&#41;</span>
        f.<span style="color: black;">writelines</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>i.<span style="color: black;">filename</span>, <span style="color: #483d8b;">' '</span>,
                      rms<span style="color: black;">&#40;</span>i.<span style="color: black;">nw</span><span style="color: black;">&#41;</span>, <span style="color: #483d8b;">' '</span>,
                      rms<span style="color: black;">&#40;</span>i.<span style="color: black;">ne</span><span style="color: black;">&#41;</span>, <span style="color: #483d8b;">' '</span>,
                      rms<span style="color: black;">&#40;</span>i.<span style="color: black;">sw</span><span style="color: black;">&#41;</span>, <span style="color: #483d8b;">' '</span>,
                      rms<span style="color: black;">&#40;</span>i.<span style="color: black;">se</span><span style="color: black;">&#41;</span>, <span style="color: #483d8b;">'<span style="color: #000099; font-weight: bold;">\n</span>'</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># Routine to import db L'inverse de la fonction précédente. Chaque tout le</span>
<span style="color: #808080; font-style: italic;"># fichier et retourne une liste d'objet MapInfos(). Je pense que l'auteur ne</span>
<span style="color: #808080; font-style: italic;"># connais pas la fonction float()</span>
<span style="color: #ff7700;font-weight:bold;">def</span> import_database<span style="color: black;">&#40;</span>path<span style="color: black;">&#41;</span>:
    db = <span style="color: black;">&#91;</span><span style="color: black;">&#93;</span>
    f = <span style="color: #008000;">open</span><span style="color: black;">&#40;</span>path<span style="color: black;">&#41;</span>
    f.<span style="color: #dc143c;">readline</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">for</span> line <span style="color: #ff7700;font-weight:bold;">in</span> f:
        fields = line.<span style="color: black;">split</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
        i = MapInfo<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
        i.<span style="color: black;">filename</span> = <span style="color: #008000;">str</span><span style="color: black;">&#40;</span>fields<span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
        i.<span style="color: black;">nw</span> = ast.<span style="color: black;">literal_eval</span><span style="color: black;">&#40;</span>fields<span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
        i.<span style="color: black;">ne</span> = ast.<span style="color: black;">literal_eval</span><span style="color: black;">&#40;</span>fields<span style="color: black;">&#91;</span><span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
        i.<span style="color: black;">sw</span> = ast.<span style="color: black;">literal_eval</span><span style="color: black;">&#40;</span>fields<span style="color: black;">&#91;</span><span style="color: #ff4500;">3</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
        i.<span style="color: black;">se</span> = ast.<span style="color: black;">literal_eval</span><span style="color: black;">&#40;</span>fields<span style="color: black;">&#91;</span><span style="color: #ff4500;">4</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
        db.<span style="color: black;">append</span><span style="color: black;">&#40;</span>i<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> db
&nbsp;
<span style="color: #808080; font-style: italic;"># Ca appelle import_database et si ça ne marche pas, ça</span>
<span style="color: #808080; font-style: italic;"># génère une &quot;base de données&quot;.</span>
<span style="color: #ff7700;font-weight:bold;">def</span> load_db<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">try</span>:
        <span style="color: #dc143c;">logging</span>.<span style="color: black;">info</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Trying to open database...&quot;</span><span style="color: black;">&#41;</span>
        db = import_database<span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;map.db&quot;</span><span style="color: black;">&#41;</span>
        <span style="color: #dc143c;">logging</span>.<span style="color: black;">info</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;...OK.&quot;</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: #008000;">IOError</span>:
        <span style="color: #dc143c;">logging</span>.<span style="color: black;">info</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;...failed. Reading .map files...&quot;</span><span style="color: black;">&#41;</span>
        db = generate_database<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
        <span style="color: #dc143c;">logging</span>.<span style="color: black;">info</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Saving database...&quot;</span><span style="color: black;">&#41;</span>
        save_database<span style="color: black;">&#40;</span>db, <span style="color: #483d8b;">&quot;map.db&quot;</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> db
&nbsp;
<span style="color: #808080; font-style: italic;"># Lat/lon to filename</span>
<span style="color: #808080; font-style: italic;"># Une fonction pour te rendre bien deg.</span>
<span style="color: #808080; font-style: italic;"># Elle converti un tuple ou une liste Latitude / Longitude en une valeur</span>
<span style="color: #808080; font-style: italic;"># en degré. Malheureusement elle tue complètement le duck typing (elle pourrait</span>
<span style="color: #808080; font-style: italic;"># accepter n'importe quel iterable). Une version pythonique serait :</span>
<span style="color: #808080; font-style: italic;"># try:</span>
<span style="color: #808080; font-style: italic;">#   deg, min = x # marche avec TOUT itérable</span>
<span style="color: #808080; font-style: italic;"># except TypeError:</span>
<span style="color: #808080; font-style: italic;">#   deg, min = x, 0</span>
<span style="color: #808080; font-style: italic;"># return float(deg) + float(min)/60. # accepte tout ce qui est castable en float</span>
<span style="color: #808080; font-style: italic;">#</span>
<span style="color: #ff7700;font-weight:bold;">def</span> to_deg<span style="color: black;">&#40;</span>x<span style="color: black;">&#41;</span>:
    <span style="color: #808080; font-style: italic;"># isinstance est rarement une bonne idée en Python. Très rarement.</span>
    <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #008000;">isinstance</span><span style="color: black;">&#40;</span>x, <span style="color: #008000;">tuple</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">or</span> <span style="color: #008000;">isinstance</span><span style="color: black;">&#40;</span>x, <span style="color: #008000;">list</span><span style="color: black;">&#41;</span>:
        xdeg, xmin = x <span style="color: #808080; font-style: italic;"># un bon petit unpacking !</span>
    <span style="color: #ff7700;font-weight:bold;">else</span>:
        xdeg = x
        xmin = <span style="color: #ff4500;">0</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> xdeg + xmin/<span style="color: #ff4500;">60</span>.
&nbsp;
<span style="color: #808080; font-style: italic;"># Trouve une carte qui contienne ces coordonnées, retourne le filename</span>
<span style="color: #808080; font-style: italic;"># plutôt que l'objet MapInfo() (pourquoi ?).</span>
<span style="color: #ff7700;font-weight:bold;">def</span> find<span style="color: black;">&#40;</span>db, x, y<span style="color: black;">&#41;</span>:
    target_xdeg = to_deg<span style="color: black;">&#40;</span>x<span style="color: black;">&#41;</span>
    target_ydeg = to_deg<span style="color: black;">&#40;</span>y<span style="color: black;">&#41;</span>
    <span style="color: #808080; font-style: italic;">#print &quot;target&quot;, target_xdeg, target_ydeg</span>
    <span style="color: #ff7700;font-weight:bold;">for</span> i <span style="color: #ff7700;font-weight:bold;">in</span> db:
        nw_x, nw_y = i.<span style="color: black;">nw</span>
        se_x, se_y = i.<span style="color: black;">se</span>
        nw_xdeg = to_deg<span style="color: black;">&#40;</span>nw_x<span style="color: black;">&#41;</span>
        nw_ydeg = to_deg<span style="color: black;">&#40;</span>nw_y<span style="color: black;">&#41;</span>
        se_xdeg = to_deg<span style="color: black;">&#40;</span>se_x<span style="color: black;">&#41;</span>
        se_ydeg = to_deg<span style="color: black;">&#40;</span>se_y<span style="color: black;">&#41;</span>
        <span style="color: #808080; font-style: italic;"># est-ce que les bordures de la carte contiennent les coordonnées ?</span>
        <span style="color: #ff7700;font-weight:bold;">if</span> nw_xdeg <span style="color: #66cc66;">&lt;</span>= target_xdeg <span style="color: #ff7700;font-weight:bold;">and</span> target_xdeg <span style="color: #66cc66;">&lt;</span>= se_xdeg:
            <span style="color: #808080; font-style: italic;">#print &quot;candidate x&quot;, nw_xdeg, se_xdeg</span>
            <span style="color: #ff7700;font-weight:bold;">if</span> nw_ydeg <span style="color: #66cc66;">&gt;</span>= target_ydeg <span style="color: #ff7700;font-weight:bold;">and</span> target_ydeg <span style="color: #66cc66;">&gt;</span>= se_ydeg:
                <span style="color: #808080; font-style: italic;">#print &quot;candidate y&quot;, nw_ydeg, se_ydeg</span>
                <span style="color: #ff7700;font-weight:bold;">return</span> i.<span style="color: black;">filename</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># Close maps</span>
<span style="color: #808080; font-style: italic;"># Vérifie qu'une carte est proche d'une autre carte. Le PEP8 recommanderait</span>
<span style="color: #808080; font-style: italic;"># de l'appeler is_close().</span>
<span style="color: #ff7700;font-weight:bold;">def</span> isclose<span style="color: black;">&#40;</span>candidate, reference, max_distance<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">if</span> candidate.<span style="color: black;">filename</span> == reference.<span style="color: black;">filename</span>:
        <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">False</span>
    <span style="color: #808080; font-style: italic;"># put everything in minutes</span>
    <span style="color: #808080; font-style: italic;"># On repasse toutes les coordonnées en minutes</span>
    infoEastings = to_deg<span style="color: black;">&#40;</span>candidate.<span style="color: black;">nw</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">*</span><span style="color: #ff4500;">60</span>
    infoNorthings = to_deg<span style="color: black;">&#40;</span>candidate.<span style="color: black;">nw</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">*</span><span style="color: #ff4500;">60</span><span style="color: #66cc66;">*</span>northAdjust
    referenceEastings = to_deg<span style="color: black;">&#40;</span>reference.<span style="color: black;">nw</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">*</span><span style="color: #ff4500;">60</span>
    referenceNorthings = to_deg<span style="color: black;">&#40;</span>reference.<span style="color: black;">nw</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">*</span><span style="color: #ff4500;">60</span><span style="color: #66cc66;">*</span>northAdjust
&nbsp;
    <span style="color: #808080; font-style: italic;"># Pythagore, les maths de 6eme, ça vous revient ?</span>
    distance = <span style="color: black;">&#40;</span> <span style="color: #dc143c;">math</span>.<span style="color: black;">sqrt</span><span style="color: black;">&#40;</span>
        <span style="color: black;">&#40;</span> infoEastings - referenceEastings <span style="color: black;">&#41;</span><span style="color: #66cc66;">**</span><span style="color: #ff4500;">2</span> + <span style="color: black;">&#40;</span> infoNorthings - referenceNorthings <span style="color: black;">&#41;</span><span style="color: #66cc66;">**</span><span style="color: #ff4500;">2</span> <span style="color: black;">&#41;</span>
          <span style="color: #66cc66;">*</span> easting2km <span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">if</span> distance <span style="color: #66cc66;">&lt;</span> max_distance:
        <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">True</span>
    <span style="color: #ff7700;font-weight:bold;">else</span>:
        <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">False</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># un générateur qui yield toutes les cartes proches d'une distance</span>
<span style="color: #ff7700;font-weight:bold;">def</span> gen_closemaps<span style="color: black;">&#40;</span>db, reference, max_distance<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">for</span> i <span style="color: #ff7700;font-weight:bold;">in</span> db:
        <span style="color: #ff7700;font-weight:bold;">if</span> isclose<span style="color: black;">&#40;</span>i, reference, max_distance<span style="color: black;">&#41;</span>:
            <span style="color: #ff7700;font-weight:bold;">yield</span> i
&nbsp;
<span style="color: #808080; font-style: italic;"># Tile</span>
<span style="color: #808080; font-style: italic;"># Une fonction pas utilisée qui convertie les degré en..., heu... lat / long ?</span>
<span style="color: #808080; font-style: italic;"># Merci le module math de Python qui permet de s'amuser avec la trigonométrie</span>
<span style="color: #ff7700;font-weight:bold;">def</span> deg2num<span style="color: black;">&#40;</span>zoom, lat_deg, lon_deg<span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;Lon./lat. to tile numbers&quot;&quot;&quot;</span>
    lat_rad = <span style="color: #dc143c;">math</span>.<span style="color: black;">radians</span><span style="color: black;">&#40;</span>lat_deg<span style="color: black;">&#41;</span>
    n = <span style="color: #ff4500;">2.0</span> <span style="color: #66cc66;">**</span> zoom
    xtile = <span style="color: #008000;">int</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>lon_deg + <span style="color: #ff4500;">180.0</span><span style="color: black;">&#41;</span> / <span style="color: #ff4500;">360.0</span> <span style="color: #66cc66;">*</span> n<span style="color: black;">&#41;</span>
    ytile = <span style="color: #008000;">int</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">1.0</span> - <span style="color: #dc143c;">math</span>.<span style="color: black;">log</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">math</span>.<span style="color: black;">tan</span><span style="color: black;">&#40;</span>lat_rad<span style="color: black;">&#41;</span> + <span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span> / <span style="color: #dc143c;">math</span>.<span style="color: black;">cos</span><span style="color: black;">&#40;</span>lat_rad<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> / <span style="color: #dc143c;">math</span>.<span style="color: black;">pi</span><span style="color: black;">&#41;</span> / <span style="color: #ff4500;">2.0</span> <span style="color: #66cc66;">*</span> n<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: black;">&#40;</span>xtile, ytile<span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># Pareil, pas utilisé. C'est la fête du slip. On fait des fonctions pour</span>
<span style="color: #808080; font-style: italic;"># le fun, si ça se trouve on les importera un jour dans le shell, un dimanche</span>
<span style="color: #808080; font-style: italic;"># de pluie</span>
<span style="color: #ff7700;font-weight:bold;">def</span> num2deg<span style="color: black;">&#40;</span>zoom, xtile, ytile<span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;Tile numbers to lon./lat.&quot;&quot;&quot;</span>
    n = <span style="color: #ff4500;">2.0</span> <span style="color: #66cc66;">**</span> zoom
    lon_deg = xtile / n <span style="color: #66cc66;">*</span> <span style="color: #ff4500;">360.0</span> - <span style="color: #ff4500;">180.0</span>
    lat_rad = <span style="color: #dc143c;">math</span>.<span style="color: black;">atan</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">math</span>.<span style="color: black;">sinh</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">math</span>.<span style="color: black;">pi</span> <span style="color: #66cc66;">*</span> <span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span> - <span style="color: #ff4500;">2</span> <span style="color: #66cc66;">*</span> ytile / n<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
    lat_deg = <span style="color: #dc143c;">math</span>.<span style="color: black;">degrees</span><span style="color: black;">&#40;</span>lat_rad<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: black;">&#40;</span>lat_deg, lon_deg<span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># obtenir une les map qui contienne les coordonnées suivantes</span>
<span style="color: #808080; font-style: italic;"># Une tile est un morceau de carte qu'on compte utiliser pour faire une</span>
<span style="color: #808080; font-style: italic;"># carte plus grosse en assemblant les parties</span>
<span style="color: #ff7700;font-weight:bold;">def</span> get_tile<span style="color: black;">&#40;</span>z, x, y<span style="color: black;">&#41;</span>:
    lon_deg, lat_deg = num2deg<span style="color: black;">&#40;</span>z, x, y<span style="color: black;">&#41;</span>
    <span style="color: #dc143c;">logging</span>.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;conv deg: %f, %f&quot;</span> <span style="color: #66cc66;">%</span> <span style="color: black;">&#40;</span>lon_deg, lat_deg<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
    db = load_db<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
    filename = find<span style="color: black;">&#40;</span>db, lon_deg, lat_deg<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> filename
&nbsp;
<span style="color: #808080; font-style: italic;"># Une version plus simple de find_map_by_coordinate.py qui utilise</span>
<span style="color: #808080; font-style: italic;"># if __name__ == &quot;__main__&quot; à bon escient</span>
<span style="color: #ff7700;font-weight:bold;">if</span> __name__ == <span style="color: #483d8b;">&quot;__main__&quot;</span>:
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #008000;">len</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">sys</span>.<span style="color: black;">argv</span><span style="color: black;">&#41;</span> <span style="color: #66cc66;">&gt;</span>= <span style="color: #ff4500;">3</span>:
        x = ast.<span style="color: black;">literal_eval</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">sys</span>.<span style="color: black;">argv</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
        y = ast.<span style="color: black;">literal_eval</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">sys</span>.<span style="color: black;">argv</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">else</span>:
        x = <span style="color: black;">&#40;</span><span style="color: #ff4500;">48</span>, <span style="color: #ff4500;">41.29</span><span style="color: black;">&#41;</span>
        y = <span style="color: black;">&#40;</span><span style="color: #ff4500;">2</span>, <span style="color: #ff4500;">22</span><span style="color: black;">&#41;</span>
&nbsp;
    db = load_db<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #dc143c;">logging</span>.<span style="color: black;">info</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Searching %f, %f...&quot;</span> <span style="color: #66cc66;">%</span> <span style="color: black;">&#40;</span>x, y<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
    r = find<span style="color: black;">&#40;</span>db, x, y<span style="color: black;">&#41;</span>
    <span style="color: #dc143c;">logging</span>.<span style="color: black;">info</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;...found: %s&quot;</span> <span style="color: #66cc66;">%</span> r<span style="color: black;">&#41;</span></pre></div></div>

<p>En conclusion, &#8220;tout est bien qui part à point sous les ponts&#8221;.</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=6518&amp;md5=5d5b8f2104135522e2b34ae9c890c634" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/notre-programme-envoyez-nous-les-scripts-que-vous-ne-pigez-pas-est-toujours-dactu/feed/</wfw:commentRss>
		<slash:comments>9</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fnotre-programme-envoyez-nous-les-scripts-que-vous-ne-pigez-pas-est-toujours-dactu%2F&amp;language=en_GB&amp;category=text&amp;title=Notre+programme+%26%238220%3BEnvoyez+nous+les+scripts+que+vous+ne+pigez+pas%26%238221%3B+est+toujours+d%26%238217%3Bactu&amp;description=Bon%2C+je+me+tra%C3%AEne+comme+une+limace+h%C3%A9mipl%C3%A9gique+pour+les+pondre+mais+comme+on+dit%2C+%26%238220%3Bqui+vol+un+cheval+donn%C3%A9+qu%26%238217%3B%C3%A0+la+fin+l%26%238217%3B%C3%A9tincelle+se+casse%26%238221%3B.+Salut%2C+je+viens+de...&amp;tags=gis%2Cpython%2Cscript%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/07/8BAESr7.jpg" length="103728" type="image/jpg" />	</item>
	</channel>
</rss>
