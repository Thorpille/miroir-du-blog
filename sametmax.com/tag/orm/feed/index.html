<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Sam &#38; Max: Python, Django, Git et du cul &#187; orm</title>
	<atom:link href="http://sametmax.com/tag/orm/feed/" rel="self" type="application/rss+xml" />
	<link>http://sametmax.com</link>
	<description>Deux développeurs en vadrouille qui se sortent les doigts du code</description>
	<lastBuildDate>Mon, 02 Dec 2013 10:02:45 +0000</lastBuildDate>
	<language>en</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>http://wordpress.org/?v=3.3.1</generator>
	<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2F&amp;language=en_US&amp;category=text&amp;title=Sam+%26amp%3B+Max%3A+Python%2C+Django%2C+Git+et+du+cul&amp;description=Deux+d%C3%A9veloppeurs+en+vadrouille+qui+se+sortent+les+doigts+du+code&amp;tags=blog" type="text/html" />
		<item>
		<title>Compter les doublons avec l&#8217;ORM Django</title>
		<link>http://sametmax.com/compter-les-doublons-avec-lorm-django/</link>
		<comments>http://sametmax.com/compter-les-doublons-avec-lorm-django/#comments</comments>
		<pubDate>Fri, 22 Nov 2013 08:28:48 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[group by]]></category>
		<category><![CDATA[orm]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=7761</guid>
		<description><![CDATA[<code>GROUP BY </code>et <code>HAVING</code> sont assez peu intuitifs en SQL, et encore moins avec l'ORM Django.]]></description>
			<content:encoded><![CDATA[<p><code>GROUP BY </code>et <code>HAVING</code> sont assez peu intuitifs en SQL, et encore moins avec l&#8217;ORM Django.</p>
<p>Voici donc la recette pour compter le nombre d’occurrences des valeurs d&#8217;un champ, pour par exemple trouver les doublons.</p>
<p>En supposant une table <code>Massage</code> avec une valeur <code>finish</code> :</p>
<pre>
ID         FINISH
1          manuel
2          oral
3          oral
4          oral
</pre>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> Massage.<span style="color: black;">objects</span>.<span style="color: black;">values</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'finish'</span><span style="color: black;">&#41;</span>.<span style="color: black;">annotate</span><span style="color: black;">&#40;</span>count=Count<span style="color: black;">&#40;</span><span style="color: #483d8b;">'id'</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
<span style="color: black;">&#123;</span><span style="color: #483d8b;">'manuel'</span>: <span style="color: #ff4500;">2</span>, <span style="color: #483d8b;">'oral'</span>: <span style="color: #483d8b;">'9'</span>: <span style="color: #483d8b;">'rectal'</span>: <span style="color: #ff4500;">1</span>, <span style="color: #483d8b;">'paradoxal'</span>: -<span style="color: #ff4500;">1</span><span style="color: black;">&#125;</span></pre></div></div>

<p>Pour obtenir uniquement les doublons, il suffit de filtrer pour avoir les valeurs qui ont un <code>count</code> plus grand que 1 :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">Massage.<span style="color: black;">objects</span>.<span style="color: black;">values</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'finish'</span><span style="color: black;">&#41;</span>.<span style="color: black;">annotate</span><span style="color: black;">&#40;</span>count=Count<span style="color: black;">&#40;</span><span style="color: #483d8b;">'id'</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>.<span style="color: #008000;">filter</span><span style="color: black;">&#40;</span>count__gt=<span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span></pre></div></div>

 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=7761&amp;md5=70ebd178c4abc22f9fe60ba0f38b5e38" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/compter-les-doublons-avec-lorm-django/feed/</wfw:commentRss>
		<slash:comments>11</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fcompter-les-doublons-avec-lorm-django%2F&amp;language=en_GB&amp;category=text&amp;title=Compter+les+doublons+avec+l%26%238217%3BORM+Django&amp;description=GROUP+BY+et+HAVING+sont+assez+peu+intuitifs+en+SQL%2C+et+encore+moins+avec+l%26%238217%3BORM+Django.+Voici+donc+la+recette+pour+compter+le+nombre+d%E2%80%99occurrences+des+valeurs+d%26%238217%3Bun+champ%2C+pour...&amp;tags=django%2Cgroup+by%2Corm%2Cpython%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/11/91390283.png" length="434902" type="image/jpg" />	</item>
		<item>
		<title>Avez vous une méthode &#8220;propre&#8221; pour jouer avec des Objets du model sans les sauvegarder en BDD sur #Django ?</title>
		<link>http://sametmax.com/avez-vous-un-methode-propre-pour-jouer-avec-des-objets-du-model-sans-les-sauvegarder-en-bdd-sur-django/</link>
		<comments>http://sametmax.com/avez-vous-un-methode-propre-pour-jouer-avec-des-objets-du-model-sans-les-sauvegarder-en-bdd-sur-django/#comments</comments>
		<pubDate>Thu, 23 May 2013 07:53:14 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[orm]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=6204</guid>
		<description><![CDATA[Oui]]></description>
			<content:encoded><![CDATA[<p>Mais oui <a href="https://twitter.com/CedricTouit/status/337288682803449856">cher interlocuter du Web</a>.</p>
<p>Créer un fichier &#8220;settings_test.py&#8221; à côté du fichier de settings, qui contient ça:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">from</span> settings <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #66cc66;">*</span>
&nbsp;
DATABASES<span style="color: black;">&#91;</span><span style="color: #483d8b;">'default'</span><span style="color: black;">&#93;</span> = <span style="color: black;">&#123;</span>
    <span style="color: #483d8b;">'ENGINE'</span>: <span style="color: #483d8b;">'django.db.backends.sqlite3'</span>,
    <span style="color: #483d8b;">'NAME'</span>: <span style="color: #483d8b;">':memory:'</span>,
<span style="color: black;">&#125;</span></pre></div></div>

<p>Et lancer les commandes <code>./manage.py</code> avec <code>--settings=settings_test</code> :</p>
<p>Par exemple :</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;">.<span style="color: #000000; font-weight: bold;">/</span>manage.py shell <span style="color: #660033;">--settings</span>=settings_test
&nbsp;
.<span style="color: #000000; font-weight: bold;">/</span>manage.py runserver <span style="color: #660033;">--settings</span>=settings_test</pre></div></div>

<p>Et voilà, toute manipulation va automatiquement sauvegarder les données en mémoire vive, et pas dans votre base de données initiale. Elles seront perdues à chaque redémarrage.</p>
<p>D&#8217;une manière générale, souvenez vous que vous pouvez faire autant de configurations alternatives et même dynamiques que vous le souhaitez avec les fichiers de settings : c&#8217;est juste du Python.</p>
<p>Si vous avez besoin des données de votre base de données initiale, vous pouvez faire une copie de la base de données et changer <code>DATABASES</code> pour pointer sur cette copie. Du coup vous manipulerez votre copie, et pas la base de données initiale.</p>
<p>Enfin, on peut <a href="https://docs.djangoproject.com/en/dev/topics/db/multi-db/">manipuler plusieurs bases de données en même temps</a> en faisant plusieurs entrées dans <code>DATABASES</code> (une &#8216;default&#8217;, une &#8216;test&#8217;, une &#8216;prod&#8217;, etc), par exemple :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">DATABASES = <span style="color: black;">&#123;</span>
    <span style="color: #483d8b;">'default'</span>: <span style="color: black;">&#123;</span>
        <span style="color: #483d8b;">'ENGINE'</span>: <span style="color: #483d8b;">'django.db.backends.postgresql_psycopg2'</span>,
        <span style="color: #483d8b;">'USER'</span>: <span style="color: #483d8b;">'postgres'</span>,
        <span style="color: #483d8b;">'PASSWORD'</span>: <span style="color: #483d8b;">'secret of mana'</span>
    <span style="color: black;">&#125;</span>
    <span style="color: #483d8b;">'test'</span>: <span style="color: black;">&#123;</span>
    <span style="color: #483d8b;">'ENGINE'</span>: <span style="color: #483d8b;">'django.db.backends.sqlite3'</span>,
    <span style="color: #483d8b;">'NAME'</span>: <span style="color: #483d8b;">':memory:'</span>,
    <span style="color: black;">&#125;</span>
<span style="color: black;">&#125;</span></pre></div></div>

<p>On peut alors spécifier la base de données à utiliser, soit par paramètre de <code>./manage.py</code> (<code>--database=bdd_a_utiliser</code>), soit directement dans le code de manipulation de l&#8217;ORM avec <code>using</code> :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> Model.<span style="color: black;">objects</span>.<span style="color: #008000;">all</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># tape dans le BDD par défaut</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> Model.<span style="color: black;">objects</span>.<span style="color: black;">using</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'test'</span><span style="color: black;">&#41;</span>.<span style="color: #008000;">all</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># tape dans la bdd de test</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> mon_model.<span style="color: black;">save</span><span style="color: black;">&#40;</span>using=<span style="color: #483d8b;">'test'</span><span style="color: black;">&#41;</span> <span style="color: #808080; font-style: italic;"># sauvegarde dans la bdd de test</span></pre></div></div>

 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=6204&amp;md5=228a632ae0f4e25fd348d43cb9d8ce66" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/avez-vous-un-methode-propre-pour-jouer-avec-des-objets-du-model-sans-les-sauvegarder-en-bdd-sur-django/feed/</wfw:commentRss>
		<slash:comments>3</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Favez-vous-un-methode-propre-pour-jouer-avec-des-objets-du-model-sans-les-sauvegarder-en-bdd-sur-django%2F&amp;language=en_GB&amp;category=text&amp;title=Avez+vous+une+m%C3%A9thode+%26%238220%3Bpropre%26%238221%3B+pour+jouer+avec+des+Objets+du+model+sans+les+sauvegarder+en+BDD+sur+%23Django+%3F&amp;description=Mais+oui+cher+interlocuter+du+Web.+Cr%C3%A9er+un+fichier+%26%238220%3Bsettings_test.py%26%238221%3B+%C3%A0+c%C3%B4t%C3%A9+du+fichier+de+settings%2C+qui+contient+%C3%A7a%3A+from+settings+import+%2A+%26nbsp%3B+DATABASES%26%2391%3B%27default%27%26%2393%3B+%3D+%26%23123%3B+%27ENGINE%27%3A+%27django.db.backends.sqlite3%27%2C+%27NAME%27%3A...&amp;tags=django%2Corm%2Cpython%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/05/tumblr_mmy1izVV8O1r539hzo1_500.jpg" length="51663" type="image/jpg" />	</item>
		<item>
		<title>Modèles Django et classes abstraites</title>
		<link>http://sametmax.com/modeles-django-et-classes-abstraites/</link>
		<comments>http://sametmax.com/modeles-django-et-classes-abstraites/#comments</comments>
		<pubDate>Fri, 01 Feb 2013 12:40:23 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[abstract class]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[model]]></category>
		<category><![CDATA[orm]]></category>
		<category><![CDATA[poo]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=4361</guid>
		<description><![CDATA[<strong>Je suis le génie de la l'ANPE. Enigma, tu m'as trouvé, et tu as le droit à 3 voeux.</strong>]]></description>
			<content:encoded><![CDATA[<blockquote><p>    Bonjour Sam &#038; Max,</p></blockquote>
<p><strong>Je suis le génie de la l&#8217;ANPE. Enigma, tu m&#8217;as trouvé, et tu as le droit à 3 voeux.</strong></p>
<blockquote><p>    J&#8217;ai bien aimé votre blog consacré a dynamiser la communauté francophone python et je voudrais vous poser une petite question.<br />
    En fait, Quand il s&#8217;agit d&#8217;écrire un modèle, ce dernier doit hériter de la classe models.Model</p>
<p>    par exemple:<br />
    class Entry(models.Model):</p>
<p>    je me demande pourquoi exactement models.Model ?<br />
    et pourquoi ne pas faire l&#8217;héritage directement comme ça:<br />
    class Entry(Model)</p></blockquote>
<p><strong><br />
Une explication de la syntaxe d&#8217;héritage des modèles Django ? Qu&#8217;il en soit ainsi.</strong></p>
<p>On peut faire les deux. C&#8217;est une question d&#8217;import.</p>
<p>Si tu fais:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">from</span> django <span style="color: #ff7700;font-weight:bold;">import</span> models</pre></div></div>

<p>Tu importes le module <code>models</code>.</p>
<p>Alors si tu veux hériter de la classe <code>Model</code> du module <code>models</code>, tu dois préfixer la classe du module (c&#8217;est ce qu&#8217;on appelle un namespace) : <code>class Entry(models.Model)</code>.</p>
<p>Si par contre tu fais :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">from</span> django.<span style="color: black;">models</span> <span style="color: #ff7700;font-weight:bold;">import</span> Model</pre></div></div>

<p>Tu importes la classe <code>Model</code>. Tu peux donc l&#8217;utiliser directement : <code>class Entry(Model)</code></p>
<p>Le choix entre l&#8217;un et l&#8217;autre est essentiellement une question de style. En Django, pour les modèles on utilise <code>from django import models</code> car on va généralement également utiliser beaucoup de champs (<code>models.IntegerField</code>, <code>models.BooleanField</code>, etc) et que ça évite de tous les importer.</p>
<blockquote><p>Aussi, je voudrais savoir qu&#8217;est ce qu&#8217;une Abstract base class ? ( car je sais que c&#8217;est un peu ça mais j&#8217;arrive pas à faire le lien )</p></blockquote>
<p><strong><br />
Je ne peux pas faire tomber amoureux, ressusciter les morts ni faire des classes abstraites en Python. Mais je peux t&#8217;expliquer pourquoi. Accordé !</strong></p>
<p>Une Abstract Base Class n&#8217;existe pas vraiment en Python. Il y a bien un module <a href="http://docs.python.org/2/library/abc.html?highlight=abc#abc">abc</a> pour les simuler en utilisant des metaclasses, mais il est peu probable que tu en aies jamais besoin.</p>
<p>Dans d&#8217;autres langages, les classes abstraites sont des classes &#8220;à trou&#8221;. C&#8217;est à dire qu&#8217;elles ne sont pas complètes. On en hérite pour récupérer une partie de leur comportement, et on écrit le reste. </p>
<p>Imagine une classe <code>Vehicule</code>, qui sert de classe de base à une classe <code>Voiture</code> et une classe <code>Moto</code> :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">class</span> Vehicule<span style="color: black;">&#40;</span><span style="color: #008000;">object</span><span style="color: black;">&#41;</span>:
&nbsp;
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__init__</span><span style="color: black;">&#40;</span>carburant<span style="color: black;">&#41;</span>:
&nbsp;
        <span style="color: #008000;">self</span>.<span style="color: black;">carburant</span> = carburant</pre></div></div>

<p>Ceci est une classe abstraite. Elle possède des éléments communs à tous les véhicules, mais ne sait pas rouler. Chaque enfant doit implémenter la méthode <code>rouler()</code> :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">class</span> Moto<span style="color: black;">&#40;</span>Vehicule<span style="color: black;">&#41;</span>:
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> rouler<span style="color: black;">&#40;</span>km<span style="color: black;">&#41;</span>:
&nbsp;
        <span style="color: #008000;">self</span>.<span style="color: black;">carburant</span> -= km <span style="color: #66cc66;">*</span> <span style="color: #ff4500;">3</span>
        <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">'Brrrrrrrrrrrrrrrrrr'</span>
&nbsp;
&nbsp;
<span style="color: #ff7700;font-weight:bold;">class</span> Voiture<span style="color: black;">&#40;</span>Vehicule<span style="color: black;">&#41;</span>:
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> rouler<span style="color: black;">&#40;</span>km<span style="color: black;">&#41;</span>:
&nbsp;
        <span style="color: #008000;">self</span>.<span style="color: black;">carburant</span> -= km <span style="color: #66cc66;">*</span> <span style="color: #ff4500;">7</span>
        <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">'Vrouuuuuuum'</span></pre></div></div>

<p>Une classe abstraite est donc une classe incomplète, utile pour rassembler du code commun aux autres classes, <strong>mais qui ne marche pas d&#8217;elle même.</strong></p>
<p>Dans d&#8217;autres langages, ce concept est formalisé par des mots clés, et des vérifications. Pas en Python : toutes les classes sont égales.</p>
<p>Maintenant le concept des classes abstraites dans Django est une application particulière. Je pense que tu poses la question parce que tu as vu ça :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">class</span> Vehicule<span style="color: black;">&#40;</span>models.<span style="color: black;">Model</span><span style="color: black;">&#41;</span>:
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">class</span> Meta:
&nbsp;
        abstract = <span style="color: #008000;">True</span></pre></div></div>

<p>Dans ce cas particulier, le principe est le même que plus haut, mais appliqué aux models.</p>
<p>L&#8217;ORM de django crée en base de donnée une table par classe qui hérite de <code>models.Model</code>. Ce n&#8217;est pas ce que tu veux pour <code>Vehicule</code> : <code>Vehicule</code> ne marche pas par elle même, aucun intérêt de créer une table pour elle.</p>
<p>Ainsi Django le formalise l&#8217;aspect &#8220;abstrait&#8221; avec un attribut. Si l&#8217;attribut <code>abstract</code> est sur <code>True</code>, Django ne créera pas de table en base de donnée pour ce modèle, car il sait que c&#8217;est une classe abstraite, et qui donc n&#8217;est pas destinée à être utilisée directement. Tous les attributs  du modèle <code>Vehicule</code> qui correspondent à des champs seront copiés dans les enfants, et seront des champs de leurs tables respectives.</p>
<blockquote><p>Je vous remercie d&#8217;avance, et j&#8217;aimerais bien si c&#8217;est possible que la réponse soit comme le prochain sujet comme ça tout le monde en profite. </p></blockquote>
<p><strong><br />
Tes désirs sont des ordres, maître.<br />
</strong><br />
(Comme d&#8217;hab, personne ne fait le v&oelig;u de libérer le génie, hein, bande de connards !)</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=4361&amp;md5=f4d60eab3da6f62f6b65c43480e36fa5" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/modeles-django-et-classes-abstraites/feed/</wfw:commentRss>
		<slash:comments>16</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fmodeles-django-et-classes-abstraites%2F&amp;language=en_GB&amp;category=text&amp;title=Mod%C3%A8les+Django+et+classes+abstraites&amp;description=Bonjour+Sam+%26%23038%3B+Max%2C+Je+suis+le+g%C3%A9nie+de+la+l%26%238217%3BANPE.+Enigma%2C+tu+m%26%238217%3Bas+trouv%C3%A9%2C+et+tu+as+le+droit+%C3%A0+3+voeux.+J%26%238217%3Bai+bien+aim%C3%A9+votre+blog+consacr%C3%A9+a...&amp;tags=abstract+class%2Cdjango%2Cmodel%2Corm%2Cpoo%2Cpython%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/02/genie.jpg" length="28719" type="image/jpg" />	</item>
		<item>
		<title>Utiliser des UUID comme primary key avec l&#8217;ORM de Django</title>
		<link>http://sametmax.com/utiliser-des-uuid-comme-primary-key-avec-lorm-de-django/</link>
		<comments>http://sametmax.com/utiliser-des-uuid-comme-primary-key-avec-lorm-de-django/#comments</comments>
		<pubDate>Thu, 06 Dec 2012 14:59:29 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[orm]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[uuid]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=3505</guid>
		<description><![CDATA[Par défaut Django ajoute automatiquement un champ <code>id</code> à tous les modèles, et le configure pour être un entier qui s'auto incrémente puis le désigne comme la clé primaire. Il est néanmoins possible d'utiliser un autre champ comme clé primaire pour sa table: un <a href="http://sametmax.com/slug-dune-chaine-de-caracteres-non-ascii-avec-django-et-unidecode/">slug</a> ou un <a href="https://fr.wikipedia.org/wiki/Num%C3%A9ro_de_s%C3%A9curit%C3%A9_sociale_en_France">identifiant métier</a>. Dans notre cas, on va voir comme utiliser un UUID.]]></description>
			<content:encoded><![CDATA[<p>Par défaut Django ajoute automatiquement un champ <code>id</code> à tous les modèles, et le configure pour être un entier qui s&#8217;auto incrémente puis le désigne comme la clé primaire. Il est néanmoins possible d&#8217;utiliser un autre champ comme clé primaire pour sa table: un <a href="http://sametmax.com/slug-dune-chaine-de-caracteres-non-ascii-avec-django-et-unidecode/">slug</a> ou un <a href="https://fr.wikipedia.org/wiki/Num%C3%A9ro_de_s%C3%A9curit%C3%A9_sociale_en_France">identifiant métier</a>. Dans notre cas, on va voir comment utiliser un <a href="http://sametmax.com/quest-ce-quun-uuid-et-a-quoi-ca-sert/">UUID</a>.</p>
<p>Un UUID est un identifiant généré de manière pseudo aléatoire qui a une forte probabilité d&#8217;être unique dans le monde entier, il y a 4&#215;10³⁷ combinaisons possibles pour les versions des algos récents. Selon le <a href="https://fr.wikipedia.org/wiki/Paradoxe_des_anniversaires">paradoxe des anniversaires</a>, il faudrait créer un milliard de UUID par seconde pendant 100 ans pour que le prochain ait 50% de chance d&#8217;être un doublon. Normalement pour votre site de fans club des limules hermaphrodites, ça devrait être suffisant.</p>
<p>Utiliser des UUID possède de <a href="http://www.codinghorror.com/blog/2007/03/primary-keys-ids-versus-guids.html">nombreux avantages</a> car ils sont plus ou moins garantis d&#8217;être uniques, et ainsi:</p>
<ul>
<li>Vos serveurs peuvent les générer indépendemment les uns des autres.</li>
<li>.<code>/manage.py loadata</code> ne va pas vous crasher à la gueule à cause d&#8217;une duplicate key.</li>
<li>On peut faire du <a href="http://en.wikipedia.org/wiki/Shard_%28database_architecture%29">sharding</a> sur la clé très facilement.</li>
<li>Faire des réplications et des synchronisations est beaucoup plus simple qu&#8217;avec un <code>AUTO INT</code>.</li>
<li>Votre modèle n&#8217;a pas besoin d&#8217;un champ significatif pour être unique.</li>
<li>Vous pouvez générer l&#8217;ID côté client et l&#8217;envoyer au serveur.</li>
<li>Faire communiquer des systèmes complètement séparés, différents ou par API interposée ne pose aucun problème de référence.</li>
</ul>
<p>Pour toutes ces raisons, les bases de données NoSQL (CouchDB, MongoDB, etc) utilisent depuis longtemps les UUID comme clés primaires par défaut. Le moteur de base de données de Google, Big Table, utilise des UUID.</p>
<p>Pourtant les UUID ne sont pas exempts de défauts:</p>
<ul>
<li>Les JOINS sont beaucoup plus lents.</li>
<li>Il prennent plus d&#8217;espace disque et en mémoire.</li>
<li>On ne peut pas les mettre dans des URL sans que ce soit très très moche.</li>
<li>Ils sont difficiles à retenir, dicter et rechercher manuellement.</li>
<li>Ils sont non significatifs. Regardez un UUID ne vous donne aucune info sur les données sous-jacentes.</li>
<li>Ils ne sont pas ordonnés. Cela a un impact sur la manipulation des données, et sur certains moteurs de BDD à l&#8217;insertion.</li>
</ul>
<p>Les UUID ne sont donc pas la solution miracle à tous les soucis, mais ils sont tout de même mon choix par défaut en ce moment ne serait-ce que pour les fixtures. Je gagne les performances sur le caching et le parallélisme, et <a href="http://www.codeproject.com/Articles/388157/GUIDs-as-fast-primary-keys-under-multiple-database">un peu de lenteur sur les JOINS</a> est quelque chose que je peux supporter. Pour les gros sites, les JOINS sont de tout façon votre ennemi juré et on finit toujours par tweaker à grand coup de dé-normalisation.</p>
<p>On peut faire passer ses modèles Django aux UUID en faisant:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">from</span> uuid <span style="color: #ff7700;font-weight:bold;">import</span> uuid4
&nbsp;
<span style="color: #ff7700;font-weight:bold;">class</span> MotDElle<span style="color: black;">&#40;</span><span style="color: #008000;">object</span><span style="color: black;">&#41;</span>:
    ...
    <span style="color: #008000;">id</span> = models.<span style="color: black;">CharField</span><span style="color: black;">&#40;</span>max_length=<span style="color: #ff4500;">36</span>, primary_key=<span style="color: #008000;">True</span>,
                          default=<span style="color: #ff7700;font-weight:bold;">lambda</span>: <span style="color: #008000;">str</span><span style="color: black;">&#40;</span>uuid4<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>, editable=<span style="color: #008000;">False</span><span style="color: black;">&#41;</span></pre></div></div>

<p>Ou, si vous utilisez <a href="https://github.com/django-extensions/django-extensions">django_extensions</a> (et vous devriez, ne serait-ce que pour <code>shell_plus</code> et <code>runserver_plus</code>):</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">from</span> django_extensions.<span style="color: black;">db</span>.<span style="color: black;">fields</span> <span style="color: #ff7700;font-weight:bold;">import</span> UUIDField
&nbsp;
<span style="color: #ff7700;font-weight:bold;">class</span> MotDElle<span style="color: black;">&#40;</span><span style="color: #008000;">object</span><span style="color: black;">&#41;</span>:
    ...
    <span style="color: #008000;">id</span> = UUIDField<span style="color: black;">&#40;</span>primary_key=<span style="color: #008000;">True</span><span style="color: black;">&#41;</span></pre></div></div>

<p>Ce qui a l&#8217;avantage de caster la valeur en un objet UUID, et non une bête string, à la lecture.</p>
<p>Malheureusement, pour le moment il n&#8217;y a aucune implémentation officielle de Django pour utiliser les UUID. Cela a des conséquences fort ennuyeuses:</p>
<ul>
<li>Les implémentations actuelles utilisent un <code>VARCHAR</code> pour stocker l&#8217;UUID au lieu d&#8217;un type natif quand c&#8217;est possible, et donc ce n&#8217;est pas du tout optimisé. L&#8217;exception étant <a href="https://github.com/jpwatts/django-pgfields">django-pdfield</a>, mais dans ce cas, adieu la compatibilité entre plusieurs SGBD.</li>
<li><code>django.contrib.auth.models.User</code> n&#8217;a aucun moyen d&#8217;utiliser proprement les UUID (il ne vous reste que le monkey patching). Cela pourrait changer avec Django 1.5 qui prévoit un modèle <code>User</code> extensible. \o/</li>
</ul>
<p>Un <a href="https://code.djangoproject.com/ticket/4682">ticket</a> pendouille depuis 5 ans sur la question. Je vous invite d&#8217;ailleurs à le spammer jusqu&#8217;à ce que réouverture s&#8217;en suive. Et le premier qui me dit &#8220;t&#8217;as qu&#8217;à l&#8217;implémenter, toi&#8221;, je lui retourne un tampon dans la poire.</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=3505&amp;md5=30f842fd13c80c874bda6e3439f07780" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/utiliser-des-uuid-comme-primary-key-avec-lorm-de-django/feed/</wfw:commentRss>
		<slash:comments>5</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Futiliser-des-uuid-comme-primary-key-avec-lorm-de-django%2F&amp;language=en_GB&amp;category=text&amp;title=Utiliser+des+UUID+comme+primary+key+avec+l%26%238217%3BORM+de+Django&amp;description=Par+d%C3%A9faut+Django+ajoute+automatiquement+un+champ+id+%C3%A0+tous+les+mod%C3%A8les%2C+et+le+configure+pour+%C3%AAtre+un+entier+qui+s%26%238217%3Bauto+incr%C3%A9mente+puis+le+d%C3%A9signe+comme+la+cl%C3%A9+primaire.+Il...&amp;tags=django%2Corm%2Cpython%2Cuuid%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2012/12/Unique.jpg" length="29673" type="image/jpg" />	</item>
		<item>
		<title>Log des requêtes SQL faites par l&#8217;ORM Django en temps réel</title>
		<link>http://sametmax.com/log-des-requetes-sql-faites-par-lorm-django-en-temps-reel/</link>
		<comments>http://sametmax.com/log-des-requetes-sql-faites-par-lorm-django-en-temps-reel/#comments</comments>
		<pubDate>Fri, 16 Mar 2012 17:30:01 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[log]]></category>
		<category><![CDATA[orm]]></category>
		<category><![CDATA[sql]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=262</guid>
		<description><![CDATA[Il existe une solution plus simple que  la <code>django-debug-toolbar</code> ou <code>connection.queries</code> pour suivre les requêtes SQL de l'ORM Django.]]></description>
			<content:encoded><![CDATA[<p>Même en recherchant sur les sites spécialisés en anglais, je tombe toujours sur des solutions basées sur la <a href="https://github.com/django-debug-toolbar/django-debug-toolbar">django-debug-toolbar</a>, l&#8217;affichage de <a href="https://docs.djangoproject.com/en/dev/faq/models/#how-can-i-see-the-raw-sql-queries-django-is-running">connection.queries</a> ou l&#8217;usage de <a href="https://github.com/dcramer/django-devserver">devserver</a>. Ça a son utilité (surtout la fabuleuse <code>django-debug-toolbar</code>), mais c&#8217;est compliqué, long à mettre en oeuvre, et pas très pratique. </p>
<p>Il a beaucoup plus simple, et le plus beau, c&#8217;est que Django le propose en natif.</p>
<p>Par default, Django loggue toutes les requêtes SQL dans <em>django.db.backends</em> si <code>DEBUG = True</code>. Il suffit donc de configurer le logger, dans votre <em>settings.py</em>:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">os</span>
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">tempfile</span>
&nbsp;
LOGGING = <span style="color: black;">&#123;</span>
    <span style="color: #483d8b;">'version'</span>: <span style="color: #ff4500;">1</span>,
    <span style="color: #483d8b;">'disable_existing_loggers'</span>: <span style="color: #008000;">False</span>,
    <span style="color: #483d8b;">'formatters'</span>: <span style="color: black;">&#123;</span>
        <span style="color: #483d8b;">'verbose'</span>: <span style="color: black;">&#123;</span>
            <span style="color: #483d8b;">'format'</span>: <span style="color: #483d8b;">'%(levelname)s %(asctime)s %(module)s %(process)d %(thread)d %(message)s'</span>
        <span style="color: black;">&#125;</span>,
        <span style="color: #483d8b;">'simple'</span>: <span style="color: black;">&#123;</span>
            <span style="color: #483d8b;">'format'</span>: <span style="color: #483d8b;">'%(levelname)s %(message)s'</span>
        <span style="color: black;">&#125;</span>,
    <span style="color: black;">&#125;</span>,
    <span style="color: #483d8b;">'handlers'</span>: <span style="color: black;">&#123;</span>
        <span style="color: #483d8b;">'tempfile'</span>: <span style="color: black;">&#123;</span>
            <span style="color: #483d8b;">'level'</span>: <span style="color: #483d8b;">'DEBUG'</span>,
            <span style="color: #483d8b;">'class'</span>: <span style="color: #483d8b;">'logging.handlers.RotatingFileHandler'</span>,
            <span style="color: #483d8b;">'formatter'</span>: <span style="color: #483d8b;">'verbose'</span>,
            <span style="color: #483d8b;">'filename'</span>: <span style="color: #dc143c;">os</span>.<span style="color: black;">path</span>.<span style="color: black;">join</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">tempfile</span>.<span style="color: black;">gettempdir</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>, <span style="color: #483d8b;">'django-debug.log'</span><span style="color: black;">&#41;</span>,
        <span style="color: black;">&#125;</span>,
        <span style="color: #483d8b;">'console'</span>:<span style="color: black;">&#123;</span>
            <span style="color: #483d8b;">'level'</span>:<span style="color: #483d8b;">'DEBUG'</span>,
            <span style="color: #483d8b;">'class'</span>:<span style="color: #483d8b;">'logging.StreamHandler'</span>,
            <span style="color: #483d8b;">'formatter'</span>: <span style="color: #483d8b;">'simple'</span>
        <span style="color: black;">&#125;</span>,
    <span style="color: black;">&#125;</span>,
    <span style="color: #483d8b;">'loggers'</span>: <span style="color: black;">&#123;</span>
        <span style="color: #483d8b;">'django.db.backends'</span>: <span style="color: black;">&#123;</span>
            <span style="color: #483d8b;">'handlers'</span>: <span style="color: black;">&#91;</span><span style="color: #483d8b;">'console'</span>, <span style="color: #483d8b;">'tempfile'</span><span style="color: black;">&#93;</span>,
            <span style="color: #483d8b;">'level'</span>: <span style="color: #483d8b;">'DEBUG'</span>,
            <span style="color: #483d8b;">'propagate'</span>: <span style="color: #008000;">True</span>,
        <span style="color: black;">&#125;</span>,
    <span style="color: black;">&#125;</span>,
<span style="color: black;">&#125;</span></pre></div></div>

<p>Lancez <code>./manage.py shell</code>:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">In <span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span><span style="color: black;">&#93;</span>: m = Table.<span style="color: black;">objects</span>.<span style="color: #008000;">filter</span><span style="color: black;">&#40;</span>title__isnull=<span style="color: #008000;">False</span><span style="color: black;">&#41;</span>
&nbsp;
In <span style="color: black;">&#91;</span><span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span>: m
DEBUG <span style="color: black;">&#40;</span><span style="color: #ff4500;">0.018</span><span style="color: black;">&#41;</span> SELECT <span style="color: #483d8b;">&quot;table&quot;</span>.<span style="color: #483d8b;">&quot;id&quot;</span>, <span style="color: #483d8b;">&quot;table&quot;</span>.<span style="color: #483d8b;">&quot;title&quot;</span>, <span style="color: #483d8b;">&quot;table&quot;</span>.<span style="color: #483d8b;">&quot;original_title&quot;</span> FROM <span style="color: #483d8b;">&quot;table&quot;</span> WHERE <span style="color: #483d8b;">&quot;table&quot;</span>.<span style="color: #483d8b;">&quot;title&quot;</span> IS NOT NULL LIMIT <span style="color: #ff4500;">21</span><span style="color: #66cc66;">;</span> args=<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
Out<span style="color: black;">&#91;</span><span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span>: <span style="color: black;">&#91;</span><span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #66cc66;">&lt;</span> Table <span style="color: #008000;">object</span> <span style="color: #66cc66;">&gt;</span>, <span style="color: #483d8b;">'...(remaining elements truncated)...'</span><span style="color: black;">&#93;</span></pre></div></div>

<p>Une version plus verbeuse sera aussi logguée dans un fichier temporaire. Par exemple, sous linux il sera dans <code>/tmp/django-debug.log</code>.</p>
<p>Toutes les requêtes faites par le site Web seront également affichées dans le terminal sur lequel tourne le serveur, et dans le fichier temporaire. </p>
<p>Une fois que vous maitrisez le concept, je vous recommande plutot de mettre le logger <em>django.db.backends</em> dans votre <em>local_settings.py</em>, histoire d&#8217;éviter de l&#8217;avoir en prod:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">LOGGING<span style="color: black;">&#91;</span><span style="color: #483d8b;">'loggers'</span><span style="color: black;">&#93;</span>.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#123;</span>
        <span style="color: #483d8b;">'django.db.backends'</span>: <span style="color: black;">&#123;</span>
            <span style="color: #483d8b;">'handlers'</span>: <span style="color: black;">&#91;</span><span style="color: #483d8b;">'console'</span>, <span style="color: #483d8b;">'tempfile'</span><span style="color: black;">&#93;</span>,
            <span style="color: #483d8b;">'level'</span>: <span style="color: #483d8b;">'DEBUG'</span>,
            <span style="color: #483d8b;">'propagate'</span>: <span style="color: #008000;">True</span>,
        <span style="color: black;">&#125;</span>,
    <span style="color: black;">&#125;</span>
<span style="color: black;">&#41;</span></pre></div></div>

<p>Autre bénéfice, il suffit de commenter cette partie quand ne souhaite plus afficher autant d&#8217;information.</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=262&amp;md5=c35b72c694c7c068607463c4d98e647c" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/log-des-requetes-sql-faites-par-lorm-django-en-temps-reel/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Flog-des-requetes-sql-faites-par-lorm-django-en-temps-reel%2F&amp;language=en_GB&amp;category=text&amp;title=Log+des+requ%C3%AAtes+SQL+faites+par+l%26%238217%3BORM+Django+en+temps+r%C3%A9el&amp;description=M%C3%AAme+en+recherchant+sur+les+sites+sp%C3%A9cialis%C3%A9s+en+anglais%2C+je+tombe+toujours+sur+des+solutions+bas%C3%A9es+sur+la+django-debug-toolbar%2C+l%26%238217%3Baffichage+de%C2%A0connection.queries+ou+l%26%238217%3Busage+de+devserver.+%C3%87a+a+son+utilit%C3%A9+%28surtout%C2%A0la...&amp;tags=django%2Clog%2Corm%2Csql%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2012/03/lumber_from_log_lg.jpg" length="460459" type="image/jpg" />	</item>
	</channel>
</rss>
