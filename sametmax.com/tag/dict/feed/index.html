<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Sam &#38; Max: Python, Django, Git et du cul &#187; dict</title>
	<atom:link href="http://sametmax.com/tag/dict/feed/" rel="self" type="application/rss+xml" />
	<link>http://sametmax.com</link>
	<description>Deux développeurs en vadrouille qui se sortent les doigts du code</description>
	<lastBuildDate>Wed, 05 Feb 2014 14:20:37 +0000</lastBuildDate>
	<language>en</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>http://wordpress.org/?v=3.3.1</generator>
	<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2F&amp;language=en_US&amp;category=text&amp;title=Sam+%26amp%3B+Max%3A+Python%2C+Django%2C+Git+et+du+cul&amp;description=Deux+d%C3%A9veloppeurs+en+vadrouille+qui+se+sortent+les+doigts+du+code&amp;tags=blog" type="text/html" />
		<item>
		<title>Mesurer les performances d&#8217;un snippet Python</title>
		<link>http://sametmax.com/mesurer-les-performances-dun-snippet-python/</link>
		<comments>http://sametmax.com/mesurer-les-performances-dun-snippet-python/#comments</comments>
		<pubDate>Sat, 08 Jun 2013 20:20:52 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[dict]]></category>
		<category><![CDATA[merge]]></category>
		<category><![CDATA[perf]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=6369</guid>
		<description><![CDATA[L'open source c'est fantastique. Github c'est merveilleux. On parle de <a href="http://sametmax.com/batbelt-la-lib-des-petits-outils-python-qui-vont-bien/">batbelt</a>, et paf, quelques jours plus tard on a notre <a href="https://github.com/sametmax/Bat-belt/pull/1">première contribution</a>.]]></description>
			<content:encoded><![CDATA[<p>Ca fait longtemps que j&#8217;avais pas musique.</p>

<!-- iframe plugin v:2.3 - wordpress.org/extend/plugins/iframe/ -->
<iframe width="420" height="315" src="http://www.youtube.com/embed/qeMFqkcPYcg" frameborder="0" scrolling="no" class="iframe-class"></iframe>
<p>L&#8217;open source c&#8217;est fantastique. Github c&#8217;est merveilleux. On parle de <a href="http://sametmax.com/batbelt-la-lib-des-petits-outils-python-qui-vont-bien/">batbelt</a>, et paf, quelques jours plus tard on a notre <a href="https://github.com/sametmax/Bat-belt/pull/1">première contribution</a>.</p>
<p>Ce qui est sympa avec cette lib, c&#8217;est que ce sont des fonctions simples et courtes, axées sur des tâches très précises. Le code est donc généralement <a href="https://github.com/sametmax/Bat-belt/blob/master/batbelt/structs.py">intéressant à lire</a>, mais pas trop compliqué, et on tombe souvent sur des cas d&#8217;école.</p>
<p>C&#8217;est le cas de cette modification de la fonction <code>dmerge()</code>. Originalement, <code>dmerge</code> permet de créer un dictionnaire à partir de la fusion de de 2 autres dicos, et ça marchait comme ça:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> dmerge<span style="color: black;">&#40;</span>d1, d2<span style="color: black;">&#41;</span>:
    d = <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span>
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d1<span style="color: black;">&#41;</span>
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d2<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> d</pre></div></div>

<p>Facile à comprendre, rapide, simple, et le comportement par défaut est intuitif : si une clé est en double, la clé du deuxième dico écrase la première.</p>
<p>Comme le <a href="http://sametmax.com/batbelt-la-lib-des-petits-outils-python-qui-vont-bien/#comment-9657">précisait Etienne,</a> ce comportement est néanmoins un parmi de nombreux possibles. On pourrait aussi vouloir:</p>
<ul>
<li>Lever une exception en cas de doublon.</li>
<li>Concaténer ou additionner les doublons.</li>
<li>Mettre les doublons dans une liste.</li>
<li>Garder la valeur originale en cas de doublon.</li>
<li>Prendre la valeur la plus grande / petite en cas de doublon.</li>
<li>Etc.</li>
</ul>
<p>Pour cela, notre contributeur a proposé qu&#8217;on puisse passer en paramètre une fonction qui choisit quelle valeur garder en cas de doublon. Le code devient donc :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> dmerge<span style="color: black;">&#40;</span>d1, d2, merge_func=<span style="color: #ff7700;font-weight:bold;">lambda</span> v1, v2: v2<span style="color: black;">&#41;</span>:
    d = <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span>
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#40;</span>k, v<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k, v <span style="color: #ff7700;font-weight:bold;">in</span> d1.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> d2<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#40;</span>k, v<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k, v <span style="color: #ff7700;font-weight:bold;">in</span> d2.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> d1<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#40;</span>k, merge_func<span style="color: black;">&#40;</span>v, d2<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k, v <span style="color: #ff7700;font-weight:bold;">in</span> d1.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">in</span> d2<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> d</pre></div></div>

<p>Avoir une valeur par défaut nous permet de garder le comportement initial. Pour cela on utilise une <a href="http://sametmax.com/fonctions-anonymes-en-python-ou-lambda/">lambda</a>. C&#8217;est ce qu&#8217;on appelle l&#8217;injection de dépendance.</p>
<p>Comme j&#8217;ai bien faire mumuse avec Python, je me suis demandé : &#8220;quelle est la stratégie de merge la plus rapide ?&#8221;. J&#8217;ai donc fait plusieurs tests de merge, avec plusieurs algos. Voici ce que ça donne:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"> <span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">itertools</span> <span style="color: #ff7700;font-weight:bold;">import</span> chain
&nbsp;
&nbsp;
 <span style="color: #ff7700;font-weight:bold;">def</span> dmerge1<span style="color: black;">&#40;</span>d1, d2, merge_func=<span style="color: #008000;">None</span><span style="color: black;">&#41;</span>:
     <span style="color: #483d8b;">&quot;&quot;&quot;
         Mon premier essai, en virant la lambda et en utilisant itertools.
     &quot;&quot;&quot;</span>
     d = <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">if</span> merge_func <span style="color: #ff7700;font-weight:bold;">is</span> <span style="color: #008000;">None</span>:
&nbsp;
         d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d1<span style="color: black;">&#41;</span>
         d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d2<span style="color: black;">&#41;</span>
         <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">for</span> k, v <span style="color: #ff7700;font-weight:bold;">in</span> chain<span style="color: black;">&#40;</span>d1.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>, d2.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>:
         <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">in</span> d1 <span style="color: #ff7700;font-weight:bold;">and</span> k <span style="color: #ff7700;font-weight:bold;">in</span> d2:
             d<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span> = merge_func<span style="color: black;">&#40;</span>d1<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span>, d2<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
         <span style="color: #ff7700;font-weight:bold;">else</span>:
             d<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span> = v
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
&nbsp;
&nbsp;
 <span style="color: #ff7700;font-weight:bold;">def</span> dmerge2<span style="color: black;">&#40;</span>d1, d2, merge_func=<span style="color: #ff7700;font-weight:bold;">lambda</span> v1, v2: v2<span style="color: black;">&#41;</span>:
     <span style="color: #483d8b;">&quot;&quot;&quot;
         Le code du PR original
     &quot;&quot;&quot;</span>
     d = <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span>
     d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#40;</span>k, v<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k, v <span style="color: #ff7700;font-weight:bold;">in</span> d1.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> d2<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
     d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#40;</span>k, v<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k, v <span style="color: #ff7700;font-weight:bold;">in</span> d2.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> d1<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
     d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#40;</span>k, merge_func<span style="color: black;">&#40;</span>v, d2<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k, v <span style="color: #ff7700;font-weight:bold;">in</span> d1.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">in</span> d2<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
&nbsp;
 <span style="color: #ff7700;font-weight:bold;">def</span> dmerge3<span style="color: black;">&#40;</span>d1, d2, merge_func=<span style="color: #008000;">None</span><span style="color: black;">&#41;</span>:
     <span style="color: #483d8b;">&quot;&quot;&quot;
        Un mélange du code original et de mon premier essai.
     &quot;&quot;&quot;</span>
     d = <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span>
&nbsp;
     d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d1<span style="color: black;">&#41;</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">if</span> merge_func <span style="color: #ff7700;font-weight:bold;">is</span> <span style="color: #008000;">None</span>:
         d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d2<span style="color: black;">&#41;</span>
         <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">for</span> k, v <span style="color: #ff7700;font-weight:bold;">in</span> d2.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
         <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">in</span> d:
             d<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span> = merge_func<span style="color: black;">&#40;</span>d<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span>, v<span style="color: black;">&#41;</span>
         <span style="color: #ff7700;font-weight:bold;">else</span>:
             d<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span> = v
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
&nbsp;
&nbsp;
 <span style="color: #ff7700;font-weight:bold;">def</span> dmerge4<span style="color: black;">&#40;</span>d1, d2, merge_func=<span style="color: #008000;">None</span><span style="color: black;">&#41;</span>:
     <span style="color: #483d8b;">&quot;&quot;&quot;
         Le code original, en virant la lambda
     &quot;&quot;&quot;</span>
     d = <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">if</span> merge_func <span style="color: #ff7700;font-weight:bold;">is</span> <span style="color: #008000;">None</span>:
         d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d1<span style="color: black;">&#41;</span>
         d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d2<span style="color: black;">&#41;</span>
         <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
     d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#40;</span>k, v<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k, v <span style="color: #ff7700;font-weight:bold;">in</span> d1.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> d2<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
     d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#40;</span>k, v<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k, v <span style="color: #ff7700;font-weight:bold;">in</span> d2.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> d1<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
     d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#40;</span>k, merge_func<span style="color: black;">&#40;</span>v, d2<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k, v <span style="color: #ff7700;font-weight:bold;">in</span> d1.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">in</span> d2<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
&nbsp;
 <span style="color: #ff7700;font-weight:bold;">if</span> __name__ == <span style="color: #483d8b;">&quot;__main__&quot;</span>:
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">random</span>
     <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">timeit</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'Generate test dicts'</span><span style="color: black;">&#41;</span>
&nbsp;
     <span style="color: #808080; font-style: italic;"># pour que le test soit juste, il faut créer plusieurs types de dicos:</span>
     <span style="color: #808080; font-style: italic;"># des longs, et des courts avec plein de collisions ou moins</span>
     d1 = <span style="color: black;">&#123;</span><span style="color: #dc143c;">random</span>.<span style="color: black;">randint</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">0</span>, <span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>: <span style="color: #483d8b;">'d1'</span> <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">xrange</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">10000</span><span style="color: black;">&#41;</span><span style="color: black;">&#125;</span>
     d2 = <span style="color: black;">&#123;</span><span style="color: #dc143c;">random</span>.<span style="color: black;">randint</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">0</span>, <span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>: <span style="color: #483d8b;">'d2'</span> <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">xrange</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">10000</span><span style="color: black;">&#41;</span><span style="color: black;">&#125;</span>
     d3 = <span style="color: black;">&#123;</span><span style="color: #dc143c;">random</span>.<span style="color: black;">randint</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">0</span>, <span style="color: #ff4500;">10000000</span><span style="color: black;">&#41;</span>: <span style="color: #483d8b;">'d1'</span> <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">xrange</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">1000000</span><span style="color: black;">&#41;</span><span style="color: black;">&#125;</span>
     d4 = <span style="color: black;">&#123;</span><span style="color: #dc143c;">random</span>.<span style="color: black;">randint</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">0</span>, <span style="color: #ff4500;">10000000</span><span style="color: black;">&#41;</span>: <span style="color: #483d8b;">'d2'</span> <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">xrange</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">1000000</span><span style="color: black;">&#41;</span><span style="color: black;">&#125;</span>
&nbsp;
     merge_to_list = <span style="color: #ff7700;font-weight:bold;">lambda</span> a, b: <span style="color: black;">&#91;</span>a, b<span style="color: black;">&#93;</span>
&nbsp;
     <span style="color: #808080; font-style: italic;"># ensuite il faut s'assurer que toutes ces fonctions retournent bien</span>
     <span style="color: #808080; font-style: italic;"># la même chose</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Testing returns value all match&quot;</span><span style="color: black;">&#41;</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">assert</span> <span style="color: black;">&#40;</span>dmerge1<span style="color: black;">&#40;</span>d1, d2<span style="color: black;">&#41;</span> == dmerge2<span style="color: black;">&#40;</span>d1, d2<span style="color: black;">&#41;</span>
             == dmerge3<span style="color: black;">&#40;</span>d1, d2<span style="color: black;">&#41;</span> == dmerge4<span style="color: black;">&#40;</span>d1, d2<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">assert</span> <span style="color: black;">&#40;</span>dmerge1<span style="color: black;">&#40;</span>d1, d2, merge_to_list<span style="color: black;">&#41;</span> == dmerge2<span style="color: black;">&#40;</span>d1, d2, merge_to_list<span style="color: black;">&#41;</span>
            == dmerge3<span style="color: black;">&#40;</span>d1, d2, merge_to_list<span style="color: black;">&#41;</span> == dmerge4<span style="color: black;">&#40;</span>d1, d2, merge_to_list<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">assert</span> <span style="color: black;">&#40;</span>dmerge1<span style="color: black;">&#40;</span>d3, d4<span style="color: black;">&#41;</span> == dmerge2<span style="color: black;">&#40;</span>d3, d4<span style="color: black;">&#41;</span>
             == dmerge3<span style="color: black;">&#40;</span>d3, d4<span style="color: black;">&#41;</span> == dmerge4<span style="color: black;">&#40;</span>d3, d4<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">assert</span> <span style="color: black;">&#40;</span>dmerge1<span style="color: black;">&#40;</span>d3, d4, merge_to_list<span style="color: black;">&#41;</span> == dmerge2<span style="color: black;">&#40;</span>d3, d4, merge_to_list<span style="color: black;">&#41;</span>
             == dmerge3<span style="color: black;">&#40;</span>d3, d4, merge_to_list<span style="color: black;">&#41;</span> == dmerge4<span style="color: black;">&#40;</span>d3, d4, merge_to_list<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">assert</span> <span style="color: black;">&#40;</span>dmerge1<span style="color: black;">&#40;</span>d1, d4<span style="color: black;">&#41;</span> == dmerge2<span style="color: black;">&#40;</span>d1, d4<span style="color: black;">&#41;</span>
             == dmerge3<span style="color: black;">&#40;</span>d1, d4<span style="color: black;">&#41;</span> == dmerge4<span style="color: black;">&#40;</span>d1, d4<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">assert</span> <span style="color: black;">&#40;</span>dmerge1<span style="color: black;">&#40;</span>d1, d4, merge_to_list<span style="color: black;">&#41;</span> == dmerge2<span style="color: black;">&#40;</span>d1, d4, merge_to_list<span style="color: black;">&#41;</span>
             == dmerge3<span style="color: black;">&#40;</span>d1, d4, merge_to_list<span style="color: black;">&#41;</span> == dmerge4<span style="color: black;">&#40;</span>d1, d4, merge_to_list<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
&nbsp;
     <span style="color: #808080; font-style: italic;"># enfin on lance l'évaluation du temps d'éxécution avec timeit()</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;Start timing&quot;</span><span style="color: black;">&#41;</span>
&nbsp;
&nbsp;
     <span style="color: #808080; font-style: italic;"># ce code est exécuté une fois par appel de timeit</span>
     <span style="color: #808080; font-style: italic;"># notez l'astuce 'from __main__ import x' qui importe du code</span>
     <span style="color: #808080; font-style: italic;"># du fichier en cours, ce qui sert rarement</span>
     setup = <span style="color: #483d8b;">''</span><span style="color: #483d8b;">'from __main__ import (dmerge1, dmerge2, dmerge3, dmerge4,
                                      d1, d2, d3, d4, merge_to_list)'</span><span style="color: #483d8b;">''</span>
&nbsp;
&nbsp;
&nbsp;
     <span style="color: #808080; font-style: italic;"># ensuite on fait des appels à timeit : </span>
     <span style="color: #808080; font-style: italic;"># - le premier paramètre est le code à mesurer: il faut qu'il </span>
     <span style="color: #808080; font-style: italic;">#   soit le plus simple et court possible</span>
     <span style="color: #808080; font-style: italic;"># - le second et le code d'initialisation avant le test (hors mesure)</span>
     <span style="color: #808080; font-style: italic;"># - le 3e est le nombre de fois que le code va être appelé. </span>
&nbsp;
&nbsp;
     <span style="color: #808080; font-style: italic;"># on va tester chaque fonction pour chaque type de dico, une fois</span>
     <span style="color: #808080; font-style: italic;"># avec l'approche par défaut, et une fois avec une fonction de merge</span>
     <span style="color: #808080; font-style: italic;"># personnalisée</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Lots of collisions&quot;</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Default merge strategy&quot;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;1&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge1(d1, d2)&quot;</span>, setup=setup, number=<span style="color: #ff4500;">1000000</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;2&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge2(d1, d2)&quot;</span>, setup=setup, number=<span style="color: #ff4500;">1000000</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;3&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge3(d1, d2)&quot;</span>, setup=setup, number=<span style="color: #ff4500;">1000000</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;4&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge4(d1, d2)&quot;</span>, setup=setup, number=<span style="color: #ff4500;">1000000</span><span style="color: black;">&#41;</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Custom merge strategy&quot;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;1&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge1(d1, d2, merge_to_list)&quot;</span>,
                               setup=setup, number=<span style="color: #ff4500;">100000</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;2&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge2(d1, d2, merge_to_list)&quot;</span>,
                               setup=setup, number=<span style="color: #ff4500;">100000</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;3&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge3(d1, d2, merge_to_list)&quot;</span>,
                               setup=setup, number=<span style="color: #ff4500;">100000</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;4&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge4(d1, d2, merge_to_list)&quot;</span>,
                               setup=setup, number=<span style="color: #ff4500;">100000</span><span style="color: black;">&#41;</span>
&nbsp;
&nbsp;
    <span style="color: #808080; font-style: italic;"># le nombre de répétitions est bien plus faible ici car sinon le test</span>
    <span style="color: #808080; font-style: italic;"># est très très long</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Long dictionaries&quot;</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Default merge strategy&quot;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;1&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge1(d3, d4)&quot;</span>, setup=setup, number=<span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;2&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge2(d3, d4)&quot;</span>, setup=setup, number=<span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;3&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge3(d3, d4)&quot;</span>, setup=setup, number=<span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;4&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge4(d3, d4)&quot;</span>, setup=setup, number=<span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Custom merge strategy&quot;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;1&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge1(d3, d4, merge_to_list)&quot;</span>,
                               setup=setup, number=<span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;2&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge2(d3, d4, merge_to_list)&quot;</span>,
                               setup=setup, number=<span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;3&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge3(d3, d4, merge_to_list)&quot;</span>,
                               setup=setup, number=<span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;4&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge4(d3, d4, merge_to_list)&quot;</span>,
                               setup=setup, number=<span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Mixed dictionaries&quot;</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Default merge strategy&quot;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;1&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge1(d1, d4)&quot;</span>, setup=setup, number=<span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;2&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge2(d1, d4)&quot;</span>, setup=setup, number=<span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;3&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge3(d1, d4)&quot;</span>, setup=setup, number=<span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;4&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge4(d1, d4)&quot;</span>, setup=setup, number=<span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
&nbsp;
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;Custom merge strategy&quot;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;1&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge1(d1, d4, merge_to_list)&quot;</span>,
                              setup=setup, number=<span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;2&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge2(d1, d4, merge_to_list)&quot;</span>,
                              setup=setup, number=<span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;3&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge3(d1, d4, merge_to_list)&quot;</span>,
                              setup=setup, number=<span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
     <span style="color: #ff7700;font-weight:bold;">print</span> <span style="color: #483d8b;">&quot;4&quot;</span>, <span style="color: #dc143c;">timeit</span>.<span style="color: #dc143c;">timeit</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;dmerge4(d1, d4, merge_to_list)&quot;</span>,
                              setup=setup, number=<span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span>
&nbsp;
&nbsp;
<span style="color: #808080; font-style: italic;"># Et voici le résultat que ça nous ressort. On voit clairement </span>
<span style="color: #808080; font-style: italic;"># que la 3eme fonction donne les meilleurs perfs, du coup</span>
<span style="color: #808080; font-style: italic;"># c'est celle qu'on a choisit</span>
&nbsp;
 <span style="color: #808080; font-style: italic;">## Generate test dicts</span>
 <span style="color: #808080; font-style: italic;">## Testing returns value all match</span>
 <span style="color: #808080; font-style: italic;">## Start timing</span>
 <span style="color: #808080; font-style: italic;">## Lots of collisions</span>
 <span style="color: #808080; font-style: italic;">## Default merge strategy</span>
 <span style="color: #808080; font-style: italic;">## 1 19.9299340248</span>
 <span style="color: #808080; font-style: italic;">## 2 148.185166121</span>
 <span style="color: #808080; font-style: italic;">## 3 21.2276539803</span>
 <span style="color: #808080; font-style: italic;">## 4 21.2074358463</span>
 <span style="color: #808080; font-style: italic;">## Custom merge strategy</span>
 <span style="color: #808080; font-style: italic;">## 1 30.646312952</span>
 <span style="color: #808080; font-style: italic;">## 2 18.522135973</span>
 <span style="color: #808080; font-style: italic;">## 3 14.0125968456</span>
 <span style="color: #808080; font-style: italic;">## 4 18.5139119625</span>
 <span style="color: #808080; font-style: italic;">## Long dictionaries</span>
 <span style="color: #808080; font-style: italic;">## Default merge strategy</span>
 <span style="color: #808080; font-style: italic;">## 1 84.4819910526</span>
 <span style="color: #808080; font-style: italic;">## 2 383.444111109</span>
 <span style="color: #808080; font-style: italic;">## 3 80.7273669243</span>
 <span style="color: #808080; font-style: italic;">## 4 86.0287930965</span>
 <span style="color: #808080; font-style: italic;">## Custom merge strategy</span>
 <span style="color: #808080; font-style: italic;">## 1 294.41114521</span>
 <span style="color: #808080; font-style: italic;">## 2 377.38009119</span>
 <span style="color: #808080; font-style: italic;">## 3 154.505481005</span>
 <span style="color: #808080; font-style: italic;">## 4 256.771039963</span>
 <span style="color: #808080; font-style: italic;">## Mixed dictionaries</span>
 <span style="color: #808080; font-style: italic;">## Default merge strategy</span>
 <span style="color: #808080; font-style: italic;">## 1 19.9574320316</span>
 <span style="color: #808080; font-style: italic;">## 2 87.1410660744</span>
 <span style="color: #808080; font-style: italic;">## 3 19.3570361137</span>
 <span style="color: #808080; font-style: italic;">## 4 19.524998188</span>
 <span style="color: #808080; font-style: italic;">## Custom merge strategy</span>
 <span style="color: #808080; font-style: italic;">## 1 60.6157000065</span>
 <span style="color: #808080; font-style: italic;">## 2 86.3876900673</span>
 <span style="color: #808080; font-style: italic;">## 3 59.0331327915</span>
 <span style="color: #808080; font-style: italic;">## 4 87.0504939556</span>
 <span style="color: #808080; font-style: italic;">## [Finished in 2494.7s]</span></pre></div></div>

<p> Le test complet a pris en tout 2494.7s, soit 41 minutes, pour tourner sur ma machine, et je l&#8217;ai lancé plusieurs fois avec différentes modifs au fil de la journée. Il faut vraiment est un geek pour aimer faire ce genre de connerie. Parce que soyons honnête, tout le monde s&#8217;en branle des perfs de cette fonction :-)</p>
<p> Il faut savoir aussi qu&#8217;après coup j&#8217;ai réalisé que son code utilisait des listes en intention, et non des <a href="http://sametmax.com/python-love-les-listes-en-intention-partie-2/">expressions génératrices</a>, ce qui fait qu&#8217;il faut attendre que toute la liste soit générée avec que <code>update()</code> fasse son travail.</p>
<p> Il y avait donc des cas supplémentaires à tester et j&#8217;avais mergé son code dans batbelt. Arf, l&#8217;optimisation n&#8217;a jamais de fin ^^</p>
<p> Bref, j&#8217;ai relancé un test avec avec des listes en intentions (et même avec des expressions ternaires ce qui donne des trucs capilotractés):</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">def</span> dmerge1<span style="color: black;">&#40;</span>d1, d2, merge_func=<span style="color: #008000;">None</span><span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;
        Une version de l'ancien dmerge3 qui utilise une expression génératrice.
    &quot;&quot;&quot;</span>
    d = <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span>
&nbsp;
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d1<span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">if</span> merge_func <span style="color: #ff7700;font-weight:bold;">is</span> <span style="color: #008000;">None</span>:
        d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d2<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>k, <span style="color: black;">&#40;</span>v <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> d <span style="color: #ff7700;font-weight:bold;">else</span> merge_func<span style="color: black;">&#40;</span>d<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span>, v<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k, v <span style="color: #ff7700;font-weight:bold;">in</span> d2.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
&nbsp;
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> dmerge2<span style="color: black;">&#40;</span>d1, d2, merge_func=<span style="color: #ff7700;font-weight:bold;">lambda</span> v1, v2: v2<span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;
        La version du proposée par notre gentil contributeur, mais
        avec des expressions génératrices à la place des listes en 
        intention.
    &quot;&quot;&quot;</span>
    d = <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span>
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>k, v<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k, v <span style="color: #ff7700;font-weight:bold;">in</span> d1.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> d2<span style="color: black;">&#41;</span>
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>k, v<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k, v <span style="color: #ff7700;font-weight:bold;">in</span> d2.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> d1<span style="color: black;">&#41;</span>
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>k, merge_func<span style="color: black;">&#40;</span>v, d2<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k, v <span style="color: #ff7700;font-weight:bold;">in</span> d1.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">in</span> d2<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
&nbsp;
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> dmerge3<span style="color: black;">&#40;</span>d1, d2, merge_func=<span style="color: #008000;">None</span><span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;
      La version la plus rapide du test précédent.
    &quot;&quot;&quot;</span>
    d = <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span>
&nbsp;
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d1<span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">if</span> merge_func <span style="color: #ff7700;font-weight:bold;">is</span> <span style="color: #008000;">None</span>:
        d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d2<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">for</span> k, v <span style="color: #ff7700;font-weight:bold;">in</span> d2.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">in</span> d:
            d<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span> = merge_func<span style="color: black;">&#40;</span>d<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span>, v<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">else</span>:
            d<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span> = v
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> dmerge4<span style="color: black;">&#40;</span>d1, d2, merge_func=<span style="color: #008000;">None</span><span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;
        La version proposée par notre contributeur, optimisée comme un connard.
    &quot;&quot;&quot;</span>
    d = <span style="color: black;">&#123;</span><span style="color: black;">&#125;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">if</span> merge_func <span style="color: #ff7700;font-weight:bold;">is</span> <span style="color: #008000;">None</span>:
        d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d1<span style="color: black;">&#41;</span>
        d.<span style="color: black;">update</span><span style="color: black;">&#40;</span>d2<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>k, v<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k, v <span style="color: #ff7700;font-weight:bold;">in</span> d1.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> d2<span style="color: black;">&#41;</span>
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>k, v<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k, v <span style="color: #ff7700;font-weight:bold;">in</span> d2.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> d1<span style="color: black;">&#41;</span>
    d.<span style="color: black;">update</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>k, merge_func<span style="color: black;">&#40;</span>v, d2<span style="color: black;">&#91;</span>k<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> k, v <span style="color: #ff7700;font-weight:bold;">in</span> d1.<span style="color: black;">iteritems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">if</span> k <span style="color: #ff7700;font-weight:bold;">in</span> d2<span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> d
&nbsp;
&nbsp;
<span style="color: #808080; font-style: italic;">## Generate test dicts</span>
<span style="color: #808080; font-style: italic;">## Testing returns value all match</span>
<span style="color: #808080; font-style: italic;">## Start timing</span>
<span style="color: #808080; font-style: italic;">## Lots of collisions</span>
<span style="color: #808080; font-style: italic;">## Default merge strategy</span>
<span style="color: #808080; font-style: italic;">## 1 12.2690660954</span>
<span style="color: #808080; font-style: italic;">## 2 97.121183157</span>
<span style="color: #808080; font-style: italic;">## 3 12.1084120274</span>
<span style="color: #808080; font-style: italic;">## 4 12.6807589531</span>
<span style="color: #808080; font-style: italic;">## Custom merge strategy</span>
<span style="color: #808080; font-style: italic;">## 1 8.73903894424</span>
<span style="color: #808080; font-style: italic;">## 2 12.0493769646</span>
<span style="color: #808080; font-style: italic;">## 3 8.00074601173</span>
<span style="color: #808080; font-style: italic;">## 4 11.4764301777</span>
<span style="color: #808080; font-style: italic;">## Long dictionaries</span>
<span style="color: #808080; font-style: italic;">## Default merge strategy</span>
<span style="color: #808080; font-style: italic;">## 1 54.5233860016</span>
<span style="color: #808080; font-style: italic;">## 2 218.695598841</span>
<span style="color: #808080; font-style: italic;">## 3 70.213809967</span>
<span style="color: #808080; font-style: italic;">## 4 61.8348701</span>
<span style="color: #808080; font-style: italic;">## Custom merge strategy</span>
<span style="color: #808080; font-style: italic;">## 1 103.258821964</span>
<span style="color: #808080; font-style: italic;">## 2 217.720175982</span>
<span style="color: #808080; font-style: italic;">## 3 96.5204670429</span>
<span style="color: #808080; font-style: italic;">## 4 214.480421066</span>
<span style="color: #808080; font-style: italic;">## Mixed dictionaries</span>
<span style="color: #808080; font-style: italic;">## Default merge strategy</span>
<span style="color: #808080; font-style: italic;">## 1 19.169850111</span>
<span style="color: #808080; font-style: italic;">## 2 66.9599928856</span>
<span style="color: #808080; font-style: italic;">## 3 19.4371211529</span>
<span style="color: #808080; font-style: italic;">## 4 19.5183057785</span>
<span style="color: #808080; font-style: italic;">## Custom merge strategy</span>
<span style="color: #808080; font-style: italic;">## 1 64.7940750122</span>
<span style="color: #808080; font-style: italic;">## 2 66.9712991714</span>
<span style="color: #808080; font-style: italic;">## 3 58.5918440819</span>
<span style="color: #808080; font-style: italic;">## 4 67.5281140804</span>
<span style="color: #808080; font-style: italic;">## [Finished in 1619.3s]</span></pre></div></div>

<p>La bonne nouvelle pour moi, c&#8217;est que l&#8217;algo 3 est toujours le plus rapide, j&#8217;ai pas à re pusher.</p>
<p>Mais il est intéressant de constater que globalement les 4 tests mettent 1619.3s à s’exécuter. Globalement utiliser des expressions génératrices boost bien les perfs.</p>
<hr />
<p><a href="https://github.com/sametmax/codes-des-articles/blob/master/2013/juin/perf.py">Télécharger le code de l&#8217;article.</a></p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=6369&amp;md5=2a38eaff3f2a26f2b60529ac3e370e94" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/mesurer-les-performances-dun-snippet-python/feed/</wfw:commentRss>
		<slash:comments>6</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fmesurer-les-performances-dun-snippet-python%2F&amp;language=en_GB&amp;category=text&amp;title=Mesurer+les+performances+d%26%238217%3Bun+snippet+Python&amp;description=Ca+fait+longtemps+que+j%26%238217%3Bavais+pas+musique.+L%26%238217%3Bopen+source+c%26%238217%3Best+fantastique.+Github+c%26%238217%3Best+merveilleux.+On+parle+de+batbelt%2C+et+paf%2C+quelques+jours+plus+tard+on+a+notre+premi%C3%A8re+contribution.+Ce...&amp;tags=dict%2Cmerge%2Cperf%2Cpython%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/06/rmhtBR7.jpg" length="92496" type="image/jpg" />	</item>
		<item>
		<title>Les vues sur des collections en Python</title>
		<link>http://sametmax.com/les-vues-sur-des-collections-en-python/</link>
		<comments>http://sametmax.com/les-vues-sur-des-collections-en-python/#comments</comments>
		<pubDate>Sat, 03 Nov 2012 18:57:02 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[dict]]></category>
		<category><![CDATA[generators]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[strings]]></category>
		<category><![CDATA[views]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=2785</guid>
		<description><![CDATA[Python 3 introduit de nombreux changements qui ont été backportés dans Python 2.7. Parmis eux, les vues, qui sont un concept assez mal expliqué dans la documentation standard.]]></description>
			<content:encoded><![CDATA[<p>Python 3 introduit de nombreux changements qui ont été backportés dans Python 2.7. Parmi eux, les vues, qui sont un concept assez mal expliqué dans la documentation standard.</p>
<h2>Dictionary views</h2>
<p>Quand on voulait travailler sur les valeurs d&#8217;un dictionnaire en Python, on avait deux choix:</p>
<ul>
<li>faire <code>dict.values()</code> et récupérer une liste entière. Créant une liste entière en mémoire.</li>
<li>faire <code>dict.itervalues()</code>, et récupérer un générateur. Mais qui ne peut être lu qu&#8217;une fois.</li>
</ul>
<p>Les vues sont une solution intermédiaire: ce sont des objets qui prennent peu de mémoire, mais qui peuvent être lus plusieurs fois.</p>
<p>Exemple:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> scores = <span style="color: black;">&#123;</span><span style="color: #483d8b;">'foo'</span>: <span style="color: #ff4500;">1</span>, <span style="color: #483d8b;">'bar'</span>: <span style="color: #ff4500;">0</span><span style="color: black;">&#125;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> val = scores.<span style="color: black;">viewvalues</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">print</span> val
dict_values<span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>, <span style="color: #ff4500;">0</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff4500;">1</span> <span style="color: #ff7700;font-weight:bold;">in</span> val
<span style="color: #008000;">True</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: black;">&#91;</span>x <span style="color: #66cc66;">*</span> <span style="color: #ff4500;">2</span> <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> val<span style="color: black;">&#93;</span>
<span style="color: black;">&#91;</span><span style="color: #ff4500;">2</span>, <span style="color: #ff4500;">0</span><span style="color: black;">&#93;</span></pre></div></div>

<p>Contrairement à une liste, les vues issues d&#8217;un dictionnaire ne supportent pas le slicing ou l&#8217;assignation et il n&#8217;y a aucune garantie d&#8217;ordre des éléments. De plus, elles ne peuvent être modifiées.</p>
<p>Bref, <strong>une vue ne contient rien</strong>, c&#8217;est juste un objet qui, quand on accède à son contenu, va le chercher dans le dictionnaire et vous le retourne. C&#8217;est ce qu&#8217;on appelle un objet proxy: il vous donne l&#8217;illusion d&#8217;accéder directement aux données pour vous faciliter la vie, généralement en vous les présentant sous une forme différente: ici un itérable.</p>
<p>On peut récupérer des vues pour les valeurs, mais également pour les clés et les couples clés / valeurs. Ces deux types de vues se comportent en plus comme des <a href="http://sametmax.com/ce-que-vous-ne-saviez-pas-sur-les-collections-en-python/">sets</a>:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> scores.<span style="color: black;">viewitems</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
dict_items<span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'foo'</span>, <span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span>, <span style="color: black;">&#40;</span><span style="color: #483d8b;">'bar'</span>, <span style="color: #ff4500;">0</span><span style="color: black;">&#41;</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> scores.<span style="color: black;">viewkeys</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> | <span style="color: black;">&#91;</span><span style="color: #ff4500;">3</span>,<span style="color: black;">&#93;</span>
<span style="color: #008000;">set</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">3</span>, <span style="color: #483d8b;">'foo'</span>, <span style="color: #483d8b;">'bar'</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span></pre></div></div>

<p>Puisqu&#8217;il est rare d&#8217;avoir besoin d&#8217;une vraie liste, et comme les vues sont une très bonne alternative aux générateurs, <code>dict.values</code> et consorts retournent des vues en Python 3.</p>
<p>Maintenant vous allez me dire &#8220;Mais si les vues sont une si bonne alternative aux générateurs, pourquoi on ne remplace pas tous les générateurs par des vues ?&#8221;. </p>
<p>Tout simplement parce que ce n&#8217;est pas possible. Un générateur est un mécanisme standard qui permet de produire des valeurs une par une. N&#8217;importe qui peut créer un générateur, car c&#8217;est un concept portable d&#8217;un problème à un autre. On peut l&#8217;appliquer à de nombreuses choses: algorithme, flux de données, fichier, etc. </p>
<p>Une vue n&#8217;est qu&#8217;un proxy qui permet de voir une <a href="http://sametmax.com/quest-ce-quune-structure-de-donnees/">structure de données</a> sous une autre forme. Il faut coder une vue par type de structure de données, car la vue va chercher les données dans cette structure quand on lui demande. Le code est donc différent à chaque fois.</p>
<p>Python ne permet pas de créer soi-même des vues, mais créer un proxy, c&#8217;est à dire un objet qui retourne les valeurs d&#8217;un autre objet quand on l&#8217;interroge, peut se faire à la main dans tout langage de programmation. Ainsi vous pourriez créer un proxy qui ressemble a une vue des clés d&#8217;un dico très simplement:</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">class</span> keyview<span style="color: black;">&#40;</span><span style="color: #008000;">object</span><span style="color: black;">&#41;</span>:
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__init__</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, d<span style="color: black;">&#41;</span>:
        <span style="color: #008000;">self</span>.<span style="color: black;">d</span> = d
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__iter__</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">self</span>.<span style="color: black;">d</span>.<span style="color: black;">iterkeys</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #66cc66;">&gt;&gt;&gt;</span> view = keyview<span style="color: black;">&#40;</span>scores<span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> view:
...     <span style="color: #ff7700;font-weight:bold;">print</span> x
...     
<span style="color: black;">foo</span>
bar
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">list</span><span style="color: black;">&#40;</span>view<span style="color: black;">&#41;</span>
<span style="color: black;">&#91;</span><span style="color: #483d8b;">'foo'</span>, <span style="color: #483d8b;">'bar'</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span></pre></div></div>

<p>L&#8217;implémentation réelle de Python (en C&#8230;) ne fait pas vraiment grand chose de plus, juste un travail d&#8217;optimisation pour être plus rapide.</p>
<h2>memoryview</h2>
<p>Les memory views suivent le même principe, mais appliqué à toute structure de données qui supporte le buffer protocole (un certain nombre de méthodes avec un nom et un comportement défini par ce protocole) comme celles trouvées dans le module <code>struct</code> ou <code>array</code>. La structure de données la plus connue qui suit le buffer protocole est la chaîne de caractères.</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> s = <span style="color: #483d8b;">'Sam &amp; Max eat the road with a Github fork'</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> ms = memoryview<span style="color: black;">&#40;</span>s<span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> ms<span style="color: black;">&#91;</span>-<span style="color: #ff4500;">1</span><span style="color: black;">&#93;</span>
<span style="color: #483d8b;">'k'</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> ms<span style="color: black;">&#91;</span>:<span style="color: #ff4500;">9</span><span style="color: black;">&#93;</span>
<span style="color: #66cc66;">&lt;</span>memory at 0x25ded60<span style="color: #66cc66;">&gt;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #483d8b;">''</span>.<span style="color: black;">join</span><span style="color: black;">&#40;</span>ms<span style="color: black;">&#91;</span>:<span style="color: #ff4500;">9</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
<span style="color: #483d8b;">'Sam &amp; Max'</span></pre></div></div>

<p>Le principal intérêt de la memory view appliquée aux strings, c&#8217;est que tout slicing retourne une nouvelle memory view. On peut donc travailler sur des parties de la chaînes sans créer une nouvelle chaîne en mémoire.</p>
<p>En revanche, les chaînes unicodes ne sont pas supportées. Il vous faudra jouer avec <code>encode()</code> et <code>decode()</code>.</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=2785&amp;md5=314fde8526eae2ff91995fb46c452d35" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/les-vues-sur-des-collections-en-python/feed/</wfw:commentRss>
		<slash:comments>15</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fles-vues-sur-des-collections-en-python%2F&amp;language=en_GB&amp;category=text&amp;title=Les+vues+sur+des+collections+en+Python&amp;description=Python+3+introduit+de+nombreux+changements+qui+ont+%C3%A9t%C3%A9+backport%C3%A9s+dans+Python+2.7.+Parmi+eux%2C+les+vues%2C+qui+sont+un+concept+assez+mal+expliqu%C3%A9+dans+la+documentation+standard.+Dictionary+views...&amp;tags=dict%2Cgenerators%2Cpython%2Cstrings%2Cviews%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2012/11/fenetretravaux.jpg" length="392879" type="image/jpg" />	</item>
	</channel>
</rss>
