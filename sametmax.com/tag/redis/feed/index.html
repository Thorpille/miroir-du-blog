<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Sam &#38; Max: Python, Django, Git et du cul &#187; redis</title>
	<atom:link href="http://sametmax.com/tag/redis/feed/" rel="self" type="application/rss+xml" />
	<link>http://sametmax.com</link>
	<description>Deux développeurs en vadrouille qui se sortent les doigts du code</description>
	<lastBuildDate>Wed, 05 Feb 2014 14:20:37 +0000</lastBuildDate>
	<language>en</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>http://wordpress.org/?v=3.3.1</generator>
	<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2F&amp;language=en_US&amp;category=text&amp;title=Sam+%26amp%3B+Max%3A+Python%2C+Django%2C+Git+et+du+cul&amp;description=Deux+d%C3%A9veloppeurs+en+vadrouille+qui+se+sortent+les+doigts+du+code&amp;tags=blog" type="text/html" />
		<item>
		<title>La stack techno qu&#8217;on utilise pour faire un site Web, et pourquoi</title>
		<link>http://sametmax.com/la-stack-techno-quon-utilise-pour-faire-un-site-web-et-pourquoi/</link>
		<comments>http://sametmax.com/la-stack-techno-quon-utilise-pour-faire-un-site-web-et-pourquoi/#comments</comments>
		<pubDate>Mon, 11 Nov 2013 06:40:38 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[celery]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[fabric]]></category>
		<category><![CDATA[mysql]]></category>
		<category><![CDATA[nginx]]></category>
		<category><![CDATA[nosql]]></category>
		<category><![CDATA[postgres]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[redis]]></category>
		<category><![CDATA[vm]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=7648</guid>
		<description><![CDATA[Une stack techno n'est pas une référence. Il n'y a pas de combo absolu qui rox absolument tout, c'est une question de contexte technique, financier, humain...

Mais c'est vrai que ça aide bien d'avoir sous les yeux les pratiques des autres.]]></description>
			<content:encoded><![CDATA[<p>Une stack techno n&#8217;est pas une référence. Il n&#8217;y a pas de combo absolu qui rox absolument tout, c&#8217;est une question de contexte technique, financier, humain&#8230;</p>
<p>Mais c&#8217;est vrai que ça aide bien d&#8217;avoir sous les yeux les pratiques des autres.</p>
<p>Je ne vais pas expliquer pourquoi Python, <a href="http://sametmax.com/10-raisons-pour-lesquelles-je-suis-toujours-marie-a-python/">je l&#8217;ai déjà fait</a>.</p>
<p>Commençons plutôt par la partie purement Web, pour laquelle on utilise Django, le framework Web Python.</p>
<p>Max et moi avons tout deux fait du PHP avant, j&#8217;ai tâté des frameworks internes, du Symfony et plus tard du Zope. J&#8217;ai regardé du côté de Pyramid et de ses prédécesseurs, et Django est celui qui me plaît le plus. J&#8217;ai juste un peu forcé la main à Max :-)</p>
<p>Car oui, le framework a été avant tout un choix de goût.</p>
<p>Ce n&#8217;est pas un choix de performances : le framework n&#8217;a aucun impact dessus. Aucun. Les architectures ont un impact. Le framework, non. Votre bottleneck sera sur les IO, pas sur le CPU. Le choix de technos asynchrones peut avoir un impact, mais ce n&#8217;est pas une question de framework. Tornado, Twisted ou NodeJS, on s&#8217;en fout. </p>
<p>Donc Django, essentiellement parce qu&#8217;il me plait. Et il me plaît pour ces raisons :</p>
<ul>
<li>Il y a un bon équilibre entre découplage et intégration. En général c&#8217;est soit très découplé et mal intégré, soit très bien intégré et très couplé.</li>
<li>C&#8217;est bien foutu et bien documenté. Et c&#8217;est stable. Vraiment très stable. Les core devs sont hyper sérieux.</li>
<li>C&#8217;est très versatile et ça peut faire plein de trucs out of the box, petits comme gros.</li>
<li>C&#8217;est assez facile à apprendre. Ça reste un framework, donc ce n&#8217;est pas la plus simple des démarches, mais dans le royaume des frameworks de cette taille, ça reste vraiment le plus simple.</li>
<li>La communauté est fantastique : il y a des centaines d&#8217;apps qui couvrent pratiquement tous les besoins.</li>
<li>Et bien entendu, c&#8217;est en Python.</li>
</ul>
<p>En terme de base de données, on a fait du MySQL pendant longtemps. Ça a plutôt bien marché. Maintenant je commence mes nouveaux projets avec PostGres, qui est plus solide. Parfois je fais juste du Sqlite, parce que ça suffit.</p>
<p>Pas de NoSQL. Après plusieurs expériences avec MongoDB et CouchDB, je n&#8217;ai pas été convaincu que les bénéfices dépassaient le coût. Il faudrait un article complet là dessus (qu&#8217;on m&#8217;a d&#8217;ailleurs demandé).</p>
<p>Question OS. c&#8217;est du CentOS avec Max (il a plus l&#8217;habitude) ou du Ubuntu Server pour mes autres projets. Je reste sur les LTS. Ce n&#8217;est pas un choix très réfléchi, c&#8217;est surtout par habitude.</p>
<p>Pas de machine virtuelle. On a essayé, sans y trouver un grand intérêt :</p>
<ul>
<li>Il faut quand même faire des scripts de migration, donc autant s&#8217;en servir pour le déploiement.</li>
<li>On perd en perfs.</li>
<li>Les erreurs liées au mal-fonctionnement d&#8217;une VM sont absolument indébuggable.</li>
<li>Si on ne fait pas la VM soit-même, il faut mettre ses couilles dans les mains d&#8217;un pestataire de service. J&#8217;ai horreur de ça.</li>
<li>Trouver des gens avec la compétence pour gérer une VM, c&#8217;est difficile. Un script de déploiement, c&#8217;est du code que tout dev saura déjà lire. Par extension ça veut dire que je m&#8217;y replonge facilement des semaines plus tard.</li>
</ul>
<p>Et donc pour le déploiement, j&#8217;utilise <a href="http://sametmax.com/travailler-moins-pour-gagner-plus-en-15-minutes-avec-python-fabric/">fabric</a>, avec <a href="https://github.com/ronnix/fabtools/">fabtools</a>.</p>
<p>Ce n&#8217;est pas la solution la plus efficace, d&#8217;autant que ça limite à Python 2.7, mais c&#8217;est la plus simple. C&#8217;est juste du code Python. N&#8217;importe qui peut comprendre le déploiement en 15 minutes. Ça se modifie vite, s&#8217;adapte facilement. </p>
<p>Il faut comprendre qu&#8217;on a jamais plus d&#8217;une dizaine de serveurs pour un projet, ces choix sont donc fait en fonction de cela. Il va sans dire que si vous gérez un parc de centaines de machines, ça ne sera pas du tout le même choix technique. Peut être que Chef ou des VM seront alors carrément plus interressant. Peut être que le NoSQL et sa capacité au scalling sera bien plus rentable.</p>
<p>Il ne s&#8217;agit pas de décrier les technos que nous n&#8217;utilisons pas. Il s&#8217;agit juste de dire, voilà les choix que nous avons fait, dans tel contexte, pour telles (bonnes ou mauvaises) raisons.</p>
<p>Durant les dernières années, on a ajouté <a href="http://redis.io/">Redis</a> à notre stack. C&#8217;est un outil fantastique qui sert à tout : de la base de données pour les trucs simples (il y a des fois ou un schéma est overkill) à la solution de caching. C&#8217;est ce qu&#8217;on a de plus proche du NoSQL.</p>
<p>L&#8217;outil est tellement simple à installer (vraiment le degré zero de la maintenance, c&#8217;est beau) et à utiliser que ça ne vaut juste pas le coup de s&#8217;en priver. </p>
<p>Du coup, plus de memcache. Toutes les grosses requêtes sont sauvegardées dans Redis, dès qu&#8217;on fait un script qui a besoin de persistance temporaire, Redis, pour communiquer entre plusieurs process, Redis, pour toutes les opérations qui ont besoin de grosses perfs comme les stats, Redis. Vive Redis.</p>
<p>D&#8217;ailleurs on utilise Redis aussi comme broker pour notre gestionnaire de queues et de taches : <a href="sametmax.com/files-de-taches-et-taches-recurrentes-avec-celery/">celery</a>. Si vous pythonez, je vous recommande chaudement celery pour toutes les tâches en background, les crawlers, les chaînes de process, etc.</p>
<p>On a aussi du moteur de recherche. Là on tappe dans du <a href="http://lucene.apache.org/solr/">Solr</a> (avec <a href="http://haystacksearch.org/">haystack</a>). C&#8217;est très puissant, en tout cas syntaxiquement car ça ne fait pas de sémantique. Ne vous attendez-donc pas à rattraper Google. Mais c&#8217;est aussi méga chiant à configurer et très lourd. Je pense qu&#8217;un jour on va migrer sur <a href="http://www.elasticsearch.org/">ElasticSearch</a>, mais c&#8217;est pas la priorité. Don&#8217;t fix what ain&#8217;t broken.</p>
<p>Devant tout ça on a <a href="http://nginx.org/">Nginx</a>. Comme beaucoup on a fait Apache => Cherokee => lighttp => nginx. Et franchement, je ne reviendrais jamais en arrière : plus léger, plus rapide, plus facile à installer et à configurer, plus versatile. Nginx fait tout, et mieux. </p>
<p>En proxy on a du <a href="http://gunicorn.org/">gunicorn</a>. Parce qu&#8217;on avait la flemme de configurer uwsgi et qu&#8217;on a pris l&#8217;habitude.</p>
<p>Après on utilise plein de libs, de petits outils, etc. Mais ça c&#8217;est le gros de notre archi.</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=7648&amp;md5=a3c473ad94a4298f30d5296cdd292afc" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/la-stack-techno-quon-utilise-pour-faire-un-site-web-et-pourquoi/feed/</wfw:commentRss>
		<slash:comments>25</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fla-stack-techno-quon-utilise-pour-faire-un-site-web-et-pourquoi%2F&amp;language=en_GB&amp;category=text&amp;title=La+stack+techno+qu%26%238217%3Bon+utilise+pour+faire+un+site+Web%2C+et+pourquoi&amp;description=Une+stack+techno+n%26%238217%3Best+pas+une+r%C3%A9f%C3%A9rence.+Il+n%26%238217%3By+a+pas+de+combo+absolu+qui+rox+absolument+tout%2C+c%26%238217%3Best+une+question+de+contexte+technique%2C+financier%2C+humain%26%238230%3B+Mais+c%26%238217%3Best+vrai+que...&amp;tags=celery%2Cdjango%2Cfabric%2Cmysql%2Cnginx%2Cnosql%2Cpostgres%2Cpython%2Credis%2Cvm%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/11/nZ9b9.jpg" length="67160" type="image/jpg" />	</item>
		<item>
		<title>Files de tâches et tâches récurrentes avec Celery</title>
		<link>http://sametmax.com/files-de-taches-et-taches-recurrentes-avec-celery/</link>
		<comments>http://sametmax.com/files-de-taches-et-taches-recurrentes-avec-celery/#comments</comments>
		<pubDate>Sat, 27 Jul 2013 07:57:12 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[celery]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[redis]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=6880</guid>
		<description><![CDATA[Quand on a traiter des choses bloquantes, avec des dépendances, des flux complexes ou des actions répétitives, créer des files d'attente peut se révéler très judicieux.
]]></description>
			<content:encoded><![CDATA[<p>Quand on a à traiter des choses bloquantes, avec des dépendances, des flux complexes ou des actions répétitives, créer des files d&#8217;attente peut se révéler très judicieux.</p>
<p>Par exemple lancer la génération d&#8217;un gros zip sur le clic d&#8217;un utilisateur, télécharger plein fichiers en parallèle pour son site de cul, lancer des calculs sur plusieurs machines et récupérer le résultat, encoder des videos en arrière plan, etc.</p>
<p>Le problème, c&#8217;est que fabriquer des files d&#8217;attente à la main, ça mène généralement à une grosse galère. La première boîte dans laquelle j&#8217;ai travaillé avait tout un système de queues à base de PHP + SQL fait à la main qui tapait dans du MySQL, c&#8217;était pas marrant du tout</p>
<p>Je fais une pause, et je note que le potentiel de jeux de mots sur cet article est fortement élevé. Mais je resterai fort.</p>
<p>Locking, priorité, dépendance, asynchronicité, concurrence, sérialisation, encoding, stockage, accessibilité, load balancing&#8230; Toutes ces problématiques sont bien vicieuses et chronophages. Il vaut mieux utiliser une lib solide et éprouvée.</p>
<p>Je resterai fort.</p>
<p><a href="https://pypi.python.org/pypi/kombu/2.2.0">Kombu</a> est une telle lib, mais elle est lourde et complexe à utiliser. J&#8217;avais fais le choix de la prendre pour un gros projet avec Max, je le regrette sur le long terme : c&#8217;est dur à maintenir et à faire évoluer. Le code est vraiment pas sympa.</p>
<p>Heureusement il existe une bibliothèque qui se met au dessus de Kombu pour et nous expose juste les fonctionnalités que l&#8217;on souhaite : <a href="http://www.celeryproject.org/">celery</a>.</p>
<p>Fort.</p>
<p>Celery est simple pour démarrer, mais très puissant si on rentre dans le détail, et croyez moi, le détail, on peut y rentrer très très profondément.</p>
<p>F&#8230;</p>
<h2>Installation</h2>
<p>Qui dit file d&#8217;attente, dit stockage. Il faut bien mettre les tâches quelque part et communiquer avec ce quelque part. En base de données ? Dans un gestionnaire de messages ? En mémoire ? Dans un cache ?</p>
<p>Celery résout le problème en proposant la même interface, quelque soit le support. Actuellement, on peut utiliser :</p>
<ul>
<li>RabbitMQ</li>
<li>Redis</li>
<li>MongoDB</li>
<li>Beanstalk CouchDB</li>
<li>SQLAlchemy ou l&#8217;ORM Django (et donc toutes les bases de données supportées comme Sqlite, MySQL, PostGres&#8230;)</li>
<li>Amazon SQS</li>
</ul>
<p>Dans notre exemple, nous allons le faire avec Redis car :</p>
<ul>
<li>Redis est très simple à installer et à configurer.</li>
<li>Nous on utilise déjà du Redis partout.</li>
<li>Aucun risque de locking.</li>
</ul>
<p>Pour ceux qui ont pas redis, c&#8217;est généralement dans les dépôts. Par exemple sur Ubuntu :</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">sudo</span> <span style="color: #c20cb9; font-weight: bold;">apt-get</span> <span style="color: #c20cb9; font-weight: bold;">install</span> redis-server</pre></div></div>

<p>Il n&#8217;y a rien à faire de plus, ça tourne, c&#8217;est configuré avec des valeurs par défaut qui sont saines. Je vous l&#8217;ai dis, redis, c&#8217;est fantastiquement bien foutu.</p>
<p>Ensuite on install celery et la lib d&#8217;accès à redis en Python qui porte un nom très original :</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;">pip <span style="color: #c20cb9; font-weight: bold;">install</span> celery redis</pre></div></div>

<p>Ca devrait compiler un peu, et comme hab avec les extensions en C, assurez vous d&#8217;avoir un compilateur et les headers en place comme indiqué dans l&#8217;article sur <a href="http://sametmax.com/votre-python-aime-les-pip/">pip</a>.</p>
<p>Ensuite on peut créer ses tâches. Créez un module, par exemple <em>tasks.py</em> :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">urllib2</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">collections</span> <span style="color: #ff7700;font-weight:bold;">import</span> Counter
&nbsp;
<span style="color: #ff7700;font-weight:bold;">from</span> celery <span style="color: #ff7700;font-weight:bold;">import</span> Celery
&nbsp;
<span style="color: #808080; font-style: italic;"># Configuration de celery. Ceci peut aussi se faire dans un fichier de config.</span>
<span style="color: #808080; font-style: italic;"># Ici on dit à celery que pour le module 'tasks', on va utiliser redis</span>
<span style="color: #808080; font-style: italic;"># comme broker (passeur de massage) et comme result backend (stockage du</span>
<span style="color: #808080; font-style: italic;"># resultat des tâches).</span>
celery = Celery<span style="color: black;">&#40;</span><span style="color: #483d8b;">'tasks'</span>, broker=<span style="color: #483d8b;">'redis://localhost'</span>, backend=<span style="color: #483d8b;">'redis://localhost'</span><span style="color: black;">&#41;</span>
&nbsp;
&nbsp;
<span style="color: #808080; font-style: italic;"># Et voici notre première tâche. C'est une fonction Python normale, décorée</span>
<span style="color: #808080; font-style: italic;"># avec un decorateur de celery. Elle prend une URL, et calcule le nombre</span>
<span style="color: #808080; font-style: italic;"># de lettre &quot;e&quot; qu'il y a dans la page.</span>
@celery.<span style="color: black;">task</span>
<span style="color: #ff7700;font-weight:bold;">def</span> ecount<span style="color: black;">&#40;</span>url<span style="color: black;">&#41;</span>:
    <span style="color: #ff7700;font-weight:bold;">return</span> Counter<span style="color: black;">&#40;</span><span style="color: #dc143c;">urllib2</span>.<span style="color: black;">urlopen</span><span style="color: black;">&#40;</span>url<span style="color: black;">&#41;</span>.<span style="color: black;">read</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: black;">&#91;</span><span style="color: #483d8b;">'e'</span><span style="color: black;">&#93;</span></pre></div></div>

<p>On lance ensuite le processus celery dans un terminal (en production, mettez ça dans supervisord ou systemd pour que ça démarre automatiquement) :</p>
<pre>
[test] sam ~/Bureau/celery_test $ celery -A tasks worker -B --loglevel=info

 -------------- celery@sam v3.0.21 (Chiastic Slide)
---- **** -----
--- * ***  * -- Linux-3.2.0-48-generic-x86_64-with-Ubuntu-12.04-precise
-- * - **** ---
- ** ---------- [config]
- ** ---------- .> broker:      redis://localhost:6379//
- ** ---------- .> app:         tasks:0x2a2fa50
- ** ---------- .> concurrency: 4 (processes)
- *** --- * --- .> events:      OFF (enable -E to monitor this worker)
-- ******* ----
--- ***** ----- [queues]
 -------------- .> celery:      exchange:celery(direct) binding:celery

[Tasks]
  . tasks.ecount

[2013-07-26 13:22:21,631: INFO/Beat] Celerybeat: Starting..
[2013-07-26 13:04:51,274: WARNING/MainProcess] celery@sam ready.
[2013-07-26 13:04:51,280: INFO/MainProcess] consumer: Connected to redis://localhost:6379//.
</pre>
<p><code>-A</code> précise le module à importer, <code>-B</code> démarre le beat (on verra ça plus tard), <code>worker</code> dit à celery que démarrer des processus de consommation de files d&#8217;attente (par défaut 4 qui travaillent en parallèle), et <code>--loglevel=info</code> va nous permettre d&#8217;avoir un affichage verbeux pour comprendre ce qui se passe.</p>
<p>Votre file d&#8217;attente est prête, et frétille d&#8217;impatience.</p>
<h2>Lancer une tâche</h2>
<p>A partir de là, vous pouvez envoyer des tâches dans la file d&#8217;attente, depuis n&#8217;importe où :</p>
<ul>
<li>Un script.</li>
<li>Un serveur Web (par exemple une vue Django).</li>
<li>Un programme sur un autre serveur (même si il faudrait alors configurer redis pour qu&#8217;il écoute sur les ports extérieurs, ce qui n&#8217;est pas le cas ici par simplicité).</li>
<li>etc</li>
</ul>
<p>Plusieurs programmes peuvent envoyer plein de tâches, en même temps, et elles vont se loger dans la file d&#8217;attente, sans bloquer le programme qui les a envoyé.</p>
<p>Par exemple, depuis le shell :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">from</span> tasks <span style="color: #ff7700;font-weight:bold;">import</span> ecount
<span style="color: #66cc66;">&gt;&gt;&gt;</span> res = ecount.<span style="color: black;">delay</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'http://danstonchat.com'</span><span style="color: black;">&#41;</span></pre></div></div>

<p>Ceci ne bloque pas mon shell, la ligne s&#8217;exécute immédiatement. La fonction <code>ecount</code> n&#8217;est pas appelée depuis le shell, elle est dans la file d&#8217;attente et sera appelée par un des processus (les fameux &#8216;worker&#8217;) qui consomment la queue. Du côté de la file, on peut voir dans le log :</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #000000;">2013</span>-07-<span style="color: #000000;">26</span> <span style="color: #000000;">14</span>:<span style="color: #000000;">18</span>:08,<span style="color: #000000;">609</span>: INFO<span style="color: #000000; font-weight: bold;">/</span>MainProcess<span style="color: #7a0874; font-weight: bold;">&#93;</span> Got task from broker: tasks.ecount<span style="color: #7a0874; font-weight: bold;">&#91;</span>599a52ea-ef6b-<span style="color: #000000;">4499</span>-981d-cd17fab592df<span style="color: #7a0874; font-weight: bold;">&#93;</span>
<span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #000000;">2013</span>-07-<span style="color: #000000;">26</span> <span style="color: #000000;">14</span>:<span style="color: #000000;">18</span>:09,070: INFO<span style="color: #000000; font-weight: bold;">/</span>MainProcess<span style="color: #7a0874; font-weight: bold;">&#93;</span> Task tasks.ecount<span style="color: #7a0874; font-weight: bold;">&#91;</span>599a52ea-ef6b-<span style="color: #000000;">4499</span>-981d-cd17fab592df<span style="color: #7a0874; font-weight: bold;">&#93;</span> succeeded <span style="color: #000000; font-weight: bold;">in</span> 0.446974039078s: <span style="color: #000000;">1242</span></pre></div></div>

<p>On a donc notre tâche qui a bien été traitée.</p>
<p>On peut récupérer le résultat dans le shell :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> res.<span style="color: black;">state</span>
<span style="color: #483d8b;">'PENDING'</span></pre></div></div>

<p>Ah&#8230; La tâche n&#8217;est pas encore terminée. Et un peu plus tard :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> res.<span style="color: black;">state</span>
<span style="color: #483d8b;">'SUCCESS'</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> res.<span style="color: black;">result</span>
<span style="color: #ff4500;">1242</span></pre></div></div>

<p>Lancer une tâche est bien entendu peu intéressant, les listes d&#8217;attente sont vraiment sympa quand on a plein de tâches à lancer, par plein de processus différents :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">results = <span style="color: black;">&#91;</span>ecount.<span style="color: black;">delay</span><span style="color: black;">&#40;</span>url<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> url <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: black;">&#40;</span><span style="color: #483d8b;">'http://google.com'</span>, <span style="color: #483d8b;">'http://sametmax.com'</span>, <span style="color: #483d8b;">'http://sebsauvage.com'</span>, <span style="color: #483d8b;">'http://multiboards.com'</span>, <span style="color: #483d8b;">'http://0bin.net'</span>, <span style="color: #483d8b;">'http://danstonchat.com'</span><span style="color: black;">&#41;</span><span style="color: black;">&#93;</span></pre></div></div>


<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #000000;">2013</span>-07-<span style="color: #000000;">26</span> <span style="color: #000000;">14</span>:<span style="color: #000000;">25</span>:<span style="color: #000000;">46</span>,<span style="color: #000000;">646</span>: INFO<span style="color: #000000; font-weight: bold;">/</span>MainProcess<span style="color: #7a0874; font-weight: bold;">&#93;</span> Got task from broker: tasks.ecount<span style="color: #7a0874; font-weight: bold;">&#91;</span>5d072a7b-29f8-4ea6-8d92-6a4c1740d724<span style="color: #7a0874; font-weight: bold;">&#93;</span>
<span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #000000;">2013</span>-07-<span style="color: #000000;">26</span> <span style="color: #000000;">14</span>:<span style="color: #000000;">25</span>:<span style="color: #000000;">46</span>,<span style="color: #000000;">649</span>: INFO<span style="color: #000000; font-weight: bold;">/</span>MainProcess<span style="color: #7a0874; font-weight: bold;">&#93;</span> Got task from broker: tasks.ecount<span style="color: #7a0874; font-weight: bold;">&#91;</span>402f6a4f-6b35-4f62-a786-9a5ba27707d2<span style="color: #7a0874; font-weight: bold;">&#93;</span>
<span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #000000;">2013</span>-07-<span style="color: #000000;">26</span> <span style="color: #000000;">14</span>:<span style="color: #000000;">25</span>:<span style="color: #000000;">46</span>,<span style="color: #000000;">650</span>: INFO<span style="color: #000000; font-weight: bold;">/</span>MainProcess<span style="color: #7a0874; font-weight: bold;">&#93;</span> Got task from broker: tasks.ecount<span style="color: #7a0874; font-weight: bold;">&#91;</span>bbe46b1b-<span style="color: #000000;">4719</span>-4c42-bd2f-21e4d72e613e<span style="color: #7a0874; font-weight: bold;">&#93;</span>
<span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #000000;">2013</span>-07-<span style="color: #000000;">26</span> <span style="color: #000000;">14</span>:<span style="color: #000000;">25</span>:<span style="color: #000000;">46</span>,<span style="color: #000000;">652</span>: INFO<span style="color: #000000; font-weight: bold;">/</span>MainProcess<span style="color: #7a0874; font-weight: bold;">&#93;</span> Got task from broker: tasks.ecount<span style="color: #7a0874; font-weight: bold;">&#91;</span>8fb35186-66e2-4eae-a40c-fc42e500ab9d<span style="color: #7a0874; font-weight: bold;">&#93;</span>
<span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #000000;">2013</span>-07-<span style="color: #000000;">26</span> <span style="color: #000000;">14</span>:<span style="color: #000000;">25</span>:<span style="color: #000000;">46</span>,<span style="color: #000000;">653</span>: INFO<span style="color: #000000; font-weight: bold;">/</span>MainProcess<span style="color: #7a0874; font-weight: bold;">&#93;</span> Got task from broker: tasks.ecount<span style="color: #7a0874; font-weight: bold;">&#91;</span>fc63f5db-8ade-<span style="color: #000000;">4383</span>-b719-c3d6390ca246<span style="color: #7a0874; font-weight: bold;">&#93;</span>
<span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #000000;">2013</span>-07-<span style="color: #000000;">26</span> <span style="color: #000000;">14</span>:<span style="color: #000000;">25</span>:<span style="color: #000000;">46</span>,<span style="color: #000000;">654</span>: INFO<span style="color: #000000; font-weight: bold;">/</span>MainProcess<span style="color: #7a0874; font-weight: bold;">&#93;</span> Got task from broker: tasks.ecount<span style="color: #7a0874; font-weight: bold;">&#91;</span>8434e21d-79ea-<span style="color: #000000;">4559</span>-a90e-92e2bc2b9dc7<span style="color: #7a0874; font-weight: bold;">&#93;</span>
<span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #000000;">2013</span>-07-<span style="color: #000000;">26</span> <span style="color: #000000;">14</span>:<span style="color: #000000;">25</span>:<span style="color: #000000;">47</span>,<span style="color: #000000;">144</span>: INFO<span style="color: #000000; font-weight: bold;">/</span>MainProcess<span style="color: #7a0874; font-weight: bold;">&#93;</span> Task tasks.ecount<span style="color: #7a0874; font-weight: bold;">&#91;</span>bbe46b1b-<span style="color: #000000;">4719</span>-4c42-bd2f-21e4d72e613e<span style="color: #7a0874; font-weight: bold;">&#93;</span> succeeded <span style="color: #000000; font-weight: bold;">in</span> 0.479865789413s: <span style="color: #000000;">27</span>
<span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #000000;">2013</span>-07-<span style="color: #000000;">26</span> <span style="color: #000000;">14</span>:<span style="color: #000000;">25</span>:<span style="color: #000000;">47</span>,<span style="color: #000000;">242</span>: INFO<span style="color: #000000; font-weight: bold;">/</span>MainProcess<span style="color: #7a0874; font-weight: bold;">&#93;</span> Task tasks.ecount<span style="color: #7a0874; font-weight: bold;">&#91;</span>5d072a7b-29f8-4ea6-8d92-6a4c1740d724<span style="color: #7a0874; font-weight: bold;">&#93;</span> succeeded <span style="color: #000000; font-weight: bold;">in</span> 0.578661203384s: <span style="color: #000000;">609</span>
<span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #000000;">2013</span>-07-<span style="color: #000000;">26</span> <span style="color: #000000;">14</span>:<span style="color: #000000;">25</span>:<span style="color: #000000;">47</span>,<span style="color: #000000;">501</span>: INFO<span style="color: #000000; font-weight: bold;">/</span>MainProcess<span style="color: #7a0874; font-weight: bold;">&#93;</span> Task tasks.ecount<span style="color: #7a0874; font-weight: bold;">&#91;</span>fc63f5db-8ade-<span style="color: #000000;">4383</span>-b719-c3d6390ca246<span style="color: #7a0874; font-weight: bold;">&#93;</span> succeeded <span style="color: #000000; font-weight: bold;">in</span> 0.35736989975s: <span style="color: #000000;">263</span>
<span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #000000;">2013</span>-07-<span style="color: #000000;">26</span> <span style="color: #000000;">14</span>:<span style="color: #000000;">25</span>:<span style="color: #000000;">47</span>,<span style="color: #000000;">645</span>: INFO<span style="color: #000000; font-weight: bold;">/</span>MainProcess<span style="color: #7a0874; font-weight: bold;">&#93;</span> Task tasks.ecount<span style="color: #7a0874; font-weight: bold;">&#91;</span>8434e21d-79ea-<span style="color: #000000;">4559</span>-a90e-92e2bc2b9dc7<span style="color: #7a0874; font-weight: bold;">&#93;</span> succeeded <span style="color: #000000; font-weight: bold;">in</span> 0.403187036514s: <span style="color: #000000;">1270</span>
<span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #000000;">2013</span>-07-<span style="color: #000000;">26</span> <span style="color: #000000;">14</span>:<span style="color: #000000;">25</span>:<span style="color: #000000;">47</span>,<span style="color: #000000;">815</span>: INFO<span style="color: #000000; font-weight: bold;">/</span>MainProcess<span style="color: #7a0874; font-weight: bold;">&#93;</span> Task tasks.ecount<span style="color: #7a0874; font-weight: bold;">&#91;</span>8fb35186-66e2-4eae-a40c-fc42e500ab9d<span style="color: #7a0874; font-weight: bold;">&#93;</span> succeeded <span style="color: #000000; font-weight: bold;">in</span> 1.14100408554s: <span style="color: #000000;">23</span>
<span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #000000;">2013</span>-07-<span style="color: #000000;">26</span> <span style="color: #000000;">14</span>:<span style="color: #000000;">25</span>:<span style="color: #000000;">49</span>,010: INFO<span style="color: #000000; font-weight: bold;">/</span>MainProcess<span style="color: #7a0874; font-weight: bold;">&#93;</span> Task tasks.ecount<span style="color: #7a0874; font-weight: bold;">&#91;</span>402f6a4f-6b35-4f62-a786-9a5ba27707d2<span style="color: #7a0874; font-weight: bold;">&#93;</span> succeeded <span style="color: #000000; font-weight: bold;">in</span> 2.34633708s: <span style="color: #000000;">3158</span></pre></div></div>

<p>Car du coup on sait que ces multiples tâches ne vont pas bloquer le processus en cour, mais qu&#8217;en plus la charge sera répartie sur le nombre de workers qu&#8217;on a décidé au départ, ni plus (surcharge du serveur), ni moins (traitement trop lent).</p>
<h2>Comment je sais quand une tâche est terminée ?</h2>
<p>On peut attendre que la tâche soit terminée :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">print</span> res.<span style="color: black;">wait</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #ff4500;">9999</span></pre></div></div>

<p>Mais ce n&#8217;est pas vraiment le but. On cherche avant tout à ce que les tâches soient non bloquantes, et exécutées dans un processus à part voir potentiellement distribuées sur plusieurs serveurs. </p>
<p>Par ailleurs, Celery n&#8217;est pas un remplacement d&#8217;un système de traitement asynchrone comme Tornado ou NodeJS, il n&#8217;est pas fait pour envoyer des réponses asynchrones à l&#8217;utilisateur. Il est fait pour faire des tâches en background, répartir la charge et ordonner le traitement. Bien entendu, on peut faire communiquer un système asynchrone avec celery comme <a href="https://github.com/mher/tornado-celery">ici</a> ou <a href="http://cyberfart.blogspot.fr/2012/11/tornado-celery-integration.html">ici</a>, mais c&#8217;est une autre histoire.</p>
<p>Concentrons nous sur les tâches.</p>
<p>La question de &#8220;Comment je sais quand une tâche est terminée ?&#8221; est souvent traduisible par &#8220;comment je réagis à une tâche pour lancer du code quand elle s&#8217;est terminée sans erreur ?&#8221;.</p>
<p>Et là, il y une solution toute simple :</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">res = tache1.<span style="color: black;">s</span><span style="color: black;">&#40;</span>arg1, arg2<span style="color: black;">&#41;</span> | tache2.<span style="color: black;">s</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> | tache3.<span style="color: black;">s</span><span style="color: black;">&#40;</span>arg1<span style="color: black;">&#41;</span></pre></div></div>

<p>Ceci va créer une chaîne de tâches. Quand la première se termine, la deuxième se lance en recevant le résultat de la première en argument.</p>
<p><code>s()</code> fabrique une sous-tâche, c&#8217;est à dire une tâche à envoyer dans la file plus tard avec des arguments pré-enregistrés. Dans notre exemple, celery va lancer <code>tache1</code> avec deux arguments, puis si ça marche, va appeler <code>tache2</code> en lui passant le résultat de <code>tache1</code> comme argument, puis si ça marche, va appeler <code>tache3</code> avec le résultat de <code>tache2</code> en premier argument et <code>arg1</code> en second argument.</p>
<p>En fait, celery vient avec tout <a href="http://docs.celeryproject.org/en/latest/userguide/canvas.html?highlight=group">un tas d&#8217;outils</a> pour exécuter des tâches dépendantes les unes des autres : par groupes, par chaînes, par morceaux, etc. Mais de toute façon, vous pouvez appeler une tâche&#8230; à l&#8217;intérieur d&#8217;une autre tâche. Donc parti de là vous pouvez faire pas mal de choses.</p>
<h2>Comment je fais pour faire une tâche récurrente ?</h2>
<p>C&#8217;est là qu&#8217;intervient le &#8220;beat&#8221; dont j&#8217;ai parlé tout à l&#8217;heure. Avec cette option, celery va vérifier toutes les secondes si il n&#8217;y a pas une tâche répétitive à lancer, et la mettre dans une file d&#8217;attente, à la manière d&#8217;un cron.</p>
<p>Il suffit de définir une tâche comme <code>periodic_task</code> pour qu&#8217;elle soit lancée régulièrement.</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">smtplib</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">from</span> celery.<span style="color: black;">schedules</span> <span style="color: #ff7700;font-weight:bold;">import</span> crontab
<span style="color: #ff7700;font-weight:bold;">from</span> celery.<span style="color: black;">decorators</span> <span style="color: #ff7700;font-weight:bold;">import</span> periodic_task
&nbsp;
<span style="color: #808080; font-style: italic;"># va executer la tâche à 5h30, 13h30 et 23h30 tous les lundi</span>
<span style="color: #808080; font-style: italic;"># run_every accepte aussi un timedelta, pour par exemple dire &quot;toutes les 10m&quot;</span>
@periodic_task<span style="color: black;">&#40;</span>run_every=crontab<span style="color: black;">&#40;</span>hour=<span style="color: #483d8b;">'5,13,23'</span>, minute=<span style="color: #ff4500;">30</span>, day_of_week=<span style="color: #483d8b;">'monday'</span><span style="color: black;">&#41;</span>
<span style="color: #ff7700;font-weight:bold;">def</span> is_alive<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">&quot;&quot;&quot;
        Vérifie que le blog est toujours en ligne, et si ce n'est pas le cas,
        envoie un mail en panique.
    &quot;&quot;&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #dc143c;">urllib2</span>.<span style="color: black;">urlopen</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'http://sametmax.com'</span><span style="color: black;">&#41;</span>.<span style="color: #dc143c;">code</span> <span style="color: #66cc66;">!</span>= <span style="color: #ff4500;">200</span>:
        mail = <span style="color: #483d8b;">'lesametlemax__AT__gmail.com'</span>.<span style="color: black;">replace</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'__AT__'</span>, <span style="color: #483d8b;">'@'</span><span style="color: black;">&#41;</span>
        server = <span style="color: #dc143c;">smtplib</span>.<span style="color: black;">SMTP</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'smtp.gmail.com:587'</span><span style="color: black;">&#41;</span>
        server.<span style="color: black;">starttls</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
        server.<span style="color: black;">login</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'root'</span>, <span style="color: #483d8b;">'admin123'</span><span style="color: black;">&#41;</span>
        server.<span style="color: black;">sendmail</span><span style="color: black;">&#40;</span>mail, mail, msg<span style="color: black;">&#41;</span>
        server.<span style="color: black;">quit</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre></div></div>

<p>Il y a de <a href="http://docs.celeryproject.org/en/latest/userguide/periodic-tasks.html?highlight=cron">bons exemples</a> sur la syntaxe sur <code>crontab()</code> dans la doc.</p>
<p>D&#8217;une manière générale, <a href="http://docs.celeryproject.org/en/latest/getting-started/introduction.html">la doc de Celery est très très riche</a>, donc plongez vous dedans si cet article ne répond pas à vos besoins, car si ça peut être mis dans une file, ça peut être fait par Celery.</p>
<h2>Note de fin</h2>
<p>Celery n&#8217;autoreload pas le code, donc redémarrez les workers à chaque fois que vous modifiez vos tasks.</p>
<p>Attention aussi aux tâches récurrentes, la suivante peut se lancer avant que la précédente soit terminée. C&#8217;est à vous de faire des tâches <a href="https://fr.wikipedia.org/wiki/Idempotent">idempotentes</a>, ou alors de mettre en place <a href="http://docs.celeryproject.org/en/latest/tutorials/task-cookbook.html#cookbook-task-serial">un système de locking</a>.</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=6880&amp;md5=b63d1026ee7b0d5a9e8f73bf0347b702" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/files-de-taches-et-taches-recurrentes-avec-celery/feed/</wfw:commentRss>
		<slash:comments>20</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Ffiles-de-taches-et-taches-recurrentes-avec-celery%2F&amp;language=en_GB&amp;category=text&amp;title=Files+de+t%C3%A2ches+et+t%C3%A2ches+r%C3%A9currentes+avec+Celery&amp;description=Quand+on+a+%C3%A0+traiter+des+choses+bloquantes%2C+avec+des+d%C3%A9pendances%2C+des+flux+complexes+ou+des+actions+r%C3%A9p%C3%A9titives%2C+cr%C3%A9er+des+files+d%26%238217%3Battente+peut+se+r%C3%A9v%C3%A9ler+tr%C3%A8s+judicieux.+Par+exemple+lancer...&amp;tags=celery%2Cpython%2Credis%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/07/zdFRjr1.jpg" length="76872" type="image/jpg" />	</item>
		<item>
		<title>Comment Redis et Memcache font expirer leurs données</title>
		<link>http://sametmax.com/comment-redis-et-memcache-font-expirer-leurs-donnees/</link>
		<comments>http://sametmax.com/comment-redis-et-memcache-font-expirer-leurs-donnees/#comments</comments>
		<pubDate>Thu, 28 Feb 2013 12:04:02 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[architecture]]></category>
		<category><![CDATA[mecached]]></category>
		<category><![CDATA[redis]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=5184</guid>
		<description><![CDATA[Redis et Memcache ont des opérations d'insertion de complexité O(1) (très rapide). Malgré ça ils proposent tout deux l'expiration de clé.]]></description>
			<content:encoded><![CDATA[<p>Redis et Memcache ont des opérations d&#8217;insertion de complexité O(1) (très rapide). Malgré ça ils proposent tout deux l&#8217;expiration de clé.</p>
<p>Et je me suis demandé : comment ils font ? Comment je pourrais fais ça si je devais le coder en Python ?</p>
<p>En effet, rechercher une clé expirée prend du temps. J&#8217;ai pensé à utiliser <a href="http://sametmax.com/heapq-le-module-python-incompris/">heapq</a>, mais l&#8217;insertion serait en 0(log(n)) (temps dépendant du nombre d&#8217;items), donc rapide, mais loin des perfs de Redis et Memcache.</p>
<p>Même si on garde à l&#8217;esprit qu&#8217;ils sont codés en C, et donc plus rapide, ça m&#8217;a turlupiné. Comment ils font ces cons ?</p>
<p>La réponse est surprenant : ils font la même chose que <a href="http://0bin.net">0bin</a> !</p>
<p><a href="http://www.memcachier.com/documentation/memcache-user-guide/">Memcache</a> :</p>
<blockquote><p>Memcache doesn’t evict keys when their expiration time expires, as doing so isn’t possible while still guaranteeing O(1) operation times. Instead expiration is more of a way to say how long until a key should be considered stale. When a GET is performed, Memcache checks if the key’s expiration time is still valid before returning it.</p></blockquote>
<p><a href="http://redis.io/commands/expire">Redis</a> :</p>
<blockquote><p>Redis keys are expired in two ways: a passive way, and an active way. A key is actively expired simply when some client tries to access it, and the key is found to be timed out. Of course this is not enough as there are expired keys that will never be accessed again. This keys should be expired anyway, so periodically Redis test a few keys at random among keys with an expire set. All the keys that are already expired are deleted from the keyspace.</p></blockquote>
<p>Memcache et Redis ne cherchent donc pas les clés, ils vérifient l&#8217;expiration à l&#8217;accès de la clé et suppriment le contenu si c&#8217;est dépassé.</p>
<p>Redis va plus loin en régulièrement prenant des clés <strong>au hasard</strong> et en checkant leur date d&#8217;expiration.</p>
<div id="attachment_5185" class="wp-caption aligncenter" style="width: 260px"><a href="http://sametmax.com/wp-content/uploads/2013/02/nQrJypO.gif"><img class="size-full wp-image-5185" title="Comment il fait ? Ah bah il fait pas." src="http://sametmax.com/wp-content/uploads/2013/02/nQrJypO.gif" alt="Gif de Tealc' buvant un café très chaud" width="250" height="136" /></a><p class="wp-caption-text">Comment il fait ? Ah bah il fait pas.</p></div>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=5184&amp;md5=51a10c7e9e484249e6653cf3a4456135" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/comment-redis-et-memcache-font-expirer-leurs-donnees/feed/</wfw:commentRss>
		<slash:comments>10</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fcomment-redis-et-memcache-font-expirer-leurs-donnees%2F&amp;language=en_GB&amp;category=text&amp;title=Comment+Redis+et+Memcache+font+expirer+leurs+donn%C3%A9es&amp;description=Redis+et+Memcache+ont+des+op%C3%A9rations+d%26%238217%3Binsertion+de+complexit%C3%A9+O%281%29+%28tr%C3%A8s+rapide%29.+Malgr%C3%A9+%C3%A7a+ils+proposent+tout+deux+l%26%238217%3Bexpiration+de+cl%C3%A9.+Et+je+me+suis+demand%C3%A9+%3A+comment+ils+font...&amp;tags=architecture%2Cmecached%2Credis%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/02/RNJUv.jpg" length="62975" type="image/jpg" />	</item>
		<item>
		<title>&#8216;Redis&#8217; object has no attribute &#8216;connection&#8217;</title>
		<link>http://sametmax.com/redis-object-has-no-attribute-connection/</link>
		<comments>http://sametmax.com/redis-object-has-no-attribute-connection/#comments</comments>
		<pubDate>Wed, 20 Feb 2013 11:10:21 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[redis]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=4461</guid>
		<description><![CDATA[Solution très conne à un problème très con.]]></description>
			<content:encoded><![CDATA[<p>Solution très conne à un problème très con.</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;">pip <span style="color: #c20cb9; font-weight: bold;">install</span> <span style="color: #660033;">--upgrade</span> redis django-redis-cache django-redis-sessions</pre></div></div>

<p>L&#8217;api de la lib Python Redis a changé, et si vous utilisez des libs qui en dépendent, certains seront plus à jour. C&#8217;est balot, mais ça nous a turlupiné.</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=4461&amp;md5=a27e0482fcc22272d4d312eb95d4a1a6" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/redis-object-has-no-attribute-connection/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fredis-object-has-no-attribute-connection%2F&amp;language=en_GB&amp;category=text&amp;title=%26%238216%3BRedis%26%238217%3B+object+has+no+attribute+%26%238216%3Bconnection%26%238217%3B&amp;description=Solution+tr%C3%A8s+conne+%C3%A0+un+probl%C3%A8me+tr%C3%A8s+con.+pip+install+--upgrade+redis+django-redis-cache+django-redis-sessions+L%26%238217%3Bapi+de+la+lib+Python+Redis+a+chang%C3%A9%2C+et+si+vous+utilisez+des+libs+qui+en...&amp;tags=python%2Credis%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2013/02/wow_red_xiii_cat_druid_.jpg" length="152046" type="image/jpg" />	</item>
		<item>
		<title>Les limites théoriques de redis</title>
		<link>http://sametmax.com/les-limites-theoriques-de-redis/</link>
		<comments>http://sametmax.com/les-limites-theoriques-de-redis/#comments</comments>
		<pubDate>Sun, 22 Jul 2012 19:55:14 +0000</pubDate>
		<dc:creator>Sam</dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[redis]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=1267</guid>
		<description><![CDATA[En théorie hein...]]></description>
			<content:encoded><![CDATA[<p><a href="https://groups.google.com/forum/?fromgroups#!topic/redis-db/n9smY0qNQYs">Nombre de clés max</a>: 2^64-1<br />
Nom d&#8217;éléments max dans un set: 2^64-1<br />
Nom d&#8217;éléments max dans une liste: 2^32-1<br />
Nom d&#8217;éléments max dans une liste: 2^64-1<br />
<a href="https://groups.google.com/forum/?fromgroups#!topic/redis-db/HH4z-8mHNLM">Taille maximum d&#8217;une clé</a>: 2^31 octets<br />
<a href="http://stackoverflow.com/questions/5606106/what-is-the-maximum-value-size-you-can-store-in-redis">Taille maximum d&#8217;une valeur de type string</a>: 512 Mo<br />
<a href="https://groups.google.com/forum/?fromgroups#!topic/redis-db/yjU4XCkZ6HA">Nombre max de DB</a>: virtuellement infinie, mais s&#8217;attendre à des problèmes de perf si on dépasse 1000, et le fichier de conf met la limite à 16 par défaut.</p>
<p>Ca va, il y a de la marge.</p>
 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=1267&amp;md5=905d37e09957808b33ed67a1c2091c3f" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/les-limites-theoriques-de-redis/feed/</wfw:commentRss>
		<slash:comments>4</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fles-limites-theoriques-de-redis%2F&amp;language=en_GB&amp;category=text&amp;title=Les+limites+th%C3%A9oriques+de+redis&amp;description=Nombre+de+cl%C3%A9s+max%3A+2%5E64-1+Nom+d%26%238217%3B%C3%A9l%C3%A9ments+max+dans+un+set%3A+2%5E64-1+Nom+d%26%238217%3B%C3%A9l%C3%A9ments+max+dans+une+liste%3A+2%5E32-1+Nom+d%26%238217%3B%C3%A9l%C3%A9ments+max+dans+une+liste%3A%C2%A02%5E64-1+Taille+maximum+d%26%238217%3Bune+cl%C3%A9%3A+2%5E31...&amp;tags=redis%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2012/07/banner_redis-300dpi-0315a8013afee137cce47b474541d7f1.png" length="25230" type="image/jpg" />	</item>
		<item>
		<title>Redis &#8211; Effacer plusieurs clefs à l&#8217;aide la commande * (wildcard)</title>
		<link>http://sametmax.com/redis-effacer-plusieurs-clefs-a-laide-la-commande-wildcard/</link>
		<comments>http://sametmax.com/redis-effacer-plusieurs-clefs-a-laide-la-commande-wildcard/#comments</comments>
		<pubDate>Sun, 17 Jun 2012 12:37:53 +0000</pubDate>
		<dc:creator>Max</dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[clef]]></category>
		<category><![CDATA[del]]></category>
		<category><![CDATA[redis]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=927</guid>
		<description><![CDATA[Comment effacer plusieurs clef sous Redis en une ligne de commande.]]></description>
			<content:encoded><![CDATA[<p>Lorsque l&#8217;on utilise <a href="http://redis.io/">Redis</a> on a du mal à ne pas y mettre de tout et n&#8217;importe quoi, du coup on se retrouve avec plein de données en RAM. Il arrive au moment d&#8217;une update où l&#8217;on aimerait bien effacer certaines clefs en mémoire. Voici une petite astuce qui m&#8217;a permis de sélectivement effacer la clef video-id.</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:monospace;">redis-cli KEYS <span style="color: #ff0000;">&quot;video-id:*&quot;</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">xargs</span> <span style="color: #660033;">-0</span> redis-cli DEL</pre></div></div>

 <p><a href="http://sametmax.com/?flattrss_redirect&amp;id=927&amp;md5=59f9c6a3a6981ad9155617091d50fd06" title="Flattr" target="_blank"><img src="http://sametmax.com/wp-content/plugins/flattr/img/flattr-badge-large.png" alt="flattr this!"/></a></p>]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/redis-effacer-plusieurs-clefs-a-laide-la-commande-wildcard/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		<atom:link rel="payment" title="Flattr this!" href="https://flattr.com/submit/auto?user_id=sam_et_max&amp;popout=1&amp;url=http%3A%2F%2Fsametmax.com%2Fredis-effacer-plusieurs-clefs-a-laide-la-commande-wildcard%2F&amp;language=en_GB&amp;category=text&amp;title=Redis+%26%238211%3B+Effacer+plusieurs+clefs+%C3%A0+l%26%238217%3Baide+la+commande+%2A+%28wildcard%29&amp;description=Lorsque+l%26%238217%3Bon+utilise+Redis+on+a+du+mal+%C3%A0+ne+pas+y+mettre+de+tout+et+n%26%238217%3Bimporte+quoi%2C+du+coup+on+se+retrouve+avec+plein+de+donn%C3%A9es+en+RAM.+Il...&amp;tags=clef%2Cdel%2Credis%2Cblog" type="text/html" />
<enclosure url="http://sametmax.com/wp-content/uploads/2012/06/erase-memory.jpg" length="428372" type="image/jpg" />	</item>
	</channel>
</rss>
